var Pl=Object.create;var ir=Object.defineProperty,Ml=Object.defineProperties,gc=Object.getOwnPropertyDescriptor,Ll=Object.getOwnPropertyDescriptors,kl=Object.getOwnPropertyNames,ln=Object.getOwnPropertySymbols,Rc=Object.getPrototypeOf,Vs=Object.prototype.hasOwnProperty,Ac=Object.prototype.propertyIsEnumerable,xl=Reflect.get;var pn=Math.pow,Us=(i,t,e)=>t in i?ir(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,w=(i,t)=>{for(var e in t||(t={}))Vs.call(t,e)&&Us(i,e,t[e]);if(ln)for(var e of ln(t))Ac.call(t,e)&&Us(i,e,t[e]);return i},ie=(i,t)=>Ml(i,Ll(t));var Cc=(i,t)=>{var e={};for(var r in i)Vs.call(i,r)&&t.indexOf(r)<0&&(e[r]=i[r]);if(i!=null&&ln)for(var r of ln(i))t.indexOf(r)<0&&Ac.call(i,r)&&(e[r]=i[r]);return e};var me=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports),ws=(i,t)=>{for(var e in t)ir(i,e,{get:t[e],enumerable:!0})},Ul=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of kl(t))!Vs.call(i,n)&&n!==e&&ir(i,n,{get:()=>t[n],enumerable:!(r=gc(t,n))||r.enumerable});return i};var h=(i,t,e)=>(e=i!=null?Pl(Rc(i)):{},Ul(t||!i||!i.__esModule?ir(e,"default",{value:i,enumerable:!0}):e,i));var G=(i,t,e,r)=>{for(var n=r>1?void 0:r?gc(t,e):t,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=(r?o(t,e,n):o(n))||n);return r&&n&&ir(t,e,n),n};var p=(i,t,e)=>(Us(i,typeof t!="symbol"?t+"":t,e),e);var ri=(i,t,e)=>xl(Rc(i),e,t);var T=(i,t,e)=>new Promise((r,n)=>{var s=c=>{try{a(e.next(c))}catch(d){n(d)}},o=c=>{try{a(e.throw(c))}catch(d){n(d)}},a=c=>c.done?r(c.value):Promise.resolve(c.value).then(s,o);a((e=e.apply(i,t)).next())});var ot=me(Xe=>{"use strict";var __=h(_());Object.defineProperty(Xe,"__esModule",{value:!0});var Bs=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};Xe.extractVersion=rr;Xe.wrapPeerConnectionEvent=wl;Xe.disableLog=Bl;Xe.disableWarnings=$l;Xe.log=Hl;Xe.deprecated=Fl;Xe.detectBrowser=Gl;Xe.compactObject=Dc;Xe.walkStats=mn;Xe.filterStats=Wl;function Vl(i,t,e){return t in i?Object.defineProperty(i,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[t]=e,i}var yc=!0,Nc=!0;function rr(i,t,e){var r=i.match(t);return r&&r.length>=e&&parseInt(r[e],10)}function wl(i,t,e){if(!!i.RTCPeerConnection){var r=i.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(o,a){if(o!==t)return n.apply(this,arguments);var c=function(u){var l=e(u);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(a,c),n.apply(this,[o,c])};var s=r.removeEventListener;r.removeEventListener=function(o,a){if(o!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(a))return s.apply(this,arguments);var c=this._eventMap[t].get(a);return this._eventMap[t].delete(a),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(r,"on"+t,{get:function(){return this["_on"+t]},set:function(a){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),a&&this.addEventListener(t,this["_on"+t]=a)},enumerable:!0,configurable:!0})}}function Bl(i){return typeof i!="boolean"?new Error("Argument type: "+(typeof i=="undefined"?"undefined":Bs(i))+". Please use a boolean."):(yc=i,i?"adapter.js logging disabled":"adapter.js logging enabled")}function $l(i){return typeof i!="boolean"?new Error("Argument type: "+(typeof i=="undefined"?"undefined":Bs(i))+". Please use a boolean."):(Nc=!i,"adapter.js deprecation warnings "+(i?"disabled":"enabled"))}function Hl(){if((typeof window=="undefined"?"undefined":Bs(window))==="object"){if(yc)return;typeof console!="undefined"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Fl(i,t){!Nc||console.warn(i+" is deprecated, please use "+t+" instead.")}function Gl(i){var t={browser:null,version:null};if(typeof i=="undefined"||!i.navigator)return t.browser="Not a browser.",t;var e=i.navigator;if(e.mozGetUserMedia)t.browser="firefox",t.version=rr(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||i.isSecureContext===!1&&i.webkitRTCPeerConnection&&!i.RTCIceGatherer)t.browser="chrome",t.version=rr(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=rr(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(i.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=rr(e.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=i.RTCRtpTransceiver&&"currentDirection"in i.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function vc(i){return Object.prototype.toString.call(i)==="[object Object]"}function Dc(i){return vc(i)?Object.keys(i).reduce(function(t,e){var r=vc(i[e]),n=r?Dc(i[e]):i[e],s=r&&!Object.keys(n).length;return n===void 0||s?t:Object.assign(t,Vl({},e,n))},{}):i}function mn(i,t,e){!t||e.has(t.id)||(e.set(t.id,t),Object.keys(t).forEach(function(r){r.endsWith("Id")?mn(i,i.get(t[r]),e):r.endsWith("Ids")&&t[r].forEach(function(n){mn(i,i.get(n),e)})}))}function Wl(i,t,e){var r=e?"outbound-rtp":"inbound-rtp",n=new Map;if(t===null)return n;var s=[];return i.forEach(function(o){o.type==="track"&&o.trackIdentifier===t.id&&s.push(o)}),s.forEach(function(o){i.forEach(function(a){a.type===r&&a.trackId===o.id&&mn(i,a,n)})}),n}});var bc=me($s=>{"use strict";var E_=h(_());Object.defineProperty($s,"__esModule",{value:!0});var nr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};$s.shimGetUserMedia=Xl;var Kl=ot(),jl=Jl(Kl);function Jl(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}var Oc=jl.log;function Xl(i,t){var e=i&&i.navigator;if(!!e.mediaDevices){var r=function(d){if((typeof d=="undefined"?"undefined":nr(d))!=="object"||d.mandatory||d.optional)return d;var u={};return Object.keys(d).forEach(function(l){if(!(l==="require"||l==="advanced"||l==="mediaSource")){var m=nr(d[l])==="object"?d[l]:{ideal:d[l]};m.exact!==void 0&&typeof m.exact=="number"&&(m.min=m.max=m.exact);var I=function(B,x){return B?B+x.charAt(0).toUpperCase()+x.slice(1):x==="deviceId"?"sourceId":x};if(m.ideal!==void 0){u.optional=u.optional||[];var E={};typeof m.ideal=="number"?(E[I("min",l)]=m.ideal,u.optional.push(E),E={},E[I("max",l)]=m.ideal,u.optional.push(E)):(E[I("",l)]=m.ideal,u.optional.push(E))}m.exact!==void 0&&typeof m.exact!="number"?(u.mandatory=u.mandatory||{},u.mandatory[I("",l)]=m.exact):["min","max"].forEach(function(N){m[N]!==void 0&&(u.mandatory=u.mandatory||{},u.mandatory[I(N,l)]=m[N])})}}),d.advanced&&(u.optional=(u.optional||[]).concat(d.advanced)),u},n=function(d,u){if(t.version>=61)return u(d);if(d=JSON.parse(JSON.stringify(d)),d&&nr(d.audio)==="object"){var l=function(B,x,F){x in B&&!(F in B)&&(B[F]=B[x],delete B[x])};d=JSON.parse(JSON.stringify(d)),l(d.audio,"autoGainControl","googAutoGainControl"),l(d.audio,"noiseSuppression","googNoiseSuppression"),d.audio=r(d.audio)}if(d&&nr(d.video)==="object"){var m=d.video.facingMode;m=m&&((typeof m=="undefined"?"undefined":nr(m))==="object"?m:{ideal:m});var I=t.version<66;if(m&&(m.exact==="user"||m.exact==="environment"||m.ideal==="user"||m.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!I)){delete d.video.facingMode;var E=void 0;if(m.exact==="environment"||m.ideal==="environment"?E=["back","rear"]:(m.exact==="user"||m.ideal==="user")&&(E=["front"]),E)return e.mediaDevices.enumerateDevices().then(function(N){N=N.filter(function(x){return x.kind==="videoinput"});var B=N.find(function(x){return E.some(function(F){return x.label.toLowerCase().includes(F)})});return!B&&N.length&&E.includes("back")&&(B=N[N.length-1]),B&&(d.video.deviceId=m.exact?{exact:B.deviceId}:{ideal:B.deviceId}),d.video=r(d.video),Oc("chrome: "+JSON.stringify(d)),u(d)})}d.video=r(d.video)}return Oc("chrome: "+JSON.stringify(d)),u(d)},s=function(d){return t.version>=64?d:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[d.name]||d.name,message:d.message,constraint:d.constraint||d.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},o=function(d,u,l){n(d,function(m){e.webkitGetUserMedia(m,u,function(I){l&&l(s(I))})})};if(e.getUserMedia=o.bind(e),e.mediaDevices.getUserMedia){var a=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(c){return n(c,function(d){return a(d).then(function(u){if(d.audio&&!u.getAudioTracks().length||d.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(function(l){l.stop()}),new DOMException("","NotFoundError");return u},function(u){return Promise.reject(s(u))})})}}}}});var Pc=me(Hs=>{"use strict";var S_=h(_());Object.defineProperty(Hs,"__esModule",{value:!0});Hs.shimGetDisplayMedia=Yl;function Yl(i,t){if(!(i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices)&&!!i.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}i.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(function(n){var s=r.video&&r.video.width,o=r.video&&r.video.height,a=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:a||3}},s&&(r.video.mandatory.maxWidth=s),o&&(r.video.mandatory.maxHeight=o),i.navigator.mediaDevices.getUserMedia(r)})}}}});var kc=me(Le=>{"use strict";var g_=h(_());Object.defineProperty(Le,"__esModule",{value:!0});Le.shimGetDisplayMedia=Le.shimGetUserMedia=void 0;var hn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},ql=bc();Object.defineProperty(Le,"shimGetUserMedia",{enumerable:!0,get:function(){return ql.shimGetUserMedia}});var zl=Pc();Object.defineProperty(Le,"shimGetDisplayMedia",{enumerable:!0,get:function(){return zl.shimGetDisplayMedia}});Le.shimMediaStream=ep;Le.shimOnTrack=tp;Le.shimGetSendersWithDtmf=ip;Le.shimGetStats=rp;Le.shimSenderReceiverGetStats=np;Le.shimAddTrackRemoveTrackWithNative=Lc;Le.shimAddTrackRemoveTrack=sp;Le.shimPeerConnection=op;Le.fixNegotiationNeeded=ap;var Ql=ot(),sr=Zl(Ql);function Zl(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function Mc(i,t,e){return t in i?Object.defineProperty(i,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[t]=e,i}function ep(i){i.MediaStream=i.MediaStream||i.webkitMediaStream}function tp(i){if((typeof i=="undefined"?"undefined":hn(i))==="object"&&i.RTCPeerConnection&&!("ontrack"in i.RTCPeerConnection.prototype)){Object.defineProperty(i.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(r){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=r)},enumerable:!0,configurable:!0});var t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._ontrackpoly||(this._ontrackpoly=function(n){n.stream.addEventListener("addtrack",function(s){var o=void 0;i.RTCPeerConnection.prototype.getReceivers?o=r.getReceivers().find(function(c){return c.track&&c.track.id===s.track.id}):o={track:s.track};var a=new Event("track");a.track=s.track,a.receiver=o,a.transceiver={receiver:o},a.streams=[n.stream],r.dispatchEvent(a)}),n.stream.getTracks().forEach(function(s){var o=void 0;i.RTCPeerConnection.prototype.getReceivers?o=r.getReceivers().find(function(c){return c.track&&c.track.id===s.id}):o={track:s};var a=new Event("track");a.track=s,a.receiver=o,a.transceiver={receiver:o},a.streams=[n.stream],r.dispatchEvent(a)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else sr.wrapPeerConnectionEvent(i,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e})}function ip(i){if((typeof i=="undefined"?"undefined":hn(i))==="object"&&i.RTCPeerConnection&&!("getSenders"in i.RTCPeerConnection.prototype)&&"createDTMFSender"in i.RTCPeerConnection.prototype){var t=function(c,d){return{track:d,get dtmf(){return this._dtmf===void 0&&(d.kind==="audio"?this._dtmf=c.createDTMFSender(d):this._dtmf=null),this._dtmf},_pc:c}};if(!i.RTCPeerConnection.prototype.getSenders){i.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(c,d){var u=e.apply(this,arguments);return u||(u=t(this,c),this._senders.push(u)),u};var r=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(c){r.apply(this,arguments);var d=this._senders.indexOf(c);d!==-1&&this._senders.splice(d,1)}}var n=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(c){var d=this;this._senders=this._senders||[],n.apply(this,[c]),c.getTracks().forEach(function(u){d._senders.push(t(d,u))})};var s=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(c){var d=this;this._senders=this._senders||[],s.apply(this,[c]),c.getTracks().forEach(function(u){var l=d._senders.find(function(m){return m.track===u});l&&d._senders.splice(d._senders.indexOf(l),1)})}}else if((typeof i=="undefined"?"undefined":hn(i))==="object"&&i.RTCPeerConnection&&"getSenders"in i.RTCPeerConnection.prototype&&"createDTMFSender"in i.RTCPeerConnection.prototype&&i.RTCRtpSender&&!("dtmf"in i.RTCRtpSender.prototype)){var o=i.RTCPeerConnection.prototype.getSenders;i.RTCPeerConnection.prototype.getSenders=function(){var c=this,d=o.apply(this,[]);return d.forEach(function(u){return u._pc=c}),d},Object.defineProperty(i.RTCRtpSender.prototype,"dtmf",{get:function(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function rp(i){if(!!i.RTCPeerConnection){var t=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){var r=this,n=Array.prototype.slice.call(arguments),s=n[0],o=n[1],a=n[2];if(arguments.length>0&&typeof s=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof s!="function"))return t.apply(this,[]);var c=function(m){var I={},E=m.result();return E.forEach(function(N){var B={id:N.id,timestamp:N.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[N.type]||N.type};N.names().forEach(function(x){B[x]=N.stat(x)}),I[B.id]=B}),I},d=function(m){return new Map(Object.keys(m).map(function(I){return[I,m[I]]}))};if(arguments.length>=2){var u=function(m){o(d(c(m)))};return t.apply(this,[u,s])}return new Promise(function(l,m){t.apply(r,[function(I){l(d(c(I)))},m])}).then(o,a)}}}function np(i){if(!!((typeof i=="undefined"?"undefined":hn(i))==="object"&&i.RTCPeerConnection&&i.RTCRtpSender&&i.RTCRtpReceiver)){if(!("getStats"in i.RTCRtpSender.prototype)){var t=i.RTCPeerConnection.prototype.getSenders;t&&(i.RTCPeerConnection.prototype.getSenders=function(){var o=this,a=t.apply(this,[]);return a.forEach(function(c){return c._pc=o}),a});var e=i.RTCPeerConnection.prototype.addTrack;e&&(i.RTCPeerConnection.prototype.addTrack=function(){var o=e.apply(this,arguments);return o._pc=this,o}),i.RTCRtpSender.prototype.getStats=function(){var o=this;return this._pc.getStats().then(function(a){return sr.filterStats(a,o.track,!0)})}}if(!("getStats"in i.RTCRtpReceiver.prototype)){var r=i.RTCPeerConnection.prototype.getReceivers;r&&(i.RTCPeerConnection.prototype.getReceivers=function(){var o=this,a=r.apply(this,[]);return a.forEach(function(c){return c._pc=o}),a}),sr.wrapPeerConnectionEvent(i,"track",function(s){return s.receiver._pc=s.srcElement,s}),i.RTCRtpReceiver.prototype.getStats=function(){var o=this;return this._pc.getStats().then(function(a){return sr.filterStats(a,o.track,!1)})}}if("getStats"in i.RTCRtpSender.prototype&&"getStats"in i.RTCRtpReceiver.prototype){var n=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof i.MediaStreamTrack){var o=arguments[0],a=void 0,c=void 0,d=void 0;return this.getSenders().forEach(function(u){u.track===o&&(a?d=!0:a=u)}),this.getReceivers().forEach(function(u){return u.track===o&&(c?d=!0:c=u),u.track===o}),d||a&&c?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):a?a.getStats():c?c.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return n.apply(this,arguments)}}}}function Lc(i){i.RTCPeerConnection.prototype.getLocalStreams=function(){var o=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(a){return o._shimmedLocalStreams[a][0]})};var t=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var c=t.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};var e=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(o){var a=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(function(u){var l=a.getSenders().find(function(m){return m.track===u});if(l)throw new DOMException("Track already exists.","InvalidAccessError")});var c=this.getSenders();e.apply(this,arguments);var d=this.getSenders().filter(function(u){return c.indexOf(u)===-1});this._shimmedLocalStreams[o.id]=[o].concat(d)};var r=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],r.apply(this,arguments)};var n=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(o){var a=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(function(c){var d=a._shimmedLocalStreams[c].indexOf(o);d!==-1&&a._shimmedLocalStreams[c].splice(d,1),a._shimmedLocalStreams[c].length===1&&delete a._shimmedLocalStreams[c]}),n.apply(this,arguments)}}function sp(i,t){if(!i.RTCPeerConnection)return;if(i.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Lc(i);var e=i.RTCPeerConnection.prototype.getLocalStreams;i.RTCPeerConnection.prototype.getLocalStreams=function(){var u=this,l=e.apply(this);return this._reverseStreams=this._reverseStreams||{},l.map(function(m){return u._reverseStreams[m.id]})};var r=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(u){var l=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(function(I){var E=l.getSenders().find(function(N){return N.track===I});if(E)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){var m=new i.MediaStream(u.getTracks());this._streams[u.id]=m,this._reverseStreams[m.id]=u,u=m}r.apply(this,[u])};var n=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},i.RTCPeerConnection.prototype.addTrack=function(u,l){var m=this;if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var I=[].slice.call(arguments,1);if(I.length!==1||!I[0].getTracks().find(function(x){return x===u}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var E=this.getSenders().find(function(x){return x.track===u});if(E)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var N=this._streams[l.id];if(N)N.addTrack(u),Promise.resolve().then(function(){m.dispatchEvent(new Event("negotiationneeded"))});else{var B=new i.MediaStream([u]);this._streams[l.id]=B,this._reverseStreams[B.id]=l,this.addStream(B)}return this.getSenders().find(function(x){return x.track===u})};function s(d,u){var l=u.sdp;return Object.keys(d._reverseStreams||[]).forEach(function(m){var I=d._reverseStreams[m],E=d._streams[I.id];l=l.replace(new RegExp(E.id,"g"),I.id)}),new RTCSessionDescription({type:u.type,sdp:l})}function o(d,u){var l=u.sdp;return Object.keys(d._reverseStreams||[]).forEach(function(m){var I=d._reverseStreams[m],E=d._streams[I.id];l=l.replace(new RegExp(I.id,"g"),E.id)}),new RTCSessionDescription({type:u.type,sdp:l})}["createOffer","createAnswer"].forEach(function(d){var u=i.RTCPeerConnection.prototype[d],l=Mc({},d,function(){var m=this,I=arguments,E=arguments.length&&typeof arguments[0]=="function";return E?u.apply(this,[function(N){var B=s(m,N);I[0].apply(null,[B])},function(N){I[1]&&I[1].apply(null,N)},arguments[2]]):u.apply(this,arguments).then(function(N){return s(m,N)})});i.RTCPeerConnection.prototype[d]=l[d]});var a=i.RTCPeerConnection.prototype.setLocalDescription;i.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=o(this,arguments[0]),a.apply(this,arguments))};var c=Object.getOwnPropertyDescriptor(i.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(i.RTCPeerConnection.prototype,"localDescription",{get:function(){var u=c.get.apply(this);return u.type===""?u:s(this,u)}}),i.RTCPeerConnection.prototype.removeTrack=function(u){var l=this;if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var m=u._pc===this;if(!m)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var I=void 0;Object.keys(this._streams).forEach(function(E){var N=l._streams[E].getTracks().find(function(B){return u.track===B});N&&(I=l._streams[E])}),I&&(I.getTracks().length===1?this.removeStream(this._reverseStreams[I.id]):I.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function op(i,t){!i.RTCPeerConnection&&i.webkitRTCPeerConnection&&(i.RTCPeerConnection=i.webkitRTCPeerConnection),!!i.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var r=i.RTCPeerConnection.prototype[e],n=Mc({},e,function(){return arguments[0]=new(e==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)});i.RTCPeerConnection.prototype[e]=n[e]})}function ap(i,t){sr.wrapPeerConnectionEvent(i,"negotiationneeded",function(e){var r=e.target;if(!((t.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")&&r.signalingState!=="stable"))return e})}});var xc=me(Fs=>{"use strict";var A_=h(_());Object.defineProperty(Fs,"__esModule",{value:!0});Fs.shimGetUserMedia=cp;function cp(i){var t=i&&i.navigator,e=function(s){return{name:{PermissionDeniedError:"NotAllowedError"}[s.name]||s.name,message:s.message,constraint:s.constraint,toString:function(){return this.name}}},r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(n){return r(n).catch(function(s){return Promise.reject(e(s))})}}});var Uc=me(Gs=>{"use strict";var v_=h(_());Object.defineProperty(Gs,"__esModule",{value:!0});Gs.shimGetDisplayMedia=dp;function dp(i){"getDisplayMedia"in i.navigator&&(!i.navigator.mediaDevices||i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||(i.navigator.mediaDevices.getDisplayMedia=i.navigator.getDisplayMedia.bind(i.navigator)))}});var Vc=me(Ws=>{"use strict";var N_=h(_());Object.defineProperty(Ws,"__esModule",{value:!0});Ws.filterIceServers=mp;var up=ot(),lp=pp(up);function pp(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function mp(i,t){var e=!1;return i=JSON.parse(JSON.stringify(i)),i.filter(function(r){if(r&&(r.urls||r.url)){var n=r.urls||r.url;r.url&&!r.urls&&lp.deprecated("RTCIceServer.url","RTCIceServer.urls");var s=typeof n=="string";return s&&(n=[n]),n=n.filter(function(o){if(o.indexOf("stun:")===0)return!1;var a=o.startsWith("turn")&&!o.startsWith("turn:[")&&o.includes("transport=udp");return a&&!e?(e=!0,!0):a&&!e}),delete r.url,r.urls=s?n[0]:n,!!n.length}})}});var js=me((D_,Ks)=>{"use strict";var O_=h(_()),P={};P.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};P.localCName=P.generateIdentifier();P.splitLines=function(i){return i.trim().split(`
`).map(function(t){return t.trim()})};P.splitSections=function(i){var t=i.split(`
m=`);return t.map(function(e,r){return(r>0?"m="+e:e).trim()+`\r
`})};P.getDescription=function(i){var t=P.splitSections(i);return t&&t[0]};P.getMediaSections=function(i){var t=P.splitSections(i);return t.shift(),t};P.matchPrefix=function(i,t){return P.splitLines(i).filter(function(e){return e.indexOf(t)===0})};P.parseCandidate=function(i){var t;i.indexOf("a=candidate:")===0?t=i.substring(12).split(" "):t=i.substring(10).split(" ");for(var e={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":e.relatedAddress=t[r+1];break;case"rport":e.relatedPort=parseInt(t[r+1],10);break;case"tcptype":e.tcpType=t[r+1];break;case"ufrag":e.ufrag=t[r+1],e.usernameFragment=t[r+1];break;default:e[t[r]]=t[r+1];break}return e};P.writeCandidate=function(i){var t=[];t.push(i.foundation),t.push(i.component),t.push(i.protocol.toUpperCase()),t.push(i.priority),t.push(i.address||i.ip),t.push(i.port);var e=i.type;return t.push("typ"),t.push(e),e!=="host"&&i.relatedAddress&&i.relatedPort&&(t.push("raddr"),t.push(i.relatedAddress),t.push("rport"),t.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(t.push("tcptype"),t.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(t.push("ufrag"),t.push(i.usernameFragment||i.ufrag)),"candidate:"+t.join(" ")};P.parseIceOptions=function(i){return i.substr(14).split(" ")};P.parseRtpMap=function(i){var t=i.substr(9).split(" "),e={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),e.name=t[0],e.clockRate=parseInt(t[1],10),e.channels=t.length===3?parseInt(t[2],10):1,e.numChannels=e.channels,e};P.writeRtpMap=function(i){var t=i.payloadType;i.preferredPayloadType!==void 0&&(t=i.preferredPayloadType);var e=i.channels||i.numChannels||1;return"a=rtpmap:"+t+" "+i.name+"/"+i.clockRate+(e!==1?"/"+e:"")+`\r
`};P.parseExtmap=function(i){var t=i.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}};P.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+`\r
`};P.parseFmtp=function(i){for(var t={},e,r=i.substr(i.indexOf(" ")+1).split(";"),n=0;n<r.length;n++)e=r[n].trim().split("="),t[e[0].trim()]=e[1];return t};P.writeFmtp=function(i){var t="",e=i.payloadType;if(i.preferredPayloadType!==void 0&&(e=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){var r=[];Object.keys(i.parameters).forEach(function(n){i.parameters[n]?r.push(n+"="+i.parameters[n]):r.push(n)}),t+="a=fmtp:"+e+" "+r.join(";")+`\r
`}return t};P.parseRtcpFb=function(i){var t=i.substr(i.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};P.writeRtcpFb=function(i){var t="",e=i.payloadType;return i.preferredPayloadType!==void 0&&(e=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(function(r){t+="a=rtcp-fb:"+e+" "+r.type+(r.parameter&&r.parameter.length?" "+r.parameter:"")+`\r
`}),t};P.parseSsrcMedia=function(i){var t=i.indexOf(" "),e={ssrc:parseInt(i.substr(7,t-7),10)},r=i.indexOf(":",t);return r>-1?(e.attribute=i.substr(t+1,r-t-1),e.value=i.substr(r+1)):e.attribute=i.substr(t+1),e};P.parseSsrcGroup=function(i){var t=i.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}};P.getMid=function(i){var t=P.matchPrefix(i,"a=mid:")[0];if(t)return t.substr(6)};P.parseFingerprint=function(i){var t=i.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}};P.getDtlsParameters=function(i,t){var e=P.matchPrefix(i+t,"a=fingerprint:");return{role:"auto",fingerprints:e.map(P.parseFingerprint)}};P.writeDtlsParameters=function(i,t){var e="a=setup:"+t+`\r
`;return i.fingerprints.forEach(function(r){e+="a=fingerprint:"+r.algorithm+" "+r.value+`\r
`}),e};P.parseCryptoLine=function(i){var t=i.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}};P.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?P.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`};P.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;var t=i.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}};P.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")};P.getCryptoParameters=function(i,t){var e=P.matchPrefix(i+t,"a=crypto:");return e.map(P.parseCryptoLine)};P.getIceParameters=function(i,t){var e=P.matchPrefix(i+t,"a=ice-ufrag:")[0],r=P.matchPrefix(i+t,"a=ice-pwd:")[0];return e&&r?{usernameFragment:e.substr(12),password:r.substr(10)}:null};P.writeIceParameters=function(i){return"a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`};P.parseRtpParameters=function(i){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},e=P.splitLines(i),r=e[0].split(" "),n=3;n<r.length;n++){var s=r[n],o=P.matchPrefix(i,"a=rtpmap:"+s+" ")[0];if(o){var a=P.parseRtpMap(o),c=P.matchPrefix(i,"a=fmtp:"+s+" ");switch(a.parameters=c.length?P.parseFmtp(c[0]):{},a.rtcpFeedback=P.matchPrefix(i,"a=rtcp-fb:"+s+" ").map(P.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase());break;default:break}}}return P.matchPrefix(i,"a=extmap:").forEach(function(d){t.headerExtensions.push(P.parseExtmap(d))}),t};P.writeRtpDescription=function(i,t){var e="";e+="m="+i+" ",e+=t.codecs.length>0?"9":"0",e+=" UDP/TLS/RTP/SAVPF ",e+=t.codecs.map(function(n){return n.preferredPayloadType!==void 0?n.preferredPayloadType:n.payloadType}).join(" ")+`\r
`,e+=`c=IN IP4 0.0.0.0\r
`,e+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,t.codecs.forEach(function(n){e+=P.writeRtpMap(n),e+=P.writeFmtp(n),e+=P.writeRtcpFb(n)});var r=0;return t.codecs.forEach(function(n){n.maxptime>r&&(r=n.maxptime)}),r>0&&(e+="a=maxptime:"+r+`\r
`),e+=`a=rtcp-mux\r
`,t.headerExtensions&&t.headerExtensions.forEach(function(n){e+=P.writeExtmap(n)}),e};P.parseRtpEncodingParameters=function(i){var t=[],e=P.parseRtpParameters(i),r=e.fecMechanisms.indexOf("RED")!==-1,n=e.fecMechanisms.indexOf("ULPFEC")!==-1,s=P.matchPrefix(i,"a=ssrc:").map(function(u){return P.parseSsrcMedia(u)}).filter(function(u){return u.attribute==="cname"}),o=s.length>0&&s[0].ssrc,a,c=P.matchPrefix(i,"a=ssrc-group:FID").map(function(u){var l=u.substr(17).split(" ");return l.map(function(m){return parseInt(m,10)})});c.length>0&&c[0].length>1&&c[0][0]===o&&(a=c[0][1]),e.codecs.forEach(function(u){if(u.name.toUpperCase()==="RTX"&&u.parameters.apt){var l={ssrc:o,codecPayloadType:parseInt(u.parameters.apt,10)};o&&a&&(l.rtx={ssrc:a}),t.push(l),r&&(l=JSON.parse(JSON.stringify(l)),l.fec={ssrc:o,mechanism:n?"red+ulpfec":"red"},t.push(l))}}),t.length===0&&o&&t.push({ssrc:o});var d=P.matchPrefix(i,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substr(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substr(5),10)*1e3*.95-50*40*8:d=void 0,t.forEach(function(u){u.maxBitrate=d})),t};P.parseRtcpParameters=function(i){var t={},e=P.matchPrefix(i,"a=ssrc:").map(function(s){return P.parseSsrcMedia(s)}).filter(function(s){return s.attribute==="cname"})[0];e&&(t.cname=e.value,t.ssrc=e.ssrc);var r=P.matchPrefix(i,"a=rtcp-rsize");t.reducedSize=r.length>0,t.compound=r.length===0;var n=P.matchPrefix(i,"a=rtcp-mux");return t.mux=n.length>0,t};P.parseMsid=function(i){var t,e=P.matchPrefix(i,"a=msid:");if(e.length===1)return t=e[0].substr(7).split(" "),{stream:t[0],track:t[1]};var r=P.matchPrefix(i,"a=ssrc:").map(function(n){return P.parseSsrcMedia(n)}).filter(function(n){return n.attribute==="msid"});if(r.length>0)return t=r[0].value.split(" "),{stream:t[0],track:t[1]}};P.parseSctpDescription=function(i){var t=P.parseMLine(i),e=P.matchPrefix(i,"a=max-message-size:"),r;e.length>0&&(r=parseInt(e[0].substr(19),10)),isNaN(r)&&(r=65536);var n=P.matchPrefix(i,"a=sctp-port:");if(n.length>0)return{port:parseInt(n[0].substr(12),10),protocol:t.fmt,maxMessageSize:r};var s=P.matchPrefix(i,"a=sctpmap:");if(s.length>0){var o=P.matchPrefix(i,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(o[0],10),protocol:o[1],maxMessageSize:r}}};P.writeSctpDescription=function(i,t){var e=[];return i.protocol!=="DTLS/SCTP"?e=["m="+i.kind+" 9 "+i.protocol+" "+t.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+t.port+`\r
`]:e=["m="+i.kind+" 9 "+i.protocol+" "+t.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+t.port+" "+t.protocol+` 65535\r
`],t.maxMessageSize!==void 0&&e.push("a=max-message-size:"+t.maxMessageSize+`\r
`),e.join("")};P.generateSessionId=function(){return Math.random().toString().substr(2,21)};P.writeSessionBoilerplate=function(i,t,e){var r,n=t!==void 0?t:2;i?r=i:r=P.generateSessionId();var s=e||"thisisadapterortc";return`v=0\r
o=`+s+" "+r+" "+n+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`};P.writeMediaSection=function(i,t,e,r){var n=P.writeRtpDescription(i.kind,t);if(n+=P.writeIceParameters(i.iceGatherer.getLocalParameters()),n+=P.writeDtlsParameters(i.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":"active"),n+="a=mid:"+i.mid+`\r
`,i.direction?n+="a="+i.direction+`\r
`:i.rtpSender&&i.rtpReceiver?n+=`a=sendrecv\r
`:i.rtpSender?n+=`a=sendonly\r
`:i.rtpReceiver?n+=`a=recvonly\r
`:n+=`a=inactive\r
`,i.rtpSender){var s="msid:"+r.id+" "+i.rtpSender.track.id+`\r
`;n+="a="+s,n+="a=ssrc:"+i.sendEncodingParameters[0].ssrc+" "+s,i.sendEncodingParameters[0].rtx&&(n+="a=ssrc:"+i.sendEncodingParameters[0].rtx.ssrc+" "+s,n+="a=ssrc-group:FID "+i.sendEncodingParameters[0].ssrc+" "+i.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return n+="a=ssrc:"+i.sendEncodingParameters[0].ssrc+" cname:"+P.localCName+`\r
`,i.rtpSender&&i.sendEncodingParameters[0].rtx&&(n+="a=ssrc:"+i.sendEncodingParameters[0].rtx.ssrc+" cname:"+P.localCName+`\r
`),n};P.getDirection=function(i,t){for(var e=P.splitLines(i),r=0;r<e.length;r++)switch(e[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return e[r].substr(2);default:}return t?P.getDirection(t):"sendrecv"};P.getKind=function(i){var t=P.splitLines(i),e=t[0].split(" ");return e[0].substr(2)};P.isRejected=function(i){return i.split(" ",2)[1]==="0"};P.parseMLine=function(i){var t=P.splitLines(i),e=t[0].substr(2).split(" ");return{kind:e[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}};P.parseOLine=function(i){var t=P.matchPrefix(i,"o=")[0],e=t.substr(2).split(" ");return{username:e[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}};P.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;for(var t=P.splitLines(i),e=0;e<t.length;e++)if(t[e].length<2||t[e].charAt(1)!=="=")return!1;return!0};typeof Ks=="object"&&(Ks.exports=P)});var Hc=me((b_,$c)=>{"use strict";var P_=h(_()),j=js();function hp(i){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[i.type]||i.type}function wc(i,t,e,r,n){var s=j.writeRtpDescription(i.kind,t);if(s+=j.writeIceParameters(i.iceGatherer.getLocalParameters()),s+=j.writeDtlsParameters(i.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":n||"active"),s+="a=mid:"+i.mid+`\r
`,i.rtpSender&&i.rtpReceiver?s+=`a=sendrecv\r
`:i.rtpSender?s+=`a=sendonly\r
`:i.rtpReceiver?s+=`a=recvonly\r
`:s+=`a=inactive\r
`,i.rtpSender){var o=i.rtpSender._initialTrackId||i.rtpSender.track.id;i.rtpSender._initialTrackId=o;var a="msid:"+(r?r.id:"-")+" "+o+`\r
`;s+="a="+a,s+="a=ssrc:"+i.sendEncodingParameters[0].ssrc+" "+a,i.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+i.sendEncodingParameters[0].rtx.ssrc+" "+a,s+="a=ssrc-group:FID "+i.sendEncodingParameters[0].ssrc+" "+i.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return s+="a=ssrc:"+i.sendEncodingParameters[0].ssrc+" cname:"+j.localCName+`\r
`,i.rtpSender&&i.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+i.sendEncodingParameters[0].rtx.ssrc+" cname:"+j.localCName+`\r
`),s}function _p(i,t){var e=!1;return i=JSON.parse(JSON.stringify(i)),i.filter(function(r){if(r&&(r.urls||r.url)){var n=r.urls||r.url;r.url&&!r.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var s=typeof n=="string";return s&&(n=[n]),n=n.filter(function(o){var a=o.indexOf("turn:")===0&&o.indexOf("transport=udp")!==-1&&o.indexOf("turn:[")===-1&&!e;return a?(e=!0,!0):o.indexOf("stun:")===0&&t>=14393&&o.indexOf("?transport=udp")===-1}),delete r.url,r.urls=s?n[0]:n,!!n.length}})}function _n(i,t){var e={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(s,o){s=parseInt(s,10);for(var a=0;a<o.length;a++)if(o[a].payloadType===s||o[a].preferredPayloadType===s)return o[a]},n=function(s,o,a,c){var d=r(s.parameters.apt,a),u=r(o.parameters.apt,c);return d&&u&&d.name.toLowerCase()===u.name.toLowerCase()};return i.codecs.forEach(function(s){for(var o=0;o<t.codecs.length;o++){var a=t.codecs[o];if(s.name.toLowerCase()===a.name.toLowerCase()&&s.clockRate===a.clockRate){if(s.name.toLowerCase()==="rtx"&&s.parameters&&a.parameters.apt&&!n(s,a,i.codecs,t.codecs))continue;a=JSON.parse(JSON.stringify(a)),a.numChannels=Math.min(s.numChannels,a.numChannels),e.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(c){for(var d=0;d<s.rtcpFeedback.length;d++)if(s.rtcpFeedback[d].type===c.type&&s.rtcpFeedback[d].parameter===c.parameter)return!0;return!1});break}}}),i.headerExtensions.forEach(function(s){for(var o=0;o<t.headerExtensions.length;o++){var a=t.headerExtensions[o];if(s.uri===a.uri){e.headerExtensions.push(a);break}}}),e}function Bc(i,t,e){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][i].indexOf(e)!==-1}function Js(i,t){var e=i.getRemoteCandidates().find(function(r){return t.foundation===r.foundation&&t.ip===r.ip&&t.port===r.port&&t.priority===r.priority&&t.protocol===r.protocol&&t.type===r.type});return e||i.addRemoteCandidate(t),!e}function Ne(i,t){var e=new Error(t);return e.name=i,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[i],e}$c.exports=function(i,t){function e(c,d){d.addTrack(c),d.dispatchEvent(new i.MediaStreamTrackEvent("addtrack",{track:c}))}function r(c,d){d.removeTrack(c),d.dispatchEvent(new i.MediaStreamTrackEvent("removetrack",{track:c}))}function n(c,d,u,l){var m=new Event("track");m.track=d,m.receiver=u,m.transceiver={receiver:u},m.streams=l,i.setTimeout(function(){c._dispatchEvent("track",m)})}var s=function(c){var d=this,u=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(m){d[m]=u[m].bind(u)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle=c.bundlePolicy==="max-bundle",c.rtcpMuxPolicy==="negotiate")throw Ne("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all";break}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced";break}if(c.iceServers=_p(c.iceServers||[],t),this._iceGatherers=[],c.iceCandidatePoolSize)for(var l=c.iceCandidatePoolSize;l>0;l--)this._iceGatherers.push(new i.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy}));else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=j.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(c,d){this._isClosed||(this.dispatchEvent(d),typeof this["on"+c]=="function"&&this["on"+c](d))},s.prototype._emitGatheringStateChange=function(){var c=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",c)},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(c,d){var u=this.transceivers.length>0,l={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:c,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&u)l.iceTransport=this.transceivers[0].iceTransport,l.dtlsTransport=this.transceivers[0].dtlsTransport;else{var m=this._createIceAndDtlsTransports();l.iceTransport=m.iceTransport,l.dtlsTransport=m.dtlsTransport}return d||this.transceivers.push(l),l},s.prototype.addTrack=function(c,d){if(this._isClosed)throw Ne("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var u=this.transceivers.find(function(I){return I.track===c});if(u)throw Ne("InvalidAccessError","Track already exists.");for(var l,m=0;m<this.transceivers.length;m++)!this.transceivers[m].track&&this.transceivers[m].kind===c.kind&&(l=this.transceivers[m]);return l||(l=this._createTransceiver(c.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(d)===-1&&this.localStreams.push(d),l.track=c,l.stream=d,l.rtpSender=new i.RTCRtpSender(c,l.dtlsTransport),l.rtpSender},s.prototype.addStream=function(c){var d=this;if(t>=15025)c.getTracks().forEach(function(l){d.addTrack(l,c)});else{var u=c.clone();c.getTracks().forEach(function(l,m){var I=u.getTracks()[m];l.addEventListener("enabled",function(E){I.enabled=E.enabled})}),u.getTracks().forEach(function(l){d.addTrack(l,u)})}},s.prototype.removeTrack=function(c){if(this._isClosed)throw Ne("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(c instanceof i.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var d=this.transceivers.find(function(m){return m.rtpSender===c});if(!d)throw Ne("InvalidAccessError","Sender was not created by this connection.");var u=d.stream;d.rtpSender.stop(),d.rtpSender=null,d.track=null,d.stream=null;var l=this.transceivers.map(function(m){return m.stream});l.indexOf(u)===-1&&this.localStreams.indexOf(u)>-1&&this.localStreams.splice(this.localStreams.indexOf(u),1),this._maybeFireNegotiationNeeded()},s.prototype.removeStream=function(c){var d=this;c.getTracks().forEach(function(u){var l=d.getSenders().find(function(m){return m.track===u});l&&d.removeTrack(l)})},s.prototype.getSenders=function(){return this.transceivers.filter(function(c){return!!c.rtpSender}).map(function(c){return c.rtpSender})},s.prototype.getReceivers=function(){return this.transceivers.filter(function(c){return!!c.rtpReceiver}).map(function(c){return c.rtpReceiver})},s.prototype._createIceGatherer=function(c,d){var u=this;if(d&&c>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var l=new i.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(l,"state",{value:"new",writable:!0}),this.transceivers[c].bufferedCandidateEvents=[],this.transceivers[c].bufferCandidates=function(m){var I=!m.candidate||Object.keys(m.candidate).length===0;l.state=I?"completed":"gathering",u.transceivers[c].bufferedCandidateEvents!==null&&u.transceivers[c].bufferedCandidateEvents.push(m)},l.addEventListener("localcandidate",this.transceivers[c].bufferCandidates),l},s.prototype._gather=function(c,d){var u=this,l=this.transceivers[d].iceGatherer;if(!l.onlocalcandidate){var m=this.transceivers[d].bufferedCandidateEvents;this.transceivers[d].bufferedCandidateEvents=null,l.removeEventListener("localcandidate",this.transceivers[d].bufferCandidates),l.onlocalcandidate=function(I){if(!(u.usingBundle&&d>0)){var E=new Event("icecandidate");E.candidate={sdpMid:c,sdpMLineIndex:d};var N=I.candidate,B=!N||Object.keys(N).length===0;if(B)(l.state==="new"||l.state==="gathering")&&(l.state="completed");else{l.state==="new"&&(l.state="gathering"),N.component=1,N.ufrag=l.getLocalParameters().usernameFragment;var x=j.writeCandidate(N);E.candidate=Object.assign(E.candidate,j.parseCandidate(x)),E.candidate.candidate=x,E.candidate.toJSON=function(){return{candidate:E.candidate.candidate,sdpMid:E.candidate.sdpMid,sdpMLineIndex:E.candidate.sdpMLineIndex,usernameFragment:E.candidate.usernameFragment}}}var F=j.getMediaSections(u._localDescription.sdp);B?F[E.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:F[E.candidate.sdpMLineIndex]+="a="+E.candidate.candidate+`\r
`,u._localDescription.sdp=j.getDescription(u._localDescription.sdp)+F.join("");var Ee=u.transceivers.every(function(A){return A.iceGatherer&&A.iceGatherer.state==="completed"});u.iceGatheringState!=="gathering"&&(u.iceGatheringState="gathering",u._emitGatheringStateChange()),B||u._dispatchEvent("icecandidate",E),Ee&&(u._dispatchEvent("icecandidate",new Event("icecandidate")),u.iceGatheringState="complete",u._emitGatheringStateChange())}},i.setTimeout(function(){m.forEach(function(I){l.onlocalcandidate(I)})},0)}},s.prototype._createIceAndDtlsTransports=function(){var c=this,d=new i.RTCIceTransport(null);d.onicestatechange=function(){c._updateIceConnectionState(),c._updateConnectionState()};var u=new i.RTCDtlsTransport(d);return u.ondtlsstatechange=function(){c._updateConnectionState()},u.onerror=function(){Object.defineProperty(u,"state",{value:"failed",writable:!0}),c._updateConnectionState()},{iceTransport:d,dtlsTransport:u}},s.prototype._disposeIceAndDtlsTransports=function(c){var d=this.transceivers[c].iceGatherer;d&&(delete d.onlocalcandidate,delete this.transceivers[c].iceGatherer);var u=this.transceivers[c].iceTransport;u&&(delete u.onicestatechange,delete this.transceivers[c].iceTransport);var l=this.transceivers[c].dtlsTransport;l&&(delete l.ondtlsstatechange,delete l.onerror,delete this.transceivers[c].dtlsTransport)},s.prototype._transceive=function(c,d,u){var l=_n(c.localCapabilities,c.remoteCapabilities);d&&c.rtpSender&&(l.encodings=c.sendEncodingParameters,l.rtcp={cname:j.localCName,compound:c.rtcpParameters.compound},c.recvEncodingParameters.length&&(l.rtcp.ssrc=c.recvEncodingParameters[0].ssrc),c.rtpSender.send(l)),u&&c.rtpReceiver&&l.codecs.length>0&&(c.kind==="video"&&c.recvEncodingParameters&&t<15019&&c.recvEncodingParameters.forEach(function(m){delete m.rtx}),c.recvEncodingParameters.length?l.encodings=c.recvEncodingParameters:l.encodings=[{}],l.rtcp={compound:c.rtcpParameters.compound},c.rtcpParameters.cname&&(l.rtcp.cname=c.rtcpParameters.cname),c.sendEncodingParameters.length&&(l.rtcp.ssrc=c.sendEncodingParameters[0].ssrc),c.rtpReceiver.receive(l))},s.prototype.setLocalDescription=function(c){var d=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(Ne("TypeError",'Unsupported type "'+c.type+'"'));if(!Bc("setLocalDescription",c.type,d.signalingState)||d._isClosed)return Promise.reject(Ne("InvalidStateError","Can not set local "+c.type+" in state "+d.signalingState));var u,l;if(c.type==="offer")u=j.splitSections(c.sdp),l=u.shift(),u.forEach(function(I,E){var N=j.parseRtpParameters(I);d.transceivers[E].localCapabilities=N}),d.transceivers.forEach(function(I,E){d._gather(I.mid,E)});else if(c.type==="answer"){u=j.splitSections(d._remoteDescription.sdp),l=u.shift();var m=j.matchPrefix(l,"a=ice-lite").length>0;u.forEach(function(I,E){var N=d.transceivers[E],B=N.iceGatherer,x=N.iceTransport,F=N.dtlsTransport,Ee=N.localCapabilities,A=N.remoteCapabilities,U=j.isRejected(I)&&j.matchPrefix(I,"a=bundle-only").length===0;if(!U&&!N.rejected){var v=j.getIceParameters(I,l),J=j.getDtlsParameters(I,l);m&&(J.role="server"),(!d.usingBundle||E===0)&&(d._gather(N.mid,E),x.state==="new"&&x.start(B,v,m?"controlling":"controlled"),F.state==="new"&&F.start(J));var Z=_n(Ee,A);d._transceive(N,Z.codecs.length>0,!1)}})}return d._localDescription={type:c.type,sdp:c.sdp},c.type==="offer"?d._updateSignalingState("have-local-offer"):d._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(c){var d=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(Ne("TypeError",'Unsupported type "'+c.type+'"'));if(!Bc("setRemoteDescription",c.type,d.signalingState)||d._isClosed)return Promise.reject(Ne("InvalidStateError","Can not set remote "+c.type+" in state "+d.signalingState));var u={};d.remoteStreams.forEach(function(x){u[x.id]=x});var l=[],m=j.splitSections(c.sdp),I=m.shift(),E=j.matchPrefix(I,"a=ice-lite").length>0,N=j.matchPrefix(I,"a=group:BUNDLE ").length>0;d.usingBundle=N;var B=j.matchPrefix(I,"a=ice-options:")[0];return B?d.canTrickleIceCandidates=B.substr(14).split(" ").indexOf("trickle")>=0:d.canTrickleIceCandidates=!1,m.forEach(function(x,F){var Ee=j.splitLines(x),A=j.getKind(x),U=j.isRejected(x)&&j.matchPrefix(x,"a=bundle-only").length===0,v=Ee[0].substr(2).split(" ")[2],J=j.getDirection(x,I),Z=j.parseMsid(x),Te=j.getMid(x)||j.generateIdentifier();if(U||A==="application"&&(v==="DTLS/SCTP"||v==="UDP/DTLS/SCTP")){d.transceivers[F]={mid:Te,kind:A,protocol:v,rejected:!0};return}!U&&d.transceivers[F]&&d.transceivers[F].rejected&&(d.transceivers[F]=d._createTransceiver(A,!0));var W,k,g,R,L,Ms,Ls,tr,vt,fc=j.parseRtpParameters(x),Ec,ks;U||(Ec=j.getIceParameters(x,I),ks=j.getDtlsParameters(x,I),ks.role="client"),Ls=j.parseRtpEncodingParameters(x);var Tc=j.parseRtcpParameters(x),Sc=j.matchPrefix(x,"a=end-of-candidates",I).length>0,Ni=j.matchPrefix(x,"a=candidate:").map(function(Ve){return j.parseCandidate(Ve)}).filter(function(Ve){return Ve.component===1});if((c.type==="offer"||c.type==="answer")&&!U&&N&&F>0&&d.transceivers[F]&&(d._disposeIceAndDtlsTransports(F),d.transceivers[F].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[F].iceTransport=d.transceivers[0].iceTransport,d.transceivers[F].dtlsTransport=d.transceivers[0].dtlsTransport,d.transceivers[F].rtpSender&&d.transceivers[F].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[F].rtpReceiver&&d.transceivers[F].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport)),c.type==="offer"&&!U){W=d.transceivers[F]||d._createTransceiver(A),W.mid=Te,W.iceGatherer||(W.iceGatherer=d._createIceGatherer(F,N)),Ni.length&&W.iceTransport.state==="new"&&(Sc&&(!N||F===0)?W.iceTransport.setRemoteCandidates(Ni):Ni.forEach(function(Ve){Js(W.iceTransport,Ve)})),tr=i.RTCRtpReceiver.getCapabilities(A),t<15019&&(tr.codecs=tr.codecs.filter(function(Ve){return Ve.name!=="rtx"})),Ms=W.sendEncodingParameters||[{ssrc:(2*F+2)*1001}];var xs=!1;if(J==="sendrecv"||J==="sendonly"){if(xs=!W.rtpReceiver,L=W.rtpReceiver||new i.RTCRtpReceiver(W.dtlsTransport,A),xs){var K;vt=L.track,Z&&Z.stream==="-"||(Z?(u[Z.stream]||(u[Z.stream]=new i.MediaStream,Object.defineProperty(u[Z.stream],"id",{get:function(){return Z.stream}})),Object.defineProperty(vt,"id",{get:function(){return Z.track}}),K=u[Z.stream]):(u.default||(u.default=new i.MediaStream),K=u.default)),K&&(e(vt,K),W.associatedRemoteMediaStreams.push(K)),l.push([vt,L,K])}}else W.rtpReceiver&&W.rtpReceiver.track&&(W.associatedRemoteMediaStreams.forEach(function(Ve){var Ic=Ve.getTracks().find(function(bl){return bl.id===W.rtpReceiver.track.id});Ic&&r(Ic,Ve)}),W.associatedRemoteMediaStreams=[]);W.localCapabilities=tr,W.remoteCapabilities=fc,W.rtpReceiver=L,W.rtcpParameters=Tc,W.sendEncodingParameters=Ms,W.recvEncodingParameters=Ls,d._transceive(d.transceivers[F],!1,xs)}else if(c.type==="answer"&&!U){W=d.transceivers[F],k=W.iceGatherer,g=W.iceTransport,R=W.dtlsTransport,L=W.rtpReceiver,Ms=W.sendEncodingParameters,tr=W.localCapabilities,d.transceivers[F].recvEncodingParameters=Ls,d.transceivers[F].remoteCapabilities=fc,d.transceivers[F].rtcpParameters=Tc,Ni.length&&g.state==="new"&&((E||Sc)&&(!N||F===0)?g.setRemoteCandidates(Ni):Ni.forEach(function(Ve){Js(W.iceTransport,Ve)})),(!N||F===0)&&(g.state==="new"&&g.start(k,Ec,"controlling"),R.state==="new"&&R.start(ks));var Dl=_n(W.localCapabilities,W.remoteCapabilities),Ol=Dl.codecs.filter(function(Ve){return Ve.name.toLowerCase()==="rtx"}).length;!Ol&&W.sendEncodingParameters[0].rtx&&delete W.sendEncodingParameters[0].rtx,d._transceive(W,J==="sendrecv"||J==="recvonly",J==="sendrecv"||J==="sendonly"),L&&(J==="sendrecv"||J==="sendonly")?(vt=L.track,Z?(u[Z.stream]||(u[Z.stream]=new i.MediaStream),e(vt,u[Z.stream]),l.push([vt,L,u[Z.stream]])):(u.default||(u.default=new i.MediaStream),e(vt,u.default),l.push([vt,L,u.default]))):delete W.rtpReceiver}}),d._dtlsRole===void 0&&(d._dtlsRole=c.type==="offer"?"active":"passive"),d._remoteDescription={type:c.type,sdp:c.sdp},c.type==="offer"?d._updateSignalingState("have-remote-offer"):d._updateSignalingState("stable"),Object.keys(u).forEach(function(x){var F=u[x];if(F.getTracks().length){if(d.remoteStreams.indexOf(F)===-1){d.remoteStreams.push(F);var Ee=new Event("addstream");Ee.stream=F,i.setTimeout(function(){d._dispatchEvent("addstream",Ee)})}l.forEach(function(A){var U=A[0],v=A[1];F.id===A[2].id&&n(d,U,v,[F])})}}),l.forEach(function(x){x[2]||n(d,x[0],x[1],[])}),i.setTimeout(function(){!(d&&d.transceivers)||d.transceivers.forEach(function(x){x.iceTransport&&x.iceTransport.state==="new"&&x.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),x.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach(function(c){c.iceTransport&&c.iceTransport.stop(),c.dtlsTransport&&c.dtlsTransport.stop(),c.rtpSender&&c.rtpSender.stop(),c.rtpReceiver&&c.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},s.prototype._updateSignalingState=function(c){this.signalingState=c;var d=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",d)},s.prototype._maybeFireNegotiationNeeded=function(){var c=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,i.setTimeout(function(){if(c.needNegotiation){c.needNegotiation=!1;var d=new Event("negotiationneeded");c._dispatchEvent("negotiationneeded",d)}},0))},s.prototype._updateIceConnectionState=function(){var c,d={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(l){l.iceTransport&&!l.rejected&&d[l.iceTransport.state]++}),c="new",d.failed>0?c="failed":d.checking>0?c="checking":d.disconnected>0?c="disconnected":d.new>0?c="new":d.connected>0?c="connected":d.completed>0&&(c="completed"),c!==this.iceConnectionState){this.iceConnectionState=c;var u=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",u)}},s.prototype._updateConnectionState=function(){var c,d={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(l){l.iceTransport&&l.dtlsTransport&&!l.rejected&&(d[l.iceTransport.state]++,d[l.dtlsTransport.state]++)}),d.connected+=d.completed,c="new",d.failed>0?c="failed":d.connecting>0?c="connecting":d.disconnected>0?c="disconnected":d.new>0?c="new":d.connected>0&&(c="connected"),c!==this.connectionState){this.connectionState=c;var u=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",u)}},s.prototype.createOffer=function(){var c=this;if(c._isClosed)return Promise.reject(Ne("InvalidStateError","Can not call createOffer after close"));var d=c.transceivers.filter(function(E){return E.kind==="audio"}).length,u=c.transceivers.filter(function(E){return E.kind==="video"}).length,l=arguments[0];if(l){if(l.mandatory||l.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");l.offerToReceiveAudio!==void 0&&(l.offerToReceiveAudio===!0?d=1:l.offerToReceiveAudio===!1?d=0:d=l.offerToReceiveAudio),l.offerToReceiveVideo!==void 0&&(l.offerToReceiveVideo===!0?u=1:l.offerToReceiveVideo===!1?u=0:u=l.offerToReceiveVideo)}for(c.transceivers.forEach(function(E){E.kind==="audio"?(d--,d<0&&(E.wantReceive=!1)):E.kind==="video"&&(u--,u<0&&(E.wantReceive=!1))});d>0||u>0;)d>0&&(c._createTransceiver("audio"),d--),u>0&&(c._createTransceiver("video"),u--);var m=j.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.transceivers.forEach(function(E,N){var B=E.track,x=E.kind,F=E.mid||j.generateIdentifier();E.mid=F,E.iceGatherer||(E.iceGatherer=c._createIceGatherer(N,c.usingBundle));var Ee=i.RTCRtpSender.getCapabilities(x);t<15019&&(Ee.codecs=Ee.codecs.filter(function(U){return U.name!=="rtx"})),Ee.codecs.forEach(function(U){U.name==="H264"&&U.parameters["level-asymmetry-allowed"]===void 0&&(U.parameters["level-asymmetry-allowed"]="1"),E.remoteCapabilities&&E.remoteCapabilities.codecs&&E.remoteCapabilities.codecs.forEach(function(v){U.name.toLowerCase()===v.name.toLowerCase()&&U.clockRate===v.clockRate&&(U.preferredPayloadType=v.payloadType)})}),Ee.headerExtensions.forEach(function(U){var v=E.remoteCapabilities&&E.remoteCapabilities.headerExtensions||[];v.forEach(function(J){U.uri===J.uri&&(U.id=J.id)})});var A=E.sendEncodingParameters||[{ssrc:(2*N+1)*1001}];B&&t>=15019&&x==="video"&&!A[0].rtx&&(A[0].rtx={ssrc:A[0].ssrc+1}),E.wantReceive&&(E.rtpReceiver=new i.RTCRtpReceiver(E.dtlsTransport,x)),E.localCapabilities=Ee,E.sendEncodingParameters=A}),c._config.bundlePolicy!=="max-compat"&&(m+="a=group:BUNDLE "+c.transceivers.map(function(E){return E.mid}).join(" ")+`\r
`),m+=`a=ice-options:trickle\r
`,c.transceivers.forEach(function(E,N){m+=wc(E,E.localCapabilities,"offer",E.stream,c._dtlsRole),m+=`a=rtcp-rsize\r
`,E.iceGatherer&&c.iceGatheringState!=="new"&&(N===0||!c.usingBundle)&&(E.iceGatherer.getLocalCandidates().forEach(function(B){B.component=1,m+="a="+j.writeCandidate(B)+`\r
`}),E.iceGatherer.state==="completed"&&(m+=`a=end-of-candidates\r
`))});var I=new i.RTCSessionDescription({type:"offer",sdp:m});return Promise.resolve(I)},s.prototype.createAnswer=function(){var c=this;if(c._isClosed)return Promise.reject(Ne("InvalidStateError","Can not call createAnswer after close"));if(!(c.signalingState==="have-remote-offer"||c.signalingState==="have-local-pranswer"))return Promise.reject(Ne("InvalidStateError","Can not call createAnswer in signalingState "+c.signalingState));var d=j.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.usingBundle&&(d+="a=group:BUNDLE "+c.transceivers.map(function(m){return m.mid}).join(" ")+`\r
`),d+=`a=ice-options:trickle\r
`;var u=j.getMediaSections(c._remoteDescription.sdp).length;c.transceivers.forEach(function(m,I){if(!(I+1>u)){if(m.rejected){m.kind==="application"?m.protocol==="DTLS/SCTP"?d+=`m=application 0 DTLS/SCTP 5000\r
`:d+="m=application 0 "+m.protocol+` webrtc-datachannel\r
`:m.kind==="audio"?d+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:m.kind==="video"&&(d+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),d+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+m.mid+`\r
`;return}if(m.stream){var E;m.kind==="audio"?E=m.stream.getAudioTracks()[0]:m.kind==="video"&&(E=m.stream.getVideoTracks()[0]),E&&t>=15019&&m.kind==="video"&&!m.sendEncodingParameters[0].rtx&&(m.sendEncodingParameters[0].rtx={ssrc:m.sendEncodingParameters[0].ssrc+1})}var N=_n(m.localCapabilities,m.remoteCapabilities),B=N.codecs.filter(function(x){return x.name.toLowerCase()==="rtx"}).length;!B&&m.sendEncodingParameters[0].rtx&&delete m.sendEncodingParameters[0].rtx,d+=wc(m,N,"answer",m.stream,c._dtlsRole),m.rtcpParameters&&m.rtcpParameters.reducedSize&&(d+=`a=rtcp-rsize\r
`)}});var l=new i.RTCSessionDescription({type:"answer",sdp:d});return Promise.resolve(l)},s.prototype.addIceCandidate=function(c){var d=this,u;return c&&!(c.sdpMLineIndex!==void 0||c.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(l,m){if(d._remoteDescription)if(!c||c.candidate==="")for(var I=0;I<d.transceivers.length&&!(!d.transceivers[I].rejected&&(d.transceivers[I].iceTransport.addRemoteCandidate({}),u=j.getMediaSections(d._remoteDescription.sdp),u[I]+=`a=end-of-candidates\r
`,d._remoteDescription.sdp=j.getDescription(d._remoteDescription.sdp)+u.join(""),d.usingBundle));I++);else{var E=c.sdpMLineIndex;if(c.sdpMid){for(var N=0;N<d.transceivers.length;N++)if(d.transceivers[N].mid===c.sdpMid){E=N;break}}var B=d.transceivers[E];if(B){if(B.rejected)return l();var x=Object.keys(c.candidate).length>0?j.parseCandidate(c.candidate):{};if(x.protocol==="tcp"&&(x.port===0||x.port===9)||x.component&&x.component!==1)return l();if((E===0||E>0&&B.iceTransport!==d.transceivers[0].iceTransport)&&!Js(B.iceTransport,x))return m(Ne("OperationError","Can not add ICE candidate"));var F=c.candidate.trim();F.indexOf("a=")===0&&(F=F.substr(2)),u=j.getMediaSections(d._remoteDescription.sdp),u[E]+="a="+(x.type?F:"end-of-candidates")+`\r
`,d._remoteDescription.sdp=j.getDescription(d._remoteDescription.sdp)+u.join("")}else return m(Ne("OperationError","Can not add ICE candidate"))}else return m(Ne("InvalidStateError","Can not add ICE candidate without a remote description"));l()})},s.prototype.getStats=function(c){if(c&&c instanceof i.MediaStreamTrack){var d=null;if(this.transceivers.forEach(function(l){l.rtpSender&&l.rtpSender.track===c?d=l.rtpSender:l.rtpReceiver&&l.rtpReceiver.track===c&&(d=l.rtpReceiver)}),!d)throw Ne("InvalidAccessError","Invalid selector.");return d.getStats()}var u=[];return this.transceivers.forEach(function(l){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(m){l[m]&&u.push(l[m].getStats())})}),Promise.all(u).then(function(l){var m=new Map;return l.forEach(function(I){I.forEach(function(E){m.set(E.id,E)})}),m})};var o=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];o.forEach(function(c){var d=i[c];if(d&&d.prototype&&d.prototype.getStats){var u=d.prototype.getStats;d.prototype.getStats=function(){return u.apply(this).then(function(l){var m=new Map;return Object.keys(l).forEach(function(I){l[I].type=hp(l[I]),m.set(I,l[I])}),m})}}});var a=["createOffer","createAnswer"];return a.forEach(function(c){var d=s.prototype[c];s.prototype[c]=function(){var u=arguments;return typeof u[0]=="function"||typeof u[1]=="function"?d.apply(this,[arguments[2]]).then(function(l){typeof u[0]=="function"&&u[0].apply(null,[l])},function(l){typeof u[1]=="function"&&u[1].apply(null,[l])}):d.apply(this,arguments)}}),a=["setLocalDescription","setRemoteDescription","addIceCandidate"],a.forEach(function(c){var d=s.prototype[c];s.prototype[c]=function(){var u=arguments;return typeof u[1]=="function"||typeof u[2]=="function"?d.apply(this,arguments).then(function(){typeof u[1]=="function"&&u[1].apply(null)},function(l){typeof u[2]=="function"&&u[2].apply(null,[l])}):d.apply(this,arguments)}}),["getStats"].forEach(function(c){var d=s.prototype[c];s.prototype[c]=function(){var u=arguments;return typeof u[1]=="function"?d.apply(this,arguments).then(function(){typeof u[1]=="function"&&u[1].apply(null)}):d.apply(this,arguments)}}),s}});var Fc=me(Ft=>{"use strict";var L_=h(_());Object.defineProperty(Ft,"__esModule",{value:!0});Ft.shimGetDisplayMedia=Ft.shimGetUserMedia=void 0;var fp=xc();Object.defineProperty(Ft,"shimGetUserMedia",{enumerable:!0,get:function(){return fp.shimGetUserMedia}});var Ep=Uc();Object.defineProperty(Ft,"shimGetDisplayMedia",{enumerable:!0,get:function(){return Ep.shimGetDisplayMedia}});Ft.shimPeerConnection=vp;Ft.shimReplaceTrack=yp;var Tp=ot(),Sp=Cp(Tp),Ip=Vc(),gp=Hc(),Rp=Ap(gp);function Ap(i){return i&&i.__esModule?i:{default:i}}function Cp(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function vp(i,t){if(i.RTCIceGatherer&&(i.RTCIceCandidate||(i.RTCIceCandidate=function(s){return s}),i.RTCSessionDescription||(i.RTCSessionDescription=function(s){return s}),t.version<15025)){var e=Object.getOwnPropertyDescriptor(i.MediaStreamTrack.prototype,"enabled");Object.defineProperty(i.MediaStreamTrack.prototype,"enabled",{set:function(s){e.set.call(this,s);var o=new Event("enabled");o.enabled=s,this.dispatchEvent(o)}})}i.RTCRtpSender&&!("dtmf"in i.RTCRtpSender.prototype)&&Object.defineProperty(i.RTCRtpSender.prototype,"dtmf",{get:function(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=new i.RTCDtmfSender(this):this.track.kind==="video"&&(this._dtmf=null)),this._dtmf}}),i.RTCDtmfSender&&!i.RTCDTMFSender&&(i.RTCDTMFSender=i.RTCDtmfSender);var r=(0,Rp.default)(i,t.version);i.RTCPeerConnection=function(s){return s&&s.iceServers&&(s.iceServers=(0,Ip.filterIceServers)(s.iceServers,t.version),Sp.log("ICE servers after filtering:",s.iceServers)),new r(s)},i.RTCPeerConnection.prototype=r.prototype}function yp(i){i.RTCRtpSender&&!("replaceTrack"in i.RTCRtpSender.prototype)&&(i.RTCRtpSender.prototype.replaceTrack=i.RTCRtpSender.prototype.setTrack)}});var Gc=me(Ys=>{"use strict";var x_=h(_());Object.defineProperty(Ys,"__esModule",{value:!0});var Xs=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};Ys.shimGetUserMedia=bp;var Np=ot(),Dp=Op(Np);function Op(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function bp(i,t){var e=i&&i.navigator,r=i&&i.MediaStreamTrack;if(e.getUserMedia=function(c,d,u){Dp.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(c).then(d,u)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){var n=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])},s=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(c){return(typeof c=="undefined"?"undefined":Xs(c))==="object"&&Xs(c.audio)==="object"&&(c=JSON.parse(JSON.stringify(c)),n(c.audio,"autoGainControl","mozAutoGainControl"),n(c.audio,"noiseSuppression","mozNoiseSuppression")),s(c)},r&&r.prototype.getSettings){var o=r.prototype.getSettings;r.prototype.getSettings=function(){var c=o.apply(this,arguments);return n(c,"mozAutoGainControl","autoGainControl"),n(c,"mozNoiseSuppression","noiseSuppression"),c}}if(r&&r.prototype.applyConstraints){var a=r.prototype.applyConstraints;r.prototype.applyConstraints=function(c){return this.kind==="audio"&&(typeof c=="undefined"?"undefined":Xs(c))==="object"&&(c=JSON.parse(JSON.stringify(c)),n(c,"autoGainControl","mozAutoGainControl"),n(c,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[c])}}}}});var Wc=me(qs=>{"use strict";var V_=h(_());Object.defineProperty(qs,"__esModule",{value:!0});qs.shimGetDisplayMedia=Pp;function Pp(i,t){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||!i.navigator.mediaDevices||(i.navigator.mediaDevices.getDisplayMedia=function(r){if(!(r&&r.video)){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return r.video===!0?r.video={mediaSource:t}:r.video.mediaSource=t,i.navigator.mediaDevices.getUserMedia(r)})}});var jc=me(De=>{"use strict";var B_=h(_());Object.defineProperty(De,"__esModule",{value:!0});De.shimGetDisplayMedia=De.shimGetUserMedia=void 0;var Gt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},Mp=Gc();Object.defineProperty(De,"shimGetUserMedia",{enumerable:!0,get:function(){return Mp.shimGetUserMedia}});var Lp=Wc();Object.defineProperty(De,"shimGetDisplayMedia",{enumerable:!0,get:function(){return Lp.shimGetDisplayMedia}});De.shimOnTrack=Vp;De.shimPeerConnection=wp;De.shimSenderGetStats=Bp;De.shimReceiverGetStats=$p;De.shimRemoveStream=Hp;De.shimRTCDataChannel=Fp;De.shimAddTransceiver=Gp;De.shimGetParameters=Wp;De.shimCreateOffer=Kp;De.shimCreateAnswer=jp;var kp=ot(),Kc=xp(kp);function xp(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function Up(i,t,e){return t in i?Object.defineProperty(i,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[t]=e,i}function Vp(i){(typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function wp(i,t){if(!((typeof i=="undefined"?"undefined":Gt(i))!=="object"||!(i.RTCPeerConnection||i.mozRTCPeerConnection))){!i.RTCPeerConnection&&i.mozRTCPeerConnection&&(i.RTCPeerConnection=i.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){var s=i.RTCPeerConnection.prototype[n],o=Up({},n,function(){return arguments[0]=new(n==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)});i.RTCPeerConnection.prototype[n]=o[n]});var e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){var s=Array.prototype.slice.call(arguments),o=s[0],a=s[1],c=s[2];return r.apply(this,[o||null]).then(function(d){if(t.version<53&&!a)try{d.forEach(function(u){u.type=e[u.type]||u.type})}catch(u){if(u.name!=="TypeError")throw u;d.forEach(function(l,m){d.set(m,Object.assign({},l,{type:e[l.type]||l.type}))})}return d}).then(a,c)}}}function Bp(i){if(!!((typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCPeerConnection&&i.RTCRtpSender)&&!(i.RTCRtpSender&&"getStats"in i.RTCRtpSender.prototype)){var t=i.RTCPeerConnection.prototype.getSenders;t&&(i.RTCPeerConnection.prototype.getSenders=function(){var n=this,s=t.apply(this,[]);return s.forEach(function(o){return o._pc=n}),s});var e=i.RTCPeerConnection.prototype.addTrack;e&&(i.RTCPeerConnection.prototype.addTrack=function(){var n=e.apply(this,arguments);return n._pc=this,n}),i.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}}function $p(i){if(!!((typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCPeerConnection&&i.RTCRtpSender)&&!(i.RTCRtpSender&&"getStats"in i.RTCRtpReceiver.prototype)){var t=i.RTCPeerConnection.prototype.getReceivers;t&&(i.RTCPeerConnection.prototype.getReceivers=function(){var r=this,n=t.apply(this,[]);return n.forEach(function(s){return s._pc=r}),n}),Kc.wrapPeerConnectionEvent(i,"track",function(e){return e.receiver._pc=e.srcElement,e}),i.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}}function Hp(i){!i.RTCPeerConnection||"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(e){var r=this;Kc.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(n){n.track&&e.getTracks().includes(n.track)&&r.removeTrack(n)})})}function Fp(i){i.DataChannel&&!i.RTCDataChannel&&(i.RTCDataChannel=i.DataChannel)}function Gp(i){if(!!((typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCPeerConnection)){var t=i.RTCPeerConnection.prototype.addTransceiver;t&&(i.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var r=arguments[1],n=r&&"sendEncodings"in r;n&&r.sendEncodings.forEach(function(c){if("rid"in c){var d=/^[a-z0-9]{0,16}$/i;if(!d.test(c.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in c&&!(parseFloat(c.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in c&&!(parseFloat(c.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});var s=t.apply(this,arguments);if(n){var o=s.sender,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=r.sendEncodings,o.sendEncodings=r.sendEncodings,this.setParametersPromises.push(o.setParameters(a).then(function(){delete o.sendEncodings}).catch(function(){delete o.sendEncodings})))}return s})}}function Wp(i){if(!!((typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCRtpSender)){var t=i.RTCRtpSender.prototype.getParameters;t&&(i.RTCRtpSender.prototype.getParameters=function(){var r=t.apply(this,arguments);return"encodings"in r||(r.encodings=[].concat(this.sendEncodings||[{}])),r})}}function Kp(i){if(!!((typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCPeerConnection)){var t=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(){var r=this,n=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return t.apply(r,n)}).finally(function(){r.setParametersPromises=[]}):t.apply(this,arguments)}}}function jp(i){if(!!((typeof i=="undefined"?"undefined":Gt(i))==="object"&&i.RTCPeerConnection)){var t=i.RTCPeerConnection.prototype.createAnswer;i.RTCPeerConnection.prototype.createAnswer=function(){var r=this,n=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return t.apply(r,n)}).finally(function(){r.setParametersPromises=[]}):t.apply(this,arguments)}}}});var Yc=me(Ze=>{"use strict";var H_=h(_());Object.defineProperty(Ze,"__esModule",{value:!0});var or=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};Ze.shimLocalStreamsAPI=Yp;Ze.shimRemoteStreamsAPI=qp;Ze.shimCallbacksAPI=zp;Ze.shimGetUserMedia=Qp;Ze.shimConstraints=Xc;Ze.shimRTCIceServerUrls=Zp;Ze.shimTrackEventTransceiver=em;Ze.shimCreateOfferLegacy=tm;Ze.shimAudioContext=im;var Jp=ot(),Jc=Xp(Jp);function Xp(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function Yp(i){if(!((typeof i=="undefined"?"undefined":or(i))!=="object"||!i.RTCPeerConnection)){if("getLocalStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in i.RTCPeerConnection.prototype)){var t=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addStream=function(r){var n=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(r)||this._localStreams.push(r),r.getAudioTracks().forEach(function(s){return t.call(n,s,r)}),r.getVideoTracks().forEach(function(s){return t.call(n,s,r)})},i.RTCPeerConnection.prototype.addTrack=function(r){for(var n=this,s=arguments.length,o=Array(s>1?s-1:0),a=1;a<s;a++)o[a-1]=arguments[a];return o&&o.forEach(function(c){n._localStreams?n._localStreams.includes(c)||n._localStreams.push(c):n._localStreams=[c]}),t.apply(this,arguments)}}"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(r){var n=this;this._localStreams||(this._localStreams=[]);var s=this._localStreams.indexOf(r);if(s!==-1){this._localStreams.splice(s,1);var o=r.getTracks();this.getSenders().forEach(function(a){o.includes(a.track)&&n.removeTrack(a)})}})}}function qp(i){if(!((typeof i=="undefined"?"undefined":or(i))!=="object"||!i.RTCPeerConnection)&&("getRemoteStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in i.RTCPeerConnection.prototype))){Object.defineProperty(i.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(r){var n=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=r),this.addEventListener("track",this._onaddstreampoly=function(s){s.streams.forEach(function(o){if(n._remoteStreams||(n._remoteStreams=[]),!n._remoteStreams.includes(o)){n._remoteStreams.push(o);var a=new Event("addstream");a.stream=o,n.dispatchEvent(a)}})})}});var t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(function(s){if(r._remoteStreams||(r._remoteStreams=[]),!(r._remoteStreams.indexOf(s)>=0)){r._remoteStreams.push(s);var o=new Event("addstream");o.stream=s,r.dispatchEvent(o)}})}),t.apply(r,arguments)}}}function zp(i){if(!((typeof i=="undefined"?"undefined":or(i))!=="object"||!i.RTCPeerConnection)){var t=i.RTCPeerConnection.prototype,e=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(d,u){var l=arguments.length>=2?arguments[2]:arguments[0],m=e.apply(this,[l]);return u?(m.then(d,u),Promise.resolve()):m},t.createAnswer=function(d,u){var l=arguments.length>=2?arguments[2]:arguments[0],m=r.apply(this,[l]);return u?(m.then(d,u),Promise.resolve()):m};var a=function(d,u,l){var m=n.apply(this,[d]);return l?(m.then(u,l),Promise.resolve()):m};t.setLocalDescription=a,a=function(d,u,l){var m=s.apply(this,[d]);return l?(m.then(u,l),Promise.resolve()):m},t.setRemoteDescription=a,a=function(d,u,l){var m=o.apply(this,[d]);return l?(m.then(u,l),Promise.resolve()):m},t.addIceCandidate=a}}function Qp(i){var t=i&&i.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=function(n){return r(Xc(n))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(s,o,a){t.mediaDevices.getUserMedia(s).then(o,a)}.bind(t))}function Xc(i){return i&&i.video!==void 0?Object.assign({},i,{video:Jc.compactObject(i.video)}):i}function Zp(i){if(!!i.RTCPeerConnection){var t=i.RTCPeerConnection;i.RTCPeerConnection=function(r,n){if(r&&r.iceServers){for(var s=[],o=0;o<r.iceServers.length;o++){var a=r.iceServers[o];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(Jc.deprecated("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,s.push(a)):s.push(r.iceServers[o])}r.iceServers=s}return new t(r,n)},i.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(i.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})}}function em(i){(typeof i=="undefined"?"undefined":or(i))==="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function tm(i){var t=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(r){if(r){typeof r.offerToReceiveAudio!="undefined"&&(r.offerToReceiveAudio=!!r.offerToReceiveAudio);var n=this.getTransceivers().find(function(o){return o.receiver.track.kind==="audio"});r.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):r.offerToReceiveAudio===!0&&!n&&this.addTransceiver("audio"),typeof r.offerToReceiveVideo!="undefined"&&(r.offerToReceiveVideo=!!r.offerToReceiveVideo);var s=this.getTransceivers().find(function(o){return o.receiver.track.kind==="video"});r.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):r.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video")}return t.apply(this,arguments)}}function im(i){(typeof i=="undefined"?"undefined":or(i))!=="object"||i.AudioContext||(i.AudioContext=i.webkitAudioContext)}});var zc=me(Wt=>{"use strict";var G_=h(_());Object.defineProperty(Wt,"__esModule",{value:!0});var rm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};Wt.shimRTCIceCandidate=cm;Wt.shimMaxMessageSize=dm;Wt.shimSendThrowTypeError=um;Wt.shimConnectionState=lm;Wt.removeExtmapAllowMixed=pm;Wt.shimAddIceCandidateNullOrEmpty=mm;var nm=js(),fn=am(nm),sm=ot(),qc=om(sm);function om(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function am(i){return i&&i.__esModule?i:{default:i}}function cm(i){if(!(!i.RTCIceCandidate||i.RTCIceCandidate&&"foundation"in i.RTCIceCandidate.prototype)){var t=i.RTCIceCandidate;i.RTCIceCandidate=function(r){if((typeof r=="undefined"?"undefined":rm(r))==="object"&&r.candidate&&r.candidate.indexOf("a=")===0&&(r=JSON.parse(JSON.stringify(r)),r.candidate=r.candidate.substr(2)),r.candidate&&r.candidate.length){var n=new t(r),s=fn.default.parseCandidate(r.candidate),o=Object.assign(n,s);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new t(r)},i.RTCIceCandidate.prototype=t.prototype,qc.wrapPeerConnectionEvent(i,"icecandidate",function(e){return e.candidate&&Object.defineProperty(e,"candidate",{value:new i.RTCIceCandidate(e.candidate),writable:"false"}),e})}}function dm(i,t){if(!!i.RTCPeerConnection){"sctp"in i.RTCPeerConnection.prototype||Object.defineProperty(i.RTCPeerConnection.prototype,"sctp",{get:function(){return typeof this._sctp=="undefined"?null:this._sctp}});var e=function(c){if(!c||!c.sdp)return!1;var d=fn.default.splitSections(c.sdp);return d.shift(),d.some(function(u){var l=fn.default.parseMLine(u);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},r=function(c){var d=c.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(d===null||d.length<2)return-1;var u=parseInt(d[1],10);return u!==u?-1:u},n=function(c){var d=65536;return t.browser==="firefox"&&(t.version<57?c===-1?d=16384:d=2147483637:t.version<60?d=t.version===57?65535:65536:d=2147483637),d},s=function(c,d){var u=65536;t.browser==="firefox"&&t.version===57&&(u=65535);var l=fn.default.matchPrefix(c.sdp,"a=max-message-size:");return l.length>0?u=parseInt(l[0].substr(19),10):t.browser==="firefox"&&d!==-1&&(u=2147483637),u},o=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){var c=this.getConfiguration(),d=c.sdpSemantics;d==="plan-b"&&Object.defineProperty(this,"sctp",{get:function(){return typeof this._sctp=="undefined"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){var u=r(arguments[0]),l=n(u),m=s(arguments[0],u),I=void 0;l===0&&m===0?I=Number.POSITIVE_INFINITY:l===0||m===0?I=Math.max(l,m):I=Math.min(l,m);var E={};Object.defineProperty(E,"maxMessageSize",{get:function(){return I}}),this._sctp=E}return o.apply(this,arguments)}}}function um(i){if(!(i.RTCPeerConnection&&"createDataChannel"in i.RTCPeerConnection.prototype))return;function t(r,n){var s=r.send;r.send=function(){var a=arguments[0],c=a.length||a.size||a.byteLength;if(r.readyState==="open"&&n.sctp&&c>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return s.apply(r,arguments)}}var e=i.RTCPeerConnection.prototype.createDataChannel;i.RTCPeerConnection.prototype.createDataChannel=function(){var n=e.apply(this,arguments);return t(n,this),n},qc.wrapPeerConnectionEvent(i,"datachannel",function(r){return t(r.channel,r.target),r})}function lm(i){if(!(!i.RTCPeerConnection||"connectionState"in i.RTCPeerConnection.prototype)){var t=i.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(r){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),r&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=r)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(n){var s=n.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;var o=new Event("connectionstatechange",n);s.dispatchEvent(o)}return n},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}}function pm(i,t){if(!!i.RTCPeerConnection&&!(t.browser==="chrome"&&t.version>=71)&&!(t.browser==="safari"&&t.version>=605)){var e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){var s=n.sdp.split(`
`).filter(function(o){return o.trim()!=="a=extmap-allow-mixed"}).join(`
`);i.RTCSessionDescription&&n instanceof i.RTCSessionDescription?arguments[0]=new i.RTCSessionDescription({type:n.type,sdp:s}):n.sdp=s}return e.apply(this,arguments)}}}function mm(i,t){if(!!(i.RTCPeerConnection&&i.RTCPeerConnection.prototype)){var e=i.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(i.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}}});var Qc=me(zs=>{"use strict";var K_=h(_());Object.defineProperty(zs,"__esModule",{value:!0});zs.adapterFactory=Im;var hm=ot(),ar=Di(hm),_m=kc(),Ye=Di(_m),fm=Fc(),ni=Di(fm),Em=jc(),we=Di(Em),Tm=Yc(),at=Di(Tm),Sm=zc(),Se=Di(Sm);function Di(i){if(i&&i.__esModule)return i;var t={};if(i!=null)for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t.default=i,t}function Im(){var i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=i.window,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},r=ar.log,n=ar.detectBrowser(t),s={browserDetails:n,commonShim:Se,extractVersion:ar.extractVersion,disableLog:ar.disableLog,disableWarnings:ar.disableWarnings};switch(n.browser){case"chrome":if(!Ye||!Ye.shimPeerConnection||!e.shimChrome)return r("Chrome shim is not included in this adapter release."),s;if(n.version===null)return r("Chrome shim can not determine version, not shimming."),s;r("adapter.js shimming chrome."),s.browserShim=Ye,Se.shimAddIceCandidateNullOrEmpty(t,n),Ye.shimGetUserMedia(t,n),Ye.shimMediaStream(t,n),Ye.shimPeerConnection(t,n),Ye.shimOnTrack(t,n),Ye.shimAddTrackRemoveTrack(t,n),Ye.shimGetSendersWithDtmf(t,n),Ye.shimGetStats(t,n),Ye.shimSenderReceiverGetStats(t,n),Ye.fixNegotiationNeeded(t,n),Se.shimRTCIceCandidate(t,n),Se.shimConnectionState(t,n),Se.shimMaxMessageSize(t,n),Se.shimSendThrowTypeError(t,n),Se.removeExtmapAllowMixed(t,n);break;case"firefox":if(!we||!we.shimPeerConnection||!e.shimFirefox)return r("Firefox shim is not included in this adapter release."),s;r("adapter.js shimming firefox."),s.browserShim=we,Se.shimAddIceCandidateNullOrEmpty(t,n),we.shimGetUserMedia(t,n),we.shimPeerConnection(t,n),we.shimOnTrack(t,n),we.shimRemoveStream(t,n),we.shimSenderGetStats(t,n),we.shimReceiverGetStats(t,n),we.shimRTCDataChannel(t,n),we.shimAddTransceiver(t,n),we.shimGetParameters(t,n),we.shimCreateOffer(t,n),we.shimCreateAnswer(t,n),Se.shimRTCIceCandidate(t,n),Se.shimConnectionState(t,n),Se.shimMaxMessageSize(t,n),Se.shimSendThrowTypeError(t,n);break;case"edge":if(!ni||!ni.shimPeerConnection||!e.shimEdge)return r("MS edge shim is not included in this adapter release."),s;r("adapter.js shimming edge."),s.browserShim=ni,ni.shimGetUserMedia(t,n),ni.shimGetDisplayMedia(t,n),ni.shimPeerConnection(t,n),ni.shimReplaceTrack(t,n),Se.shimMaxMessageSize(t,n),Se.shimSendThrowTypeError(t,n);break;case"safari":if(!at||!e.shimSafari)return r("Safari shim is not included in this adapter release."),s;r("adapter.js shimming safari."),s.browserShim=at,Se.shimAddIceCandidateNullOrEmpty(t,n),at.shimRTCIceServerUrls(t,n),at.shimCreateOfferLegacy(t,n),at.shimCallbacksAPI(t,n),at.shimLocalStreamsAPI(t,n),at.shimRemoteStreamsAPI(t,n),at.shimTrackEventTransceiver(t,n),at.shimGetUserMedia(t,n),at.shimAudioContext(t,n),Se.shimRTCIceCandidate(t,n),Se.shimMaxMessageSize(t,n),Se.shimSendThrowTypeError(t,n),Se.removeExtmapAllowMixed(t,n);break;default:r("Unsupported browser!");break}return s}});var _=me(Qs=>{"use strict";Object.defineProperty(Qs,"__esModule",{value:!0});var gm=Qc(),Rm=(0,gm.adapterFactory)({window:typeof window=="undefined"?void 0:window});Qs.default=Rm});var ft=me((qf,Po)=>{"use strict";var zf=h(_()),Xm=Object.prototype.hasOwnProperty,xe="~";function xr(){}Object.create&&(xr.prototype=Object.create(null),new xr().__proto__||(xe=!1));function Ym(i,t,e){this.fn=i,this.context=t,this.once=e||!1}function Ud(i,t,e,r,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var s=new Ym(e,r||i,n),o=xe?xe+t:t;return i._events[o]?i._events[o].fn?i._events[o]=[i._events[o],s]:i._events[o].push(s):(i._events[o]=s,i._eventsCount++),i}function jn(i,t){--i._eventsCount===0?i._events=new xr:delete i._events[t]}function be(){this._events=new xr,this._eventsCount=0}be.prototype.eventNames=function(){var t=[],e,r;if(this._eventsCount===0)return t;for(r in e=this._events)Xm.call(e,r)&&t.push(xe?r.slice(1):r);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};be.prototype.listeners=function(t){var e=xe?xe+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,s=r.length,o=new Array(s);n<s;n++)o[n]=r[n].fn;return o};be.prototype.listenerCount=function(t){var e=xe?xe+t:t,r=this._events[e];return r?r.fn?1:r.length:0};be.prototype.emit=function(t,e,r,n,s,o){var a=xe?xe+t:t;if(!this._events[a])return!1;var c=this._events[a],d=arguments.length,u,l;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,r),!0;case 4:return c.fn.call(c.context,e,r,n),!0;case 5:return c.fn.call(c.context,e,r,n,s),!0;case 6:return c.fn.call(c.context,e,r,n,s,o),!0}for(l=1,u=new Array(d-1);l<d;l++)u[l-1]=arguments[l];c.fn.apply(c.context,u)}else{var m=c.length,I;for(l=0;l<m;l++)switch(c[l].once&&this.removeListener(t,c[l].fn,void 0,!0),d){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,e);break;case 3:c[l].fn.call(c[l].context,e,r);break;case 4:c[l].fn.call(c[l].context,e,r,n);break;default:if(!u)for(I=1,u=new Array(d-1);I<d;I++)u[I-1]=arguments[I];c[l].fn.apply(c[l].context,u)}}return!0};be.prototype.on=function(t,e,r){return Ud(this,t,e,r,!1)};be.prototype.once=function(t,e,r){return Ud(this,t,e,r,!0)};be.prototype.removeListener=function(t,e,r,n){var s=xe?xe+t:t;if(!this._events[s])return this;if(!e)return jn(this,s),this;var o=this._events[s];if(o.fn)o.fn===e&&(!n||o.once)&&(!r||o.context===r)&&jn(this,s);else{for(var a=0,c=[],d=o.length;a<d;a++)(o[a].fn!==e||n&&!o[a].once||r&&o[a].context!==r)&&c.push(o[a]);c.length?this._events[s]=c.length===1?c[0]:c:jn(this,s)}return this};be.prototype.removeAllListeners=function(t){var e;return t?(e=xe?xe+t:t,this._events[e]&&jn(this,e)):(this._events=new xr,this._eventsCount=0),this};be.prototype.off=be.prototype.removeListener;be.prototype.addListener=be.prototype.on;be.prefixed=xe;be.EventEmitter=be;typeof Po!="undefined"&&(Po.exports=be)});var Za=me((rD,el)=>{var nD=h(_()),Zu=el.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(i){return i.encoding?"rtpmap:%d %s/%s/%s":i.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(i){return i.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(i){return i.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(i){return"extmap:%d"+(i.direction?"/%s":"%v")+(i["encrypt-uri"]?" %s":"%v")+" %s"+(i.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(i){return i.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(i){var t="candidate:%s %d %s %d %s %d typ %s";return t+=i.raddr!=null?" raddr %s rport %d":"%v%v",t+=i.tcptype!=null?" tcptype %s":"%v",i.generation!=null&&(t+=" generation %d"),t+=i["network-id"]!=null?" network-id %d":"%v",t+=i["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(i){var t="ssrc:%d";return i.attribute!=null&&(t+=" %s",i.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(i){return i.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(i){return i.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(i){return"imageattr:%s %s %s"+(i.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(i){return"simulcast:%s %s"+(i.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(i){return"ts-refclk:%s"+(i.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(i){var t="mediaclk:";return t+=i.id!=null?"id=%s %s":"%v%s",t+=i.mediaClockValue!=null?"=%s":"",t+=i.rateNumerator!=null?" rate=%s":"",t+=i.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Zu).forEach(function(i){var t=Zu[i];t.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})});var rl=me(Bt=>{var oD=h(_()),Qi=function(i){return String(Number(i))===i?Number(i):i},Yh=function(i,t,e,r){if(r&&!e)t[r]=Qi(i[1]);else for(var n=0;n<e.length;n+=1)i[n+1]!=null&&(t[e[n]]=Qi(i[n+1]))},qh=function(i,t,e){var r=i.name&&i.names;i.push&&!t[i.push]?t[i.push]=[]:r&&!t[i.name]&&(t[i.name]={});var n=i.push?{}:r?t[i.name]:t;Yh(e.match(i.reg),n,i.names,i.name),i.push&&t[i.push].push(n)},tl=Za(),zh=RegExp.prototype.test.bind(/^([a-z])=(.*)/);Bt.parse=function(i){var t={},e=[],r=t;return i.split(/(\r\n|\r|\n)/).filter(zh).forEach(function(n){var s=n[0],o=n.slice(2);s==="m"&&(e.push({rtp:[],fmtp:[]}),r=e[e.length-1]);for(var a=0;a<(tl[s]||[]).length;a+=1){var c=tl[s][a];if(c.reg.test(o))return qh(c,r,o)}}),t.media=e,t};var il=function(i,t){var e=t.split(/=(.+)/,2);return e.length===2?i[e[0]]=Qi(e[1]):e.length===1&&t.length>1&&(i[e[0]]=void 0),i};Bt.parseParams=function(i){return i.split(/;\s?/).reduce(il,{})};Bt.parseFmtpConfig=Bt.parseParams;Bt.parsePayloads=function(i){return i.toString().split(" ").map(Number)};Bt.parseRemoteCandidates=function(i){for(var t=[],e=i.split(" ").map(Qi),r=0;r<e.length;r+=3)t.push({component:e[r],ip:e[r+1],port:e[r+2]});return t};Bt.parseImageAttributes=function(i){return i.split(" ").map(function(t){return t.substring(1,t.length-1).split(",").reduce(il,{})})};Bt.parseSimulcastStreamList=function(i){return i.split(";").map(function(t){return t.split(",").map(function(e){var r,n=!1;return e[0]!=="~"?r=Qi(e):(r=Qi(e.substring(1,e.length)),n=!0),{scid:r,paused:n}})})}});var sl=me((aD,nl)=>{var cD=h(_()),ec=Za(),Qh=/%[sdv%]/g,Zh=function(i){var t=1,e=arguments,r=e.length;return i.replace(Qh,function(n){if(t>=r)return n;var s=e[t];switch(t+=1,n){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}})},en=function(i,t,e){var r=t.format instanceof Function?t.format(t.push?e:e[t.name]):t.format,n=[i+"="+r];if(t.names)for(var s=0;s<t.names.length;s+=1){var o=t.names[s];t.name?n.push(e[t.name][o]):n.push(e[t.names[s]])}else n.push(e[t.name]);return Zh.apply(null,n)},e_=["v","o","s","i","u","e","p","c","b","t","r","z","a"],t_=["i","c","b","a"];nl.exports=function(i,t){t=t||{},i.version==null&&(i.version=0),i.name==null&&(i.name=" "),i.media.forEach(function(s){s.payloads==null&&(s.payloads="")});var e=t.outerOrder||e_,r=t.innerOrder||t_,n=[];return e.forEach(function(s){ec[s].forEach(function(o){o.name in i&&i[o.name]!=null?n.push(en(s,o,i)):o.push in i&&i[o.push]!=null&&i[o.push].forEach(function(a){n.push(en(s,o,a))})})}),i.media.forEach(function(s){n.push(en("m",ec.m[0],s)),r.forEach(function(o){ec[o].forEach(function(a){a.name in s&&s[a.name]!=null?n.push(en(o,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(c){n.push(en(o,a,c))})})})}),n.join(`\r
`)+`\r
`}});var ol=me($t=>{var uD=h(_()),Ai=rl(),i_=sl();$t.write=i_;$t.parse=Ai.parse;$t.parseParams=Ai.parseParams;$t.parseFmtpConfig=Ai.parseFmtpConfig;$t.parsePayloads=Ai.parsePayloads;$t.parseRemoteCandidates=Ai.parseRemoteCandidates;$t.parseImageAttributes=Ai.parseImageAttributes;$t.parseSimulcastStreamList=Ai.parseSimulcastStreamList});var pc=me((gl,Ds)=>{var Jb=h(_());(function(i){"use strict";function t(A,U){var v=(A&65535)+(U&65535),J=(A>>16)+(U>>16)+(v>>16);return J<<16|v&65535}function e(A,U){return A<<U|A>>>32-U}function r(A,U,v,J,Z,Te){return t(e(t(t(U,A),t(J,Te)),Z),v)}function n(A,U,v,J,Z,Te,W){return r(U&v|~U&J,A,U,Z,Te,W)}function s(A,U,v,J,Z,Te,W){return r(U&J|v&~J,A,U,Z,Te,W)}function o(A,U,v,J,Z,Te,W){return r(U^v^J,A,U,Z,Te,W)}function a(A,U,v,J,Z,Te,W){return r(v^(U|~J),A,U,Z,Te,W)}function c(A,U){A[U>>5]|=128<<U%32,A[(U+64>>>9<<4)+14]=U;var v,J,Z,Te,W,k=1732584193,g=-271733879,R=-1732584194,L=271733878;for(v=0;v<A.length;v+=16)J=k,Z=g,Te=R,W=L,k=n(k,g,R,L,A[v],7,-680876936),L=n(L,k,g,R,A[v+1],12,-389564586),R=n(R,L,k,g,A[v+2],17,606105819),g=n(g,R,L,k,A[v+3],22,-1044525330),k=n(k,g,R,L,A[v+4],7,-176418897),L=n(L,k,g,R,A[v+5],12,1200080426),R=n(R,L,k,g,A[v+6],17,-1473231341),g=n(g,R,L,k,A[v+7],22,-45705983),k=n(k,g,R,L,A[v+8],7,1770035416),L=n(L,k,g,R,A[v+9],12,-1958414417),R=n(R,L,k,g,A[v+10],17,-42063),g=n(g,R,L,k,A[v+11],22,-1990404162),k=n(k,g,R,L,A[v+12],7,1804603682),L=n(L,k,g,R,A[v+13],12,-40341101),R=n(R,L,k,g,A[v+14],17,-1502002290),g=n(g,R,L,k,A[v+15],22,1236535329),k=s(k,g,R,L,A[v+1],5,-165796510),L=s(L,k,g,R,A[v+6],9,-1069501632),R=s(R,L,k,g,A[v+11],14,643717713),g=s(g,R,L,k,A[v],20,-373897302),k=s(k,g,R,L,A[v+5],5,-701558691),L=s(L,k,g,R,A[v+10],9,38016083),R=s(R,L,k,g,A[v+15],14,-660478335),g=s(g,R,L,k,A[v+4],20,-405537848),k=s(k,g,R,L,A[v+9],5,568446438),L=s(L,k,g,R,A[v+14],9,-1019803690),R=s(R,L,k,g,A[v+3],14,-187363961),g=s(g,R,L,k,A[v+8],20,1163531501),k=s(k,g,R,L,A[v+13],5,-1444681467),L=s(L,k,g,R,A[v+2],9,-51403784),R=s(R,L,k,g,A[v+7],14,1735328473),g=s(g,R,L,k,A[v+12],20,-1926607734),k=o(k,g,R,L,A[v+5],4,-378558),L=o(L,k,g,R,A[v+8],11,-2022574463),R=o(R,L,k,g,A[v+11],16,1839030562),g=o(g,R,L,k,A[v+14],23,-35309556),k=o(k,g,R,L,A[v+1],4,-1530992060),L=o(L,k,g,R,A[v+4],11,1272893353),R=o(R,L,k,g,A[v+7],16,-155497632),g=o(g,R,L,k,A[v+10],23,-1094730640),k=o(k,g,R,L,A[v+13],4,681279174),L=o(L,k,g,R,A[v],11,-358537222),R=o(R,L,k,g,A[v+3],16,-722521979),g=o(g,R,L,k,A[v+6],23,76029189),k=o(k,g,R,L,A[v+9],4,-640364487),L=o(L,k,g,R,A[v+12],11,-421815835),R=o(R,L,k,g,A[v+15],16,530742520),g=o(g,R,L,k,A[v+2],23,-995338651),k=a(k,g,R,L,A[v],6,-198630844),L=a(L,k,g,R,A[v+7],10,1126891415),R=a(R,L,k,g,A[v+14],15,-1416354905),g=a(g,R,L,k,A[v+5],21,-57434055),k=a(k,g,R,L,A[v+12],6,1700485571),L=a(L,k,g,R,A[v+3],10,-1894986606),R=a(R,L,k,g,A[v+10],15,-1051523),g=a(g,R,L,k,A[v+1],21,-2054922799),k=a(k,g,R,L,A[v+8],6,1873313359),L=a(L,k,g,R,A[v+15],10,-30611744),R=a(R,L,k,g,A[v+6],15,-1560198380),g=a(g,R,L,k,A[v+13],21,1309151649),k=a(k,g,R,L,A[v+4],6,-145523070),L=a(L,k,g,R,A[v+11],10,-1120210379),R=a(R,L,k,g,A[v+2],15,718787259),g=a(g,R,L,k,A[v+9],21,-343485551),k=t(k,J),g=t(g,Z),R=t(R,Te),L=t(L,W);return[k,g,R,L]}function d(A){var U,v="",J=A.length*32;for(U=0;U<J;U+=8)v+=String.fromCharCode(A[U>>5]>>>U%32&255);return v}function u(A){var U,v=[];for(v[(A.length>>2)-1]=void 0,U=0;U<v.length;U+=1)v[U]=0;var J=A.length*8;for(U=0;U<J;U+=8)v[U>>5]|=(A.charCodeAt(U/8)&255)<<U%32;return v}function l(A){return d(c(u(A),A.length*8))}function m(A,U){var v,J=u(A),Z=[],Te=[],W;for(Z[15]=Te[15]=void 0,J.length>16&&(J=c(J,A.length*8)),v=0;v<16;v+=1)Z[v]=J[v]^909522486,Te[v]=J[v]^1549556828;return W=c(Z.concat(u(U)),512+U.length*8),d(c(Te.concat(W),512+128))}function I(A){var U="0123456789abcdef",v="",J,Z;for(Z=0;Z<A.length;Z+=1)J=A.charCodeAt(Z),v+=U.charAt(J>>>4&15)+U.charAt(J&15);return v}function E(A){return unescape(encodeURIComponent(A))}function N(A){return l(E(A))}function B(A){return I(N(A))}function x(A,U){return m(E(A),E(U))}function F(A,U){return I(x(A,U))}function Ee(A,U,v){return U?v?x(U,A):F(U,A):v?N(A):B(A)}typeof define=="function"&&define.amd?define(function(){return Ee}):typeof Ds=="object"&&Ds.exports?Ds.exports=Ee:i.md5=Ee})(gl)});var mL=h(_());var Jy=h(_());var TE=h(_(),1);var z_=h(_(),1),Oi="4.15.00.1600",Be="5.0.0";function Zc(i){Be=i;let[t,e,r]=i.split(".").map(n=>parseInt(n,10));Oi=`${t}.${Math.min(15,e)}.${Math.min(15,r)}.${e.toString().padStart(2,"0")}${r.toString().padStart(2,"0")}`}var En=typeof importScripts!="undefined",Tn=typeof registerProcessor!="undefined";var Sn="",ed=i=>Sn=i,Zs="web.sdk.qcloud.com",td="web.sdk.tencent.cn",id="web.sdk.cloud.tencent.cn",In="https://console.cloud.tencent.com/trtc",bi=`https://${Zs}/trtc/webrtc/v5/doc`,Pi=`${bi}/zh-cn/`,rd="https://yun.tim.qq.com",nd="https://videoapi-sgp.im.qcloud.com",sd="trtc_error_assistance",Mi={LOG:"jssdk_log",EVENT:"jssdk_event",KEY_POINT:"jssdk_new_endreport"},Kt={QCLOUD:"qcloud",OLD_CLOUD_LADDER:"trtc",WEBRTC:"webrtc"},ct=(o=>(o[o.TRACE=0]="TRACE",o[o.DEBUG=1]="DEBUG",o[o.INFO=2]="INFO",o[o.WARN=3]="WARN",o[o.ERROR=4]="ERROR",o[o.NONE=5]="NONE",o))(ct||{});var si={unknown:0,wifi:1,"3g":2,"2g":3,"4g":4,wired:5},eo=7*24*3600*1e3;var to={standard:{sampleRate:48e3,channelCount:1,bitrate:40},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},high:{sampleRate:48e3,channelCount:1,bitrate:192},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}},Li={"120p":{width:160,height:120,frameRate:15,bitrate:200},"180p":{width:320,height:180,frameRate:15,bitrate:350},"240p":{width:320,height:240,frameRate:15,bitrate:400},"360p":{width:640,height:360,frameRate:15,bitrate:800},"480p":{width:640,height:480,frameRate:15,bitrate:900},"720p":{width:1280,height:720,frameRate:15,bitrate:1500},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"1440p":{width:2560,height:1440,frameRate:30,bitrate:4860},"4K":{width:3840,height:2160,frameRate:30,bitrate:9e3}},io={"480p":{width:640,height:480,frameRate:5,bitrate:900},"480p_2":{width:640,height:480,frameRate:30,bitrate:1e3},"720p":{width:1280,height:720,frameRate:5,bitrate:1200},"720p_2":{width:1280,height:720,frameRate:30,bitrate:3e3},"1080p":{width:1920,height:1080,frameRate:5,bitrate:1600},"1080p_2":{width:1920,height:1080,frameRate:30,bitrate:4e3}},f={CANVAS:"canvas",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",SMALL:"small",BIG:"big",AUXILIARY:"auxiliary",SMALL_VIDEO:"smallVideo",FACING_MODE_USER:"user",FACING_MODE_ENVIRONMENT:"environment",MUTE:"mute",UNMUTE:"unmute",ENDED:"ended",PLAYING:"playing",PAUSE:"pause",ERROR:"error",LOADEDDATA:"loadeddata",AUDIO_INPUT:"audioinput",VIDEO_INPUT:"videoinput",DETAIL:"detail",TEXT:"text",MAIN:"main",BACKUP:"backup",BANNED:"banned",KICK:"kick",USER_TIME_OUT:"user_time_out",ROOM_DISBAND:"room_disband",SEI_MESSAGE:"sei-message",ADD:"add",REMOVE:"remove",REPLACE:"replace",TRACK:"track",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe"},he={INACTIVE:"inactive",SENDONLY:"sendonly",RECVONLY:"recvonly"},ro={OLD_CLOUD_LADDER:"wss://trtc.rtc.qq.com",WEBRTC:"wss://webrtc.qq.com"};var cr=1,od=2,gn=4,dr=8,no=64,so=16,Rn="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",ad="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",cd=f.MAIN,An=f.AUXILIARY;var ur="unknown",Oe={NEW:"new",CONNECTING:"connecting",FAILED:"failed",CLOSED:"closed",DISCONNECTED:"disconnected",CONNECTED:"connected",COMPLETED:"completed"},dd=1/0;function ud(i){dd=i}function lr(){return dd}var Cn=30,oi={JOIN:"join",DELTA_JOIN:"delta-join",REJOIN:"rejoin",LEAVE:"leave",DELTA_LEAVE:"delta-leave",PUBLISH:"publish",DELTA_PUBLISH:"delta-publish",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",UPLINK_CONNECTION:"uplink-connection",UPLINK_RECONNECTION:"uplink-reconnection",DOWNLINK_CONNECTION:"downlink-connection",DOWNLINK_RECONNECTION:"downlink-reconnection",ON_TRACK:"ontrack",ICE_CONNECTION_STATE:"iceConnectionState",LOCAL_STREAM_INITIALIZE:"stream-initialize",SIGNAL_CONNECTION:"websocketConnectionState",SIGNAL_RECONNECTION:"websocketReconnectionState",UPDATE_STREAM:"update-stream",RECOVER_LOCAL_AUDIO_TRACK:"recover-local-audio-track",RECOVER_LOCAL_VIDEO_TRACK:"recover-local-video-track",RECOVER_SUBSCRIPTION:"recover-subscription",START_MIX_TRANSCODE:"start-mix-transcode",STOP_MIX_TRANSCODE:"stop-mix-transcode",PLAYER_ERROR:"player-error",SCHEDULE:"schedule",LOAD_WORKLET:"load-worklet",VIDEO_FROZEN_COUNT:"videoFrozenCount"};var ld=1e4,pd=1e4,ai="unified-plan",pr="plan-b",ci={MODE:{MANUAL:"manual",PRESET_LAYOUT:"preset-layout"},PLACE_HOLDER:{REMOTE:"$PLACE_HOLDER_REMOTE$"},STREAM_TYPE:{IT_AUDIO_VIDEO:0,IT_PICTURE:2,IT_CANVAS:3,IT_PURE_AUDIO:4,IT_PURE_VIDEO:5}},O={String:"string",Number:"number",Boolean:"boolean",Array:"array",Object:"object"},vn=1028;var oo=500;var J_=f.BIG,X_=f.SMALL,md=10*1e3,mr={MAIN:"schedule.rtc.qq.com",BACKUP:"schedule.rtc.qcloud.com",MAIN_OVERSEA:"schedule.rtc.tencentcloud.com",BACKUP_OVERSEA:"schedule-ecdn.rtc.tencentcloud.com"};var hd=5,ki="default",yn=ki;var Y_=Object.keys(ct),_d=["normal leave","timeout leave","kick","role change"],hr=10,_r=2e3,yt="ric",jt="raf",fd="interval",fr="timeout";var mE=h(_(),1);var ef=h(_(),1);var Ed=new Date().getTime(),ao=0,Td=function(i){Ed=i,ao=Ed-new Date().getTime();let t=new Date;t.setTime(i),M.info(`baseTime from server: ${t} offset: ${ao}`)},Er=function(){return new Date().getTime()+ao},Nn=function(){let i=new Date;return i.setTime(Er()),i.toLocaleString()};var Ge={};ws(Ge,{bytes2ms:()=>xm,catchEmitterError:()=>bo,copyProperties:()=>km,deepMerge:()=>ht,fibonacci:()=>Ui,formatedTime:()=>Wm,getAudioContext:()=>Mt,getConstructorName:()=>Wn,getContainerFromElement:()=>Kn,getEnv:()=>Mm,getGainAudioContext:()=>wm,getInternalVersion:()=>Bm,getLoggerUrl:()=>li,getMuteStateFromFlag:()=>Vi,getNetworkQuality:()=>Hm,getNetworkType:()=>Fn,getOSType:()=>Pd,getReconnectionTimeout:()=>mt,getSysInfo:()=>Lm,getTerminalType:()=>bd,getTurnServer:()=>Fm,getValueType:()=>_e,glog:()=>kd,ipv4ToUint32:()=>kr,isArray:()=>ke,isArrayOrObject:()=>Pr,isAudioWorkletSupported:()=>Do,isBoolean:()=>Pt,isConstructor:()=>Mr,isEmpty:()=>Lr,isFunction:()=>oe,isLangChinese:()=>pt,isMediaStreamTrack:()=>Vm,isNumber:()=>de,isObject:()=>pi,isOverseaSdkAppId:()=>Hn,isPlainObject:()=>Yt,isPromise:()=>Gn,isRemoteTrack:()=>qt,isString:()=>re,isUndefined:()=>y,ms2bytes:()=>Um,ms2samples:()=>Ld,performanceNow:()=>ee,promiseAny:()=>Oo,samples2ms:()=>Md,tryCatchFunction:()=>No});var xf=h(_(),1);var mf=h(_(),1);var dt=typeof navigator!="undefined"?navigator==null?void 0:navigator.userAgent:"",Q=i=>new RegExp(i,"i").test(dt),Ie=i=>{if(Q(i)){let t=new RegExp(`${i}\\/([\\d.]+)`),e=dt.match(t);if(e&&e[1])return e[1]}return""},co=i=>{if(Q(i)){let t=new RegExp(`${i}\\/(\\d+)`),e=dt.match(t);if(e&&e[1])return parseFloat(e[1])}return NaN},Sd=/AppleWebKit\/([\d.]+)/i.exec(dt),Am=Sd?parseFloat(Sd[1]):NaN,Sr=Q("iPad"),Id=typeof navigator!="undefined"&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&Q("Macintosh"),di=Q("iPhone")&&!Sr,Cm=Q("iPod"),ut=di||Sr||Cm||Id,et=Q("Android"),gd=function(){if(et){let i=dt.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(i){let t=i[1]&&parseFloat(i[1]),e=i[2]&&parseFloat(i[2]);if(t&&e)return parseFloat(`${i[1]}.${i[2]}`);if(t)return t}}return NaN}(),nf=et&&Q("webkit")&&gd<2.3,sf=et&&gd<5&&Am<537,$e=Q("Firefox"),uo=Ie("Firefox"),Rd=co("Firefox"),Ir=Q("Edge"),lo=Ie("Edge"),gr=Q("Edg"),po=Ie("Edg"),Ad=co("Edg"),Dn=Q("SogouMobileBrowser"),mo=Ie("SogouMobileBrowser"),On=Q("MetaSr\\s"),ho=Ie("MetaSr\\s"),Nt=Q("TBS"),_o=Ie("TBS"),bn=Q("XWEB"),fo=Ie("XWEB"),of=Q("MSIE\\s8\\.0"),vm=Q("MSIE\\/\\d+"),af=function(){if(vm){let i=/MSIE\s(\d+)\.\d/.exec(dt),t=i&&parseFloat(i[1]);return!t&&/Trident\/7.0/i.test(dt)&&/rv:11.0/.test(dt)&&(t=11),t}return NaN}(),Rr=Q("(micromessenger|webbrowser)"),Eo=Ie("MicroMessenger"),Ar=!Nt&&Q("MQQBrowser")&&Q("COVC"),Cr=!Nt&&Q("MQQBrowser")&&!Q("COVC"),Tr=Cr||Ar?Ie("MQQBrowser"):"",Pn=!Nt&&Q(" QQBrowser"),To=Ie(" QQBrowser"),Mn=!Nt&&Q("QQBrowserLite"),So=Ie("QQBrowserLite"),Ln=!Nt&&Q("MQBHD"),Io=Ie("MQBHD"),vr=Q("Windows"),Dt=!ut&&Q("MAC OS X"),yr=!et&&Q("Linux"),cf=Q("MicroMessenger"),Cd=Q("UCBrowser"),df=Q("Electron"),kn=Q("MiuiBrowser"),go=Ie("MiuiBrowser"),xn=Q("HuaweiBrowser"),uf=Q("Huawei"),Ro=Ie("HuaweiBrowser"),Un=Q("SamsungBrowser"),Ao=Ie("SamsungBrowser"),Vn=Q("HeyTapBrowser"),Co=Ie("HeyTapBrowser"),wn=Q("VivoBrowser"),vo=Ie("VivoBrowser"),Nr=()=>co("Chrome"),vd=Q("Chrome"),Dr=!Ir&&!On&&!Dn&&!Nt&&!bn&&!gr&&!Pn&&!kn&&!xn&&!Un&&!Vn&&!wn&&vd,Or=Nr(),yo=Ie("Chrome"),lt=!vd&&!Cr&&!Ar&&!Mn&&!Ln&&Q("Safari");var br=Ie("Safari"),lf=/Android.*(wv|.0.0.0)/.test(dt),xi=(()=>{if(Id)return br;if(ut){let i=dt.match(/OS (\d+)_(\d+)/i);if(i&&i[1]){let t=i[1];return i[2]&&(t+=`.${i[2]}`),t}}return""})(),yd=br==="15.1",Bn=xi==="15.1",pf=(()=>{let i=Number(xi.split(".")[0]);return i===14||i===13})(),Jt=typeof location!="undefined"?location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1":!1,Xt=(()=>{let i;return()=>{if(y(i))try{i=!!window.localStorage}catch(t){M.warn(t),i=!1}return i}})(),Ot=ym();function ym(){let i=new Map([[$e,["Firefox",uo]],[gr,["Edg",po]],[Dr,["Chrome",yo]],[lt,["Safari",br]],[Nt,["TBS",_o]],[bn,["XWEB",fo]],[Rr&&di,["WeChat",Eo]],[Pn,["QQ(Win)",To]],[Cr,["QQ(Mobile)",Tr]],[Ar,["QQ(Mobile X5)",Tr]],[Mn,["QQ(Mac)",So]],[Ln,["QQ(iPad)",Io]],[kn,["MI",go]],[xn,["HW",Ro]],[Un,["Samsung",Ao]],[Vn,["OPPO",Co]],[wn,["VIVO",vo]],[Ir,["EDGE",lo]],[Dn,["SogouMobile",mo]],[On,["Sogou",ho]]]),t="unknown",e="unknown";return i.has(!0)&&([t,e]=i.get(!0)),{name:t,version:e}}var Df=h(_(),1);var Sf=h(_(),1);var _f=h(_(),1);var ui=1e8;var $={AVOID_REPEATED_CALL:"AVOID_REPEATED_CALL",INVALID_PARAMETER_REQUIRED:"INVALID_PARAMETER_REQUIRED",INVALID_PARAMETER_TYPE:"INVALID_PARAMETER_TYPE",INVALID_PARAMETER_EMPTY:"INVALID_PARAMETER_EMPTY",INVALID_PARAMETER_INSTANCE:"INVALID_PARAMETER_INSTANCE",INVALID_PARAMETER_RANGE:"INVALID_PARAMETER_RANGE",INVALID_PARAMETER_MIN:"INVALID_PARAMETER_MIN",INVALID_PARAMETER_MAX:"INVALID_PARAMETER_MAX",INVALID_PARAMETER_STREAMTYPE:"INVALID_PARAMETER_STREAMTYPE",API_CALL_TIMEOUT:"API_CALL_TIMEOUT",SIGNAL_CHANNEL_RECONNECTION_FAILED:"SIGNAL_CHANNEL_RECONNECTION_FAILED",SIGNAL_CHANNEL_SETUP_FAILED:"SIGNAL_CHANNEL_SETUP_FAILED",ERROR_MESSAGE:"ERROR_MESSAGE",EXCHANGE_SDP_TIMEOUT:"EXCHANGE_SDP_TIMEOUT",DOWNLINK_RECONNECTION_FAILED:"DOWNLINK_RECONNECTION_FAILED",EXCHANGE_SDP_FAILED:"EXCHANGE_SDP_FAILED",UPDATE_OFFER_TIMEOUT:"UPDATE_OFFER_TIMEOUT",UPLINK_RECONNECTION_FAILED:"UPLINK_RECONNECTION_FAILED",INVALID_RECORDID:"INVALID_RECORDID",INVALID_PURE_AUDIO:"INVALID_PURE_AUDIO",INVALID_STREAMID:"INVALID_STREAMID",INVALID_USER_DEFINE_RECORDID:"INVALID_USER_DEFINE_RECORDID",INVALID_USER_DEFINE_PUSH_ARGS:"INVALID_USER_DEFINE_PUSH_ARGS",INVALID_PROXY:"INVALID_PROXY",INVALID_JOIN:"INVALID_JOIN",INVALID_ROOMID_STRING:"INVALID_ROOMID_STRING",INVALID_ROOMID_INTEGER:"INVALID_ROOMID_INTEGER",INVALID_SIGNAL_CHANNEL:"INVALID_SIGNAL_CHANNEL",JOIN_ROOM_TIMEOUT:"JOIN_ROOM_TIMEOUT",JOIN_ROOM_FAILED:"JOIN_ROOM_FAILED",REJOIN_ROOM_FAILED:"REJOIN_ROOM_FAILED",INVALID_DESTROY:"INVALID_DESTROY",INVALID_PUBLISH:"INVALID_PUBLISH",INVALID_UNPUBLISH:"INVALID_UNPUBLISH",INVALID_AUDIENCE:"INVALID_AUDIENCE",INVALID_INITIALIZE:"INVALID_INITIALIZE",INVALID_DUPLICATE_PUBLISHING:"INVALID_DUPLICATE_PUBLISHING",INVALID_SUBSCRIBE_UNDEFINED:"INVALID_SUBSCRIBE_UNDEFINED",INVALID_SUBSCRIBE_LOCAL:"INVALID_SUBSCRIBE_LOCAL",INVALID_REMOTE_STREAM:"INVALID_REMOTE_STREAM",SUBSCRIBE_FAILED:"SUBSCRIBE_FAILED",INVALID_ROLE:"INVALID_ROLE",INVALID_PARAMETER_SWITCH_ROLE:"INVALID_PARAMETER_SWITCH_ROLE",INVALID_OPERATION_SWITCH_ROLE:"INVALID_OPERATION_SWITCH_ROLE",SWITCH_ROLE_TIMEOUT:"SWITCH_ROLE_TIMEOUT",SWITCH_ROLE_FAILED:"SWITCH_ROLE_FAILED",CLIENT_BANNED:"CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"INVALID_OPERATION_START_PUBLISH_CDN",INVALID_OPERATION_STOP_PUBLISH_CDN:"INVALID_OPERATION_STOP_PUBLISH_CDN",INVALID_STREAM_ID:"INVALID_STREAM_ID",START_PUBLISH_CDN_FAILED:"START_PUBLISH_CDN_FAILED",STOP_PUBLISH_CDN_FAILED:"STOP_PUBLISH_CDN_FAILED",START_MIX_TRANSCODE:"START_MIX_TRANSCODE",STOP_MIX_TRANSCODE:"STOP_MIX_TRANSCODE",INVALID_AUDIO_VOLUME:"INVALID_AUDIO_VOLUME",ENABLE_SMALL_STREAM_PUBLISHED:"ENABLE_SMALL_STREAM_PUBLISHED",DISABLE_SMALL_STREAM_PUBLISHED:"DISABLE_SMALL_STREAM_PUBLISHED",NOT_SUPPORTED_SMALL_STREAM:"NOT_SUPPORTED_SMALL_STREAM",INVALID_SMALL_STREAM_PROFILE:"INVALID_SMALL_STREAM_PROFILE",INVALID_PARAMETER_REMOTE_STREAM:"INVALID_PARAMETER_REMOTE_STREAM",INVALID_OPERATION_CHANGE_SMALL:"INVALID_OPERATION_CHANGE_SMALL",REMOTE_NOT_PUBLISH_SMALL_STREAM:"REMOTE_NOT_PUBLISH_SMALL_STREAM",INVALID_SWITCH_DEVICE:"INVALID_SWITCH_DEVICE",INVALID_SWITCH_DEVICE_PUBLISHING:"INVALID_SWITCH_DEVICE_PUBLISHING",INVALID_REPLACE_TRACK:"INVALID_REPLACE_TRACK",INVALID_INITIALIZE_LOCAL_STREAM:"INVALID_INITIALIZE_LOCAL_STREAM",INVALID_ADD_TRACK_REPETITIVE:"INVALID_ADD_TRACK_REPETITIVE",INVALID_ADD_TRACK_REMOVING:"INVALID_ADD_TRACK_REMOVING",INVALID_ADD_TRACK_PUBLISHING:"INVALID_ADD_TRACK_PUBLISHING",INVALID_STREAM_INITIALIZED:"INVALID_STREAM_INITIALIZED",INVALID_ADD_TRACK_NUMBER:"INVALID_ADD_TRACK_NUMBER",INVALID_REMOVE_AUDIO_TRACK:"INVALID_REMOVE_AUDIO_TRACK",INVALID_REMOVE_AUDIO_ADDING:"INVALID_REMOVE_AUDIO_ADDING",INVALID_REMOVE_AUDIO_ON:"INVALID_REMOVE_AUDIO_ON",INVALID_REMOVE_TRACK_PUBLISHING:"INVALID_REMOVE_TRACK_PUBLISHING",INVALID_REMOVE_TRACK_NOT_TRACK:"INVALID_REMOVE_TRACK_NOT_TRACK",INVALID_REMOVE_TRACK_NUMBER:"INVALID_REMOVE_TRACK_NUMBER",INVALID_REPLACE_TRACK_NO_TRACK:"INVALID_REPLACE_TRACK_NO_TRACK",REPEAT_JOIN:"REPEAT_JOIN",CLIENT_DESTROYED:"CLIENT_DESTROYED",START_MIX_TRANSCODE_FAILED:"START_MIX_TRANSCODE_FAILED",STOP_MIX_TRANSCODE_FAILED:"STOP_MIX_TRANSCODE_FAILED",MIX_TRANSCODE_NOT_STARTED:"MIX_TRANSCODE_NOT_STARTED",CANNOT_LESS_THAN_ZERO:"CANNOT_LESS_THAN_ZERO",MIX_PARAMS_VIDEO_FRAMERATE:"MIX_PARAMS_VIDEO_FRAMERATE",MIX_PARAMS_VIDEO_GOP:"MIX_PARAMS_VIDEO_GOP",MIX_PARAMS_AUDIO_BITRATE:"MIX_PARAMS_AUDIO_BITRATE",MIX_PARAMS_USER_Z_ORDER:"MIX_PARAMS_USER_Z_ORDER",MIX_PARAMS_NOT_SELF:"MIX_PARAMS_NOT_SELF",MIX_PARAMS_USER_STREAM:"MIX_PARAMS_USER_STREAM",INVALID_PLAY:"INVALID_PLAY",INVALID_ELEMENT_ID:"INVALID_ELEMENT_ID",INVALID_ELEMENT_ID_TYPE:"INVALID_ELEMENT_ID_TYPE",PLAY_FAILED:"PLAY_FAILED",INVALID_USERID:"INVALID_USERID",INVALID_CREATE_STREAM_SOURCE:"INVALID_CREATE_STREAM_SOURCE",INVALID_CREATE_STREAM_SCREEN:"INVALID_CREATE_STREAM_SCREEN",INVALID_CREATE_STREAM_AUDIO:"INVALID_CREATE_STREAM_AUDIO",INVALID_CREATE_STREAM_SCREEN_AUDIO:"INVALID_CREATE_STREAM_SCREEN_AUDIO",NOT_SUPPORTED_HTTP:"NOT_SUPPORTED_HTTP",NOT_SUPPORTED_WEBRTC:"NOT_SUPPORTED_WEBRTC",NOT_SUPPORTED_PROFILE:"NOT_SUPPORTED_PROFILE",NOT_SUPPORTED_MEDIA:"NOT_SUPPORTED_MEDIA",NOT_SUPPORTED_H264ENCODE:"NOT_SUPPORTED_H264ENCODE",NOT_SUPPORTED_H264DECODE:"NOT_SUPPORTED_H264DECODE",NOT_SUPPORTED_TRACK:"NOT_SUPPORTED_TRACK",NOT_SUPPORTED_SWITCH_DEVICE:"NOT_SUPPORTED_SWITCH_DEVICE",NOT_SUPPORTED_CAPTURE:"NOT_SUPPORTED_CAPTURE",NOT_SUPPORTED_AUX:"NOT_SUPPORTED_AUX",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",SIGNAL_RESPONSE_FAILED:"SIGNAL_RESPONSE_FAILED",CATCH_HANDLER_ERROR:"CATCH_HANDLER_ERROR",API_NOT_EXIST:"API_NOT_EXIST",CONNECTION_CLOSED:"CONNECTION_CLOSED",SUBSCRIBE_ALL_FALSE:"SUBSCRIBE_ALL_FALSE",SEI_NOT_SUPPORT:"SEI_NOT_SUPPORT",SEI_DISABLED:"SEI_DISABLED",SEI_EMPTY:"SEI_EMPTY",SEI_OVERSIZE:"SEI_OVERSIZE",SEI_BEFORE_PUBLISH:"SEI_BEFORE_PUBLISH",SEI_NOT_VIDEO:"SEI_NOT_VIDEO",CALL_FREQUENCY_LIMIT:"CALL_FREQUENCY_LIMIT",CONNECTION_ABORTED:"CONNECTION_ABORTED",API_CALL_ABORTED:"API_CALL_ABORTED",DUPLICATE_AUX:"DUPLICATE_AUX"},He={AVOID_REPEATED_CALL(i){return`previous ${i.name}() is ongoing, please avoid repeated calls.`},INVALID_PARAMETER_REQUIRED({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' is a required param when calling ${e}(), received: ${r}.`},INVALID_PARAMETER_TYPE({key:i,rule:t,fnName:e,value:r}){let n=`${i||t.name}`,s="";return Array.isArray(t.type)?s=t.type.join("|"):s=t.type,`'${n}' must be type of ${s} when calling ${e}(), received type: ${_e(r)}.`},INVALID_PARAMETER_EMPTY({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' cannot be '${r}' when calling ${e}().`},INVALID_PARAMETER_INSTANCE({key:i,rule:t,fnName:e,value:r}){let n=`${i||t.name}`,s=`${t.instanceOf.name||t.instanceOf}`;return`'${n}' must be instanceof ${s} when calling ${e}(), received type: ${_e(r)}.`},INVALID_PARAMETER_RANGE({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' must be one of ${t.values.join("|")} when calling ${e}(), received: ${r}.`},INVALID_PARAMETER_MIN({key:i,rule:t,fnName:e,value:r}){return`the min value of ${i||t.name} is ${t.min}, received: ${r}.`},INVALID_PARAMETER_MAX({key:i,rule:t,fnName:e,value:r}){return`the max value of ${i||t.name} is ${t.max}, received: ${r}.`},API_CALL_TIMEOUT(i){return`${i.commandDesc||i.command} timeout observed.`},SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED(i){return`SignalChannel setup failure: (errorCode: ${i.errorCode}, errorMsg: ${i.errorMsg} }).`},ERROR_MESSAGE(i){let t=`${i.type} failed`;return i.message&&(t=`${t}: ${i.message}.`),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED(i){return`exchange sdp failed ${i.errMsg}.`},UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING(i){return`'${i}' must be validate string when useStringRoomId is true.`},INVALID_ROOMID_INTEGER(i){return`'${i}' must be an integer between [1, 4294967294] when useStringRoomId is false.`},INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED({error:i,code:t}){return`Failed to join room - ${i} code: ${t}`},REJOIN_ROOM_FAILED(i){return`reJoin room: ${i.roomId} failed, please check your network.`},INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:`no permission to publish() under live/${"audience"}, please call switchRole("${"anchor"}") firstly before publish().`,INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING(i){return`duplicate ${i} stream publishing, please unpublish your prev ${i} stream and then re-publish.`},INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED({message:i,userId:t,streamType:e}){return`failed to subscribe ${t} ${e} stream, reason: ${i}.`},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:`role could only be set to a value as ${"anchor"} or ${"audience"}.`,INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED(i){return`switchRole failed, errCode: ${i.code} errMsg: ${i.message}.`},CLIENT_BANNED(i){return`client was banned because of ${i.message}.`},INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() after join room and publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED(i){return`startPublishCDNStream failed, errMsg: ${i.message}.`},STOP_PUBLISH_CDN_FAILED(i){return`stopPublishCDNStream failed, errMsg: ${i.message}.`},INVALID_STREAM_ID(i){return`'${i}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_TRACK:"localStream has not this track.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK(i){return`cannot replace ${i.kind} track because stream has not ${i.kind} track`},START_MIX_TRANSCODE_FAILED(i){return`startMixTranscode failed, errMsg: ${i.message}.`},STOP_MIX_TRANSCODE_FAILED(i){return`stopMixTranscode failed, errMsg: ${i.message}.`},MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' cannot be less than 0 when calling ${e}().`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER(i){return`'${i}' is required and must be between 1 and 15.`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:({key:i,fnName:t})=>`'${i}' is not found in the document object when calling ${t}().`,INVALID_ELEMENT_ID_TYPE:({key:i,fnName:t,type:e})=>`the element corresponding to '${i}' must be instanceof HTMLElement when calling ${t}(), received: ${e}.`,PLAY_FAILED:i=>`${i.media} play failed\uFF0Cbrowser exception: ${i.error.toString()}`,INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK(i){return`${i}Track is not supported on your browser.`},NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone and the configuration on TRTC.createStream.",CAMERA_NOT_FOUND:"no camera detected, please check your camera and the configuration on TRTC.createStream.",SIGNAL_RESPONSE_FAILED(i){return`${i.signalResponse} failed, response code is ${i.code} , errMsg: ${i.message}.`},CATCH_HANDLER_ERROR({name:i,event:t}){return`an error was caught on ${i}.on('${t}', handler), please check your code on 'handler'.`},API_NOT_EXIST({name:i}){return`experimental api ${i} does not exist.`},REPEAT_JOIN:i=>`[${i}] is calling client.join api or has already joined room, please avoid repeated join.`,CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED({funName:i}){return`failed to call ${i}() because client was destroyed.`},SEI_NOT_SUPPORT:i=>`not support to sendSEIMessage${i===!1?" without using h264 codec":""}`,SEI_DISABLED:"SEI is disabled, to enable SEI: TRTC.createClient({ enableSEI: true })",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:i=>`buffer size(${i}) is over 1000 Bytes`,SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:({isSize:i,name:t,timesInSecond:e,maxSizeInSecond:r})=>`api ${t} call ${i?"size":"times"} is over ${i?`${r} bytes`:e} in a second.`,CONNECTION_ABORTED(i){return`connection aborted due to: ${i}`},API_CALL_ABORTED(i){let t;return i.message.includes("REMOTE_STREAM_NOT_EXIST")?t=`Subscribe ${i.userId} ${i.streamType} stream aborted, reason: remote user ${i.userId} unpublished stream.`:t=`API aborted, reason: ${i.message}`,t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser.",INVALID_PARAMETER_STREAMTYPE:i=>`'streamType' is required when 'userId' is not '*', calling ${i}()`};var If=h(_());function Nd(i){return Reflect.apply(Object.prototype.toString,i,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var Nm={AVOID_REPEATED_CALL(i){return`\u524D\u4E00\u4E2A ${i.name}() \u8C03\u7528\u6B63\u5728\u8FDB\u884C\u4E2D, \u8BF7\u907F\u514D\u91CD\u590D\u8C03\u7528\u3002`},INVALID_PARAMETER_REQUIRED({key:i,rule:t,fnName:e,value:r}){return`\u8C03\u7528 ${e}() \u65B9\u6CD5\u7684\u65F6\u5019 '${i||t.name}' \u662F\u5FC5\u987B\u7684\u53C2\u6570, \u6536\u5230\u7684\u503C\u4E3A: ${r}\u3002`},INVALID_PARAMETER_TYPE({key:i,rule:t,fnName:e,value:r}){let n=`${i||t.name}`,s="";return Array.isArray(t.type)?s=t.type.join("|"):s=t.type,`\u8C03\u7528 ${e}() \u65B9\u6CD5\u7684\u65F6\u5019 '${n}' \u5FC5\u987B\u662F ${s} \u7C7B\u578B, \u6536\u5230\u7684\u7C7B\u578B\u662F: ${Nd(r)}\u3002`},INVALID_PARAMETER_EMPTY({key:i,rule:t,fnName:e,value:r}){return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${i||t.name}' \u4E0D\u80FD\u662F '${r}'\u3002`},INVALID_PARAMETER_INSTANCE({key:i,rule:t,fnName:e,value:r}){let n=`${i||t.name}`,s=`${t.instanceOf.name||t.instanceOf}`;return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${n}' \u539F\u578B\u5FC5\u987B\u662F ${s} , \u6536\u5230\u7684\u662F: ${Nd(r)}\u3002`},INVALID_PARAMETER_RANGE({key:i,rule:t,fnName:e,value:r}){return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${i||t.name}' \u5FC5\u987B\u662F ${t.values.join("|")} \u7684\u5176\u4E2D\u4E00\u79CD, \u6536\u5230\u7684\u662F: ${r}\u3002`},API_CALL_TIMEOUT(i){return`${i.commandDesc||i.command} \u8D85\u65F6\u3002`},SIGNAL_CHANNEL_RECONNECTION_FAILED:"\u4FE1\u4EE4\u901A\u9053\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u4F60\u7684\u7F51\u7EDC\u3002",SIGNAL_CHANNEL_SETUP_FAILED(i){return`\u4FE1\u4EE4\u901A\u9053\u5EFA\u7ACB\u5931\u8D25: (\u9519\u8BEF\u7801: ${i.errorCode}, \u9519\u8BEF\u4FE1\u606F: ${i.errorMsg} })\u3002`},ERROR_MESSAGE(i){let t=`${i.type} \u5931\u8D25\u3002`;return i.message&&(t=`${t}: ${i.message}\u3002`),t},SUBSCRIPTION_TIMEOUT:"\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0D\u54CD\u5E94\u8BA2\u9605\u884C\u4E3A\u3002",EXCHANGE_SDP_TIMEOUT:"\u4EA4\u6362 sdp \u8D85\u65F6\uFF0C\u8BF7\u5237\u65B0\u7F51\u7EDC\u91CD\u8BD5\u3002",DOWNLINK_RECONNECTION_FAILED:"\u4E0B\u884C\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u7F51\u7EDC\u5E76\u91CD\u65B0\u52A0\u5165\u623F\u95F4\u3002",EXCHANGE_SDP_FAILED(i){return`\u4EA4\u6362 SDP \u5931\u8D25\uFF0C\u539F\u56E0 ${i.errMsg}\u3002`},REPLACE_TRACK_INVALID:"LocalStream \u53D1\u5E03\u4E4B\u540E\u624D\u53EF\u4EE5\u8C03\u7528 replaceTrack\u3002",UPDATE_OFFER_TIMEOUT:"\u66F4\u65B0 offer \u8D85\u65F6\uFF0C\u8BF7\u5237\u65B0\u7F51\u7EDC\u91CD\u8BD5\u3002",UPLINK_RECONNECTION_FAILED:"\u4E0A\u884C\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u7F51\u7EDC\u5E76\u91CD\u65B0\u63A8\u6D41\u3002",INVALID_RECORDID:"recordId \u5FC5\u987B\u662F\u6570\u5B57\u3002",INVALID_PURE_AUDIO:"pureAudioPushMode \u5FC5\u987B\u662F\u6570\u5B571\u62162\u3002",INVALID_STREAMID:"streamId \u5FC5\u987B\u662F 64 \u5B57\u8282\u4EE5\u5185\u7684\u5B57\u7B26\u4E32\uFF0C\u5E76\u4E14\u4E0D\u80FD\u4E3A\u7A7A\u3002",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId \u5FC5\u987B\u662F\u5305\u542B (a-zA-Z)\u3001(0-9)\u3001\u4E0B\u5212\u7EBF\u548C\u8FDE\u5B57\u7B26\u7684\u5B57\u7B26\u4E32\u5B57\u9762\u91CF\uFF0C64 \u4E2A\u5B57\u8282\u4EE5\u5185\uFF0C\u4E14\u4E0D\u4E3A\u7A7A\u3002",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs \u5FC5\u987B\u662F 256 \u5B57\u8282\u4EE5\u5185\u7684\u5B57\u7B26\u4E32\u6587\u5B57\uFF0C\u5E76\u4E14\u4E0D\u80FD\u4E3A\u7A7A\u3002",INVALID_PROXY:"\u4EE3\u7406\u670D\u52A1\u5668 url \u5FC5\u987B\u4EE5\u201Cwss://\u201D\u5F00\u5934\u3002",INVALID_JOIN:"join() \u65B9\u6CD5\u4E0D\u80FD\u88AB\u91CD\u590D\u8C03\u7528\u3002",INVALID_ROOMID_STRING(i){return`\u5F53 useStringRoomId \u4E3A true \u65F6\uFF0C'${i}' \u5FC5\u987B\u662F\u5408\u6CD5\u5B57\u7B26\u4E32\u3002`},INVALID_ROOMID_INTEGER(i){return`\u5F53 useStringRoomId \u4E3A false \u65F6\uFF0C'${i}' \u5FC5\u987B\u662F\u5408\u6CD5\u6574\u6570\u5728\u533A\u95F4[1, 4294967294]\u3002`},INVALID_SIGNAL_CHANNEL:"SignalChannel \u8FD8\u672A\u521D\u59CB\u5316\u597D\u3002",JOIN_ROOM_TIMEOUT:"\u8FDB\u623F\u8D85\u65F6\u3002",JOIN_ROOM_FAILED(i){return`\u8FDB\u623F\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A${i.error}\u3002`},REJOIN_ROOM_FAILED(i){return`\u91CD\u8FDB\u623F: ${i.roomId} \u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u72B6\u51B5\u3002`},INVALID_LEAVE:"\u8BF7\u5728\u8C03\u7528 destroy() \u65B9\u6CD5\u4E4B\u524D\u8C03\u7528 leave()\u3002",INVALID_PUBLISH:"\u8BF7\u5728\u8C03\u7528 publish() \u65B9\u6CD5\u4E4B\u524D\u8C03\u7528 join()\u3002",INVALID_UNPUBLISH:"\u8FD8\u6CA1\u6709\u88AB publish\u3002",INVALID_AUDIENCE:"\u5728\u89C2\u4F17\u6A21\u5F0F\u4E0B\u4E0D\u5141\u8BB8\u8C03\u7528 publish()\uFF0C\u8BF7\u5148\u5207\u6362\u6210\u4E3B\u64AD\u6A21\u5F0F\u3002",INVALID_INITIALIZE:"\u65E0\u6CD5\u53D1\u5E03 stream\uFF0C\u539F\u56E0\uFF1AlocalStream \u672A\u521D\u59CB\u5316\u3001\u6B63\u5728\u5207\u6362\u8BBE\u5907\u3001\u5DF2\u7ECF\u8C03\u7528 localStream.close() \u5173\u95ED\u91C7\u96C6",INVALID_DUPLICATE_PUBLISHING:"\u91CD\u590D\u53D1\u5E03\uFF0C\u8BF7\u5148 unpublish \u4E4B\u540E\uFF0C\u518D\u91CD\u65B0 publish\u3002",INVALID_SUBSCRIBE_UNDEFINED:"stream \u53C2\u6570\u662F undefined \u6216\u8005 null\u3002",INVALID_SUBSCRIBE_LOCAL:"stream \u53C2\u6570\u4E0D\u80FD\u4E3A\u672C\u5730\u6D41\u3002",INVALID_REMOTE_STREAM:"remoteStream \u4E0D\u5B58\u5728\uFF0C\u5DF2\u88AB\u8FDC\u7AEF client \u53D6\u6D88\u53D1\u5E03\u3002",SUBSCRIBE_FAILED(i){let t="\u8BA2\u9605\u6D41\u5931\u8D25\uFF0C\u539F\u56E0: ";return i.message.includes("REMOTE_STREAM_NOT_EXIST")?t+="\u8FDC\u7AEF\u7528\u6237\u5DF2\u53D6\u6D88\u63A8\u6D41\uFF0C\u65E0\u6CD5\u8BA2\u9605\u8BE5\u8FDC\u7AEF\u6D41\u3002":t+=`${i.message}\u3002`,t},INVALID_ROLE:"\u53EA\u6709\u76F4\u64AD\u6A21\u5F0F\u624D\u53EF\u4EE5\u8FDB\u884C\u89D2\u8272\u5207\u6362\u3002",INVALID_PARAMETER_SWITCH_ROLE:"role \u53EA\u80FD\u8BBE\u7F6E\u4E3A anchor \u6216\u8005 audience\u3002",INVALID_OPERATION_SWITCH_ROLE:"\u8BF7\u5728\u4F7F\u7528 switchRole() \u65B9\u6CD5\u524D\u5148\u8FDB\u623F\u3002",SWITCH_ROLE_TIMEOUT:"\u5207\u6362\u89D2\u8272\u8D85\u65F6\u3002",SWITCH_ROLE_FAILED(i){return`\u5207\u6362\u89D2\u8272\u5931\u8D25\u3002\u9519\u8BEF\u7801: ${i.code} \u9519\u8BEF\u4FE1\u606F: ${i.message}\u3002`},CLIENT_BANNED(i){return`\u60A8\u88AB\u52A8\u9000\u623F\u4E86\uFF0C\u539F\u56E0\u4E3A\uFF1A${i.reason}\u3002`},INVALID_OPERATION_START_PUBLISH_CDN:"\u8BF7\u5728\u8FDB\u623F\u524D\u6216\u8005\u8FDB\u623F\u5E76\u6210\u529F\u53D1\u5E03\u672C\u5730\u6D41\u540E\u8C03\u7528 startPublishCDNStream() \u65B9\u6CD5\u3002",INVALID_OPERATION_STOP_PUBLISH_CDN:"\u5728\u8C03\u7528 stopPublishCDNStream() \u65B9\u6CD5\u524D\u9700\u8981\u5148 startPublishCDNStream()\u3002",INVALID_STREAM_ID(i){return`'${i}' \u53EA\u80FD\u7531\u5927\u5C0F\u5199\u5B57\u6BCD\uFF08a-zA-z\uFF09, \u6570\u5B57\uFF080-9\uFF09, \u8FDE\u5B57\u7B26\u548C\u4E0B\u5212\u7EBF\u7EC4\u6210`},START_PUBLISH_CDN_FAILED(i){return`startPublishCDNStream \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${i.message}\u3002`},STOP_PUBLISH_CDN_FAILED(i){return`stopPublishCDNStream \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${i.message}\u3002`},START_MIX_TRANSCODE:"\u8C03\u7528 startMixTranscode() \u65B9\u6CD5\u524D\u9700\u8981\u5148\u8C03\u7528 join()\u3002",STOP_MIX_TRANSCODE:"\u8C03\u7528 stopMixTranscode \u4E4B\u524D\u9700\u8981\u8C03\u7528 startMixTranscode\u3002",INVALID_AUDIO_VOLUME:"interval \u5FC5\u987B\u662F\u6570\u5B57\u3002",ENABLE_SMALL_STREAM_PUBLISHED:"\u53D1\u5E03 localStream \u4E4B\u540E\u4E0D\u5141\u8BB8\u5F00\u542F\u5C0F\u6D41\u3002",DISABLE_SMALL_STREAM_PUBLISHED:"\u53D1\u5E03 localStream \u4E4B\u540E\u4E0D\u5141\u8BB8\u5173\u95ED\u5C0F\u6D41\u3002",NOT_SUPPORTED_SMALL_STREAM:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u5F00\u542F\u5C0F\u6D41\u3002",INVALID_SMALL_STREAM_PROFILE:"\u5C0F\u6D41\u53C2\u6570\u4E0D\u5408\u6CD5\u3002",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream \u4E0D\u5408\u6CD5\u3002",REMOTE_NOT_PUBLISH_SMALL_STREAM:"\u8FDC\u7AEF\u7528\u6237\u6CA1\u6709\u53D1\u5E03\u5C0F\u6D41\u3002",INVALID_SWITCH_DEVICE:"\u5F53\u524D\u7684\u6D41\u4E0D\u53EF\u4EE5\u8C03\u7528 switchDevice\u3002",INVALID_SWITCH_DEVICE_PUBLISHING:"\u53D1\u5E03\u672C\u5730\u6D41\u65F6\u4E0D\u80FD\u5207\u6362\u8BBE\u5907\u3002",INVALID_REPLACE_TRACK:"client.publish \u63A5\u53E3\u5C1A\u672A\u8C03\u7528\u5B8C\u6210\uFF0C\u8BF7\u7B49\u5176\u8C03\u7528\u5B8C\u6210\u540E\u518D\u8C03\u7528 replaceTrack \u63A5\u53E3\u3002",INVALID_INITIALIZE_LOCAL_STREAM:"\u672C\u5730\u6D41\u8FD8\u6CA1\u6709\u521D\u59CB\u5316\u3002",INVALID_ADD_TRACK_REPETITIVE:"\u524D\u4E00\u4E2A addTrack \u6B63\u5728\u8FDB\u884C\uFF0C\u8BF7\u907F\u514D\u91CD\u590D\u8C03\u7528\u3002",INVALID_ADD_TRACK_REMOVING:"track \u5728\u79FB\u52A8\u7684\u65F6\u5019\u4E0D\u80FD\u6DFB\u52A0\u65B0\u7684 track\u3002",INVALID_ADD_TRACK_PUBLISHING:"\u5728\u53D1\u5E03\u672C\u5730\u6D41\u7684\u65F6\u5019\u4E0D\u80FD\u6DFB\u52A0\u65B0\u7684 track\u3002",INVALID_STREAM_INITIALIZED:"\u60A8\u7684\u672C\u5730\u6D41\u8FD8\u6CA1\u6709\u521D\u59CB\u5316\u3002",INVALID_ADD_TRACK_NUMBER:"\u4E00\u6761\u6D41\u6700\u591A\u6709\u4E00\u4E2A\u97F3\u9891\u8F68\u9053\u548C\u4E00\u4E2A\u89C6\u9891\u8F68\u9053\u3002",INVALID_REMOVE_AUDIO_TRACK:"remove audio track \u662F\u4E0D\u5141\u8BB8\u7684\u3002",INVALID_REMOVE_AUDIO_ADDING:"\u5F53\u4E00\u4E2A track \u88AB addTrack \u7684\u65F6\u5019\u4E0D\u80FD\u5BF9\u6D41\u8FDB\u884C removeTrack \u64CD\u4F5C\u3002",INVALID_REMOVE_AUDIO_ON:"\u524D\u4E00\u6B21\u8C03\u7528\u7684 removeTrack \u6B63\u5728\u8FDB\u884C\u4E2D\uFF0C\u8BF7\u907F\u514D\u91CD\u590D\u64CD\u4F5C\u3002",INVALID_REMOVE_TRACK_PUBLISHING:"\u53D1\u5E03\u6D41\u7684\u8FC7\u7A0B\u4E2D\u4E0D\u80FD\u8FDB\u884C removeTrack \u64CD\u4F5C\u3002",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"\u88AB remove \u7684 track \u6CA1\u6709\u88AB\u53D1\u5E03\u3002",INVALID_REMOVE_TRACK_NUMBER:"\u4E0D\u652F\u6301\u79FB\u9664\u552F\u4E00\u7684\u89C6\u9891\u8F68\u9053\uFF0C\u8BF7\u4F7F\u7528 replaceTrack \u6216\u8005 muteVideo \u65B9\u6CD5\u3002",INVALID_REPLACE_TRACK_NO_TRACK(i){return`LocalStream \u6CA1\u6709 ${i.kind} track\uFF0C\u65E0\u6CD5\u8FDB\u884C\u66FF\u6362\u3002`},START_MIX_TRANSCODE_FAILED(i){return`startMixTranscode \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${i.message}\u3002`},STOP_MIX_TRANSCODE_FAILED(i){return`stopMixTranscode \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F:  ${i.message}\u3002`},MIX_TRANSCODE_NOT_STARTED:"\u8FD8\u6CA1\u6709\u5F00\u59CB mixTranscode\u3002",CANNOT_LESS_THAN_ZERO({key:i,rule:t,fnName:e}){return`'\u5F53\u8C03\u7528 ${e}() \u51FD\u6570\u65F6\uFF0C\u8981\u6C42\u53C2\u6570 ${i||t.name}' \u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E0`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' \u5E94\u8BE5\u662F (0, 30] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' \u5E94\u8BE5\u662F [1, 8] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' \u5E94\u8BE5\u662F [32, 192] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_USER_Z_ORDER(i){return`'${i}' \u662F\u5FC5\u4F20\u7684\uFF0C\u4E14\u8981\u6C42\u4E3A [1 ,15] \u4E4B\u95F4\u7684\u6574\u6570\u3002`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' \u5FC5\u987B\u5305\u542B\u53D1\u8D77\u6DF7\u6D41\u7684\u7528\u6237\u4FE1\u606F\u3002",MIX_PARAMS_USER_STREAM:"\u8F93\u51FA\u6D41\u7684 'config.videoWidth' \u548C 'config.videoHeight' \u5E94\u8BE5\u5BB9\u7EB3\u6240\u6709\u6DF7\u5165\u6D41\u3002",INVALID_PLAY:"play() \u88AB\u91CD\u590D\u8C03\u7528\uFF0C\u8BF7\u5148 stop()\uFF0C\u7136\u540E\u518D\u91CD\u65B0\u8C03\u7528 play\u3002",INVALID_ELEMENT_ID:({key:i,fnName:t})=>`\u5728\u8C03\u7528 ${t}() \u65F6\uFF0Cdocument \u5BF9\u8C61\u4E2D\u627E\u4E0D\u5230 ${i} \u5BF9\u5E94\u7684\u5143\u7D20\uFF0C\u8BF7\u68C0\u67E5\u3002`,INVALID_ELEMENT_ID_TYPE:({key:i,type:t,fnName:e})=>`\u5728\u8C03\u7528 ${e}() \u65B9\u6CD5\u65F6\uFF0C${i} \u53C2\u6570\u5BF9\u5E94\u7684 HTML \u6807\u7B7E\u5143\u7D20\u5FC5\u987B\u662F HTMLElement \u5B9E\u4F8B\uFF0C\u60A8\u4F20\u5165\u7684\u662F\uFF1A${t}\u3002`,PLAY_FAILED:i=>`${i.media} \u64AD\u653E\u88AB\u4E2D\u65AD\uFF0C\u6D4F\u89C8\u5668\u5F02\u5E38\u539F\u56E0\uFF1A${i.error.toString()}`,INVALID_USERID:"userId \u4E0D\u80FD\u4E3A\u7A7A\u683C\u3002",INVALID_CREATE_STREAM_SOURCE:"createStream() \u751F\u6210 LocalStream \u53EF\u4EE5\u4F7F\u7528 audio & video \u6216 audioSource & videoSource \u521B\u5EFA\uFF0C\u4F46\u4E0D\u80FD\u6DF7\u5408\u4F7F\u7528\u3002",INVALID_CREATE_STREAM_SCREEN:"screen \u548C video \u4E0D\u80FD\u540C\u65F6\u4E3A true\u3002",INVALID_CREATE_STREAM_AUDIO:"audio \u548C screenAudio \u4E0D\u80FD\u540C\u65F6\u4E3A true\u3002",INVALID_CREATE_STREAM_SCREEN_AUDIO:"screen \u4E3A true \u65F6\uFF0C\u4E0D\u80FD\u8BBE\u7F6E screenAudio\u3002",NOT_SUPPORTED_HTTP:"\u7531\u4E8E\u6D4F\u89C8\u5668\u5B89\u5168\u7B56\u7565\u9650\u5236\uFF0C\u4E0D\u652F\u6301\u5728 http \u534F\u8BAE\u4E0B\u4F7F\u7528\u91C7\u96C6\u3001\u63A8\u6D41\u7B49\u80FD\u529B\uFF0C\u8BF7\u4F7F\u7528 https \u534F\u8BAE\u3002",NOT_SUPPORTED_WEBRTC:"\u5F53\u524D\u6D4F\u89C8\u5668\u6216\u73AF\u5883\u4E0D\u5B8C\u5168\u652F\u6301 WebRTC \u80FD\u529B\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_PROFILE:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 setVideoProfile \u65B9\u6CD5\u3002\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_MEDIA:"\u5F53\u524D\u6D4F\u89C8\u5668\u6216\u73AF\u5883\u4E0D\u652F\u6301 navigator.mediaDevices\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_H264ENCODE:"\u5F53\u524D\u7684\u8BBE\u5907\u6216\u73AF\u5883\u4E0D\u652F\u6301 H264 \u7F16\u7801\uFF0C\u4E0D\u652F\u6301 H264 \u683C\u5F0F\u8FDB\u884C\u63A8\u6D41\u3002",NOT_SUPPORTED_H264DECODE:"\u5F53\u524D\u7684\u8BBE\u5907\u6216\u73AF\u5883\u4E0D\u652F\u6301 H264 \u89E3\u7801\uFF0C\u4E0D\u652F\u6301 H264 \u683C\u5F0F\u8FDB\u884C\u62C9\u6D41\u3002",NOT_SUPPORTED_TRACK(i){return`\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 ${i}Track \u65B9\u6CD5\u3002`},NOT_SUPPORTED_REPLACE_TRACK:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 replaceTrack \u65B9\u6CD5\uFF0C\u8BF7\u4F7F\u7528 switchDevice \u6216\u8005 addTrack\u3002",NOT_SUPPORTED_CAPTURE:"\u60A8\u5F53\u524D\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u5C4F\u5E55\u5206\u4EAB\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_AUX:"\u60A8\u5F53\u524D\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u63A8\u8F85\u6D41\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\uFF08Chrome 69+, Safari 11+, Firefox 59+\uFF09\u3002",MICROPHONE_NOT_FOUND:"\u672A\u68C0\u6D4B\u5230\u9EA6\u514B\u98CE\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u9EA6\u514B\u98CE\u548C TRTC.createStream \u4E0A\u7684\u914D\u7F6E\u3002",CAMERA_NOT_FOUND:"\u672A\u68C0\u6D4B\u5230\u6444\u50CF\u5934\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u6444\u50CF\u5934\u548C TRTC.createStream \u4E0A\u7684\u914D\u7F6E\u3002",CATCH_HANDLER_ERROR:({name:i,event:t})=>` \u5728 ${i}.on('${t}', handler) \u4E8B\u4EF6\u4E2D\u6355\u83B7\u5230\u4E1A\u52A1\u4FA7\u9519\u8BEF\uFF0C\u8BF7\u6839\u636E\u4E0B\u8FF0\u9519\u8BEF\u4FE1\u606F\uFF0C\u68C0\u67E5\u60A8\u5728 handler \u4E2D\u7684\u4E1A\u52A1\u4EE3\u7801\u3002`,REPEAT_JOIN:i=>`\u7528\u6237 [${i}] \u6B63\u5728\u8C03\u7528\u8FDB\u623F\u63A5\u53E3\u6216\u8005\u5DF2\u7ECF\u5728\u623F\u95F4\u5185\uFF0C\u8BF7\u52FF\u91CD\u590D\u521B\u5EFA\u76F8\u540C userId \u7684 client \u8FDB\u5165\u540C\u4E00\u4E2A\u623F\u95F4\u3002`,CLIENT_DESTROYED:({funName:i})=>`client \u5DF2\u7ECF\u88AB\u9500\u6BC1\uFF0C\u8C03\u7528 ${i}() \u65B9\u6CD5\u5931\u8D25\u3002`,API_CALL_ABORTED(i){let t;return i.message.includes("REMOTE_STREAM_NOT_EXIST")?t=`\u4E2D\u65AD\u8BA2\u9605\u7528\u6237 ${i.userId} \u7684 ${i.streamType} stream, \u539F\u56E0: \u5728\u60A8\u8BA2\u9605\u8FC7\u7A0B\u4E2D\uFF0C\u8FDC\u7AEF\u7528\u6237 ${i.userId} \u53D6\u6D88\u4E86\u63A8\u6D41\uFF0C\u60A8\u53EF\u4EE5\u5728\u4E0B\u6B21\u8FDC\u7AEF\u63A8\u6D41\u65F6\u518D\u8FDB\u884C\u8BA2\u9605\u3002`:t=`\u4E2D\u65AD\u63A5\u53E3\u8C03\u7528, \u539F\u56E0: ${i.message}\u3002`,t},SEI_BEFORE_PUBLISH:"\u5F53\u524D client \u6CA1\u6709\u63A8 localStream(\u4E3B\u6D41\uFF0C\u975E\u5C4F\u5E55\u5206\u4EAB\u6D41)\uFF0C\u65E0\u6CD5\u8C03\u7528 client.sendSEIMessage() \u63A5\u53E3\u3002"},Dm={INVALID_USER_DEFINE_RECORDID:"TRTC.html#createClient",INVALID_PROXY:"Client.html#setProxyServer",INVALID_JOIN:"Client.html#join",INVALID_ROOMID_STRING:"Client.html#join",INVALID_ROOMID_INTEGER:"Client.html#join",INVALID_PUBLISH:"Client.html#publish",INVALID_UNPUBLISH:"Client.html#unpublish",INVALID_AUDIENCE:"Client.html#switchRole",INVALID_INITIALIZE:"Client.html#publish",INVALID_DUPLICATE_PUBLISHING:"Client.html#publish",INVALID_SUBSCRIBE_UNDEFINED:"Client.html#subscribe",INVALID_SUBSCRIBE_LOCAL:"Client.html#subscribe",INVALID_REMOTE_STREAM:"Client.html#subscribe",INVALID_ROLE:"Client.html#switchRole",INVALID_PARAMETER_SWITCH_ROLE:"Client.html#switchRole",INVALID_OPERATION_SWITCH_ROLE:"Client.html#switchRole",CLIENT_BANNED:"module-ClientEvent.html#.CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"Client.html#startPublishCDNStream",INVALID_OPERATION_STOP_PUBLISH_CDN:"Client.html#stopPublishCDNStream",START_MIX_TRANSCODE:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE:"Client.html#stopMixTranscode",INVALID_AUDIO_VOLUME:"Client.html#enableAudioVolumeEvaluation",ENABLE_SMALL_STREAM_PUBLISHED:"Client.html#enableSmallStream",DISABLE_SMALL_STREAM_PUBLISHED:"Client.html#disableSmallStream",NOT_SUPPORTED_SMALL_STREAM:"tutorial-27-advanced-small-stream.html#h2-4",INVALID_SMALL_STREAM_PROFILE:"Client.html#setSmallStreamProfile",REMOTE_NOT_PUBLISH_SMALL_STREAM:"Client.html#setRemoteVideoStreamType",INVALID_SWITCH_DEVICE:"LocalStream.html#switchDevice",INVALID_SWITCH_DEVICE_PUBLISHING:"LocalStream.html#switchDevice",INVALID_REPLACE_TRACK:"LocalStream.html#replaceTrack",INVALID_INITIALIZE_LOCAL_STREAM:"LocalStream.html#replaceTrack",INVALID_ADD_TRACK_REPETITIVE:"LocalStream.html#addTrack",INVALID_ADD_TRACK_REMOVING:"LocalStream.html#addTrack",INVALID_ADD_TRACK_PUBLISHING:"LocalStream.html#addTrack",INVALID_STREAM_INITIALIZED:"LocalStream.html#addTrack",INVALID_ADD_TRACK_NUMBER:"LocalStream.html#addTrack",INVALID_REMOVE_AUDIO_TRACK:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ADDING:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ON:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NUMBER:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHED:"LocalStream.html#removeTrack",START_MIX_TRANSCODE_TIMEOUT:"Client.html#startMixTranscode",START_MIX_TRANSCODE_FAILED:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE_FAILED:"Client.html#stopMixTranscode",MIX_TRANSCODE_NOT_STARTED:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_FRAMERATE:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_GOP:"Client.html#startMixTranscode",MIX_PARAMS_AUDIO_BITRATE:"Client.html#startMixTranscode",MIX_PARAMS_USER_Z_ORDER:"Client.html#startMixTranscode",MIX_PARAMS_NOT_SELF:"Client.html#startMixTranscode",MIX_PARAMS_USER_STREAM:"Client.html#startMixTranscode",INVALID_PLAY:"Stream.html#play",PLAY_FAILED:"Stream.html#play",INVALID_USERID:"TRTC.html#createClient",INVALID_CREATE_STREAM_SOURCE:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN:"TRTC.html#createStream",INVALID_CREATE_STREAM_AUDIO:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN_AUDIO:"TRTC.html#createStream",NOT_SUPPORTED_HTTP:"tutorial-05-info-browser.html#h2-2",NOT_SUPPORTED_WEBRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_TRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_PROFILE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_MEDIA:"tutorial-05-info-browser.html",NOT_SUPPORTED_H264ENCODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_H264DECODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_TRACK:"LocalStream.html#addTrack",NOT_SUPPORTED_REPLACE_TRACK:"LocalStream.html#replaceTrack",NOT_SUPPORTED_CAPTURE:"tutorial-05-info-browser.html",MICROPHONE_NOT_FOUND:"TRTC.html#createStream",CAMERA_NOT_FOUND:"TRTC.html#createStream",SUBSCRIBE_FAILED:"Client.html#subscribe",API_CALL_ABORTED(i){let t;return i.message.includes("REMOTE_STREAM_NOT_EXIST")?t="Client.html#subscribe":t="module-ErrorCode.html#.API_CALL_ABORTED",t}};typeof window!="undefined"&&(window.TRTC_ERROR_INFO=Nm,window.TRTC_ERROR_LINK=Dm);var Dd=(i,t)=>t?`${bi}/${i}/${t}`:`${bi}/${i}/index.html`;var Om=()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};let i=localStorage.getItem(sd);if(i){i=JSON.parse(i);let t=document.createElement("script");t.type="text/javascript",t.text=i.message,document.body.appendChild(t);let e=window.TRTC_ERROR_INFO,r=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:e,TRTC_ERROR_LINK:r}}return{}};function H(i){let{key:t,data:e,link:r,addDocLink:n=!0}=i,s="",o="",a="";oe(He[t])?s=He[t](e):re(He[t])&&(s=He[t]);let{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:d}=Om();r?a=`${r.className}.html#${r.fnName}`:d&&d[t]&&(oe(d[t])?a=d[t](e):re(d[t])&&(a=d[t]));let u=s;return pt()&&(c&&c[t]&&(oe(c[t])?o=c[t](e):re(c[t])&&(o=c[t])),o&&(n?u=`${o}
\u8BF7\u67E5\u770B\u6587\u6863: ${Dd("zh-cn",a)}

`:u=`${o}

`,u+=s)),n&&(u+=` 
Refer to: ${Dd("en",a)}
`),u}var Pm="trtc_env",Mm=function(){return new URLSearchParams(location.search).get(Pm)||""},Hn=i=>Number(i)<14e8,li=function(i,t){let e;Sn?e=Sn:e=Hn(i)?nd:rd;let r=Math.floor(Math.random()*pn(2,31));return`${e}/v5/AVQualityReportSvc/C2S?random=${r}&sdkappid=${i}&cmdtype=${t}`};function bd(){return et?4:di?2:Sr?3:Dt?12:vr?5:yr?13:1}function Pd(){return et?"Android":di?"iPhone":Sr?"iPad":Dt?"Mac":vr?"Windows":yr?"Linux":"unknown"}function Fn(){let{userAgent:i,connection:t}=navigator,e=(i.match(/NetType\/\S+/)||[])[0]||"";e=e.toLowerCase().replace("nettype/",""),e==="3gnet"&&(e="3g");let r=t&&t.type&&t.type.toLowerCase(),n=t&&t.effectiveType&&t.effectiveType.toLowerCase();n==="slow-2"&&(n="2g");let s=e||"unknown";if(r)switch(r){case"cellular":case"wimax":s=n||"unknown";break;case"wifi":s="wifi";break;case"ethernet":s="wired";break;case"none":case"other":case"unknown":default:s="unknown";break}return s}var Lm=function(i){return{AbilityOption:{AVLimit:i,GeneralLimit:{CPULimit:{uint32_CPU_num:navigator.hardwareConcurrency||0,str_CPU_name:String(navigator.platform),uint32_CPU_maxfreq:0,model:"",uint32_total_memory:0},uint32_terminal_type:bd(),uint32_device_type:0,str_os_verion:Pd(),uint32_link_type:1,str_client_version:Oi,uint32_net_type:si[Fn()],ua:navigator.userAgent,version:""}}}};function No({fn:i,context:t}){return function(...e){try{let r=i.apply(t||this,e);return Gn(r)?r.catch(n=>M.error(`${i.name}() error observed ${n}`)):r}catch(r){M.error(`${i.name}() error observed ${r}`)}}}function km(i,t){for(let e of Reflect.ownKeys(t))if(e!=="constructor"&&e!=="prototype"&&e!=="name"){let r=Object.getOwnPropertyDescriptor(t,e)||"";Object.defineProperty(i,e,r)}return i}function xm(i,t=48e3){return Md(i/4,t)}function Md(i,t=48e3){return i*1e3/t}function Um(i,t=48e3){return Ld(i,t)*4}function Ld(i,t=48e3){return i*t/1e3}var kd=typeof window!="undefined"&&typeof window.glog=="function"?window.glog:()=>{},pt=()=>{let i=navigator.language;return i=i.substring(0,2),i==="zh"},Yt=function(i){if(!i||typeof i!="object"||Object.prototype.toString.call(i)!="[object Object]")return!1;let t=Object.getPrototypeOf(i);if(t===null)return!0;let e=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return typeof e=="function"&&e instanceof e&&Function.prototype.toString.call(e)===Function.prototype.toString.call(Object)};function Ui(i,t=1,e=1){return i<=1?e:Ui(i-1,e,t+e)}function mt(i){return i>8?30*1e3:Ui(i)*1e3}function _e(i){return Reflect.apply(Object.prototype.toString,i,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var oe=i=>typeof i=="function",y=i=>typeof i=="undefined",re=i=>typeof i=="string",de=i=>typeof i=="number",Pt=i=>typeof i=="boolean",pi=i=>_e(i)==="object",ke=i=>_e(i)==="array",Vm=i=>_e(i)==="MediaStreamTrack".toLowerCase(),qt=i=>i.isRemote,Gn=i=>_e(i)==="promise",Mr=i=>oe(i)&&i.prototype.constructor===i,Wn=i=>Mr(i)?i.prototype.constructor.name:"";typeof window!="undefined"&&(window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var Do=typeof AudioWorkletNode!="undefined",Mt=()=>new window.AudioContext,wm=(()=>{let i;return()=>{if(i)return i;i=new window.AudioContext;let t=()=>{i.state==="suspended"?(i.resume(),document.addEventListener("click",i.resume)):i.state==="interrupted"?i.resume():document.removeEventListener("click",i.resume)};return i.onstatechange=()=>{M.info(`gain context state: ${i.state}`),t()},i}})();function Oo(i){return new Promise((t,e)=>{let r=[];i.forEach(n=>{n.then(t).catch(s=>{r.push(s),r.length===i.length&&e(r)})})})}function ee(){return!performance||!performance.now?Date.now():Math.floor(performance.now())}var bo=(i,t)=>{let{emit:e}=i;return i.emit=(...r)=>{try{return e.apply(i,r)}catch(n){let s=H({key:$.CATCH_HANDLER_ERROR,data:{name:t,event:r[0]},addDocLink:!1});return M.warn(`${s}

${n.stack}`),!1}},i},Od=i=>+i<10?`0${i}`:i,Bm=i=>{let t=i.match(/^\d+\.\d+\.\d+/)[0];if(!t)return i;let e=t.split("."),r=Od(e[1])+Od(e[2]);return e[1]-15>0&&(e[1]="15"),e[2]-15>0&&(e[2]="15"),`${e.join(".")}.${r}`},$m=Object.prototype.hasOwnProperty,{toString:kf}=Object.prototype;function Lr(i){if(i==null)return!0;if(typeof i=="boolean")return!1;if(typeof i=="number")return i===0;if(typeof i=="string"||typeof i=="function"||Array.isArray(i))return i.length===0;if(i instanceof Error)return i.message==="";if(Yt(i))switch(Object.prototype.toString.call(i)){case"[object File]":case"[object Map]":case"[object Set]":return i.size===0;case"[object Object]":{for(let t in i)if($m.call(i,t))return!1;return!0}}return!1}function Vi(i,t){return{userId:t,hasAudio:!!(i&dr),hasVideo:!!(i&cr),hasAuxiliary:!!(i&gn),hasSmall:!!(i&od),audioMuted:!!(i&no),videoMuted:!!(i&so),audioAvailable:!!(i&dr)&&!(i&no),videoAvailable:!!(i&cr)&&!(i&so)}}function Hm(i,t){return i>50||t>500?5:i>30||t>350?4:i>20||t>200?3:i>10||t>100?2:i>=0||t>=0?1:0}function Fm(i){let t={urls:`turn:${i.url}`};return!y(i.username)&&!y(i.credential)&&(t.username=i.username,t.credential=i.credential,t.credentialType="password",y(i.credentialType)||(t.credentialType=i.credentialType)),t}function kr(i,t=!0){if(!re(i))return 0;let e=i.split(".");return t?(Number(e[0])<<24|Number(e[1])<<16|Number(e[2])<<8|Number(e[3]))>>>0:(Number(e[3])<<24|Number(e[2])<<16|Number(e[1])<<8|Number(e[0]))>>>0}var Pr=function(i){return ke(i)||pi(i)},ht=function(i,t,e,r){if(!(Pr(i)&&Pr(t)))return 0;let n=0,s=Object.keys(t),o;for(let a=0,c=s.length;a<c;a++)if(o=s[a],!(y(t[o])||e&&e.includes(o)))if(Pr(i[o])&&Pr(t[o]))n+=ht(i[o],t[o],e,r);else{if(r&&r.includes(t[o]))continue;i[o]!==t[o]&&(i[o]=t[o],n+=1)}return n},Kn=i=>re(i)?document.getElementById(i):i,Gm=new Intl.DateTimeFormat("zh-CN",{dateStyle:"short",timeStyle:"medium"}),Wm=()=>Gm.format(new Date);var wf=h(_(),1);function zt({url:i,body:t,method:e,timeout:r}){let n=new XMLHttpRequest;return new Promise((s,o)=>{n.onreadystatechange=()=>{if(n.readyState===4)if(n.status>=200&&n.status<300)try{let a=JSON.parse(n.response);s({data:a})}catch(a){s({data:n.response})}else o({status:n.status,statusText:n.statusText||"request failed!"})},n.timeout=r||5e3,n.open(e||"POST",i,!0),n.send(t)})}var Ff=h(_(),1);var Km=0,jm=1,xd=2;function Jm({retryFunction:i,settings:t,onError:e,onRetrying:r,onRetryFailed:n,context:s}){return function(...o){let{retries:a=5,timeout:c=1e3}=t,d=0,u=-1,l=Km,m=(I,E)=>T(this,null,function*(){let N=s||this;try{let B=yield i.apply(N,o);d=0,I(B)}catch(B){let x=()=>{clearTimeout(u),d=0,l=xd,E(B)},F=()=>{l!==xd&&d<(oe(a)?a():a)?(d++,l=jm,oe(r)&&r.call(this,d,x),u=window.setTimeout(()=>{u=-1,m(I,E)},oe(c)?c(d):c)):(x(),oe(n)&&n.call(this,B))};oe(e)?e.call(N,B,F,E):F()}});return new Promise(m)}}var _t=Jm;var Xf=h(_(),1);var wi=class{constructor(t){p(this,"userId");p(this,"remoteUserId");p(this,"id");p(this,"sdkAppId");p(this,"type");p(this,"isLocal");this.id=t.id,this.userId=t.userId,this.sdkAppId=t.sdkAppId,this.remoteUserId=t.remoteUserId,this.isLocal=Pt(t.isLocal)?t.isLocal:!0,this.type=this.isLocal?"":t.type}createChild(t){return Object.setPrototypeOf(t,this)}setUserId(t){this.userId=t}setSdkAppId(t){this.sdkAppId=t}log(t,e){e.unshift(`[${this.isLocal?"\u2191":"\u2193"}${this.type&&this.type!=="main"?"*":""}${this.id}|${this.isLocal?this.userId:this.remoteUserId}]`),M.log(t,e,y(this.userId)||Lr(this.userId),this.userId,this.sdkAppId)}info(...t){this.log(2,t)}debug(...t){this.log(1,t)}warn(...t){this.log(3,t)}error(...t){this.log(4,t)}};var Zf=h(_(),1),Vd=h(ft(),1),qm=new Vd.default,C=qm;var tE=h(_(),1),wd=(K=>(K.ROOM_DESTROY="1",K.JOIN_START="21",K.JOIN_SCHEDULE_SUCCESS="22",K.JOIN_SIGNAL_CONNECTION_START="23",K.JOIN_SIGNAL_CONNECTION_END="24",K.JOIN_SEND_CMD="25",K.JOIN_RECEIVED_CMD_RES="26",K.JOIN_SUCCESS="27",K.JOIN_FAILED="28",K.LEAVE_START="51",K.LEAVE_SEND_CMD="52",K.LEAVE_SUCCESS="53",K.PUBLISH_START="61",K.SEND_FIRST_VIDEO_FRAME="62",K.SUBSCRIBE_START="81",K.SUBSCRIBE_SUCCESS="82",K.UNSUBSCRIBE_SUCCESS="83",K.LOCAL_TRACK_CAPTURE_START="101",K.LOCAL_TRACK_CAPTURE_SUCCESS="102",K.LOCAL_TRACK_CAPTURE_FAILED="103",K.LOCAL_TRACK_PUBLISHED="104",K.LOCAL_TRACK_UNPUBLISHED="105",K.LOCAL_TRACK_REPLACED="106",K.SWITCH_DEVICE_SUCCESS="107",K.TRACK_MUTED="108",K.TRACK_UNMUTED="109",K.REMOTE_TRACK_SUBSCRIBED="110",K.REMOTE_TRACK_UNSUBSCRIBED="111",K.PLAY_TRACK_START="151",K.PLAYER_STATE_CHANGED="152",K.VIDEO_LOADED_DATA="153",K.AUTOPLAY_DIALOG_CLICK_CONFIRM="154",K.WORKLET_LOADED_SUCCESS="155",K.WORKLET_LOADED_FAILED="156",K.SIGNAL_CONNECTION_STATE_CHANGED="201",K.PEER_CONNECTION_STATE_CHANGED="202",K.HEARTBEAT_REPORT="251",K.RECEIVED_PUBLISHED_USER_LIST="252",K.REMOTE_PUBLISH_STATE_CHANGED="253",K.AUDIO_LEVEL_INTERVAL="260",K.NETWORK_QUALITY="261",K.API_SUCCESS_RATE="262",K))(wd||{}),S=wd;var zm="%cTRTC%c%s",Qm="padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;",Zm="display: inline",eh=!(ut||et),Mo=class{constructor(){p(this,"_isEnableUploadLog",!0);p(this,"_localJoinedUser",new Map);p(this,"_queue",[]);p(this,"_timeoutId",-1);p(this,"_logLevel",1);p(this,"_logLevelToUpload",2);!En&&!Tn&&(this.checkURLParam(),this.installEvents())}get isAbleToUpload(){return this._isEnableUploadLog&&this._timeoutId!==-1}installEvents(){C.on(S.JOIN_SCHEDULE_SUCCESS,({schedule:t})=>{var e;((e=t==null?void 0:t.config)==null?void 0:e.logLevelToUpload)&&ct[t.config.logLevelToUpload]&&(this._logLevelToUpload=t.config.logLevelToUpload)}),C.on(S.JOIN_SUCCESS,({room:t})=>{this.addJoinedUser({userId:t.userId,sdkAppId:t.sdkAppId}),this.startUpload()}),C.once(S.JOIN_FAILED,()=>{this.startUpload()}),C.on(S.LEAVE_SUCCESS,({room:t})=>{this.deleteJoinedUser(t.userId)})}startUpload(){this._timeoutId===-1&&this.uploadInterval()}addJoinedUser(t){this._localJoinedUser.set(t.userId,t),this.startUpload()}deleteJoinedUser(t){this._localJoinedUser.delete(t)}uploadInterval(){this.upload().catch(()=>{}),this._timeoutId=window.setTimeout(()=>this.uploadInterval(),2e3)}getLogsToUpload(){let t={map:new Map,splicedQueue:[]};if(this._queue[0].forAllJoinedClients&&this._localJoinedUser.size===0)return t;let e=0;for(;e<this._queue.length&&e!==50;e++){let r=this._queue[e];if(r.forAllJoinedClients)this._localJoinedUser.forEach(({userId:n,sdkAppId:s})=>{t.map.has(n)?t.map.get(n).logs.push(r):t.map.set(n,{userId:n,sdkAppId:s,logs:[r]})});else if(re(r.userId)&&de(r.sdkAppId)){let{userId:n,sdkAppId:s}=r;t.map.has(n)?t.map.get(n).logs.push(r):t.map.set(n,{userId:n,sdkAppId:s,logs:[r]})}}return t.map.size>0&&(t.splicedQueue=this._queue.splice(0,e)),t}upload(){return T(this,null,function*(){if(this._queue.length===0||!this._isEnableUploadLog)return;let{map:t,splicedQueue:e}=this.getLogsToUpload();if(t.size===0)return;try{let n=[...t.values()];for(let s=0;s<n.length;s++){let{userId:o,sdkAppId:a,logs:c}=n[s];yield this.uploadLogWithRetry(JSON.stringify({timestamp:Nn(),sdkAppId:String(a),userId:o,version:Be,log:c.map(d=>d.log).join(`
`)}),a),c.forEach(d=>d.uploaded=!0)}}catch(n){}let r=e.filter(n=>!n.uploaded);r.length>0&&(this._queue=r.concat(this._queue))})}uploadLogWithRetry(t,e){return _t({retryFunction:()=>zt({url:li(e,Mi.LOG),body:t,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(r,n)=>{n()}})()}getPrefix(t){let e=new Date;e.setTime(Er());let r=String(e.getMilliseconds());return"padStart"in String.prototype&&(r=r.toString().padStart(3,"0")),`[${e.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${r}] <${ct[t]}>`}getLogLevel(){return this._logLevel}setLogLevel(t){y(ct[t])||(this._logLevel!==t&&this.info("setLogLevel",t),this._logLevel=t)}enableUploadLog(){this._isEnableUploadLog=!0}disableUploadLog(){this.warn("disableUploadLog"),this._isEnableUploadLog=!1}logChunkToString(t){if(re(t))return t;try{return JSON.stringify(t)}catch(e){return""}}log(t,e,r=!0,n,s){var a;if(e.unshift(this.getPrefix(t)),this._isEnableUploadLog&&t>=this._logLevelToUpload&&this._queue.push({log:e.reduce((c,d)=>`${c} ${this.logChunkToString(d)}`.trim(),""),level:t,userId:n,sdkAppId:s,forAllJoinedClients:r}),t<this._logLevel)return;let o=((a=ct[t])==null?void 0:a.toLowerCase())||"info";eh?console[o](zm,Qm,Zm,...e):console[o](...e)}debug(...t){this.log(1,t)}info(...t){this.log(2,t)}warn(...t){this.log(3,t)}error(...t){this.log(4,t)}createLogger(t){return new wi(t)}checkURLParam(){let e=new URLSearchParams(location.search).get("logLevelToUpload"),r=e?Number(e):-1;ct[r]&&(this._logLevelToUpload=r)}},M=new Mo;var Bd=!0,$d=function(){var i;Bd&&(Bd=!1,M.getLogLevel()!==5&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info(`*   API Document: ${Pi}index.html`),console.info("*   Changelog: https://cloud.tencent.com/document/product/647/38958"),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),M.info("TRTC Web SDK Version:",Be),M.info("UA:",navigator.userAgent),M.info(`URL: ${location.href}${((i=self.frameElement)==null?void 0:i.tagName)==="IFRAME"?" in iframe":""}`))};var ju=h(ft());var IE=h(_()),Y={ERROR:"error",AUTOPLAY_FAILED:"autoplay-failed",KICKED_OUT:"kicked-out",REMOTE_USER_ENTER:"remote-user-enter",REMOTE_USER_EXIT:"remote-user-exit",REMOTE_AUDIO_AVAILABLE:"remote-audio-available",REMOTE_AUDIO_UNAVAILABLE:"remote-audio-unavailable",REMOTE_VIDEO_AVAILABLE:"remote-video-available",REMOTE_VIDEO_UNAVAILABLE:"remote-video-unavailable",AUDIO_VOLUME:"audio-volume",NETWORK_QUALITY:"network-quality",CONNECTION_STATE_CHANGED:"connection-state-changed",AUDIO_PLAY_STATE_CHANGED:"audio-play-state-changed",VIDEO_PLAY_STATE_CHANGED:"video-play-state-changed",SCREEN_SHARE_STOPPED:"screen-share-stopped",DEVICE_CHANGED:"device-changed",PUBLISH_STATE_CHANGED:"publish-state-changed"};var Lt={};ws(Lt,{HTTPS_API:()=>sh,IS_GET_CAPABILITIES_SUPPORTED:()=>dh,IS_GET_SETTINGS_SUPPORTED:()=>mi,IS_SEI_SUPPORTED:()=>Qn,basis:()=>uh,checkSystemRequirementsInternal:()=>Vo,decodeSupportStatus:()=>Xn,encodeSupportStatus:()=>Kd,getBrowserInfo:()=>rh,getDisplayResolution:()=>jd,getOSName:()=>Yn,isAddTransceiverSupported:()=>Vr,isBrowserSupported:()=>ko,isGetReceiversSupported:()=>Ur,isGetSendersSupported:()=>zn,isGetTransceiversSupported:()=>Qt,isGetUserMediaSupported:()=>Jd,isMediaDevicesSupported:()=>Jn,isMediaSessionSupported:()=>zd,isMediaStreamTrackProcessorSupported:()=>Uo,isReplaceTrackSupported:()=>ch,isScreenCaptureApiAvailable:()=>wo,isSelectedCandidatePair:()=>Bi,isSetParametersSupported:()=>Bo,isSmallStreamAPISupported:()=>Yd,isSmallStreamSupported:()=>qn,isStopTransceiverSupported:()=>ah,isTRTCSupported:()=>nh,isUnifiedPlanDefault:()=>oh,isUsedInHttpProtocol:()=>xo,isWebAudioSupported:()=>Xd,isWebCodecSupported:()=>qd,isWebCodecsSupported:()=>Wd,isWebRTCSupported:()=>$o,isWebTransportSupported:()=>Qd});var kE=h(_(),1);var vE=h(_(),1);var RE=h(_(),1),Hd=(R=>(R[R.INVALID_PARAMETER=4096]="INVALID_PARAMETER",R[R.INVALID_OPERATION=4097]="INVALID_OPERATION",R[R.NOT_SUPPORTED=4098]="NOT_SUPPORTED",R[R.DEVICE_NOT_FOUND=4099]="DEVICE_NOT_FOUND",R[R.INITIALIZE_FAILED=4100]="INITIALIZE_FAILED",R[R.SIGNAL_CHANNEL_SETUP_FAILED=16385]="SIGNAL_CHANNEL_SETUP_FAILED",R[R.SIGNAL_CHANNEL_ERROR=16386]="SIGNAL_CHANNEL_ERROR",R[R.ICE_TRANSPORT_ERROR=16387]="ICE_TRANSPORT_ERROR",R[R.JOIN_ROOM_FAILED=16388]="JOIN_ROOM_FAILED",R[R.CREATE_OFFER_FAILED=16389]="CREATE_OFFER_FAILED",R[R.SIGNAL_CHANNEL_RECONNECTION_FAILED=16390]="SIGNAL_CHANNEL_RECONNECTION_FAILED",R[R.UPLINK_RECONNECTION_FAILED=16391]="UPLINK_RECONNECTION_FAILED",R[R.DOWNLINK_RECONNECTION_FAILED=16392]="DOWNLINK_RECONNECTION_FAILED",R[R.REMOTE_STREAM_NOT_EXIST=16400]="REMOTE_STREAM_NOT_EXIST",R[R.CLIENT_BANNED=16448]="CLIENT_BANNED",R[R.SERVER_TIMEOUT=16449]="SERVER_TIMEOUT",R[R.SUBSCRIPTION_TIMEOUT=16450]="SUBSCRIPTION_TIMEOUT",R[R.PLAY_NOT_ALLOWED=16451]="PLAY_NOT_ALLOWED",R[R.DEVICE_AUTO_RECOVER_FAILED=16452]="DEVICE_AUTO_RECOVER_FAILED",R[R.START_PUBLISH_CDN_FAILED=16453]="START_PUBLISH_CDN_FAILED",R[R.STOP_PUBLISH_CDN_FAILED=16454]="STOP_PUBLISH_CDN_FAILED",R[R.START_MIX_TRANSCODE_FAILED=16455]="START_MIX_TRANSCODE_FAILED",R[R.STOP_MIX_TRANSCODE_FAILED=16456]="STOP_MIX_TRANSCODE_FAILED",R[R.NOT_SUPPORTED_H264=16457]="NOT_SUPPORTED_H264",R[R.SWITCH_ROLE_FAILED=16458]="SWITCH_ROLE_FAILED",R[R.API_CALL_TIMEOUT=16459]="API_CALL_TIMEOUT",R[R.SCHEDULE_FAILED=16460]="SCHEDULE_FAILED",R[R.API_CALL_ABORTED=16461]="API_CALL_ABORTED",R[R.UNKNOWN=65535]="UNKNOWN",R))(Hd||{}),b=Hd;var th=function(i){for(let t in b)if(b[t]===i)return t;return"UNKNOWN"},Lo=class extends Error{constructor({name:e="RtcError",message:r,code:n=b.UNKNOWN,extraCode:s=0,constraint:o}){let a=`<${th(n)} 0x${n.toString(16)}>`,c=`${r}${o?` constraint: ${o}`:""}${r!=null&&r.includes(a)?"":` ${a}`}`;super(c);this.code=n,this.extraCode=s,this.name=e,this.message=c,this.constraint=o,this.originMessage=r}getCode(){return this.code}getExtraCode(){return this.extraCode}toString(){return this.originMessage}},V=Lo;var ae={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isWebCodecsSupported:!1,isMediaDevicesSupported:!1,isScreenShareSupported:!1,isSmallStreamSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}},ih=new Map([[$e,["Firefox",uo]],[gr,["Edg",po]],[Dr,["Chrome",yo]],[lt,["Safari",br]],[Nt,["TBS",_o]],[bn,["XWEB",fo]],[Rr&&di,["WeChat",Eo]],[Pn,["QQ(Win)",To]],[Cr,["QQ(Mobile)",Tr]],[Ar,["QQ(Mobile X5)",Tr]],[Mn,["QQ(Mac)",So]],[Ln,["QQ(iPad)",Io]],[kn,["MI",go]],[xn,["HW",Ro]],[Un,["Samsung",Ao]],[Vn,["OPPO",Co]],[wn,["VIVO",vo]],[Ir,["EDGE",lo]],[Dn,["SogouMobile",mo]],[On,["Sogou",ho]]]);function rh(){let i=ih.get(!0),t=i?i[0]:"unknown",e=i?i[1]:"unknown";return{browserName:t,browserVersion:e}}var ko=function(){return!(Cd||Ir||gr&&Ad<80||$e&&Rd<56)},Wd=function(){return["VideoDecoder","VideoEncoder","AudioEncoder","AudioDecoder","MediaStreamTrackGenerator"].every(t=>t in window)},Jn=function(){if(!navigator.mediaDevices)return M.error(He.NOT_SUPPORTED_MEDIA),!1;let i=["getUserMedia","enumerateDevices"];return i.filter(t=>t in navigator.mediaDevices).length===i.length},Fd=!1;function xo(){return location.protocol==="http:"&&!Jt&&!Fd?(Fd=!0,M.warn(H({key:$.NOT_SUPPORTED_HTTP})),!0):!1}var Uo=function(){return(window==null?void 0:window.OffscreenCanvas)&&(window==null?void 0:window.MediaStreamTrackProcessor)&&(window==null?void 0:window.MediaStreamTrackGenerator)},Kd=function(){return T(this,null,function*(){if(ae.detail.isH264EncodeSupported||ae.detail.isVp8EncodeSupported)return{isH264EncodeSupported:ae.detail.isH264EncodeSupported,isVp8EncodeSupported:ae.detail.isVp8EncodeSupported};let i,t=!1,e=!1;try{let r=new RTCPeerConnection,n=document.createElement(f.CANVAS);n.getContext("2d");let s=n.captureStream(0);return r.addTrack(s.getVideoTracks()[0],s),i=yield r.createOffer(),i.sdp.toLowerCase().indexOf("h264")!==-1&&(t=!0),i.sdp.toLowerCase().indexOf("vp8")!==-1&&(e=!0),r.close(),ae.detail.isH264EncodeSupported=t,ae.detail.isVp8EncodeSupported=e,{isH264EncodeSupported:ae.detail.isH264EncodeSupported,isVp8EncodeSupported:ae.detail.isVp8EncodeSupported}}catch(r){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}})},Xn=function(){return T(this,null,function*(){if(ae.detail.isH264DecodeSupported&&ae.detail.isVp8DecodeSupported)return{isH264DecodeSupported:ae.detail.isH264DecodeSupported,isVp8DecodeSupported:ae.detail.isVp8DecodeSupported};let i,t=!1,e=!1;try{let r=new RTCPeerConnection;return i=yield r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),i.sdp.toLowerCase().indexOf("h264")!==-1&&(t=!0),i.sdp.toLowerCase().indexOf("vp8")!==-1&&(e=!0),r.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:e}}catch(r){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}})},Vo=function(){return T(this,null,function*(){if(ae.result)return ae;let i=ko(),t=$o(),e=Wd(),r=Jn(),{isH264EncodeSupported:n,isVp8EncodeSupported:s}=yield Kd(),{isH264DecodeSupported:o,isVp8DecodeSupported:a}=yield Xn();return ae.result=i&&t&&r&&(n||s)&&(o||a),ae.detail.isBrowserSupported=i,ae.detail.isWebRTCSupported=t,ae.detail.isWebCodecsSupported=e,ae.detail.isMediaDevicesSupported=r,ae.detail.isScreenShareSupported=wo(),ae.detail.isSmallStreamSupported=qn(),ae.detail.isH264EncodeSupported=n,ae.detail.isVp8EncodeSupported=s,ae.detail.isH264DecodeSupported=o,ae.detail.isVp8DecodeSupported=a,ae.result||M.error(`${navigator.userAgent} isBrowserSupported: ${i}isWebCodecsSupported: ${e} isMediaSupported: ${r} isH264EncodeSupported: ${n} isVp8EncodeSupported: ${s} isH264DecodeSupported: ${o} isVp8DecodeSupported: ${a} `),ae})},nh=function(){return ae.result},wo=function(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)},sh=(i,t,e)=>{location.protocol==="http:"&&!Jt&&(i[t]=()=>{throw new V({code:b.INVALID_OPERATION,message:He.NOT_SUPPORTED_HTTP})})},Bi=function(i){return i.type==="candidate-pair"&&i.nominated&&(i.state==="in-progress"||i.state==="succeeded")?!(Pt(i.selected)&&!i.selected):!1},Gd=new Map([[et,"Android"],[ut,"iOS"],[vr,"Windows"],[Dt,"MacOS"],[yr,"Linux"]]),Yn=function(){return Gd.get(!0)?Gd.get(!0):"unknown"};function jd(){let i="";if(screen.width){let t=screen.width?screen.width*window.devicePixelRatio:"",e=screen.height?screen.height*window.devicePixelRatio:"";i+=`${t} * ${e}`}return i}function Jd(){return navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function Xd(){let i={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let e=0;e<t.length;e++)if(t[e]in window){i.isSupported=!0;break}return i.isSupported}function Yd(){return"captureStream"in HTMLCanvasElement.prototype}function qn(){return Rr||ut||Or&&Or<63?!1:!!(ko()&&Yd())}var oh=function(){if(y(window.RTCRtpTransceiver)||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let i=null,t=!1;try{i=new RTCPeerConnection({sdpSemantics:ai}),i.addTransceiver(f.AUDIO),t=!0}catch(e){}return i==null||i.close(),t};function Ur(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function zn(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function Qt(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function Vr(){return"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype}function ah(){return"RTCRtpTransceiver"in window&&"stop"in window.RTCRtpTransceiver.prototype}function ch(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}function Bo(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&zn()}var mi=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,dh=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype,Qn="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&Nr()>=86,$o=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter(t=>t in window).length>0};function qd(){let i={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return y(window.AudioDecoder)||(i.AudioDecoder=!0),y(window.AudioEncoder)||(i.AudioEncoder=!0),y(window.VideoDecoder)||(i.VideoDecoder=!0),y(window.VideoEncoder)||(i.VideoEncoder=!0),y(window.ImageDecoder)||(i.ImageDecoder=!0),i}function zd(){return"mediaSession"in navigator&&!y(navigator.mediaSession.setActionHandler)}function Qd(){return!y(window.WebTransport)}function uh(){let i={browser:`${Ot.name}/${Ot.version}`,os:Yn(),displayResolution:jd(),isScreenShareSupported:wo(),isWebRTCSupported:$o(),isGetUserMediaSupported:Jd(),isWebAudioSupported:Xd(),isWebSocketsSupported:"WebSocket"in window&&window.WebSocket.CLOSING===2,isWebCodecSupported:qd(),isMediaSessionSupported:zd(),isWebTransportSupported:Qd()};return navigator.userAgent.includes("miniProgram")&&(i.browser=`mini/${i.browser}`),i}var mC=h(_(),1);var VE=h(_(),1),lh=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{let t=Math.random()*16|0;return(i=="x"?t:t&3|8).toString(16)})},Ho=lh;var FE=h(_(),1);var Fo=class{constructor(){p(this,"_prefix","TRTC");p(this,"_queue",new Map);this.checkStorage()}getRealKey(t){return`${this._prefix}_${t}`}checkStorage(){if(!Xt())return;setInterval(this.doFlush.bind(this),2e4),Object.keys(localStorage).filter(r=>{if(r.startsWith(this._prefix)){let n=JSON.parse(localStorage.getItem(r));if(n&&n.expiresIn<Date.now())return!0}return!1}).forEach(r=>localStorage.removeItem(r))}doFlush(){if(!!Xt())try{for(let[t,e]of this._queue)localStorage.setItem(t,JSON.stringify(e))}catch(t){M.warn(t)}}getItem(t){if(!Xt())return null;try{let e=JSON.parse(localStorage.getItem(this.getRealKey(t)));return e&&e.expiresIn>=Date.now()?e.value:null}catch(e){M.warn(e)}}setItem(t,e){if(!!Xt())try{let r={expiresIn:Date.now()+eo,value:e};this._queue.set(this.getRealKey(t),r)}catch(r){M.warn(r)}}deleteItem(t){if(!Xt())return!1;try{return t=this.getRealKey(t),this._queue.delete(t),localStorage.removeItem(t),!0}catch(e){return M.warn(e),!1}}clear(){if(!!Xt())try{localStorage.clear()}catch(t){M.warn(t)}}},$i=new Fo;var wI=h(_(),1);var KE=h(_(),1),eu=h(ft(),1);var Zd=Symbol("instance"),wr=Symbol("abortCtrl"),hi=Symbol("cacheResult"),Go=class{constructor(t,e,r){p(this,"oldState");p(this,"newState");p(this,"action");p(this,"error");this.oldState=t,this.newState=e,this.action=r}toString(){return`${this.action}ing`}},Br=class extends Error{constructor(e,r,n){super(r);p(this,"state");p(this,"message");p(this,"cause");this.state=e,this.message=r,this.cause=n}},$r=new Map,ph=Object.getPrototypeOf((()=>T(void 0,null,function*(){}))()).constructor;function ye(i,t,e={}){return(r,n,s)=>{let o=e.action||n;if(!e.context){let c=$r.get(r)||[];$r.has(r)||$r.set(r,c),c.push({from:i,to:t,action:o})}let a=s.value;s.value=function(...c){return T(this,null,function*(){var I;let d=this;if(e.context&&(d=ue.get(typeof e.context=="function"?e.context.call(this,...c):e.context)),d.state===t)return d[hi];let u=null;if(Array.isArray(i)?i.length==0?d[wr]&&(d[wr].aborted=!0):(typeof d.state!="string"||!i.includes(d.state))&&(u=new Br(d._state,`${d.name} ${o} to ${t} failed: current state ${d._state} not in from config`)):i!==d.state&&(u=new Br(d._state,`${d.name} ${o} to ${t} failed: current state ${d._state} not from ${i}`)),u)if(e.fail)e.fail.call(this,u);else{if(e.ignoreError)return u;throw u}let l=d.state;Zn.call(d,new Go(l,t,o));let m={aborted:!1};d[wr]=m;try{let E=a.apply(this,c);return E instanceof ph?d[hi]=yield E:d[hi]=E,m.aborted||(d[wr]=void 0,Zn.call(d,t),(I=e.success)==null||I.call(this,d[hi])),d[hi]}catch(E){let N=E instanceof Error?E.message:String(E);if(Zn.call(d,l,N),e.fail)e.fail.call(this,new Br(d._state,`action '${o}' failed :${N}`,E instanceof Error?E:new Error(N)));else{if(e.ignoreError)return E;throw E}}})}}}var mh=(()=>typeof window!="undefined"&&window.__AFSM__?(e,r)=>{window.dispatchEvent(new CustomEvent(e,{detail:r}))}:typeof importScripts!="undefined"?(e,r)=>{postMessage({type:e,payload:r})}:()=>{})();function Zn(i,t){let e=this._state;this._state=i;let r=i.toString();i&&this.emit(r,e),this.emit(ue.STATECHANGED,i,e,t),this.updateDevTools({value:i,old:e,err:t})}var hh,_h,We=class extends eu.default{constructor(e,r,n){super();p(this,"name");p(this,"groupName");p(this,"_state",We.INIT);p(this,hh);p(this,_h);this.name=e,this.groupName=r,e||(e=Date.now().toString(36)),n?Object.setPrototypeOf(this,n):n=Object.getPrototypeOf(this),r||(this.groupName=this.constructor.name);let s=n[Zd];s?this.name=s.name+"-"+s.count++:n[Zd]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram})}get stateDiagram(){let e=Object.getPrototypeOf(this),r=$r.get(e)||[],n=new Set,s=[],o=[],a=new Set,c=Object.getPrototypeOf(e);$r.has(c)&&(c.stateDiagram.forEach(u=>n.add(u)),c.allStates.forEach(u=>a.add(u))),r.forEach(({from:u,to:l,action:m})=>{typeof u=="string"?s.push({from:u,to:l,action:m}):u.length?u.forEach(I=>{s.push({from:I,to:l,action:m})}):o.push({to:l,action:m})}),s.forEach(({from:u,to:l,action:m})=>{a.add(u),a.add(l),a.add(m+"ing"),n.add(`${u} --> ${m}ing : ${m}`),n.add(`${m}ing --> ${l} : ${m} \u{1F7E2}`),n.add(`${m}ing --> ${u} : ${m} \u{1F534}`)}),o.forEach(({to:u,action:l})=>{n.add(`${l}ing --> ${u} : ${l} \u{1F7E2}`),a.forEach(m=>{m!==u&&n.add(`${m} --> ${l}ing : ${l}`)})});let d=[...n];return Object.defineProperties(e,{stateDiagram:{value:d},allStates:{value:a}}),d}static get(e){let r;return typeof e=="string"?(r=We.instances.get(e),r||We.instances.set(e,r=new We(e,void 0,Object.create(We.prototype)))):(r=We.instances2.get(e),r||We.instances2.set(e,r=new We(e.constructor.name,void 0,Object.create(We.prototype)))),r}static getState(e){var r;return(r=We.get(e))==null?void 0:r.state}updateDevTools(e={}){mh(We.UPDATEAFSM,w({name:this.name,group:this.groupName},e))}get state(){return this._state}set state(e){Zn.call(this,e)}},ue=We;hh=hi,_h=wr,p(ue,"STATECHANGED","stateChanged"),p(ue,"UPDATEAFSM","updateAFSM"),p(ue,"INIT","[*]"),p(ue,"ON","on"),p(ue,"OFF","off"),p(ue,"instances",new Map),p(ue,"instances2",new WeakMap);var KS=h(_(),1);var SS=h(_(),1);var XT=h(_(),1);var FT=h(_(),1);var qE=h(_(),1);var tu=(window==null?void 0:window.requestIdleCallback)||function(i){let t=Date.now();return setTimeout(()=>{i({didTimeout:!1,timeRemaining(){return Math.max(0,50-(Date.now()-t))}})},1e3)},fh=(window==null?void 0:window.cancelIdleCallback)||function(i){clearTimeout(i)},Eh=(window==null?void 0:window.cancelAnimationFrame)||(window==null?void 0:window.mozCancelAnimationFrame),Hr=class{static generateTaskID(){return this.currentTaskID++}static run(t=fr,e,r){t===fd?r=w({delay:2e3,count:0,backgroundTask:!0},r):t===yt?r=w({delay:1e4,count:0},r):t===jt?r=w({fps:60,delay:16.6,count:0,backgroundTask:!0},r):r=w({delay:2e3,count:0,backgroundTask:!0},r),pi(e)&&(r=w(w({},r),e)),oe(t)&&(e=t,t=fr);let n=w({taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:t,callback:e},r);return this.taskMap.set(n.taskID,n),this[t](n),n.taskID}static interval(t){let e=()=>{t.callback(),t.loopCount+=1,this.isBreakLoop(t)};return t.intervalID=setInterval(e,t.delay)}static timeout(t){let e=()=>{if(t.callback(),t.loopCount+=1,!this.isBreakLoop(t))return t.timeoutID=setTimeout(e,t.delay)};return t.timeoutID=setTimeout(e,t.delay)}static ric(t){let e=ee(),r,n=()=>{if(r=ee()-e,r>=t.delay&&(e=ee()-Math.floor(r%t.delay),t.callback(),t.loopCount+=1),!this.isBreakLoop(t))return t.ricID=tu(n,{timeout:t.delay})};return t.ricID=tu(n,{timeout:t.delay})}static raf(t){t.delay=(1e3/t.fps).toFixed(2);let e=ee(),r,n=()=>{if(document.hidden&&t.backgroundTask)return r=ee()-e,e=ee(),t.callback(),t.loopCount+=1,this.isBreakLoop(t)?void 0:t.timeoutID=setTimeout(n,t.delay-Math.floor(r%t.delay));if(r=ee()-e,r>=t.delay&&(e=ee()-Math.floor(r%t.delay),t.callback(),t.loopCount+=1),!this.isBreakLoop(t))return t.rafID=requestAnimationFrame(n)};if(t.rafID=requestAnimationFrame(n),t.backgroundTask){let s=()=>{if(document.hidden){let o=ee()-e;o>=t.delay?n():t.timeoutID=setTimeout(n,t.delay-o)}};document.addEventListener("visibilitychange",s),t.onVisibilitychange=s,document.hidden&&s()}return t.taskID}static hasTask(t){return this.taskMap.has(t)}static clearTask(t){if(!this.taskMap.has(t))return!0;let{intervalID:e,timeoutID:r,rafID:n,ricID:s,onVisibilitychange:o}=this.taskMap.get(t);return e&&clearInterval(e),r&&clearTimeout(r),n&&Eh(n),s&&fh(s),o&&document.removeEventListener("visibilitychange",o),this.taskMap.delete(t),!0}static isBreakLoop(t){return this.taskMap.has(t.taskID)?t.count!==0&&t.loopCount>=t.count?(this.clearTask(t.taskID),!0):!1:!0}};Hr.taskMap=new Map,Hr.currentTaskID=1;var le=Hr;var tT=h(_(),1);var iu={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_PUBLISHED:"stream-published",STREAM_SUBSCRIBED:"stream-subscribed",STREAM_UNSUBSCRIBED:"stream-unsubscribed",STATE_CHANGED:"state-changed",ERROR:"error",CONNECTION_STATE_CHANGED:"connection-state-changed",SEI_MESSAGE:f.SEI_MESSAGE},ZE={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_SUBSCRIBED:"stream-subscribed",CONNECTION_STATE_CHANGED:"connection-state-changed",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",MUTE_AUDIO:"mute-audio",MUTE_VIDEO:"mute-video",UNMUTE_AUDIO:"unmute-audio",UNMUTE_VIDEO:"unmute-video",CLIENT_BANNED:"client-banned",NETWORK_QUALITY:"network-quality",AUDIO_VOLUME:"audio-volume",SEI_MESSAGE:f.SEI_MESSAGE,ERROR:"error"};var Et={LOADED_DATA:f.LOADEDDATA,MEDIA_TRACK_CHANGED:"media-track-changed",PLAYER_STATE_CHANGED:"player-state-changed"};var gT=h(_(),1);var pT=h(_(),1);var Wo=class{constructor(){this._roomIdMap=new Map;typeof registerProcessor=="undefined"&&(this._configs={sdkAppId:"",userId:"",version:Be,env:Kt.QCLOUD,browserVersion:Ot.name+Ot.version,ua:navigator.userAgent})}setConfig({sdkAppId:t,env:e,userId:r,roomId:n}){t!==this._configs.sdkAppId&&(this._configs.sdkAppId=String(t)),this._configs.env=e,this._configs.userId=r,this._roomIdMap.set(r,String(n))}logSuccessEvent(t){Jt||!M.isAbleToUpload||this._configs.env===Kt.QCLOUD&&this.uploadEventToKibana(ie(w({},t),{result:"success"}))}logFailedEvent(t){if(Jt||!M.isAbleToUpload)return;let{eventType:e,code:r,error:n,userId:s}=t,o={roomId:this._roomIdMap.get(s||this._configs.userId),userId:s,eventType:e,result:"failed",code:r||(n==null?void 0:n.extraCode)||(n==null?void 0:n.code)||b.UNKNOWN};this._configs.env===Kt.QCLOUD&&this.uploadEventToKibana(ie(w({},o),{error:n}))}uploadEventToKibana(t){let e=`stat-${t.eventType}-${t.result}`;(t.eventType==="delta-join"||t.eventType==="delta-leave"||t.eventType==="delta-publish")&&(e=`${t.eventType}:${t.delta}`),this.uploadEvent({log:e,userId:t.userId}),t.result==="failed"&&(e=`stat-${t.eventType}-${t.result}-${t.code}`,this.uploadEvent({log:e,userId:t.userId,error:t.error}))}uploadEvent({log:t,userId:e,error:r}){let n={timestamp:Nn(),sdkAppId:this._configs.sdkAppId,userId:e||this._configs.userId,version:Be,log:t};r&&(n.errorInfo=r.message),this.sendRequest(li(this._configs.sdkAppId,Mi.LOG),n)}sendRequest(t,e){if(!M.isAbleToUpload){setTimeout(()=>{this.sendRequest(t,e)},1e3);return}zt({url:t,body:JSON.stringify(e)}).catch(()=>{})}},Ae=new Wo;var kt="trtc_autoplay",Ko=`${kt}_mask`,Hi=`${kt}_wrapper`,ru=`${kt}_header`,jo=`${kt}_content`,es=`${kt}_action_wrapper`,Jo=`${kt}_question`,Xo=`${kt}_collapse`,ts=`${kt}_action_confirm`,nu=`${kt}_detail`,su="#2473E8",qo="dialog",Th=`${qo}-show`,Sh=`${qo}-1`,Ih=`${qo}-2`,ou=!1,zo=()=>!!document.querySelector(`.${Hi}`),cu=`${bi}/${pt()?"zh-cn":"en"}/tutorial-21-advanced-auto-play-policy.html`,au=`<br><a href='${cu}' target='_blank'>${pt()?"\u5176\u4ED6\u65B9\u6848\uFF1F":"Any other solution?"}</a>`,gh=`${pt()?`\u6D4F\u89C8\u5668\u81EA\u52A8\u64AD\u653E\u7B56\u7565\uFF1A\u5728\u7528\u6237\u4E0E\u9875\u9762\u4EA7\u751F\u4EA4\u4E92\uFF08\u70B9\u51FB\u3001\u89E6\u6478\uFF09\u4E4B\u524D\uFF0C\u6D4F\u89C8\u5668\u7981\u6B62\u64AD\u653E\u6709\u58F0\u5A92\u4F53\u3002\u8BE5\u5F39\u7A97\u7528\u4E8E\u5E2E\u52A9\u7528\u6237\u6062\u590D\u97F3\u89C6\u9891\u64AD\u653E\u3002${au}`:`Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ${au}`}`,Yo=class{constructor(){p(this,"content","\u97F3\u89C6\u9891\u64AD\u653E\u88AB\u6D4F\u89C8\u5668\u62E6\u622A\uFF0C\u8BF7\u70B9\u51FB\u201C\u6062\u590D\u64AD\u653E\u201D\u3002");p(this,"_dialogNode",null);p(this,"_bodyPosition","");p(this,"_showDetail",!1);p(this,"_isCollapseClicked",!1);p(this,"_isQuestionClicked",!1);if(pt()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!ou){let t=document.createElement("style");t.innerHTML=`.${Ko}{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.${Ko} div:not(.${es}){display:block !important;}.${Hi}{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.${Hi} a{color:${su};}.${ru}{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.${jo}{margin:8px 0;}.${es}{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.${Xo}{margin-right:auto;cursor:pointer}.${Jo}{height:100%;line-height:16px;cursor:pointer;}.${ts}{margin-left:8px;color:#fff;background:${su};padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.${ts}:hover{opacity:0.9;}.${Xo},.${ts},.${jo},.${Jo}{font-size:14px;}@media screen and (max-width:750px){.${Hi}{width:80vw;}}`,document.head.appendChild(t),ou=!0}this.addDiaLog()}createDiaLog(){let t=document.createElement("template");t.innerHTML=`<div class="${Ko}"><div class='${Hi}'><div class='${ru}'>${location.host}</div><div class='${jo}'>${this.content}</div><div class='${nu}' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">${gh}</div><div class='${es}'></div></div></div>`.trim();let e=document.createElement("button");e.className=ts,e.innerText=pt()?"\u6062\u590D\u64AD\u653E":"Resume",e.onclick=this.onConfirm.bind(this);let r=document.createElement("div");r.className=Jo,r.innerHTML=`<?xml version="1.0" encoding="UTF-8"?>
    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>
    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>
    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>
    </svg>
    `,r.onclick=this.onQuestionClick.bind(this);let n=document.createElement("div");n.className=Xo,n.innerText=`${pt()?"\u8BE6\u60C5 >":"Detail >"}`,n.onclick=this.onCollapseClick.bind(this);let s=t.content.firstChild,o=s.querySelector(`.${es}`);return o.appendChild(n),o.appendChild(r),o.appendChild(e),s}addDiaLog(){zo()||(this._dialogNode=this.createDiaLog(),document.body.appendChild(this._dialogNode),this._dialogNode.onclick=this.onConfirm.bind(this),this._dialogNode.querySelector(`.${Hi}`).onclick=t=>t.stopPropagation(),this._bodyPosition=document.body.style.position,document.body.style.position="fixed",M.info("show autoplay dialog"),Ae.uploadEvent({log:Th}))}deleteDiaLog(){this._dialogNode&&(document.body.removeChild(this._dialogNode),document.body.style.position=this._bodyPosition,this._dialogNode=null)}onConfirm(){M.warn("confirm clicked, try resume stream"),C.emit(S.AUTOPLAY_DIALOG_CLICK_CONFIRM),this.deleteDiaLog()}onCollapseClick(){let t=this._dialogNode.querySelector(`.${nu}`);t.style.visibility=`${this._showDetail?"hidden":"visible"}`,t.style.height=`${this._showDetail?0:"fit-content"}`,this._showDetail=!this._showDetail,this._isCollapseClicked||Ae.uploadEvent({log:Sh}),this._isCollapseClicked=!0}onQuestionClick(){window.open(cu,"_blank"),this._isQuestionClicked||Ae.uploadEvent({log:Ih}),this._isQuestionClicked=!0}},du=Yo;var Fi={};ws(Fi,{create:()=>qe,remove:()=>Ue});var AT=h(_(),1),Fr=new WeakMap;function qe(i,t){Fr.has(i)||Fr.set(i,[]);let e=Fr.get(i),n={add:(s,o)=>("addEventListener"in t?(e.push(t.removeEventListener.bind(t,s,o)),t.addEventListener(s,o)):(e.push(t.off.bind(t,s,o)),t.on(s,o)),n)};return n}function Ue(i){let t=Fr.get(i);t&&(t.forEach(e=>e()),Fr.delete(i))}var xt=class extends ue{constructor(e,r){super(e.id,`${r}-player`);this.kind=r;p(this,"id");p(this,"element",null);p(this,"container",null);p(this,"mediaStream",new MediaStream);p(this,"track");p(this,"attr");p(this,"muted");p(this,"_log");p(this,"_pausedRetryCount");p(this,"_isElementPlayingFired",!1);p(this,"_interval");this.id=e.id,this._log=e.log,this.track=e.track,this.container=e.container,this.muted=e.muted,this._pausedRetryCount=hd,this._state="STOPPED",this.bindTrackEvents()}get isPlaying(){return this._state==="PLAYING"}get isStopped(){return this._state==="STOPPED"}setAttr(e){this.attr=e}setTrack(e){if(e!==this.track&&(this.unbindTrackEvents(),this.track=e,this.emit(Et.MEDIA_TRACK_CHANGED,e),e!==null&&(this.bindTrackEvents(),this.element))){let r=new MediaStream;r.addTrack(e),this.element.srcObject=r}}setContainer(e){this.container=e,this.track&&this.element&&this.container&&this.container.appendChild(this.element)}play(){return T(this,null,function*(){if(this.element&&this.element.parentElement!==this.container&&this.container&&this.container.append(this.element),!this.isPlaying)try{this.bindAutoPlayEvent(),yield this.element.play()}catch(e){let r=H({key:$.PLAY_FAILED,data:{media:this.kind,error:e}});if(this._log.warn(e),r.includes("NotAllowedError"))throw new V({code:b.PLAY_NOT_ALLOWED,message:r})}})}stop(){this.unbindEvents(),this._isElementPlayingFired=!1,this.element&&(this.container&&this.container.removeChild(this.element),this.element.srcObject=null,this.element=null),this.handleStopped(f.ENDED),this._interval>0&&le.clearTask(this._interval)}resume(){return this.isPlaying?Promise.resolve():Bn?this.replay():(this._log.info("resume"),this.play().catch(()=>{}))}setMuted(e){this.element&&(this.element.muted=e),this.muted=e}setRect(e,r){this.element&&(this.element.style.width=`${e}px`,this.element.style.height=`${r}px`)}replay(){return this.stop(),this.play().catch(()=>{})}bindElementEvents(){if(this.element){let e=this.handleElementEvent.bind(this);qe(this.element,this.element).add(f.PLAYING,e).add(f.ENDED,e).add(f.PAUSE,e).add(f.ERROR,e).add(f.LOADEDDATA,e)}}bindTrackEvents(){if(this.track){let e=this.handleTrackEvent.bind(this);Fi==null||Fi.create(this.track,this.track).add(f.ENDED,e).add(f.MUTE,e).add(f.UNMUTE,e),this.track.readyState===f.ENDED&&this.handleTrackEvent({type:f.ENDED}),this.track.muted&&this.handleTrackEvent({type:f.MUTE})}}bindAutoPlayEvent(){C.on(S.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}unbindTrackEvents(){this.track&&Ue(this.track)}unbindEvents(){this.element&&Ue(this.element),this.unbindTrackEvents(),C.off(S.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}handleElementEvent(e){var n;switch(e.type){case f.PLAYING:this._isElementPlayingFired=!0,this._log.info(`${this.kind} player is playing`),this.handlePlaying(f.PLAYING),this._interval&&(le.clearTask(this._interval),this._interval=-1);break;case f.ENDED:this._log.info(`${this.kind} player is ended`),this.handleStopped(f.ENDED);break;case f.PAUSE:this._log.info(`${this.kind} player is paused`),this.handlePaused(f.PAUSE);let s=this.container&&document.getElementById(this.container.id);s||this._log.warn(`${this.kind} player has been remove, element ID: ${(n=this.container)==null?void 0:n.id}`);let o=Nr();this._pausedRetryCount>0&&(this.kind===f.VIDEO&&!zo()||this.kind===f.AUDIO&&(de(o)&&o<=70||!s))&&(this._log.info(`${this.kind} player auto resume when paused`),this.resume(),this._pausedRetryCount--),ut&&(this._interval=le.run(fr,()=>{this.element&&this._state==="PAUSED"&&this.resume()},{delay:3e3}));break;case f.ERROR:if(this.element&&this.element.error){let a=`${Yn()}/${Ot.name}/${Ot.version}`;this._log.error(`${this.kind} player error observed. code: ${this.element.error.code} message: ${this.element.error.message} deviceInfo: ${a}`)}break;case f.LOADEDDATA:this.kind===f.VIDEO&&this.emit(Et.LOADED_DATA);break}}handleTrackEvent(e){switch(e.type){case f.ENDED:this._log.info(`${this.kind} track is ended`),this.handleStopped(f.ENDED);break;case f.MUTE:this._log.info(`${this.kind} track is unable to provide media output`),this.handlePaused(f.MUTE);break;case f.UNMUTE:this._log.info(`${this.kind} track is able to provide media output`),this._isElementPlayingFired&&this.handlePlaying(f.UNMUTE);break}}handlePlaying(e){this.emit(Et.PLAYER_STATE_CHANGED,{type:this.kind,state:"PLAYING",reason:e})}handlePaused(e){this.emit(Et.PLAYER_STATE_CHANGED,{type:this.kind,state:"STOPPED",reason:e})}handleStopped(e){this.emit(Et.PLAYER_STATE_CHANGED,{type:this.kind,state:"STOPPED",reason:e})}getElement(){return this.element}};G([ye([],"PLAYING")],xt.prototype,"handlePlaying",1),G([ye("PLAYING","STOPPED",{ignoreError:!0})],xt.prototype,"handlePaused",1),G([ye([],"STOPPED")],xt.prototype,"handleStopped",1);var _i=class extends xt{constructor(e){super(e,f.VIDEO);p(this,"mirror");p(this,"objectFit");y(e.mirror)||(this.mirror=e.mirror),y(e.objectFit)||(this.objectFit=e.objectFit)}initializeElement(){var n;let e=document.createElement(f.VIDEO);if(this.track){let s=new MediaStream;s.addTrack(this.track),e.srcObject=s}e.muted=!0;let r=`width: 100%; height: 100%; object-fit: ${this.objectFit};background-color: black;`;this.mirror&&(r+="transform: scaleX(-1);"),e.setAttribute("id",`video_${this.id}`),e.setAttribute("style",r),e.setAttribute("autoplay","autoplay"),e.setAttribute("playsinline","playsinline"),(n=this.container)==null||n.appendChild(e),this.element=e,this.bindElementEvents()}setAttr(e){let r=Object.assign({autoplay:"autoplay",playsinline:"playsinline",muted:!0},e);r.style=Object.assign({width:"100%",height:"100%"},r.style),super.setAttr(r)}setMirror(e){this.element&&(this.element.style.transform=e?"scaleX(-1)":""),this.mirror=e}setObjectFit(e){this.element&&(this.element.style.objectFit=`${e}`),this.objectFit=e}play(){return this.element||this.initializeElement(),super.play()}getVideoFrame(){if(!this.element)return"";let e=document.createElement("canvas");return e.width=this.element.videoWidth,e.height=this.element.videoHeight,e.getContext("2d").drawImage(this.element,0,0),e.toDataURL("image/png")}getElement(){return this.element}};var fS=h(_(),1);var dS=h(_(),1);var eS=h(_(),1);var Rh="class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=Math.max(rms,this.volume*0.95);this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);",lu=!1,Qo=class{constructor(t){p(this,"context_");p(this,"blob_");this.context_=t.context,this.blob_=new Blob([Rh],{type:"application/javascript"}),this.addModuleToContext()}addModuleToContext(){return T(this,null,function*(){try{yield this.context_.audioWorklet.addModule(URL.createObjectURL(this.blob_)),M.info("worklet addModule success"),C.emit(S.WORKLET_LOADED_SUCCESS),lu=!0}catch(t){M.info(`worklet addModule catch error. ${t.message}`),C.emit(S.WORKLET_LOADED_FAILED)}})}get initWorkletSuccess(){return lu}},pu=Qo;var tt,is,rs=0,Zo=class{constructor(t){p(this,"_volume");p(this,"_log");p(this,"_track");p(this,"_stream");p(this,"_audioCtx");p(this,"_destination");p(this,"_streamSource");p(this,"_scriptProcessorNode");p(this,"_audioWorkletNode");p(this,"_interval");let{track:e,log:r}=t;this._volume=0,this._log=r,this._track=e,tt||(tt=Mt()),this._audioCtx=tt,this._destination=this._audioCtx.destination;let n=new MediaStream;n.addTrack(this._track),this._streamSource=this._audioCtx.createMediaStreamSource(n),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._interval=200,C.on(S.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),Do?(C.on(S.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),C.on(S.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor(),rs+=1}preload(){is?is.initWorkletSuccess&&this.initAudioWorklet():is=new pu({context:tt})}initAudioWorklet(){if(!this._audioWorkletNode)try{this._audioWorkletNode=new AudioWorkletNode(this._audioCtx,"volume-meter"),this._audioWorkletNode.port.onmessage=t=>{this._volume=t.data.volume||0},this._streamSource.connect(this._audioWorkletNode).connect(this._destination),this.handleAudioLevelInterval({interval:this._interval})}catch(t){Ae.logFailedEvent({userId:this._log.userId,eventType:oi.LOAD_WORKLET,error:t}),this.initScriptProcessor()}}initScriptProcessor(){if(!this._scriptProcessorNode)try{this._scriptProcessorNode=this._audioCtx.createScriptProcessor(2048,1,1),this._scriptProcessorNode.onaudioprocess=t=>{let e=t.inputBuffer.getChannelData(0),r=0;for(let n=0;n<e.length;++n)r+=e[n]*e[n];this._volume=Math.sqrt(r/e.length)||0},this._streamSource.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._destination)}catch(t){this._log.error(`volumeMeter init script processor error: ${t}`)}}destroy(){this._streamSource&&this._streamSource.disconnect(),this._scriptProcessorNode&&(this._scriptProcessorNode.onaudioprocess=null,this._scriptProcessorNode.disconnect()),this._audioWorkletNode&&(this._audioWorkletNode.port.postMessage({name:"stop"}),this._audioWorkletNode.port.onmessage=null,this._audioWorkletNode.disconnect()),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._audioCtx=null,C.off(S.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),C.off(S.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),C.off(S.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),rs>0&&(rs-=1),rs===0&&(tt==null||tt.close(),tt=null,is=null)}resume(){tt==null||tt.resume()}getInternalAudioLevel(){return this._volume}getCalculatedVolume(){return parseFloat(this._volume.toFixed(2))}handleAudioLevelInterval(t){var r;let{interval:e}=t;this._interval=e,(r=this._audioWorkletNode)==null||r.port.postMessage({name:"setIntervalTime",intervalTime:e})}},mu=Zo;var fi=class extends xt{constructor(e){super(e,f.AUDIO);p(this,"_volumeMeter");p(this,"gainedTrack");p(this,"_outputDeviceId");p(this,"_volume",1);e.gainedTrack&&(this.gainedTrack=e.gainedTrack),this._outputDeviceId=e.outputDeviceId,this.track&&this.initVolumeMeter(this.track)}setTrack(e){this.track!==e&&(this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),e!==null&&this.initVolumeMeter(e)),super.setTrack(e)}initVolumeMeter(e){this._volumeMeter=new mu({track:this.gainedTrack||e,log:this._log})}initializeElement(){if((xi==="15.2"||xi==="15.3"||xi==="15.4")&&this.muted){this._log.info("audioElement is muted.");return}let r=document.createElement(f.AUDIO);if(this.gainedTrack||this.track){let n=new MediaStream;n.addTrack(this.gainedTrack||this.track),r.srcObject=n}r.muted=this.muted,r.setAttribute("id",`audio_${this.id}`),r.setAttribute("autoplay","autoplay"),r.setAttribute("playsinline","playsinline"),this.element=r,this.bindElementEvents()}play(){return T(this,null,function*(){this.element||this.initializeElement(),this._outputDeviceId&&(yield this.setSinkId(this._outputDeviceId)),!this._volumeMeter&&this.track&&this.initVolumeMeter(this.track),this.setVolume(this._volume),yield ri(fi.prototype,this,"play").call(this)})}stop(){this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),super.stop()}resume(){return T(this,null,function*(){yield ri(fi.prototype,this,"resume").call(this),this._volumeMeter&&this._volumeMeter.resume()})}setSinkId(e){return T(this,null,function*(){this._outputDeviceId!==e&&(this.element&&(yield this.element.setSinkId(e)),this._outputDeviceId=e)})}setVolume(e){!this.element||(this.element.volume=e,this._volume=e)}getAudioLevel(){var e;return((e=this._volumeMeter)==null?void 0:e.getCalculatedVolume())||0}getInternalAudioLevel(){var e;return(e=this._volumeMeter)==null?void 0:e.getInternalAudioLevel()}};var Ei=class extends ue{constructor({userId:e,sdkAppId:r,mediaType:n,room:s}){var o;super();p(this,"id",Ho());p(this,"userId");p(this,"isRemote");p(this,"mediaType");p(this,"room");p(this,"user");p(this,"_log");p(this,"isPlayCalled");p(this,"mediaTrack",null);p(this,"mediaStream");p(this,"container",null);p(this,"subVideoPlayerMap");p(this,"playerMuted",!1);p(this,"abortCtrl");p(this,"audioOutputDeviceId");p(this,"audioVolume");p(this,"objectFit","cover");p(this,"mirror",!1);p(this,"gain");p(this,"isScreen",!1);y(e)||(this.userId=e),this.mediaType=n,this._log=M.createLogger({id:`${this.kind[0]}t`,userId:(o=s||this.room)==null?void 0:o.userId,remoteUserId:this instanceof Ke?void 0:this.userId,sdkAppId:r,type:this.mediaType===2?"auxiliary":"main",isLocal:this instanceof Ke}),this.initPlayer()}get log(){return this._log||M}get kind(){return this.mediaType===1?f.AUDIO:f.VIDEO}get muted(){return!!(this.mediaTrack&&!this.mediaTrack.enabled)}get strMediaType(){return this.mediaType===4?f.VIDEO:this.mediaType===2?f.SCREEN:f.AUDIO}uninstallEvents(){}play(e,r){return T(this,null,function*(){if(!this.mediaTrack)return;let n=ke(e)?e[0]:e;if(this._log.info(`play with options: ${JSON.stringify(r)}`),this.isPlayCalled){r&&!y(r.muted)&&this.setPlayerMute(r.muted),r&&!y(r.objectFit)&&(this.objectFit=r.objectFit),this.isScreen?this.mirror=!1:r&&!y(r.mirror)&&(this.mirror=r.mirror),this.kind===f.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror),this.container!==n&&n&&(this.container=n,this.player.setContainer(n)),ke(e)&&e.length>=1&&(yield this.playSubContainer(e.slice(1),r)));return}(!this.isRemote||this.kind===f.VIDEO)&&(this.playerMuted=!0),r&&!y(r.muted)&&(this.playerMuted=r.muted),r&&!y(r.objectFit)&&(this.objectFit=r.objectFit),this.isScreen?this.mirror=!1:(this.isRemote||(this.mirror=!0),r&&!y(r.mirror)&&(this.mirror=r.mirror)),this.player.setMuted(this.playerMuted),this.kind===f.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror)),this.isPlayCalled=!0,n&&(this.container=n,this.player.setContainer(n)),C.emit(S.PLAY_TRACK_START,{track:this});try{yield this.player.play(),ke(e)&&e.length>1&&(yield this.playSubContainer(e.slice(1),r))}catch(s){throw this.handleAutoPlayFailed(),this.emit("error",s),s}})}playSubContainer(e,r){return T(this,null,function*(){if(!this.mediaTrack||this.kind===f.AUDIO)return;this.subVideoPlayerMap||(this.subVideoPlayerMap=new Map),this.subVideoPlayerMap.forEach((s,o)=>{var a;e.find(c=>o===c)||(s.stop(),s.setContainer(null),(a=this.subVideoPlayerMap)==null||a.delete(o))});for(let[s,o]of e.entries()){let a=this.subVideoPlayerMap.get(o);a?r&&(y(r.mirror)||a.setMirror(r.mirror),y(r.objectFit)||a.setObjectFit(r.objectFit)):this.subVideoPlayerMap.set(o,new _i({id:this.userId||this.id,track:this.mediaTrack,container:o,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log.createChild({id:`vp-sub${s+1}`})}))}let n=[...this.subVideoPlayerMap.values()];for(let s of n)yield s.play()})}initPlayer(){var e;this.log.info(`create ${this.kind}Player`),this.kind===f.AUDIO?this.player=new fi({id:this.userId||this.id,track:this.mediaTrack,gainedTrack:(e=this.gain)==null?void 0:e.audioTrack,container:this.container||null,muted:this.playerMuted,outputDeviceId:this.audioOutputDeviceId,log:this.log}):(this.player=new _i({id:this.userId||this.id,track:this.mediaTrack,container:this.container||null,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log}),this.player.on(Et.LOADED_DATA,()=>{C.emit(S.VIDEO_LOADED_DATA,{track:this})}),this.player.on(Et.MEDIA_TRACK_CHANGED,r=>{var n;(n=this.subVideoPlayerMap)==null||n.forEach(s=>s.setTrack(r))})),this.player.on(Et.PLAYER_STATE_CHANGED,r=>{C.emit(S.PLAYER_STATE_CHANGED,w({track:this},r)),this.emit("player-state-changed",r)})}setAudioOutput(e){return T(this,null,function*(){var r;this.audioOutputDeviceId=e,yield(r=this.player)==null?void 0:r.setSinkId(e)})}setAudioVolume(e){var r;this.audioVolume=e,this.log.info(`setAudioVolume to ${e}`),(r=this.player)==null||r.setVolume(e)}getAudioLevel(){var e;return((e=this.player)==null?void 0:e.getAudioLevel())||0}getInternalAudioLevel(){var e;return((e=this.player)==null?void 0:e.getInternalAudioLevel())||0}stop(){!this.isPlayCalled||(this.isPlayCalled=!1,this.player&&(this.log.info(`stop ${this.kind} player`),this.player.stop(),this.player.setContainer(null)),this.subVideoPlayerMap&&this.subVideoPlayerMap.size>0&&this.subVideoPlayerMap.forEach(e=>{e.stop(),e.setContainer(null)}),this.container=null)}resume(){return T(this,null,function*(){var e;!this.isPlayCalled||(yield(e=this.player)==null?void 0:e.resume())})}close(){var e;this.log.info("close"),this.isPlayCalled&&this.stop(),!this.isRemote&&((e=this.mediaTrack)==null||e.stop(),this.mediaTrack=null,this.uninstallEvents())}setMute(e){return this.mediaTrack?(this.mediaTrack.enabled=!e,this.emit(e?"mute":"unmute",this),C.emit(e?S.TRACK_MUTED:S.TRACK_UNMUTED,{track:this}),!0):!1}setPlayerMute(e){this.playerMuted=e,this.player.setMuted(e)}setMediaStream(e){e!==this.mediaStream&&(this.mediaStream=e)}setMediaStreamTrack(e){this.mediaStream||(this.mediaStream=new MediaStream),this.mediaTrack&&this.mediaStream.removeTrack(this.mediaTrack);let r=this.mediaTrack;this.mediaTrack=e,this.mediaTrack&&(this.mediaTrack.enabled=!this.muted,this.mediaStream.addTrack(this.mediaTrack),this.isRemote||this.player.setTrack(this.mediaTrack)),this.updatePlayingState(!!e),this.emit("media-track-changed",this.mediaTrack,r)}setMediaType(e){this.mediaType=e}updatePlayingState(e){!this.isPlayCalled||e&&!this.player.isStopped||!e&&this.player.isStopped||this.isPlayCalled&&this.player.isStopped===e&&(this.log.info(`playing state updated, ${e?"play":"stop"} ${this.kind}`),e&&this.player.isStopped&&this.player.play().catch(()=>this.handleAutoPlayFailed()),!e&&!this.player.isStopped&&this.player.stop())}handleAutoPlayFailed(){if(this.room&&this.room.enableAutoPlayDialog)new du;else{let e=()=>{this.resume().then(()=>{document.removeEventListener("click",e,!0),document.removeEventListener("touchstart",e,!0)})};document.addEventListener("click",e,!0),document.addEventListener("touchstart",e,!0)}}};G([ye([],ue.INIT)],Ei.prototype,"close",1);var mI=h(_(),1);var qS=h(_(),1);var Ah=Object.prototype.hasOwnProperty,{toString:XS}=Object.prototype;function Ch(i){if(i==null)return!0;if(typeof i=="boolean")return!1;if(typeof i=="number")return i===0;if(typeof i=="string"||typeof i=="function"||Array.isArray(i))return i.length===0;if(i instanceof Error)return i.message==="";if(Yt(i))switch(Object.prototype.toString.call(i)){case"[object File]":case"[object Map]":case"[object Set]":return i.size===0;case"[object Object]":{for(let t in i)if(Ah.call(i,t))return!1;return!0}}return!1}var Gi=Ch;var tI=h(_(),1),fu=h(ft(),1);var _u=i=>t=>t.deviceId===i;var Gr=class{constructor(t,e="Input"){p(this,"kind");p(this,"type");p(this,"devices",[]);this.kind=t,this.type=e}update(t,e){let r=t.filter(n=>n.kind===`${this.kind}${this.type.toLocaleLowerCase()}`);e&&(r.forEach(n=>{if(n.deviceId&&!this.devices.find(_u(n.deviceId))){let s=`${this.kind}${this.type}Added`;M.warn(`${s}: ${JSON.stringify(n)}`),e.emit(s,n)}}),this.devices.forEach(n=>{if(n.deviceId&&!r.find(_u(n.deviceId))){let s=`${this.kind}${this.type}Removed`;M.warn(`${s}: ${JSON.stringify(n)}`),e.emit(s,n)}})),this.devices=r}hasDevice(t){return!!this.devices.find(e=>e.deviceId===t)}},ea=class extends fu.EventEmitter{constructor(){super();p(this,"audioInputs",new Gr(f.AUDIO));p(this,"videoInputs",new Gr(f.VIDEO));p(this,"audioOutputs",new Gr(f.AUDIO,"Output"));this.init(),navigator.mediaDevices&&navigator.mediaDevices.addEventListener("devicechange",this.update.bind(this))}init(){ns().then(e=>{this.audioInputs.update(e),this.videoInputs.update(e),this.audioOutputs.update(e)})}update(){return T(this,null,function*(){let e=yield ns();return this.audioInputs.update(e,this),this.videoInputs.update(e,this),this.audioOutputs.update(e,this),this})}},fe=Tn||En?null:new ea;function ns(){return T(this,null,function*(){return xo()||!Jn()?[]:(yield navigator.mediaDevices.enumerateDevices()).map((t,e)=>{let r={kind:t.kind,deviceId:t.deviceId,groupId:t.groupId,label:t.label||`${t.kind}_${e}`};return t.deviceId.length>0&&ta.add(`${t.deviceId}_${t.kind}`),t.getCapabilities&&(r.getCapabilities=()=>t.getCapabilities()),r})})}function Qe(){return fe.update().then(i=>i.audioInputs.devices)}function St(){return fe.update().then(i=>i.videoInputs.devices)}function Wi(){return T(this,null,function*(){return fe.update().then(i=>i.audioOutputs.devices)})}var ta=new Set;function Eu(i){if(i instanceof CanvasCaptureMediaStreamTrack||!(i instanceof MediaStreamTrack))return!1;let t=i.label.toLocaleLowerCase();if(t.includes("camera")||t.includes("webcam"))return!0;let r=`${((i==null?void 0:i.getSettings())||{}).deviceId}_${f.VIDEO_INPUT}`;return!!ta.has(r)}function Tu(i){if(i instanceof CanvasCaptureMediaStreamTrack||!(i instanceof MediaStreamTrack))return!1;let t=i.label.toLocaleLowerCase();if(t.includes("mic")||t.includes("\u9EA6\u514B\u98CE"))return!0;let r=`${((i==null?void 0:i.getSettings())||{}).deviceId}_${f.AUDIO_INPUT}`;return!!ta.has(r)}function ia(i,t){return T(this,null,function*(){let r=(yield Qe()).find(n=>n.deviceId===ki);return(r==null?void 0:r.groupId)===i&&r.label===t})}function Su(s){return T(this,arguments,function*({newDeviceId:i,oldDeviceId:t,oldGroupId:e,oldLabel:r,kind:n}){return i!==t?!1:n===f.AUDIO&&i===ki?yield ia(e,r):!0})}var vh=function(i){return T(this,null,function*(){let t=yield Nh(i);M.info(`getUserMedia with constraints: ${JSON.stringify(t)}`);let e,r;t.audio&&(e=yield Qe(),M.info(`microphones: ${JSON.stringify(e)}`)),t.video&&(r=yield St(),M.info(`cameras: ${JSON.stringify(r)}`));try{return yield navigator.mediaDevices.getUserMedia(t)}catch(n){if(n.name==="NotFoundError"){if(r&&r.length===0)throw new V({code:b.DEVICE_NOT_FOUND,message:H({key:$.CAMERA_NOT_FOUND})});if(e&&e.length===0)throw new V({code:b.DEVICE_NOT_FOUND,message:H({key:$.MICROPHONE_NOT_FOUND})})}throw new V({code:b.INITIALIZE_FAILED,name:n.name,message:n.message,constraint:n.constraint})}})},yh=_t({retryFunction:vh,settings:{retries:3,timeout:500},onError:(i,t,e)=>{i.name==="NotReadableError"?t():e(i)},onRetrying:i=>{M.warn(`getUserMedia NotReadableError observed, retrying [${i}/3]`)}});function Nh(i){return T(this,null,function*(){let t={echoCancellation:i.echoCancellation,autoGainControl:i.autoGainControl,noiseSuppression:i.noiseSuppression};if(!i.audio)t=!1;else if(!Gi(i.microphoneId))t=w({deviceId:i.useExact?{exact:i.microphoneId}:i.microphoneId,sampleRate:i.sampleRate,channelCount:i.channelCount},t);else{t=w({sampleRate:i.sampleRate,channelCount:i.channelCount},t);let o=(yield Qe()).filter(({deviceId:a})=>a.length>0);o.length>0&&(t.deviceId={exact:o[0].deviceId})}let e={},r={ideal:i.width,max:i.width},n={ideal:i.height,max:i.height};return $e&&Dt&&i.width*i.height<352*288&&(r=i.width,n=i.height),!y(i.facingMode)&&i.video?e={facingMode:i.facingMode,width:r,height:n,frameRate:i.frameRate}:!Gi(i.cameraId)&&i.video?e={deviceId:i.useExact?{exact:i.cameraId}:i.cameraId,width:r,height:n,frameRate:i.frameRate}:i.video?y(i.width)?e=!0:e={width:r,height:n,frameRate:i.frameRate}:e=!1,{audio:t,video:e}})}var Iu=yh;var fI=h(_(),1);function ss(i){return ce((t,e)=>function(...r){return T(this,null,function*(){return yield i.apply(this,r),t.apply(this,r)})})}function os(i){return ce((t,e)=>function(...r){return T(this,null,function*(){return i.call(this,t.apply(this,r))})})}function ce(i){return function(t,e,r){return r.value=i(r.value,e),r}}var Ke=class extends Ei{constructor(e){super({mediaType:e});p(this,"isRemote",!1);p(this,"deviceId");p(this,"groupId","");p(this,"label","");p(this,"_isRecapturing",!1);p(this,"_lastRecaptureTime",0);this.onTrackMuted=this.onTrackMuted.bind(this),this.onTrackEnded=this.onTrackEnded.bind(this)}installTrackEvent(e){e.addEventListener(f.MUTE,this.onTrackMuted),e.addEventListener(f.ENDED,this.onTrackEnded),e.muted&&this.onTrackMuted(),e.readyState===f.ENDED&&this.onTrackEnded()}uninstallTrackEvent(e){e.removeEventListener(f.MUTE,this.onTrackMuted),e.removeEventListener(f.ENDED,this.onTrackEnded)}setStateToCapture(){}capture(e){return T(this,null,function*(){try{C.emit(S.LOCAL_TRACK_CAPTURE_START,{track:this});let r;e.customSource?(r=new MediaStream,r.addTrack(e.customSource)):r=yield Iu(e);let n=r.getTracks()[0];return this.setMediaStream(r),this.setMediaStreamTrack(n),e.customSource||(this.updateDeviceIdInUse(),this.listenDeviceChange()),C.emit(S.LOCAL_TRACK_CAPTURE_SUCCESS,{track:this}),r}catch(r){throw C.emit(S.LOCAL_TRACK_CAPTURE_FAILED,{track:this,error:r}),this.log.error(`getUserMedia error observed ${r}`),r}})}setMediaStreamTrack(e){this.state===ue.INIT&&this.setStateToCapture(),this.mediaTrack&&this.uninstallTrackEvent(this.mediaTrack),super.setMediaStreamTrack(e),e&&this.installTrackEvent(e)}setPublishStarting(){}setPublishStarted(){}setPublishStopped(e,r){}publish(e){this.room=e,this.userId=e.userId,this._log.setUserId(e.userId),this._log.setSdkAppId(e.sdkAppId),C.emit(S.LOCAL_TRACK_PUBLISHED,{track:this}),this.setPublishStarted()}unpublish(){this.room=void 0,this.mediaType===2&&(this.mediaType=4),C.emit(S.LOCAL_TRACK_UNPUBLISHED,{track:this}),this.setPublishStopped("api-call")}get isPublishing(){return this.state==="publish"}updateDeviceIdInUse(){return T(this,null,function*(){if(this.mediaTrack&&mi){let{deviceId:e,groupId:r}=this.mediaTrack.getSettings();(yield Su({newDeviceId:e,oldDeviceId:this.deviceId,oldGroupId:this.groupId,oldLabel:this.label,kind:this.kind}))||(this.deviceId=e,this.label=this.mediaTrack.label,r&&(this.groupId=r),ns().then(s=>{let o=s.find(a=>a.deviceId===e);o&&this.emit("2",o)}))}})}setProfile(e){this.log.info("setProfile",e),Object.assign(this.profile,e)}isNeedToRecapture(e=!1){return!(!this.deviceId||!this.mediaTrack||this.kind===f.AUDIO&&!Tu(this.mediaTrack)||this.kind===f.VIDEO&&!Eu(this.mediaTrack)||this._isRecapturing||e&&Dt&&lt)}onTrackMuted(){if(!!this.isNeedToRecapture(!0)){if(Date.now()-this._lastRecaptureTime<_r){setTimeout(()=>this.onTrackMuted(),_r);return}setTimeout(()=>{var e;((e=this.mediaTrack)==null?void 0:e.muted)&&document.visibilityState==="visible"&&this.recapture(this.deviceId)},5e3)}}onTrackEnded(){if(!!this.isNeedToRecapture()){if(Date.now()-this._lastRecaptureTime<_r){setTimeout(()=>this.onTrackEnded(),_r);return}this.recapture(this.deviceId)}}recapture(e){return T(this,null,function*(){var s;if(this._isRecapturing||!this.mediaTrack)return;let r;return this.log.warn("recapture trying"),(s=this.mediaTrack)==null||s.stop(),this._isRecapturing=!0,this._lastRecaptureTime=Date.now(),(this.kind==="audio"?yield Qe():yield St()).find(o=>o.deviceId===e)&&(r=e),this.capture({deviceId:r,useExact:!0}).then(()=>{var o;return(o=this.room)==null?void 0:o.replaceTrack(this)}).then(()=>{this._isRecapturing=!1,this.log.warn("recapture success"),this.emit("1",{deviceId:this.deviceId})}).catch(o=>{this._isRecapturing=!1,this.log.warn(`recapture failed ${o.message}`),this.emit("5",o)})})}};G([ye(ue.INIT,"capture")],Ke.prototype,"setStateToCapture",1),G([ye("capture","publish_starting",{success(){this.emit("4",{mediaType:this.strMediaType,state:"starting",prevState:"stopped"})}})],Ke.prototype,"setPublishStarting",1),G([ye("publish_starting","publish",{success(){this.emit("4",{mediaType:this.strMediaType,state:"started",prevState:"starting"})}})],Ke.prototype,"setPublishStarted",1),G([ce(i=>function(t,e){let r=this.state.oldState||this.state;i.call(this,t,e),r!=="capture"&&this.emit("4",{mediaType:this.strMediaType,state:"stopped",prevState:this.state.oldState==="publish_starting"?"starting":"started",reason:t,error:e})}),ye(["publish","publish_starting"],"capture",{ignoreError:!0})],Ke.prototype,"setPublishStopped",1);var YI=h(_(),1);var Ut=class extends Ke{constructor(){super(1);p(this,"mediaType",1);p(this,"volume",0);p(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40});p(this,"playerMuted",!0)}getAudioLevel(){return this.volume||super.getAudioLevel()}capture({deviceId:e,useExact:r=!1}={}){return super.capture({video:!1,audio:!0,microphoneId:e,echoCancellation:this.profile.echoCancellation,autoGainControl:this.profile.autoGainControl,noiseSuppression:this.profile.noiseSuppression,sampleRate:this.profile.sampleRate,channelCount:this.profile.channelCount,useExact:r})}switchDevice(e){return T(this,null,function*(){if(!(!this.mediaStream||!this.mediaTrack)){if(this.deviceId===e)if(e===ki){if(yield ia(this.groupId,this.label))return}else return;try{this.log.info(`switchDevice audio to: ${e}`),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),C.emit(S.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch microphone success")}catch(r){throw this.log.error(`switch microphone failed ${r}`),this.deviceId&&this.recapture(this.deviceId),r}}})}listenDeviceChange(){fe&&!fe.listeners("audioInputRemoved").includes(this.handleMicrophoneRemoved)&&fe.on("audioInputRemoved",this.handleMicrophoneRemoved,this)}handleMicrophoneRemoved(e){return T(this,null,function*(){if(e.deviceId===this.deviceId){this.log.warn(`current microphone is lost: ${JSON.stringify(e)}`);let r=yield Qe();r[0]?this.recapture(r[0].deviceId):fe.on("audioInputAdded",this.handleMicrophoneAdded,this)}})}handleMicrophoneAdded(e){return T(this,null,function*(){this.log.warn(`microphone added: ${JSON.stringify(e)}`),this.recapture(e.deviceId)})}close(){fe.off("audioInputAdded",this.handleMicrophoneAdded,this),fe.off("audioInputRemoved",this.handleMicrophoneRemoved,this),super.close()}};var ag=h(_(),1);var it=class extends Ke{constructor(){super(4);p(this,"mediaType",4);p(this,"profile",{width:640,height:480,frameRate:15,bitrate:900});p(this,"states",{bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0});p(this,"small");p(this,"facingMode");p(this,"_canvas");p(this,"_canvasInterval");p(this,"canvasTrack")}capture({deviceId:e,facingMode:r,useExact:n=!1,customSource:s}={}){return super.capture({audio:!1,video:!0,facingMode:r||this.facingMode,cameraId:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,useExact:n,customSource:s})}genCanvasTrack(){if(this.canvasTrack||!this.mediaTrack)return;this.log.info("gen canvas track");let{width:e,height:r,frameRate:n}=this.mediaTrack.getSettings();this._canvas=document.createElement("canvas");let s=this._canvas.getContext("2d");e&&r&&(this._canvas.width=e,this._canvas.height=r),this._canvasInterval=le.run(jt,()=>{if(!this._canvas)return;if(this.mediaTrack){let c=this.mediaTrack.getSettings();(c.width!==this._canvas.width||c.height!==this._canvas.height)&&(this._canvas.width=c.width,this._canvas.height=c.height)}let a=this.player.getElement();a&&(s==null||s.drawImage(a,0,0,this._canvas.width,this._canvas.height))},{fps:Math.max(15,n||0)});let o=this._canvas.captureStream();this.canvasTrack=o.getVideoTracks()[0]}destoryCanvasTrack(){this._canvasInterval&&(le.clearTask(this._canvasInterval),this._canvasInterval=void 0,this._canvas=void 0,this.canvasTrack=void 0)}setProfile(e){var n;if(!e)return;let r=e.bitrate&&e.bitrate!==this.profile.bitrate;return super.setProfile(e),(n=this.mediaTrack)==null?void 0:n.applyConstraints({width:e.width,height:e.height,frameRate:e.frameRate}).then(()=>{if(r&&this.room&&this.room.setBandWidth)return this.room.setBandWidth({bandwidth:e.bitrate,type:f.VIDEO,videoType:f.BIG})})}switchDevice(e){return T(this,null,function*(){try{if(!this.mediaStream||this.deviceId===e||this.facingMode===e)return;(e===f.FACING_MODE_USER||e===f.FACING_MODE_ENVIRONMENT)&&(this.facingMode=e,e=void 0),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),C.emit(S.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch camera success")}catch(r){throw this.log.error(`switch camera failed ${r}`),this.deviceId&&this.recapture(this.deviceId),r}})}listenDeviceChange(){fe&&!fe.listeners("audioInputRemoved").includes(this.handleCameraRemoved)&&fe.on("videoInputRemoved",this.handleCameraRemoved,this)}handleCameraRemoved(e){return T(this,null,function*(){if(e.deviceId===this.deviceId){this.log.warn(`current camera is lost: ${JSON.stringify(e)}`);let r=yield St();r[0]?this.recapture(r[0].deviceId):fe.on("videoInputAdded",this.handleCameraAdded,this)}})}handleCameraAdded(e){return T(this,null,function*(){this.log.warn(`camera added: ${JSON.stringify(e)}`),this.recapture(e.deviceId)})}close(){fe.off("videoInputAdded",this.handleCameraAdded,this),fe.off("videoInputRemoved",this.handleCameraRemoved,this),this.destoryCanvasTrack(),super.close()}};var Ig=h(_(),1);var mg=h(_(),1);var Oh=function(i){return T(this,null,function*(){let t=null;if(Dr&&Or<74||lt){let n=ra(i);M.info(`getDisplayMedia with constraints: ${JSON.stringify(n)}`);let s=yield navigator.mediaDevices.getDisplayMedia(n);if(i.systemAudio)return M.warn("Your browser not support capture system audio"),s;if(i.audio){let o=Ru(i);return M.info(`getUserMedia with constraints: ${JSON.stringify(o)}`),t=yield navigator.mediaDevices.getUserMedia(o),s.addTrack(t.getAudioTracks()[0]),s}return s}if(i.systemAudio){let n=ra(i);return M.info(`getDisplayMedia with constraints: ${JSON.stringify(n)}`),yield navigator.mediaDevices.getDisplayMedia(n)}let e=ra(i);M.info(`getDisplayMedia with constraints: ${JSON.stringify(e)}`);let r=yield navigator.mediaDevices.getDisplayMedia(e);if(i.audio){let n=Ru(i);return M.info(`getUserMedia with constraints: ${JSON.stringify(n)}`),t=yield navigator.mediaDevices.getUserMedia(n),r.addTrack(t.getAudioTracks()[0]),r}return r})};function Ru(i){let t={echoCancellation:i.echoCancellation,autoGainControl:i.autoGainControl,noiseSuppression:i.noiseSuppression,sampleRate:i.sampleRate,channelCount:i.channelCount};return y(i.microphoneId)||(t.deviceId=i.microphoneId),{audio:t,video:!1}}function ra(i){let t={systemAudio:"include",selfBrowserSurface:"include",surfaceSwitching:"include"},e={width:lt?{max:i.width}:{ideal:i.width,max:i.width},height:lt?{max:i.height}:{ideal:i.height,max:i.height},frameRate:i.frameRate,displaySurface:"monitor"};if(t.video=e,!y(i.systemAudio)){let{echoCancellation:r=!0,noiseSuppression:n=!1,autoGainControl:s=!1}=i;t.audio={echoCancellation:r,noiseSuppression:n,autoGainControl:s,sampleRate:48e3}}return t}var Au=Oh;var It=class extends it{constructor(){super();p(this,"profile",{width:1920,height:1080,frameRate:5,bitrate:1600});p(this,"objectFit","contain");p(this,"isScreen",!0);this._log.id=`s-${this._log.id}`}capture(){return T(this,arguments,function*({systemAudio:e=!1,autoGainControl:r,echoCancellation:n,noiseSuppression:s,audioTrack:o,videoTrack:a}={}){try{let c;return a||o?(c=new MediaStream,a&&c.addTrack(a),o&&c.addTrack(o)):c=yield Au({audio:!1,systemAudio:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,autoGainControl:r,echoCancellation:n,noiseSuppression:s}),this.setMediaStream(c),this.setMediaStreamTrack(c.getVideoTracks()[0]),c}catch(c){throw this.log.error(`getDisplayMedia error observed ${c}`),c instanceof V?c:new V({code:b.INITIALIZE_FAILED,name:c.name,message:c.message})}})}switchDevice(e){return T(this,null,function*(){throw new Error("Method not implemented.")})}};var Cg=h(_(),1);var Ti=class extends Ut{constructor(){super(),this._log.id=`s-${this._log.id}`}setScreenAudioTrack(t,e){this.setMediaStream(e),this.setMediaStreamTrack(t)}};var kg=h(_(),1);var Dg=h(_(),1),vu=h(ft(),1);var Cu=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","interruptbegin","interruptend","loadedmetadata","loadstart","mozaudioavailable","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"],Wr=class extends vu.default{constructor(e){super();p(this,"audioContext");p(this,"destination");p(this,"source",null);p(this,"audio");p(this,"id");this.audioContext=Mt(),this.initAudioContext(),this.destination=this.audioContext.createMediaStreamDestination(),this.audio=document.createElement("audio"),this.audio.crossOrigin="anonymous",this.audio.src=e.url,typeof e.loop=="boolean"&&(this.audio.loop=e.loop),e.volume&&this.setVolume(e.volume),e.id&&(this.id=e.id),this.source=this.audioContext.createMediaElementSource(this.audio),this.source.connect(this.destination),Cu.forEach(r=>{this.audio.addEventListener(r,this.handleAudio.bind(this))})}initAudioContext(){let e=this.audioContext,r=()=>{e.state==="suspended"?(e.resume(),document.addEventListener("click",r)):e.state==="interrupted"?e.resume():document.removeEventListener("click",r)};document.addEventListener("click",r),e.onstatechange=()=>{M.info(`audioSource context state: ${e.state}`),r()}}destroy(){var e,r;(e=this.source)==null||e.disconnect(),(r=this.destination)==null||r.disconnect(),this.audio&&(Cu.forEach(n=>{this.audio.removeEventListener(n,this.handleAudio.bind(this))}),this.audio.pause(),this.audio.removeAttribute("src"),this.audio.removeAttribute("srcObject"),this.audio.load()),this.audioContext.close().then(()=>{this.source=null,this.destination=null,this.audioContext=null})}handleAudio(e){this.emit(e.type,e)}getStream(){var e;return((e=this.destination)==null?void 0:e.stream)||null}play(){this.audio&&this.audio.play().then(()=>{}).catch(e=>{this.emit("error",e)})}pause(){this.audio&&this.audio.pause()}resume(){this.audio&&(this.audio.pause(),this.audio.currentTime=0)}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0)}setPosition(e){if(e<0&&e>this.duration()){M.error("Time beyond song duration.");return}this.audio&&(this.audio.currentTime=e)}getPosition(){if(this.audio)return this.audio.currentTime}setVolume(e){if(e>1&&e<0)throw new Error("\u97F3\u91CF\u8D85\u51FA\u9650\u5236");this.audio&&(this.audio.volume=e)}getVolume(){if(this.audio)return this.audio.volume}setPlayBackRate(e){if(e>8&&e<0)throw new Error("\u901F\u7387\u8D85\u51FA\u9650\u5236");this.audio&&(this.audio.playbackRate=e)}getPlayBackRate(){if(this.audio)return this.audio.playbackRate}duration(){return this.audio&&this.audio.duration||0}loop(e){if(e===void 0)return this.audio&&this.audio.loop;this.audio&&typeof e=="boolean"&&(this.audio.loop=e)}};var as=class{constructor({log:t}){p(this,"audioContext",null);p(this,"destination",null);p(this,"localAudioTrack",null);p(this,"localScreenAudioTrack",null);p(this,"audioTrackStreamSource",null);p(this,"screenAudioTrackStreamSource",null);p(this,"musicList",[]);p(this,"hasMusic",!1);p(this,"mixedMusicMap",new Map);p(this,"cacheMusicMap",new Map);p(this,"_log");this._log=t,this.initAudioContext()}get hasScreenAudioTrack(){return this.localScreenAudioTrack!==null}get hasAudioTrack(){return this.localAudioTrack!==null}isNeedToUseDestination(){return this.hasMusic&&this.localAudioTrack||this.localAudioTrack&&this.localScreenAudioTrack}get mediaStreamTrack(){var t,e;return this.isNeedToUseDestination()?this.destination.stream.getAudioTracks()[0]:((t=this.localAudioTrack)==null?void 0:t.mediaTrack)||((e=this.localScreenAudioTrack)==null?void 0:e.mediaTrack)}addMusicSource(t){return T(this,null,function*(){this.initAudioContext();let{id:e,url:r,loop:n,volume:s}=t;if(this.mixedMusicMap.has(e))return;let o;this.cacheMusicMap.has(e)?o=this.cacheMusicMap.get(e).audioSource:o=new Wr(t);let{stream:a}=o.destination,c=document.createElement("audio");c.srcObject=a,o.play(),yield c.play(),this._log.info(`start mix audio ${e} success.`);let d=this.audioContext.createMediaStreamSource(a),u=this.audioContext.createGain();d.connect(u),u.connect(this.destination),this.musicList.push(e),this.mixedMusicMap.set(e,{audioSource:o,streamSource:d,gainNode:u,audioPlayer:c}),this.cacheMusicMap.set(e,{audioSource:o}),this.hasMusic=!0})}addAudioTrack(t){this.initAudioContext(),!!(t!=null&&t.mediaStream)&&this.localAudioTrack!==t&&(this.localAudioTrack=t,this.audioTrackStreamSource=this.audioContext.createMediaStreamSource(t.mediaStream),this.audioTrackStreamSource.connect(this.destination))}addScreenAudioTrack(t){this.initAudioContext(),!!(t!=null&&t.mediaStream)&&this.localScreenAudioTrack!==t&&(this.localScreenAudioTrack=t,this.screenAudioTrackStreamSource=this.audioContext.createMediaStreamSource(t.mediaStream),this.screenAudioTrackStreamSource.connect(this.destination))}removeAudioTrackSource(t){var e,r;t==="main"&&((e=this.audioTrackStreamSource)==null||e.disconnect(),this.audioTrackStreamSource=null,this.localAudioTrack=null),t==="screen"&&((r=this.screenAudioTrackStreamSource)==null||r.disconnect(),this.screenAudioTrackStreamSource=null,this.localScreenAudioTrack=null)}removeMusicSource({id:t}){if(this.mixedMusicMap.has(t)){let{audioSource:e,streamSource:r,gainNode:n,audioPlayer:s}=this.mixedMusicMap.get(t);r.disconnect(),n.disconnect(),s.pause(),s.srcObject=null,e.stop(),this.mixedMusicMap.delete(t),this.musicList=this.musicList.filter(o=>o!==t),this.musicList.length===0&&(this.hasMusic=!1)}}destroyAllMusic(){this.musicList.forEach(t=>{this.removeMusicSource({id:t})})}initAudioContext(){if(this.audioContext)return;this.audioContext=Mt(),this.destination=this.audioContext.createMediaStreamDestination();let t=this.audioContext,e=()=>{t.state==="suspended"?(t.resume(),document.addEventListener("click",e)):t.state==="interrupted"?t.resume():document.removeEventListener("click",e)};document.addEventListener("click",e),t.onstatechange=()=>{M.info(`audioManager context state: ${t.state}`),e()}}destroy(){this.removeAudioTrackSource("main"),this.removeAudioTrackSource("aux"),this.audioContext.close()}};var eR=h(_(),1);var jg=h(_(),1);var na=class extends Ei{constructor(e,r,n){super({userId:r.userId,sdkAppId:e.sdkAppId,mediaType:n,room:e});this.room=e;this.user=r;p(this,"userId");p(this,"tinyId");p(this,"isRemote",!0);this.tinyId=r.tinyId,this.userId=r.userId}play(e,r){return this.hasFlag?super.play(e,r):(this.isPlayCalled=!0,this.container=e,e&&this.player.setContainer(e),Promise.resolve())}setMute(e){return this.hasFlag&&super.setMute(e)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.mediaTrack&&this.hasFlag&&this.isSubscribed&&this.player.setTrack(this.mediaTrack)}get isSubscribed(){return this.state===na.STATE_SUBSCRIBE}get streamType(){return(this.mediaType&2)===0?"main":"auxiliary"}subscribe(e=!0){this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack),this.updatePlayingState(!0),e&&C.emit(S.REMOTE_TRACK_SUBSCRIBED,{track:this})}unsubscribe(e=!0){this.player.setTrack(null),this.updatePlayingState(!1),e&&C.emit(S.REMOTE_TRACK_UNSUBSCRIBED,{track:this}),this.streamType==="main"&&this.kind==="video"&&this.room.changeType(!1,this.user)}onFlagChanged(){this.updatePlayingState(this.hasFlag),this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack)}},rt=na;p(rt,"STATE_SUBSCRIBE","subscribe"),G([ye(ue.INIT,rt.STATE_SUBSCRIBE)],rt.prototype,"subscribe",1),G([ye(rt.STATE_SUBSCRIBE,ue.INIT)],rt.prototype,"unsubscribe",1);var cs=class extends rt{constructor(e,r){super(e,r,1);p(this,"volume",0);p(this,"mediaType",1);p(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,end2EndDelay:0,jitterBufferDelay:0})}getAudioLevel(){return this.volume||super.getAudioLevel()}get hasFlag(){return this.user.muteState.hasAudio&&!this.user.muteState.audioMuted}isFlagChanged(e){let r=e.hasAudio&&!e.audioMuted;return this.hasFlag||(this.volume=0),this.hasFlag!==r}};var aR=h(_(),1);var Kr=class extends rt{constructor(e,r,n=4){super(e,r,n);p(this,"mediaType",4);p(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,end2EndDelay:0,jitterBufferDelay:0})}changeType(e){this.room.changeType(e,this.user)}get hasFlag(){return this.user.muteState.hasVideo&&!this.user.muteState.videoMuted}isFlagChanged(e){let r=e.hasVideo&&!e.videoMuted;return this.hasFlag!==r}},ds=class extends Kr{constructor(e,r){super(e,r,2);p(this,"mediaType",2);p(this,"objectFit","contain")}get hasFlag(){return this.user.muteState.hasAuxiliary}isFlagChanged(e){let r=e.hasAuxiliary;return this.hasFlag!==r}};var OA=h(_(),1);var pA=h(_());var uR=h(_());function ge(...i){}var bh=i=>i();function oa(){this.dispose()}var Ph=()=>typeof __FASTRX_DEVTOOLS__!="undefined",Mh=1,Vt=class extends Function{toString(){return`${this.name}(${this.args.length?[...this.args].join(", "):""})`}subscribe(t){let e=new sa(t,this,this.streamId++);return nt.subscribe({id:this.id,end:!1},{nodeId:e.sourceId,streamId:e.id}),this(e),e}},jr=class{constructor(){this.defers=new Set,this.disposed=!1}next(t){}complete(){this.dispose()}error(t){this.dispose()}get bindDispose(){return()=>this.dispose()}dispose(){this.disposed=!0,this.complete=ge,this.error=ge,this.next=ge,this.dispose=ge,this.subscribe=ge,this.doDefer()}subscribe(t){return t instanceof Vt?t.subscribe(this):t(this),this}get bindSubscribe(){return t=>this.subscribe(t)}doDefer(){this.defers.forEach(bh),this.defers.clear()}defer(t){this.defers.add(t)}removeDefer(t){this.defers.delete(t)}reset(){this.disposed=!1,delete this.complete,delete this.next,delete this.dispose,delete this.next,delete this.subscribe}resetNext(){delete this.next}resetComplete(){delete this.complete}resetError(){delete this.error}},X=class extends jr{constructor(t){super(),this.sink=t,t.defer(this.bindDispose)}next(t){this.sink.next(t)}complete(){this.sink.complete()}error(t){this.sink.error(t)}};function yu(i,...t){return t.reduce((e,r)=>r(e),i)}function wt(i,t,e){if(Ph()){let r=Object.defineProperties(Object.setPrototypeOf(i,Vt.prototype),{streamId:{value:0,writable:!0,configurable:!0},name:{value:t,writable:!0,configurable:!0},args:{value:e,writable:!0,configurable:!0},id:{value:0,writable:!0,configurable:!0}});nt.create(r);for(let n=0;n<e.length;n++){let s=e[n];typeof s=="function"&&s instanceof Vt&&nt.addSource(r,s)}return r}return i}function q(i,t){return function(...e){return r=>{if(r instanceof Vt){let n=wt(s=>{let o=new i(s,...e);o.sourceId=n.id,o.subscribe(r)},t,arguments);return n.source=r,nt.pipe(n),n}else return n=>r(new i(n,...e))}}}function Zt(i,t){window.postMessage({source:"fastrx-devtools-backend",payload:{event:i,payload:t}})}var sa=class extends X{constructor(t,e,r){super(t),this.source=e,this.id=r,this.sourceId=t.sourceId,this.defer(()=>{nt.defer(this.source,this.id)})}next(t){nt.next(this.source,this.id,t),this.sink.next(t)}complete(){nt.complete(this.source,this.id),this.sink.complete()}error(t){nt.complete(this.source,this.id,t),this.sink.error(t)}},nt={addSource(i,t){Zt("addSource",{id:i.id,name:i.toString(),source:{id:t.id,name:t.toString()}})},next(i,t,e){Zt("next",{id:i.id,streamId:t,data:e&&e.toString()})},subscribe({id:i,end:t},e){Zt("subscribe",{id:i,end:t,sink:{nodeId:e&&e.nodeId,streamId:e&&e.streamId}})},complete(i,t,e){Zt("complete",{id:i.id,streamId:t,err:e?e.toString():null})},defer(i,t){Zt("defer",{id:i.id,streamId:t})},pipe(i){Zt("pipe",{name:i.toString(),id:i.id,source:{id:i.source.id,name:i.source.toString()}})},update(i){Zt("update",{id:i.id,name:i.toString()})},create(i){i.id||(i.id=Mh++),Zt("create",{name:i.toString(),id:i.id})}},us=class extends Error{constructor(t){super(`timeout after ${t}ms`),this.timeout=t}};var IR=h(_());var fR=h(_());var aa=class extends jr{constructor(t){super(),this.source=t,this.sinks=new Set}add(t){t.defer(()=>this.remove(t)),this.sinks.add(t).size===1&&(this.reset(),this.subscribe(this.source))}remove(t){this.sinks.delete(t),this.sinks.size===0&&this.dispose()}next(t){this.sinks.forEach(e=>e.next(t))}complete(){this.sinks.forEach(t=>t.complete()),this.sinks.clear()}error(t){this.sinks.forEach(e=>e.error(t)),this.sinks.clear()}};function ls(){return i=>{let t=new aa(i);if(i instanceof Vt){let e=wt(r=>{t.add(r)},"share",arguments);return t.sourceId=e.id,e.source=i,nt.pipe(e),e}return wt(t.add.bind(t),"share",arguments)}}function Lh(...i){return wt(t=>{let e=i.length,r=e,n=e,s=new Array(e),o=()=>{--n===0&&t.complete()},a=(c,d)=>{let u=new X(t);u.next=l=>{--r===0?(u.next=m=>{s[d]=m,t.next(s)},u.next(l)):s[d]=l},u.complete=o,u.subscribe(c)};i.forEach(a)},"combineLatest",arguments)}var ca=class extends X{constructor(t,...e){super(t);let r=new X(this.sink);r.next=n=>this.buffer=n,r.complete=ge,r.subscribe(Lh(...e))}next(t){this.buffer&&this.sink.next([t,...this.buffer])}},pR=q(ca,"withLatestFrom"),da=class extends X{constructor(t,e,r){super(t),this.bufferSize=e,this.startBufferEvery=r,this.buffer=[],this.count=0,this.startBufferEvery&&(this.buffers=[[]])}next(t){this.startBufferEvery?(this.count++===this.startBufferEvery&&(this.buffers.push([]),this.count=1),this.buffers.forEach(e=>{e.push(t)}),this.buffers[0].length===this.bufferSize&&this.sink.next(this.buffers.shift())):(this.buffer.push(t),this.buffer.length===this.bufferSize&&(this.sink.next(this.buffer),this.buffer=[]))}complete(){this.buffer.length?this.sink.next(this.buffer):this.buffers.length&&this.buffers.forEach(t=>this.sink.next(t)),super.complete()}},mR=q(da,"bufferCount"),ua=class extends X{constructor(t,e){super(t),this.buffer=[];let r=new X(t);r.next=n=>{t.next(this.buffer),this.buffer=[]},r.complete=ge,r.subscribe(e)}next(t){this.buffer.push(t)}complete(){this.buffer.length&&this.sink.next(this.buffer),super.complete()}},hR=q(ua,"buffer");function la(i){let t=arguments,e=ls()(wt(r=>{e.next=n=>r.next(n),e.complete=()=>r.complete(),e.error=n=>r.error(n),i&&r.subscribe(i)},"subject",t));return e.next=ge,e.complete=ge,e.error=ge,e}function Nu(i){return wt(t=>{let e=0,r=setInterval(()=>t.next(e++),i);return t.defer(()=>{clearInterval(r)}),"interval"},"interval",arguments)}var $R=h(_());var AR=h(_());var pa=class extends X{constructor(t,e,r){super(t),this.f=e;let n=()=>{this.sink.next(this.acc),this.sink.complete()};typeof r=="undefined"?this.next=s=>{this.acc=s,this.complete=n,this.resetNext()}:(this.acc=r,this.complete=n)}next(t){this.acc=this.f(this.acc,t)}},kh=q(pa,"reduce");var ma=class extends X{constructor(t,e,r){super(t),this.filter=e,this.thisArg=r}next(t){this.filter.call(this.thisArg,t)&&this.sink.next(t)}},xh=q(ma,"filter"),ha=class extends X{next(t){}},DR=q(ha,"ignoreElements"),_a=class extends X{constructor(t,e){super(t),this.count=e}next(t){this.sink.next(t),--this.count===0&&this.complete()}},Uh=q(_a,"take"),fa=class extends X{constructor(t,e){super(t);let r=new X(t);r.next=()=>t.complete(),r.complete=oa,r.subscribe(e)}},OR=q(fa,"takeUntil"),Ea=class extends X{constructor(t,e){super(t),this.f=e}next(t){this.f(t)?this.sink.next(t):this.complete()}},Vh=q(Ea,"takeWhile");var Ta=class extends X{constructor(t,e){super(t),this.count=e}next(t){--this.count===0&&(this.next=super.next)}},bR=q(Ta,"skip"),Sa=class extends X{constructor(t,e){super(t),t.next=ge;let r=new X(t);r.next=()=>{r.dispose(),t.resetNext()},r.complete=oa,r.subscribe(e)}},PR=q(Sa,"skipUntil"),Ia=class extends X{constructor(t,e){super(t),this.f=e}next(t){this.f(t)||(this.next=super.next,this.next(t))}},wh=q(Ia,"skipWhile"),Bh={leading:!0,trailing:!1},ga=class extends X{constructor(t,e,r){super(t),this.durationSelector=e,this.trailing=r}cacheValue(t){this.last=t,this.disposed&&this.throttle(t)}send(t){this.sink.next(t),this.throttle(t)}throttle(t){this.reset(),this.subscribe(this.durationSelector(t))}next(){this.complete()}complete(){this.dispose(),this.trailing&&this.send(this.last)}},Ra=class extends X{constructor(t,e,r=Bh){super(t),this.durationSelector=e,this.config=r,this._throttle=new ga(this.sink,this.durationSelector,this.config.trailing),this._throttle.dispose()}next(t){this._throttle.disposed&&this.config.leading?this._throttle.send(t):this._throttle.cacheValue(t)}complete(){this._throttle.throttle=ge,this._throttle.complete(),super.complete()}},MR=q(Ra,"throttle");var Aa=class extends X{next(){this.complete()}complete(){this.dispose(),this.sink.next(this.last)}},Ca=class extends X{constructor(t,e){super(t),this.durationSelector=e,this._debounce=new Aa(this.sink),this._debounce.dispose()}next(t){this._debounce.dispose(),this._debounce.reset(),this._debounce.last=t,this._debounce.subscribe(this.durationSelector(t))}complete(){this._debounce.complete(),super.complete()}},LR=q(Ca,"debounce");var va=class extends X{constructor(t,e,r){super(t),this.count=e,this.defaultValue=r}next(t){this.count--===0&&(this.defaultValue=t,this.complete())}complete(){if(this.defaultValue===void 0){this.error(new Error("not enough elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},kR=q(va,"elementAt");var ya=class extends X{constructor(t,e){super(t),this.f=e,this.i=0}next(t){this.f(t)?(this.sink.next(this.i++),this.complete()):++this.i}},xR=q(ya,"findIndex"),Na=class extends X{constructor(t,e,r){super(t),this.f=e,this.defaultValue=r,this.index=0}next(t){(!this.f||this.f(t,this.index++))&&(this.defaultValue=t,this.complete())}complete(){if(this.defaultValue===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},UR=q(Na,"first"),Da=class extends X{constructor(t,e,r){super(t),this.f=e,this.defaultValue=r,this.index=0}next(t){(!this.f||this.f(t,this.index++))&&(this.defaultValue=t)}complete(){if(this.defaultValue===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},VR=q(Da,"last"),Oa=class extends X{constructor(t,e){super(t),this.predicate=e,this.index=0}next(t){this.predicate(t,this.index++)?this.result=!0:(this.result=!1,this.complete())}complete(){if(this.result===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.result);super.complete()}},wR=q(Oa,"every");var nA=h(_());var ba=class extends X{constructor(t,e,r){super(t),this.f=e,typeof r=="undefined"?this.next=n=>{this.acc=n,this.resetNext(),this.sink.next(this.acc)}:this.acc=r}next(t){this.sink.next(this.acc=this.f(this.acc,t))}},GR=q(ba,"scan"),Pa=class extends X{constructor(){super(...arguments),this.hasLast=!1}next(t){this.hasLast?this.sink.next([this.last,t]):this.hasLast=!0,this.last=t}},WR=q(Pa,"pairwise"),Ma=class extends X{constructor(t,e,r){super(t),this.mapper=e,this.thisArg=r}next(t){super.next(this.mapper.call(this.thisArg,t))}},Du=q(Ma,"map");var Ki=class extends X{constructor(t,e,r){super(t),this.data=e,this.context=r}next(t){let e=this.context.combineResults;e?this.sink.next(e(this.data,t)):this.sink.next(t)}tryComplete(){this.context.resetComplete(),this.dispose()}},ji=class extends X{constructor(t,e,r){super(t),this.makeSource=e,this.combineResults=r,this.index=0}subInner(t,e){let r=this.currentSink=new e(this.sink,t,this);this.complete=this.tryComplete,r.complete=r.tryComplete,r.subscribe(this.makeSource(t,this.index++))}tryComplete(){this.currentSink.resetComplete(),this.dispose()}},ps=class extends Ki{},ms=class extends ji{next(t){this.subInner(t,ps),this.next=e=>{this.currentSink.dispose(),this.subInner(e,ps)}}},$h=q(ms,"switchMap");function Es(i){return(t,e)=>i(()=>t,e)}var KR=Es(q(ms,"switchMapTo")),La=class extends Ki{tryComplete(){this.dispose(),this.context.sources.length?this.context.subNext():(this.context.resetNext(),this.context.resetComplete())}},hs=class extends ji{constructor(){super(...arguments),this.sources=[],this.next2=this.sources.push.bind(this.sources)}next(t){this.next2(t),this.subNext()}subNext(){this.next=this.next2,this.subInner(this.sources.shift(),La),this.disposed&&this.sources.length===0&&this.currentSink.resetComplete()}tryComplete(){this.sources.length===0&&this.currentSink.resetComplete(),this.dispose()}},jR=q(hs,"concatMap"),JR=Es(q(hs,"concatMapTo")),ka=class extends Ki{tryComplete(){this.context.inners.delete(this),super.dispose(),this.context.inners.size===0&&this.context.resetComplete()}},_s=class extends ji{constructor(){super(...arguments),this.inners=new Set}next(t){this.subInner(t,ka),this.inners.add(this.currentSink)}tryComplete(){this.inners.size===1?this.inners.forEach(t=>t.resetComplete()):this.dispose()}},XR=q(_s,"mergeMap"),YR=Es(q(_s,"mergeMapTo")),xa=class extends Ki{dispose(){this.context.resetNext(),super.dispose()}},fs=class extends ji{next(t){this.next=ge,this.subInner(t,xa)}},qR=q(fs,"exhaustMap"),zR=Es(q(fs,"exhaustMapTo")),Ua=class extends X{constructor(t,e){super(t),this.f=e,this.groups=new Map}next(t){let e=this.f(t),r=this.groups.get(e);typeof r=="undefined"&&(r=la(),r.key=e,this.groups.set(e,r),super.next(r)),r.next(t)}complete(){this.groups.forEach(t=>t.complete()),super.complete()}error(t){this.groups.forEach(e=>e.error(t)),super.error(t)}},QR=q(Ua,"groupBy"),Va=class extends X{constructor(){super(...arguments),this.start=new Date}next(t){this.sink.next({value:t,interval:Number(new Date)-Number(this.start)}),this.start=new Date}},ZR=q(Va,"timeInterval"),wa=class extends X{constructor(t,e){super(t),this.miniseconds=e,this.buffer=[],this.id=setInterval(()=>{this.sink.next(this.buffer.concat()),this.buffer.length=0},this.miniseconds)}next(t){this.buffer.push(t)}complete(){this.sink.next(this.buffer),super.complete()}dispose(){clearInterval(this.id),super.dispose()}},eA=q(wa,"bufferTime"),Ba=class extends X{constructor(t,e){super(t),this.buffer=[],this.delayTime=e}dispose(){clearTimeout(this.timeoutId),super.dispose()}delay(t){this.timeoutId=setTimeout(()=>{let e=this.buffer.shift();if(e){let{time:r,data:n}=e;super.next(n),this.buffer.length&&this.delay(Number(this.buffer[0].time)-Number(r))}},t)}next(t){this.buffer.length||this.delay(this.delayTime),this.buffer.push({time:new Date,data:t})}complete(){this.timeoutId=setTimeout(()=>super.complete(),this.delayTime)}},tA=q(Ba,"delay"),$a=class extends X{constructor(t,e){super(t),this.selector=e}error(t){this.dispose(),this.selector(t)(this.sink)}},iA=q($a,"catchError");var uA=h(_());var Ha=class extends X{constructor(t,e){super(t),e instanceof Function?this.next=r=>{e(r),t.next(r)}:(e.next&&(this.next=r=>{e.next(r),t.next(r)}),e.complete&&(this.complete=()=>{e.complete(),t.complete()}),e.error&&(this.error=r=>{e.error(r),t.error(r)}))}},aA=q(Ha,"tap"),Fa=class extends X{constructor(t,e){super(t),this.timeout=e,this.id=setTimeout(()=>this.error(new us(this.timeout)),this.timeout)}next(t){super.next(t),clearTimeout(this.id),this.next=super.next}dispose(){clearTimeout(this.id),super.dispose()}},cA=q(Fa,"timeout");var NA=yu(Nu(250),Du(()=>performance.now()),ls());var wA=h(_(),1);var Ji=new Map;C.on(S.JOIN_SUCCESS,({room:i})=>{Ce(i.userId,{eventId:32788,eventDesc:"join room"})});C.on(S.LEAVE_START,({room:i})=>{Ce(i.userId,{eventId:32789,eventDesc:"leave room"})});C.on(S.LOCAL_TRACK_PUBLISHED,({track:i})=>{i.room&&Ce(i.room.userId,{eventId:i.kind===f.AUDIO?32769:32768,eventDesc:`publish ${i.kind}`})});C.on(S.LOCAL_TRACK_UNPUBLISHED,({track:i})=>{i.room&&Ce(i.room.userId,{eventId:i.kind===f.AUDIO?32771:32770,eventDesc:`unpublish ${i.kind}`})});C.on(S.TRACK_MUTED,({track:i})=>{i.room&&(i.kind===f.AUDIO?Ce(i.room.userId,{eventId:i.isRemote?32785:32772,eventDesc:"mute audio",remoteUserId:i.isRemote?i.userId:void 0}):Ce(i.room.userId,{eventId:i.isRemote?32784:32773,eventDesc:"mute video",remoteUserId:i.isRemote?i.userId:void 0}))});C.on(S.TRACK_UNMUTED,({track:i})=>{i.room&&(i.kind===f.AUDIO?Ce(i.room.userId,{eventId:i.isRemote?32787:32774,eventDesc:"unmute audio",remoteUserId:i.isRemote?i.userId:void 0}):Ce(i.room.userId,{eventId:i.isRemote?32786:32775,eventDesc:"unmute video",remoteUserId:i.isRemote?i.userId:void 0}))});C.on(S.REMOTE_TRACK_SUBSCRIBED,({track:i})=>{i.mediaType===1&&Ce(i.room.userId,{eventId:32777,eventDesc:`${f.SUBSCRIBE} ${i.kind}`,remoteUserId:i.userId}),i.mediaType===4&&Ce(i.room.userId,{eventId:32776,eventDesc:`${f.SUBSCRIBE} ${i.kind}`,remoteUserId:i.userId}),i.mediaType===8&&Ce(i.room.userId,{eventId:32803,eventDesc:`${f.SUBSCRIBE} ${f.SMALL_VIDEO}`,remoteUserId:i.userId})});C.on(S.REMOTE_TRACK_UNSUBSCRIBED,({track:i})=>{i.mediaType===1&&Ce(i.room.userId,{eventId:32779,eventDesc:`${f.UNSUBSCRIBE} ${i.kind}`,remoteUserId:i.userId}),i.mediaType===4&&Ce(i.room.userId,{eventId:32778,eventDesc:`${f.UNSUBSCRIBE} ${i.kind}`,remoteUserId:i.userId}),i.mediaType===8&&Ce(i.room.userId,{eventId:32804,eventDesc:`${f.UNSUBSCRIBE} ${f.SMALL_VIDEO}`,remoteUserId:i.userId})});C.on(S.SWITCH_DEVICE_SUCCESS,({track:i})=>{i.room&&Ce(i.room.userId,{eventId:i.kind===f.VIDEO?32780:32781,eventDesc:`switch ${i.kind===f.VIDEO?"camera":"microphone"}`})});C.on(S.LOCAL_TRACK_REPLACED,({track:i})=>{i.room&&Ce(i.room.userId,{eventId:i.kind===f.VIDEO?32782:32783,eventDesc:`replace ${i.kind}`})});C.on(S.SIGNAL_CONNECTION_STATE_CHANGED,({room:i,prevState:t,state:e})=>{let r,n;switch(e){case"CONNECTED":t==="RECONNECTING"?(r=32795,n="signal reconnected"):(r=32791,n="signal connected");break;case"DISCONNECTED":t==="RECONNECTING"?(r=32796,n="signal reconnect fail"):(r=32790,n="signal disconnected");break;case"RECONNECTING":r=32794,n="signal reconnecting";break}r&&n&&Ce(i.userId,{eventId:r,eventDesc:n})});C.on(S.PEER_CONNECTION_STATE_CHANGED,({room:i,prevState:t,state:e,remoteUserId:r})=>{let n=!!r,s=n?"downlink":"uplink",o,a;switch(e){case"CONNECTED":t==="RECONNECTING"?(o=n?32801:32798,a=`${s} reconnected`):(o=n?32793:32792,a=`${s} connected`);break;case"DISCONNECTED":t==="RECONNECTING"&&(o=n?32802:32799,a=`${s} reconnect fail`);break;case"RECONNECTING":o=n?32800:32797,a=`${s} reconnecting`;break}o&&a&&Ce(i.userId,{eventId:o,eventDesc:a,remoteUserId:r})});function Ce(i,t){let e=ie(w({},t),{timestamp:Er()});Ji.has(i)?Ji.get(i).push(e):Ji.set(i,[e])}function Ou(i){if(Ji.has(i)){let t=Ji.get(i).map(e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc}));return Ji.delete(i),t}return[]}var YA=h(_(),1);var rC=h(_(),1);var bu=h(ft(),1);var Ss=class extends bu.EventEmitter{constructor(e,r,n="userId"){super();this.mySelfId=e;this._log=r;this.key=n;p(this,"userMap",new Map);p(this,"remotePublishedUserMap",new Map)}getPublishedUser(e){return this.remotePublishedUserMap.get(e)}addUser(e){let r=e[this.key],{userId:n,tinyId:s,role:o}=e;if(this.userMap.has(r))return;let a={userId:n,tinyId:s,role:o===20?"anchor":"audience"};this.userMap.set(r,a),this.emit("1",a)}deleteUser(e,r){let n=this.userMap.get(e);if(!n)return;let s=`peer leave [${e}]`;y(r)||(s+=`:${_d[r]}`),this._log.info(s);let o=this.remotePublishedUserMap.get(e);if(o){let a=o.muteState;o.flag=0,this.emit("5",o.userId),this.deleteRemotePublishedUser(e),this.emit("6",{prevMuteState:a,muteState:o.muteState,flag:0})}this.userMap.delete(e),this.emit("2",n.userId)}setUserList(e){this.userMap.forEach(r=>{e.findIndex(n=>n[this.key]===r[this.key])<0&&this.deleteUser(r[this.key],0)}),e.forEach(r=>{!this.userMap.has(r[this.key])&&r[this.key]!==this.mySelfId&&this.addUser(r)})}addRemotePublishedUser(e){this.remotePublishedUserMap.has(e[this.key])||this.remotePublishedUserMap.set(e[this.key],e)}deleteRemotePublishedUser(e){!this.remotePublishedUserMap.has(e)||this.remotePublishedUserMap.delete(e)}setRemotePublishedUserList(e){this.remotePublishedUserMap.forEach(r=>{let n=r[this.key];if(e.findIndex(s=>s[this.key]===r[this.key])<0){this._log.info(`remote [${n}] unpublish`);let s=r.muteState;r.flag=0,this.emit("5",r.userId),this.deleteRemotePublishedUser(n),this.emit("6",{prevMuteState:s,muteState:r.muteState,flag:0})}}),e.forEach(r=>{var u;let n=r[this.key];if(n===this.mySelfId)return;let{flag:s,userId:o,tinyId:a}=r,c=Vi(s,o),d=(u=this.remotePublishedUserMap.get(n))==null?void 0:u.muteState;if(d){let l=this.remotePublishedUserMap.get(n);l&&l.flag!==s&&(l.flag=s,this._log.info(`remote publish updated: ${JSON.stringify(l.muteState)}`),this.emit("6",{prevMuteState:d,muteState:c,flag:s}))}else this._log.info(`remote publish. state: ${JSON.stringify(c)}`),this.addUser({userId:o,tinyId:a,role:20}),this.emit("3",r),this.emit("6",{prevMuteState:Vi(0,o),muteState:c,flag:s})})}clear(){this.userMap.clear(),this.remotePublishedUserMap.clear()}};var BC=h(_());var Xr={SCENE_LIVE:"live",SCENE_RTC:"rtc",ROLE_ANCHOR:"anchor",ROLE_AUDIENCE:"audience",STREAM_TYPE_MAIN:"main",STREAM_TYPE_SUB:"sub",AUDIO_PROFILE_STANDARD:"standard",AUDIO_PROFILE_STANDARD_STEREO:"standard-stereo",AUDIO_PROFILE_HIGH:"high",AUDIO_PROFILE_HIGH_STEREO:"high-stereo",QOS_PREFERENCE_SMOOTH:"smooth",QOS_PREFERENCE_CLEAR:"clear"};var dv=h(_());var FC=h(_(),1);var Pe=class extends Error{};function Hh(i,t){let e=[];return ht(e,i),ht(e,t),e}function Fh(i){this._resolve=Promise.resolve(i)}function Gh(i){this._reject=Promise.reject(i)}var Xi=class{constructor(t,e){this.instance=t;this.group=e;this.started=!1;this.ops=[];this.startSame=()=>!0;this.mergeUpdate=Hh;let r=Xi.instances.get(t);r?r.set(e,this):Xi.instances.set(t,new Map([[e,this]]))}static get(t,e){let r=Xi.instances.get(t);return r&&r.get(e)||new Xi(t,e)}action(t,e,r){let n=a=>{var c;return t===0?this.started=!0:t===3&&(this.started=!1),this.ops.shift(),(c=this.currentOp)==null||c.action(),a},s=a=>{var d;let c=t===0;throw this.ops.shift(),c&&this.currentOp&&(this.currentOp.reject(new Pe("start failed")),this.ops.shift()),(d=this.currentOp)==null||d.action(),a},o={type:t,action:()=>e(...o.args).then(n,s),args:r,resolve:Fh,reject:Gh};try{switch(this.state){case 1:if(t===0)throw new Pe("already started");break;case 4:if(t===2)throw new Pe("not started");break;default:return this.cacheOp(o)}}catch(a){return Promise.reject(a)}return this.ops.push(o),o.promise=e(...o.args).then(n,s)}cacheOp(t){if(this.ops.length===1)switch(this.state){case 0:case 2:if(t.type===0)throw new Pe("already start");break;case 3:switch(t.type){case 2:throw new Pe("update not allowed when stopping");case 3:return this.currentOp.promise}break;default:throw new Pe("unknown state")}else switch(t.type){case 3:switch(this.lastOpType){case 3:return this.lastOp.promise;default:let r=new Pe("keep stop");if(this.ops.slice(1).forEach(n=>n.reject(r)),this.ops=this.ops.slice(0,1),this.state===3)return this.currentOp.promise}break;case 2:switch(this.lastOpType){case 2:return this.lastOp.args=this.mergeUpdate(this.lastOp.args,t.args),this.lastOp.promise;case 3:throw new Pe("update not allowed after stop")}break;case 0:switch(this.lastOpType){case 2:throw new Pe("start not allowed after update");case 0:throw new Pe("duplicate start");case 3:if(this.startSame(this.currentOp.args,t.args))throw this.ops.pop().reject(new Pe("keep start")),new Pe("already start")}}t.promise=new Promise((r,n)=>{t._resolve?t._resolve.then(r):t.resolve=r,t._reject?t._reject.catch(n):t.reject=n});let{action:e}=t;return t.action=()=>e().then(t.resolve,t.reject),this.ops.push(t),t.promise}get lastOp(){return this.ops[this.ops.length-1]}get lastOpType(){return this.lastOp.type}get currentOp(){return this.ops[0]}get state(){return this.currentOp?this.currentOp.type:this.started?1:4}},Si=Xi;Si.instances=new WeakMap;var ev=h(_());var WC=h(_()),te={INVALID_PARAMETER:5e3,INVALID_OPERATION:5100,ENV_NOT_SUPPORTED:5200,DEVICE_ERROR:5300,SERVER_ERROR:5400,OPERATION_FAILED:5500,OPERATION_ABORT:5998,UNKNOWN_ERROR:5999},ei=(D=>(D[D.INVALID_PARAMETER=5e3]="INVALID_PARAMETER",D[D.INVALID_PARAMETER_REQUIRED=5001]="INVALID_PARAMETER_REQUIRED",D[D.INVALID_PARAMETER_TYPE=5002]="INVALID_PARAMETER_TYPE",D[D.INVALID_PARAMETER_EMPTY=5003]="INVALID_PARAMETER_EMPTY",D[D.INVALID_PARAMETER_INSTANCE=5004]="INVALID_PARAMETER_INSTANCE",D[D.INVALID_PARAMETER_RANGE=5005]="INVALID_PARAMETER_RANGE",D[D.INVALID_PARAMETER_LESS_THAN_ZERO=5006]="INVALID_PARAMETER_LESS_THAN_ZERO",D[D.INVALID_PARAMETER_MIN=5007]="INVALID_PARAMETER_MIN",D[D.INVALID_PARAMETER_MAX=5008]="INVALID_PARAMETER_MAX",D[D.INVALID_ELEMENT_ID=5009]="INVALID_ELEMENT_ID",D[D.INVALID_ELEMENT_ID_TYPE=5010]="INVALID_ELEMENT_ID_TYPE",D[D.INVALID_STREAM_ID=5011]="INVALID_STREAM_ID",D[D.INVALID_ROOM_ID_STRING=5012]="INVALID_ROOM_ID_STRING",D[D.INVALID_ROOM_ID_INTEGER=5013]="INVALID_ROOM_ID_INTEGER",D[D.INVALID_STREAM_TYPE=5014]="INVALID_STREAM_TYPE",D[D.MIX_PARAMS_USER_Z_ORDER=5015]="MIX_PARAMS_USER_Z_ORDER",D[D.MIX_PARAMS_VIDEO_FRAMERATE=5016]="MIX_PARAMS_VIDEO_FRAMERATE",D[D.MIX_PARAMS_VIDEO_GOP=5017]="MIX_PARAMS_VIDEO_GOP",D[D.MIX_PARAMS_AUDIO_BITRATE=5018]="MIX_PARAMS_AUDIO_BITRATE",D[D.MIX_PARAMS_NOT_SELF=5019]="MIX_PARAMS_NOT_SELF",D[D.MIX_PARAMS_USER_STREAM=5020]="MIX_PARAMS_USER_STREAM",D[D.INVALID_OPERATION=5100]="INVALID_OPERATION",D[D.INVALID_OPERATION_NOT_JOINED=5101]="INVALID_OPERATION_NOT_JOINED",D[D.INVALID_OPERATION_REMOTE_USER_NOT_EXIST=5102]="INVALID_OPERATION_REMOTE_USER_NOT_EXIST",D[D.INVALID_OPERATION_STREAM_TYPE_NOT_EXIST=5103]="INVALID_OPERATION_STREAM_TYPE_NOT_EXIST",D[D.INVALID_OPERATION_REPEAT_CALL=5104]="INVALID_OPERATION_REPEAT_CALL",D[D.ENV_NOT_SUPPORTED=5200]="ENV_NOT_SUPPORTED",D[D.NOT_SUPPORTED_HTTP=5201]="NOT_SUPPORTED_HTTP",D[D.NOT_SUPPORTED_WEBRTC=5202]="NOT_SUPPORTED_WEBRTC",D[D.NOT_SUPPORTED_H264_ENCODE=5203]="NOT_SUPPORTED_H264_ENCODE",D[D.NOT_SUPPORTED_H264_DECODE=5204]="NOT_SUPPORTED_H264_DECODE",D[D.NOT_SUPPORTED_SCREEN_SHARE=5205]="NOT_SUPPORTED_SCREEN_SHARE",D[D.NOT_SUPPORTED_SMALL_VIDEO=5206]="NOT_SUPPORTED_SMALL_VIDEO",D[D.NOT_SUPPORTED_SEI=5207]="NOT_SUPPORTED_SEI",D[D.DEVICE_ERROR=5300]="DEVICE_ERROR",D[D.DEVICE_NOT_FOUND_ERROR=5301]="DEVICE_NOT_FOUND_ERROR",D[D.DEVICE_NOT_ALLOWED_ERROR=5302]="DEVICE_NOT_ALLOWED_ERROR",D[D.DEVICE_NOT_READABLE_ERROR=5303]="DEVICE_NOT_READABLE_ERROR",D[D.DEVICE_OVERCONSTRAINED_ERROR=5304]="DEVICE_OVERCONSTRAINED_ERROR",D[D.DEVICE_INVALID_STATE_ERROR=5305]="DEVICE_INVALID_STATE_ERROR",D[D.DEVICE_SECURITY_ERROR=5306]="DEVICE_SECURITY_ERROR",D[D.DEVICE_ABORT_ERROR=5307]="DEVICE_ABORT_ERROR",D[D.CAMERA_RECOVER_FAILED=5308]="CAMERA_RECOVER_FAILED",D[D.MICROPHONE_RECOVER_FAILED=5309]="MICROPHONE_RECOVER_FAILED",D[D.SERVER_ERROR=5400]="SERVER_ERROR",D[D.ACCOUNT_NO_MONEY=-100013]="ACCOUNT_NO_MONEY",D[D.OPERATION_FAILED=5500]="OPERATION_FAILED",D[D.FIREWALL_RESTRICTION=5501]="FIREWALL_RESTRICTION",D[D.REJOIN_FAILED=5502]="REJOIN_FAILED",D[D.EVENT_HANDLER_ERROR=5503]="EVENT_HANDLER_ERROR",D[D.OPERATION_ABORT=5998]="OPERATION_ABORT",D[D.UNKNOWN_ERROR=5999]="UNKNOWN_ERROR",D))(ei||{});var YC=h(_());function Mu({code:i,params:t,enableDocLink:e=!1}){let r="",n,s=ei[i];try{n=Pu[s]}catch(o){n=Pu.UNKNOWN_ERROR}return oe(n)?r=n(t):re(n)&&(r=n),e&&(r+=" doc:"),r}var Pu={INVALID_PARAMETER({fnName:i}){return`the parameters of the '${i}' you called does not meet the requirements, please check the API documentation.`},INVALID_PARAMETER_REQUIRED({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' is a required param when calling ${e}(), received: ${r}.`},INVALID_PARAMETER_TYPE({key:i,rule:t,fnName:e,value:r}){let n=`${i||t.name}`,s="";return Array.isArray(t.type)?s=t.type.join("|"):s=t.type,`'${n}' must be type of ${s} when calling ${e}(), received type: ${_e(r)}.`},INVALID_PARAMETER_EMPTY({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' cannot be '${r}' when calling ${e}().`},INVALID_PARAMETER_INSTANCE({key:i,rule:t,fnName:e,value:r}){let n=`${i||t.name}`,s=`${t.instanceOf.name||t.instanceOf}`;return`'${n}' must be instanceof ${s} when calling ${e}(), received type: ${_e(r)}.`},INVALID_PARAMETER_RANGE({key:i,rule:t,fnName:e,value:r}){return`'${i||t.name}' must be one of ${t.values.join("|")} when calling ${e}(), received: ${r}.`},INVALID_PARAMETER_LESS_THAN_ZERO({key:i,rule:t,fnName:e}){return`'${i||t.name}' cannot be less than 0 when calling ${e}().`},INVALID_PARAMETER_MIN({key:i,rule:t,value:e}){return`the min value of ${i||t.name} is ${t.min}, received: ${e}.`},INVALID_PARAMETER_MAX({key:i,rule:t,value:e}){return`the max value of ${i||t.name} is ${t.max}, received: ${e}.`},INVALID_ELEMENT_ID({key:i,fnName:t}){return`'${i}' is not found in the document object when calling ${t}().`},INVALID_ELEMENT_ID_TYPE({key:i,fnName:t,type:e}){return`the element corresponding to '${i}' must be instanceof HTMLElement when calling ${t}(), received: ${e}.`},INVALID_STREAM_ID({key:i}){return`'${i}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},INVALID_ROOM_ID_STRING({key:i}){return`'${i}' must be validate string when useStringRoomId is true.`},INVALID_ROOM_ID_INTEGER({key:i}){return`'${i}' must be an integer between [1, 4294967294] when useStringRoomId is false.`},INVALID_STREAM_TYPE:({fnName:i})=>`'streamType' is required when 'userId' is not '*', calling ${i}()`,MIX_PARAMS_USER_Z_ORDER({key:i}){return`'${i}' is required and must be between 1 and 15.`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_OPERATION({fnName:i}){return`the API '${i}' you called does not meet the requirements, please check the API documentation.`},INVALID_OPERATION_NOT_JOINED({fnName:i}){return`cannot ${i} because you are not enter room yet.`},INVALID_OPERATION_REMOTE_USER_NOT_EXIST({fnName:i,value:t}){return`cannot ${i} because remote user(userId: ${t.userId}) does not publishing stream.`},INVALID_OPERATION_STREAM_TYPE_NOT_EXIST({fnName:i,value:t}){return`cannot ${i} because remote user(userId: ${t.userId}) does not publishing ${t.streamType} video.`},INVALID_OPERATION_REPEAT_CALL({fnName:i}){return`you are already ${i}(), cannot repeated call '${i}'.`},ENV_NOT_SUPPORTED({fnName:i}){return`the current browser does not support the capability of the function '${i}' you are calling, please check the API documentation.`},NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"the current browser does not support WebRTC capability, please check the SDK documentation.",NOT_SUPPORTED_H264_ENCODE:"this browser does not support H264 encode.",NOT_SUPPORTED_H264_DECODE:"this browser does not support H264 decode.",NOT_SUPPORTED_SCREEN_SHARE:"this browser does not support screen share, please check the browser version.",NOT_SUPPORTED_SMALL_VIDEO:"this browser does not support small video, please check the browser version.",NOT_SUPPORTED_SEI:"this browser does not support SEI, please check the browser version.",DEVICE_ERROR({fnName:i,error:t}){return`'${i}' got server exception${t?`, error: ${t.toString()}.`:"."}`},DEVICE_NOT_FOUND_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`NotFoundError, no ${t} detected, please check your device and the configuration on '${i}'${e?`, error: ${e.toString()}.`:"."}`},DEVICE_NOT_ALLOWED_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`NotAllowedError, you have disabled ${t} access, please allow the current application to use the ${t}${e?`, error: ${e.toString()}.`:"."}`},DEVICE_NOT_READABLE_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`NotReadableError, the ${t} maybe in use by another APP, please check if the device is pre-occupied by another APP.`},DEVICE_OVERCONSTRAINED_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`OverconstrainedError, the device ID is incorrect, please check whether the device ID passed in is correct${e?`, error: ${e.toString()}.`:"."}`},DEVICE_INVALID_STATE_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`InvalidStateError, after the user clicks and interacts with the page, turn on the ${t}${e?`, error: ${e.toString()}.`:"."}`},DEVICE_SECURITY_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`SecurityError, check whether the system security policy restricts the use of the ${t}, and it is recommended to turn on the ${t} after the user interacts with the page${e?`, error: ${e.toString()}.`:"."}`},DEVICE_ABORT_ERROR({fnName:i,deviceType:t=Ii(i),error:e}){return`AbortError, an unknown exception in the system makes the device unusable, recommended to change the device or browser and re-check whether the device is normal${e?` error: ${e.toString()}.`:"."}`},CAMERA_RECOVER_FAILED({error:i}){return`camera recover capture failed ${(i==null?void 0:i.name)||""}: ${(i==null?void 0:i.originMessage)||(i==null?void 0:i.message)}`},MICROPHONE_RECOVER_FAILED({error:i}){return`microphone recover capture failed ${(i==null?void 0:i.name)||""}: ${(i==null?void 0:i.originMessage)||(i==null?void 0:i.message)}`},OPERATION_FAILED({fnName:i,error:t}){return`\u2018${i}\u2019 failed, reason: ${t==null?void 0:t.toString()}`},FIREWALL_RESTRICTION(){return"media connection failure due to firewall restrictions, please try to change your network."},EVENT_HANDLER_ERROR({eventName:i}){return`an error was caught on trtc.on('${i}', handler), please check your code on 'handler'.`},SERVER_ERROR({fnName:i,error:t}){return`'${i}' got server error: ${t==null?void 0:t.toString()}, please check the SDK documentation.`},ACCOUNT_NO_MONEY:({fnParams:i})=>`your TRTC account run out of credit, please recharge.${i.sdkAppId?` SDKAppId: ${i.sdkAppId}`:""}`,OPERATION_ABORT({fnName:i}){return`'${i}' abort`},UNKNOWN_ERROR({fnName:i,error:t}){return`'${i}' throw unknown exception${t?`, error: ${t.toString()}.`:"."}`}};function Ii(i){if(!i)return"camera";let t=i.toLowerCase();return t.includes("screen")?"screen share":t.includes("audio")?"microphone":"camera"}var Yi=class extends Error{constructor({code:e,extraCode:r,message:n="",messageParams:s,fnName:o="",originError:a}){let c;n?c=n:c=Mu({code:r||e,params:w({fnName:o,error:a},s)});super(c);p(this,"name","RtcError");p(this,"code");p(this,"extraCode");p(this,"functionName");p(this,"message");p(this,"originError");this.name=ei[e],this.code=e,this.extraCode=r,this.functionName=o,this.originError=a,this.message=c}static convertFrom(e,r,n){let s=e;if(e instanceof V){let{stack:o}=e,a={code:te.UNKNOWN_ERROR,fnName:r,originError:e};switch(e.getCode()){case b.INVALID_PARAMETER:a.code=te.INVALID_PARAMETER;break;case b.INVALID_OPERATION:a.code=te.INVALID_OPERATION;break;case b.NOT_SUPPORTED:case b.NOT_SUPPORTED_H264:a.code=te.ENV_NOT_SUPPORTED,e.getCode()===b.NOT_SUPPORTED_H264&&(a.extraCode=e.message.includes(He.NOT_SUPPORTED_H264ENCODE)?5203:5204);break;case b.DEVICE_NOT_FOUND:case b.DEVICE_AUTO_RECOVER_FAILED:a.code=te.DEVICE_ERROR;break;case b.JOIN_ROOM_FAILED:a.messageParams={fnParams:n};case b.SERVER_TIMEOUT:case b.SWITCH_ROLE_FAILED:a.code=te.SERVER_ERROR,a.extraCode=e.getExtraCode();break;case b.API_CALL_ABORTED:a.code=te.OPERATION_ABORT;break;case b.INITIALIZE_FAILED:a.code=5300,a.extraCode=Wh(e.name);break;case b.UNKNOWN:break;default:a.code=te.OPERATION_FAILED}s=new Yi(a),o&&(s.stack+=o.substr(o.indexOf(`
`)))}else s=new Yi({code:te.UNKNOWN_ERROR,fnName:r,originError:e});return s}};function Wh(i){let t;switch(i){case"NotFoundError":t=5301;break;case"NotAllowedError":t=5302;break;case"NotReadableError":t=5303;break;case"OverconstrainedError":t=5304;break;case"InvalidStateError":t=5305;break;case"SecurityError":t=5306;break;case"AbortError":t=5307;break;default:t=5300}return t}var z=Yi;var Ga=(i,t)=>{if(t instanceof Pe){let{stack:e}=t;t=new z({code:te.OPERATION_ABORT,message:`${i} abort: ${t.message}`,fnName:i}),e&&(t.stack+=e.substr(e.indexOf(`
`)))}throw t};function gi(i,t){return ce((e,r)=>function(...n){let s=Si.get(this,typeof i=="string"?i:i(...n));return t&&(s.startSame=t.bind(this)),s.action(0,e.bind(this),n).catch(Ga.bind(null,r))})}function qi(i,t){return ce((e,r)=>function(...n){let s=Si.get(this,typeof i=="string"?i:i(...n));return t&&(s.mergeUpdate=t.bind(this)),s.action(2,e.bind(this),n).catch(Ga.bind(null,r))})}function Ri(i,t=!1){return ce((e,r)=>function(...n){let s=Si.get(this,typeof i=="string"?i:i(...n));return s.abortStart=t,s.action(3,e.bind(this),n).catch(Ga.bind(null,r))})}var Iv=h(_());var Lu={type:O.Object,properties:{cameraId:{type:O.String},useFrontCamera:{type:O.Boolean},fillMode:{type:O.String,values:["contain","cover","fill"]},mirror:{type:O.Boolean},small:{properties:{width:{type:O.Number},height:{type:O.Number},frameRate:{type:O.Number},bitrate:{type:O.Number}}},videoTrack:{instanceOf:MediaStreamTrack}}},ku={type:O.Object,properties:{systemAudio:{type:O.Boolean},fillMode:{type:O.String,values:["contain","cover","fill"]},profile:{type:[O.String,O.Object],properties:{width:{type:O.Number},height:{type:O.Number},frameRate:{type:O.Number},bitrate:{type:O.Number}}},videoTrack:{instanceOf:MediaStreamTrack},audioTrack:{instanceOf:MediaStreamTrack}}},zi={type:[O.String,HTMLElement,null,O.Array],arrayItem:{instanceOf:HTMLElement},validate(i,t,e){if(re(i)){let r=document.getElementById(i);if(!r)throw new z({code:te.INVALID_PARAMETER,extraCode:5009,fnName:e,messageParams:{key:t}});if(!(r instanceof HTMLElement))throw new z({code:te.INVALID_PARAMETER,extraCode:5010,fnName:e,messageParams:{key:t,type:_e(r)}})}}},xu={name:"userId",required:!0,type:O.String},Uu={type:O.Object,properties:{microphoneId:{type:O.String},audioTrack:{instanceOf:MediaStreamTrack},captureVolume:{type:O.Number,min:0,max:100},earMonitorVolume:{type:O.Number,min:0,max:100},echoCancellation:{type:O.Boolean},autoGainControl:{type:O.Boolean},noiseSuppression:{type:O.Boolean}}};function Vu(i,t,e,r){if(!/^[A-Za-z\d_-]*$/.test(i))throw new z({code:te.INVALID_PARAMETER,extraCode:5011,fnName:e,messageParams:{key:t}})}function wu(i,t,e,r){if(re(i)){if(!/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(i))throw new z({code:te.INVALID_PARAMETER,extraCode:5012,fnName:e,messageParams:{key:t}})}else if(!(/^[1-9]\d*$/.test(String(i))&&i<4294967295))throw new z({code:te.INVALID_PARAMETER,extraCode:5013,fnName:e,messageParams:{key:t}})}function Wa(i,t){if(!i)throw new z({code:te.INVALID_OPERATION,extraCode:5101,fnName:t})}function Bu(i,t,e){if(!i)throw new z({code:te.INVALID_OPERATION,extraCode:5102,fnName:t,messageParams:{value:e}})}var ti={type:O.Number,notLessThanZero:!0},Kh={enterRoom:{name:"EnterRoomConfig",type:O.Object,required:!0,validate(i,t,e){if(this._room.isJoined)throw new z({code:te.INVALID_OPERATION,extraCode:5104,fnName:e})},properties:{sdkAppId:{required:!0,type:O.Number,allowEmpty:!1},userId:{required:!0,type:O.String,allowEmpty:!1},userSig:{required:!0,type:O.String,allowEmpty:!1},scene:{type:O.String,values:["live","rtc"]},role:{type:O.String,values:["audience","anchor"]},roomId:{required:!0,type:[O.String,O.Number],validate:wu},proxy:{type:[O.Object,O.String],properties:{websocketProxy:{type:O.String},turnServer:{type:[O.Object,O.Array],properties:{url:{required:!0,type:O.String},username:{type:O.String},credential:{type:O.String},credentialType:{type:O.String,values:["password"]}}},loggerProxy:{type:O.String},webtransportProxy:{type:O.String}}},enableAutoPlayDialog:{type:O.Boolean},streamId:{type:O.String},userDefineRecordId:{type:O.String}}},startLocalVideo:{name:"LocalVideoConfig",type:O.Object,properties:{view:zi,publish:{type:O.Boolean},option:Lu}},updateLocalVideo:{name:"updateLocalVideoConfig",type:O.Object,required:!0,properties:{view:ie(w({},zi),{required:!1}),publish:{type:O.Boolean},mute:{type:O.Boolean},option:Lu}},startLocalAudio:{name:"LocalAudioConfig",type:O.Object,properties:{publish:{type:O.Boolean},option:Uu}},updateLocalAudio:{name:"updateLocalAudioConfig",type:O.Object,required:!0,properties:{publish:{type:O.Boolean},mute:{type:O.Boolean},option:Uu}},startScreenShare:{name:"ScreenShareConfig",type:O.Object,properties:{view:zi,publish:{type:O.Boolean},option:ku}},updateScreenShare:{name:"updateScreenShareConfig",type:O.Object,required:!0,properties:{view:zi,publish:{type:O.Boolean},option:ku}},muteRemoteAudio:[xu,{name:"mute",required:!0,type:O.Boolean}],setRemoteAudioVolume:[xu,{name:"volume",required:!0,type:O.Number,min:0,max:100}],startRemoteVideo:{name:"startRemoteVideoConfig",type:O.Object,required:!0,properties:{view:zi,userId:{type:O.String,required:!0},streamType:{values:["main","sub"],required:!0},option:{type:O.Object,properties:{fillMode:{type:O.String,values:["contain","cover","fill"]},mirror:{type:O.Boolean}}}},validate(i,t,e){Wa(this._room.isJoined,e);let r=this._room.remotePublishedUserMap.get(i.userId);if(Bu(!!r,e,i),r&&(i.streamType==="main"&&!r.muteState.videoAvailable||i.streamType==="sub"&&!r.muteState.hasAuxiliary))throw new z({code:te.INVALID_OPERATION,extraCode:5103,fnName:e,messageParams:{value:i}})}},updateRemoteVideo:{name:"updateRemoteVideoConfig",type:O.Object,required:!0,properties:{view:ie(w({},zi),{required:!1}),userId:{type:O.String,required:!0},streamType:{values:["main","sub"],required:!0},option:{type:O.Object,properties:{fillMode:{type:O.String,values:["contain","cover","fill"]},mirror:{type:O.Boolean}}}},validate(i,t,e){Wa(this._room.isJoined,e);let r=this._room.remotePublishedUserMap.get(i.userId);if(Bu(!!r,e,i),r&&(i.streamType==="main"&&!r.muteState.videoAvailable||i.streamType==="sub"&&!r.muteState.hasAuxiliary))throw new z({code:te.INVALID_OPERATION,extraCode:5103,fnName:e,messageParams:{value:i}})}},stopRemoteVideo:{name:"stopRemoteVideoConfig",type:O.Object,required:!0,properties:{userId:{type:O.String,required:!0},streamType:{values:["main","sub"]}},validate(i,t,e){if(i.userId!=="*"&&y(i.streamType))throw new z({code:te.INVALID_PARAMETER,extraCode:5014,fnName:e})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate(i,t,e){Wa(this._room.isJoined,e)}},enableAudioVolumeEvaluation:[{name:"interval",type:O.Number},{name:"enableInBackground",type:O.Boolean}],startMixTranscode:{name:"config",required:!0,type:O.Object,properties:{mode:{type:O.String,values:["preset-layout","manual"]},streamId:{type:O.String,validate:Vu},videoWidth:ti,videoHeight:ti,videoBitrate:ie(w({},ti),{allowEmpty:!1}),videoFramerate:{type:O.Number,validate(i,t,e,r){if(i<=0||i>30)throw new z({code:te.INVALID_PARAMETER,extraCode:5016,fnName:e})}},videoGop:{type:O.Number,validate(i,t,e,r){if(i<1||i>8)throw new z({code:te.INVALID_PARAMETER,extraCode:5017,fnName:e})}},audioSampleRate:ti,audioBitrate:{type:O.Number,validate(i,t,e,r){if(i<32||i>192)throw new z({code:te.INVALID_PARAMETER,extraCode:5018,fnName:e})}},audioChannels:{type:O.Number,values:[1,2]},backgroundColor:{type:O.Number},backgroundImage:{type:O.String},mixUsers:{required:!0,type:O.Array,arrayItem:{require:!0,type:O.Object,properties:{userId:{required:!0,type:O.String},roomId:{type:[O.String,O.Number],validate:wu},pureAudio:{type:O.Boolean},width:ti,height:ti,locationX:ti,locationY:ti,zOrder:{type:O.Number},streamType:{values:["main","sub"]},renderMode:{type:O.Number,values:[0,1,2,4]}}}}},validate(i,t,e,r){let n=0,s=0,{mixUsers:o}=i,a=[];if(o.forEach((c,d)=>{if(a.push(c.userId),!c.pureAudio){if(!c.zOrder||c.zOrder<1||c>15)throw new z({code:te.INVALID_PARAMETER,extraCode:5015,fnName:e,messageParams:{key:`config.mixUsers[${d}].zOrder`}});c.width+c.locationX>n&&(n=c.width+c.locationX),c.height+c.locationY>s&&(s=c.height+c.locationY)}}),a.indexOf(this._room.userId)<0)throw new z({code:te.INVALID_PARAMETER,extraCode:5019,fnName:e});if(i.videoWidth<n||i.videoHeight<s)throw new z({code:te.INVALID_PARAMETER,extraCode:5020,fnName:e})}},startPublishCDNStream:{name:"options",required:!1,properties:{streamId:{type:O.String,validate:Vu},streamType:{values:["main","sub"]},appId:{type:O.Number,allowEmpty:!1},bizId:{type:O.Number,allowEmpty:!1},url:{type:O.String,allowEmpty:!1}}}},Me={TRTC:Kh};var vv=h(_());function Yr(i){return i==="sub"?"auxiliary":i==="auxiliary"?"sub":"main"}function qr(i){return i===Xr.QOS_PREFERENCE_CLEAR?"detail":i===Xr.QOS_PREFERENCE_SMOOTH?"motion":""}var Hu="5.0.1";var kv=h(_());function Fe(...i){return ce((t,e)=>function(...r){try{Fu.call(this,i,r,e,this._name)}catch(n){return Promise.reject(n)}return t.apply(this,r)})}function Ka(...i){return ce((t,e)=>function(...r){try{Fu.call(this,i,r,e,this._name)}catch(n){throw n}return t.apply(this,r)})}function Fu(i,t,e,r){if(ke(i))for(let n=0;n<i.length;n++)gs.call(this,{rule:i[n],value:t[n],key:i[n].name,fnName:e,className:r});else gs.call(this,{rule:i,value:t[0],key:i.name,fnName:e,className:r})}function gs({rule:i,value:t,key:e,fnName:r,className:n}){function s(c){return{code:te.INVALID_PARAMETER,extraCode:c,fnName:r,messageParams:{key:e,rule:i,value:t}}}if(y(t)){if(i.required)throw new z(s(5001));if(y(i.defaultValue))return;t=i.defaultValue}if(Array.isArray(i.type)){let c=!1;for(let d=0;d<i.type.length;d++)i.type[d]===null&&t===null&&(c=!0),oe(i.type[d])&&t instanceof i.type[d]&&(c=!0),re(i.type[d])&&_e(t)===i.type[d].toLowerCase()&&(c=!0);if(!c)throw new z({code:te.INVALID_PARAMETER,extraCode:5002,fnName:r,messageParams:{key:e,rule:{type:i.type.map(d=>Mr(d)?Wn(d):re(d)?d:_e(d))},value:t}})}else if(!y(i.type)&&_e(t)!==i.type)throw new z(s(5002));if(i.allowEmpty===!1){let c=de(t)&&(t===0||Number.isNaN(t)),d=re(t)&&t.trim()==="";if(c||d)throw new z(s(5003))}if(i.notLessThanZero&&de(t)&&t<0)throw new z(s(5006));if(!y(i.min)&&de(t)&&t<i.min)throw new z(s(5007));if(!y(i.max)&&de(t)&&t>i.max)throw new z(s(5008));if(re(i.instanceOf)){if(!t||t._name!==i.instanceOf)throw new z(s(5004))}else if(oe(i.instanceOf)&&!(t instanceof i.instanceOf))throw new z(s(5004));if(i.values&&!i.values.includes(t))throw new z(s(5005));let{properties:o}=i;Yt(o)&&pi(t)&&Object.keys(o).forEach(c=>{gs.call(this,{rule:o[c],value:t&&t[c],key:`${c}`,fnName:r,className:n})});let{arrayItem:a}=i;Yt(a)&&ke(t)&&t.forEach((c,d)=>{gs.call(this,{rule:a,value:c,key:`${e}[${d}]`,fnName:r,className:n})}),oe(i.validate)&&i.validate.call(this,t,e,r,n,this)}var Fv=h(_());function Re(){return ce((i,t)=>function(...e){let r=this._log||loggerManager;e.length>0?r.info(`${t}() ${JSON.stringify(e,(n,s)=>{if(s===e||n in e)return s;try{return s instanceof HTMLElement?`id: ${s.id} type:${_e(s)}`:(JSON.stringify(s),s)}catch(o){return`type:${_e(s)}`}})}`):r.info(`${t}()`);try{let n=i.apply(this,e),s=ee();return Gn(n)?n.then(o=>(r.info(`${t}() success`),C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:t,cost:ee()-s}),o)).catch(o=>{throw o=z.convertFrom.call(this,o,t,e.length===1?e[0]:e),r.error(`${t}() failed ${o}`),C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:t,error:o}),o}):(C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:t,cost:ee()-s}),n)}catch(n){throw n=z.convertFrom.call(this,n,t),r.error(`${t}() failed ${n}`),C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:t,error:n}),n}})}var jv=h(_(),1);var Rs=new WeakMap;function Gu(i,t){return ce((e,r)=>function(...n){var a,c;let s=(a=Rs.get(this))==null?void 0:a.get(t(...n));s&&s>0&&clearTimeout(s);let o=window.setTimeout(()=>{e.apply(this,n)},i);Rs.has(this)?(c=Rs.get(this))==null||c.set(t(...n),o):Rs.set(this,new Map([[t(...n),o]]))})}var Wu=0,ja=new Set,je=null;Zc(Hu);var zr=class extends ju.EventEmitter{constructor(e,r){super();p(this,"_room");p(this,"_eventListened",new Set);p(this,"_localVideoTrack",null);p(this,"_localAudioTrack",null);p(this,"_localScreenTrack",null);p(this,"_localScreenAudioTrack",null);p(this,"_localVideoConfig",null);p(this,"_localScreenConfig",null);p(this,"_localAudioConfig",null);p(this,"_remoteVideoConfigMap",new Map);p(this,"_remoteAudioConfigMap",new Map);p(this,"_remoteAudioMuteMap",new Map);p(this,"_log",M.createLogger({id:`t${Wu}`}));this._room=new e(w({logger:this._log,frameWorkType:zr.frameWorkType},r)),this._room.on("audio-volume",n=>{!n.find(s=>s.userId==="")&&this._localAudioTrack&&n.push({userId:"",volume:Math.floor(this._localAudioTrack.getAudioLevel()*100)}),this.emit(Y.AUDIO_VOLUME,{result:n.sort((s,o)=>o.volume-s.volume)})}),this.on(Y.REMOTE_AUDIO_UNAVAILABLE,({userId:n})=>{this._stopRemoteAudio({userId:n},!1).catch(()=>{})}),this.on(Y.REMOTE_VIDEO_UNAVAILABLE,({userId:n,streamType:s})=>{this._stopRemoteVideo({userId:n,streamType:s},!1).catch(()=>{})}),qe(fe,fe).add("audioInputAdded",n=>{this.emit(Y.DEVICE_CHANGED,{type:"microphone",action:"add",device:n})}).add("audioInputRemoved",n=>{this.emit(Y.DEVICE_CHANGED,{type:"microphone",action:"remove",device:n})}).add("videoInputAdded",n=>{this.emit(Y.DEVICE_CHANGED,{type:"camera",action:"add",device:n})}).add("videoInputRemoved",n=>{this.emit(Y.DEVICE_CHANGED,{type:"camera",action:"remove",device:n})}).add("audioOutputAdded",n=>T(this,null,function*(){if(this.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"add",device:n}),je&&je.deviceId===yn){let s=(yield Wi()).find(o=>o.deviceId===yn);s&&je.groupId!==s.groupId&&(je=s,this.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"active",device:s}))}})).add("audioOutputRemoved",n=>T(this,null,function*(){this.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"remove",device:n});let s=(yield Wi())[0];s&&je&&(je.deviceId===n.deviceId||je.deviceId===yn&&je.groupId!==s.groupId)&&(je=s,this.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"active",device:s}))})),bo(this,"trtc")}static create(){}static _create(e,r){Wu+=1,$d();let n=new zr(e,r);return ja.add(n),je?n.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"active",device:je}):Wi().then(s=>{s[0]&&(je=s[0],n.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"active",device:s[0]}))}),n}enterRoom(e){return T(this,null,function*(){var c,d;let{scene:r="rtc",enableAutoPlayDialog:n=!0,autoReceiveAudio:s=!0,autoReceiveVideo:o=!0}=e;e.proxy&&(this._room.setProxyServer(e.proxy),!re(e.proxy)&&e.proxy.turnServer&&((d=(c=this._room).setTurnServer)==null||d.call(c,e.proxy.turnServer,e.proxy.iceTransportPolicy))),this._room.enableAutoPlayDialog=n,this._room.autoReceiveAudio=s,this._room.autoReceiveVideo=o;let a={sdkAppId:e.sdkAppId,userId:e.userId,userSig:e.userSig,privateMapKey:e.privateMapKey||null,role:e.role==="audience"?21:20,roomId:0,strRoomId:"",businessInfo:e.businessInfo||null,streamId:e.streamId||null,userDefineRecordId:e.userDefineRecordId||null};re(e.roomId)?(a.strRoomId=e.roomId,this._room.useStringRoomId=!0):a.roomId=e.roomId,qe(this,this._room).add("peer-join",u=>{let{userId:l}=u;this.emit(Y.REMOTE_USER_ENTER,{userId:l})}).add("peer-leave",u=>{this.emit(Y.REMOTE_USER_EXIT,{userId:u})}).add("banned",u=>{this._exitRoom().then(()=>{this.emit(Y.KICKED_OUT,{reason:u.reason})})}).add("error",u=>{this._exitRoom().then(()=>{this.emit(Y.ERROR,z.convertFrom(u))})}).add("signal-connection-state-changed",u=>{this.emit(Y.CONNECTION_STATE_CHANGED,u)}).add("network-quality",u=>{this.emit(Y.NETWORK_QUALITY,u)}).add("remote-published",u=>{[u.remoteAudioTrack,u.remoteVideoTrack,u.remoteAuxiliaryTrack].forEach(m=>{qe(m,m).add("player-state-changed",I=>{let E=ie(w({},I),{userId:u.userId});m.kind===f.VIDEO&&(E.streamType=Yr(m.streamType)),this.emit(m.kind===f.AUDIO?Y.AUDIO_PLAY_STATE_CHANGED:Y.VIDEO_PLAY_STATE_CHANGED,E)}).add("error",I=>{I.getCode()===b.PLAY_NOT_ALLOWED&&this.emit(Y.AUTOPLAY_FAILED)})})}).add("remote-unpublished",u=>{[u.remoteAudioTrack,u.remoteVideoTrack,u.remoteAuxiliaryTrack].forEach(m=>{Ue(m)})}).add("remote-publish-state-changed",({prevMuteState:u,muteState:l})=>{let{userId:m}=l,I=this._room.remotePublishedUserMap.get(m),E=u.audioAvailable,N=u.videoAvailable,{audioAvailable:B,videoAvailable:x}=l;B||this._remoteAudioConfigMap.delete(m),x||this._remoteVideoConfigMap.delete(`${m}_${"main"}`),l.hasAuxiliary||this._remoteVideoConfigMap.delete(`${m}_${"sub"}`),E!==B&&this.emit(B?Y.REMOTE_AUDIO_AVAILABLE:Y.REMOTE_AUDIO_UNAVAILABLE,{userId:m}),N!==x&&this.emit(x?Y.REMOTE_VIDEO_AVAILABLE:Y.REMOTE_VIDEO_UNAVAILABLE,{userId:m,streamType:"main"}),u.hasAuxiliary!==l.hasAuxiliary&&this.emit(l.hasAuxiliary?Y.REMOTE_VIDEO_AVAILABLE:Y.REMOTE_VIDEO_UNAVAILABLE,{userId:m,streamType:"sub"})}).add("firewall-restriction",()=>{this.emit(Y.ERROR,new z({code:te.OPERATION_FAILED,extraCode:5501}))}),this._handleReceiveMode(),yield this._room.join(a,r,zr.frameWorkType),this._checkTrackToPublish()})}exitRoom(){return T(this,null,function*(){return yield this._exitRoom()})}switchRole(e){return T(this,null,function*(){yield this._room.switchRole(e),e==="anchor"&&this._checkTrackToPublish()})}destroy(){Ue(fe),this.removeAllListeners(),this._room.destroy(),ja.delete(this),this._localAudioTrack&&this.stopLocalAudio(),this._localVideoTrack&&this.stopLocalVideo(),this._localScreenTrack&&this.stopScreenShare()}startLocalAudio(){return T(this,arguments,function*(e={publish:!0}){if(this._localAudioTrack){this._log.warn("local audio is already started");return}let{publish:r=!0,option:n}=e,s=new Ut,o={},a={muted:!0};n&&(y(n.microphoneId)?y(n.audioTrack)||(o.customSource=n.audioTrack):o.deviceId=n.microphoneId,y(n.captureVolume),y(n.profile)||(re(n.profile)?to[n.profile]&&s.setProfile(to[n.profile]):s.setProfile(n.profile)),de(n.earMonitorVolume)&&(a.muted=!(n.earMonitorVolume>0),a.volume=n.earMonitorVolume),y(n.echoCancellation)||(s.profile.echoCancellation=n.echoCancellation),y(n.noiseSuppression)||(s.profile.noiseSuppression=n.noiseSuppression),y(n.autoGainControl)||(s.profile.autoGainControl=n.autoGainControl)),s.on("5",c=>{this.emit(Y.ERROR,new z({code:te.DEVICE_ERROR,extraCode:5309,messageParams:{error:c}}))}),s.on("2",c=>{this.emit(Y.DEVICE_CHANGED,{type:"microphone",action:"active",device:c})}),s.on("4",c=>{let d;c.error&&(d=z.convertFrom(c.error)),this.emit(Y.PUBLISH_STATE_CHANGED,ie(w({},c),{error:d}))}),yield s.capture(o),qe(s,s).add("player-state-changed",c=>{this.emit(Y.AUDIO_PLAY_STATE_CHANGED,ie(w({},c),{userId:""}))}),yield this._updateAudioPlayOption({playOption:a,track:s}),r&&this._room.isJoined&&this._room.publish(s).catch(()=>{}),this._localAudioTrack=s,this._localAudioConfig=ie(w({},e),{publish:r})})}updateLocalAudio(e){return T(this,null,function*(){if(!this._localAudioTrack||!this._localAudioConfig)return;let{publish:r,mute:n,option:s}=e,o={};s&&(s.microphoneId?yield this._localAudioTrack.switchDevice(s.microphoneId):y(s.audioTrack)||(this._localAudioTrack.setMediaStreamTrack(s.audioTrack),yield this._room.replaceTrack(this._localAudioTrack)),y(s.captureVolume),y(s.earMonitorVolume)||(o.muted=!(s.earMonitorVolume>0),o.volume=s.earMonitorVolume)),yield this._updateAudioPlayOption({playOption:o,track:this._localAudioTrack,prevConfig:this._localAudioConfig}),this._room.isJoined&&!y(r)&&(r&&!this._localAudioConfig.publish&&this._room.publish(this._localAudioTrack).catch(()=>{}),this._localAudioConfig.publish&&!r&&this._room.unpublish(this._localAudioTrack).catch(()=>{})),y(n)||this._localAudioTrack.setMute(n),ht(this._localAudioConfig,e)})}stopLocalAudio(){return T(this,null,function*(){!this._localAudioTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localAudioTrack).catch(()=>{})),this._localAudioTrack.stop(),this._localAudioTrack.close(),Ue(this._localAudioTrack),this._localAudioTrack=null,this._localAudioConfig=null)})}startLocalVideo(){return T(this,arguments,function*(e={publish:!0,view:null}){if(this._localVideoTrack){this._log.warn("local video is already started");return}let{view:r,publish:n=!0,option:s}=e,o=new it,a={},c={};if(s&&(s.cameraId?a.deviceId=s.cameraId:y(s.useFrontCamera)?y(s.videoTrack)||(a.customSource=s.videoTrack):a.facingMode=s.useFrontCamera?f.FACING_MODE_USER:f.FACING_MODE_ENVIRONMENT,y(s.profile)||(re(s.profile)?Li[s.profile]&&o.setProfile(Li[s.profile]):o.setProfile(s.profile)),y(s.fillMode)||(c.objectFit=s.fillMode),y(s.mirror)||(c.mirror=s.mirror),y(s.small)||(qn()?re(s.small)?o.small=Li[s.small]:o.small=s.small:this._log.warn("small stream is not supported"))),o.on("5",d=>{this.emit(Y.ERROR,new z({code:te.DEVICE_ERROR,extraCode:5308,messageParams:{error:d}}))}),o.on("2",d=>{this.emit(Y.DEVICE_CHANGED,{type:"camera",action:"active",device:d})}),o.on("4",d=>{let u;d.error&&(u=z.convertFrom(d.error)),this.emit(Y.PUBLISH_STATE_CHANGED,ie(w({},d),{error:u}))}),yield o.capture(a),(s==null?void 0:s.qosPreference)&&o.mediaTrack){let d=qr(s.qosPreference);o.mediaTrack.contentHint=d}qe(o,o).add("player-state-changed",d=>{this.emit(Y.VIDEO_PLAY_STATE_CHANGED,ie(w({},d),{userId:"",streamType:"main"}))}),yield this._updateVideoPlayOption({view:r,playOption:c,track:o}),n&&this._room.isJoined&&this._room.publish(o).catch(()=>{}),this._localVideoTrack=o,this._localVideoConfig=ie(w({},e),{view:r,publish:n})})}updateLocalVideo(e){return T(this,null,function*(){if(!this._localVideoTrack||!this._localVideoConfig)return;let{view:r,publish:n,mute:s,option:o}=e,a={};if(o&&(o.cameraId?yield this._localVideoTrack.switchDevice(o.cameraId):y(o.useFrontCamera)?y(o.videoTrack)||(this._localVideoTrack.setMediaStreamTrack(o.videoTrack),yield this._room.replaceTrack(this._localVideoTrack)):yield this._localVideoTrack.switchDevice(o.useFrontCamera?f.FACING_MODE_USER:f.FACING_MODE_ENVIRONMENT),y(o.profile)||(re(o.profile)?Li[o.profile]&&this._localVideoTrack.setProfile(Li[o.profile]):this._localVideoTrack.setProfile(o.profile)),y(o.fillMode)||(a.objectFit=o.fillMode),y(o.mirror)||(a.mirror=o.mirror),o.qosPreference&&this._localVideoTrack.mediaTrack)){let c=qr(o.qosPreference);this._localVideoTrack.mediaTrack.contentHint=c}yield this._updateVideoPlayOption({view:r,playOption:a,track:this._localVideoTrack,prevConfig:this._localVideoConfig}),this._room.isJoined&&!y(n)&&(n&&!this._localVideoConfig.publish&&this._room.publish(this._localVideoTrack).catch(()=>{}),this._localVideoConfig.publish&&!n&&this._room.unpublish(this._localVideoTrack).catch(()=>{})),y(s)||this._localVideoTrack.setMute(s),ht(this._localVideoConfig,e)})}stopLocalVideo(){return T(this,null,function*(){!this._localVideoTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localVideoTrack).catch(()=>{})),this._localVideoTrack.stop(),this._localVideoTrack.close(),Ue(this._localVideoTrack),this._localVideoTrack=null,this._localVideoConfig=null)})}startScreenShare(){return T(this,arguments,function*(e={publish:!0,view:null}){if(this._localScreenTrack){this._log.warn("screen share is already started");return}let{view:r=null,publish:n=!0,option:s}=e,o=new It;o.on("4",l=>{let m;l.error&&(m=z.convertFrom(l.error)),this.emit(Y.PUBLISH_STATE_CHANGED,ie(w({},l),{error:m}))});let a=null;o.setMediaType(2);let c={},d={};s&&(y(s.profile)||(re(s.profile)?io[s.profile]&&o.setProfile(io[s.profile]):o.setProfile(s.profile)),s.systemAudio&&(c.systemAudio=!0,c.echoCancellation=s.echoCancellation,c.noiseSuppression=s.noiseSuppression,c.autoGainControl=s.autoGainControl),y(s.fillMode)||(d.objectFit=s.fillMode),s.videoTrack&&(c.videoTrack=s.videoTrack),s.audioTrack&&(c.audioTrack=s.audioTrack));let u=yield o.capture(c);if(s!=null&&s.qosPreference){let l=qr(s.qosPreference);o.mediaTrack.contentHint=l}if(o.mediaTrack.addEventListener(f.ENDED,()=>{this._stopScreenShare(),this.emit(Y.SCREEN_SHARE_STOPPED)}),u.getAudioTracks()[0]&&(a=new Ti,a.setScreenAudioTrack(u.getAudioTracks()[0],u)),qe(o,o).add("player-state-changed",l=>{this.emit(Y.VIDEO_PLAY_STATE_CHANGED,ie(w({},l),{userId:"",streamType:"sub"}))}),yield this._updateVideoPlayOption({view:r,playOption:d,track:o}),n&&this._room.isJoined){let l=[o];a&&l.push(a),this._room.publish(...l).catch(()=>{})}this._localScreenTrack=o,this._localScreenAudioTrack=a,this._localScreenConfig=ie(w({},e),{view:r,publish:n})})}updateScreenShare(e){return T(this,null,function*(){if(!this._localScreenTrack||!this._localScreenConfig)return;let{view:r,publish:n,option:s}=e,o={};if(s&&(y(s.fillMode)||(o.objectFit=s.fillMode),s.qosPreference)){let a=qr(s.qosPreference);this._localScreenTrack.mediaTrack.contentHint=a}yield this._updateVideoPlayOption({view:r,playOption:o,track:this._localScreenTrack,prevConfig:this._localScreenConfig}),this._room.isJoined&&!y(n)&&(n&&!this._localScreenConfig.publish&&this._room.publish(this._localScreenTrack).catch(()=>{}),this._localScreenConfig.publish&&!n&&this._room.unpublish(this._localScreenTrack).catch(()=>{})),ht(this._localScreenConfig,e)})}stopScreenShare(){return T(this,null,function*(){return yield this._stopScreenShare()})}usePlugin(){}startPlugin(e,r){return T(this,null,function*(){var n;e==="RTCAudioMixer"&&(this._room.startPlugin("RTCAudioMixer",r),this._room.isJoined&&this._localAudioTrack&&this._room.isMainStreamPublished&&(yield(n=this._room)==null?void 0:n.publish(this._localAudioTrack)))})}updatePlugin(e,r){}stopPlugin(e,r){return T(this,null,function*(){e==="RTCAudioMixer"&&this._room.stopPlugin("RTCAudioMixer",r)})}startRemoteVideo(e){return T(this,null,function*(){let{view:r,userId:n,streamType:s,option:o}=e,a=`${n}_${s}`;if(this._remoteVideoConfigMap.has(a)){this._log.warn(`remote video has already started. userId:${n}, streamType:${s}`);return}let c=this._room.remotePublishedUserMap.get(n);if(!c)return;let d={},u=s==="main"?c.remoteVideoTrack:c.remoteAuxiliaryTrack;o&&(y(o.fillMode)||(d.objectFit=o.fillMode),y(o.mirror)||(d.mirror=o.mirror),s==="main"&&!y(o.small)&&this._room.changeType(o.small,u.user)),yield this._room.subscribe(u),yield this._updateVideoPlayOption({view:r,playOption:d,track:u}),this._remoteVideoConfigMap.set(a,e)})}updateRemoteVideo(e){return T(this,null,function*(){let{view:r,userId:n,streamType:s,option:o}=e,a=`${n}_${s}`;if(!this._remoteVideoConfigMap.has(a)||!this._room.remotePublishedUserMap.has(n))return;let c={};o&&(y(o.fillMode)||(c.objectFit=o.fillMode),y(o.mirror)||(c.mirror=o.mirror));let d=null,u=this._room.remotePublishedUserMap.get(n);s==="main"&&(u==null?void 0:u.muteState.hasVideo)&&(d=u.remoteVideoTrack),s==="sub"&&(u==null?void 0:u.muteState.hasAuxiliary)&&(d=u.remoteAuxiliaryTrack);let l=this._remoteVideoConfigMap.get(a);d&&(s==="main"&&o&&!y(o.small)&&this._room.changeType(o.small,d.user),yield this._updateVideoPlayOption({view:r,playOption:c,track:d,prevConfig:l})),ht(l,e)})}stopRemoteVideo(e){return T(this,null,function*(){return this._stopRemoteVideo(e)})}_stopRemoteVideo(e,r=!0){return T(this,null,function*(){let n=[],s=this._room.remotePublishedUserMap.get(e.userId);if(s){let{muteState:o,remoteVideoTrack:a,remoteAuxiliaryTrack:c}=s;o.hasVideo&&e.streamType==="main"&&n.push(a),o.hasAuxiliary&&e.streamType==="sub"&&n.push(c)}for(let o of n)r&&(yield this._room.unsubscribe(o)),o.stop(),this._remoteVideoConfigMap.delete(`${o.userId}_${Yr(o.streamType)}`)})}muteRemoteAudio(e,r){return T(this,null,function*(){if(e==="*")if(r)yield this._stopRemoteAudio({userId:e});else{let n=[...this._room.remotePublishedUserMap.values()];for(let s of n)s.muteState.hasAudio&&(yield this._startRemoteAudio({userId:s.userId}))}else r?yield this._stopRemoteAudio({userId:e}):yield this._startRemoteAudio({userId:e});this._remoteAudioMuteMap.set(e,r)})}setRemoteAudioVolume(e,r){if(e==="*"){let n=[...this._room.remotePublishedUserMap.values()];for(let s of n)this._updateAudioPlayOption({playOption:{volume:r},track:s.remoteAudioTrack})}else if(e){let n=this._room.remotePublishedUserMap.get(e);n&&this._updateAudioPlayOption({playOption:{volume:r},track:n.remoteAudioTrack})}}enableAudioVolumeEvaluation(e=2e3,r=!1){this._room.enableAudioVolumeEvaluation(e,r)}startMixTranscode(e){let r=w({},e);return r.mixUsers=e.mixUsers.map(n=>{let s=w({},n);return y(n.streamType)||(s.streamType=Yr(n.streamType)),s}),this._room.startMixTranscode(r)}stopMixTranscode(){return this._room.stopMixTranscode()}startPublishCDNStream(e){let r=w({},e);return y(e.streamType)||(r.streamType=Yr(e.streamType)),this._room.startPublishCDNStream(r)}stopPublishCDNStream(){return this._room.stopPublishCDNStream()}on(e,r,n){return super.on(e,r,n),this._eventListened.add(e),this}off(e,r,n){return e==="*"?(this._eventListened.clear(),this.removeAllListeners()):super.off(e,r,n),this}getVideoTrack(e={userId:"",streamType:"main"}){let{userId:r="",streamType:n="main"}=e;if(r===""){if(n==="main"&&this._localVideoTrack)return this._localVideoTrack.mediaTrack;if(n==="sub"&&this._localScreenTrack)return this._localScreenTrack.mediaTrack}else{let s=this._room.remotePublishedUserMap.get(r);if(s)return n==="main"?s.remoteVideoTrack.mediaTrack:s.remoteAuxiliaryTrack.mediaTrack}return null}getAudioTrack(e){if(e){let r=this._room.remotePublishedUserMap.get(e);if(r)return r.remoteAudioTrack.mediaTrack}else if(this._localAudioTrack)return this._localAudioTrack.mediaTrack;return null}setCurrentSpeaker(e){var r;(r=this._localAudioTrack)==null||r.setAudioOutput(e),this._room.remotePublishedUserMap.forEach(n=>n.remoteAudioTrack.setAudioOutput(e))}_startRemoteAudio(e){return T(this,null,function*(){let{userId:r,option:n}=e;if(this._remoteAudioConfigMap.has(r)){this._log.warn(`remote audio has already started. userId:${r}`);return}let s=this._room.remotePublishedUserMap.get(r);if(!s)return;let o={};n&&(y(n.volume)||(o.volume=n.volume));let a=s.remoteAudioTrack;yield this._room.subscribe(a),yield this._updateAudioPlayOption({playOption:o,track:a}),this._remoteAudioConfigMap.set(r,e)})}_stopRemoteAudio(e,r=!0){return T(this,null,function*(){let n=this._room.remotePublishedUserMap.get(e.userId);n!=null&&n.muteState.hasAudio&&(r&&(yield this._room.unsubscribe(n.remoteAudioTrack)),n.remoteAudioTrack.stop()),this._remoteAudioConfigMap.delete(`${e.userId}`)})}_updateVideoPlayOption(o){return T(this,arguments,function*({view:e,playOption:r,track:n,prevConfig:s}){if(y(e)&&s&&s.view&&!Lr(r)){let a;ke(s.view)?a=s.view:a=Kn(s.view),a&&(yield n.play(a,r))}if(!y(e)){let a;ke(e)?a=e:a=Kn(e),a?yield n.play(a,r):n.stop()}})}_updateAudioPlayOption(s){return T(this,arguments,function*({playOption:e={},track:r,prevConfig:n}){r.isPlayCalled||(yield r.play(null,e)),y(e.muted)||r.setPlayerMute(e.muted),y(e.volume)||r.setAudioVolume(e.volume/100)})}_checkTrackToPublish(){var r,n,s;let e=[];if(((r=this._localAudioConfig)==null?void 0:r.publish)&&this._localAudioTrack&&e.push(this._localAudioTrack),((n=this._localVideoConfig)==null?void 0:n.publish)&&this._localVideoTrack&&e.push(this._localVideoTrack),(s=this._localScreenConfig)!=null&&s.publish&&(this._localScreenTrack&&e.push(this._localScreenTrack),this._localScreenAudioTrack&&e.push(this._localScreenAudioTrack)),e.length!==0)return this._room.publish(...e).catch(()=>{})}_handleReceiveMode(){this._room.autoReceiveAudio&&qe(this,this).add(Y.REMOTE_AUDIO_AVAILABLE,r=>T(this,[r],function*({userId:e}){if(this._remoteAudioMuteMap.get("*")||this._remoteAudioMuteMap.get(e))return;let n=this._room.remotePublishedUserMap.get(e);n&&(yield this._room.subscribe(n.remoteAudioTrack).catch(()=>{}),yield this._updateAudioPlayOption({track:n.remoteAudioTrack}).catch(()=>{}),this._remoteAudioConfigMap.set(e,{userId:e}))})),this._room.autoReceiveVideo&&qe(this,this).add(Y.REMOTE_VIDEO_AVAILABLE,({userId:e,streamType:r})=>{let n=this._room.remotePublishedUserMap.get(e);n&&(r==="main"?this._room.subscribe(n.remoteVideoTrack).catch(()=>{}):r==="sub"&&this._room.subscribe(n.remoteAuxiliaryTrack).catch(()=>{}))})}_exitRoom(){return T(this,null,function*(){this._room.isJoined&&(yield this._room.leave()),[...this._remoteAudioConfigMap.keys()].forEach(e=>{this._stopRemoteAudio({userId:e}).catch()}),[...this._remoteVideoConfigMap.keys()].forEach(e=>{let r=e.includes("main")?"main":"sub",n=e.split(`_${r}`)[0];n&&this._stopRemoteVideo({userId:n,streamType:r}).catch()}),this._remoteVideoConfigMap.clear(),this._remoteAudioConfigMap.clear(),this._remoteAudioMuteMap.clear(),this._room.remotePublishedUserMap.forEach(e=>{Ue(e.remoteAudioTrack),Ue(e.remoteVideoTrack),Ue(e.remoteAuxiliaryTrack)}),Ue(this)})}_stopScreenShare(){return T(this,null,function*(){var e,r,n;if(!!this._localScreenTrack){if(this._room.isJoined){let s=[this._localScreenTrack];this._localScreenAudioTrack&&s.push(this._localScreenAudioTrack),yield(e=this._room)==null?void 0:e.unpublish(...s).catch(()=>{})}this._localScreenTrack.stop(),this._localScreenTrack.close(),(r=this._localScreenAudioTrack)==null||r.stop(),(n=this._localScreenAudioTrack)==null||n.close(),Ue(this._localScreenTrack),this._localScreenTrack=null,this._localScreenAudioTrack=null,this._localScreenConfig=null}})}static setLogLevel(e,r){M.setLogLevel(e),y(r)||(r?M.enableUploadLog():M.disableUploadLog())}static isSupported(){return Vo()}static getCameraList(){return St()}static getMicrophoneList(){return Qe()}static getSpeakerList(){return Wi()}static setCurrentSpeaker(e){return T(this,null,function*(){(yield Wi()).forEach(n=>{n.deviceId===e&&(ja.forEach(s=>{s.setCurrentSpeaker(e),s.emit(Y.DEVICE_CHANGED,{type:"speaker",action:"active",device:n})}),je=n)})})}},ne=zr;p(ne,"_loggerManager",M),p(ne,"EVENT",Y),p(ne,"ERROR_CODE",te),p(ne,"TYPE",Xr),p(ne,"frameWorkType",30),G([Fe(Me.TRTC.enterRoom),gi("room",([i],[t])=>i.roomId===t.roomId&&i.userId===t.userId&&i.sdkAppId===t.sdkAppId),ce(i=>function(t){return this._log.setUserId(t.userId),this._log.setSdkAppId(t.sdkAppId),i.call(this,t).catch(e=>{throw Ue(this),e})}),Re()],ne.prototype,"enterRoom",1),G([Re()],ne.prototype,"exitRoom",1),G([Fe(Me.TRTC.switchRole),qi("room",(i,t)=>t),Re()],ne.prototype,"switchRole",1),G([Re()],ne.prototype,"destroy",1),G([Fe(Me.TRTC.startLocalAudio),gi("audio",([i],[t])=>{var e,r;return((e=i==null?void 0:i.option)==null?void 0:e.microphoneId)===((r=t==null?void 0:t.option)==null?void 0:r.microphoneId)}),Re()],ne.prototype,"startLocalAudio",1),G([Fe(Me.TRTC.updateLocalAudio),qi("audio"),Re()],ne.prototype,"updateLocalAudio",1),G([Ri("audio"),Re()],ne.prototype,"stopLocalAudio",1),G([Fe(Me.TRTC.startLocalVideo),gi("video",([i],[t])=>{var e,r;return((e=i==null?void 0:i.option)==null?void 0:e.cameraId)===((r=t==null?void 0:t.option)==null?void 0:r.cameraId)}),Re()],ne.prototype,"startLocalVideo",1),G([Fe(Me.TRTC.updateLocalVideo),qi("video"),Re()],ne.prototype,"updateLocalVideo",1),G([Ri("video"),Re()],ne.prototype,"stopLocalVideo",1),G([Fe(Me.TRTC.startScreenShare),gi("screen",()=>!0),Re()],ne.prototype,"startScreenShare",1),G([Fe(Me.TRTC.updateScreenShare),qi("screen"),Re()],ne.prototype,"updateScreenShare",1),G([Re()],ne.prototype,"stopScreenShare",1),G([Fe(Me.TRTC.startRemoteVideo),gi(i=>`v${i.userId}${i.streamType}`,()=>!0),Re()],ne.prototype,"startRemoteVideo",1),G([Fe(Me.TRTC.updateRemoteVideo),qi(i=>`v${i.userId}${i.streamType}`),Re()],ne.prototype,"updateRemoteVideo",1),G([Fe(Me.TRTC.stopRemoteVideo),ce(i=>function(t){return T(this,null,function*(){if(t.userId==="*"){let e=[];return this._room.remotePublishedUserMap.forEach(r=>{this._remoteVideoConfigMap.has(`${r.userId}_${"main"}`)&&e.push(this.stopRemoteVideo({streamType:"main",userId:r.userId}).catch(()=>{})),this._remoteVideoConfigMap.has(`${r.userId}_${"sub"}`)&&e.push(this.stopRemoteVideo({streamType:"sub",userId:r.userId}).catch(()=>{}))}),Promise.all(e)}return i.call(this,t)})}),Re()],ne.prototype,"stopRemoteVideo",1),G([Ri(i=>`v${i.userId}${i.streamType}`,!0)],ne.prototype,"_stopRemoteVideo",1),G([Fe(...Me.TRTC.muteRemoteAudio),Re()],ne.prototype,"muteRemoteAudio",1),G([Ka(...Me.TRTC.setRemoteAudioVolume),Gu(200,i=>i),Re()],ne.prototype,"setRemoteAudioVolume",1),G([Ka(...Me.TRTC.enableAudioVolumeEvaluation)],ne.prototype,"enableAudioVolumeEvaluation",1),G([Fe(Me.TRTC.startMixTranscode)],ne.prototype,"startMixTranscode",1),G([gi(i=>`a${i.userId}`,()=>!0)],ne.prototype,"_startRemoteAudio",1),G([ce(i=>function(t){return T(this,null,function*(){return t.userId==="*"?Promise.all([...this._room.remotePublishedUserMap.values()].map(e=>this._stopRemoteAudio(ie(w({},t),{userId:e.userId})).catch(()=>{}))):i.call(this,t)})}),Ri(i=>`a${i.userId}`)],ne.prototype,"_stopRemoteAudio",1),G([Ri("room")],ne.prototype,"_exitRoom",1),G([Ri("screen")],ne.prototype,"_stopScreenShare",1);var Qr=ne;var aL=h(_());var uN=h(_(),1);var Ja=class{constructor(){this._set=new Set;C.on(S.LEAVE_SUCCESS,this.delete,this)}add({room:t,roomId:e}){if(t.scene==="rtc")return;let r=this.getKey(t.userId,e||t.roomId,t.sdkAppId,t.useStringRoomId);this._set.add(r)}delete({room:t,roomId:e}){if(t.scene==="rtc")return;let r=this.getKey(t.userId,t.roomId||e,t.sdkAppId,t.useStringRoomId);this._set.delete(r)}getKey(t,e,r,n){return`${r}_${e}_${t}_${n}`}isJoined({userId:t,roomId:e,sdkAppId:r,room:n}){return n.scene==="rtc"?!1:this._set.has(this.getKey(t,e,r,n.useStringRoomId))}};function Jh(){return T(this,null,function*(){let i,t;try{let l=yield Qe();i=l&&l.length}catch(l){}try{let l=yield St();t=l&&l.length}catch(l){}let e={microphone:i,camera:t},{isH264EncodeSupported:r,isVp8EncodeSupported:n,isH264DecodeSupported:s,isVp8DecodeSupported:o}=this.checkSystemResult.detail,a=Lt.basis(),c={webRTC:a.isWebRTCSupported,getUserMedia:a.isGetUserMediaSupported,webSocket:a.isWebSocketsSupported,screenShare:a.isScreenShareSupported,webAudio:a.isWebAudioSupported,h264Encode:r,h264Decode:s,vp8Encode:n,vp8Decode:o},d={browser:a.browser,os:a.os,trtc:c,devices:e},u={isWebCodecSupported:a.isWebCodecSupported,isMediaSessionSupported:a.isMediaSessionSupported,isWebTransportSupported:a.isWebTransportSupported};Ae.uploadEvent({log:`trtcstats-${JSON.stringify(d)}`,userId:this.userId}),this._log.info(`TrtcStats-${JSON.stringify(d)}`),Ae.uploadEvent({log:`trtcadvancedstats-${JSON.stringify(u)}`,userId:this.userId})})}function Ju(){return ce(i=>{let t=new Ja;return function(e,r,n){return T(this,null,function*(){let s=String(e.roomId||e.strRoomId);if(this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.userSig=e.userSig,this._log.setSdkAppId(this.sdkAppId),this._log.setUserId(this.userId),this.scene=r,e.privateMapKey=e.privateMapKey||"",this.isJoined)throw new V({code:b.INVALID_OPERATION,message:H({key:$.INVALID_JOIN})});if(this.checkDestroy(),t.isJoined({userId:this.userId,roomId:s,sdkAppId:this.sdkAppId,room:this}))throw new V({code:b.INVALID_OPERATION,message:H({key:$.REPEAT_JOIN,data:this.userId})});t.add({room:this,roomId:s}),this._log.info(`Join() => joining room: ${s} useStringRoomId: ${this.useStringRoomId} scene: ${this.scene} role: ${this.role}`),this.role=e.role===21?"audience":"anchor",C.emit(S.JOIN_START,{room:this,roomId:s}),this.checkSystemResult=yield Lt.checkSystemRequirementsInternal(),this.checkDestroy();let o=Ge.getEnv();o||(o=Kt.QCLOUD,this.proxy_ws&&(this.proxy_ws.startsWith(ro.OLD_CLOUD_LADDER)?o=Kt.OLD_CLOUD_LADDER:this.proxy_ws.startsWith(ro.WEBRTC)&&(o=Kt.WEBRTC))),Ae.setConfig({env:o,sdkAppId:String(this.sdkAppId),userId:this.userId,roomId:s}),Jh.call(this);let{isH264EncodeSupported:a,isVp8EncodeSupported:c}=this.checkSystemResult.detail;if(!Lt.isWebRTCSupported()||!a&&!c)throw new V({code:b.NOT_SUPPORTED,message:H({key:$.NOT_SUPPORTED_WEBRTC})});try{!this.proxy_ws&&!this.proxy_wt&&!this.scheduleResult.domains&&(yield this.schedule(s,n,Be)),console.log("scheduleResult",this.scheduleResult);let d=yield i.call(this,e,r,n);return this.roomId=s,this._joinedTimestamp=Ge.performanceNow(),C.emit(S.JOIN_SUCCESS,{room:this}),d}catch(d){throw t.delete({room:this,roomId:s}),C.emit(S.JOIN_FAILED,{room:this,error:d}),d}})}})}var EN=h(_(),1);var Xu=()=>ce(i=>function(...t){return T(this,null,function*(){C.emit(S.LEAVE_START,{room:this}),yield i.call(this),C.emit(S.LEAVE_SUCCESS,{room:this,roomId:this.roomId})})});var kN=h(_()),qu=h(ft());var IN=h(_()),ve={SETUP_SUCCESS:"1",SETUP_FAILED:"5",CONNECTION_STATE_CHANGED:"2",CONNECTED:"3",RECONNECT_FAILED:"4"},Je={DISCONNECTED:"DISCONNECTED",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED"},gt={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772,REBUILD_PEER_CONNECTION_RES:4150},Yu=[gt.UPDATE_REMOTE_MUTE_STAT,gt.UPLINK_NETWORK_STATS,gt.USER_LIST_RES,gt.MUTE_RESULT],se={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res",REBUILD_PEER_CONNECTION_RES:"rebuild-pc-res"},pe={PUBLISH_CHANGE:"publish_change",JOIN_ROOM:"join",LEAVE_ROOM:"leave",ON_QUALITY_REPORT:"quality_report",UPDATE_MUTE_STAT:"mute_uplink",PUBLISH:"publish",PUBLISH_STATE_CHANGE:"publish_state_change",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",RECEIVE_DATA_USER_LIST:"receive_data_userlist",UNSUBSCRIBE:"unsubscribe",SUBSCRIBE_CHANGE:"subscribe_change",START_PUBLISH_TENCENT_CDN:"start_publishing",STOP_PUBLISH_TENCENT_CDN:"stop_publishing",START_PUBLISH_GIVEN_CDN:"start_push_user_cdn",STOP_PUBLISH_GIVEN_CDN:"stop_push_user_cdn",START_MIX_TRANSCODE:"start_mcu_mix",STOP_MIX_TRANSCODE:"stop_mcu_mix",GET_USER_LIST:"get_user_list",SWITCH_ROLE:"change_role",UPDATE_CONSTRAINT_CONFIG:"update_constraint_config",REBUILD_PEER_CONNECTION:"rebuild_pc"};var Zr=class{constructor(t){p(this,"_room");p(this,"_sdkAppId");p(this,"_userId");p(this,"_userSig");p(this,"_url");p(this,"_backupUrl");p(this,"_urlWithParam");p(this,"_backupUrlWithParam");p(this,"_socketInUse");p(this,"_socket");p(this,"_backupSocket");p(this,"_backupTimer",-1);p(this,"_signalInfo",{tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0});p(this,"_currentState",Je.DISCONNECTED);p(this,"_reconnectionCount",0);p(this,"_reconnectionTimer",-1);p(this,"_seq",0);p(this,"_log");p(this,"_emitter");p(this,"_lastMessageTime",-1);p(this,"_prevTime",-1);this._room=t.room,this._sdkAppId=t.sdkAppId,this._userId=t.userId,this._userSig=t.userSig,this._url=t.url,this._backupUrl=t.backupUrl;let e=`?sdkAppId=${encodeURIComponent(this._sdkAppId)}&userId=${encodeURIComponent(this._userId)}&userSig=${encodeURIComponent(this._userSig)}`;this._urlWithParam=`${this._url}${e}`,this._backupUrlWithParam=`${this._backupUrl}${e}`,this._seq=0,this._log=M.createLogger({id:"ws",userId:this._userId,sdkAppId:this._sdkAppId}),this._emitter=new qu.default}get isConnected(){return this._currentState===Je.CONNECTED}get isConnecting(){return this._currentState===Je.CONNECTING}get isOnline(){return this._currentState===Je.CONNECTED&&Date.now()-this._lastMessageTime<12*1e3}connect(){return new Promise((t,e)=>{this._prevTime<0&&(this._prevTime=ee()),this._log.info(`connect to ${this._url}`),this.emitConnectionStateChanged(Je.CONNECTING),this._socket=new WebSocket(this._urlWithParam),this.bindSocket(this._socket),this._backupTimer=setTimeout(()=>{this.isConnected||(this._log.info("trying to connect to backupUrl"),this.tryConnectBackup())},5e3),this.once(ve.CONNECTED,t),this.once(ve.RECONNECT_FAILED,e)})}tryConnectBackup(){this._backupSocket||(this.unbindAndCloseSocket(f.MAIN),this._log.debug(`try to connect to url: ${this._backupUrlWithParam}`),this._backupSocket=new WebSocket(this._backupUrlWithParam),this.bindSocket(this._backupSocket))}bindSocket(t){t.onopen=this.onopen.bind(this),t.onclose=this.onclose.bind(this),t.onerror=this.onerror.bind(this),t.onmessage=this.onmessage.bind(this)}unbindSocket(t){this.clearBackupTimer(),t.onopen=()=>{},t.onclose=()=>{},t.onerror=()=>{},t.onmessage=()=>{}}unbindAndCloseSocket(t){if(t===f.MAIN){if(this._socket){this.unbindSocket(this._socket);try{this._socket.close(1e3)}catch(e){}this._socket=null}}else if(this._backupSocket){this.unbindSocket(this._backupSocket);try{this._backupSocket.close(1e3)}catch(e){}this._backupSocket=null}}clearBackupTimer(){this._backupTimer!==-1&&(clearTimeout(this._backupTimer),this._backupTimer=-1)}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onopen(t){if(this.isConnected)return;this.isReconnecting&&!this._signalInfo.tinyId&&this.stopReconnection(),this.clearBackupTimer(),t.target===this._socket?(this.unbindAndCloseSocket(f.BACKUP),this._socketInUse=this._socket):(this.unbindAndCloseSocket(f.MAIN),this._socketInUse=this._backupSocket),this.emitConnectionStateChanged(Je.CONNECTED),this._emitter.emit(ve.CONNECTED)}onclose(t){let{url:e}=t.target,r=t.target===this._socketInUse;this._log.info(`websocket[${e} InUse: ${r}] is closed with code: ${t.code}`),t.target===this._socketInUse&&(this.emitConnectionStateChanged(Je.DISCONNECTED),(!t.wasClean||t.code!==1e3)&&(this._log.warn(`onclose code:${t.code} reason:${t.reason}`),this._log.warn("close current websocket and schedule a reconnect timeout"),this._socketInUse.onclose=()=>{},this._socketInUse.close(4011),this._socket=null,this._backupSocket=null,this._socketInUse=null,this.reconnect(f.MAIN)))}onerror(t){let{url:e}=t.target;this._log.error(`websocket[${e}] error observed`),this.isConnected?t.target===this._socketInUse&&(this.unbindAndCloseSocket(f.MAIN),this.unbindAndCloseSocket(f.BACKUP),this._socketInUse=null,this.reconnect(f.MAIN)):(this.isReconnecting||C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:new Error("ws onerror")}),t.target==this._socket?(this.unbindAndCloseSocket(f.MAIN),this.reconnect(f.BACKUP)):(this.unbindAndCloseSocket(f.BACKUP),this.reconnect(f.MAIN)))}onmessage(t){if(!this.isConnected)return;this._lastMessageTime=Date.now();let e=JSON.parse(t.data),{cmd:r,data:n}=e,s=Object.values(gt),a=Object.keys(gt)[s.indexOf(r)],c=se[a];switch(Yu.includes(r)||(this._log.debug(`received msg: ${t.data}`),this._log.info(`Received event: [ ${c||`unknown cmd: ${r}`} ]`)),r){case gt.CHANNEL_SETUP_RESULT:{if(e.code===0)this._signalInfo.clientIp=n.clientIp,this._signalInfo.signalIp=n.signalInnerIp,this._signalInfo.tinyId=e.tinyId,n.svrTime&&Td(n.svrTime),this._log.info("ChannelSetup Success"),C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",cost:ee()-this._prevTime}),this._prevTime=-1,this._emitter.emit(ve.SETUP_SUCCESS,{signalInfo:this._signalInfo});else{let d=new V({code:b.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:e.code,message:H({key:$.SIGNAL_CHANNEL_SETUP_FAILED,data:{errorCode:e.code,errorMsg:e.message}})});this._log.error(`${e.code}, ${e.message}`),this.close(),C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:d}),this._emitter.emit(ve.SETUP_FAILED,d)}break}case gt.JOIN_ROOM_RESULT:{e.code===0&&(this._signalInfo.relayIp=n.relayOuterIp,this._signalInfo.relayInnerIp=n.relayInnerIp,this._signalInfo.relayPort=n.relayPort,this._log.info(`signalIp:${this._signalInfo.signalIp} clientIp:${this._signalInfo.clientIp} relayIp: ${this._signalInfo.relayIp}`)),this._emitter.emit(c,{data:e});break}case gt.CHANNEL_RECONNECT_RESULT:{e.code===0?(this._log.warn("reconnect success"),this.stopReconnection(),C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",cost:ee()-this._prevTime}),this._prevTime=-1,this._room.syncUserList(),this._room.checkConnectionsToReconnect()):(this._log.warn(`reconnect failed, ${e.code} ${e.message}`),this._room.reJoin());break}default:this._emitter.emit(c,{data:e});break}}reconnect(t=f.MAIN){if(this.isReconnecting)return;if(this._reconnectionCount>=Cn){this._log.warn(`SDK has tried reconnect signal channel for ${Cn} times, but all failed. please check your network`);let n=new V({code:b.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:H({key:$.SIGNAL_CHANNEL_RECONNECTION_FAILED})});C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",error:n}),this._emitter.emit(ve.RECONNECT_FAILED,n);return}this._reconnectionCount++,this._log.warn(`reconnect ${t} [${this._reconnectionCount}/${Cn}]`);let e=this.getReconnectionUrl(t);this.emitConnectionStateChanged(Je.CONNECTING),this._prevTime<0&&(this._prevTime=ee()),t===f.MAIN?(this._socket=new WebSocket(e),this.bindSocket(this._socket)):(this._backupSocket=new WebSocket(e),this.bindSocket(this._backupSocket));let r=mt(this._reconnectionCount);this._reconnectionTimer=setTimeout(()=>{this._log.warn(`reconnect ${t} timeout(${r/1e3}s), try again`),this.clearReconnectionTimer(),this.unbindAndCloseSocket(f.MAIN),this.unbindAndCloseSocket(f.BACKUP),this.reconnect(t===f.MAIN?f.BACKUP:f.MAIN)},r)}get isReconnecting(){return this._reconnectionTimer!==-1}getReconnectionUrl(t){let e=t===f.MAIN?this._urlWithParam:this._backupUrlWithParam;if(this._signalInfo.tinyId&&e.indexOf("&rc=1")===-1){let{roomId:r,useStringRoomId:n}=this._room;e+=`&rc=1&relayInnerIp=${this._signalInfo.relayInnerIp}&relayOuterIp=${this._signalInfo.relayIp}&relayPort=${this._signalInfo.relayPort}&roomId=${r}&useStringRoomId=${n}`}return e}send(t,e={}){if(this.isConnected){let r={cmd:t,data:e,userId:this._userId,tinyId:this._signalInfo.tinyId,seq:++this._seq};return this._socketInUse.send(JSON.stringify(r)),r.seq}}sendWaitForResponse({command:t,data:e,timeout:r=5e3,responseCommand:n,commandDesc:s,enableLog:o=!0}){return new Promise((a,c)=>{let d=setTimeout(()=>{this.off(n,u);let m=new V({code:b.API_CALL_TIMEOUT,message:H({key:$.API_CALL_TIMEOUT,data:{commandDesc:s,command:t}})});o&&this._log.warn(m),c(m)},r),u=m=>{m.data.seq===l&&(clearTimeout(d),this.off(n,u),a(m))};this.on(n,u);let l=this.send(t,e)})}sendWaitForResponseWithRetry(t){let{commandDesc:e,command:r,retries:n=0,retryTimeout:s=0}=t;return _t({retryFunction:this.sendWaitForResponse,onRetrying:o=>{this._log.warn(`${e||r} timeout observed, retrying [${o}/${n}]`)},settings:{retries:n,timeout:s},context:this})(t)}getCurrentState(){return this._currentState}getSignalInfo(){return this._signalInfo}stopReconnection(){this.isReconnecting&&(this._reconnectionCount=0,this.clearReconnectionTimer())}close(){this._log.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._socketInUse=null,this.unbindAndCloseSocket(f.MAIN),this.unbindAndCloseSocket(f.BACKUP),this.emitConnectionStateChanged(Je.DISCONNECTED)}on(t,e,r){this._emitter.on(t,e,r)}removeListener(t,e,r){this._emitter.removeListener(t,e,r)}once(t,e,r){this._emitter.once(t,e,r)}off(t,e,r){this._emitter.off(t,e,r)}emitConnectionStateChanged(t){t!==this._currentState&&(this._log.info(`${this._currentState} -> ${t}`),this._emitter.emit(ve.CONNECTION_STATE_CHANGED,{prevState:this._currentState,state:t}),this._currentState=t)}};var OD=h(_());var tD=h(_()),Qu=h(ft());var BN=h(_());var Xa=class{constructor(t,e,r){this._isUplink=r,this._connection=t,this._log=e,this._seiMessageList=[],this._seiPayloadType=243,this._mainVideoSenderOrReceiver=null,this._mainVideoAbortController=null,this._abortMap=new Map,this.onSEIMessage=null}get isRunning(){return!!this._mainVideoAbortController}start(t){this._mainVideoSenderOrReceiver=t;let e=t.createEncodedStreams(),r=e.readable,n=e.writable,s=new TransformStream({transform:this._isUplink?this.encodeVideoFrame.bind(this):this.decodeVideoFrame.bind(this)});this._mainVideoAbortController=new AbortController,r.pipeThrough(s).pipeTo(n,{signal:this._mainVideoAbortController.signal}).catch(()=>{})}restart(t){this.stop(),this.start(t)}stop(){var t;(t=this._mainVideoAbortController)==null||t.abort(),this._mainVideoAbortController=null}destroy(){this.stop(),this._abortMap.forEach(t=>t.abort()),this._abortMap.clear(),this._log=null,this.onSEIMessage=null,this._mainVideoSenderOrReceiver=null,this._connection=null}handleEncodedStreams(){try{let t=this._connection.getPeerConnection();this.clearUnusedSenderOrReceiver(t),this._isUplink?t.getSenders().forEach((e,r)=>{if(r===1){if(e===this._mainVideoSenderOrReceiver)return;this.isRunning?this.restart(e):this.start(e)}else{if(this._abortMap.has(e))return;this.pipeSenderOrReceiver(e)}}):t.getReceivers().forEach((e,r)=>{var n;this._abortMap.has(e)||e===this._mainVideoSenderOrReceiver||(r===1&&((n=e.track)==null?void 0:n.kind)===f.VIDEO?this.isRunning?this.restart(e):this.start(e):this.pipeSenderOrReceiver(e))})}catch(t){this._log.warn(t)}}pipeSenderOrReceiver(t){let{readable:e,writable:r}=t.createEncodedStreams(),n=new AbortController;this._abortMap.set(t,n),e.pipeTo(r,{signal:n.signal}).catch(()=>{})}clearUnusedSenderOrReceiver(t){this._abortMap.forEach((e,r)=>{(this._isUplink?t.getSenders():t.getReceivers()).find(s=>s===r)||(e.abort(),this._abortMap.delete(r))})}push(t,e){e&&e.seiPayloadType&&(this._seiPayloadType=e.seiPayloadType),this._seiMessageList.push(t)}hasSEI(t){let e=new DataView(t);return e.getInt32(0)===1&&e.getInt8(4)===6}isEmptyFrame(t){return t.type==="empty"||t.data.byteLength===0}getNaluCount(t){let e=0,r=0,n=new DataView(t);for(let s=0;s<t.byteLength;s++)switch(n.getUint8(s)){case 0:e++;break;case 1:(e===2||e===3)&&r++,e=0;break;default:e=0;break}return r}encodeVideoFrame(t,e){try{if(this._connection.isH264&&this._seiMessageList.length>0&&!this.isEmptyFrame(t)){let n=9-this.getNaluCount(t.data);if(n<=0)return;let s=this._seiMessageList.splice(0,n).reverse().map(this.encodeSEINalu.bind(this)),o=s.reduce((l,m)=>l+m.dataView.byteLength,0),a=new ArrayBuffer(o+t.data.byteLength),c=new DataView(a),d=new DataView(t.data),u=0;for(let l=0;l<s.length;l++)for(let m=0;m<s[l].dataView.byteLength;m++)c.setInt8(u++,s[l].dataView.getInt8(m));for(let l=0;l<t.data.byteLength;l++)c.setInt8(u++,d.getInt8(l));t.data=a,this._log.debug(`${s.length} sei sent`)}}catch(r){this._log.warn(r)}e.enqueue(t)}decodeVideoFrame(t,e){try{if(this._connection.isH264&&!this.isEmptyFrame(t)&&this.hasSEI(t.data)){let r=[],n=new DataView(t.data),s=0,o=-1,a=-1;for(let c=0;c<t.data.byteLength;c++){let d=n.getUint8(c);if(d===0)s++;else if(d===1){if(s===2||s===3){let u=c-s;if(o===-1?o=u:a===-1&&(a=u,r.push(new As(new DataView(n.buffer.slice(o,a)))),o=u,a=-1),!(n.getUint8(c+1)===6)){t.data=new DataView(n.buffer.slice(u)).buffer;break}}s=0}else s=0}this._log.debug(`${r.length} sei received`),oe(this.onSEIMessage)&&r.reverse().forEach(c=>{this.onSEIMessage({seiPayloadType:c.seiPayloadType,data:c.seiPayload.buffer})})}}catch(r){this._log.warn(r)}e.enqueue(t)}encodeSEINalu(t){let e=t.byteLength,r=parseInt(e/255),n=e%255,s=[];s.push(0,0,0,1,6,this._seiPayloadType);for(let a=0;a<r;a++)s.push(255);s.push(n);let o=new DataView(t);return s.push(...new Uint8Array(o.buffer)),s.push(128),new As(new DataView(new Uint8Array(s).buffer),!0)}},As=class{constructor(t,e=!1){this.dataView=t,this.isSEI&&(e?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){let{seiPayloadStartIndex:t}=this,e=this.dataView.byteLength-2,r=[],n=0;for(let o=t;o<=e;o++){let a=this.dataView.getInt8(o);switch(a){case 0:case 1:case 2:case 3:n===2&&(r.push(3),n=0),a==0?n++:n=0,r.push(a);break;default:n=0,r.push(a);break}}r.push(this.dataView.getInt8(this.dataView.byteLength-1));let s=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,t),...r]).buffer);this.dataView=s}removePreventionByte(){let{seiPayloadStartIndex:t}=this,e=this.dataView.byteLength-1,r=[],n=0;for(let o=t;o<=e;o++)switch(this.dataView.getInt8(o)){case 0:n++,r.push(this.dataView.getInt8(o));break;case 3:n!==2&&r.push(this.dataView.getInt8(o)),n=0;break;default:r.push(this.dataView.getInt8(o)),n=0;break}let s=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,t),...r]).buffer);this.dataView=s}get isSEI(){return this.dataView.getUint8(4)===6}get seiPayloadStartIndex(){let t=6;for(let e=6;e<this.dataView.buffer.byteLength&&(t++,this.dataView.getUint8(e)===255);e++);return t}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let t=0,e=6;for(let s=6;s<this.dataView.buffer.byteLength;s++){let o=this.dataView.getUint8(s);if(e++,o===255)t+=255;else{t+=o;break}}let r=new ArrayBuffer(t),n=new DataView(r);for(let s=0;s<r.byteLength;s++,e++)n.setInt8(s,this.dataView.getInt8(e));return n}},zu=Xa;var Ya=0,qa=!1,Cs=new Set,Xh=i=>Ya>2&&!qa&&Cs.size===0&&i,Qa=!1,st=class{constructor(t){p(this,"userId");p(this,"tinyId");p(this,"_sdpSemantics");p(this,"_isUplink");p(this,"_room");p(this,"_log");p(this,"_signalChannel");p(this,"_isErrorObserved",!1);p(this,"_waitForPeerConnectionConnectedPromise");p(this,"_waitForPeerConnectionConnectedPromiseReject",null);p(this,"_peerConnection",null);p(this,"_emitter",new Qu.default);p(this,"_currentState","DISCONNECTED");p(this,"_isReconnecting",!1);p(this,"_reconnectionCount",0);p(this,"_reconnectionTimer",-1);p(this,"_isFirstConnection",!0);p(this,"_prevTime",-1);p(this,"_enableSEI");p(this,"_sei");p(this,"_localAddress");p(this,"_remoteAddress");this.userId=t.userId,this.tinyId=t.tinyId,this._room=t.room,this._sdpSemantics=t.room.sdpSemantics,this._isUplink=t.isUplink,this._log=M.createLogger({id:"n",userId:this._room.userId,remoteUserId:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=t.signalChannel,this._enableSEI=t.enableSEI,this._enableSEI&&Qn&&(this._sei=new zu(this,this._log,this._isUplink))}beforeConnect(){this._prevTime<0&&(this._prevTime=ee())}afterConnect(t){return T(this,null,function*(){try{yield t,this._isFirstConnection?(this._isFirstConnection=!1,C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",cost:Math.min(ee()-this._prevTime,30*1e3)})):this._isReconnecting&&C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",cost:ee()-this._prevTime}),this._prevTime=-1}catch(e){throw this._isFirstConnection?(this._isFirstConnection=!1,C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",error:e})):this._isReconnecting&&this._reconnectionCount>=3&&C.emit(S.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",error:e}),e}})}initialize(){let t={encodedInsertableStreams:this._enableSEI&&Qn,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this._peerConnection=new RTCPeerConnection(t),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(t){this._log.info("close connection"),this._emitter.emit("closed",t),this.closePeerConnection(),this._sei&&(this._sei.destroy(),this._sei=null),Cs.delete(this)}closePeerConnection(t=!1){this._peerConnection&&(this._log.info("close pc"),this._peerConnection.onconnectionstatechange=null,this._peerConnection.close(),this._peerConnection=null,t&&this.emitConnectionStateChangedEvent("DISCONNECTED")),this._waitForPeerConnectionConnectedPromiseReject&&this._waitForPeerConnectionConnectedPromiseReject(new V({code:b.API_CALL_ABORTED,message:"connection closed"}))}getDTLSTransportState(){if(!this._peerConnection)return ur;let t=null;if(this._isUplink){if(!zn()||this._peerConnection.getSenders().length===0)return ur;t=this._peerConnection.getSenders()[0].transport}else{if(!Ur()||this._peerConnection.getReceivers().length===0)return ur;t=this._peerConnection.getReceivers()[0].transport}return t?t.state:ur}onConnectionStateChange(t){let e=this._peerConnection.iceConnectionState,r=this.getDTLSTransportState();if(this._log.info(`connectionState: ${t.target.connectionState}, ICE: ${e}, DTLS: ${r}`),t.target.connectionState===Oe.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),t.target.connectionState===Oe.FAILED||t.target.connectionState===Oe.CLOSED){let n=`connection ${t.target.connectionState}. ICE Transport state: ${e}, DTLS Transport state: ${r}`,s=new V({message:n,code:b.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection(),this._isErrorObserved||this._emitter.emit("error",s)}(t.target.connectionState===Oe.CONNECTED||t.target.connectionState===Oe.COMPLETED)&&(this.logSelectedCandidate(),Ae.logSuccessEvent({userId:this._room.userId,eventType:oi.ICE_CONNECTION_STATE}),this.emitConnectionStateChangedEvent("CONNECTED"))}emitConnectionStateChangedEvent(t){return t===this._currentState?!1:(t==="CONNECTED"?(Ya=0,qa=!1,Qa=!0,Cs.add(this)):Cs.delete(this),C.emit(S.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:t,remoteUserId:this._isUplink?void 0:this.userId}),this._emitter.emit("connection-state-changed",{prevState:this._currentState,state:t}),this._currentState=t,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}logSelectedCandidate(){return T(this,null,function*(){if(!this._peerConnection)return;let t=yield this._peerConnection.getStats();for(let[,e]of t)if(Bi(e)){let r=t.get(e.localCandidateId),n=t.get(e.remoteCandidateId);r&&(this._log.info(`local candidate: ${r.candidateType} ${r.protocol}:${r.ip||r.address}:${r.port} ${r.networkType||""} ${r.candidateType==="relay"?`relayProtocol:${r.relayProtocol}`:""}`),this._localAddress=`${r.ip||r.address}:${r.port}`),n&&(this._log.info(`remote candidate: ${n.candidateType} ${n.protocol}:${n.ip||n.address}:${n.port}`),this._remoteAddress=`${n.protocol}:${n.ip||n.address}`);break}})}getCurrentState(){return this._currentState}waitForPeerConnectionConnected(){return this._waitForPeerConnectionConnectedPromise?this._waitForPeerConnectionConnectedPromise:(this._waitForPeerConnectionConnectedPromise=new Promise((t,e)=>{if(this._currentState==="CONNECTED")return t();this._waitForPeerConnectionConnectedPromiseReject=e;let r=a=>{a.state==="CONNECTED"&&(clearTimeout(o),s(),t())},n=({room:a})=>{a===this._room&&(clearTimeout(o),s(),e(new V({code:b.API_CALL_ABORTED,message:H({key:$.CONNECTION_ABORTED,data:"leave room"})})))},s=()=>{C.off(S.LEAVE_SUCCESS,n,this),this._emitter.off("connection-state-changed",r,this)},o=setTimeout(()=>{s();let a=new V({code:b.API_CALL_TIMEOUT,message:"connection timeout"});Ya+=1,Xh(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),qa=!0,this._emitter.emit("firewall-restriction")),e(a)},md);C.on(S.LEAVE_SUCCESS,n,this),this._emitter.on("connection-state-changed",r,this)}),this._waitForPeerConnectionConnectedPromise=this._waitForPeerConnectionConnectedPromise.finally(()=>{this._waitForPeerConnectionConnectedPromise=null,this._waitForPeerConnectionConnectedPromiseReject=null}),this._waitForPeerConnectionConnectedPromise)}getReconnectionCount(){return this._reconnectionCount}startReconnection(){this._isReconnecting=!0,this.reconnect()}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}stopReconnection(){this._log.info("stop reconnection"),this._isReconnecting=!1,this._reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(ve.CONNECTED,this.reconnect,this)}beforeReconnect(){if(this._reconnectionTimer!==-1)return this._log.warn("reconnect() is reconnecting, ignore"),-1;if(this._reconnectionCount>=lr()){this._log.warn(`SDK has tried reconnect for ${this._reconnectionCount} times, but all failed, please check your network`),this.stopReconnection();let t=new V({code:this._isUplink?b.UPLINK_RECONNECTION_FAILED:b.DOWNLINK_RECONNECTION_FAILED,message:H({key:this._isUplink?$.UPLINK_RECONNECTION_FAILED:$.DOWNLINK_RECONNECTION_FAILED})});return this.emitConnectionStateChangedEvent("DISCONNECTED"),this._emitter.emit("error",t),-1}return this._signalChannel.isConnected?(this._reconnectionCount+=1,this._log.warn(`reconnect() trying [${this._reconnectionCount}]`),1):(this._log.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this._signalChannel.once(ve.CONNECTED,this.reconnect,this),-1)}on(t,e,r){this._emitter.on(t,e,r)}off(t,e,r){this._emitter.off(t,e,r)}getIsReconnecting(){return this._isReconnecting}get isH264(){var t,e;return!!((e=(t=this._peerConnection)==null?void 0:t.remoteDescription)!=null&&e.sdp.includes("H264"))}};var pD=h(_()),tc=h(ol());var Rt=function(i){return tc.default.parse(i)},Ci=function(i){return tc.default.write(i)},al=function(i){let t=Rt(i);return t.media.forEach(e=>{e.type===f.AUDIO&&e.fmtp.forEach(r=>{r.config+=";sprop-stereo=1;stereo=1"})}),Ci(t)};function cl(i){let t=Rt(i);return t.media.forEach(e=>{var r,n;if(e.type===f.VIDEO){let s=new Set;e.rtp.forEach(({payload:a,codec:c})=>c==="H264"&&s.add(a)),e.fmtp.forEach(({payload:a,config:c})=>{let d=c.match(/apt=(\d+)/);d&&d[1]&&s.has(Number(d[1]))&&s.add(a)});let o=({payload:a})=>!s.has(a);e.rtp=e.rtp.filter(o),e.rtcpFb=(r=e.rtcpFb)==null?void 0:r.filter(o),e.fmtp=e.fmtp.filter(o),e.payloads=(n=e.payloads)==null?void 0:n.split(" ").filter(a=>!s.has(Number(a))).join(" ")}}),Ci(t)}var hD=h(_());function vs(i){return Object.keys(i).filter(t=>i[t])}var ic=class extends st{constructor(e){super(ie(w({},e),{isUplink:!1}));p(this,"_flag",0);p(this,"role","anchor");p(this,"remoteAudioTrack");p(this,"remoteVideoTrack");p(this,"remoteAuxiliaryTrack");p(this,"ssrc",{audio:0,video:0,auxiliary:0});p(this,"_isSDPExchanging",!1);this.flag=e.flag,this.remoteAudioTrack=new cs(this._room,this),this.remoteVideoTrack=new Kr(this._room,this),this.remoteAuxiliaryTrack=new ds(this._room,this)}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(this.remoteVideoTrack.mediaType&8?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return Vi(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var r,n,s;e!==this._flag&&(this._flag=e,(r=this.remoteAudioTrack)==null||r.onFlagChanged(),(n=this.remoteVideoTrack)==null||n.onFlagChanged(),(s=this.remoteAuxiliaryTrack)==null||s.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===f.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){super.initialize(),this.installEvents(),this._peerConnection.ontrack=this.onTrack.bind(this)}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents()}installEvents(){}uninstallEvents(){this._emitter.removeAllListeners()}emitConnectionStateChangedEvent(e){var s,o;let r=this._currentState,n=super.emitConnectionStateChangedEvent(e);return n&&r!==e&&((s=this.remoteVideoTrack)==null||s.emit("connection-state-changed",{prevState:r,state:e}),(o=this.remoteAuxiliaryTrack)==null||o.emit("connection-state-changed",{prevState:r,state:e})),n}onTrack(e){let r=e.streams[0],{track:n}=e,s=r.id===Rn?f.MAIN:f.AUXILIARY;this._log.debug(`ontrack ${s} ${n.kind}`);let o=f.AUDIO;n.kind===f.VIDEO&&(o=s===f.MAIN?f.VIDEO:f.AUXILIARY);let a=this.remoteAudioTrack;o===f.VIDEO?a=this.remoteVideoTrack:o===f.AUXILIARY&&(a=this.remoteAuxiliaryTrack),a.setMediaStream(r),a.setMediaStreamTrack(n)}addRRTRLine(e){let r=e.split(`\r
`),n=new Map;r.forEach((o,a)=>{/^a=rtcp-fb:/.test(o)&&r[a+1]&&!/^a=rtcp-fb:/.test(r[a+1])&&n.set(a+1,`${o.match(/^a=rtcp-fb:\d+/)[0]} rrtr`)});let s=[...n];for(let o=0;o<s.length;o++){let[a,c]=s[o];r.splice(a+o,0,c)}return r.join(`\r
`)}addSPSDescription(e){let r=Rt(e);return r.media.forEach(n=>{n.type===f.VIDEO&&n.fmtp.forEach(s=>{s.config+=";sps-pps-idr-in-keyframe=1"})}),Ci(r)}removeSDESDescription(e){let r=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],n=Rt(e);return n.media.forEach(s=>{!s.ext||(s.ext=s.ext.filter(o=>!r.includes(o.uri)))}),Ci(n)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}isSubscribeSmall(e){return y(e.smallVideo)&&!this.subscribeState.smallVideo}subscribe(e,r){return T(this,null,function*(){var n,s;try{if((((n=this._peerConnection)==null?void 0:n.connectionState)===Oe.NEW||((s=this._peerConnection)==null?void 0:s.connectionState)===Oe.CONNECTING)&&(yield this.waitForPeerConnectionConnected()),this.isSubscriptionStateNotChanged(e)){this._peerConnection||(this.initialize(),yield this.connect(e));return}if(this._peerConnection||this._isSDPExchanging){let o="subscribe_change";Object.values(e).find(a=>a===!0)||(o="unsubscribe"),yield this.sendSubscription(o,e)}else this.initialize(),yield this.connect(e)}catch(o){throw this._room.isJoined&&this.isStreamUnpublished(r)?(this._log.warn(`${o.message} ${JSON.stringify(this.muteState)}`),new V({code:b.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId} unpublished stream`})):o}})}unsubscribe(n){return T(this,arguments,function*({remoteTracks:e,streamType:r}){if(this._currentState==="CONNECTED"&&(r==="main"&&!this.isMainStreamSubscribed||r==="auxiliary"&&!this.isAuxStreamSubscribed)){this._log.info(`${r} stream already unsubscribed`);return}let s=w({},this.subscribeState);e.forEach(a=>{switch(a.mediaType){case 1:s.audio=!1;break;case 4:s.video=!1;break;case 8:s.smallVideo=!1;break;case 2:s.auxiliary=!1;break;default:break}});let o="subscribe_change";Object.values(s).find(a=>a===!0)||(o="unsubscribe"),this._log.info(`${o==="unsubscribe"?o:"subscribe"} ${r} [${vs(s)}]`),yield this.sendSubscription(o,s),o==="unsubscribe"&&(this.remoteAudioTrack.setMediaStreamTrack(null),this.remoteVideoTrack.setMediaStreamTrack(null),this.remoteAuxiliaryTrack.setMediaStreamTrack(null),this.closePeerConnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"))})}sendSubscription(e,r=this.subscribeState){let n={srcTinyId:this.tinyId,srcUserId:this.userId},s=pe.UNSUBSCRIBE,o=se.UNSUBSCRIBE_RESULT;return e==="subscribe_change"&&(n={audio:r.audio,bigVideo:r.video,auxVideo:r.auxiliary,smallVideo:r.smallVideo,srcTinyId:this.tinyId},s=pe.SUBSCRIBE_CHANGE,o=se.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:s,data:n,responseCommand:o,timeout:1e4}).then(({data:a})=>{if(a.code!==0){let c=new V({code:a.code,message:H({key:$.ERROR_MESSAGE,data:{type:e,message:a.message}})});throw this._log.error(c),c}})}connect(){return T(this,arguments,function*(e=this.subscribeState){try{yield this.exchangeSDP(e),yield this.waitForPeerConnectionConnected()}catch(r){throw this.closePeerConnection(!0),r}})}exchangeSDP(e){return T(this,null,function*(){try{this._isSDPExchanging=!0,yield this.createOffer(),this._log.info("createOffer success, sending offer");let{type:r,sdp:n}=this._peerConnection.localDescription,s={type:r,sdp:n,srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo},o=yield this._signalChannel.sendWaitForResponse({command:pe.SUBSCRIBE,commandDesc:"exchange sdp",data:s,responseCommand:se.SUBSCRIBE_RESULT,timeout:pd});if(!this._peerConnection){let a=new V({code:b.INVALID_OPERATION,message:H({key:$.CONNECTION_CLOSED})});throw this._log.warn(a),a}yield this.onSubscribeResult(o),this._isSDPExchanging=!1}catch(r){throw this._isSDPExchanging=!1,r}})}createOffer(){return T(this,null,function*(){let e={voiceActivityDetection:!1};Vr()&&this._sdpSemantics===ai?(this._peerConnection.addTransceiver(f.AUDIO,{direction:he.RECVONLY}),this._peerConnection.addTransceiver(f.VIDEO,{direction:he.RECVONLY}),this._peerConnection.addTransceiver(f.VIDEO,{direction:he.RECVONLY})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);let r=yield this._peerConnection.createOffer(e);if(r.sdp){let{isH264DecodeSupported:n}=yield Xn();n||(this._log.warn("remove h264 desc from sdp"),r.sdp=cl(r.sdp)),r.sdp=this.addRRTRLine(r.sdp),r.sdp=this.addSPSDescription(r.sdp),r.sdp=al(r.sdp),this._sdpSemantics===ai&&(r.sdp=this.removeSDESDescription(r.sdp))}yield this._peerConnection.setLocalDescription(r)})}onSubscribeResult(e){return T(this,null,function*(){let{code:r,message:n=""}=e&&e.data||{},{type:s,sdp:o}=e&&e.data&&e.data.data||{};if(r===vn)throw new V({code:b.NOT_SUPPORTED_H264,message:H({key:$.NOT_SUPPORTED_H264DECODE})});try{if(r!==0)throw new V({code:r,message:H({key:$.EXCHANGE_SDP_FAILED,data:{errMsg:n}})});this._log.debug(`accept remote answer: ${o}`),yield this._peerConnection.setRemoteDescription({type:s,sdp:o}),this.updateSSRC(o)}catch(a){throw this._log.error(a),a}})}updateSSRC(e){try{Rt(e).media.forEach(n=>{if(!!n.ssrcs)if(n.type===f.AUDIO){let s=n.ssrcs.find(o=>{var a;return(a=o.value)==null?void 0:a.includes(Rn)});s&&(this.ssrc.audio=Number(s.id))}else{let s=n.ssrcs.find(a=>{var c;return(c=a.value)==null?void 0:c.includes(Rn)}),o=n.ssrcs.find(a=>{var c;return(c=a.value)==null?void 0:c.includes(ad)});s&&(this.ssrc.video=Number(s.id)),o&&(this.ssrc.auxiliary=Number(o.id))}})}catch(r){}}getSubscribeState(){return this.subscribeState}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}reconnect(){return T(this,null,function*(){if(!(ri(ic.prototype,this,"beforeReconnect").call(this)<0))try{this.closePeerConnection(),this.initialize(),yield this.connect(),this.stopReconnection(),this._log.warn("reconnect() success")}catch(r){let n=mt(this._reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${n/1e3}s`),this._reconnectionTimer=setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},n)}})}getIsReconnecting(){return this._isReconnecting}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}getCurrentState(){return this._currentState}setDelay({audioDelay:e,videoDelay:r}){this.remoteAudioTrack.stat.end2EndDelay=e,this.remoteVideoTrack.stat.end2EndDelay=r}},tn=ic;G([ce(i=>function(...t){return new Promise((e,r)=>{let n=s=>{this._emitter.off("closed",n),r(new V({code:b.API_CALL_ABORTED,message:H({key:$.CONNECTION_ABORTED,data:s})}))};this._emitter.on("closed",n),i.apply(this,t).then(e,r).finally(()=>{this._emitter.off("closed",n)})})})],tn.prototype,"subscribe",1),G([os(st.prototype.afterConnect),ss(st.prototype.beforeConnect)],tn.prototype,"connect",1);var ul=tn;var gO=h(_());var LD=h(_(),1);var ys=new Map;function ll(i){let t=Mt(),e=t.createMediaStreamDestination(),r=[];i.forEach(s=>{let o=new MediaStream;o.addTrack(s);let a=t.createMediaStreamSource(o);a.connect(e),r.push(a)});let n=e.stream.getAudioTracks()[0];return ys.set(n,{destination:e,track:n,mediaStreamSourceList:r}),n}function pl(i){if(ys.has(i)){let{destination:t,track:e,mediaStreamSourceList:r}=ys.get(i);e.stop(),t.disconnect(),r.forEach(n=>{n.disconnect()}),ys.delete(i)}}var zD=h(_());var UD=h(_());var r_="let width,height,offscreen,ctx;onmessage=function(e){const{action,data}=e.data;switch(action){case'render':offscreen=data.canvas;width=offscreen.width;height=offscreen.height;ctx=offscreen.getContext('2d');draw(data.readable,data.writable);break}};function draw(readable,writable){const transformer=new TransformStream({async transform(cameraFrame,controller){ctx.drawImage(cameraFrame,0,0,width,height);const frame=new VideoFrame(offscreen,{timestamp:cameraFrame.timestamp});cameraFrame.close();controller.enqueue(frame)}});readable.pipeThrough(transformer).pipeTo(writable)}",n_=new Blob([r_],{type:"application/javascript"}),rc=class{constructor(t){p(this,"width");p(this,"height");p(this,"canvas");p(this,"offscreen");p(this,"smallGenerator");p(this,"smallWritable");p(this,"bigProcessor");p(this,"bigReadable");p(this,"worker");let{videoTrack:e}=t;this.width=void 0,this.height=void 0,this.canvas=null,this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:e}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(n_)),M.info("init worker processor success")}catch(t){M.warn(`init worker processor failed. ${t.error}`)}}setCanvasRect(t,e){this.width=t,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generateVideoTrack(){let t=new MediaStream([this.smallGenerator]);return t==null?void 0:t.getTracks()[0]}destroy(){this.worker.terminate()}},ml=rc;var BD=h(_());var nc=class{constructor(t){p(this,"_player");p(this,"_canvas");p(this,"_canvasCtx");this._player=t,this._canvas=document.createElement("canvas"),this._canvasCtx=this._canvas.getContext("2d")}setCanvasRect(t,e){!this._canvas||(this._canvas.width=t,this._canvas.height=e)}drawVideoToCanvas(){let t=this._player.getElement();this._canvas&&this._canvasCtx&&t&&this._canvasCtx.drawImage(t,0,0,this._canvas.width,this._canvas.height)}generateVideoTrack(t){return this._canvas.captureStream(t).getVideoTracks()[0]}generateStreamFromTrack(t){let e=new MediaStream;return e.addTrack(t),e}destroy(){var t;(t=this._player)==null||t.stop(),this._canvas&&(this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._canvasCtx=null)}get canvas(){return this._canvas}get canvasCtx(){return this._canvasCtx}get canDrawVideoToCanvas(){if(this._player){let t=this._player.getElement();if(t)return t.readyState===t.HAVE_ENOUGH_DATA}return!1}},sc=nc;var oc=class{constructor(t){p(this,"_player");p(this,"_processor");p(this,"_initOffscreenSuccess");p(this,"_localVideoTrack");p(this,"_interval");this._localVideoTrack=t,this._player=t.player,this._processor=null,this._initOffscreenSuccess=!1}initialize(){return T(this,null,function*(){if(Uo()&&(navigator==null?void 0:navigator.hardwareConcurrency)>=6)try{yield this.initOffscreen(),this._initOffscreenSuccess=!0,M.info("Initialize VideoGenerator successfully!")}catch(t){this.initCanvas()}else this.initCanvas()})}generateSmallVideoTrack(t){let e=this.getSmallVideoProfile(t),r;return this._initOffscreenSuccess?(this._processor.setCanvasRect(e.width,e.height),r=this._processor.generateVideoTrack(e.frameRate)):(this._processor.setCanvasRect(e.width,e.height),this._player.setRect(e.width,e.height),r=this._processor.generateVideoTrack(e.frameRate),this._interval=le.run(jt,this.render.bind(this),{fps:e.frameRate})),r}render(){this._processor instanceof sc&&this._processor.drawVideoToCanvas()}destroy(){le.clearTask(this._interval),this._processor&&this._processor.destroy()}initOffscreen(){this._processor=new ml({videoTrack:this._localVideoTrack.mediaTrack})}initCanvas(){this._player=new _i({track:this._localVideoTrack.mediaTrack,muted:!0,objectFit:"cover",mirror:!1,container:null,id:"video-player",log:this._localVideoTrack.log}),this._player.play().then(()=>{M.info("VideoGenerator: play local video success")}).catch(()=>{M.error("VideoGenerator: Failed to play local video")}),this._processor=new sc(this._player)}getSmallVideoProfile(t){let e=this._localVideoTrack.mediaTrack,r=this._localVideoTrack.profile;if(mi){let c=e.getSettings();c&&c.width&&c.height&&(r.width=c.width,r.height=c.height)}let n,s=r.width*r.height,o=t.width*t.height;return M.info(`big res: ${r.width}*${r.height} small res: ${t.width}*${t.height} `),s>o?n=s/o:(M.warn(`Small stream resolution is larger than big stream, which is invalid. big: ${r.width} * ${r.height} small: ${t.width} * ${t.height}`),n=s/(160*120)),{width:r.width/Math.sqrt(n),height:r.height/Math.sqrt(n),frameRate:t.frameRate}}},rn=oc;var hl={voiceActivityDetection:!1},ac=class extends st{constructor(e){super(ie(w({},e),{isUplink:!0}));p(this,"localMainAudioTrack",null);p(this,"localMainVideoTrack",null);p(this,"localAuxAudioTrack",null);p(this,"localAuxVideoTrack",null);p(this,"ssrc",{audio:0,video:0,small:0,auxiliary:0});p(this,"_mixedAudioTrack",null);p(this,"_isSDPExchanging",!1);p(this,"_isPublishingAux",!1);p(this,"_publishingLocalAudioTrack");p(this,"_publishingLocalVideoTrack");p(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0});p(this,"_smallGenerator");p(this,"_audioManager");this._audioManager=e.audioManager,this._smallGenerator=null}get isMainStreamPublished(){return!!(this.localMainAudioTrack||this.localMainVideoTrack)}get isAuxStreamPublished(){return!!(this.localAuxVideoTrack||this.localAuxAudioTrack)}get publishState(){var r,n,s,o;let e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let a=this._peerConnection.getSenders();a&&(Qt()?(e.audio=!!((r=a[0])!=null&&r.track),e.bigVideo=!!((n=a[1])!=null&&n.track),e.smallVideo=!!((s=a[2])!=null&&s.track),e.auxVideo=!!((o=a[3])!=null&&o.track)):a.forEach(c=>{c.track&&(c.track.kind===f.AUDIO?e.audio=!0:(e.bigVideo=!0,this._smallGenerator&&(e.smallVideo=!0)))}))}return e}initialize(){super.initialize(),this.installEvents()}reset(){this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){this._emitter.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this._emitter.on("connection-state-changed",this.handleConnectionStateChange,this)}uninstallEvents(){this._emitter.off("connection-state-changed",this.handleConnectionStateChange,this)}emitConnectionStateChangedEvent(e,r){var o,a,c;let n=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&n!==e&&(r?r.emit("connection-state-changed",{prevState:n,state:e}):((o=this.localMainVideoTrack)==null||o.emit("connection-state-changed",{prevState:n,state:e}),(a=this.localAuxVideoTrack)==null||a.emit("connection-state-changed",{prevState:n,state:e}),(c=this._publishingLocalVideoTrack)==null||c.emit("connection-state-changed",{prevState:n,state:e}))),s}publish(s){return T(this,arguments,function*({localAudioTrack:e,localVideoTrack:r,isAuxiliary:n}){var a;this._peerConnection||this.initialize(),e&&(this._publishingLocalAudioTrack=e),r&&(this._publishingLocalVideoTrack=r),this._isPublishingAux=n;let o;return r&&!n&&r.small&&(this._smallGenerator=new rn(r),yield this._smallGenerator.initialize(),o=this._smallGenerator.generateSmallVideoTrack(r.small)),this.updateMediaSettings(),Vr()?yield this.publishByTransceiver({localAudioTrack:e,localVideoTrack:r,smallTrack:o,isAuxiliary:n}):yield this.publishByAddTrack({localAudioTrack:e,localVideoTrack:r,smallTrack:o}),this._publishingLocalAudioTrack=null,this._publishingLocalVideoTrack=null,this._isPublishingAux=!1,n?(r&&(this.localAuxVideoTrack=r),e&&(this.localAuxAudioTrack=e)):(r&&(this.localMainVideoTrack=r),e&&(this.localMainAudioTrack=e)),(a=this._sei)==null||a.handleEncodedStreams(),this.installTrackMuteEvents(e,r),this.sendMutedFlag(),{localAudioTrack:e,localVideoTrack:r}})}publishByTransceiver(o){return T(this,arguments,function*({localAudioTrack:e,localVideoTrack:r,smallTrack:n,isAuxiliary:s}){var l,m;this._log.info("publish by transceiver");let a=new MediaStream;r&&Bn&&yd&&r.genCanvasTrack();let c=(r==null?void 0:r.canvasTrack)||(r==null?void 0:r.mediaTrack),d=(l=this._audioManager)!=null&&l.isNeedToUseDestination()?(m=this._audioManager)==null?void 0:m.mediaStreamTrack:e==null?void 0:e.mediaTrack;d&&a.addTrack(d),c&&a.addTrack(c);let u=this._peerConnection.getTransceivers();if(u.length===0)this._peerConnection.addTransceiver(d||f.AUDIO,{direction:he.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(s?f.VIDEO:c||f.VIDEO,{direction:he.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(n||f.VIDEO,{direction:he.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(s?c||f.VIDEO:f.VIDEO,{direction:he.SENDONLY,streams:[a]}),yield this.connect();else{let I=[];if(d&&(u[0].sender.track?yield u[0].sender.replaceTrack(d):(yield u[0].sender.replaceTrack(d),I.push(0)),yield this.setBandwidth({bandwidth:(e==null?void 0:e.profile.bitrate)||40,type:f.AUDIO})),c){let E=s?3:1;yield u[E].sender.replaceTrack(c),yield this.setBandwidth({bandwidth:r.profile.bitrate,type:f.VIDEO,videoType:s?f.AUXILIARY:f.BIG}),I.push(E),n&&(yield u[2].sender.replaceTrack(n),yield this.setBandwidth({bandwidth:r.small.bitrate,type:f.VIDEO,videoType:f.SMALL}),I.push(2))}yield this.setTransceiverDirection(he.SENDONLY,I),yield this.doPublishChange(),r==null||r.emit("connection-state-changed",{prevState:"DISCONNECTED",state:"CONNECTING"}),r==null||r.emit("connection-state-changed",{prevState:"CONNECTING",state:"CONNECTED"})}})}publishByAddTrack(s){return T(this,arguments,function*({localAudioTrack:e,localVideoTrack:r,smallTrack:n}){var d;this._log.info("publish by addtrack");let o=r==null?void 0:r.mediaTrack,a=e!=null&&e.mediaTrack?(d=this._audioManager)==null?void 0:d.mediaStreamTrack:null;if(this._peerConnection&&this._peerConnection.connectionState!=="new"){a&&(yield this.addTrack(a,e)),o&&(yield this.addTrack(o,r));return}let c=new MediaStream;if(a&&c.addTrack(a),o&&c.addTrack(o),a&&this._peerConnection.addTrack(a,c),o&&(this._peerConnection.addTrack(o,c),n)){let u=new MediaStream;u.addTrack(n),this._peerConnection.addTrack(n,u)}yield this.connect()})}installTrackMuteEvents(...e){e.forEach(r=>{r&&(r==null||r.on("mute",this.sendMutedFlag,this),r==null||r.on("unmute",this.sendMutedFlag,this))})}uninstallTrackMuteEvents(...e){e.forEach(r=>{r&&(r==null||r.off("mute",this.sendMutedFlag,this),r==null||r.off("unmute",this.sendMutedFlag,this))})}unpublish(n){return T(this,arguments,function*({localAudioTrack:e,localVideoTrack:r}){var u,l,m,I;if(!Qt()){if(e&&e.mediaTrack&&!r&&this.localMainVideoTrack){yield this.removeTrack(e.mediaTrack,e),this.localMainAudioTrack=null;return}if(r&&r.mediaTrack&&!e&&this.localMainAudioTrack){yield this.removeTrack(r.mediaTrack,r),this.localMainVideoTrack=null;return}let E=yield this.doUnpublish();return this.uninstallTrackMuteEvents(e,r),this.emitConnectionStateChangedEvent("DISCONNECTED",r),E}let s=r&&r===this.localAuxVideoTrack,o=e==null?void 0:e.mediaTrack,a=r==null?void 0:r.mediaTrack,c=this._peerConnection.getSenders(),d=[];if(o)if((u=this._audioManager)!=null&&u.isNeedToUseDestination()){if(((l=this._audioManager)==null?void 0:l.hasAudioTrack)&&this._audioManager.hasMusic&&(this._audioManager.destroyAllMusic(),yield c[0].replaceTrack(null)),this._audioManager.hasAudioTrack&&this._audioManager.hasScreenAudioTrack){let E=s?(m=this.localMainAudioTrack)==null?void 0:m.mediaTrack:(I=this.localAuxAudioTrack)==null?void 0:I.mediaTrack;yield c[0].replaceTrack(E||null)}}else yield c[0].replaceTrack(null),d.push(0),this.localMainAudioTrack=null;a&&(s?(yield c[3].replaceTrack(null),this.localAuxVideoTrack=null,this._mediaSettings=ie(w({},this._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),d.push(3)):(yield c[1].replaceTrack(null),yield c[2].replaceTrack(null),this.localMainVideoTrack=null,this._mediaSettings=ie(w({},this._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),d.push(1,2))),this.isMainStreamPublished||this.isAuxStreamPublished?(yield this.setTransceiverDirection(he.INACTIVE,d),yield this.doPublishChange(!1)):yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,r),r==null||r.emit("connection-state-changed",{prevState:this._currentState,state:"DISCONNECTED"})})}doPublishChange(e=!0){return T(this,null,function*(){let r={state:this.publishState,constraintConfig:this._mediaSettings},n=yield this._signalChannel.sendWaitForResponse({command:pe.PUBLISH_STATE_CHANGE,data:r,responseCommand:se.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(n.data.code,n.data.message)})}doUnpublish(e=!1){return this._signalChannel.sendWaitForResponse({command:pe.UNPUBLISH,commandDesc:"unpublish",responseCommand:se.UNPUBLISH_RESULT,enableLog:e}).catch(r=>{if(r.getCode()===b.API_CALL_TIMEOUT)return Promise.resolve();throw r})}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:r}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":r&&(this._mediaSettings.videoCodec="VP8");let n=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:s,localAuxVideoTrack:o}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?o=this._publishingLocalVideoTrack:s=this._publishingLocalVideoTrack),mi){if(n&&n.mediaTrack){let a=n.mediaTrack.getSettings();this._mediaSettings.audioChannel=a.channelCount||1,this._mediaSettings.audioBps=n.profile.bitrate*1e3,this._mediaSettings.audioFs=a.sampleRate||0}if(s&&s.mediaTrack){let a=s.mediaTrack.getSettings();this._mediaSettings.videoWidth=a.width||0,this._mediaSettings.videoHeight=a.height||0,this._mediaSettings.videoFps=a.frameRate||0,this._mediaSettings.videoBps=s.profile.bitrate*1e3,s.small&&(this._mediaSettings.smallVideoWidth=s.small.width,this._mediaSettings.smallVideoHeight=s.small.height,this._mediaSettings.smallVideoFps=s.small.frameRate,this._mediaSettings.smallVideoBps=s.small.bitrate*1e3)}if(o&&o.mediaTrack){let a=o.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=a.width||0,this._mediaSettings.auxVideoHeight=a.height||0,this._mediaSettings.auxVideoFps=a.frameRate||0,this._mediaSettings.auxVideoBps=o.profile.bitrate*1e3}}else n&&n.mediaTrack&&(this._mediaSettings.audioChannel=n.profile.channelCount,this._mediaSettings.audioBps=n.profile.bitrate*1e3,this._mediaSettings.audioFs=n.profile.sampleRate),s&&s.mediaTrack&&(this._mediaSettings.videoWidth=s.profile.width,this._mediaSettings.videoHeight=s.profile.height,this._mediaSettings.videoFps=s.profile.frameRate,this._mediaSettings.videoBps=s.profile.bitrate*1e3);this._log.info(`updateMediaSettings: ${JSON.stringify(this._mediaSettings)}`)}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:pe.UPDATE_CONSTRAINT_CONFIG,data:this._mediaSettings,responseCommand:se.UPDATE_CONSTRAINT_CONFIG_RES}).then(e=>{e.data.code!==0&&this._log.warn(e.data.message)}).catch(this._log.warn)}addTrack(e,r){return T(this,null,function*(){var s;if(!this._peerConnection)return;let n=r===this.localAuxAudioTrack||r===this.localAuxVideoTrack;this._log.info(`is adding ${e.kind} track to current published local ${n?f.AUXILIARY:f.MAIN} stream`),(s=this._sei)==null||s.handleEncodedStreams(),Qt()?yield this.addTrackByTransceiver(e,n):yield this.addTrackBySender(e,r)})}addTrackByTransceiver(e,r){return T(this,null,function*(){var s;let n=this._peerConnection.getTransceivers();if(e.kind===f.AUDIO)n[0].sender.track?(this.mixAudioTrack(n[0].sender.track,e),yield n[0].sender.replaceTrack(this._mixedAudioTrack)):yield n[0].sender.replaceTrack(e);else{let o=r?3:1;if(yield n[o].sender.replaceTrack(e),o===1&&((s=this.localMainVideoTrack)==null?void 0:s.small)){this._smallGenerator=new rn(this.localMainVideoTrack),yield this._smallGenerator.initialize();let a=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield n[2].sender.replaceTrack(a)}n[o].direction===he.INACTIVE&&(yield this.setTransceiverDirection(he.SENDONLY,[o]))}this.updateMediaSettings(),yield this.doPublishChange()})}addTrackBySender(e,r){return T(this,null,function*(){Qt()&&this._peerConnection.getTransceivers().findIndex(o=>o.direction==="stopped")>=0&&(this._log.warn("transceiver is stopping, negotiate sdp first"),yield this.updateOffer("remove",e));let n=this._peerConnection.getSenders().find(o=>o.track&&o.track.kind===e.kind);if(n&&n.track){this._log.warn("sender already exists, remove sender first");let o=n.track;this.removeSender(n),yield this.updateOffer("remove",o)}let{mediaStream:s}=r;if(this._peerConnection.addTrack(e,s),e.kind===f.VIDEO&&r instanceof it&&r.small){this._smallGenerator=new rn(r),yield this._smallGenerator.initialize();let o=this._smallGenerator.generateSmallVideoTrack(r.small),a=new MediaStream;a.addTrack(o),this._peerConnection.addTrack(o,a)}yield this.updateOffer("add",e)})}isNeedToResetOfferOrder(){if(this._sdpSemantics===pr||!this._peerConnection||!this._peerConnection.localDescription)return!1;let{sdp:e}=this._peerConnection.localDescription,r=Rt(e);for(let n=0;n<r.media.length;n++)if(Number(r.media[n].mid)===0&&r.media[n].type===f.VIDEO)return!0;return!1}removeSender(e){let r=null;Qt()&&(r=this._peerConnection.getTransceivers().find(n=>n.sender&&n.sender.track===e.track)),this._peerConnection.removeTrack(e),r&&oe(r.stop)&&(this._log.info("stop transceiver"),r.stop())}removeTrack(e,r){return T(this,null,function*(){if(!this._peerConnection)return;let n=r===this.localAuxAudioTrack||r===this.localAuxVideoTrack;this._log.info(`is removing ${e.kind} track from current published local ${n?f.AUXILIARY:f.MAIN} stream`),Qt()?yield this.removeTrackByTransceiver(e,n):yield this.removeTrackBySender(e)})}removeTrackByTransceiver(e,r){return T(this,null,function*(){var s,o;let n=this._peerConnection.getTransceivers();if(e.kind===f.AUDIO)if(this._mixedAudioTrack){let a=r?(s=this.localMainAudioTrack)==null?void 0:s.mediaTrack:(o=this.localAuxAudioTrack)==null?void 0:o.mediaTrack;yield n[0].sender.replaceTrack(a||null),this.destroyMixedAudioTrack()}else yield n[0].sender.replaceTrack(null);else{let a=r?3:1;yield n[a].sender.replaceTrack(null),a===1&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield n[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(he.INACTIVE,[a])}this.updateMediaSettings(),yield this.doPublishChange()})}setTransceiverDirection(e,r){return T(this,null,function*(){if(!$e)return;let n=!1,s=!1;this._log.info(`setting transceiver ${r.join(",")} direction to ${e}`);let o=this._peerConnection.getTransceivers();if(r.forEach(d=>{o[d].direction!==e&&(o[d].direction=e,n=!0)}),n){this._log.info("updating offer");let d=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(d)}let a=-1,c=this._peerConnection.remoteDescription.sdp.split(`\r
`).map(d=>{if(d.match(new RegExp(`a=(${he.INACTIVE}|${he.RECVONLY}|${he.SENDONLY})`))&&a++,r.includes(a)){if(e===he.INACTIVE&&d.includes(`a=${he.RECVONLY}`))return s=!0,`a=${e}`;if(e===he.SENDONLY&&d.includes(`a=${he.INACTIVE}`))return s=!0,`a=${he.RECVONLY}`}return d}).join(`\r
`);s&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:c}))})}removeTrackBySender(e){return T(this,null,function*(){var n,s;if(e.kind===f.VIDEO&&this.isNeedToResetOfferOrder()&&this.localMainAudioTrack){this.reset(),this.initialize(),(s=(n=this.localMainVideoTrack)==null?void 0:n.mediaStream)==null||s.removeTrack(e),yield this.publish({localAudioTrack:this.localMainAudioTrack,isAuxiliary:!1});return}let r=this._peerConnection.getSenders().find(o=>o.track===e);r&&(this.removeSender(r),e.kind===f.VIDEO&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,this._peerConnection.getSenders().forEach(o=>{o.track&&o.track.kind===f.VIDEO&&this.removeSender(o)}))),yield this.updateOffer("remove",e)})}replaceTrack(e,r){return T(this,null,function*(){var o,a,c;let n=(o=this._peerConnection)==null?void 0:o.getSenders();if(!n||n.length===0)return;let s=r===this.localAuxAudioTrack||r===this.localAuxVideoTrack;if(this._log.info(`is replacing ${e.kind} track on ${s?f.AUXILIARY:f.MAIN} stream`),e.kind===f.AUDIO&&n[0])if(this._mixedAudioTrack&&((a=this.localMainAudioTrack)==null?void 0:a.mediaTrack)&&((c=this.localAuxAudioTrack)==null?void 0:c.mediaTrack)){this.destroyMixedAudioTrack();let d=s?this.localMainAudioTrack.mediaTrack:this.localAuxAudioTrack.mediaTrack;this.mixAudioTrack(e,d),yield n[0].replaceTrack(this._mixedAudioTrack)}else yield n[0].replaceTrack(e);if(e.kind===f.VIDEO){if(!s&&n[1]&&(yield n[1].replaceTrack(e),this._smallGenerator&&n[2])){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new rn(this.localMainVideoTrack),yield this._smallGenerator.initialize();let d=this._smallGenerator.generateSmallVideoTrack(this._room.smallStreamConfig);yield n[2].replaceTrack(d)}s&&n[3]&&(yield n[3].replaceTrack(e))}})}updateOffer(e,r){return T(this,null,function*(){try{let n=yield this._peerConnection.createOffer(hl);$e&&n.sdp&&(n.sdp=this.setSDPDirection(n.sdp,"sendrecv")),yield this._peerConnection.setLocalDescription(n);let s=this.updateMediaSettings(),o={action:e,trackId:r.id,kind:r.kind===f.VIDEO?"bigVideo":r.kind,type:"offer",sdp:this._peerConnection.localDescription.sdp,constraintConfig:s,state:this.publishState};this._log.info("createOffer success, sending updated offer to remote server"),this._log.debug(`updatedOffer: ${o.sdp}`);let a=yield this._signalChannel.sendWaitForResponse({command:pe.PUBLISH_CHANGE,data:o,responseCommand:se.UPDATE_OFFER_RESULT,timeout:ld,commandDesc:"update offer"}),{code:c,message:d}=a.data;c!==0&&this.checkPublishResultCode(c,d),yield this.acceptAnswer(a.data.data),n.sdp&&this.updateSSRC(n.sdp)}catch(n){throw this._log.error(n),n}})}setBandwidth(o){return T(this,arguments,function*({bandwidth:e,type:r,videoType:n,sdp:s}){if(!Bo())return s?r===f.VIDEO?this.updateVideoBandwidthRestriction(s,e,n):this.updateAudioBandwidthRestriction(s,e):void 0;let a=0;r===f.VIDEO&&(n===f.SMALL?a=2:n===f.AUXILIARY?a=3:a=1);let c=this._peerConnection.getSenders()[a];if(c){let d=c.getParameters();(!d.encodings||d.encodings.length===0)&&(d.encodings=[{}]),d.encodings[0].maxBitrate=e*1e3;try{return yield c.setParameters(d),this._log.info(`${n||""}${r} bandwidth ${e} kbps`),s}catch(u){if(this._log.info(`failed to set bandwidth by setting maxBitrate: ${u}`),s)return r===f.VIDEO?this.updateVideoBandwidthRestriction(s,e,n):this.updateAudioBandwidthRestriction(s,e)}}return s})}updateVideoBandwidthRestriction(e,r,n){let s="AS";$e&&(s="TIAS",r=r*1e3);let o=0,a=-1;return n===f.SMALL?o=1:n===f.AUXILIARY&&(o=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,c=>(a+=1,a===o?`${c}b=${s}:${r}\r
`:c)),e}updateAudioBandwidthRestriction(e,r){let n="AS";return $e&&(n="TIAS",r=r*1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,`m=audio $1\r
c=IN $2\r
b=${n}:${r}\r
`),e}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}connect(){return T(this,null,function*(){try{yield this.exchangeSDP(),yield this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),this.uninstallEvents(),e}})}exchangeSDP(){return T(this,null,function*(){try{this._isSDPExchanging=!0,yield this.createOffer(),this._log.info("createOffer success, sending offer to remote server"),yield this.doExchangeSDP(),this._isSDPExchanging=!1}catch(e){throw this._isSDPExchanging=!1,e}})}createOffer(){return T(this,null,function*(){try{let e=yield this._peerConnection.createOffer(hl);yield this._peerConnection.setLocalDescription(e),e.sdp&&this.updateSSRC(e.sdp)}catch(e){throw e}})}doExchangeSDP(){let e={command:pe.PUBLISH,responseCommand:se.PUBLISH_RESULT,data:{type:this._peerConnection.localDescription.type,sdp:this.removeVideoOrientation(this._peerConnection.localDescription.sdp),screen:this.localMainVideoTrack instanceof It||this.localAuxVideoTrack instanceof It,state:this.publishState,constraintConfig:this._mediaSettings},enableLog:!1};return this._log.debug(`sending sdp offer: ${e.data.sdp}`),this._signalChannel.sendWaitForResponse(e).then(r=>{let{code:n,message:s,data:o}=r.data;return n===0?this.acceptAnswer(o):this.checkPublishResultCode(n,s)})}setSDPDirection(e,r,n="all"){let s=Rt(e);return s.media.forEach(o=>{(n==="all"||o.type===n)&&(o.direction=r)}),Ci(s)}acceptAnswer(e){return T(this,null,function*(){var r,n,s,o,a;try{let c;if(this._publishingLocalAudioTrack||this._publishingLocalVideoTrack||this.isMainStreamPublished){let l=((r=this._publishingLocalVideoTrack)==null?void 0:r.profile.bitrate)||((n=this.localMainVideoTrack)==null?void 0:n.profile.bitrate),m=((s=this._publishingLocalAudioTrack)==null?void 0:s.profile.bitrate)||((o=this.localMainAudioTrack)==null?void 0:o.profile.bitrate);if(l){let I=this._isPublishingAux?f.AUXILIARY:f.BIG;c=yield this.setBandwidth({bandwidth:l,type:f.VIDEO,sdp:c,videoType:I})}m&&(c=yield this.setBandwidth({bandwidth:m,type:f.AUDIO,sdp:c}))}if(c=this.removeVideoOrientation(e.sdp),(a=this._publishingLocalVideoTrack)!=null&&a.small){let{smallStreamConfig:l}=this._room;c=yield this.setBandwidth({bandwidth:l.bitrate,type:f.VIDEO,videoType:f.SMALL,sdp:c})}let u={type:e.type,sdp:c};yield this._peerConnection.setRemoteDescription(u),this._log.debug(`accepted answer: ${c}`)}catch(c){throw this._log.error(`failed to accept remote answer ${c}`),c}})}sendMutedFlag(e){var s,o,a;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let n={audio:!!((s=this.localMainAudioTrack)!=null&&s.muted),bigVideo:!!((o=this.localMainVideoTrack)!=null&&o.muted),auxVideo:!!((a=this.localAuxVideoTrack)!=null&&a.muted)};this._log.info(`send muted state: ${JSON.stringify(n)}`),this._signalChannel.send(pe.UPDATE_MUTE_STAT,n)}getIsReconnecting(){return this._isReconnecting}reconnect(){return T(this,null,function*(){if(!(ri(ac.prototype,this,"beforeReconnect").call(this)<0))try{yield this._signalChannel.sendWaitForResponse({command:pe.UNPUBLISH,responseCommand:se.UNPUBLISH_RESULT,enableLog:!1}),this.closePeerConnection(),this.initialize(),this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0})),this._log.warn("reconnect() uplink reconnect successfully"),this.stopReconnection()}catch(r){let n=mt(this._reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${n/1e3}s`),this._reconnectionTimer=setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},n)}})}handleConnectionStateChange(e){e.state==="CONNECTED"&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&C.emit(S.SEND_FIRST_VIDEO_FRAME,{room:this._room})}updateSSRC(e){try{Rt(e).media.forEach((n,s)=>{if(n.type===f.AUDIO){let o=n.ssrcs&&n.ssrcs[0];o&&(this.ssrc.audio=Number(o.id))}else{if(this._sdpSemantics===pr&&n.ssrcGroups){n.ssrcGroups.forEach((a,c)=>{let d=Number(a.ssrcs.split(" ")[0]);c===0?this.ssrc.video=d:c===1&&(this.ssrc.small=d)});return}let o=n.ssrcs&&n.ssrcs[0];if(!o)return;switch(s){case 1:this.ssrc.video=Number(o.id);break;case 2:this.ssrc.small=Number(o.id);break;case 3:this.ssrc.auxiliary=Number(o.id);break;default:break}}})}catch(r){}}getVideoTrackId(e=f.VIDEO){if(this._peerConnection){let r=this._peerConnection.getSenders();if(e===f.AUXILIARY&&r[3]&&r[3].track)return r[3].track.id;if(e===f.VIDEO&&r[1]&&r[1].track)return r[1].track.id}if(this.localMainVideoTrack&&e===f.VIDEO){let r=this.localMainVideoTrack.mediaTrack;if(r)return r.id}if(this.localAuxVideoTrack&&e===f.AUXILIARY){let r=this.localAuxVideoTrack.mediaTrack;if(r)return r.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,r){if(e!==0)throw e===vn?(this._log.error(He.NOT_SUPPORTED_H264ENCODE),new V({code:b.NOT_SUPPORTED_H264,message:H({key:$.NOT_SUPPORTED_H264ENCODE})})):new V({code:b.UNKNOWN,message:H({key:$.SIGNAL_RESPONSE_FAILED,data:{signalResponse:se.PUBLISH_RESULT,code:e,message:r}})})}sendSEI(e,r){var n;(n=this._sei)==null||n.push(e,r)}mixAudioTrack(e,r){this._log.info("mix audio track"),this._mixedAudioTrack=ll([e,r])}destroyMixedAudioTrack(){this._mixedAudioTrack&&(this._log.info("destroy audio track"),pl(this._mixedAudioTrack),this._mixedAudioTrack=null)}},nn=ac;G([ce(i=>function(...t){return new Promise((e,r)=>{let n=s=>{this._emitter.off("closed",n),r(new V({code:b.API_CALL_ABORTED,message:H({key:$.CONNECTION_ABORTED,data:s})}))};this._emitter.on("closed",n),i.apply(this,t).then(e,r).finally(()=>{this._emitter.off("closed",n)})})})],nn.prototype,"publish",1),G([os(st.prototype.afterConnect),ss(st.prototype.beforeConnect)],nn.prototype,"connect",1);var _l=nn;var LO=h(_());var sn=class{constructor(t,e){p(this,"_log");p(this,"_prevReportTime");p(this,"_prevReport",{});p(this,"_prevEncoderImplementation");p(this,"_prevQualityLimitationReason");p(this,"_prevDecoderImplementationMap",new Map);this._log=e,this._prevReportTime=0,this._prevEncoderImplementation="",this._prevQualityLimitationReason=""}get statInterval(){return this._prevReportTime===0?2:(Date.now()-this._prevReportTime)/1e3}getSenderStats(t){return T(this,null,function*(){var s;let e={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},r=t.getPeerConnection(),n=t.getSSRC();if(r)try{(yield r.getStats()).forEach(a=>{if(a.type==="outbound-rtp")if(a.mediaType===f.VIDEO){if(!$e&&y(a.trackId))return;a.ssrc===n.video&&!y(a.encoderImplementation)&&this._prevEncoderImplementation!==a.encoderImplementation&&(this._log.info(`encoderImplementation change to ${a.encoderImplementation}`),this._prevEncoderImplementation=a.encoderImplementation),a.ssrc===n.video&&!y(a.qualityLimitationReason)&&this._prevQualityLimitationReason!==a.qualityLimitationReason&&(this._log.info(`qualityLimitationReason change to ${a.qualityLimitationReason}`),this._prevQualityLimitationReason=a.qualityLimitationReason);let c=f.VIDEO;a.ssrc===n.small?c=f.SMALL:a.ssrc===n.auxiliary&&(c=f.AUXILIARY),e[c].bytesSent=a.bytesSent,e[c].packetsSent=a.packetsSent,e[c].framesEncoded=a.framesEncoded}else a.mediaType===f.AUDIO&&(e.audio.bytesSent=a.bytesSent,e.audio.packetsSent=a.packetsSent);else a.type==="candidate-pair"?Bi(a)&&de(a.currentRoundTripTime)&&(e.rtt=Math.floor(a.currentRoundTripTime*1e3)):a.type==="media-source"&&(a.kind===f.AUDIO?(e.audio.audioLevel=a.audioLevel||0,e.audio.totalAudioEnergy=a.totalAudioEnergy||0):a.kind===f.VIDEO&&(a.trackIdentifier===t.getVideoTrackId(f.VIDEO)?e.video.fpsCapture=a.framesPerSecond:a.trackIdentifier===t.getVideoTrackId(f.AUXILIARY)?e.auxiliary.fpsCapture=a.framesPerSecond:e.small.fpsCapture=a.framesPerSecond));if(y(a.audioLevel)||(e.audio.audioLevel=a.audioLevel||0),!y(a.frameWidth)){let c=f.SMALL;a.trackIdentifier===t.getVideoTrackId(f.VIDEO)||a.ssrc===n.video?c=f.VIDEO:(a.trackIdentifier===t.getVideoTrackId(f.AUXILIARY)||a.ssrc===n.auxiliary)&&(c=f.AUXILIARY),e[c].frameWidth=a.frameWidth,e[c].frameHeight=a.frameHeight,e[c].framesSent=a.framesSent}}),e.audio.audioLevel===0&&(e.audio.audioLevel=((s=t.localMainAudioTrack)==null?void 0:s.getInternalAudioLevel())||0)}catch(o){this._log.warn(`failed to getStats on sender connection ${o}`)}return e})}getReceiverStats(t){return T(this,null,function*(){let e={tinyId:t.tinyId,userId:t.userId,rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0,insertedSamplesForDeceleration:0,removedSamplesForAcceleration:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0}},r=t.getPeerConnection();if(r)try{let{ssrc:n}=t,{muteState:s}=t;(yield r.getStats()).forEach(a=>{if(a.type==="inbound-rtp"){if(a.mediaType===f.AUDIO&&a.ssrc===n.audio&&s.hasAudio){e.audio.packetsReceived=a.packetsReceived,e.audio.bytesReceived=a.bytesReceived,e.audio.packetsLost=a.packetsLost,a.insertedSamplesForDeceleration&&(e.audio.insertedSamplesForDeceleration=a.insertedSamplesForDeceleration),a.removedSamplesForAcceleration&&(e.audio.removedSamplesForAcceleration=a.removedSamplesForAcceleration);let{remoteAudioTrack:c}=t;c.stat.packetsReceived=a.packetsReceived,c.stat.bytesReceived=a.bytesReceived,c.stat.packetsLost=a.packetsLost,a.jitterBufferDelay&&(c.stat.jitterBufferDelay=Math.floor(a.jitterBufferDelay/a.jitterBufferEmittedCount*1e3)),e.hasAudio=!0}else if(a.mediaType===f.VIDEO){if($e&&a.bytesReceived===0)return;let c;a.ssrc===n.video&&s.hasVideo&&(e.video.packetsReceived=a.packetsReceived,e.video.bytesReceived=a.bytesReceived,e.video.packetsLost=a.packetsLost,e.video.framesReceived=a.framesReceived,e.video.framesDecoded=a.framesDecoded,e.video.fpsDecoded=a.framesPerSecond,e.hasVideo=!0,c=t.remoteVideoTrack,a.decoderImplementation&&(!this._prevDecoderImplementationMap.has(e.userId)||this._prevDecoderImplementationMap.get(e.userId)!==a.decoderImplementation)&&(this._log.info(`${e.userId} decoderImplementation change to ${a.decoderImplementation}`),this._prevDecoderImplementationMap.set(e.userId,a.decoderImplementation))),a.ssrc===n.auxiliary&&s.hasAuxiliary&&(e.auxiliary.packetsReceived=a.packetsReceived,e.auxiliary.bytesReceived=a.bytesReceived,e.auxiliary.packetsLost=a.packetsLost,e.auxiliary.framesReceived=a.framesReceived,e.auxiliary.framesDecoded=a.framesDecoded,e.auxiliary.fpsDecoded=a.framesPerSecond,c=t.remoteAuxiliaryTrack,e.hasAuxiliary=!0),c&&(c.stat.packetsReceived=a.packetsReceived,c.stat.bytesReceived=a.bytesReceived,c.stat.packetsLost=a.packetsLost,c.stat.framesReceived=a.framesReceived,c.stat.framesDecoded=a.framesDecoded,a.jitterBufferDelay&&(c.stat.jitterBufferDelay=Math.floor(a.jitterBufferDelay/a.jitterBufferEmittedCount*1e3)))}}else a.type==="candidate-pair"&&Bi(a)&&de(a.currentRoundTripTime)&&(e.rtt=Math.floor(a.currentRoundTripTime*1e3));y(a.frameWidth)||((a.trackIdentifier===t.getMainStreamVideoTrackId()||a.ssrc===n.video)&&(e.video.frameWidth=a.frameWidth,e.video.frameHeight=a.frameHeight,t.remoteVideoTrack.stat.frameWidth=a.frameWidth,t.remoteVideoTrack.stat.frameHeight=a.frameHeight),(a.trackIdentifier===t.getAuxStreamVideoTrackId()||a.ssrc===n.auxiliary)&&(e.auxiliary.frameWidth=a.frameWidth,e.auxiliary.frameHeight=a.frameHeight,t.remoteAuxiliaryTrack.stat.frameWidth=a.frameWidth,t.remoteAuxiliaryTrack.stat.frameHeight=a.frameHeight)),y(a.audioLevel)||(e.audio.audioLevel=a.audioLevel||0,e.audio.totalAudioEnergy=a.totalAudioEnergy||0)}),e.audio.audioLevel===0&&(e.audio.audioLevel=t.remoteAudioTrack.getInternalAudioLevel()||0)}catch(n){this._log.warn(`failed to getStats on receiver connection ${n}`)}return e})}getStats(t,e){return T(this,null,function*(){let r={};t&&(r=yield this.getSenderStats(t));let n=[];for(let[s,o]of e){let a=yield this.getReceiverStats(o);n.push(a)}return{senderStats:r,receiverStats:n}})}getDifferenceValue(t,e){if(Gi(t))return e;let r=e-t;return r<0?0:r}prepareReport({stats:t,report:e,freezeMap:r}){if(!Gi(t.senderStats)){let u={uint32_audio_level:t.senderStats.audio.audioLevel*ui,uint32_audio_energy:t.senderStats.audio.totalAudioEnergy*1e6,uint32_audio_codec_bitrate:t.senderStats.audio.bytesSent},l=[],m={uint32_video_stream_type:2,uint32_video_codec_fps:t.senderStats.video.framesSent,uint32_video_capture_fps:t.senderStats.video.fpsCapture,uint32_video_width:t.senderStats.video.frameWidth,uint32_video_height:t.senderStats.video.frameHeight,uint32_video_codec_bitrate:t.senderStats.video.bytesSent,uint32_video_enc_fps:t.senderStats.video.framesEncoded};if(l.push(m),t.senderStats.small.bytesSent){let E={uint32_video_stream_type:3,uint32_video_codec_fps:t.senderStats.small.framesSent||0,uint32_video_capture_fps:t.senderStats.small.fpsCapture||0,uint32_video_width:t.senderStats.small.frameWidth||0,uint32_video_height:t.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.small.bytesSent,uint32_video_enc_fps:t.senderStats.small.framesEncoded||0};l.push(E)}if(t.senderStats.auxiliary.bytesSent){let E={uint32_video_stream_type:7,uint32_video_codec_fps:t.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:t.senderStats.auxiliary.fpsCapture||0,uint32_video_width:t.senderStats.auxiliary.frameWidth||0,uint32_video_height:t.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:t.senderStats.auxiliary.framesEncoded||0};l.push(E)}let I={uint32_bitrate:0,uint32_lost:0,uint32_rtt:t.senderStats.rtt};e.msg_up_stream_info={msg_audio_status:u,msg_video_status:l,msg_network_status:I}}let{statInterval:n}=this;e.msg_down_stream_info=[],t.receiverStats.forEach(u=>{let l={msg_user_info:{str_identifier:u.userId,uint64_tinyid:u.tinyId},msg_network_status:{uint32_rtt:u.rtt,uint32_bitrate:0,uint32_lost:0},msg_audio_status:{},msg_video_status:[]};if(u.hasAudio){let m={uint32_audio_codec_bitrate:u.audio.bytesReceived,uint32_audio_total_bitrate:u.audio.bytesReceived,uint32_audio_level:u.audio.audioLevel*1e8,uint32_audio_energy:u.audio.totalAudioEnergy*1e6,uint32_audio_receive:u.audio.packetsReceived,uint32_audio_origin_lost:u.audio.packetsLost};l.msg_audio_status=m}if(u.hasVideo){let m=r.get(`${u.userId}_${cd}`),I=m?m.duration:0,E={uint32_video_stream_type:2,uint32_video_receive_fps:u.video.framesReceived,uint32_video_width:u.video.frameWidth,uint32_video_height:u.video.frameHeight,uint32_video_codec_bitrate:u.video.bytesReceived,uint32_video_receive:u.video.packetsReceived,uint32_video_origin_lost:u.video.packetsLost,uint32_video_block_time:I,uint32_video_dec_fps:u.video.framesDecoded};l.msg_video_status.push(E)}if(u.hasAuxiliary){let m=r.get(`${u.userId}_${An}`),I=m?m.duration:0,E={uint32_video_stream_type:7,uint32_video_receive_fps:u.auxiliary.framesReceived,uint32_video_width:u.auxiliary.frameWidth,uint32_video_height:u.auxiliary.frameHeight,uint32_video_codec_bitrate:u.auxiliary.bytesReceived,uint32_video_receive:u.auxiliary.packetsReceived+u.auxiliary.packetsLost,uint32_video_origin_lost:u.auxiliary.packetsLost,uint32_video_block_time:I,uint32_video_dec_fps:u.auxiliary.framesDecoded};l.msg_video_status.push(E)}e.msg_down_stream_info.push(l)});let s=this._prevReport;if(this._prevReport=JSON.parse(JSON.stringify(e)),e.msg_up_stream_info.msg_audio_status&&s.msg_up_stream_info.msg_audio_status){let u=s.msg_up_stream_info.msg_audio_status,l=e.msg_up_stream_info.msg_audio_status,m=this.getDifferenceValue(u.uint32_audio_codec_bitrate,l.uint32_audio_codec_bitrate);l.uint32_audio_codec_bitrate=Math.round(m*8/n),e.msg_up_stream_info.msg_network_status.uint32_bitrate+=l.uint32_audio_codec_bitrate}let o=s.msg_up_stream_info.msg_video_status;e.msg_up_stream_info.msg_video_status.forEach(u=>{let l=o.find(B=>B.uint32_video_stream_type===u.uint32_video_stream_type);if(!l||l.uint32_video_codec_bitrate===0){u.uint32_video_codec_bitrate=0,u.uint32_video_enc_fps=0,u.uint32_video_codec_fps=0;return}let m=l.uint32_video_codec_bitrate,I=l.uint32_video_enc_fps,E=l.uint32_video_codec_fps,N=this.getDifferenceValue(m,u.uint32_video_codec_bitrate);u.uint32_video_codec_bitrate=Math.round(N*8/n),e.msg_up_stream_info.msg_network_status.uint32_bitrate+=u.uint32_video_codec_bitrate,u.uint32_video_enc_fps=Math.round(this.getDifferenceValue(I,u.uint32_video_enc_fps)/n),u.uint32_video_codec_fps=Math.round(this.getDifferenceValue(E,u.uint32_video_codec_fps)/n)});let c=e.msg_down_stream_info,d=s.msg_down_stream_info;return c.forEach(u=>{let l=d.find(m=>m.msg_user_info.uint64_tinyid===u.msg_user_info.uint64_tinyid);if(!!l){if(u.msg_audio_status&&l.msg_audio_status){let m=u.msg_audio_status,I=l.msg_audio_status;m.uint32_audio_origin_lost=this.getDifferenceValue(I.uint32_audio_origin_lost,m.uint32_audio_origin_lost),m.uint32_audio_receive=this.getDifferenceValue(I.uint32_audio_receive,m.uint32_audio_receive),m.uint32_audio_receive+=m.uint32_audio_origin_lost;let E=this.getDifferenceValue(I.uint32_audio_codec_bitrate,m.uint32_audio_codec_bitrate);m.uint32_audio_codec_bitrate=Math.round(E*8/n),m.uint32_audio_total_bitrate=Math.round(E*8/n)}if(u.msg_video_status&&l.msg_video_status){let m=l.msg_video_status;u.msg_video_status=u.msg_video_status.filter(E=>m.find(N=>N.uint32_video_stream_type===E.uint32_video_stream_type)),u.msg_video_status.forEach(E=>{let N=m.find(J=>J.uint32_video_stream_type===E.uint32_video_stream_type),B=N.uint32_video_receive,x=N.uint32_video_origin_lost,F=N.uint32_video_codec_bitrate,Ee=N.uint32_video_receive_fps,A=N.uint32_video_dec_fps;E.uint32_video_origin_lost=this.getDifferenceValue(x,E.uint32_video_origin_lost),E.uint32_video_receive=this.getDifferenceValue(B,E.uint32_video_receive)+E.uint32_video_origin_lost;let U=this.getDifferenceValue(F,E.uint32_video_codec_bitrate);E.uint32_video_codec_bitrate=Math.round(U*8/n);let v=this.getDifferenceValue(Ee,E.uint32_video_receive_fps);E.uint32_video_receive_fps=Math.round(v/n),E.uint32_video_dec_fps=Math.round(this.getDifferenceValue(A,E.uint32_video_dec_fps)/n)})}}}),e}getStatsReport(n){return T(this,arguments,function*({uplinkConnection:t,downlinkConnections:e,freezeMap:r}){let s={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:0},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}}]},o=yield this.getStats(t,e);return JSON.stringify(this._prevReport)==="{}"&&(this._prevReport=JSON.parse(JSON.stringify(s))),this.prepareReport({stats:o,report:s,freezeMap:r}),this._prevReportTime=Date.now(),s})}reset(){this._prevReportTime=0,this._prevReport={},this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevDecoderImplementationMap=new Map}};var JO=h(_());var fl=h(ft());var cc=class extends fl.default{constructor({signalChannel:e,room:r}){super();p(this,"_room");p(this,"_signalChannel");p(this,"_log");p(this,"_uplinkRTT",0);p(this,"_uplinkLoss",0);p(this,"_downlinkRTT",0);p(this,"_downlinkLoss",0);p(this,"_downlinkPrevStatMap",new Map);p(this,"_downlinkLossAndRTTMap",new Map);p(this,"_interval",-1);p(this,"_uplinkNetworkQuality",0);p(this,"_downlinkNetworkQuality",0);this._room=r,this._signalChannel=e,this._log=M.createLogger({id:"q",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this.initialize()}get uplinkNetworkQuality(){return this._uplinkNetworkQuality}set uplinkNetworkQuality(e){e!==this._uplinkNetworkQuality&&this._log.info(`uplink network quality change ${this.uplinkNetworkQuality} -> ${e}, rtt: ${this._uplinkRTT}, loss: ${this._uplinkLoss}`),this._uplinkNetworkQuality=e}get downlinkNetworkQuality(){return this._downlinkNetworkQuality}set downlinkNetworkQuality(e){if(e!==this._downlinkNetworkQuality){let{rtt:r,loss:n}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._log.info(`downlink network quality change ${this.downlinkNetworkQuality} -> ${e}, rtt: ${r}, loss: ${n}`)}this._downlinkNetworkQuality=e}initialize(){this._signalChannel.on(se.UPLINK_NETWORK_STATS,e=>{this.handleUplinkNetworkQuality(e)}),this._signalChannel.on(ve.CONNECTION_STATE_CHANGED,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){var c,d;if(e.data.code!==0)return;let r=e.data.data;if(r.delay&&this.updateDelay(r.delay),!this._room.uplinkConnection){this.uplinkNetworkQuality=0,this._uplinkLoss=0,this._uplinkRTT=0;return}let n=(d=(c=this._room)==null?void 0:c.uplinkConnection)==null?void 0:d.getPeerConnection();if(n&&this.isPeerConnectionDisconnected(n)){this.uplinkNetworkQuality=6,this._uplinkLoss=0,this._uplinkRTT=0;return}let s=r.expectAudPkg+r.expectVidPkg,o=r.recvAudPkg+r.recvVidPkg,a=s-o;s===0&&o===0||(a<=0?this._uplinkLoss=0:this._uplinkLoss=Math.round(a/s*100),this._uplinkRTT=r.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this._uplinkLoss,this._uplinkRTT))}handleDownlinkNetworkQuality(){return T(this,null,function*(){if(this._room.remotePublishedUserMap.size===0){this.downlinkNetworkQuality=0;return}let e=[...this._room.remotePublishedUserMap.values()],r=e.filter(a=>{var c;return((c=a.getPeerConnection())==null?void 0:c.connectionState)===Oe.CONNECTED});if(e.filter(a=>this.isPeerConnectionDisconnected(a.getPeerConnection())).length===e.length){this.downlinkNetworkQuality=6;return}for(let a=0;a<r.length;a++){let c=r[a].getPeerConnection();if(!c)return;let{rtt:d,totalPacketsLost:u,totalPacketsReceived:l}=yield this.getStat(c);if(!this._downlinkPrevStatMap.has(c)){this._downlinkPrevStatMap.set(c,{totalPacketsLost:u,totalPacketsReceived:l});continue}let m=0,I=this._downlinkPrevStatMap.get(c),E=u-I.totalPacketsLost,N=l-I.totalPacketsReceived;E<=0||N<0?m=0:m=Math.round(E/(E+N)*100),this._downlinkPrevStatMap.set(c,{totalPacketsLost:u,totalPacketsReceived:l}),this._downlinkLossAndRTTMap.set(c,{rtt:d,loss:m,userId:r[a].getUserId(),audioDelay:r[a].remoteAudioTrack.stat.end2EndDelay,videoDelay:r[a].remoteVideoTrack.stat.end2EndDelay})}if([...this._downlinkPrevStatMap.keys()].forEach(a=>{this.isPeerConnectionDisconnected(a)&&(this._downlinkPrevStatMap.delete(a),this._downlinkLossAndRTTMap.delete(a))}),this._downlinkLossAndRTTMap.size===0)return;let{rtt:s,loss:o}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._downlinkRTT=s,this._downlinkLoss=o,this.downlinkNetworkQuality=this.getNetworkQuality(o,s)})}getStat(e){return T(this,null,function*(){let r={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!Ur())return r;let n=e.getReceivers();try{for(let s=0;s<n.length;s++)(yield n[s].getStats()).forEach(c=>{c.type==="candidate-pair"&&de(c.currentRoundTripTime)&&(r.rtt=Math.round(c.currentRoundTripTime*1e3)),c.type==="inbound-rtp"&&(c.mediaType===f.AUDIO||c.mediaType===f.VIDEO)&&(r.totalPacketsLost+=c.packetsLost,r.totalPacketsReceived+=c.packetsReceived)});return r}catch(s){return r}})}getAverageLossAndRTT(e){let r={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach(n=>{r.rtt+=n.rtt,r.loss+=n.loss}),Object.keys(r).forEach(n=>{r[n]=Math.round(r[n]/e.length)})),r}getNetworkQuality(e,r){return e>50||r>500?5:e>30||r>350?4:e>20||r>200?3:e>10||r>100?2:e>=0||r>=0?1:0}handleSignalConnectionStateChange(e){e.state===Je.DISCONNECTED?(this._uplinkRTT=0,this._uplinkLoss=0,this.uplinkNetworkQuality=6):e.state===Je.CONNECTED&&this.uplinkNetworkQuality===6&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange({state:e}){e==="DISCONNECTED"?(this._uplinkLoss=0,this._uplinkRTT=0,this.uplinkNetworkQuality=6):e==="CONNECTED"&&this.uplinkNetworkQuality===6&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!!(e&&(e.connectionState===Oe.DISCONNECTED||e.connectionState===Oe.FAILED||e.connectionState===Oe.CLOSED))}setUplinkConnection(e){this._room.uplinkConnection=e,this._room.uplinkConnection?this._room.uplinkConnection.on(iu.CONNECTION_STATE_CHANGED,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this._uplinkRTT=0,this._uplinkLoss=0)}start(){if(this._interval!==-1){this._log.info("network quality calculating is already started");return}this._log.debug("start network quality calculating"),this._interval=le.run(yt,()=>{this.handleDownlinkNetworkQuality();let e=[...this._downlinkLossAndRTTMap.values()];C.emit(S.NETWORK_QUALITY,{room:this._room,uplink:{rtt:this._uplinkRTT,loss:this._uplinkLoss},downlinks:e}),this.emit(cc.EVENT_NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this._uplinkRTT,uplinkLoss:this._uplinkLoss,downlinkRTT:this._downlinkRTT,downlinkLoss:this._downlinkLoss,downlinkInfo:e})},{delay:2e3})}stop(){this._log.info("stop network quality calculating"),this._interval!==-1&&(le.clearTask(this._interval),this._interval=-1),this._downlinkLossAndRTTMap.clear(),this._downlinkPrevStatMap.clear()}updateDelay(e){let{tinyIdToUserIdMap:r}=this._room;e.forEach(({srcTinyId:n,videoDelay:s,audioDelay:o})=>{let a=r.get(n);if(a){let c=this._room.remotePublishedUserMap.get(a);c==null||c.setDelay({videoDelay:s,audioDelay:o})}})}},vi=cc;p(vi,"EVENT_NETWORK_QUALITY","0");var EM=h(_(),1);var Tb=h(_(),1);var QO=h(_(),1);var Ht=new WeakMap;function on({settings:i={retries:5,timeout:2e3},onError:t,onRetrying:e,onRetryFailed:r}){return function(n,s,o){let a=_t({retryFunction:o.value,settings:i,onError(c,d,u){t&&t.call(this,c,()=>{var l;(l=Ht.get(n))!=null&&l.has(s)?d():u(c)},u)},onRetrying:(c,d)=>{var u;oe(e)&&e(c,d),(u=Ht.get(n))!=null&&u.has(s)&&(Ht.get(n).get(s).stopRetry=d)},onRetryFailed:r});return o.value=function(...c){let d=Ht.get(n);return d?d.set(s,{args:c}):Ht.set(n,new Map([[s,{args:c}]])),a.apply(this,c).finally(()=>{var u;return(u=Ht.get(n))==null?void 0:u.delete(s)})},o}}function an({fnName:i,callback:t,validateArgs:e=!0}){return function(r,n,s){let o=s.value;return s.value=function(...a){var c,d;if((c=Ht.get(r))!=null&&c.has(i)){let{stopRetry:u,args:l}=Ht.get(r).get(i),m=!0;if(e){for(let I of l)if(!a.find(E=>E===I)){m=!1;break}}m&&(t&&t.apply(this,a),u&&u(),(d=Ht.get(r))==null||d.delete(i))}return o.apply(this,a)},s}}var Ns=class{constructor(t){p(this,"_frameWorkType");p(this,"_component");p(this,"_room");p(this,"_signalInfo",{tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0});p(this,"_keyPrefix");p(this,"_log");p(this,"_intervalId");p(this,"_firstPublishedUserList");p(this,"_networkQuality");p(this,"_basicInfo");p(this,"_pathJoinRoom");p(this,"_pathLeaveRoom");p(this,"_pathMainVideoMap");p(this,"_pathMainAudioMap");p(this,"_pathAuxiliaryMap");p(this,"_remoteStreamStatMap");p(this,"_localStreamStat");p(this,"_apiSuccessRateMap",new Map);p(this,"_eventMap",new Map);this._frameWorkType=t.frameWorkType||30,this._component=t.component||0,this._room=t.room,this._keyPrefix="key_point",this._log=M.createLogger({id:"kpm",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),Object.getOwnPropertyNames(this.__proto__).forEach(e=>{e.startsWith("handle")&&oe(this[e])&&(this[e]=No({fn:this[e],context:this}))}),this.initData(),this.installEvents(),this._intervalId=le.run(yt,this.setStorage.bind(this),{delay:2e4})}get _storageKey(){return`${this._keyPrefix}_${this._room.userId}`}initData(){this._firstPublishedUserList=[],this._networkQuality={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this._basicInfo={string_sdk_version:Be,uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:this._room.scene==="live"?1:0,uint32_joining_duration:0,uint32_networkType:si[Fn()],uint32_framework:this._frameWorkType,uint32_component:this._component},this._pathJoinRoom={uint64_start_time:0,uint64_init_audio_start_time:0,uint64_init_audio_end_time:0,uint64_init_camera_start_time:0,uint64_init_camera_end_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_init_audio_ret:0,int32_init_camera_ret:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this._pathLeaveRoom={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this._localStreamStat={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this._pathMainVideoMap=new Map,this._pathMainAudioMap=new Map,this._pathAuxiliaryMap=new Map,this._remoteStreamStatMap=new Map,this._apiSuccessRateMap.clear()}addEvent(t,e){return this._eventMap.set(t,e),C.on(t,e),this}installEvents(){this._room.once("banned",()=>this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId})),this.addEvent(S.JOIN_START,this.handleJoinStart).addEvent(S.JOIN_SIGNAL_CONNECTION_START,this.handleSignalConnectionStart).addEvent(S.JOIN_SIGNAL_CONNECTION_END,this.handleSignalConnectionEnd).addEvent(S.JOIN_SEND_CMD,this.handleJoinSendCMD).addEvent(S.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce).addEvent(S.JOIN_SUCCESS,this.handleJoinSuccess).addEvent(S.JOIN_FAILED,this.handleJoinFailed).addEvent(S.LEAVE_START,this.handleLeaveStart).addEvent(S.LEAVE_SUCCESS,this.handleLeaveSuccess).addEvent(S.LEAVE_SEND_CMD,this.handleLeaveSendCMD).addEvent(S.LOCAL_TRACK_CAPTURE_START,this.handleTrackCaptureStart).addEvent(S.LOCAL_TRACK_CAPTURE_SUCCESS,this.handleTrackCaptureSuccess).addEvent(S.LOCAL_TRACK_CAPTURE_FAILED,this.handleTrackCaptureFailed).addEvent(S.PUBLISH_START,this.handlePublishStart).addEvent(S.SEND_FIRST_VIDEO_FRAME,this.handleSendFirstVideoFrame).addEvent(S.SUBSCRIBE_START,this.handleSubscribeStart).addEvent(S.SUBSCRIBE_SUCCESS,this.handleSubscribed).addEvent(S.PLAY_TRACK_START,this.handlePlayStart).addEvent(S.VIDEO_LOADED_DATA,this.handleVideoLoadedData).addEvent(S.PLAYER_STATE_CHANGED,({track:t,state:e,type:r})=>{!qt(t)||!this.hitTest(t.room)||e==="PLAYING"&&(r===f.AUDIO?this.handleAudioPlaying(t):this.handleVideoPlaying(t))}).addEvent(S.NETWORK_QUALITY,this.handleNetworkQuality).addEvent(S.HEARTBEAT_REPORT,this.handleHeartbeatStats).addEvent(S.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList).addEvent(S.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:r})=>{if(!this.hitTest(t))return;let n=e.hasAudio||e.hasVideo||e.hasSmall,s=e.hasAuxiliary,o=r.hasAudio||r.hasVideo||r.hasSmall,a=r.hasAuxiliary;!n&&o&&this.handleRemoteStreamAdded(r.userId,"main"),!s&&a&&this.handleRemoteStreamAdded(r.userId,"auxiliary")}).addEvent(S.API_SUCCESS_RATE,this.handleAPISuccessRate)}uninstallEvents(){this._eventMap.forEach((t,e)=>C.off(e,t)),this._eventMap.clear()}destroy(){this.uninstallEvents(),le.clearTask(this._intervalId)}handleJoinStart(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_start_time===0&&(this._pathJoinRoom.uint64_start_time=Date.now(),this.checkStorage())}handleSignalConnectionStart({room:t}){this.hitTest(t)&&this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time===0&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleSignalConnectionEnd({room:t,error:e}){this.hitTest(t)&&this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time===0&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time=Date.now(),e&&(this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret=e instanceof V?Number(e.getExtraCode()||e.getCode()):b.UNKNOWN,this._pathJoinRoom.int32_end_ret=2))}handleJoinSendCMD(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time===0&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time===0&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time=Date.now(),this._pathJoinRoom.int32_send_request_enter_room_cmd_ret=t.code,t.code!==0&&(this._pathJoinRoom.int32_end_ret=3))}handleJoinSuccess(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_end_time===0&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret=0,this._signalInfo=t.room.getSignalInfo())}handleJoinFailed({room:t}){this.hitTest(t)&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret===0&&(this._pathJoinRoom.int32_end_ret=3),this.report())}handleReceivedPublishUserList(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_recv_userlist_time===0&&(this._pathJoinRoom.uint64_recv_userlist_time=Date.now(),this._firstPublishedUserList=t.publishedUserList||[])}handleSendFirstVideoFrame({room:t}){!this.hitTest(t)||this._pathJoinRoom.uint64_send_first_video_frame_time===0&&this._pathJoinRoom.uint64_start_time!==0&&(this._pathJoinRoom.uint64_send_first_video_frame_time=Date.now())}handleLeaveStart(t){this.hitTest(t.room)&&(this._pathLeaveRoom.uint64_start_time=Date.now())}handleLeaveSuccess(t){this.hitTest(t.room)&&this._pathLeaveRoom.uint64_end_time===0&&(this._pathLeaveRoom.uint64_end_time=Date.now(),this._pathJoinRoom.uint64_end_time!==0?this._basicInfo.uint32_joining_duration=this._pathLeaveRoom.uint64_end_time-this._pathJoinRoom.uint64_end_time:this._log.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(t){this.hitTest(t.room)&&(this._pathLeaveRoom.uint64_send_request_exit_room_cmd_start_time=Date.now(),this._pathLeaveRoom.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded(t,e){var n;let r=`${t}_${e}`;if(!this._remoteStreamStatMap.has(r)){let s={userId:t,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:ie(w({},o_),{msg_user_info:new cn({userId:t,tinyId:(n=this._room.remotePublishedUserMap.get(t))==null?void 0:n.tinyId,role:20})})};s.statsToReport.uint32_stream_type=e==="main"?2:7,this._remoteStreamStatMap.set(r,s)}}handleSubscribeStart({room:t,remotePublishedUser:e,streamType:r,subscribeState:n}){if(!this.hitTest(t))return;let{userId:s,tinyId:o,role:a}=e,c=new cn({userId:s,tinyId:o,role:a==="anchor"?20:21}),d=Date.now(),u=`${s}_${r}`,l=this._remoteStreamStatMap.get(u);l&&l.subscribeStartTime===0&&(l.subscribeStartTime=d),r==="main"?(e.muteState.hasVideo&&(n.video||n.smallVideo)&&!this._pathMainVideoMap.has(u)&&this._pathMainVideoMap.set(u,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0},userId:s,sendSubscribeCMDTime:d}),e.muteState.hasAudio&&n.audio&&!this._pathMainAudioMap.has(u)&&this._pathMainAudioMap.set(u,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_play_first_frame_time:0},userId:s,sendSubscribeCMDTime:d})):e.muteState.hasAuxiliary&&n.auxiliary&&!this._pathAuxiliaryMap.has(u)&&this._pathAuxiliaryMap.set(u,{sendSubscribeCMDTime:d})}handleSubscribed({room:t,remotePublishedUser:e,streamType:r}){if(this.hitTest(t)){let n=`${e.userId}_${r}`,s=this._remoteStreamStatMap.get(n);s&&s.subscribedTime===0&&(s.subscribedTime=Date.now())}}handlePlayStart({track:t}){if(!qt(t)||!this.hitTest(t.room))return;let e=`${t.userId}_${t.streamType}`,r=this._remoteStreamStatMap.get(e);(r==null?void 0:r.playStreamTime)===0&&(r.playStreamTime=Date.now())}handleVideoLoadedData({track:t}){if(!qt(t)||!this.hitTest(t.room))return;let e=`${t.userId}_${t.streamType}`,r=this._pathMainVideoMap.get(e);r&&r.statsToReport.uint64_combine_first_frame_time===0&&(r.statsToReport.uint64_combine_first_frame_time=Date.now())}handleVideoPlaying(t){let e=`${t.userId}_${t.streamType}`,r=Date.now(),n=this._pathMainVideoMap.get(e),s=this._remoteStreamStatMap.get(e);if(n&&(n.statsToReport.uint64_render_first_frame_time===0&&(n.statsToReport.uint64_render_first_frame_time=r),s)){let{statsToReport:a,playStreamTime:c,subscribedTime:d}=s;a.uint32_video_render_first===0&&c-d<=100&&(a.uint32_video_render_first=r-n.sendSubscribeCMDTime)}let o=this._pathAuxiliaryMap.get(e);if(o&&s){let{statsToReport:a,playStreamTime:c,subscribedTime:d}=s;a.uint32_video_render_first===0&&c-d<=100&&(a.uint32_video_render_first=r-o.sendSubscribeCMDTime)}}handleAudioPlaying(t){let e=`${t.userId}_${t.streamType}`,r=this._pathMainAudioMap.get(e);r&&r.statsToReport.uint64_play_first_frame_time===0&&(r.statsToReport.uint64_play_first_frame_time=Date.now())}handleNetworkQuality(t){this.hitTest(t.room)&&(this._networkQuality.totalUplinkLoss+=t.uplink.loss,this._networkQuality.totalUplinkRTT+=t.uplink.rtt,this._networkQuality.count++,t.downlinks.forEach(({rtt:e,loss:r,userId:n,videoDelay:s,audioDelay:o})=>{let a=this._networkQuality.totalDownlinkRTTAndLossMap.get(n);if(a)a.totalRTT+=e,a.totalLoss+=r,s&&(a.totalVideoDelay=(a.totalVideoDelay||0)+s,a.videoDelayCount=(a.videoDelayCount||0)+1),o&&(a.totalAudioDelay=(a.totalAudioDelay||0)+o,a.audioDelayCount=(a.audioDelayCount||0)+1),a.count++;else{let c,d,u,l;s&&(d=s,u=1),o&&(c=o,l=1),this._networkQuality.totalDownlinkRTTAndLossMap.set(n,{totalRTT:e,totalLoss:r,count:1,totalAudioDelay:c,totalVideoDelay:d,audioDelayCount:l,videoDelayCount:u})}}))}handleHeartbeatStats(t){if(this.hitTest(t.room)){let{msg_up_stream_info:e,msg_down_stream_info:r}=t.report;if(e.msg_video_status[0]){let{uint32_video_codec_bitrate:n,uint32_video_enc_fps:s,uint32_video_width:o,uint32_video_height:a}=e.msg_video_status[0];this._localStreamStat.totalVideoBitrate+=n,this._localStreamStat.totalVideoFPS+=s,this._localStreamStat.totalVideoWidth+=o,this._localStreamStat.totalVideoHeight+=a,this._localStreamStat.videoCount++}if(e.msg_audio_status){let{uint32_audio_level:n}=e.msg_audio_status;Math.floor(n/ui*100)>0&&(this._localStreamStat.totalAudioLevel+=n/ui,this._localStreamStat.audioLevelCount++)}r.forEach(n=>{let{msg_user_info:s,msg_audio_status:o,msg_video_status:a}=n,c=s.str_identifier,d=this._room.remotePublishedUserMap.get(c);if(a.forEach(u=>{let l=u.uint32_video_stream_type===2,m=u.uint32_video_stream_type===7,I=`${c}_${l?"main":"auxiliary"}`,E=this._remoteStreamStatMap.get(I);if(!!E&&(l&&(d==null?void 0:d.remoteVideoTrack.isSubscribed)||m&&(d==null?void 0:d.remoteAuxiliaryTrack))){E.totalVideoFPS+=u.uint32_video_receive_fps,E.totalVideoBitrate+=u.uint32_video_codec_bitrate,E.videoCount++,E.statsToReport.uint32_video_width===0&&(E.statsToReport.uint32_video_width=u.uint32_video_width),E.statsToReport.uint32_video_height===0&&(E.statsToReport.uint32_video_height=u.uint32_video_height);let N=l?d.remoteVideoTrack:d.remoteAuxiliaryTrack;N.stat.jitterBufferDelay&&(E.videoJitterBufferDelay=N.stat.jitterBufferDelay),N.stat.framesReceived&&(E.statsToReport.uint32_video_consume_render_rate=Math.floor(N.stat.framesDecoded/N.stat.framesReceived*pn(10,6)))}}),o){let u=`${c}_${"main"}`,l=this._remoteStreamStatMap.get(u);this._remoteStreamStatMap.has(u)&&l&&(d==null?void 0:d.remoteAudioTrack.isSubscribed)&&(l.totalAudioBitrate+=o.uint32_audio_codec_bitrate,l.audioCount++,d.remoteAudioTrack.stat.jitterBufferDelay&&(l.audioJitterBufferDelay=d.remoteAudioTrack.stat.jitterBufferDelay),Math.floor(o.uint32_audio_level/ui*100)>0&&(l.totalAudioLevel+=o.uint32_audio_level/ui,l.audioLevelCount++))}})}}handlePublishStart({room:t}){this.hitTest(t)&&this._localStreamStat.publishStartTime===0&&(this._localStreamStat.publishStartTime=Date.now())}handleTrackCaptureStart({track:t}){t.mediaType===1&&this._pathJoinRoom.uint64_init_audio_start_time===0&&(this._pathJoinRoom.uint64_init_audio_start_time=Date.now()),t.mediaType===4&&this._pathJoinRoom.uint64_init_camera_start_time===0&&(this._pathJoinRoom.uint64_init_camera_start_time=Date.now())}handleTrackCaptureSuccess({track:t}){t.mediaType===1&&this._pathJoinRoom.uint64_init_audio_end_time===0&&(this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),t.mediaType===4&&this._pathJoinRoom.uint64_init_camera_end_time===0&&(this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleTrackCaptureFailed({track:t,error:e}){let r={NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5},n=e instanceof V?e.getExtraCode()||e.getCode():r[e.name]||b.UNKNOWN;t.mediaType===1&&this._pathJoinRoom.uint64_init_audio_end_time===0&&(this._pathJoinRoom.int32_init_audio_ret=n,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),t.mediaType===4&&this._pathJoinRoom.uint64_init_camera_end_time===0&&(this._pathJoinRoom.int32_init_camera_ret=n,this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleAPISuccessRate({room:t,apiName:e,error:r,cost:n}){if(!this.hitTest(t))return;let s=El[e],o={uint32_function_request_type:s,uint32_avg_value:0,uint32_max_value:0,uint32_request_count:1,uint32_success_count:0,msg_error_code:[]};if(r){let{code:c,extraCode:d}=r;Ae.uploadEvent({log:`stat-${e}-failed-${d||c||b.UNKNOWN}`,userId:this._room.userId,error:r});let u={int32_error_code:d||c,error_count:1};o.msg_error_code.push(u)}else de(n)&&(o.uint32_avg_value=n,o.uint32_max_value=n,o.uint32_success_count=1);let a=this._apiSuccessRateMap.get(s);a?(a.uint32_success_count+o.uint32_success_count>0&&(a.uint32_avg_value=(a.uint32_avg_value*a.uint32_success_count+o.uint32_avg_value)/(a.uint32_success_count+o.uint32_success_count)),a.uint32_max_value=Math.max(a.uint32_max_value,o.uint32_max_value),a.uint32_request_count+=1,a.uint32_success_count=a.uint32_success_count+o.uint32_success_count,o.msg_error_code.forEach(c=>{let d=a.msg_error_code.find(u=>u.int32_error_code===c.int32_error_code);d?d.error_count+=1:a.msg_error_code.push(c)})):this._apiSuccessRateMap.set(s,o)}hasVideoFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&cr)>=0}hasAudioFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&dr)>=0}hasAuxFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&gn)>=0}hitTest(t){return t===this._room}checkStorage(){return T(this,null,function*(){try{let t=$i.getItem(this._storageKey);t&&(yield this.upload(t),$i.deleteItem(this._storageKey))}catch(t){this._log.warn(t)}})}setStorage(){this.prepareReport();let t=this.getReportData();t.msg_path_enter_room.uint64_start_time!==0&&$i.setItem(this._storageKey,t)}prepareReport(){if(this._networkQuality.count>0&&(this._basicInfo.uint32_avg_rtt=Math.floor(this._networkQuality.totalUplinkRTT/this._networkQuality.count),this._basicInfo.uint32_avg_up_loss=Math.floor(this._networkQuality.totalUplinkLoss/this._networkQuality.count)),this._localStreamStat.videoCount>0){this._localStreamStat.statsToReport.uint32_video_big_capture_fps=Math.floor(this._localStreamStat.totalVideoFPS/this._localStreamStat.videoCount),this._localStreamStat.statsToReport.uint32_video_big_bitrate=Math.floor(this._localStreamStat.totalVideoBitrate/this._localStreamStat.videoCount);let t=Math.floor(this._localStreamStat.totalVideoWidth/this._localStreamStat.videoCount),e=Math.floor(this._localStreamStat.totalVideoHeight/this._localStreamStat.videoCount);this._localStreamStat.statsToReport.uint32_video_big_resolution=t<<16|e}this._localStreamStat.audioLevelCount>0&&(this._localStreamStat.statsToReport.uint32_audio_capture_db=Math.floor(this._localStreamStat.totalAudioLevel/this._localStreamStat.audioLevelCount*100)),this._remoteStreamStatMap.forEach((t,e)=>{let{userId:r}=t,n=this._networkQuality.totalDownlinkRTTAndLossMap.get(r);if(n){let{totalLoss:u,count:l,audioDelayCount:m,videoDelayCount:I,totalAudioDelay:E,totalVideoDelay:N}=n;t.statsToReport.uint32_avg_down_loss=Math.floor(u/l),m&&E&&(t.statsToReport.uint32_audio_network_p2p_delay=Math.floor(E/m),t.audioJitterBufferDelay&&(t.statsToReport.uint32_p2p_delay=Math.floor(t.statsToReport.uint32_audio_network_p2p_delay+t.audioJitterBufferDelay))),I&&N&&(t.statsToReport.uint32_video_network_p2p_delay=Math.floor(N/I))}t.videoCount>0&&(t.statsToReport.uint32_video_avg_fps=Math.floor(t.totalVideoFPS/t.videoCount),t.statsToReport.uint32_video_avg_bitrate=Math.floor(t.totalVideoBitrate/t.videoCount)),t.audioCount>0&&(t.statsToReport.uint32_audio_recv_bitrate=t.statsToReport.uint32_audio_bitrate=Math.floor(t.totalAudioBitrate/t.audioCount)),t.audioLevelCount>0&&(t.statsToReport.uint32_audio_play_db=Math.floor(t.totalAudioLevel/t.audioLevelCount*100));let{callDurationCalculator:s}=this._room;s&&(t.statsToReport.uint32_audio_play_time=s.getDuration(e,f.AUDIO),t.statsToReport.uint32_video_play_time=s.getDuration(e,f.VIDEO)),t.statsToReport.uint32_video_render_first=Math.min(t.statsToReport.uint32_video_render_first,yi);let{badCaseDetector:o}=this._room,{dataFreeze:a,count:c}=o.getDataFreezeDuration(e),{renderFreeze:d}=o.getRenderFreezeDuration(e);t.statsToReport.uint32_video_block_count=c,t.statsToReport.uint32_video_block_time=Math.min(a,t.statsToReport.uint32_video_play_time),t.statsToReport.uint32_video_external_block_time=Math.min(d,t.statsToReport.uint32_video_play_time),o.isBlackStream(e)&&t.statsToReport.uint32_video_avg_fps===0?t.statsToReport.uint32_video_black_screen_subjective=1:t.statsToReport.uint32_video_black_screen_subjective=0,(t.subscribeStartTime===0||t.subscribeStartTime-t.streamAddedTime>100||t.playStreamTime===0)&&(this._pathMainAudioMap.delete(e),this._pathMainVideoMap.delete(e),t.statsToReport.uint32_video_render_first=0)}),this._pathMainAudioMap.forEach((t,e)=>{if(!this.hasAudioFlag(t.userId)){this._pathMainAudioMap.delete(e);return}t.statsToReport.uint64_play_first_frame_time-t.statsToReport.uint64_start_enter_time>yi&&(t.statsToReport.uint64_play_first_frame_time=t.statsToReport.uint64_start_enter_time+yi)}),this._pathMainVideoMap.forEach((t,e)=>{if(!this.hasVideoFlag(t.userId)){this._pathMainVideoMap.delete(e);return}t.statsToReport.uint64_render_first_frame_time-t.statsToReport.uint64_start_enter_time>yi&&(t.statsToReport.uint64_render_first_frame_time=t.statsToReport.uint64_start_enter_time+yi)}),this._pathJoinRoom.uint64_end_time-this._pathJoinRoom.uint64_start_time>yi&&(this._pathJoinRoom.uint64_end_time=this._pathJoinRoom.uint64_start_time+yi)}getReportData(){return{uint32_sdk_app_id:Number(this._room.sdkAppId),msg_user_info:new cn({userId:this._room.userId,tinyId:this._room.tinyId,role:this._room.role==="anchor"?20:21}),msg_basic_info:this._basicInfo,uint32_acc_ip:kr(this._signalInfo.relayIp),uint32_client_ip:kr(this._signalInfo.clientIp,!1),uint32_acc_port:this._signalInfo.relayPort||0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*2147483648),msg_path_enter_room:this._pathJoinRoom,msg_path_exit_room:this._pathLeaveRoom,msg_path_recv_video:[...this._pathMainVideoMap.values()].map(e=>e.statsToReport),msg_quality_statistics:[...this._remoteStreamStatMap.values()].map(e=>e.statsToReport),str_room_name:String(this._room.roomId||0),msg_path_recv_audio:[...this._pathMainAudioMap.values()].map(e=>e.statsToReport),uint32_info_client_ip:kr(this._signalInfo.clientIp,!1),error_code:[],msg_local_statistics:this._localStreamStat.statsToReport,msg_function_request_stats:[...this._apiSuccessRateMap.values()]}}report(){return T(this,null,function*(){try{this.prepareReport();let t=this.getReportData();yield this.upload(t),$i.deleteItem(this._storageKey),this.initData()}catch(t){this._log.warn(t)}})}upload(t){return T(this,null,function*(){if(Jt||t.msg_path_enter_room.uint64_start_time===0||[Zs,td,id].findIndex(s=>s===location.host)>=0)return;let e=Number(this._room.sdkAppId),r=li(e,Mi.KEY_POINT),n=yield zt({url:r,body:JSON.stringify(t)});if(n.data!=="ok")throw`key point upload failed: ${n.data}`})}};G([on({settings:{timeout:500,retries:3}})],Ns.prototype,"upload",1);var yi=5e3,o_={msg_user_info:null,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0,uint32_video_consume_render_rate:0},cn=class{constructor(t){p(this,"str_identifier");p(this,"str_tinyid");p(this,"uint32_role");this.str_identifier=String(t.userId),this.str_tinyid=String(t.tinyId||0),this.uint32_role=t.role}},El=(g=>(g[g.enterRoom=50001]="enterRoom",g[g.exitRoom=50002]="exitRoom",g[g.switchRole=50003]="switchRole",g[g.destroy=50004]="destroy",g[g.startLocalAudio=50005]="startLocalAudio",g[g.updateLocalAudio=50006]="updateLocalAudio",g[g.stopLocalAudio=50007]="stopLocalAudio",g[g.startLocalVideo=50008]="startLocalVideo",g[g.updateLocalVideo=50009]="updateLocalVideo",g[g.stopLocalVideo=50010]="stopLocalVideo",g[g.startScreenShare=50011]="startScreenShare",g[g.updateScreenShare=50012]="updateScreenShare",g[g.stopScreenShare=50013]="stopScreenShare",g[g.enableAudioVolumeEvaluation=50014]="enableAudioVolumeEvaluation",g[g.startRemoteVideo=50015]="startRemoteVideo",g[g.updateRemoteVideo=50016]="updateRemoteVideo",g[g.stopRemoteVideo=50017]="stopRemoteVideo",g[g.muteRemoteAudio=50018]="muteRemoteAudio",g[g.setRemoteAudioVolume=50019]="setRemoteAudioVolume",g[g.startMixTranscode=50020]="startMixTranscode",g[g.stopMixTranscode=50021]="stopMixTranscode",g[g.startPublishCDNStream=50022]="startPublishCDNStream",g[g.stopPublishCDNStream=50023]="stopPublishCDNStream",g[g.PeerConnectionConnect=50024]="PeerConnectionConnect",g[g.PeerConnectionReconnect=50025]="PeerConnectionReconnect",g[g.WebsocketConnect=50026]="WebsocketConnect",g[g.WebsocketReconnect=50027]="WebsocketReconnect",g[g.schedule=50028]="schedule",g))(El||{}),Tl=Ns;var Pb=h(_(),1);var Rb=h(_(),1);var dc=class{constructor(){p(this,"_startTime");p(this,"_endTime");this._startTime=0,this._endTime=0,this.start()}start(){this._startTime===0&&(this._startTime=ee())}stop(){this._endTime===0&&(this._endTime=ee())}getDuration(){return this._endTime===0?ee()-this._startTime:this._endTime-this._startTime}get endTime(){return this._endTime}},Zi=dc;var uc=class{constructor(t){p(this,"_room",null);p(this,"_durationMap");p(this,"_eventMap",new Map);this._room=t.room,this._durationMap=new Map,this.installEvents()}installEvents(){this._eventMap.set(S.SUBSCRIBE_SUCCESS,this.handleSubscribed).set(S.UNSUBSCRIBE_SUCCESS,this.handleStreamStopped).set(S.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:r})=>{var o;let{userId:n}=r;if(!this.hitTest(t))return;e.hasAudio&&!r.hasAudio&&this.stopDurationItem(`${n}_${"main"}`,f.AUDIO),e.hasVideo&&!r.hasVideo&&this.stopDurationItem(`${n}_${"main"}`,f.VIDEO),e.hasAuxiliary&&!r.hasAuxiliary&&this.stopDurationItem(`${n}_${"auxiliary"}`,f.VIDEO);let s=(o=this._room)==null?void 0:o.remotePublishedUserMap.get(n);!s||(!e.hasAudio&&r.hasAudio&&s.remoteAudioTrack.isSubscribed&&this.addDuractionItem(n,f.AUDIO,"main"),!e.hasVideo&&r.hasVideo&&s.remoteVideoTrack.isSubscribed&&this.addDuractionItem(n,f.VIDEO,"main"),!e.hasAuxiliary&&r.hasAuxiliary&&s.remoteAuxiliaryTrack.isSubscribed&&this.addDuractionItem(n,f.VIDEO,"auxiliary"))}),this._eventMap.forEach((t,e)=>C.on(e,t,this))}uninstallEvents(){this._eventMap.forEach((t,e)=>C.off(e,t,this)),this._eventMap.clear()}handleSubscribed({room:t,streamType:e,remotePublishedUser:r}){if(!this.hitTest(t))return;let{userId:n}=r,s=`${n}_${e}`;if(r.muteState.hasAudio&&e==="main")if(r.remoteAudioTrack.isSubscribed){let o=new Zi,a=this._durationMap.get(s);a?this.isRecording(a.audio)||a.audio.push(o):this._durationMap.set(s,{userId:n,type:e,audio:[o],video:[]})}else this.stopDurationItem(s,f.AUDIO);if(r.muteState.hasVideo||r.muteState.hasAuxiliary)if(r.remoteVideoTrack.isSubscribed||r.remoteAuxiliaryTrack.isSubscribed){let o=new Zi,a=this._durationMap.get(s);a?this.isRecording(a.video)||a.video.push(o):this._durationMap.set(s,{userId:n,type:e,audio:[],video:[o]})}else this.stopDurationItem(s,f.VIDEO)}handleStreamStopped({room:t,streamType:e,remotePublishedUser:r}){if(!this.hitTest(t))return;let{userId:n}=r,s=`${n}_${e}`;this.stopDurationItem(s,f.AUDIO),this.stopDurationItem(s,f.VIDEO)}isRecording(t){return t.findIndex(e=>e.endTime===0)>=0}addDuractionItem(t,e,r){let n=`${t}_${r}`,s=new Zi,o=this._durationMap.get(n);o?this.isRecording(o[e])||o[e].push(s):this._durationMap.set(n,{userId:t,type:r,audio:e===f.AUDIO?[s]:[],video:e===f.AUDIO?[]:[s]})}stopDurationItem(t,e){if(this._durationMap.has(t)){let n=this._durationMap.get(t)[e].find(s=>s.endTime===0);n&&n.stop()}}hitTest(t){return this._room===t}getDuration(t,e){return this._durationMap.has(t)?this._durationMap.get(t)[e].reduce((n,s)=>n+s.getDuration(),0):0}getDurationMap(){return this._durationMap}reset(){this._durationMap.clear()}destroy(){this._room=null,this.uninstallEvents()}},Sl=uc;var Kb=h(_(),1);var lc=class{constructor(t){p(this,"_room");p(this,"_renderFreezeMap",new Map);p(this,"_isVideoPlayingEventFiredMap",new Map);p(this,"_dataFreezeMap",new Map);p(this,"_monitorFreezeData",new Map);p(this,"_eventMap",new Map);this._room=t.room,this.installEvents()}installEvents(){this._eventMap.set(S.LEAVE_SUCCESS,({room:t})=>{this.hitTest(t)&&this.stop()}).set(S.PLAY_TRACK_START,this.onPlayTrackStart).set(S.UNSUBSCRIBE_SUCCESS,({room:t,streamType:e,remotePublishedUser:r})=>{if(!this.hitTest(t))return;let{userId:n}=r,s=`${n}_${e}`;this.stopDataFreeze({key:s,userId:n,type:e})}).set(S.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:r})=>{if(!this.hitTest(t))return;let{userId:n}=r;if(e.hasVideo&&!r.hasVideo){let s="main",o=`${r.userId}_${s}`;this.stopDataFreeze({key:o,userId:n,type:s})}if(e.hasAuxiliary&&!r.hasAuxiliary){let s="auxiliary",o=`${r.userId}_${s}`;this.stopDataFreeze({key:o,userId:n,type:s})}}).set(S.PLAYER_STATE_CHANGED,({track:t,state:e,reason:r,type:n})=>{if(!(!qt(t)||!this.hitTest(t.room)||n!==f.VIDEO)){if(e==="PLAYING"){let s=`${t.userId}_${t.streamType}`;this._isVideoPlayingEventFiredMap.set(s,!0)}r===f.MUTE?this.onVideoTrackMuted(t):r===f.UNMUTE&&this.onVideoTrackUnmuted(t)}}).set(S.HEARTBEAT_REPORT,this.onHearBeatReport),this._eventMap.forEach((t,e)=>C.on(e,t,this))}uninstallEvents(){this._eventMap.forEach((t,e)=>C.off(e,t,this)),this._eventMap.clear()}stop(){this._renderFreezeMap.clear(),this._dataFreezeMap.clear(),this._isVideoPlayingEventFiredMap.clear()}onVideoTrackMuted(t){if(!t.isSubscribed)return;let{userId:e,streamType:r}=t,n=`${e}_${r}`,s=this._dataFreezeMap.get(n),o=new Zi;s?s.durationItemList.push(o):this._dataFreezeMap.set(n,{userId:e,type:r,durationItemList:[o],isFreezing(){let a=this.durationItemList[this.durationItemList.length-1];return a&&a.endTime===0}})}onVideoTrackUnmuted(t){if(!t.isSubscribed)return;let{userId:e,streamType:r}=t,n=`${e}_${r}`;this.stopDataFreeze({key:n,userId:e,type:r})}onHearBeatReport({room:t,report:e}){!this.hitTest(t)||e.msg_down_stream_info.forEach(r=>{let n=this._room.remotePublishedUserMap.get(r.msg_user_info.str_identifier);if(!n)return;let{userId:s,muteState:o}=n;r.msg_video_status.forEach(a=>{a.uint32_video_stream_type===2&&o.hasVideo&&!o.videoMuted&&n.remoteVideoTrack.isSubscribed&&this.handleRenderFreeze({userId:s,fps:a.uint32_video_dec_fps,type:"main"}),a.uint32_video_stream_type===7&&o.hasAuxiliary&&n.remoteAuxiliaryTrack.isSubscribed&&this.handleRenderFreeze({userId:s,fps:a.uint32_video_dec_fps,type:"auxiliary"})})})}stopDataFreeze({key:t,userId:e,type:r}){let n=this._dataFreezeMap.get(t);if(!n||!n.isFreezing())return;let s=n.durationItemList[n.durationItemList.length-1];s.stop();let o=s.getDuration();o>oo?this._monitorFreezeData.set(t,{userId:e,type:r,duration:o}):n.durationItemList.pop()}getTotalDuration(t){return t.reduce((e,r)=>{let n=r.getDuration();return e+Math.min(n,5e3)},0)}handleRenderFreeze(n){return T(this,arguments,function*({userId:t,fps:e,type:r}){let s=`${t}_${r}`,o=this._renderFreezeMap.get(s);if(e<=2){let a=ee();o&&!o.isFreeze&&(o.freezeTimeline.push({startTime:a,endTime:0}),o.isFreeze=!0),o||this._renderFreezeMap.set(s,{userId:t,type:r,isFreeze:!0,freezeTimeline:[{startTime:a,endTime:0}],renderFreezeTotal:0})}else if(o&&o.isFreeze){o.isFreeze=!1;let a=o.freezeTimeline.pop();if(a){a.endTime=ee();let c=a.endTime-a.startTime;o.freezeTimeline.push(a),o.renderFreezeTotal+=Math.min(5e3,c)}}})}onPlayTrackStart({track:t}){if(!qt(t)||!this.hitTest(t.room)||t.kind!==f.VIDEO||t.hasFlag)return;let e=`${t.userId}_${t.streamType}`;this._isVideoPlayingEventFiredMap.has(e)||this._isVideoPlayingEventFiredMap.set(e,!1)}getDataFreezeDuration(t){let e={dataFreeze:0,count:0},r=this._dataFreezeMap.get(t);if(r){if(r.isFreezing()){let n=r.durationItemList[r.durationItemList.length-1];n.stop(),n.getDuration()<oo&&r.durationItemList.pop()}e.dataFreeze=this.getTotalDuration(r.durationItemList),e.count=r.durationItemList.length}return e}getRenderFreezeDuration(t){let e=this._renderFreezeMap.get(t),r=0,n=0;if(e)if(!e.isFreeze)r=e.renderFreezeTotal;else{let s=ee(),o=e.freezeTimeline[e.freezeTimeline.length-1],a=s-o.startTime;r=e.renderFreezeTotal+Math.min(a,5e3),n=e.freezeTimeline.length}return{renderFreeze:r,count:n}}getMonitorFreeze(){return this._monitorFreezeData}isBlackStream(t){return this._isVideoPlayingEventFiredMap.has(t)?!this._isVideoPlayingEventFiredMap.get(t):!1}resetMonitor(){this._monitorFreezeData.clear()}hitTest(t){return t===this._room}destroy(){this.uninstallEvents()}},Il=lc;var aP=h(_(),1);var Rl=h(pc(),1);var mc=class{constructor(t){p(this,"_room");p(this,"_log");p(this,"_config",null);p(this,"_data");p(this,"_remoteVideoTrackMap",new Map);this._room=t,this._log=M.createLogger({id:"mix",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this.installEvents()}get isPresetLayoutMode(){return this._config&&this._config.mode===ci.MODE.PRESET_LAYOUT}get isMixing(){return!!this._data}installEvents(){C.on(S.REMOTE_TRACK_SUBSCRIBED,this.onSubscribed,this),C.on(S.REMOTE_TRACK_UNSUBSCRIBED,this.onUnSubscribed,this),C.on(S.REMOTE_PUBLISH_STATE_CHANGED,this.onRemotePublishedChanged,this)}uninstallEvents(){C.off(S.REMOTE_TRACK_SUBSCRIBED,this.onSubscribed,this),C.off(S.REMOTE_TRACK_UNSUBSCRIBED,this.onUnSubscribed,this),C.off(S.REMOTE_PUBLISH_STATE_CHANGED,this.onRemotePublishedChanged,this)}reset(){this.uninstallEvents(),this._config=null}onSubscribed({track:t}){t.room!==this._room||t.kind!==f.VIDEO||(this._remoteVideoTrackMap.set(`${t.userId}_${t.streamType}`,!1),this.isMixing&&this.hasAvailablePlaceHolder()&&this._config&&this.startMixTranscode(this._config))}onUnSubscribed({track:t}){t.room!==this._room||t.kind!==f.VIDEO||this.handleRemoteTrackUnavailable(`${t.userId}_${t.streamType}`)}onRemotePublishedChanged({room:t,prevMuteState:e,muteState:r}){t===this._room&&(e.hasVideo&&!r.hasVideo&&this.handleRemoteTrackUnavailable(`${r.userId}_${"main"}`),e.hasAuxiliary&&!r.hasAuxiliary&&this.handleRemoteTrackUnavailable(`${r.userId}_${"auxiliary"}`))}handleRemoteTrackUnavailable(t){if(this._remoteVideoTrackMap.has(t)){let e=this._remoteVideoTrackMap.get(t);this._remoteVideoTrackMap.delete(t),this.isMixing&&this.isPresetLayoutMode&&e&&this._config&&this.startMixTranscode(this._config)}}startMixTranscode(t){return T(this,null,function*(){try{this.resetIsUsedFlag(),this._config=t;let e=this.getInputParam(t),r=this.getOutputParam(t),n=this.getOutputSessionId({config:t,roomId:this._room.roomId,userId:this._room.userId});this.isMixing&&this._data&&n!==this._data.outputSessionId&&(this._log.info("startMixTranscode() streamId changed, stop mixing before start"),yield this.doStopMixTranscode()),yield this.doStartMixTranscode({outputSessionId:n,inputParam:e,outputParam:r})}catch(e){throw this.resetIsUsedFlag(),e}})}doStartMixTranscode(n){return T(this,arguments,function*({outputSessionId:t,inputParam:e,outputParam:r}){let s={roomId:String(this._room.roomId),mcuRequestTime:Date.now(),outputSessionId:t,inputParam:e,outputParam:r};this._log.info(`startMixTranscode: ${JSON.stringify(s)}`);let o=yield this._room.sendStartMixTranscode(s),{code:a}=o.data,{message:c}=o.data;if(a!==0)throw a===-102083&&(c=`Please enable relayed-push in ${In} and try later, refer to ${Pi}tutorial-26-advanced-publish-cdn-stream.html`),this._log.error(`startMixTranscode failed, errCode: ${a} errMsg: ${c}`),new V({code:b.START_MIX_TRANSCODE_FAILED,message:H({key:$.START_MIX_TRANSCODE_FAILED,data:{message:c},link:{className:"Client",fnName:"startMixTranscode"}})});this._data=s})}reStartMixTranscode(){!this.isMixing||this._config&&this.startMixTranscode(this._config)}stopMixTranscode(){return T(this,null,function*(){if(!this.isMixing)throw new V({code:b.INVALID_OPERATION,message:H({key:$.MIX_TRANSCODE_NOT_STARTED})});yield this.doStopMixTranscode(),this.resetIsUsedFlag()})}doStopMixTranscode(){return T(this,null,function*(){let t={mcuRequestTime:Date.now(),outputSessionId:this._data.outputSessionId,streamType:this._data.outputParam.streamType};this._log.info(`stopMixTranscode: ${JSON.stringify(t)}`);let e=yield this._room.sendStopMixTranscode(t),{code:r,message:n}=e.data;if(r===0)this._data=void 0;else throw this._log.error(`stopMixTranscode failed, errCode: ${r} errMsg: ${n}`),new V({code:b.STOP_MIX_TRANSCODE_FAILED,message:H({key:$.STOP_MIX_TRANSCODE_FAILED,data:{message:n},link:{className:"Client",fnName:"stopMixTranscode"}})})})}getOutputSessionId({config:t,userId:e,roomId:r}){return re(t.streamId)&&t.streamId.length>0?t.streamId:(0,Rl.default)(`${r}_${e}_main`)}getInputParam(t){let e=t.mixUsers.map(r=>({userId:r.userId,roomId:String(r.roomId||this._room.roomId),width:r.width||0,height:r.height||0,locationX:r.locationX||0,locationY:r.locationY||0,zOrder:r.zOrder,streamType:!y(r.streamType)&&r.streamType===An?1:0,inputType:r.pureAudio?ci.STREAM_TYPE.IT_PURE_AUDIO:ci.STREAM_TYPE.IT_AUDIO_VIDEO,renderMode:r.renderMode||0}));return t.mode===ci.MODE.PRESET_LAYOUT&&(e.forEach(r=>{if(r.userId===ci.PLACE_HOLDER.REMOTE){let n=[...this._remoteVideoTrackMap.entries()].find(([,s])=>!s);if(n){let[s]=n,o=s.split("_");r.userId=o.slice(0,o.length-1).join("_"),r.streamType=o.splice(-1)[0]==="auxiliary"?1:0,this._remoteVideoTrackMap.set(s,!0)}}}),e=e.filter(r=>r.userId!==ci.PLACE_HOLDER.REMOTE)),e}getOutputParam(t){let e=t.streamId||"";return{streamId:e,streamType:e.length>0?1:0,width:y(t.videoWidth)?640:t.videoWidth,height:y(t.videoHeight)?480:t.videoHeight,videoBps:t.videoBitrate||0,fps:t.videoFramerate||15,gop:t.videoGOP||2,audioSampleRate:t.audioSampleRate||48e3,audioBps:t.audioBitrate||64,audioChannels:t.audioChannels||1,backgroundColor:t.backgroundColor||0,backgroundImg:t.backgroundImage||"",extraInfo:"",videoCodec:2,audioCodec:0}}hasAvailablePlaceHolder(){var t,e;return!(!this.isPresetLayoutMode||((t=this._data)==null?void 0:t.inputParam.length)===((e=this._config)==null?void 0:e.mixUsers.length))}resetIsUsedFlag(){this._remoteVideoTrackMap.forEach((t,e)=>{this._remoteVideoTrackMap.set(e,!1)})}},Al=mc;var IP=h(_(),1),Os=h(pc(),1);var dn=class{constructor(t){p(this,"_room");p(this,"_publishTencentMainStreamObj",{params:null,streamId:void 0,isPublishing:!1});p(this,"_publishTencentAuxStreamObj",{params:null,streamId:void 0,isPublishing:!1});p(this,"_publishGivenCDNData",null);p(this,"_isPublishingGivenCDN",!1);this._room=t}get _isPublishingTencentCDN(){return this._publishTencentMainStreamObj.isPublishing||this._publishTencentAuxStreamObj.isPublishing}generatePublishCDNStreamId(t,e){if(!t){let r=`${this._room.roomId}_${this._room.userId}_${this.convertStreamType(e)}`;return/^[A-Za-z\d_-]*$/.test(r)||(r=(0,Os.default)(r)),`${this._room.sdkAppId}_${r}`}return t}convertStreamType(t){return t==="main"?t:"aux"}generatePublishCDNSessionId(t){return(0,Os.default)(`${this._room.roomId}_${this._room.userId}_${this.convertStreamType(t)}`)}startPublishCDN(t){return T(this,null,function*(){let{streamId:e="",streamType:r="main",appId:n,bizId:s,url:o}=t;yield this.startPublishTencentCDN({streamId:e,streamType:r}),n&&s&&o&&(yield this.startPublishGivenCDN({streamType:r,appId:n,bizId:s,url:o}))})}stopPublishCDN(){return T(this,null,function*(){if(!this._isPublishingTencentCDN)throw new V({code:b.INVALID_OPERATION,message:H({key:$.INVALID_OPERATION_STOP_PUBLISH_CDN})});yield this.stopPublishTencentCDN(),this._isPublishingGivenCDN&&(yield this.stopPublishGivenCDN())})}startPublishTencentCDN(t){return T(this,null,function*(){if(t.streamType==="auxiliary"?(this._publishTencentAuxStreamObj.params=t,this._publishTencentAuxStreamObj.isPublishing=!0):(this._publishTencentMainStreamObj.params=t,this._publishTencentMainStreamObj.isPublishing=!0),!this._room.isJoined)return;let e=this.generatePublishCDNStreamId(t.streamId,t.streamType),r=this.generatePublishCDNSessionId(t.streamType),n=t.streamType==="auxiliary"?1:0,s={requestTime:Date.now(),sessionId:r,streamId:e,streamType:n};yield this.doStartPublishTencentCDN(s,t.streamType)})}doStartPublishTencentCDN(t,e){return T(this,null,function*(){try{M.info(`startPublishTencentCDN: ${JSON.stringify(t)}`);let r=yield this._room.sendStartPublishCDN(t,!0),{code:n}=r.data,{message:s}=r.data;if(n===0)e==="auxiliary"?this._publishTencentAuxStreamObj.streamId=t.streamId:this._publishTencentMainStreamObj.streamId=t.streamId;else throw e==="auxiliary"?this._publishTencentAuxStreamObj.isPublishing=!1:this._publishTencentMainStreamObj.isPublishing=!1,n===-102083&&(s=`Please enable relayed-push in ${In} and try later, refer to ${Pi}tutorial-26-advanced-publish-cdn-stream.html`),M.error(`startPublishTencentCDN failed, errCode: ${n}, errMsg: ${s}`),new V({code:b.START_PUBLISH_CDN_FAILED,message:H({key:$.START_PUBLISH_CDN_FAILED,data:{message:s},link:{className:"Client",fnName:"startPublishCDNStream"}})})}catch(r){throw e==="auxiliary"?this._publishTencentAuxStreamObj.isPublishing=!1:this._publishTencentMainStreamObj.isPublishing=!1,r}})}resetPublishTencentParam(t){t==="main"&&(this._publishTencentMainStreamObj={params:null,streamId:void 0,isPublishing:!1}),t==="auxiliary"&&(this._publishTencentAuxStreamObj={params:null,streamId:void 0,isPublishing:!1})}stopPublishTencentCDN(){return T(this,null,function*(){if(!this._room.isJoined){this.resetPublishTencentParam("main"),this.resetPublishTencentParam("auxiliary");return}this._publishTencentMainStreamObj.isPublishing&&(yield this.doStopPublishTencentCDN("main")),this._publishTencentAuxStreamObj.isPublishing&&(yield this.doStopPublishTencentCDN("auxiliary"))})}doStopPublishTencentCDN(t){return T(this,null,function*(){let e={requestTime:Date.now(),sessionId:(0,Os.default)(`${this._room.roomId}_${this._room.userId}_${this.convertStreamType(t)}`)};M.info(`stopPublishTencentCDN: ${JSON.stringify(e)}`);let r=yield this._room.sendStopPublishCDN(e,!0),{code:n,message:s}=r.data;if(n===0)this.resetPublishTencentParam(t);else if(n===-102069)M.warn("stopPublishTencentCDN failed, can not stopPublishTencentCDN in auto relayed-push mode"),this.resetPublishTencentParam(t);else throw M.error(`stopPublishTencentCDN failed, errCode: ${n} errMsg: ${s}`),new V({code:b.STOP_PUBLISH_CDN_FAILED,message:H({key:$.STOP_PUBLISH_CDN_FAILED,data:{message:s},link:{className:"Client",fnName:"stopPublishCDNStream"}})})})}startPublishGivenCDN(t){return T(this,null,function*(){let e=t.streamType==="main"?this._publishTencentMainStreamObj.streamId:this._publishTencentAuxStreamObj.streamId,r={pushRequestTime:Date.now(),pushAppId:t.appId,pushBizId:t.bizId,pushCdnUrl:t.url,pushStreamType:this.convertStreamType(t.streamType),pushStreamId:e};if(M.info(`startPublishGivenCDN: ${JSON.stringify(r)}`),this._publishGivenCDNData=r,this._isPublishingGivenCDN=!0,!!this._room.isJoined)try{let n=yield this._room.sendStartPublishCDN(r,!1),{code:s,message:o}=n.data;if(s!==0)throw M.error(`startPublishGivenCDN failed, errCode: ${s}, errMsg: ${o}`),this._publishGivenCDNData=null,this._isPublishingGivenCDN=!1,new V({code:b.START_PUBLISH_CDN_FAILED,message:H({key:$.START_PUBLISH_CDN_FAILED,data:{message:o},link:{className:"Client",fnName:"startPublishCDNStream"}})})}catch(n){throw this._publishGivenCDNData=null,this._isPublishingGivenCDN=!1,n}})}stopPublishGivenCDN(){return T(this,null,function*(){if(!this._room.isJoined||!this._publishGivenCDNData){this._publishGivenCDNData=null,this._isPublishingGivenCDN=!1;return}let{pushAppId:t,pushBizId:e,pushCdnUrl:r,pushStreamType:n}=this._publishGivenCDNData,s={pushRequestTime:Date.now(),pushAppId:t,pushBizId:e,pushCdnUrl:r,pushStreamType:n};M.info(`stopPublishGivenCDN: ${JSON.stringify(s)}`);let o=yield this._room.sendStopPublishCDN(s,!1),{code:a,message:c}=o.data;if(a===0)this._publishGivenCDNData=null,this._isPublishingGivenCDN=!1;else throw M.error(`stopPublishGivenCDN failed, errCode: ${a} errMsg: ${c}`),new V({code:b.STOP_PUBLISH_CDN_FAILED,message:H({key:$.STOP_PUBLISH_CDN_FAILED,data:{message:c},link:{className:"Client",fnName:"stopPublishCDNStream"}})})})}handleCDNConfigForJoinData(t){let e=t,r;if(this._publishTencentMainStreamObj.isPublishing||this._publishTencentAuxStreamObj.isPublishing){let n={};re(e)&&(n=JSON.parse(e)),n.Str_uc_params||(n.Str_uc_params={}),this._publishTencentMainStreamObj.isPublishing&&(this._publishTencentMainStreamObj.streamId?n.Str_uc_params.userdefine_streamid_main=this._publishTencentMainStreamObj.streamId:this._publishTencentMainStreamObj.params&&(n.Str_uc_params.userdefine_streamid_main=this.generatePublishCDNStreamId(this._publishTencentMainStreamObj.params.streamId,"main"))),this._publishTencentAuxStreamObj.isPublishing&&(this._publishTencentAuxStreamObj.streamId?n.Str_uc_params.userdefine_streamid_aux=this._publishTencentAuxStreamObj.streamId:this._publishTencentAuxStreamObj.params&&(n.Str_uc_params.userdefine_streamid_aux=this.generatePublishCDNStreamId(this._publishTencentAuxStreamObj.params.streamId,"auxiliary"))),e=JSON.stringify(n)}if(this._isPublishingGivenCDN&&this._publishGivenCDNData){let{pushAppId:n,pushBizId:s,pushCdnUrl:o,pushStreamType:a,pushStreamId:c}=this._publishGivenCDNData;r={pushRequestTime:Date.now(),pushAppId:n,pushBizId:s,pushCdnUrl:o,pushStreamType:a,pushStreamId:c}}return{bussinessInfo:e,pushUserCdnInfo:r}}reset(){this.resetPublishTencentParam("main"),this.resetPublishTencentParam("auxiliary"),this._publishGivenCDNData=null,this._isPublishingGivenCDN=!1}};var LP=h(_(),1);function yl(a){return T(this,arguments,function*({userId:i,sdkAppId:t,useStringRoomId:e,roomId:r,userSig:n,version:s,frameWorkType:o}){let c={delta:0,count:[1,1],msg:[]};try{let d=new FormData;d.append("userId",String(i)),d.append("sdkAppId",String(t)),d.append("isStrGroupId",String(e)),d.append("groupId",String(r)),d.append("sdkVersion",s),d.append("userSig",String(n)),d.append("frameWorkType",String(o));let u=ee(),l=yield c_(d,c,t);return c.delta=ee()-u,l}catch(d){let u=ke(d)?d[0]:d,l=de(u.code)?u.code:0,m=`get websocket url failed: ${u.message.includes("timeout")?"timeout":u.message}`,I=new V({code:b.SCHEDULE_FAILED,extraCode:l,message:H({key:$.JOIN_ROOM_FAILED,data:{error:m,code:l}})});throw M.error(I),I}})}function Cl(i,t=f.MAIN){let e;return Hn(i)?e=t===f.MAIN?mr.MAIN_OVERSEA:mr.BACKUP_OVERSEA:e=t===f.MAIN?mr.MAIN:mr.BACKUP,`https://${e}/api/v1/config`}function a_(i,t,e){return new Promise((r,n)=>{zt({url:i,body:t,timeout:e.timeout}).then(s=>{s.data.code===0?r(s.data.data):n({code:s.data.code,message:s.data.msg})}).catch(n)})}var vl=(i,t)=>_t({retryFunction:a_,settings:{retries:3,timeout:0},onError:t,onRetrying:i});function c_(i,t,e){return new Promise((r,n)=>{let s=null;Oo([vl(o=>t.count[0]=o+1,(o,a)=>{t.msg[0]=o.message,s||a()})(Cl(e,f.MAIN),i,{get timeout(){return Ui(2+t.count[0])*1e3}}),vl(o=>t.count[1]=o+1,(o,a)=>{t.msg[1]=o.message,s||a()})(Cl(e,f.BACKUP),i,{get timeout(){return Ui(2+t.count[1])*1e3}})]).then(o=>{s=o,r(s)}).catch(n)})}var d_=0;var bs=class extends ue{constructor(e){super("room");this.seq=d_++;this.role="anchor";this.localTracks=new Set;this.enableAutoPlayDialog=!0;this.autoReceiveAudio=!0;this.autoReceiveVideo=!0;this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null};this._log=M.createLogger({id:`r${this.seq}`});this._joinedTimestamp=0;this._isDestroyed=!1;this.useStringRoomId=!!e.useStringRoomId,Pt(e.autoReceiveAudio)&&(this.autoReceiveAudio=e.autoReceiveAudio),Pt(e.autoReceiveVideo)&&(this.autoReceiveVideo=e.autoReceiveVideo),Pt(e.enableAutoPlayDialog)&&(this.enableAutoPlayDialog=e.enableAutoPlayDialog),this.keyPointManager=new Tl({room:this,frameWorkType:e.frameWorkType,component:e.component}),this.callDurationCalculator=new Sl({room:this}),this.badCaseDetector=new Il({room:this}),this.mixTranscodeManager=new Al(this),this.publishCDNManager=new dn(this)}get isMainStreamPublished(){for(let e of this.localTracks)if(e.mediaType&4)return!0;return!1}get isAuxStreamPublished(){for(let e of this.localTracks)if(e.mediaType&2)return!0;return!1}get hasAuxStream(){for(let e of this.remotePublishedUserMap.values())if(e.muteState.hasAuxiliary)return!0;return this.isAuxStreamPublished}getLogger(){return this._log}get isJoined(){return this.state==="joined"}addTrack(e){return T(this,null,function*(){return this.publish(e)})}removeTrack(e){return T(this,null,function*(){return this.unpublish(e)})}replaceTrack(e){return T(this,null,function*(){})}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAIVoice(e){throw new Error("Method not implemented.")}getRemoteAudioStats(){return T(this,null,function*(){let e={};return this.remotePublishedUserMap.forEach(r=>{e[r.userId]=r.remoteAudioTrack.stat}),e})}getTransportStats(){return T(this,null,function*(){var r;let e={rtt:((r=this.quality)==null?void 0:r.uplinkRTT)||0,downlinksRTT:{}};if(this.quality)for(let n of this.quality.downlinkInfo)e.downlinksRTT[n.userId]=n.rtt;return e})}getRemoteVideoStats(){return T(this,arguments,function*(e="main"){let r={};return this.remotePublishedUserMap.forEach(n=>{let s=e==="auxiliary"?n.remoteAuxiliaryTrack:n.remoteVideoTrack;r[n.userId]=s.stat}),r})}checkDestroy(){if(this._isDestroyed)throw new V({code:b.INVALID_OPERATION,message:H({key:$.CLIENT_DESTROYED,data:{funName:"join"}})})}destroy(){if(this.isJoined)throw this._log.warn(He.INVALID_DESTROY),new V({code:b.INVALID_OPERATION,message:H({key:$.INVALID_DESTROY})});this._log.info("destroy room"),this.keyPointManager.destroy(),this.callDurationCalculator.destroy(),this.badCaseDetector.destroy(),this._isDestroyed=!0,C.emit(S.ROOM_DESTROY,{room:this})}startMixTranscode(e){return this.mixTranscodeManager.startMixTranscode(e)}stopMixTranscode(){return this.mixTranscodeManager.stopMixTranscode()}startPublishCDNStream(){return T(this,arguments,function*(e={}){if(this._log.info(`startPublishCDNStream with params: ${JSON.stringify(e)}; isJoined: ${this.isJoined}; hasMainStream: ${this.isMainStreamPublished}; hasAuxStream: ${!!this.isAuxStreamPublished};`),this.isJoined){if(e.streamType==="main"&&!this.isMainStreamPublished)throw new V({code:b.INVALID_OPERATION,message:H({key:$.INVALID_OPERATION_START_PUBLISH_CDN})});if(e.streamType==="auxiliary"&&!this.isAuxStreamPublished)throw new V({code:b.INVALID_OPERATION,message:H({key:$.INVALID_OPERATION_START_PUBLISH_CDN})})}yield this.publishCDNManager.startPublishCDN(e)})}stopPublishCDNStream(){return this.publishCDNManager.stopPublishCDN()}schedule(e,r,n){return T(this,null,function*(){var o;let s=ee();try{let a=yield yl({userId:this.userId,sdkAppId:this.sdkAppId,roomId:e,useStringRoomId:this.useStringRoomId,version:n,userSig:this.userSig,frameWorkType:r});this._log.info(`schedule: ${JSON.stringify(a)}`),this.scheduleResult=w(w({},this.scheduleResult),a),de((o=a.config)==null?void 0:o.retryCount)&&ud(a.config.retryCount),C.emit(S.JOIN_SCHEDULE_SUCCESS,{room:this,schedule:this.scheduleResult}),C.emit(S.API_SUCCESS_RATE,{room:this,apiName:"schedule",cost:ee()-s})}catch(a){throw C.emit(S.API_SUCCESS_RATE,{room:this,apiName:"schedule",error:a}),a}})}};var AM=h(_(),1);var er=new WeakMap,At=new WeakMap;function hc(){return function(i,t,e){let r=e.value,n=({fn:s,args:o,context:a,resolve:c,reject:d})=>{s.apply(a,o).then(c,d).finally(()=>{let u=er.get(a);u&&(u.shift(),u[0]&&n(w({},u[0])))})};return e.value=function(...s){return new Promise((o,a)=>{if(er.has(this)){let c=er.get(this),{length:d}=c;c.push({fn:r,args:s,context:this,resolve:o,reject:a}),d===0&&n({fn:r,args:s,context:this,resolve:o,reject:a})}else er.set(this,[{fn:r,args:s,context:this,resolve:o,reject:a}]),n({fn:r,args:s,context:this,resolve:o,reject:a})})},e}}function Nl(i){return function(t,e,r){let n=r.value;return r.value=function(...s){var a,c;let o=[];return(a=er.get(this))==null||a.forEach(d=>o.push(d)),(c=At.get(this))==null||c.forEach(d=>d.forEach(u=>o.push(u))),o.forEach(d=>{d.reject(new V({code:b.API_CALL_ABORTED,message:i}))}),er.delete(this),At.delete(this),n.apply(this,s)},r}}function _c(i){return function(t,e,r){let n=r.value,s=a=>de(i)?a[i]:i(...a),o=({fn:a,args:c,context:d,resolve:u,reject:l})=>{a.apply(d,c).then(u,l).finally(()=>{if(At.has(d)&&At.get(d).has(s(c))){let m=At.get(d).get(s(c));m&&(m.shift(),m[0]&&o(w({},m[0])))}})};return r.value=function(...a){return new Promise((c,d)=>{if(At.has(this))if(At.get(this).has(s(a))){let u=At.get(this).get(s(a));if(u){let{length:l}=u;u.push({fn:n,args:a,context:this,resolve:c,reject:d}),l===0&&o({fn:n,args:a,context:this,resolve:c,reject:d})}}else At.get(this).set(s(a),[{fn:n,args:a,context:this,resolve:c,reject:d}]),o({fn:n,args:a,context:this,resolve:c,reject:d});else{let u=new Map;u.set(s(a),[{fn:n,args:a,context:this,resolve:c,reject:d}]),At.set(this,u),o({fn:n,args:a,context:this,resolve:c,reject:d})}})},r}}var{isString:Ps,isPlainObject:u_,isUndefined:ii,getNetworkType:l_,getTerminalType:p_,isEmpty:un}=Ge,Ct=class extends bs{constructor(e){super(e);this.privateMapKey="";this._heartbeat=-1;this._lastHeartBeatTime=-1;this._joinTimeout=-1;this._firstPublishedList=null;this._joinReject=null;this._isPublishing=!1;this._isRelayChanged=!1;this.uplinkConnection=null;this._changeBigSmallRecords=new Map;this._networkQuality=null;this._networkType=l_();this._turnServers=[];this._syncUserListInterval=-1;this._smallStreamConfig={bitrate:100,frameRate:15,height:120,width:160};this.enableSEI=!1;this._enableAudioVolumeEvaluation=!1;this._audioVolumeIntervalId=null;this._enableMultiAuxStream=!1;this._pureAudioPushMode=!1;this.audioManager=null;this._stats=new sn(this,this._log),this.userManager=new Ss(this.userId,this._log),this._version=Be,this.sdpSemantics=pr,ii(e.sdpSemantics)?Lt.isUnifiedPlanDefault()&&(this.sdpSemantics=ai):this.sdpSemantics=e.sdpSemantics,this._log.info(`sdpSemantics: ${this.sdpSemantics}, netType: ${this._networkType}`),this.audioManager=new as({log:this._log}),e.iceTransportPolicy&&(this._iceTransportPolicy=e.iceTransportPolicy),this._enableMultiAuxStream=ii(e.enableMultiAuxStream)?!1:e.enableMultiAuxStream,this.enableSEI=e.enableSEI,this._initBusinessInfo(e)}get isMainStreamPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.isMainStreamPublished)}get isMainAudioPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.localMainAudioTrack)}get isAuxStreamPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.isAuxStreamPublished)}get hasAuxStream(){return[...this.remotePublishedUserMap.values()].findIndex(e=>e.muteState.hasAuxiliary)>=0}get userMap(){return this.userManager.userMap}get remotePublishedUserMap(){return this.userManager.remotePublishedUserMap}get tinyIdToUserIdMap(){return new Map([...this.remotePublishedUserMap.values()].map(e=>[e.tinyId,e.userId]))}join(e,r,n){return T(this,null,function*(){this.userManager.mySelfId=this.userId,this.userManager.on("1",o=>{this.emit("peer-join",o)}),this.userManager.on("2",o=>{this.closeDownLinkConnection(o,"remote user exitRoom"),this.emit("peer-leave",o)}),this.userManager.on("3",this.createDownlinkConnection,this),this.userManager.on("5",this.closeDownLinkConnection,this),this.userManager.on("6",a=>{var o=Cc(a,[]);C.emit(S.REMOTE_PUBLISH_STATE_CHANGED,w({room:this},o)),this.emit("remote-publish-state-changed",w({},o))});let s=String(e.roomId||e.strRoomId);return this._joinOptions=e,new Promise((o,a)=>T(this,null,function*(){this._joinReject=a;try{this.checkDestroy(),yield this.initialize(),yield this.doJoin(e),o(),this._firstPublishedList&&this.onPublishedUserList({data:{userList:this._firstPublishedList}})}catch(c){this.reset(),a(c)}this._joinReject=null}))})}doJoin(e){return new Promise((r,n)=>{var d;ii(e.role)||(this.role=e.role===20?"anchor":"audience"),ii(e.privateMapKey)||(this.privateMapKey=e.privateMapKey);let s={roomId:String(e.roomId||e.strRoomId),useStringRoomId:this.useStringRoomId,privateMapKey:this.privateMapKey,trtcRole:this.role==="anchor"?20:21,trtcScene:this.scene==="live"?2:1,sdpSemantics:this.sdpSemantics,version:this._version,ua:navigator&&navigator.userAgent||"",terminalType:p_(),netType:si[this._networkType],bussinessInfo:this._businessInfo},{bussinessInfo:o,pushUserCdnInfo:a}=this.publishCDNManager.handleCDNConfigForJoinData(this._businessInfo);Object.assign(s,{bussinessInfo:o,pushUserCdnInfo:a}),this._log.debug(`join room signal data: ${JSON.stringify(s)}`);let c=5e3;((d=this.scheduleResult.config)==null?void 0:d.enterRoomTimeout)&&this.scheduleResult.config.enterRoomTimeout>=1&&(c=this.scheduleResult.config.enterRoomTimeout*1e3),this._joinTimeout=window.setTimeout(()=>{this._log.error("join room timeout observed"),n(new V({code:b.JOIN_ROOM_FAILED,message:H({key:$.JOIN_ROOM_TIMEOUT})}))},c),C.emit(S.JOIN_SEND_CMD,{room:this}),this._signalChannel.once(ve.SETUP_FAILED,u=>{this.clearJoinTimeout(),C.emit(S.JOIN_SIGNAL_CONNECTION_END,{room:this,error:u}),n(u)}),this._signalChannel.send(pe.JOIN_ROOM,s),this._signalChannel.once(se.JOIN_ROOM_RESULT,u=>{this.clearJoinTimeout();let{code:l,message:m,data:I}=u.data;C.emit(S.JOIN_RECEIVED_CMD_RES,{room:this,code:l}),l===0?(this._log.info("Join room success, start heartbeat"),this.startHeartbeat(),this.syncUserList(),this.startSyncUserListInterval(),this._firstPublishedList=I.publishers,r()):(this._log.error(`Join room failed result: ${l} error: ${m}`),n(new V({code:b.JOIN_ROOM_FAILED,extraCode:l,message:H({key:$.JOIN_ROOM_FAILED,data:{error:m,code:l}})})))})})}reJoin(){return T(this,null,function*(){if(!this.isJoined){this._log.warn("reJoin abort");return}try{this._log.warn(`reJoin pending: ${this._joinOptions.roomId}`),this._signalChannel.close(),yield this._signalChannel.connect(),yield this.doJoin(ie(w({},this._joinOptions),{role:this.role==="anchor"?20:21,privateMapKey:this.privateMapKey})),this._log.warn("reJoin success"),Ae.logSuccessEvent({userId:this.userId,eventType:oi.REJOIN}),this.checkConnectionsToReconnect(),this.uplinkConnection&&!this.uplinkConnection.getIsReconnecting()&&this.uplinkConnection.startReconnection(),this.mixTranscodeManager.reStartMixTranscode()}catch(e){this._log.warn(`reJoin fail ${e}`),this.reset(),Ae.logFailedEvent({userId:this.userId,eventType:oi.REJOIN,error:e}),this.emit("error",new V({code:b.JOIN_ROOM_FAILED,message:H({key:$.REJOIN_ROOM_FAILED,data:{roomId:this._joinOptions.roomId}})}))}})}initialize(){this._log.info("setup signal channel");let{mainUrl:e,backupUrl:r}=this.getSignalChannelUrl();return this._signalChannel=new Zr({sdkAppId:this.sdkAppId,userId:this.userId,userSig:this.userSig,url:e,backupUrl:r,room:this}),this._networkQuality||(this._networkQuality=new vi({signalChannel:this._signalChannel,room:this}),this._networkQuality.on(vi.EVENT_NETWORK_QUALITY,n=>{this.emit("network-quality",n)})),this._signalChannel.on(ve.CONNECTION_STATE_CHANGED,n=>{C.emit(S.SIGNAL_CONNECTION_STATE_CHANGED,w({room:this},n)),this.emit("signal-connection-state-changed",n)}),this._signalChannel.on(ve.RECONNECT_FAILED,n=>{this.reset(),this.emit("error",n)}),this._signalChannel.once(ve.SETUP_SUCCESS,n=>{this.tinyId=n.signalInfo.tinyId,C.emit(S.JOIN_SIGNAL_CONNECTION_END,{room:this})}),this._signalChannel.on(se.PEER_JOIN,n=>{let{srcTinyId:s,userId:o,role:a}=n.data.data;this.userManager.addUser({userId:o,tinyId:s,role:a})}),this._signalChannel.on(se.PEER_LEAVE,n=>{let{userId:s,reason:o=0}=n.data.data;this.userManager.deleteUser(s,o)}),this._signalChannel.on(se.UPDATE_REMOTE_MUTE_STAT,n=>{Date.now()-this._lastHeartBeatTime>=10*1e3&&this.doHeartbeat(),this.onPublishedUserList(n.data)}),this._signalChannel.on(se.CLIENT_BANNED,n=>{let s=n.data.data,{reason:o}=s;if(Ae.uploadEvent({log:`stat-banned:${o}`,userId:this.userId}),o==="user_time_out"){this._log.warn(`${o} last heart beat time: ${this._lastHeartBeatTime} interval: ${Date.now()-this._lastHeartBeatTime}, visibility: ${document.visibilityState}`),this.reJoin();return}this._log[o==="kick"?"error":"info"](`user was banned because of [${o}]`),this.reset(),this.emit("banned",{reason:o})}),C.emit(S.JOIN_SIGNAL_CONNECTION_START,{room:this}),this._signalChannel.connect()}leave(){return T(this,null,function*(){try{yield this.doHeartbeat()}catch(e){}C.emit(S.LEAVE_SEND_CMD,{room:this}),this._log.info("leave() => leaving room"),this._signalChannel.send(pe.LEAVE_ROOM),this.reset()})}clearNetworkQuality(){this._networkQuality&&(this._networkQuality.stop(),this._networkQuality=null)}closeConnections(){this.remotePublishedUserMap.forEach(e=>{this.closeDownLinkConnection(e.userId,"you exitRoom")})}clearJoinTimeout(){clearTimeout(this._joinTimeout),this._joinTimeout=-1}startHeartbeat(){this._heartbeat===-1&&(this._heartbeat=le.run(yt,this.doHeartbeat.bind(this),{delay:2e3}))}stopHeartbeat(){this._heartbeat!==-1&&(this._log.info("stopHeartbeat"),le.clearTask(this._heartbeat),this._heartbeat=-1,this._lastHeartBeatTime=-1)}doHeartbeat(){return T(this,null,function*(){var a;let e=this.badCaseDetector.getMonitorFreeze(),r=yield this._stats.getStatsReport({uplinkConnection:this.uplinkConnection,downlinkConnections:this.remotePublishedUserMap,freezeMap:e});if(this.badCaseDetector.resetMonitor(),!((a=this._signalChannel)!=null&&a.isConnected))return;let n=this._signalChannel.isConnected?Ou(this.userId):[],s=w({str_sdk_version:Oi,uint64_datetime:new Date().getTime(),msg_user_info:{str_identifier:this.userId,uint64_tinyid:this.tinyId},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:si[this._networkType]},msg_event_msg:n,str_acc_ip:this.getSignalInfo().relayIp,str_client_ip:this.getSignalInfo().clientIp},r);C.emit(S.HEARTBEAT_REPORT,{room:this,report:s}),this._signalChannel.send(pe.ON_QUALITY_REPORT,s);let o=Date.now();this._lastHeartBeatTime>0&&o-this._lastHeartBeatTime>1e4&&this._log.warn(`heartbeat took ${o-this._lastHeartBeatTime}`),this._signalChannel.isConnected&&(this._lastHeartBeatTime=o),!this._isRelayChanged&&this.isRelayMaybeFailed()&&(this.reJoin(),this._isRelayChanged=!0)})}onPublishedUserList(e){if(!this.isJoined)return;let r=e.data.userList.map(({userId:n,srcTinyId:s,flag:o})=>{let a=this.remotePublishedUserMap.get(n);return a&&this._changeBigSmallRecords.has(n)&&this.checkSubscribeBigSmallVideo(a),{userId:n,tinyId:s,flag:o}});C.emit(S.RECEIVED_PUBLISHED_USER_LIST,{room:this,publishedUserList:r}),this.userManager.setRemotePublishedUserList(r)}closeUplink(e="you unpublished"){this.uplinkConnection&&(this.localTracks.size>0&&this.uplinkConnection.doUnpublish(),this.uplinkConnection.close(e),this.uplinkConnection=null),this.localTracks.forEach(r=>r.unpublish()),this.localTracks.clear()}createDownlinkConnection({userId:e,tinyId:r,flag:n}){let s=new ul({userId:e,tinyId:r,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:n});this.userManager.addRemotePublishedUser(s),this.installDownlinkEvents(s,e),this.emit("remote-published",s)}closeDownLinkConnection(e,r="remote user unpublished"){let n=this.remotePublishedUserMap.get(e);n&&(n.getIsReconnecting()&&n.stopReconnection(),n.close(r),this.emit("remote-unpublished",n))}installDownlinkEvents(e,r){e.on("error",n=>{let s=n.getCode();s!==b.ICE_TRANSPORT_ERROR&&(s===b.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLinkConnection(r),this.emit("error",n))}),e.on("connection-state-changed",n=>{this.emit("media-connection-state-changed",ie(w({},n),{userId:e.userId}))}),e.on("firewall-restriction",()=>{this.emit("firewall-restriction")})}startSyncUserListInterval(){this._syncUserListInterval===-1&&(this._syncUserListInterval=le.run(yt,this.syncUserList.bind(this)))}stopSyncUserListInterval(){le.clearTask(this._syncUserListInterval),this._syncUserListInterval=-1}syncUserList(){return this.getUserList().then(e=>{this.userManager.setUserList(e)}).catch(e=>{this._log.debug(`sync user list failed: ${e}`)})}getUserList(){var e;return(e=this._signalChannel)!=null&&e.isConnected?this._signalChannel.sendWaitForResponse({command:pe.GET_USER_LIST,responseCommand:se.USER_LIST_RES,enableLog:!1,timeout:2e3}).then(({data:r})=>{let{code:n,message:s}=r;if(n===0)return(r.data&&r.data.userList||[]).map(({userId:a,srcTinyId:c,role:d})=>({userId:a,tinyId:c,role:d}));throw H({key:$.SIGNAL_RESPONSE_FAILED,data:{signalResponse:se.USER_LIST_RES,code:n,message:s}})}):Promise.reject("not connected")}getAllConnections(){let e=[...this.remotePublishedUserMap.values()];return this.uplinkConnection&&e.push(this.uplinkConnection),e}isRelayMaybeFailed(){if(!this._signalChannel.isOnline||!Qa)return!1;let e=this.getAllConnections();if(e.length===0)return!1;for(let r=0;r<e.length;r++)if(e[r].getReconnectionCount()<6)return!1;return!0}checkConnectionsToReconnect(){this.getAllConnections().forEach(r=>{if(!r.getIsReconnecting()){let n=r.getPeerConnection();n&&n.connectionState===Oe.CLOSED&&(this._log.warn(`[${r.getUserId()}] pc is closed but not reconnect`),r.startReconnection())}})}destroy(){this._isDestroyed||(super.destroy(),this._joinReject&&(this._joinReject(new V({code:b.INVALID_OPERATION,message:H({key:$.CLIENT_DESTROYED,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.removeAllListeners())}switchRole(e){return T(this,null,function*(){this.role!==e&&(e==="audience"&&this.uplinkConnection&&this.closeUplink("you switch role to audience"),yield this.doSwitchRole(e))})}doSwitchRole(e){let r={command:pe.SWITCH_ROLE,data:{role:e==="anchor"?20:21,privateMapKey:this.privateMapKey},responseCommand:se.SWITCH_ROLE_RES,retries:1};return this._log.info(`switchRole signal data: ${JSON.stringify(r.data)}`),this._signalChannel.sendWaitForResponseWithRetry(r).then(n=>{let{code:s,message:o}=n.data;if(s!==0)throw new V({code:b.SWITCH_ROLE_FAILED,message:H({key:$.SWITCH_ROLE_FAILED,data:{message:o,code:s}})});this.role=e}).catch(n=>{throw n instanceof V&&n.getCode()===b.API_CALL_TIMEOUT&&(n=new V({code:b.SWITCH_ROLE_FAILED,message:H({key:$.SWITCH_ROLE_TIMEOUT})})),this._log.error(n),n})}publish(...e){return T(this,null,function*(){if(this.scene==="live"&&this.role!=="anchor")return;C.emit(S.PUBLISH_START,{room:this});let r={},n={};this._isPublishing=!0,e.forEach(s=>{!s.mediaTrack||(s instanceof Ut&&(s instanceof Ti?(n.audio=s,this.audioManager.addScreenAudioTrack(s)):(r.audio=s,this.audioManager.addAudioTrack(s))),s instanceof it&&(s instanceof It&&s.mediaType===2?n.video=s:r.video=s),s.setPublishStarting())});try{let s=un(r),o=un(n);(!s||!o)&&!this.uplinkConnection&&(this.uplinkConnection=new _l({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),this.uplinkConnection.on("connection-state-changed",a=>{this.emit("media-connection-state-changed",ie(w({},a),{userId:this.userId}))}),this.uplinkConnection.on("firewall-restriction",()=>{this.emit("firewall-restriction")}),this.uplinkConnection.on("error",a=>{let c=a.getCode();c!==b.ICE_TRANSPORT_ERROR&&(c===b.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emit("error",a))})),s||(this._log.info("publish() => main stream"),yield this.uplinkConnection.publish({localAudioTrack:r.audio,localVideoTrack:r.video,isAuxiliary:!1}),this._log.info("main stream is published")),o||(this._log.info("publish() => aux stream"),yield this.uplinkConnection.publish({localAudioTrack:n.audio,localVideoTrack:n.video,isAuxiliary:!0}),this._log.info("aux stream is published")),this._isPublishing=!1,e.forEach(a=>{!a.mediaTrack||(this.localTracks.add(a),a.publish(this))})}catch(s){throw e.forEach(o=>{let a="error";s.message.includes("timeout")?a="timeout":s.code===b.API_CALL_ABORTED&&(a="api-call"),o.setPublishStopped(a,a==="error"?s:void 0)}),this._isPublishing=!1,s}})}unpublish(...e){return T(this,null,function*(){if(this.scene==="live"&&this.role!=="anchor"||!this.isMainStreamPublished&&!this.isAuxStreamPublished||!this.uplinkConnection)return;let r={},n={};e.forEach(s=>{!s.mediaTrack||(s instanceof Ut&&(s instanceof Ti?n.audio=s:r.audio=s),s instanceof it&&(s instanceof It&&s.mediaType===2?n.video=s:r.video=s))});try{un(r)||(this._log.info("unpublish() => main stream"),yield this.uplinkConnection.unpublish({localAudioTrack:r.audio,localVideoTrack:r.video})),un(n)||(this._log.info("unpublish() => aux stream"),yield this.uplinkConnection.unpublish({localAudioTrack:n.audio,localVideoTrack:n.video}))}catch(s){}e.forEach(s=>{!s.mediaTrack||(s.unpublish(),this.localTracks.delete(s))}),this.localTracks.size===0&&this.closeUplink("you unpublished")})}addTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():(e.setPublishStarting(),this.uplinkConnection.addTrack(e.mediaTrack,e).then(r=>(e.publish(this),r)))}removeTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():this.uplinkConnection.removeTrack(e.mediaTrack,e).then(r=>(e.unpublish(),r))}replaceTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():this.uplinkConnection.replaceTrack(e.mediaTrack,e).then(r=>{C.emit(S.LOCAL_TRACK_REPLACED,{track:e})})}setBandWidth(e){return T(this,null,function*(){!this.uplinkConnection||(yield this.uplinkConnection.setBandwidth(e),yield this.uplinkConnection.sendMediaSettings())})}subscribe(...e){return T(this,null,function*(){let{userId:r}=e[0],n=this.remotePublishedUserMap.get(r);if(!n)return;let s=e.find(o=>o.mediaType===2)?"auxiliary":"main";try{let o=w({},n.subscribeState);e.forEach(c=>{switch(c.mediaType){case 1:o.audio=!0;break;case 4:o.video=!0;break;case 2:o.auxiliary=!0;break}});let a=this._changeBigSmallRecords.get(r);a&&a.options.smallVideo&&n.muteState.hasSmall&&o.video&&(o.video=!1,o.smallVideo=!0),C.emit(S.SUBSCRIBE_START,{room:this,streamType:s,remotePublishedUser:n,subscribeState:o}),this._log.info(`subscribe() => ${s} [${vs(o)}] prev: [${vs(n.subscribeState)}]`),yield n.subscribe(o,s),n.remoteVideoTrack.setMediaType(o.smallVideo?8:4),e.forEach(c=>c.subscribe()),C.emit(S.SUBSCRIBE_SUCCESS,{room:this,streamType:s,remotePublishedUser:n})}catch(o){let a=o instanceof V?o.getCode():b.UNKNOWN,c=o;throw o instanceof V?a===b.REMOTE_STREAM_NOT_EXIST&&(c=new V({code:b.API_CALL_ABORTED,message:H({key:$.API_CALL_ABORTED,data:{message:o.message,userId:r,streamType:s}})}),this._log.warn(c)):(c=new V({code:a,message:H({key:$.SUBSCRIBE_FAILED,data:{message:o.message,userId:r,streamType:s}})}),this._log.error(c)),c}})}unsubscribe(...e){return T(this,null,function*(){let{userId:r}=e[0],n=this.remotePublishedUserMap.get(r);if(!n)return;let s=e.find(o=>o.mediaType===2)?"auxiliary":"main";this._log.info(`unsubscribe() => ${s}`),yield n.unsubscribe({remoteTracks:e,streamType:s}),e.forEach(o=>{o.unsubscribe(),o.mediaType===8&&o.setMediaType(4)}),C.emit(S.UNSUBSCRIBE_SUCCESS,{room:this,streamType:s,remotePublishedUser:n})})}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAudioVolumeEvaluation(e=2e3,r){if(e<=0){this._enableAudioVolumeEvaluation=!1,le.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null;return}e=Math.floor(Math.max(e,100)),C.emit(S.AUDIO_LEVEL_INTERVAL,{interval:e}),this._audioVolumeIntervalId&&(le.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null),this._enableAudioVolumeEvaluation=!0,this._audioVolumeIntervalId=le.run(jt,()=>{var s,o;let n=[];if((s=this.uplinkConnection)!=null&&s.localMainAudioTrack){let a=Math.floor(this.uplinkConnection.localMainAudioTrack.getAudioLevel()*100);n.push({userId:"",volume:a})}(o=this.remotePublishedUserMap)==null||o.forEach(a=>{if(a.muteState.hasAudio){let c=Math.floor(a.remoteAudioTrack.getAudioLevel()*100);n.push({userId:a.userId,volume:c})}}),this.emit("audio-volume",n)},{fps:1e3/e,backgroundTask:r})}getLocalAudioStats(){return T(this,null,function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0},this.uplinkConnection){let r=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:r.audio.bytesSent,packetsSent:r.audio.packetsSent}}return e})}getLocalVideoStats(){return T(this,null,function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection){let{video:{bytesSent:r,packetsSent:n,framesEncoded:s,framesSent:o,frameWidth:a,frameHeight:c}}=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:r,packetsSent:n,framesEncoded:s,framesSent:o,frameWidth:a,frameHeight:c}}return e})}getTransportStats(){return T(this,null,function*(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection){let r=yield this._stats.getSenderStats(this.uplinkConnection);e.rtt=r.rtt}for(let[,r]of this.remotePublishedUserMap){let n=yield this._stats.getReceiverStats(r);e.downlinksRTT[n.userId]=n.rtt}return e})}getRemoteVideoStats(e){return T(this,null,function*(){let r={};for(let[n,s]of this.remotePublishedUserMap)e==="main"&&s.muteState.hasVideo&&(r[n]=s.remoteVideoTrack.stat),e==="auxiliary"&&s.muteState.hasAuxiliary&&(r[n]=s.remoteAuxiliaryTrack.stat);return r})}getRemoteAudioStats(){return T(this,null,function*(){let e={};for(let[r,n]of this.remotePublishedUserMap)n.muteState.hasAudio&&(e[r]=n.remoteAudioTrack.stat);return e})}setProxyServer(e){if(Ps(e)){if(!e.startsWith("wss://"))throw new V({code:b.INVALID_PARAMETER,message:"invalid websocket url"});this.proxy_ws=e}else if(u_(e)){let{websocketProxy:r,loggerProxy:n}=e;r&&(this.proxy_ws=r),n&&ed(n)}}setTurnServer(e,r){this._log.info(`set turn server: ${JSON.stringify(e)} ${r||""}`);let n=[];Array.isArray(e)?e.forEach(s=>n.push(Ge.getTurnServer(s))):Ge.isPlainObject(e)&&n.push(Ge.getTurnServer(e)),this._turnServers=n,r&&(this._iceTransportPolicy=r)}sendStartMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:pe.START_MIX_TRANSCODE,data:e,timeout:5e3,responseCommand:se.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"})}sendStopMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:pe.STOP_MIX_TRANSCODE,data:e,timeout:5e3,responseCommand:se.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"})}sendStartPublishCDN(e,r=!0){return this._signalChannel.sendWaitForResponse({command:r?pe.START_PUBLISH_TENCENT_CDN:pe.START_PUBLISH_GIVEN_CDN,data:e,timeout:5e3,responseCommand:r?se.START_PUBLISH_TENCENT_CDN_RES:se.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDN"})}sendStopPublishCDN(e,r=!0){return this._signalChannel.sendWaitForResponse({command:r?pe.STOP_PUBLISH_TENCENT_CDN:pe.STOP_PUBLISH_GIVEN_CDN,data:e,timeout:5e3,responseCommand:r?se.STOP_PUBLISH_TENCENT_CDN_RES:se.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDN"})}getIceServers(){return this._turnServers.length===0&&this.scheduleResult.iceServers?this.scheduleResult.iceServers:this._turnServers}getIceTransportPolicy(){return this._iceTransportPolicy||this.scheduleResult.iceTransportPolicy||"all"}getLogger(){return this._log}enableAIVoice(){throw new Error("Method not implemented.")}getSignalChannelUrl(){let e={mainUrl:"",backupUrl:""},r=Ge.getEnv();return r?(e.mainUrl=`wss://${r}.rtc.qq.com`,e.backupUrl=e.mainUrl):this.proxy_ws?(e.mainUrl=this.proxy_ws,e.backupUrl=e.mainUrl):Array.isArray(this.scheduleResult.domains)&&this.scheduleResult.domains.length>0&&(e.mainUrl=`wss://${this.scheduleResult.domains[0]}`,e.backupUrl=e.mainUrl,this.scheduleResult.domains[1]&&(e.backupUrl=`wss://${this.scheduleResult.domains[1]}`)),e}getSignalInfo(){var e;return((e=this._signalChannel)==null?void 0:e.getSignalInfo())||{}}reset(){this.mixTranscodeManager.reset(),this.publishCDNManager.reset(),this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.clearNetworkQuality(),this.closeUplink("you exitRoom"),this._signalChannel&&(this._log.info("destroying SignalChannel"),this._signalChannel.close()),this._stats.reset(),this.userManager.clear(),this.userManager.removeAllListeners()}checkSubscribeBigSmallVideo(e){return T(this,null,function*(){let r=e==null?void 0:e.muteState.hasSmall,n=e==null?void 0:e.muteState.hasVideo;if(!r&&!n||!e.isBigStreamSubscribed&&!e.isSmallStreamSubscribed)return;let s=e.getUserId(),o=this._changeBigSmallRecords.get(s)||{},a=e.getSubscribeState(),{options:c,isSubscribing:d,reSubscribeCount:u}=o;if(c.video&&a.video||c.smallVideo&&a.smallVideo&&r||d)return;let l={audio:a.audio,auxiliary:a.auxiliary,video:c.video,smallVideo:c.smallVideo};if(r&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed)try{c&&!d&&u>=1&&(o.isSubscribing=!0,o.reSubscribeCount=u-1,!r&&e.isSmallStreamSubscribed&&(l.video=!0,l.smallVideo=!1),yield e==null?void 0:e.subscribe(l,"main"),e.remoteVideoTrack.setMediaType(l.smallVideo?8:4),this._log.info(`change [${s}] to ${l.smallVideo?"small":"big"} video successfully. count ${hr-o.reSubscribeCount}.`),o.isSubscribing=!1,o.reSubscribeCount=hr)}catch(m){this._log.info(`change [${s}] to ${l.smallVideo?"small":"big"} video failed. count ${hr-o.reSubscribeCount}.`),o.isSubscribing=!1,u===0&&this._changeBigSmallRecords.delete(s)}})}changeType(e,r){let s={options:{video:!e,smallVideo:e},isSubscribing:!1,reSubscribeCount:hr};this._changeBigSmallRecords.set(r.userId,s),this._log.info(`set [${r.userId}] video prefer type: ${e?"small":"big"}`)}get smallStreamConfig(){return this._smallStreamConfig}_initBusinessInfo(e){this._businessInfo=e.businessInfo;let r={};if(Ps(e.businessInfo)&&(r=JSON.parse(e.businessInfo)),!ii(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new V({code:b.INVALID_PARAMETER,message:H({key:$.INVALID_PURE_AUDIO})});this._pureAudioPushMode=e.pureAudioPushMode,r.Str_uc_params||(r.Str_uc_params={}),r.Str_uc_params.pure_audio_push_mod=this._pureAudioPushMode}if(!ii(e.streamId))if(Ps(e.streamId)&&String(e.streamId)&&String(e.streamId).length<=64)r.Str_uc_params||(r.Str_uc_params={}),r.Str_uc_params.userdefine_streamid_main=e.streamId;else throw new V({code:b.INVALID_PARAMETER,message:H({key:$.INVALID_STREAMID})});if(!ii(e.userDefineRecordId)){let n=/^[A-Za-z0-9_-]{1,64}$/gi;if(e.userDefineRecordId.match(n)===null)throw new V({code:b.INVALID_PARAMETER,message:H({key:$.INVALID_USER_DEFINE_RECORDID})});r.Str_uc_params||(r.Str_uc_params={}),r.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!ii(e.userDefinePushArgs))if(Ps(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256)r.Str_uc_params||(r.Str_uc_params={}),r.Str_uc_params.userdefine_push_args=e.userDefinePushArgs;else throw new V({code:b.INVALID_PARAMETER,message:H({key:$.INVALID_USER_DEFINE_PUSH_ARGS})});un(r)||(this._businessInfo=JSON.stringify(r))}startPlugin(e,r){return T(this,null,function*(){var n;e==="RTCAudioMixer"&&(yield(n=this.audioManager)==null?void 0:n.addMusicSource(r))})}stopPlugin(e,r){return T(this,null,function*(){var n;e==="RTCAudioMixer"&&((n=this.audioManager)==null||n.removeMusicSource(r))})}};G([ye(["left",ue.INIT],"joined"),Ju()],Ct.prototype,"join",1),G([ye("joined","left",{ignoreError:!0}),Xu(),Nl("leave room"),an({fnName:"publish",validateArgs:!1}),an({fnName:"unsubscribe",validateArgs:!1})],Ct.prototype,"leave",1),G([hc(),on({settings:{retries:lr,timeout:i=>mt(i)},onError(i,t,e){var r;(r=i.message)!=null&&r.includes("timeout")?(this._log.warn("publish timeout"),t()):(this._log.error(`publish failed: ${i}`),e(i))}})],Ct.prototype,"publish",1),G([an({fnName:"publish",callback(...i){var t;this.localTracks.size===0&&((t=this.uplinkConnection)==null||t.close("you unpublished"),this.uplinkConnection=null,i.forEach(e=>e.setPublishStopped("api-call")))}}),hc()],Ct.prototype,"unpublish",1),G([_c((...i)=>i[0].userId),on({settings:{retries:lr,timeout:i=>mt(i)},onError(i,t,e){i.message.includes("timeout")?(this._log.warn("subscribe timeout"),t()):(this._log.error(`subscribe failed: ${i}`),e(i))}})],Ct.prototype,"subscribe",1),G([an({fnName:"subscribe",callback(...i){i.forEach(t=>{let e=this.remotePublishedUserMap.get(t.userId);e&&!e.isMainStreamSubscribed&&!e.isAuxStreamSubscribed&&e.close("you unsubscribed")})}}),_c((...i)=>i[0].userId)],Ct.prototype,"unsubscribe",1);Qr.create=Qr._create.bind(Qr,Ct);var lL=Qr;export{lL as default};
