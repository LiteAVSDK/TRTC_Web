var ms=Object.defineProperty,jd=Object.defineProperties,Jd=Object.getOwnPropertyDescriptor,Yd=Object.getOwnPropertyDescriptors;var Xr=Object.getOwnPropertySymbols,Xd=Object.getPrototypeOf,Ma=Object.prototype.hasOwnProperty,ka=Object.prototype.propertyIsEnumerable,Qd=Reflect.get;var Qr=Math.pow,_s=(r,t,e)=>t in r?ms(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,R=(r,t)=>{for(var e in t||(t={}))Ma.call(t,e)&&_s(r,e,t[e]);if(Xr)for(var e of Xr(t))ka.call(t,e)&&_s(r,e,t[e]);return r},k=(r,t)=>jd(r,Yd(t));var wa=(r,t)=>{var e={};for(var i in r)Ma.call(r,i)&&t.indexOf(i)<0&&(e[i]=r[i]);if(r!=null&&Xr)for(var i of Xr(r))t.indexOf(i)<0&&ka.call(r,i)&&(e[i]=r[i]);return e};var zi=(r,t)=>{for(var e in t)ms(r,e,{get:t[e],enumerable:!0})};var N=(r,t,e,i)=>{for(var o=i>1?void 0:i?Jd(t,e):t,s=r.length-1,n;s>=0;s--)(n=r[s])&&(o=(i?n(t,e,o):n(o))||o);return i&&o&&ms(t,e,o),o};var d=(r,t,e)=>(_s(r,typeof t!="symbol"?t+"":t,e),e);var Bt=(r,t,e)=>Qd(Xd(r),e,t);var _=(r,t,e)=>new Promise((i,o)=>{var s=c=>{try{a(e.next(c))}catch(l){o(l)}},n=c=>{try{a(e.throw(c))}catch(l){o(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,n);a((e=e.apply(r,t)).next())});import oL from"webrtc-adapter";import{EventEmitter as rh}from"eventemitter3";var Va=(b=>(b[b.INVALID_PARAMETER=4096]="INVALID_PARAMETER",b[b.INVALID_OPERATION=4097]="INVALID_OPERATION",b[b.NOT_SUPPORTED=4098]="NOT_SUPPORTED",b[b.DEVICE_NOT_FOUND=4099]="DEVICE_NOT_FOUND",b[b.INITIALIZE_FAILED=4100]="INITIALIZE_FAILED",b[b.SIGNAL_CHANNEL_SETUP_FAILED=16385]="SIGNAL_CHANNEL_SETUP_FAILED",b[b.SIGNAL_CHANNEL_ERROR=16386]="SIGNAL_CHANNEL_ERROR",b[b.ICE_TRANSPORT_ERROR=16387]="ICE_TRANSPORT_ERROR",b[b.JOIN_ROOM_FAILED=16388]="JOIN_ROOM_FAILED",b[b.CREATE_OFFER_FAILED=16389]="CREATE_OFFER_FAILED",b[b.SIGNAL_CHANNEL_RECONNECTION_FAILED=16390]="SIGNAL_CHANNEL_RECONNECTION_FAILED",b[b.UPLINK_RECONNECTION_FAILED=16391]="UPLINK_RECONNECTION_FAILED",b[b.DOWNLINK_RECONNECTION_FAILED=16392]="DOWNLINK_RECONNECTION_FAILED",b[b.REMOTE_STREAM_NOT_EXIST=16400]="REMOTE_STREAM_NOT_EXIST",b[b.CLIENT_BANNED=16448]="CLIENT_BANNED",b[b.SERVER_TIMEOUT=16449]="SERVER_TIMEOUT",b[b.SUBSCRIPTION_TIMEOUT=16450]="SUBSCRIPTION_TIMEOUT",b[b.PLAY_NOT_ALLOWED=16451]="PLAY_NOT_ALLOWED",b[b.DEVICE_AUTO_RECOVER_FAILED=16452]="DEVICE_AUTO_RECOVER_FAILED",b[b.START_PUBLISH_CDN_FAILED=16453]="START_PUBLISH_CDN_FAILED",b[b.STOP_PUBLISH_CDN_FAILED=16454]="STOP_PUBLISH_CDN_FAILED",b[b.START_MIX_TRANSCODE_FAILED=16455]="START_MIX_TRANSCODE_FAILED",b[b.STOP_MIX_TRANSCODE_FAILED=16456]="STOP_MIX_TRANSCODE_FAILED",b[b.NOT_SUPPORTED_H264=16457]="NOT_SUPPORTED_H264",b[b.SWITCH_ROLE_FAILED=16458]="SWITCH_ROLE_FAILED",b[b.API_CALL_TIMEOUT=16459]="API_CALL_TIMEOUT",b[b.SCHEDULE_FAILED=16460]="SCHEDULE_FAILED",b[b.API_CALL_ABORTED=16461]="API_CALL_ABORTED",b[b.UNKNOWN=65535]="UNKNOWN",b))(Va||{}),T=Va;var qd=function(r){for(let t in T)if(T[t]===r)return t;return"UNKNOWN"},ps=class extends Error{constructor({name:e="RtcError",message:i,code:o=T.UNKNOWN,extraCode:s=0,constraint:n}){let a=`<${qd(o)} 0x${o.toString(16)}>`,c=`${i}${n?` constraint: ${n}`:""}${i!=null&&i.includes(a)?"":` ${a}`}`;super(c);d(this,"code");d(this,"extraCode");d(this,"message");d(this,"originMessage");d(this,"name");d(this,"constraint");this.code=o,this.extraCode=s,this.name=e,this.message=c,this.constraint=n,this.originMessage=i}getCode(){return this.code}getExtraCode(){return this.extraCode}toString(){return this.originMessage}},A=ps;var Ua=new Date().getTime(),Es=0,xa=function(r){Ua=r,Es=Ua-new Date().getTime();let t=new Date;t.setTime(r),g.info(`baseTime from server: ${t} offset: ${Es}`)},Zi=function(){return new Date().getTime()+Es},qr=function(){let r=new Date;return r.setTime(Zi()),r.toLocaleString()};var me={};zi(me,{bytes2ms:()=>Ml,copyProperties:()=>Pl,deepMerge:()=>je,fibonacci:()=>ki,formatedTime:()=>Hl,getConstructorName:()=>Oo,getContainerFromElement:()=>yo,getEnv:()=>Ll,getInternalVersion:()=>Vl,getLoggerUrl:()=>Qt,getMuteStateFromFlag:()=>Nt,getNetworkQuality:()=>xl,getNetworkType:()=>Do,getOSType:()=>Ya,getReconnectionTimeout:()=>ye,getSysInfo:()=>vl,getTerminalType:()=>Ja,getTurnServer:()=>Bl,getValueType:()=>ee,glog:()=>qa,ipv4ToUint32:()=>Cr,isArray:()=>de,isArrayOrObject:()=>Sr,isAudioWorkletSupported:()=>Gs,isBoolean:()=>re,isConstructor:()=>Ar,isEmpty:()=>Rr,isFunction:()=>K,isLangChinese:()=>Ke,isMediaStreamTrack:()=>wl,isNumber:()=>J,isObject:()=>qt,isOverseaSdkAppId:()=>No,isPlainObject:()=>ot,isPromise:()=>gr,isRemoteTrack:()=>Ct,isString:()=>j,isUndefined:()=>I,ms2bytes:()=>kl,ms2samples:()=>Qa,performanceNow:()=>w,promiseAny:()=>Ws,samples2ms:()=>Xa,stringify:()=>zt});var Gt={};zi(Gt,{ANDROID_VERSION:()=>Is,CHROME_MAJOR_VERSION:()=>Ci,CHROME_VERSION:()=>po,EDGE_VERSION:()=>Zr,EDG_MAJOR_VERSION:()=>gs,EDG_VERSION:()=>eo,FIREFOX_MAJOR_VERSION:()=>Ss,FIREFOX_VERSION:()=>zr,HUAWEI_VERSION:()=>uo,IE_VERSION:()=>il,IOS_VERSION:()=>$t,IPADQQB_VERSION:()=>co,IS_ANDROID:()=>Oe,IS_ANDROID_WEBVIEW:()=>al,IS_ANY_SAFARI:()=>nl,IS_CHROME:()=>Ri,IS_CHROME_ONLY:()=>Rs,IS_EDG:()=>Ti,IS_EDGE:()=>fi,IS_ELECTRON:()=>ol,IS_FIREFOX:()=>Y,IS_HEADLESS_CHROME:()=>Cs,IS_HUAWEI:()=>sl,IS_HUAWEIBROWSER:()=>ar,IS_IE:()=>Ha,IS_IE8:()=>tl,IS_IOS:()=>De,IS_IOS_13_OR_14:()=>cl,IS_IOS_15_1:()=>Ht,IS_IPAD:()=>Ei,IS_IPADQQB:()=>sr,IS_IPAD_PRO:()=>Ts,IS_IPHONE:()=>ft,IS_IPOD:()=>$a,IS_LINUX:()=>Ai,IS_LOCAL:()=>we,IS_MAC:()=>Fe,IS_MACQQB:()=>or,IS_MIBROWSER:()=>nr,IS_MQQB:()=>gi,IS_NATIVE_ANDROID:()=>el,IS_OLD_ANDROID:()=>Zd,IS_OPPOBROWSER:()=>dr,IS_SAFARI:()=>ke,IS_SAFARI_15_1:()=>ur,IS_SAMSUNGBROWSER:()=>cr,IS_SOGOU:()=>tr,IS_SOGOUM:()=>er,IS_TBS:()=>He,IS_UCBROWSER:()=>As,IS_VIVOBROWSER:()=>lr,IS_WECHAT:()=>Ii,IS_WIN:()=>Tt,IS_WQQB:()=>rr,IS_WX:()=>rl,IS_X5MQQB:()=>Si,IS_XWEB:()=>ir,MACQQB_VERSION:()=>ao,MI_VERSION:()=>lo,MQQB_VERSION:()=>pi,OPPO_VERSION:()=>_o,SAFARI_VERSION:()=>Ni,SAMSUNG_VERSION:()=>ho,SOGOUM_VERSION:()=>to,SOGOU_VERSION:()=>io,TBS_VERSION:()=>ro,USER_AGENT:()=>Me,VIVO_VERSION:()=>mo,WECHAT_VERSION:()=>so,WQQB_VERSION:()=>no,XWEB_VERSION:()=>oo,browserInfo:()=>Ft,getBrowserInfo:()=>Fa,getChromeMajorVersion:()=>It,isLocalStorageEnabled:()=>et});var Me=typeof navigator=="undefined"?"":navigator.userAgent,B=r=>new RegExp(r,"i").test(Me),se=r=>{if(B(r)){let t=new RegExp(`${r}\\/([\\d.]+)`),e=Me.match(t);if(e&&e[1])return e[1]}return""},fs=r=>{if(B(r)){let t=new RegExp(`${r}\\/(\\d+)`),e=Me.match(t);if(e&&e[1])return parseFloat(e[1])}return NaN},Ba=/AppleWebKit\/([\d.]+)/i.exec(Me),zd=Ba?parseFloat(Ba[1]):NaN,Ei=B("iPad"),Ts=typeof navigator!="undefined"&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&B("Macintosh"),ft=B("iPhone")&&!Ei,$a=B("iPod"),De=ft||Ei||$a||Ts,Oe=B("Android"),Is=function(){if(Oe){let r=Me.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(r){let t=r[1]&&parseFloat(r[1]),e=r[2]&&parseFloat(r[2]);if(t&&e)return parseFloat(`${r[1]}.${r[2]}`);if(t)return t}}return NaN}(),Zd=Oe&&B("webkit")&&Is<2.3,el=Oe&&Is<5&&zd<537,Y=B("Firefox"),zr=se("Firefox"),Ss=fs("Firefox"),fi=B("Edge"),Zr=se("Edge"),Ti=B("Edg"),eo=se("Edg"),gs=fs("Edg"),er=B("SogouMobileBrowser"),to=se("SogouMobileBrowser"),tr=B("MetaSr\\s"),io=se("MetaSr\\s"),He=B("TBS"),ro=se("TBS"),ir=B("XWEB"),oo=se("XWEB"),tl=B("MSIE\\s8\\.0"),Ha=B("MSIE\\/\\d+"),il=function(){if(Ha){let r=/MSIE\s(\d+)\.\d/.exec(Me),t=r&&parseFloat(r[1]);return!t&&/Trident\/7.0/i.test(Me)&&/rv:11.0/.test(Me)&&(t=11),t}return NaN}(),Ii=B("(micromessenger|webbrowser)"),so=se("MicroMessenger"),Si=!He&&B("MQQBrowser")&&B("COVC"),gi=!He&&B("MQQBrowser")&&!B("COVC"),pi=gi||Si?se("MQQBrowser"):"",rr=!He&&B(" QQBrowser"),no=se(" QQBrowser"),or=!He&&B("QQBrowserLite"),ao=se("QQBrowserLite"),sr=!He&&B("MQBHD"),co=se("MQBHD"),Tt=B("Windows"),Fe=!De&&B("MAC OS X"),Ai=!Oe&&B("Linux"),rl=B("MicroMessenger"),As=B("UCBrowser"),ol=B("Electron"),nr=B("MiuiBrowser"),lo=se("MiuiBrowser"),ar=B("HuaweiBrowser"),sl=B("Huawei"),uo=se("HuaweiBrowser"),cr=B("SamsungBrowser"),ho=se("SamsungBrowser"),dr=B("HeyTapBrowser"),_o=se("HeyTapBrowser"),lr=B("VivoBrowser"),mo=se("VivoBrowser"),It=()=>fs("Chrome"),Rs=B("Chrome"),Ri=!fi&&!tr&&!er&&!He&&!ir&&!Ti&&!rr&&!nr&&!ar&&!cr&&!dr&&!lr&&Rs,Cs=B("HeadlessChrome"),Ci=It(),po=se("Chrome"),ke=!Rs&&!gi&&!Si&&!or&&!sr&&B("Safari"),nl=ke||De,Ni=se("Safari"),al=/Android.*(wv|.0.0.0)/.test(Me),$t=(()=>{if(Ts)return Ni;if(De){let r=Me.match(/OS (\d+)_(\d+)/i);if(r&&r[1]){let t=r[1];return r[2]&&(t+=`.${r[2]}`),t}}return""})(),ur=Ni==="15.1",Ht=$t==="15.1",cl=(()=>{let r=Number($t.split(".")[0]);return r===14||r===13})(),we=typeof location!="undefined"?location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1":!1,et=(()=>{let r;return()=>{if(I(r))try{r=!!window.localStorage}catch(t){r=!1}return r}})(),Ft=Fa();function Fa(){let r=new Map([[Y,["Firefox",zr]],[Ti,["Edg",eo]],[Ri,["Chrome",po]],[ke,["Safari",Ni]],[He,["TBS",ro]],[ir,["XWEB",oo]],[Ii&&ft,["WeChat",so]],[rr,["QQ(Win)",no]],[gi,["QQ(Mobile)",pi]],[Si,["QQ(Mobile X5)",pi]],[or,["QQ(Mac)",ao]],[sr,["QQ(iPad)",co]],[nr,["MI",lo]],[ar,["HW",uo]],[cr,["Samsung",ho]],[dr,["OPPO",_o]],[lr,["VIVO",mo]],[fi,["EDGE",Zr]],[er,["SogouMobile",to]],[tr,["Sogou",io]]]),t="unknown",e="unknown";return r.has(!0)&&([t,e]=r.get(!0)),{name:t,version:e}}var Fs={};zi(Fs,{AUDIO_MUTE_BIT:()=>go,AUDIO_STAT_BIT:()=>yi,AUX_STAT_BIT:()=>pr,AUX_STREAM_MSID:()=>Ms,BACKEND_ENV:()=>So,BASE_DOC_URL:()=>Kt,BASE_HOST:()=>Eo,CAPABILITIES_KEYS:()=>Co,CLASS_NAME:()=>Nl,CLOUD_CONSOLE_URL:()=>ll,DATA_FREEZE_TIMING:()=>Ro,DOC_URL:()=>ys,DTLS_STATE_UNKNOWN:()=>Ue,ENV_NAME:()=>tt,EXCHANGE_SDP_TIMEOUT:()=>xs,INTERVAL:()=>Hs,IS_WORKER:()=>Di,IS_WORKLET:()=>hr,KIBANA_EVENT:()=>Ge,LOCAL_STREAM_PUBLISH_STATE:()=>Ka,LOGGER_CMD_TYPE:()=>jt,LOGGER_DOMAIN:()=>bs,LOGGER_DOMAIN_OVERSEA:()=>Ls,LOG_LEVEL:()=>Ve,LOG_LEVEL_NAME:()=>Ol,MAIN_STREAM_MSID:()=>Er,MICROPHONE_COMMUNICATIONS:()=>Dl,MICROPHONE_DEFAULT:()=>Xt,NAME:()=>u,NETWORK_TYPE:()=>St,NOT_SUPPORTED_H264:()=>Yt,PAUSED_RETRY_COUNT:()=>Bs,PEERCONNECTION_CONNECTING_TIMEOUT:()=>Tr,PEER_CONNECTION_STATE:()=>q,PEER_LEAVE_REASON:()=>$s,RAF:()=>rt,RECOVER_CAPTURE_INTERVAL:()=>Pi,REMOTE_STREAM_TYPE_AUX:()=>ws,REMOTE_STREAM_TYPE_MAIN:()=>ks,RENDER_FREEZE_TIMING:()=>gl,RIC:()=>We,SCHEDULE_DOMAIN:()=>Li,SCHEDULE_TIMEOUT:()=>Cl,SDP_SEMANTICS_PLAN_B:()=>bi,SDP_SEMANTICS_UNIFIED_PLAN:()=>At,SECOND_HOST:()=>Ds,SIGNAL_PING_PONG_INTERVAL:()=>hl,SIGNAL_PING_TIMEOUT:()=>ul,SIGNAL_RECONNECTION_COUNT:()=>fr,SMALL_STAT_BIT:()=>Ps,SPEAKER_DEFAULT:()=>Ir,STORAGE_EXPIRES_TIME:()=>fo,STREAM_TYPE_BIG:()=>Al,STREAM_TYPE_SMALL:()=>Rl,SUBSCRIBE_SMALL_RETRY_COUNT:()=>vi,SYNC_USER_LIST_INTERVAL:()=>Sl,Scene:()=>gt,Switch:()=>Ga,THIRD_HOST:()=>Os,TIMEOUT:()=>Mi,TRANSPORT_DIRECTION:()=>W,TRTC_ERROR_ASSISTANCE:()=>vs,TRTC_QUALITY_BAD:()=>fl,TRTC_QUALITY_DISCONNECTED:()=>Il,TRTC_QUALITY_EXCELLENT:()=>ml,TRTC_QUALITY_GOOD:()=>pl,TRTC_QUALITY_POOR:()=>El,TRTC_QUALITY_UNKNOWN:()=>_l,TRTC_QUALITY_VERY_BAD:()=>Tl,UPDATE_OFFER_TIMEOUT:()=>Us,VIDEO_MUTE_BIT:()=>Ao,VIDEO_STAT_BIT:()=>Oi,audioProfileMap:()=>To,getRetryCount:()=>it,getScriptDir:()=>dl,innerVersion:()=>Wt,loggerProxy:()=>_r,screenProfileMap:()=>Io,setLoggerProxy:()=>mr,setRetryCount:()=>Vs,setVersion:()=>Ns,version:()=>_e,videoProfileMap:()=>Jt});var Wt="4.15.00.1600",_e="5.0.0";function Ns(r){_e=r;let[t,e,i]=r.split(".").map(o=>parseInt(o,10));Wt=`${t}.${Math.min(15,e)}.${Math.min(15,i)}.${e.toString().padStart(2,"0")}${i.toString().padStart(2,"0")}`}var Di=typeof importScripts!="undefined",hr=typeof registerProcessor!="undefined",dl=()=>{let r=Di?self.location.href:document.currentScript.src;return r.substring(0,r.lastIndexOf("/")+1)},_r="",mr=r=>_r=r,Eo="web.sdk.qcloud.com",Ds="web.sdk.tencent.cn",Os="web.sdk.cloud.tencent.cn",ll="https://console.cloud.tencent.com/trtc",Kt=`https://${Eo}/trtc/webrtc/v5/doc`,ys=`${Kt}/zh-cn/`,bs="https://yun.tim.qq.com",Ls="https://videoapi-sgp.im.qcloud.com",vs="trtc_error_assistance",jt={LOG:"jssdk_log",EVENT:"jssdk_event",KEY_POINT:"jssdk_new_endreport"},tt={QCLOUD:"qcloud",OLD_CLOUD_LADDER:"trtc",WEBRTC:"webrtc"},Ve=(n=>(n[n.TRACE=0]="TRACE",n[n.DEBUG=1]="DEBUG",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.NONE=5]="NONE",n))(Ve||{}),ul=18e3,hl=2e3,St={unknown:0,wifi:1,"3g":2,"2g":3,"4g":4,wired:5},fo=7*24*3600*1e3,Ga=(o=>(o.USEAINS="useAINS",o.ENABLEDEBUG="enableDebug",o.USEV2="useV2",o.USEWT="useWt",o))(Ga||{}),To={standard:{sampleRate:48e3,channelCount:1,bitrate:40},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},high:{sampleRate:48e3,channelCount:1,bitrate:192},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}},Jt={"120p":{width:160,height:120,frameRate:15,bitrate:200},"180p":{width:320,height:180,frameRate:15,bitrate:350},"240p":{width:320,height:240,frameRate:15,bitrate:400},"360p":{width:640,height:360,frameRate:15,bitrate:800},"480p":{width:640,height:480,frameRate:15,bitrate:900},"720p":{width:1280,height:720,frameRate:15,bitrate:1500},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"1440p":{width:2560,height:1440,frameRate:30,bitrate:4860},"4K":{width:3840,height:2160,frameRate:30,bitrate:9e3}},Io={"480p":{width:640,height:480,frameRate:5,bitrate:900},"480p_2":{width:640,height:480,frameRate:30,bitrate:1e3},"720p":{width:1280,height:720,frameRate:5,bitrate:1200},"720p_2":{width:1280,height:720,frameRate:30,bitrate:3e3},"1080p":{width:1920,height:1080,frameRate:5,bitrate:1600},"1080p_2":{width:1920,height:1080,frameRate:30,bitrate:4e3}},u={CANVAS:"canvas",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",SMALL:"small",BIG:"big",AUXILIARY:"auxiliary",SMALL_VIDEO:"smallVideo",FACING_MODE_USER:"user",FACING_MODE_ENVIRONMENT:"environment",MUTE:"mute",UNMUTE:"unmute",ENDED:"ended",PLAYING:"playing",PAUSE:"pause",ERROR:"error",LOADEDDATA:"loadeddata",AUDIO_INPUT:"audioinput",VIDEO_INPUT:"videoinput",DETAIL:"detail",TEXT:"text",MAIN:"main",BACKUP:"backup",BANNED:"banned",KICK:"kick",USER_TIME_OUT:"user_time_out",ROOM_DISBAND:"room_disband",SEI_MESSAGE:"sei-message",ADD:"add",REMOVE:"remove",REPLACE:"replace",TRACK:"track",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",TRANSCEIVER_DIRECTION_SENDONLY:"sendonly",TRANSCEIVER_DIRECTION_RECVONLY:"recvonly"},W={INACTIVE:"inactive",SENDONLY:"sendonly",RECVONLY:"recvonly"},So={OLD_CLOUD_LADDER:"wss://trtc.rtc.qq.com",WEBRTC:"wss://webrtc.qq.com"},gt=(e=>(e.LIVE="live",e.RTC="rtc",e))(gt||{}),Oi=1,Ps=2,pr=4,yi=8,go=64,Ao=16,Er="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",Ms="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",ks=u.MAIN,ws=u.AUXILIARY,_l=0,ml=1,pl=2,El=3,fl=4,Tl=5,Il=6,Ue="unknown",q={NEW:"new",CONNECTING:"connecting",FAILED:"failed",CLOSED:"closed",DISCONNECTED:"disconnected",CONNECTED:"connected",COMPLETED:"completed"},Wa=1/0;function Vs(r){Wa=r}function it(){return Wa}var fr=30,Ge={JOIN:"join",DELTA_JOIN:"delta-join",REJOIN:"rejoin",LEAVE:"leave",DELTA_LEAVE:"delta-leave",PUBLISH:"publish",DELTA_PUBLISH:"delta-publish",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",UPLINK_CONNECTION:"uplink-connection",UPLINK_RECONNECTION:"uplink-reconnection",DOWNLINK_CONNECTION:"downlink-connection",DOWNLINK_RECONNECTION:"downlink-reconnection",ON_TRACK:"ontrack",ICE_CONNECTION_STATE:"iceConnectionState",LOCAL_STREAM_INITIALIZE:"stream-initialize",SIGNAL_CONNECTION:"websocketConnectionState",SIGNAL_RECONNECTION:"websocketReconnectionState",UPDATE_STREAM:"update-stream",RECOVER_LOCAL_AUDIO_TRACK:"recover-local-audio-track",RECOVER_LOCAL_VIDEO_TRACK:"recover-local-video-track",RECOVER_SUBSCRIPTION:"recover-subscription",START_MIX_TRANSCODE:"start-mix-transcode",STOP_MIX_TRANSCODE:"stop-mix-transcode",PLAYER_ERROR:"player-error",SCHEDULE:"schedule",LOAD_WORKLET:"load-worklet",VIDEO_FROZEN_COUNT:"videoFrozenCount"},Sl=1e4,Us=1e4,xs=1e4,At="unified-plan",bi="plan-b",Yt=1028,Ka=(i=>(i[i.UNPUBLISH=-1]="UNPUBLISH",i[i.PUBLISHING=0]="PUBLISHING",i[i.PUBLISHED=1]="PUBLISHED",i))(Ka||{}),Ro=500,gl=1e3,Al=u.BIG,Rl=u.SMALL,Tr=10*1e3,Li={MAIN:"schedule.rtc.qq.com",BACKUP:"schedule.rtc.qcloud.com",MAIN_OVERSEA:"schedule.rtc.tencentcloud.com",BACKUP_OVERSEA:"schedule-ecdn.rtc.tencentcloud.com"},Cl=2e3,Nl={TRTC:"TRTC",CLIENT:"Client",LOCAL_STREAM:"LocalStream",REMOTE_STREAM:"RemoteStream",STREAM:"Stream"},Bs=5,Xt="default",Ir=Xt,Dl="communications",Ol=Object.keys(Ve),$s=["normal leave","timeout leave","kick","role change"],vi=10,Pi=2e3,We="ric",rt="raf",Hs="interval",Mi="timeout",Co=["width","height","frameRate","facingMode","sampleRate","sampleSize","channelCount","deviceId"];var Rt=1e8;var bl="trtc_env",Ll=function(){return new URLSearchParams(location.search).get(bl)||""},No=r=>Number(r)<14e8,Qt=function(r,t){let e;_r?e=_r:e=No(r)?Ls:bs;let i=Math.floor(Math.random()*Qr(2,31));return`${e}/v5/AVQualityReportSvc/C2S?random=${i}&sdkappid=${r}&cmdtype=${t}`};function Ja(){return Oe?4:ft?2:Ei?3:Fe?12:Tt?5:Ai?13:1}function Ya(){return Oe?"Android":ft?"iPhone":Ei?"iPad":Fe?"Mac":Tt?"Windows":Ai?"Linux":"unknown"}function Do(){let{userAgent:r,connection:t}=navigator,e=(r.match(/NetType\/\S+/)||[])[0]||"";e=e.toLowerCase().replace("nettype/",""),e==="3gnet"&&(e="3g");let i=t&&t.type&&t.type.toLowerCase(),o=t&&t.effectiveType&&t.effectiveType.toLowerCase();o==="slow-2"&&(o="2g");let s=e||"unknown";if(i)switch(i){case"cellular":case"wimax":s=o||"unknown";break;case"wifi":s="wifi";break;case"ethernet":s="wired";break;case"none":case"other":case"unknown":default:s="unknown";break}return s}var vl=function(r){return{AbilityOption:{AVLimit:r,GeneralLimit:{CPULimit:{uint32_CPU_num:navigator.hardwareConcurrency||0,str_CPU_name:String(navigator.platform),uint32_CPU_maxfreq:0,model:"",uint32_total_memory:0},uint32_terminal_type:Ja(),uint32_device_type:0,str_os_verion:Ya(),uint32_link_type:1,str_client_version:Wt,uint32_net_type:St[Do()],ua:navigator.userAgent,version:""}}}};function Pl(r,t){for(let e of Reflect.ownKeys(t))if(e!=="constructor"&&e!=="prototype"&&e!=="name"){let i=Object.getOwnPropertyDescriptor(t,e)||"";Object.defineProperty(r,e,i)}return r}function Ml(r,t=48e3){return Xa(r/4,t)}function Xa(r,t=48e3){return r*1e3/t}function kl(r,t=48e3){return Qa(r,t)*4}function Qa(r,t=48e3){return r*t/1e3}var qa=typeof window!="undefined"&&typeof window.glog=="function"?window.glog:()=>{},Ke=()=>{let r=navigator.language;return r=r.substring(0,2),r==="zh"},ot=function(r){if(!r||typeof r!="object"||Object.prototype.toString.call(r)!="[object Object]")return!1;let t=Object.getPrototypeOf(r);if(t===null)return!0;let e=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return typeof e=="function"&&e instanceof e&&Function.prototype.toString.call(e)===Function.prototype.toString.call(Object)};function ki(r,t=1,e=1){return r<=1?e:ki(r-1,e,t+e)}function ye(r){return r>8?30*1e3:ki(r)*1e3}function ee(r){return Reflect.apply(Object.prototype.toString,r,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var K=r=>typeof r=="function",I=r=>typeof r=="undefined",j=r=>typeof r=="string",J=r=>typeof r=="number",re=r=>typeof r=="boolean",qt=r=>ee(r)==="object",de=r=>ee(r)==="array",wl=r=>ee(r)==="MediaStreamTrack".toLowerCase(),Ct=r=>r.isRemote,gr=r=>ee(r)==="promise",Ar=r=>K(r)&&r.prototype.constructor===r,Oo=r=>Ar(r)?r.prototype.constructor.name:"",Gs=typeof AudioWorkletNode!="undefined";function Ws(r){return new Promise((t,e)=>{let i=[];r.forEach(o=>{o.then(t).catch(s=>{i.push(s),i.length===r.length&&e(i)})})})}function w(){return!performance||!performance.now?Date.now():Math.floor(performance.now())}var ja=r=>+r<10?`0${r}`:r,Vl=r=>{let t=r.match(/^\d+\.\d+\.\d+/)[0];if(!t)return r;let e=t.split("."),i=ja(e[1])+ja(e[2]);return e[1]-15>0&&(e[1]="15"),e[2]-15>0&&(e[2]="15"),`${e.join(".")}.${i}`},Ul=Object.prototype.hasOwnProperty,{toString:Jh}=Object.prototype;function Rr(r){if(r==null)return!0;if(typeof r=="boolean")return!1;if(typeof r=="number")return r===0;if(typeof r=="string"||typeof r=="function"||Array.isArray(r))return r.length===0;if(r instanceof Error)return r.message==="";if(ot(r))switch(Object.prototype.toString.call(r)){case"[object File]":case"[object Map]":case"[object Set]":return r.size===0;case"[object Object]":{for(let t in r)if(Ul.call(r,t))return!1;return!0}}return!1}function Nt(r,t){return{userId:t,hasAudio:!!(r&yi),hasVideo:!!(r&Oi),hasAuxiliary:!!(r&pr),hasSmall:!!(r&Ps),audioMuted:!!(r&go),videoMuted:!!(r&Ao),audioAvailable:!!(r&yi)&&!(r&go),videoAvailable:!!(r&Oi)&&!(r&Ao)}}function xl(r,t){return r>50||t>500?5:r>30||t>350?4:r>20||t>200?3:r>10||t>100?2:r>=0||t>=0?1:0}function Bl(r){let t={urls:`turn:${r.url}`};return!I(r.username)&&!I(r.credential)&&(t.username=r.username,t.credential=r.credential,t.credentialType="password",I(r.credentialType)||(t.credentialType=r.credentialType)),t}function Cr(r,t=!0){if(!j(r))return 0;let e=r.split(".");return t?(Number(e[0])<<24|Number(e[1])<<16|Number(e[2])<<8|Number(e[3]))>>>0:(Number(e[3])<<24|Number(e[2])<<16|Number(e[1])<<8|Number(e[0]))>>>0}var Sr=function(r){return de(r)||qt(r)},je=function(r,t,e,i){if(!(Sr(r)&&Sr(t)))return 0;let o=0,s=Object.keys(t),n;for(let a=0,c=s.length;a<c;a++)if(n=s[a],!(I(t[n])||e&&e.includes(n)))if(Sr(r[n])&&Sr(t[n]))o+=je(r[n],t[n],e,i);else{if(i&&i.includes(t[n]))continue;r[n]!==t[n]&&(r[n]=t[n],o+=1)}return o},yo=r=>j(r)?document.getElementById(r):r,$l=new Intl.DateTimeFormat("zh-CN",{dateStyle:"short",timeStyle:"medium"}),Hl=()=>$l.format(new Date);function zt(r,t){try{if(de(r))return`[${r.map(o=>zt(o,t)).join(",")}]`;if(!ot(r)||!de(t))return JSON.stringify(r);let e={},i=new Set(t);return Object.keys(r).forEach(o=>{i.has(o)&&(e[o]=r[o])}),JSON.stringify(e)}catch(e){return"{}"}}function Dt({url:r,body:t,method:e,timeout:i}){let o=new XMLHttpRequest;return new Promise((s,n)=>{o.onreadystatechange=()=>{if(o.readyState===4)if(o.status>=200&&o.status<300)try{let a=JSON.parse(o.response);s({data:a})}catch(a){s({data:o.response})}else n({status:o.status,statusText:o.statusText||"request failed!"})},o.timeout=i||5e3,o.open(e||"POST",r,!0),o.send(t)})}var Fl=0,Gl=1,za=2;function Wl({retryFunction:r,settings:t,onError:e,onRetrying:i,onRetryFailed:o,context:s}){return function(...n){let{retries:a=5,timeout:c=1e3}=t,l=0,h=-1,m=Fl,f=(L,D)=>_(this,null,function*(){let Q=s||this;try{let Ie=yield r.apply(Q,n);l=0,L(Ie)}catch(Ie){let Et=()=>{clearTimeout(h),l=0,m=za,D(Ie)},Yr=()=>{m!==za&&l<(K(a)?a():a)?(l++,m=Gl,K(i)&&i.call(this,l,Et),h=window.setTimeout(()=>{h=-1,f(L,D)},K(c)?c(l):c)):(Et(),K(o)&&o.call(this,Ie))};K(e)?e.call(Q,Ie,Yr,D,n):Yr()}});return new Promise(f)}}var Je=Wl;var wi=class{constructor(t){d(this,"userId");d(this,"remoteUserId");d(this,"id");d(this,"sdkAppId");d(this,"type");d(this,"isLocal");this.id=t.id,this.userId=t.userId,this.sdkAppId=t.sdkAppId,this.remoteUserId=t.remoteUserId,this.isLocal=re(t.isLocal)?t.isLocal:!0,this.type=this.isLocal?"":t.type}createChild(t){return Object.setPrototypeOf(t,this)}setUserId(t){this.userId=t}setSdkAppId(t){this.sdkAppId=t}log(t,e){let i=this.isLocal?this.userId:this.remoteUserId;e.unshift(`[${this.isLocal?"\u2191":"\u2193"}${this.type&&this.type!=="main"?"*":""}${this.id}${i?`|${i}`:""}]`),g.log(t,e,I(this.userId)||Rr(this.userId),this.userId,this.sdkAppId)}info(...t){this.log(2,t)}debug(...t){this.log(1,t)}warn(...t){this.log(3,t)}error(...t){this.log(4,t)}};import Kl from"eventemitter3";var jl=new Kl,E=jl;var Ks=(U=>(U.ROOM_DESTROY="1",U.JOIN_START="21",U.JOIN_SCHEDULE_SUCCESS="22",U.JOIN_SIGNAL_CONNECTION_START="23",U.JOIN_SIGNAL_CONNECTION_END="24",U.JOIN_SEND_CMD="25",U.JOIN_RECEIVED_CMD_RES="26",U.JOIN_SUCCESS="27",U.JOIN_FAILED="28",U.LEAVE_START="51",U.LEAVE_SEND_CMD="52",U.LEAVE_SUCCESS="53",U.PUBLISH_START="61",U.SEND_FIRST_VIDEO_FRAME="62",U.SUBSCRIBE_START="81",U.SUBSCRIBE_SUCCESS="82",U.UNSUBSCRIBE_SUCCESS="83",U.LOCAL_TRACK_CAPTURE_START="101",U.LOCAL_TRACK_CAPTURE_SUCCESS="102",U.LOCAL_TRACK_CAPTURE_FAILED="103",U.LOCAL_TRACK_PUBLISHED="104",U.LOCAL_TRACK_UNPUBLISHED="105",U.LOCAL_TRACK_REPLACED="106",U.SWITCH_DEVICE_SUCCESS="107",U.TRACK_MUTED="108",U.TRACK_UNMUTED="109",U.REMOTE_TRACK_SUBSCRIBED="110",U.REMOTE_TRACK_UNSUBSCRIBED="111",U.PLAY_TRACK_START="151",U.PLAYER_STATE_CHANGED="152",U.VIDEO_LOADED_DATA="153",U.AUTOPLAY_DIALOG_CLICK_CONFIRM="154",U.WORKLET_LOADED_SUCCESS="155",U.WORKLET_LOADED_FAILED="156",U.SIGNAL_CONNECTION_STATE_CHANGED="201",U.PEER_CONNECTION_STATE_CHANGED="202",U.HEARTBEAT_REPORT="251",U.RECEIVED_PUBLISHED_USER_LIST="252",U.REMOTE_PUBLISH_STATE_CHANGED="253",U.AUDIO_LEVEL_INTERVAL="260",U.NETWORK_QUALITY="261",U.API_SUCCESS_RATE="262",U))(Ks||{});var p=Ks;var Jl="%cTRTC%c%s",Yl="padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;",Xl="display: inline",Ql=!(De||Oe||Cs),js=class{constructor(){d(this,"_isEnableUploadLog",!0);d(this,"_localJoinedUser",new Map);d(this,"_queue",[]);d(this,"_timeoutId",-1);d(this,"_logLevel",1);d(this,"_logLevelToUpload",2);!Di&&!hr&&(this.checkURLParam(),this.installEvents())}get isAbleToUpload(){return this._isEnableUploadLog&&this._timeoutId!==-1}installEvents(){E.on(p.JOIN_SCHEDULE_SUCCESS,({schedule:t})=>{var e;((e=t==null?void 0:t.config)==null?void 0:e.logLevelToUpload)&&Ve[t.config.logLevelToUpload]&&(this._logLevelToUpload=t.config.logLevelToUpload)}),E.on(p.JOIN_SUCCESS,({room:t})=>{this.addJoinedUser({userId:t.userId,sdkAppId:t.sdkAppId}),this.startUpload()}),E.once(p.JOIN_FAILED,()=>{this.startUpload()}),E.on(p.LEAVE_SUCCESS,({room:t})=>{this.deleteJoinedUser(t.userId)})}startUpload(){this._timeoutId===-1&&this.uploadInterval()}addJoinedUser(t){this._localJoinedUser.set(t.userId,t),this.startUpload()}deleteJoinedUser(t){this._localJoinedUser.delete(t)}uploadInterval(){this.upload().catch(()=>{}),this._timeoutId=window.setTimeout(()=>this.uploadInterval(),2e3)}getLogsToUpload(){let t={map:new Map,splicedQueue:[]};if(this._queue[0].forAllJoinedClients&&this._localJoinedUser.size===0)return t;let e=0;for(;e<this._queue.length&&e!==50;e++){let i=this._queue[e];if(i.forAllJoinedClients)this._localJoinedUser.forEach(({userId:o,sdkAppId:s})=>{t.map.has(o)?t.map.get(o).logs.push(i):t.map.set(o,{userId:o,sdkAppId:s,logs:[i]})});else if(j(i.userId)&&J(i.sdkAppId)){let{userId:o,sdkAppId:s}=i;t.map.has(o)?t.map.get(o).logs.push(i):t.map.set(o,{userId:o,sdkAppId:s,logs:[i]})}}return t.map.size>0&&(t.splicedQueue=this._queue.splice(0,e)),t}upload(){return _(this,null,function*(){if(this._queue.length===0||!this._isEnableUploadLog)return;let{map:t,splicedQueue:e}=this.getLogsToUpload();if(t.size===0)return;try{let o=[...t.values()];for(let s=0;s<o.length;s++){let{userId:n,sdkAppId:a,logs:c}=o[s];yield this.uploadLogWithRetry(JSON.stringify({timestamp:qr(),sdkAppId:String(a),userId:n,version:_e,log:c.map(l=>l.log).join(`
`)}),a),c.forEach(l=>l.uploaded=!0)}}catch(o){}let i=e.filter(o=>!o.uploaded);i.length>0&&(this._queue=i.concat(this._queue))})}uploadLogWithRetry(t,e){return Je({retryFunction:()=>Dt({url:Qt(e,jt.LOG),body:t,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(i,o)=>{o()}})()}getPrefix(t){let e=new Date;e.setTime(Zi());let i=String(e.getMilliseconds());return"padStart"in String.prototype&&(i=i.toString().padStart(3,"0")),`[${e.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${i}] <${Ve[t]}>`}getLogLevel(){return this._logLevel}setLogLevel(t){I(Ve[t])||(this._logLevel!==t&&this.info("setLogLevel",t),this._logLevel=t)}enableUploadLog(){this._isEnableUploadLog=!0}disableUploadLog(){this.warn("disableUploadLog"),this._isEnableUploadLog=!1}logChunkToString(t){if(j(t))return t;try{return JSON.stringify(t)}catch(e){return""}}log(t,e,i=!0,o,s){var a;if(e.unshift(this.getPrefix(t)),this._isEnableUploadLog&&t>=this._logLevelToUpload&&this._queue.push({log:e.reduce((c,l)=>`${c} ${this.logChunkToString(l)}`.trim(),""),level:t,userId:o,sdkAppId:s,forAllJoinedClients:i}),t<this._logLevel)return;let n=((a=Ve[t])==null?void 0:a.toLowerCase())||"info";Ql?console[n](Jl,Yl,Xl,...e):console[n](...e)}debug(...t){this.log(1,t)}info(...t){this.log(2,t)}warn(...t){this.log(3,t)}error(...t){this.log(4,t)}createLogger(t){return new wi(t)}checkURLParam(){let e=new URLSearchParams(location.search).get("logLevelToUpload"),i=e?Number(e):-1;Ve[i]&&(this._logLevelToUpload=i)}},g=new js;var ql=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let t=Math.random()*16|0;return(r=="x"?t:t&3|8).toString(16)})},Js=ql;var Ys=class{constructor(){d(this,"_prefix","TRTC");d(this,"_queue",new Map);this.checkStorage()}getRealKey(t){return`${this._prefix}_${t}`}checkStorage(){if(!et())return;setInterval(this.doFlush.bind(this),2e4),Object.keys(localStorage).filter(i=>{if(i.startsWith(this._prefix)){let o=JSON.parse(localStorage.getItem(i));if(o&&o.expiresIn<Date.now())return!0}return!1}).forEach(i=>localStorage.removeItem(i))}doFlush(){if(!!et())try{for(let[t,e]of this._queue)localStorage.setItem(t,JSON.stringify(e))}catch(t){g.warn(t)}}getItem(t){if(!et())return null;try{let e=JSON.parse(localStorage.getItem(this.getRealKey(t)));return e&&e.expiresIn>=Date.now()?e.value:null}catch(e){g.warn(e)}}setItem(t,e){if(!!et())try{let i={expiresIn:Date.now()+fo,value:e};this._queue.set(this.getRealKey(t),i)}catch(i){g.warn(i)}}deleteItem(t){if(!et())return!1;try{return t=this.getRealKey(t),this._queue.delete(t),localStorage.removeItem(t),!0}catch(e){return g.warn(e),!1}}clear(){if(!!et())try{localStorage.clear()}catch(t){g.warn(t)}}},Vi=new Ys;var nt={};zi(nt,{HTTPS_API:()=>ou,IS_GET_CAPABILITIES_SUPPORTED:()=>en,IS_GET_SETTINGS_SUPPORTED:()=>st,IS_SEI_SUPPORTED:()=>bt,IS_SPC_SUPPORTED:()=>Po,basis:()=>cu,checkSystemRequirementsInternal:()=>zs,decodeSupportStatus:()=>Lo,encodeSupportStatus:()=>oc,getBrowserInfo:()=>iu,getDisplayResolution:()=>nc,getOSName:()=>sc,isAddTransceiverSupported:()=>yt,isBrowserSupported:()=>Xs,isGetReceiversSupported:()=>Zt,isGetSendersSupported:()=>Ui,isGetTransceiversSupported:()=>be,isGetUserMediaSupported:()=>ac,isMediaDevicesSupported:()=>bo,isMediaSessionSupported:()=>uc,isMediaStreamTrackProcessorSupported:()=>qs,isReplaceTrackSupported:()=>au,isScreenCaptureApiAvailable:()=>Zs,isSelectedCandidatePair:()=>Ot,isSetParametersSupported:()=>Nr,isSmallStreamAPISupported:()=>dc,isSmallStreamSupported:()=>vo,isStopTransceiverSupported:()=>nu,isTRTCSupported:()=>ru,isUnifiedPlanDefault:()=>su,isUsedInHttpProtocol:()=>Qs,isWebAudioSupported:()=>cc,isWebCodecSupported:()=>lc,isWebCodecsSupported:()=>rc,isWebRTCSupported:()=>tn,isWebTransportSupported:()=>hc});var C={AVOID_REPEATED_CALL:"AVOID_REPEATED_CALL",INVALID_PARAMETER_REQUIRED:"INVALID_PARAMETER_REQUIRED",INVALID_PARAMETER_TYPE:"INVALID_PARAMETER_TYPE",INVALID_PARAMETER_EMPTY:"INVALID_PARAMETER_EMPTY",INVALID_PARAMETER_INSTANCE:"INVALID_PARAMETER_INSTANCE",INVALID_PARAMETER_RANGE:"INVALID_PARAMETER_RANGE",INVALID_PARAMETER_MIN:"INVALID_PARAMETER_MIN",INVALID_PARAMETER_MAX:"INVALID_PARAMETER_MAX",INVALID_PARAMETER_STREAMTYPE:"INVALID_PARAMETER_STREAMTYPE",API_CALL_TIMEOUT:"API_CALL_TIMEOUT",SIGNAL_CHANNEL_RECONNECTION_FAILED:"SIGNAL_CHANNEL_RECONNECTION_FAILED",SIGNAL_CHANNEL_SETUP_FAILED:"SIGNAL_CHANNEL_SETUP_FAILED",ERROR_MESSAGE:"ERROR_MESSAGE",EXCHANGE_SDP_TIMEOUT:"EXCHANGE_SDP_TIMEOUT",DOWNLINK_RECONNECTION_FAILED:"DOWNLINK_RECONNECTION_FAILED",EXCHANGE_SDP_FAILED:"EXCHANGE_SDP_FAILED",UPDATE_OFFER_TIMEOUT:"UPDATE_OFFER_TIMEOUT",UPLINK_RECONNECTION_FAILED:"UPLINK_RECONNECTION_FAILED",INVALID_RECORDID:"INVALID_RECORDID",INVALID_PURE_AUDIO:"INVALID_PURE_AUDIO",INVALID_STREAMID:"INVALID_STREAMID",INVALID_USER_DEFINE_RECORDID:"INVALID_USER_DEFINE_RECORDID",INVALID_USER_DEFINE_PUSH_ARGS:"INVALID_USER_DEFINE_PUSH_ARGS",INVALID_PROXY:"INVALID_PROXY",INVALID_JOIN:"INVALID_JOIN",INVALID_ROOMID_STRING:"INVALID_ROOMID_STRING",INVALID_ROOMID_INTEGER:"INVALID_ROOMID_INTEGER",INVALID_SIGNAL_CHANNEL:"INVALID_SIGNAL_CHANNEL",JOIN_ROOM_TIMEOUT:"JOIN_ROOM_TIMEOUT",JOIN_ROOM_FAILED:"JOIN_ROOM_FAILED",REJOIN_ROOM_FAILED:"REJOIN_ROOM_FAILED",INVALID_DESTROY:"INVALID_DESTROY",INVALID_PUBLISH:"INVALID_PUBLISH",INVALID_UNPUBLISH:"INVALID_UNPUBLISH",INVALID_AUDIENCE:"INVALID_AUDIENCE",INVALID_INITIALIZE:"INVALID_INITIALIZE",INVALID_DUPLICATE_PUBLISHING:"INVALID_DUPLICATE_PUBLISHING",INVALID_SUBSCRIBE_UNDEFINED:"INVALID_SUBSCRIBE_UNDEFINED",INVALID_SUBSCRIBE_LOCAL:"INVALID_SUBSCRIBE_LOCAL",INVALID_REMOTE_STREAM:"INVALID_REMOTE_STREAM",SUBSCRIBE_FAILED:"SUBSCRIBE_FAILED",INVALID_ROLE:"INVALID_ROLE",INVALID_PARAMETER_SWITCH_ROLE:"INVALID_PARAMETER_SWITCH_ROLE",INVALID_OPERATION_SWITCH_ROLE:"INVALID_OPERATION_SWITCH_ROLE",SWITCH_ROLE_TIMEOUT:"SWITCH_ROLE_TIMEOUT",SWITCH_ROLE_FAILED:"SWITCH_ROLE_FAILED",CLIENT_BANNED:"CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"INVALID_OPERATION_START_PUBLISH_CDN",INVALID_OPERATION_STOP_PUBLISH_CDN:"INVALID_OPERATION_STOP_PUBLISH_CDN",INVALID_STREAM_ID:"INVALID_STREAM_ID",START_PUBLISH_CDN_FAILED:"START_PUBLISH_CDN_FAILED",STOP_PUBLISH_CDN_FAILED:"STOP_PUBLISH_CDN_FAILED",START_MIX_TRANSCODE:"START_MIX_TRANSCODE",STOP_MIX_TRANSCODE:"STOP_MIX_TRANSCODE",INVALID_AUDIO_VOLUME:"INVALID_AUDIO_VOLUME",ENABLE_SMALL_STREAM_PUBLISHED:"ENABLE_SMALL_STREAM_PUBLISHED",DISABLE_SMALL_STREAM_PUBLISHED:"DISABLE_SMALL_STREAM_PUBLISHED",NOT_SUPPORTED_SMALL_STREAM:"NOT_SUPPORTED_SMALL_STREAM",INVALID_SMALL_STREAM_PROFILE:"INVALID_SMALL_STREAM_PROFILE",INVALID_PARAMETER_REMOTE_STREAM:"INVALID_PARAMETER_REMOTE_STREAM",INVALID_OPERATION_CHANGE_SMALL:"INVALID_OPERATION_CHANGE_SMALL",REMOTE_NOT_PUBLISH_SMALL_STREAM:"REMOTE_NOT_PUBLISH_SMALL_STREAM",INVALID_SWITCH_DEVICE:"INVALID_SWITCH_DEVICE",INVALID_SWITCH_DEVICE_PUBLISHING:"INVALID_SWITCH_DEVICE_PUBLISHING",INVALID_REPLACE_TRACK:"INVALID_REPLACE_TRACK",INVALID_INITIALIZE_LOCAL_STREAM:"INVALID_INITIALIZE_LOCAL_STREAM",INVALID_ADD_TRACK_REPETITIVE:"INVALID_ADD_TRACK_REPETITIVE",INVALID_ADD_TRACK_REMOVING:"INVALID_ADD_TRACK_REMOVING",INVALID_ADD_TRACK_PUBLISHING:"INVALID_ADD_TRACK_PUBLISHING",INVALID_STREAM_INITIALIZED:"INVALID_STREAM_INITIALIZED",INVALID_ADD_TRACK_NUMBER:"INVALID_ADD_TRACK_NUMBER",INVALID_REMOVE_AUDIO_TRACK:"INVALID_REMOVE_AUDIO_TRACK",INVALID_REMOVE_AUDIO_ADDING:"INVALID_REMOVE_AUDIO_ADDING",INVALID_REMOVE_AUDIO_ON:"INVALID_REMOVE_AUDIO_ON",INVALID_REMOVE_TRACK_PUBLISHING:"INVALID_REMOVE_TRACK_PUBLISHING",INVALID_REMOVE_TRACK_NOT_TRACK:"INVALID_REMOVE_TRACK_NOT_TRACK",INVALID_REMOVE_TRACK_NUMBER:"INVALID_REMOVE_TRACK_NUMBER",INVALID_REPLACE_TRACK_NO_TRACK:"INVALID_REPLACE_TRACK_NO_TRACK",REPEAT_JOIN:"REPEAT_JOIN",CLIENT_DESTROYED:"CLIENT_DESTROYED",NOT_BUG_PACKAGE:"NOT_BUG_PACKAGE",START_MIX_TRANSCODE_FAILED:"START_MIX_TRANSCODE_FAILED",STOP_MIX_TRANSCODE_FAILED:"STOP_MIX_TRANSCODE_FAILED",MIX_TRANSCODE_NOT_STARTED:"MIX_TRANSCODE_NOT_STARTED",CANNOT_LESS_THAN_ZERO:"CANNOT_LESS_THAN_ZERO",MIX_PARAMS_VIDEO_FRAMERATE:"MIX_PARAMS_VIDEO_FRAMERATE",MIX_PARAMS_VIDEO_GOP:"MIX_PARAMS_VIDEO_GOP",MIX_PARAMS_AUDIO_BITRATE:"MIX_PARAMS_AUDIO_BITRATE",MIX_PARAMS_USER_Z_ORDER:"MIX_PARAMS_USER_Z_ORDER",MIX_PARAMS_NOT_SELF:"MIX_PARAMS_NOT_SELF",MIX_PARAMS_USER_STREAM:"MIX_PARAMS_USER_STREAM",INVALID_PLAY:"INVALID_PLAY",INVALID_ELEMENT_ID:"INVALID_ELEMENT_ID",INVALID_ELEMENT_ID_TYPE:"INVALID_ELEMENT_ID_TYPE",PLAY_FAILED:"PLAY_FAILED",INVALID_USERID:"INVALID_USERID",INVALID_CREATE_STREAM_SOURCE:"INVALID_CREATE_STREAM_SOURCE",INVALID_CREATE_STREAM_SCREEN:"INVALID_CREATE_STREAM_SCREEN",INVALID_CREATE_STREAM_AUDIO:"INVALID_CREATE_STREAM_AUDIO",INVALID_CREATE_STREAM_SCREEN_AUDIO:"INVALID_CREATE_STREAM_SCREEN_AUDIO",NOT_SUPPORTED_HTTP:"NOT_SUPPORTED_HTTP",NOT_SUPPORTED_WEBRTC:"NOT_SUPPORTED_WEBRTC",NOT_SUPPORTED_PROFILE:"NOT_SUPPORTED_PROFILE",NOT_SUPPORTED_MEDIA:"NOT_SUPPORTED_MEDIA",NOT_SUPPORTED_H264ENCODE:"NOT_SUPPORTED_H264ENCODE",NOT_SUPPORTED_H264DECODE:"NOT_SUPPORTED_H264DECODE",NOT_SUPPORTED_TRACK:"NOT_SUPPORTED_TRACK",NOT_SUPPORTED_SWITCH_DEVICE:"NOT_SUPPORTED_SWITCH_DEVICE",NOT_SUPPORTED_CAPTURE:"NOT_SUPPORTED_CAPTURE",NOT_SUPPORTED_AUX:"NOT_SUPPORTED_AUX",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",SIGNAL_RESPONSE_FAILED:"SIGNAL_RESPONSE_FAILED",CATCH_HANDLER_ERROR:"CATCH_HANDLER_ERROR",API_NOT_EXIST:"API_NOT_EXIST",CONNECTION_CLOSED:"CONNECTION_CLOSED",SUBSCRIBE_ALL_FALSE:"SUBSCRIBE_ALL_FALSE",SEI_NOT_SUPPORT:"SEI_NOT_SUPPORT",SEI_DISABLED:"SEI_DISABLED",SEI_EMPTY:"SEI_EMPTY",SEI_OVERSIZE:"SEI_OVERSIZE",SEI_BEFORE_PUBLISH:"SEI_BEFORE_PUBLISH",SEI_NOT_VIDEO:"SEI_NOT_VIDEO",CALL_FREQUENCY_LIMIT:"CALL_FREQUENCY_LIMIT",CONNECTION_ABORTED:"CONNECTION_ABORTED",API_CALL_ABORTED:"API_CALL_ABORTED",DUPLICATE_AUX:"DUPLICATE_AUX"},ue={AVOID_REPEATED_CALL(r){return`previous ${r.name}() is ongoing, please avoid repeated calls.`},INVALID_PARAMETER_REQUIRED({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' is a required param when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_TYPE({key:r,rule:t,fnName:e,value:i}){let o=`${r||t.name}`,s="";return Array.isArray(t.type)?s=t.type.join("|"):s=t.type,`'${o}' must be type of ${s} when calling ${e}(), received type: ${ee(i)}.`},INVALID_PARAMETER_EMPTY({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' cannot be '${i}' when calling ${e}().`},INVALID_PARAMETER_INSTANCE({key:r,rule:t,fnName:e,value:i}){let o=`${r||t.name}`,s=`${t.instanceOf.name||t.instanceOf}`;return`'${o}' must be instanceof ${s} when calling ${e}(), received type: ${ee(i)}.`},INVALID_PARAMETER_RANGE({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' must be one of ${t.values.join("|")} when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_MIN({key:r,rule:t,fnName:e,value:i}){return`the min value of ${r||t.name} is ${t.min}, received: ${i}.`},INVALID_PARAMETER_MAX({key:r,rule:t,fnName:e,value:i}){return`the max value of ${r||t.name} is ${t.max}, received: ${i}.`},API_CALL_TIMEOUT(r){return`${r.commandDesc||r.command} timeout observed.`},SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED(r){return`SignalChannel setup failure: (errorCode: ${r.errorCode}, errorMsg: ${r.errorMsg} }).`},ERROR_MESSAGE(r){let t=`${r.type} failed`;return r.message&&(t=`${t}: ${r.message}.`),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED(r){return`exchange sdp failed ${r.errMsg}.`},UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING(r){return`'${r}' must be validate string when useStringRoomId is true.`},INVALID_ROOMID_INTEGER(r){return`'${r}' must be an integer between [1, 4294967294] when useStringRoomId is false.`},INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED({error:r,code:t}){return`Failed to join room - ${r} code: ${t}`},REJOIN_ROOM_FAILED(r){return`reJoin room: ${r.roomId} failed, please check your network.`},INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:`no permission to publish() under live/${"audience"}, please call switchRole("${"anchor"}") firstly before publish().`,INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING(r){return`duplicate ${r} stream publishing, please unpublish your prev ${r} stream and then re-publish.`},INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED({message:r,userId:t,streamType:e}){return`failed to subscribe ${t} ${e} stream, reason: ${r}.`},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:`role could only be set to a value as ${"anchor"} or ${"audience"}.`,INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED(r){return`switchRole failed, errCode: ${r.code} errMsg: ${r.message}.`},CLIENT_BANNED(r){return`client was banned because of ${r.message}.`},INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() after join room and publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED(r){return`startPublishCDNStream failed, errMsg: ${r.message}.`},STOP_PUBLISH_CDN_FAILED(r){return`stopPublishCDNStream failed, errMsg: ${r.message}.`},INVALID_STREAM_ID(r){return`'${r}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_TRACK:"localStream has not this track.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK(r){return`cannot replace ${r.kind} track because stream has not ${r.kind} track`},NOT_BUG_PACKAGE:"You need to buy packages, refer to tencent console.",START_MIX_TRANSCODE_FAILED(r){return`startMixTranscode failed, errMsg: ${r.message}.`},STOP_MIX_TRANSCODE_FAILED(r){return`stopMixTranscode failed, errMsg: ${r.message}.`},MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' cannot be less than 0 when calling ${e}().`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER(r){return`'${r}' is required and must be between 1 and 15.`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:({key:r,fnName:t})=>`'${r}' is not found in the document object when calling ${t}().`,INVALID_ELEMENT_ID_TYPE:({key:r,fnName:t,type:e})=>`the element corresponding to '${r}' must be instanceof HTMLElement when calling ${t}(), received: ${e}.`,PLAY_FAILED:r=>`${r.media} play failed\uFF0Cbrowser exception: ${r.error.toString()}`,INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK(r){return`${r}Track is not supported on your browser.`},NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone and the configuration on TRTC.createStream.",CAMERA_NOT_FOUND:"no camera detected, please check your camera and the configuration on TRTC.createStream.",SIGNAL_RESPONSE_FAILED(r){return`${r.signalResponse} failed, response code is ${r.code} , errMsg: ${r.message}.`},CATCH_HANDLER_ERROR({name:r,event:t}){return`an error was caught on ${r}.on('${t}', handler), please check your code on 'handler'.`},API_NOT_EXIST({name:r}){return`experimental api ${r} does not exist.`},REPEAT_JOIN:r=>`[${r}] is calling client.join api or has already joined room, please avoid repeated join.`,CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED({funName:r}){return`failed to call ${r}() because client was destroyed.`},SEI_NOT_SUPPORT:r=>`not support to sendSEIMessage${r===!1?" without using h264 codec":""}`,SEI_DISABLED:"SEI is disabled, to enable SEI: TRTC.createClient({ enableSEI: true })",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:r=>`buffer size(${r}) is over 1000 Bytes`,SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:({isSize:r,name:t,timesInSecond:e,maxSizeInSecond:i})=>`api ${t} call ${r?"size":"times"} is over ${r?`${i} bytes`:e} in a second.`,CONNECTION_ABORTED(r){return`connection aborted due to: ${r}`},API_CALL_ABORTED(r){let t;return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t=`Subscribe ${r.userId} ${r.streamType} stream aborted, reason: remote user ${r.userId} unpublished stream.`:t=`API aborted, reason: ${r.message}`,t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser.",INVALID_PARAMETER_STREAMTYPE:r=>`'streamType' is required when 'userId' is not '*', calling ${r}()`};function Za(r){return Reflect.apply(Object.prototype.toString,r,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var zl={AVOID_REPEATED_CALL(r){return`\u524D\u4E00\u4E2A ${r.name}() \u8C03\u7528\u6B63\u5728\u8FDB\u884C\u4E2D, \u8BF7\u907F\u514D\u91CD\u590D\u8C03\u7528\u3002`},INVALID_PARAMETER_REQUIRED({key:r,rule:t,fnName:e,value:i}){return`\u8C03\u7528 ${e}() \u65B9\u6CD5\u7684\u65F6\u5019 '${r||t.name}' \u662F\u5FC5\u987B\u7684\u53C2\u6570, \u6536\u5230\u7684\u503C\u4E3A: ${i}\u3002`},INVALID_PARAMETER_TYPE({key:r,rule:t,fnName:e,value:i}){let o=`${r||t.name}`,s="";return Array.isArray(t.type)?s=t.type.join("|"):s=t.type,`\u8C03\u7528 ${e}() \u65B9\u6CD5\u7684\u65F6\u5019 '${o}' \u5FC5\u987B\u662F ${s} \u7C7B\u578B, \u6536\u5230\u7684\u7C7B\u578B\u662F: ${Za(i)}\u3002`},INVALID_PARAMETER_EMPTY({key:r,rule:t,fnName:e,value:i}){return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${r||t.name}' \u4E0D\u80FD\u662F '${i}'\u3002`},INVALID_PARAMETER_INSTANCE({key:r,rule:t,fnName:e,value:i}){let o=`${r||t.name}`,s=`${t.instanceOf.name||t.instanceOf}`;return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${o}' \u539F\u578B\u5FC5\u987B\u662F ${s} , \u6536\u5230\u7684\u662F: ${Za(i)}\u3002`},INVALID_PARAMETER_RANGE({key:r,rule:t,fnName:e,value:i}){return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${r||t.name}' \u5FC5\u987B\u662F ${t.values.join("|")} \u7684\u5176\u4E2D\u4E00\u79CD, \u6536\u5230\u7684\u662F: ${i}\u3002`},API_CALL_TIMEOUT(r){return`${r.commandDesc||r.command} \u8D85\u65F6\u3002`},SIGNAL_CHANNEL_RECONNECTION_FAILED:"\u4FE1\u4EE4\u901A\u9053\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u4F60\u7684\u7F51\u7EDC\u3002",SIGNAL_CHANNEL_SETUP_FAILED(r){return`\u4FE1\u4EE4\u901A\u9053\u5EFA\u7ACB\u5931\u8D25: (\u9519\u8BEF\u7801: ${r.errorCode}, \u9519\u8BEF\u4FE1\u606F: ${r.errorMsg} })\u3002`},ERROR_MESSAGE(r){let t=`${r.type} \u5931\u8D25\u3002`;return r.message&&(t=`${t}: ${r.message}\u3002`),t},SUBSCRIPTION_TIMEOUT:"\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0D\u54CD\u5E94\u8BA2\u9605\u884C\u4E3A\u3002",EXCHANGE_SDP_TIMEOUT:"\u4EA4\u6362 sdp \u8D85\u65F6\uFF0C\u8BF7\u5237\u65B0\u7F51\u7EDC\u91CD\u8BD5\u3002",DOWNLINK_RECONNECTION_FAILED:"\u4E0B\u884C\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u7F51\u7EDC\u5E76\u91CD\u65B0\u52A0\u5165\u623F\u95F4\u3002",EXCHANGE_SDP_FAILED(r){return`\u4EA4\u6362 SDP \u5931\u8D25\uFF0C\u539F\u56E0 ${r.errMsg}\u3002`},REPLACE_TRACK_INVALID:"LocalStream \u53D1\u5E03\u4E4B\u540E\u624D\u53EF\u4EE5\u8C03\u7528 replaceTrack\u3002",UPDATE_OFFER_TIMEOUT:"\u66F4\u65B0 offer \u8D85\u65F6\uFF0C\u8BF7\u5237\u65B0\u7F51\u7EDC\u91CD\u8BD5\u3002",UPLINK_RECONNECTION_FAILED:"\u4E0A\u884C\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u7F51\u7EDC\u5E76\u91CD\u65B0\u63A8\u6D41\u3002",INVALID_RECORDID:"recordId \u5FC5\u987B\u662F\u6570\u5B57\u3002",INVALID_PURE_AUDIO:"pureAudioPushMode \u5FC5\u987B\u662F\u6570\u5B571\u62162\u3002",INVALID_STREAMID:"streamId \u5FC5\u987B\u662F 64 \u5B57\u8282\u4EE5\u5185\u7684\u5B57\u7B26\u4E32\uFF0C\u5E76\u4E14\u4E0D\u80FD\u4E3A\u7A7A\u3002",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId \u5FC5\u987B\u662F\u5305\u542B (a-zA-Z)\u3001(0-9)\u3001\u4E0B\u5212\u7EBF\u548C\u8FDE\u5B57\u7B26\u7684\u5B57\u7B26\u4E32\u5B57\u9762\u91CF\uFF0C64 \u4E2A\u5B57\u8282\u4EE5\u5185\uFF0C\u4E14\u4E0D\u4E3A\u7A7A\u3002",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs \u5FC5\u987B\u662F 256 \u5B57\u8282\u4EE5\u5185\u7684\u5B57\u7B26\u4E32\u6587\u5B57\uFF0C\u5E76\u4E14\u4E0D\u80FD\u4E3A\u7A7A\u3002",INVALID_PROXY:"\u4EE3\u7406\u670D\u52A1\u5668 url \u5FC5\u987B\u4EE5\u201Cwss://\u201D\u5F00\u5934\u3002",INVALID_JOIN:"join() \u65B9\u6CD5\u4E0D\u80FD\u88AB\u91CD\u590D\u8C03\u7528\u3002",INVALID_ROOMID_STRING(r){return`\u5F53 useStringRoomId \u4E3A true \u65F6\uFF0C'${r}' \u5FC5\u987B\u662F\u5408\u6CD5\u5B57\u7B26\u4E32\u3002`},INVALID_ROOMID_INTEGER(r){return`\u5F53 useStringRoomId \u4E3A false \u65F6\uFF0C'${r}' \u5FC5\u987B\u662F\u5408\u6CD5\u6574\u6570\u5728\u533A\u95F4[1, 4294967294]\u3002`},INVALID_SIGNAL_CHANNEL:"SignalChannel \u8FD8\u672A\u521D\u59CB\u5316\u597D\u3002",JOIN_ROOM_TIMEOUT:"\u8FDB\u623F\u8D85\u65F6\u3002",JOIN_ROOM_FAILED(r){return`\u8FDB\u623F\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A${r.error}\u3002`},REJOIN_ROOM_FAILED(r){return`\u91CD\u8FDB\u623F: ${r.roomId} \u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u72B6\u51B5\u3002`},INVALID_LEAVE:"\u8BF7\u5728\u8C03\u7528 destroy() \u65B9\u6CD5\u4E4B\u524D\u8C03\u7528 leave()\u3002",INVALID_PUBLISH:"\u8BF7\u5728\u8C03\u7528 publish() \u65B9\u6CD5\u4E4B\u524D\u8C03\u7528 join()\u3002",INVALID_UNPUBLISH:"\u8FD8\u6CA1\u6709\u88AB publish\u3002",INVALID_AUDIENCE:"\u5728\u89C2\u4F17\u6A21\u5F0F\u4E0B\u4E0D\u5141\u8BB8\u8C03\u7528 publish()\uFF0C\u8BF7\u5148\u5207\u6362\u6210\u4E3B\u64AD\u6A21\u5F0F\u3002",INVALID_INITIALIZE:"\u65E0\u6CD5\u53D1\u5E03 stream\uFF0C\u539F\u56E0\uFF1AlocalStream \u672A\u521D\u59CB\u5316\u3001\u6B63\u5728\u5207\u6362\u8BBE\u5907\u3001\u5DF2\u7ECF\u8C03\u7528 localStream.close() \u5173\u95ED\u91C7\u96C6",INVALID_DUPLICATE_PUBLISHING:"\u91CD\u590D\u53D1\u5E03\uFF0C\u8BF7\u5148 unpublish \u4E4B\u540E\uFF0C\u518D\u91CD\u65B0 publish\u3002",INVALID_SUBSCRIBE_UNDEFINED:"stream \u53C2\u6570\u662F undefined \u6216\u8005 null\u3002",INVALID_SUBSCRIBE_LOCAL:"stream \u53C2\u6570\u4E0D\u80FD\u4E3A\u672C\u5730\u6D41\u3002",INVALID_REMOTE_STREAM:"remoteStream \u4E0D\u5B58\u5728\uFF0C\u5DF2\u88AB\u8FDC\u7AEF client \u53D6\u6D88\u53D1\u5E03\u3002",SUBSCRIBE_FAILED(r){let t="\u8BA2\u9605\u6D41\u5931\u8D25\uFF0C\u539F\u56E0: ";return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t+="\u8FDC\u7AEF\u7528\u6237\u5DF2\u53D6\u6D88\u63A8\u6D41\uFF0C\u65E0\u6CD5\u8BA2\u9605\u8BE5\u8FDC\u7AEF\u6D41\u3002":t+=`${r.message}\u3002`,t},INVALID_ROLE:"\u53EA\u6709\u76F4\u64AD\u6A21\u5F0F\u624D\u53EF\u4EE5\u8FDB\u884C\u89D2\u8272\u5207\u6362\u3002",INVALID_PARAMETER_SWITCH_ROLE:"role \u53EA\u80FD\u8BBE\u7F6E\u4E3A anchor \u6216\u8005 audience\u3002",INVALID_OPERATION_SWITCH_ROLE:"\u8BF7\u5728\u4F7F\u7528 switchRole() \u65B9\u6CD5\u524D\u5148\u8FDB\u623F\u3002",SWITCH_ROLE_TIMEOUT:"\u5207\u6362\u89D2\u8272\u8D85\u65F6\u3002",SWITCH_ROLE_FAILED(r){return`\u5207\u6362\u89D2\u8272\u5931\u8D25\u3002\u9519\u8BEF\u7801: ${r.code} \u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},CLIENT_BANNED(r){return`\u60A8\u88AB\u52A8\u9000\u623F\u4E86\uFF0C\u539F\u56E0\u4E3A\uFF1A${r.reason}\u3002`},INVALID_OPERATION_START_PUBLISH_CDN:"\u8BF7\u5728\u8FDB\u623F\u524D\u6216\u8005\u8FDB\u623F\u5E76\u6210\u529F\u53D1\u5E03\u672C\u5730\u6D41\u540E\u8C03\u7528 startPublishCDNStream() \u65B9\u6CD5\u3002",INVALID_OPERATION_STOP_PUBLISH_CDN:"\u5728\u8C03\u7528 stopPublishCDNStream() \u65B9\u6CD5\u524D\u9700\u8981\u5148 startPublishCDNStream()\u3002",INVALID_STREAM_ID(r){return`'${r}' \u53EA\u80FD\u7531\u5927\u5C0F\u5199\u5B57\u6BCD\uFF08a-zA-z\uFF09, \u6570\u5B57\uFF080-9\uFF09, \u8FDE\u5B57\u7B26\u548C\u4E0B\u5212\u7EBF\u7EC4\u6210`},START_PUBLISH_CDN_FAILED(r){return`startPublishCDNStream \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},STOP_PUBLISH_CDN_FAILED(r){return`stopPublishCDNStream \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},START_MIX_TRANSCODE:"\u8C03\u7528 startMixTranscode() \u65B9\u6CD5\u524D\u9700\u8981\u5148\u8C03\u7528 join()\u3002",STOP_MIX_TRANSCODE:"\u8C03\u7528 stopMixTranscode \u4E4B\u524D\u9700\u8981\u8C03\u7528 startMixTranscode\u3002",INVALID_AUDIO_VOLUME:"interval \u5FC5\u987B\u662F\u6570\u5B57\u3002",ENABLE_SMALL_STREAM_PUBLISHED:"\u53D1\u5E03 localStream \u4E4B\u540E\u4E0D\u5141\u8BB8\u5F00\u542F\u5C0F\u6D41\u3002",DISABLE_SMALL_STREAM_PUBLISHED:"\u53D1\u5E03 localStream \u4E4B\u540E\u4E0D\u5141\u8BB8\u5173\u95ED\u5C0F\u6D41\u3002",NOT_SUPPORTED_SMALL_STREAM:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u5F00\u542F\u5C0F\u6D41\u3002",INVALID_SMALL_STREAM_PROFILE:"\u5C0F\u6D41\u53C2\u6570\u4E0D\u5408\u6CD5\u3002",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream \u4E0D\u5408\u6CD5\u3002",REMOTE_NOT_PUBLISH_SMALL_STREAM:"\u8FDC\u7AEF\u7528\u6237\u6CA1\u6709\u53D1\u5E03\u5C0F\u6D41\u3002",INVALID_SWITCH_DEVICE:"\u5F53\u524D\u7684\u6D41\u4E0D\u53EF\u4EE5\u8C03\u7528 switchDevice\u3002",INVALID_SWITCH_DEVICE_PUBLISHING:"\u53D1\u5E03\u672C\u5730\u6D41\u65F6\u4E0D\u80FD\u5207\u6362\u8BBE\u5907\u3002",INVALID_REPLACE_TRACK:"client.publish \u63A5\u53E3\u5C1A\u672A\u8C03\u7528\u5B8C\u6210\uFF0C\u8BF7\u7B49\u5176\u8C03\u7528\u5B8C\u6210\u540E\u518D\u8C03\u7528 replaceTrack \u63A5\u53E3\u3002",INVALID_INITIALIZE_LOCAL_STREAM:"\u672C\u5730\u6D41\u8FD8\u6CA1\u6709\u521D\u59CB\u5316\u3002",INVALID_ADD_TRACK_REPETITIVE:"\u524D\u4E00\u4E2A addTrack \u6B63\u5728\u8FDB\u884C\uFF0C\u8BF7\u907F\u514D\u91CD\u590D\u8C03\u7528\u3002",INVALID_ADD_TRACK_REMOVING:"track \u5728\u79FB\u52A8\u7684\u65F6\u5019\u4E0D\u80FD\u6DFB\u52A0\u65B0\u7684 track\u3002",INVALID_ADD_TRACK_PUBLISHING:"\u5728\u53D1\u5E03\u672C\u5730\u6D41\u7684\u65F6\u5019\u4E0D\u80FD\u6DFB\u52A0\u65B0\u7684 track\u3002",INVALID_STREAM_INITIALIZED:"\u60A8\u7684\u672C\u5730\u6D41\u8FD8\u6CA1\u6709\u521D\u59CB\u5316\u3002",INVALID_ADD_TRACK_NUMBER:"\u4E00\u6761\u6D41\u6700\u591A\u6709\u4E00\u4E2A\u97F3\u9891\u8F68\u9053\u548C\u4E00\u4E2A\u89C6\u9891\u8F68\u9053\u3002",INVALID_REMOVE_AUDIO_TRACK:"remove audio track \u662F\u4E0D\u5141\u8BB8\u7684\u3002",INVALID_REMOVE_AUDIO_ADDING:"\u5F53\u4E00\u4E2A track \u88AB addTrack \u7684\u65F6\u5019\u4E0D\u80FD\u5BF9\u6D41\u8FDB\u884C removeTrack \u64CD\u4F5C\u3002",INVALID_REMOVE_AUDIO_ON:"\u524D\u4E00\u6B21\u8C03\u7528\u7684 removeTrack \u6B63\u5728\u8FDB\u884C\u4E2D\uFF0C\u8BF7\u907F\u514D\u91CD\u590D\u64CD\u4F5C\u3002",INVALID_REMOVE_TRACK_PUBLISHING:"\u53D1\u5E03\u6D41\u7684\u8FC7\u7A0B\u4E2D\u4E0D\u80FD\u8FDB\u884C removeTrack \u64CD\u4F5C\u3002",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"\u88AB remove \u7684 track \u6CA1\u6709\u88AB\u53D1\u5E03\u3002",INVALID_REMOVE_TRACK_NUMBER:"\u4E0D\u652F\u6301\u79FB\u9664\u552F\u4E00\u7684\u89C6\u9891\u8F68\u9053\uFF0C\u8BF7\u4F7F\u7528 replaceTrack \u6216\u8005 muteVideo \u65B9\u6CD5\u3002",INVALID_REPLACE_TRACK_NO_TRACK(r){return`LocalStream \u6CA1\u6709 ${r.kind} track\uFF0C\u65E0\u6CD5\u8FDB\u884C\u66FF\u6362\u3002`},START_MIX_TRANSCODE_FAILED(r){return`startMixTranscode \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},STOP_MIX_TRANSCODE_FAILED(r){return`stopMixTranscode \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F:  ${r.message}\u3002`},MIX_TRANSCODE_NOT_STARTED:"\u8FD8\u6CA1\u6709\u5F00\u59CB mixTranscode\u3002",CANNOT_LESS_THAN_ZERO({key:r,rule:t,fnName:e}){return`'\u5F53\u8C03\u7528 ${e}() \u51FD\u6570\u65F6\uFF0C\u8981\u6C42\u53C2\u6570 ${r||t.name}' \u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E0`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' \u5E94\u8BE5\u662F (0, 30] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' \u5E94\u8BE5\u662F [1, 8] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' \u5E94\u8BE5\u662F [32, 192] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_USER_Z_ORDER(r){return`'${r}' \u662F\u5FC5\u4F20\u7684\uFF0C\u4E14\u8981\u6C42\u4E3A [1 ,15] \u4E4B\u95F4\u7684\u6574\u6570\u3002`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' \u5FC5\u987B\u5305\u542B\u53D1\u8D77\u6DF7\u6D41\u7684\u7528\u6237\u4FE1\u606F\u3002",MIX_PARAMS_USER_STREAM:"\u8F93\u51FA\u6D41\u7684 'config.videoWidth' \u548C 'config.videoHeight' \u5E94\u8BE5\u5BB9\u7EB3\u6240\u6709\u6DF7\u5165\u6D41\u3002",INVALID_PLAY:"play() \u88AB\u91CD\u590D\u8C03\u7528\uFF0C\u8BF7\u5148 stop()\uFF0C\u7136\u540E\u518D\u91CD\u65B0\u8C03\u7528 play\u3002",INVALID_ELEMENT_ID:({key:r,fnName:t})=>`\u5728\u8C03\u7528 ${t}() \u65F6\uFF0Cdocument \u5BF9\u8C61\u4E2D\u627E\u4E0D\u5230 ${r} \u5BF9\u5E94\u7684\u5143\u7D20\uFF0C\u8BF7\u68C0\u67E5\u3002`,INVALID_ELEMENT_ID_TYPE:({key:r,type:t,fnName:e})=>`\u5728\u8C03\u7528 ${e}() \u65B9\u6CD5\u65F6\uFF0C${r} \u53C2\u6570\u5BF9\u5E94\u7684 HTML \u6807\u7B7E\u5143\u7D20\u5FC5\u987B\u662F HTMLElement \u5B9E\u4F8B\uFF0C\u60A8\u4F20\u5165\u7684\u662F\uFF1A${t}\u3002`,PLAY_FAILED:r=>`${r.media} \u64AD\u653E\u88AB\u4E2D\u65AD\uFF0C\u6D4F\u89C8\u5668\u5F02\u5E38\u539F\u56E0\uFF1A${r.error.toString()}`,INVALID_USERID:"userId \u4E0D\u80FD\u4E3A\u7A7A\u683C\u3002",INVALID_CREATE_STREAM_SOURCE:"createStream() \u751F\u6210 LocalStream \u53EF\u4EE5\u4F7F\u7528 audio & video \u6216 audioSource & videoSource \u521B\u5EFA\uFF0C\u4F46\u4E0D\u80FD\u6DF7\u5408\u4F7F\u7528\u3002",INVALID_CREATE_STREAM_SCREEN:"screen \u548C video \u4E0D\u80FD\u540C\u65F6\u4E3A true\u3002",INVALID_CREATE_STREAM_AUDIO:"audio \u548C screenAudio \u4E0D\u80FD\u540C\u65F6\u4E3A true\u3002",INVALID_CREATE_STREAM_SCREEN_AUDIO:"screen \u4E3A true \u65F6\uFF0C\u4E0D\u80FD\u8BBE\u7F6E screenAudio\u3002",NOT_SUPPORTED_HTTP:"\u7531\u4E8E\u6D4F\u89C8\u5668\u5B89\u5168\u7B56\u7565\u9650\u5236\uFF0C\u4E0D\u652F\u6301\u5728 http \u534F\u8BAE\u4E0B\u4F7F\u7528\u91C7\u96C6\u3001\u63A8\u6D41\u7B49\u80FD\u529B\uFF0C\u8BF7\u4F7F\u7528 https \u534F\u8BAE\u3002",NOT_SUPPORTED_WEBRTC:"\u5F53\u524D\u6D4F\u89C8\u5668\u6216\u73AF\u5883\u4E0D\u5B8C\u5168\u652F\u6301 WebRTC \u80FD\u529B\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_PROFILE:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 setVideoProfile \u65B9\u6CD5\u3002\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_MEDIA:"\u5F53\u524D\u6D4F\u89C8\u5668\u6216\u73AF\u5883\u4E0D\u652F\u6301 navigator.mediaDevices\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_H264ENCODE:"\u5F53\u524D\u7684\u8BBE\u5907\u6216\u73AF\u5883\u4E0D\u652F\u6301 H264 \u7F16\u7801\uFF0C\u4E0D\u652F\u6301 H264 \u683C\u5F0F\u8FDB\u884C\u63A8\u6D41\u3002",NOT_SUPPORTED_H264DECODE:"\u5F53\u524D\u7684\u8BBE\u5907\u6216\u73AF\u5883\u4E0D\u652F\u6301 H264 \u89E3\u7801\uFF0C\u4E0D\u652F\u6301 H264 \u683C\u5F0F\u8FDB\u884C\u62C9\u6D41\u3002",NOT_SUPPORTED_TRACK(r){return`\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 ${r}Track \u65B9\u6CD5\u3002`},NOT_SUPPORTED_REPLACE_TRACK:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 replaceTrack \u65B9\u6CD5\uFF0C\u8BF7\u4F7F\u7528 switchDevice \u6216\u8005 addTrack\u3002",NOT_SUPPORTED_CAPTURE:"\u60A8\u5F53\u524D\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u5C4F\u5E55\u5206\u4EAB\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_AUX:"\u60A8\u5F53\u524D\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u63A8\u8F85\u6D41\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\uFF08Chrome 69+, Safari 11+, Firefox 59+\uFF09\u3002",MICROPHONE_NOT_FOUND:"\u672A\u68C0\u6D4B\u5230\u9EA6\u514B\u98CE\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u9EA6\u514B\u98CE\u548C TRTC.createStream \u4E0A\u7684\u914D\u7F6E\u3002",CAMERA_NOT_FOUND:"\u672A\u68C0\u6D4B\u5230\u6444\u50CF\u5934\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u6444\u50CF\u5934\u548C TRTC.createStream \u4E0A\u7684\u914D\u7F6E\u3002",CATCH_HANDLER_ERROR:({name:r,event:t})=>` \u5728 ${r}.on('${t}', handler) \u4E8B\u4EF6\u4E2D\u6355\u83B7\u5230\u4E1A\u52A1\u4FA7\u9519\u8BEF\uFF0C\u8BF7\u6839\u636E\u4E0B\u8FF0\u9519\u8BEF\u4FE1\u606F\uFF0C\u68C0\u67E5\u60A8\u5728 handler \u4E2D\u7684\u4E1A\u52A1\u4EE3\u7801\u3002`,REPEAT_JOIN:r=>`\u7528\u6237 [${r}] \u6B63\u5728\u8C03\u7528\u8FDB\u623F\u63A5\u53E3\u6216\u8005\u5DF2\u7ECF\u5728\u623F\u95F4\u5185\uFF0C\u8BF7\u52FF\u91CD\u590D\u521B\u5EFA\u76F8\u540C userId \u7684 client \u8FDB\u5165\u540C\u4E00\u4E2A\u623F\u95F4\u3002`,CLIENT_DESTROYED:({funName:r})=>`client \u5DF2\u7ECF\u88AB\u9500\u6BC1\uFF0C\u8C03\u7528 ${r}() \u65B9\u6CD5\u5931\u8D25\u3002`,API_CALL_ABORTED(r){let t;return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t=`\u4E2D\u65AD\u8BA2\u9605\u7528\u6237 ${r.userId} \u7684 ${r.streamType} stream, \u539F\u56E0: \u5728\u60A8\u8BA2\u9605\u8FC7\u7A0B\u4E2D\uFF0C\u8FDC\u7AEF\u7528\u6237 ${r.userId} \u53D6\u6D88\u4E86\u63A8\u6D41\uFF0C\u60A8\u53EF\u4EE5\u5728\u4E0B\u6B21\u8FDC\u7AEF\u63A8\u6D41\u65F6\u518D\u8FDB\u884C\u8BA2\u9605\u3002`:t=`\u4E2D\u65AD\u63A5\u53E3\u8C03\u7528, \u539F\u56E0: ${r.message}\u3002`,t},SEI_BEFORE_PUBLISH:"\u5F53\u524D client \u6CA1\u6709\u63A8 localStream(\u4E3B\u6D41\uFF0C\u975E\u5C4F\u5E55\u5206\u4EAB\u6D41)\uFF0C\u65E0\u6CD5\u8C03\u7528 client.sendSEIMessage() \u63A5\u53E3\u3002"},Zl={INVALID_USER_DEFINE_RECORDID:"TRTC.html#createClient",INVALID_PROXY:"Client.html#setProxyServer",INVALID_JOIN:"Client.html#join",INVALID_ROOMID_STRING:"Client.html#join",INVALID_ROOMID_INTEGER:"Client.html#join",INVALID_PUBLISH:"Client.html#publish",INVALID_UNPUBLISH:"Client.html#unpublish",INVALID_AUDIENCE:"Client.html#switchRole",INVALID_INITIALIZE:"Client.html#publish",INVALID_DUPLICATE_PUBLISHING:"Client.html#publish",INVALID_SUBSCRIBE_UNDEFINED:"Client.html#subscribe",INVALID_SUBSCRIBE_LOCAL:"Client.html#subscribe",INVALID_REMOTE_STREAM:"Client.html#subscribe",INVALID_ROLE:"Client.html#switchRole",INVALID_PARAMETER_SWITCH_ROLE:"Client.html#switchRole",INVALID_OPERATION_SWITCH_ROLE:"Client.html#switchRole",CLIENT_BANNED:"module-ClientEvent.html#.CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"Client.html#startPublishCDNStream",INVALID_OPERATION_STOP_PUBLISH_CDN:"Client.html#stopPublishCDNStream",START_MIX_TRANSCODE:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE:"Client.html#stopMixTranscode",INVALID_AUDIO_VOLUME:"Client.html#enableAudioVolumeEvaluation",ENABLE_SMALL_STREAM_PUBLISHED:"Client.html#enableSmallStream",DISABLE_SMALL_STREAM_PUBLISHED:"Client.html#disableSmallStream",NOT_SUPPORTED_SMALL_STREAM:"tutorial-27-advanced-small-stream.html#h2-4",INVALID_SMALL_STREAM_PROFILE:"Client.html#setSmallStreamProfile",REMOTE_NOT_PUBLISH_SMALL_STREAM:"Client.html#setRemoteVideoStreamType",INVALID_SWITCH_DEVICE:"LocalStream.html#switchDevice",INVALID_SWITCH_DEVICE_PUBLISHING:"LocalStream.html#switchDevice",INVALID_REPLACE_TRACK:"LocalStream.html#replaceTrack",INVALID_INITIALIZE_LOCAL_STREAM:"LocalStream.html#replaceTrack",INVALID_ADD_TRACK_REPETITIVE:"LocalStream.html#addTrack",INVALID_ADD_TRACK_REMOVING:"LocalStream.html#addTrack",INVALID_ADD_TRACK_PUBLISHING:"LocalStream.html#addTrack",INVALID_STREAM_INITIALIZED:"LocalStream.html#addTrack",INVALID_ADD_TRACK_NUMBER:"LocalStream.html#addTrack",INVALID_REMOVE_AUDIO_TRACK:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ADDING:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ON:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NUMBER:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHED:"LocalStream.html#removeTrack",START_MIX_TRANSCODE_TIMEOUT:"Client.html#startMixTranscode",START_MIX_TRANSCODE_FAILED:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE_FAILED:"Client.html#stopMixTranscode",MIX_TRANSCODE_NOT_STARTED:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_FRAMERATE:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_GOP:"Client.html#startMixTranscode",MIX_PARAMS_AUDIO_BITRATE:"Client.html#startMixTranscode",MIX_PARAMS_USER_Z_ORDER:"Client.html#startMixTranscode",MIX_PARAMS_NOT_SELF:"Client.html#startMixTranscode",MIX_PARAMS_USER_STREAM:"Client.html#startMixTranscode",INVALID_PLAY:"Stream.html#play",PLAY_FAILED:"Stream.html#play",INVALID_USERID:"TRTC.html#createClient",INVALID_CREATE_STREAM_SOURCE:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN:"TRTC.html#createStream",INVALID_CREATE_STREAM_AUDIO:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN_AUDIO:"TRTC.html#createStream",NOT_SUPPORTED_HTTP:"tutorial-05-info-browser.html#h2-2",NOT_SUPPORTED_WEBRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_TRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_PROFILE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_MEDIA:"tutorial-05-info-browser.html",NOT_SUPPORTED_H264ENCODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_H264DECODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_TRACK:"LocalStream.html#addTrack",NOT_SUPPORTED_REPLACE_TRACK:"LocalStream.html#replaceTrack",NOT_SUPPORTED_CAPTURE:"tutorial-05-info-browser.html",MICROPHONE_NOT_FOUND:"TRTC.html#createStream",CAMERA_NOT_FOUND:"TRTC.html#createStream",SUBSCRIBE_FAILED:"Client.html#subscribe",API_CALL_ABORTED(r){let t;return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t="Client.html#subscribe":t="module-ErrorCode.html#.API_CALL_ABORTED",t}};typeof window!="undefined"&&(window.TRTC_ERROR_INFO=zl,window.TRTC_ERROR_LINK=Zl);var ec=(r,t)=>t?`${Kt}/${r}/${t}`:`${Kt}/${r}/index.html`;var eu=()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};let r=localStorage.getItem(vs);if(r){r=JSON.parse(r);let t=document.createElement("script");t.type="text/javascript",t.text=r.message,document.body.appendChild(t);let e=window.TRTC_ERROR_INFO,i=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:e,TRTC_ERROR_LINK:i}}return{}};function y(r){let{key:t,data:e,link:i,addDocLink:o=!0}=r,s="",n="",a="";K(ue[t])?s=ue[t](e):j(ue[t])&&(s=ue[t]);let{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:l}=eu();i?a=`${i.className}.html#${i.fnName}`:l&&l[t]&&(K(l[t])?a=l[t](e):j(l[t])&&(a=l[t]));let h=s;return Ke()&&(c&&c[t]&&(K(c[t])?n=c[t](e):j(c[t])&&(n=c[t])),n&&(o?h=`${n}
\u8BF7\u67E5\u770B\u6587\u6863: ${ec("zh-cn",a)}

`:h=`${n}

`,h+=s)),o&&(h+=` 
Refer to: ${ec("en",a)}
`),h}var X={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isWebCodecsSupported:!1,isMediaDevicesSupported:!1,isScreenShareSupported:!1,isSmallStreamSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}},tu=new Map([[Y,["Firefox",zr]],[Ti,["Edg",eo]],[Ri,["Chrome",po]],[ke,["Safari",Ni]],[He,["TBS",ro]],[ir,["XWEB",oo]],[Ii&&ft,["WeChat",so]],[rr,["QQ(Win)",no]],[gi,["QQ(Mobile)",pi]],[Si,["QQ(Mobile X5)",pi]],[or,["QQ(Mac)",ao]],[sr,["QQ(iPad)",co]],[nr,["MI",lo]],[ar,["HW",uo]],[cr,["Samsung",ho]],[dr,["OPPO",_o]],[lr,["VIVO",mo]],[fi,["EDGE",Zr]],[er,["SogouMobile",to]],[tr,["Sogou",io]]]);function iu(){let r=tu.get(!0),t=r?r[0]:"unknown",e=r?r[1]:"unknown";return{browserName:t,browserVersion:e}}var Xs=function(){return!(As||fi||Ti&&gs<80||Y&&Ss<56)},rc=function(){return["VideoDecoder","VideoEncoder","AudioEncoder","AudioDecoder","MediaStreamTrackGenerator"].every(t=>t in window)},bo=function(){if(!navigator.mediaDevices)return g.error(ue.NOT_SUPPORTED_MEDIA),!1;let r=["getUserMedia","enumerateDevices"];return r.filter(t=>t in navigator.mediaDevices).length===r.length},tc=!1;function Qs(){return location.protocol==="http:"&&!we&&!tc?(tc=!0,g.warn(y({key:C.NOT_SUPPORTED_HTTP})),!0):!1}var qs=function(){return(window==null?void 0:window.OffscreenCanvas)&&(window==null?void 0:window.MediaStreamTrackProcessor)&&(window==null?void 0:window.MediaStreamTrackGenerator)},oc=function(){return _(this,null,function*(){if(X.detail.isH264EncodeSupported||X.detail.isVp8EncodeSupported)return{isH264EncodeSupported:X.detail.isH264EncodeSupported,isVp8EncodeSupported:X.detail.isVp8EncodeSupported};let r,t=!1,e=!1;try{let i=new RTCPeerConnection,o=document.createElement(u.CANVAS);o.getContext("2d");let s=o.captureStream(0);return i.addTrack(s.getVideoTracks()[0],s),r=yield i.createOffer(),r.sdp.toLowerCase().indexOf("h264")!==-1&&(t=!0),r.sdp.toLowerCase().indexOf("vp8")!==-1&&(e=!0),i.close(),X.detail.isH264EncodeSupported=t,X.detail.isVp8EncodeSupported=e,{isH264EncodeSupported:X.detail.isH264EncodeSupported,isVp8EncodeSupported:X.detail.isVp8EncodeSupported}}catch(i){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}})},Lo=function(){return _(this,null,function*(){if(X.detail.isH264DecodeSupported&&X.detail.isVp8DecodeSupported)return{isH264DecodeSupported:X.detail.isH264DecodeSupported,isVp8DecodeSupported:X.detail.isVp8DecodeSupported};let r,t=!1,e=!1;try{let i=new RTCPeerConnection;return r=yield i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),r.sdp.toLowerCase().indexOf("h264")!==-1&&(t=!0),r.sdp.toLowerCase().indexOf("vp8")!==-1&&(e=!0),i.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:e}}catch(i){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}})},zs=function(){return _(this,null,function*(){if(X.result)return X;let r=Xs(),t=tn(),e=rc(),i=bo(),{isH264EncodeSupported:o,isVp8EncodeSupported:s}=yield oc(),{isH264DecodeSupported:n,isVp8DecodeSupported:a}=yield Lo();return X.result=r&&t&&i&&(o||s)&&(n||a),X.detail.isBrowserSupported=r,X.detail.isWebRTCSupported=t,X.detail.isWebCodecsSupported=e,X.detail.isMediaDevicesSupported=i,X.detail.isScreenShareSupported=Zs(),X.detail.isSmallStreamSupported=vo(),X.detail.isH264EncodeSupported=o,X.detail.isVp8EncodeSupported=s,X.detail.isH264DecodeSupported=n,X.detail.isVp8DecodeSupported=a,X.result||g.error(`${navigator.userAgent} isBrowserSupported: ${r}isWebCodecsSupported: ${e} isMediaSupported: ${i} isH264EncodeSupported: ${o} isVp8EncodeSupported: ${s} isH264DecodeSupported: ${n} isVp8DecodeSupported: ${a} `),X})},ru=function(){return X.result},Zs=function(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)},ou=(r,t,e)=>{location.protocol==="http:"&&!we&&(r[t]=()=>{throw new A({code:T.INVALID_OPERATION,message:ue.NOT_SUPPORTED_HTTP})})},Ot=function(r){return r.type==="candidate-pair"&&r.nominated&&(r.state==="in-progress"||r.state==="succeeded")?!(re(r.selected)&&!r.selected):!1},ic=new Map([[Oe,"Android"],[De,"iOS"],[Tt,"Windows"],[Fe,"MacOS"],[Ai,"Linux"]]),sc=function(){return ic.get(!0)?ic.get(!0):"unknown"};function nc(){let r="";if(screen.width){let t=screen.width?screen.width*window.devicePixelRatio:"",e=screen.height?screen.height*window.devicePixelRatio:"";r+=`${t} * ${e}`}return r}function ac(){return navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function cc(){let r={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let e=0;e<t.length;e++)if(t[e]in window){r.isSupported=!0;break}return r.isSupported}function dc(){return"captureStream"in HTMLCanvasElement.prototype}function vo(){return Ii||De||Ci&&Ci<63?!1:!!(Xs()&&dc())}var su=function(){if(I(window.RTCRtpTransceiver)||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let r=null,t=!1;try{r=new RTCPeerConnection({sdpSemantics:At}),r.addTransceiver(u.AUDIO),t=!0}catch(e){}return r==null||r.close(),t};function Zt(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function Ui(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function be(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function yt(){return"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype}var Po=yt();function nu(){return"RTCRtpTransceiver"in window&&"stop"in window.RTCRtpTransceiver.prototype}function au(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}function Nr(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&Ui()}var st=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,en=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype,bt="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&It()>=86,tn=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter(t=>t in window).length>0};function lc(){let r={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return I(window.AudioDecoder)||(r.AudioDecoder=!0),I(window.AudioEncoder)||(r.AudioEncoder=!0),I(window.VideoDecoder)||(r.VideoDecoder=!0),I(window.VideoEncoder)||(r.VideoEncoder=!0),I(window.ImageDecoder)||(r.ImageDecoder=!0),r}function uc(){return"mediaSession"in navigator&&!I(navigator.mediaSession.setActionHandler)}function hc(){return!I(window.WebTransport)}function cu(){let r={browser:`${Ft.name}/${Ft.version}`,os:sc(),displayResolution:nc(),isScreenShareSupported:Zs(),isWebRTCSupported:tn(),isGetUserMediaSupported:ac(),isWebAudioSupported:cc(),isWebSocketsSupported:"WebSocket"in window&&window.WebSocket.CLOSING===2,isWebCodecSupported:lc(),isMediaSessionSupported:uc(),isWebTransportSupported:hc()};return navigator.userAgent.includes("miniProgram")&&(r.browser=`mini/${r.browser}`),r}import{ChangeState as $o,FSM as Mc}from"afsm";import{ChangeState as fu,FSM as Dc}from"afsm";import{ChangeState as un,FSM as pu}from"afsm";var _c=(window==null?void 0:window.requestIdleCallback)||function(r){let t=Date.now();return setTimeout(()=>{r({didTimeout:!1,timeRemaining(){return Math.max(0,50-(Date.now()-t))}})},1e3)},du=(window==null?void 0:window.cancelIdleCallback)||function(r){clearTimeout(r)},lu=(window==null?void 0:window.cancelAnimationFrame)||(window==null?void 0:window.mozCancelAnimationFrame),Dr=class{static generateTaskID(){return this.currentTaskID++}static run(t=Mi,e,i){t===Hs?i=R({delay:2e3,count:0,backgroundTask:!0},i):t===We?i=R({delay:1e4,count:0},i):t===rt?i=R({fps:60,delay:16.6,count:0,backgroundTask:!0},i):i=R({delay:2e3,count:0,backgroundTask:!0},i),qt(e)&&(i=R(R({},i),e)),K(t)&&(e=t,t=Mi);let o=R({taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:t,callback:e},i);return this.taskMap.set(o.taskID,o),this[t](o),o.taskID}static interval(t){let e=()=>{t.callback(),t.loopCount+=1,this.isBreakLoop(t)};return t.intervalID=setInterval(e,t.delay)}static timeout(t){let e=()=>{if(t.callback(),t.loopCount+=1,!this.isBreakLoop(t))return t.timeoutID=setTimeout(e,t.delay)};return t.timeoutID=setTimeout(e,t.delay)}static ric(t){let e=w(),i,o=()=>{if(i=w()-e,i>=t.delay&&(e=w()-Math.floor(i%t.delay),t.callback(),t.loopCount+=1),!this.isBreakLoop(t))return t.ricID=_c(o,{timeout:t.delay})};return t.ricID=_c(o,{timeout:t.delay})}static raf(t){t.delay=(1e3/t.fps).toFixed(2);let e=w(),i,o=()=>{if(document.hidden&&t.backgroundTask)return i=w()-e,e=w(),t.callback(),t.loopCount+=1,this.isBreakLoop(t)?void 0:t.timeoutID=setTimeout(o,t.delay-Math.floor(i%t.delay));if(i=w()-e,i>=t.delay&&(e=w()-Math.floor(i%t.delay),t.callback(),t.loopCount+=1),!this.isBreakLoop(t))return t.rafID=requestAnimationFrame(o)};if(t.rafID=requestAnimationFrame(o),t.backgroundTask){let s=()=>{if(document.hidden){let n=w()-e;n>=t.delay?o():t.timeoutID=setTimeout(o,t.delay-n)}};document.addEventListener("visibilitychange",s),t.onVisibilitychange=s,document.hidden&&s()}return t.taskID}static hasTask(t){return this.taskMap.has(t)}static clearTask(t){if(!this.taskMap.has(t))return!0;let{intervalID:e,timeoutID:i,rafID:o,ricID:s,onVisibilitychange:n}=this.taskMap.get(t);return e&&clearInterval(e),i&&clearTimeout(i),o&&lu(o),s&&du(s),n&&document.removeEventListener("visibilitychange",n),this.taskMap.delete(t),!0}static isBreakLoop(t){return this.taskMap.has(t.taskID)?t.count!==0&&t.loopCount>=t.count?(this.clearTask(t.taskID),!0):!1:!0}};Dr.taskMap=new Map,Dr.currentTaskID=1;var z=Dr;var mc={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_PUBLISHED:"stream-published",STREAM_SUBSCRIBED:"stream-subscribed",STREAM_UNSUBSCRIBED:"stream-unsubscribed",STATE_CHANGED:"state-changed",ERROR:"error",CONNECTION_STATE_CHANGED:"connection-state-changed",SEI_MESSAGE:u.SEI_MESSAGE},q_={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_SUBSCRIBED:"stream-subscribed",CONNECTION_STATE_CHANGED:"connection-state-changed",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",MUTE_AUDIO:"mute-audio",MUTE_VIDEO:"mute-video",UNMUTE_AUDIO:"unmute-audio",UNMUTE_VIDEO:"unmute-video",CLIENT_BANNED:"client-banned",NETWORK_QUALITY:"network-quality",AUDIO_VOLUME:"audio-volume",SEI_MESSAGE:u.SEI_MESSAGE,ERROR:"error"};var Xe={LOADED_DATA:u.LOADEDDATA,MEDIA_TRACK_CHANGED:"media-track-changed",PLAYER_STATE_CHANGED:"player-state-changed"};var rn=class{constructor(){this._roomIdMap=new Map;typeof registerProcessor=="undefined"&&(this._configs={sdkAppId:"",userId:"",version:_e,env:tt.QCLOUD,browserVersion:Ft.name+Ft.version,ua:navigator.userAgent})}setConfig({sdkAppId:t,env:e,userId:i,roomId:o}){t!==this._configs.sdkAppId&&(this._configs.sdkAppId=String(t)),this._configs.env=e,this._configs.userId=i,this._roomIdMap.set(i,String(o))}logSuccessEvent(t){we||!g.isAbleToUpload||this._configs.env===tt.QCLOUD&&this.uploadEventToKibana(k(R({},t),{result:"success"}))}logFailedEvent(t){if(we||!g.isAbleToUpload)return;let{eventType:e,code:i,error:o,userId:s}=t,n={roomId:this._roomIdMap.get(s||this._configs.userId),userId:s,eventType:e,result:"failed",code:i||(o==null?void 0:o.extraCode)||(o==null?void 0:o.code)||T.UNKNOWN};this._configs.env===tt.QCLOUD&&this.uploadEventToKibana(k(R({},n),{error:o}))}uploadEventToKibana(t){let e=`stat-${t.eventType}-${t.result}`;(t.eventType==="delta-join"||t.eventType==="delta-leave"||t.eventType==="delta-publish")&&(e=`${t.eventType}:${t.delta}`),this.uploadEvent({log:e,userId:t.userId}),t.result==="failed"&&(e=`stat-${t.eventType}-${t.result}-${t.code}`,this.uploadEvent({log:e,userId:t.userId,error:t.error}))}uploadEvent({log:t,userId:e,error:i}){let o={timestamp:qr(),sdkAppId:this._configs.sdkAppId,userId:e||this._configs.userId,version:_e,log:t};i&&(o.errorInfo=i.message),this.sendRequest(Qt(this._configs.sdkAppId,jt.LOG),o)}sendRequest(t,e){if(!g.isAbleToUpload){setTimeout(()=>{this.sendRequest(t,e)},1e3);return}Dt({url:t,body:JSON.stringify(e)}).catch(()=>{})}},Z=new rn;var at="trtc_autoplay",on=`${at}_mask`,xi=`${at}_wrapper`,pc=`${at}_header`,sn=`${at}_content`,Mo=`${at}_action_wrapper`,nn=`${at}_question`,an=`${at}_collapse`,ko=`${at}_action_confirm`,Ec=`${at}_detail`,fc="#2473E8",dn="dialog",uu=`${dn}-show`,hu=`${dn}-1`,_u=`${dn}-2`,Tc=!1,ln=()=>!!document.querySelector(`.${xi}`),Sc=`${Kt}/${Ke()?"zh-cn":"en"}/tutorial-21-advanced-auto-play-policy.html`,Ic=`<br><a href='${Sc}' target='_blank'>${Ke()?"\u5176\u4ED6\u65B9\u6848\uFF1F":"Any other solution?"}</a>`,mu=`${Ke()?`\u6D4F\u89C8\u5668\u81EA\u52A8\u64AD\u653E\u7B56\u7565\uFF1A\u5728\u7528\u6237\u4E0E\u9875\u9762\u4EA7\u751F\u4EA4\u4E92\uFF08\u70B9\u51FB\u3001\u89E6\u6478\uFF09\u4E4B\u524D\uFF0C\u6D4F\u89C8\u5668\u7981\u6B62\u64AD\u653E\u6709\u58F0\u5A92\u4F53\u3002\u8BE5\u5F39\u7A97\u7528\u4E8E\u5E2E\u52A9\u7528\u6237\u6062\u590D\u97F3\u89C6\u9891\u64AD\u653E\u3002${Ic}`:`Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ${Ic}`}`,cn=class{constructor(){d(this,"content","\u97F3\u89C6\u9891\u64AD\u653E\u88AB\u6D4F\u89C8\u5668\u62E6\u622A\uFF0C\u8BF7\u70B9\u51FB\u201C\u6062\u590D\u64AD\u653E\u201D\u3002");d(this,"_dialogNode",null);d(this,"_bodyPosition","");d(this,"_showDetail",!1);d(this,"_isCollapseClicked",!1);d(this,"_isQuestionClicked",!1);if(Ke()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!Tc){let t=document.createElement("style");t.innerHTML=`.${on}{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.${on} div:not(.${Mo}){display:block !important;}.${xi}{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.${xi} a{color:${fc};}.${pc}{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.${sn}{margin:8px 0;}.${Mo}{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.${an}{margin-right:auto;cursor:pointer}.${nn}{height:100%;line-height:16px;cursor:pointer;}.${ko}{margin-left:8px;color:#fff;background:${fc};padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.${ko}:hover{opacity:0.9;}.${an},.${ko},.${sn},.${nn}{font-size:14px;}@media screen and (max-width:750px){.${xi}{width:80vw;}}`,document.head.appendChild(t),Tc=!0}this.addDiaLog()}createDiaLog(){let t=document.createElement("template");t.innerHTML=`<div class="${on}"><div class='${xi}'><div class='${pc}'>${location.host}</div><div class='${sn}'>${this.content}</div><div class='${Ec}' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">${mu}</div><div class='${Mo}'></div></div></div>`.trim();let e=document.createElement("button");e.className=ko,e.innerText=Ke()?"\u6062\u590D\u64AD\u653E":"Resume",e.onclick=this.onConfirm.bind(this);let i=document.createElement("div");i.className=nn,i.innerHTML=`<?xml version="1.0" encoding="UTF-8"?>
    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>
    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>
    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>
    </svg>
    `,i.onclick=this.onQuestionClick.bind(this);let o=document.createElement("div");o.className=an,o.innerText=`${Ke()?"\u8BE6\u60C5 >":"Detail >"}`,o.onclick=this.onCollapseClick.bind(this);let s=t.content.firstChild,n=s.querySelector(`.${Mo}`);return n.appendChild(o),n.appendChild(i),n.appendChild(e),s}addDiaLog(){ln()||(this._dialogNode=this.createDiaLog(),document.body.appendChild(this._dialogNode),this._dialogNode.onclick=this.onConfirm.bind(this),this._dialogNode.querySelector(`.${xi}`).onclick=t=>t.stopPropagation(),this._bodyPosition=document.body.style.position,document.body.style.position="fixed",g.info("show autoplay dialog"),Z.uploadEvent({log:uu}))}deleteDiaLog(){this._dialogNode&&(document.body.removeChild(this._dialogNode),document.body.style.position=this._bodyPosition,this._dialogNode=null)}onConfirm(){g.warn("confirm clicked, try resume stream"),E.emit(p.AUTOPLAY_DIALOG_CLICK_CONFIRM),this.deleteDiaLog()}onCollapseClick(){let t=this._dialogNode.querySelector(`.${Ec}`);t.style.visibility=`${this._showDetail?"hidden":"visible"}`,t.style.height=`${this._showDetail?0:"fit-content"}`,this._showDetail=!this._showDetail,this._isCollapseClicked||Z.uploadEvent({log:hu}),this._isCollapseClicked=!0}onQuestionClick(){window.open(Sc,"_blank"),this._isQuestionClicked||Z.uploadEvent({log:_u}),this._isQuestionClicked=!0}},gc=cn;var Bi={};zi(Bi,{create:()=>Le,remove:()=>pe});var Or=new WeakMap;function Le(r,t){Or.has(r)||Or.set(r,[]);let e=Or.get(r),o={add:(s,n)=>("addEventListener"in t?(e.push(t.removeEventListener.bind(t,s,n)),t.addEventListener(s,n)):(e.push(t.off.bind(t,s,n)),t.on(s,n)),o)};return o}function pe(r){let t=Or.get(r);t&&(t.forEach(e=>e()),Or.delete(r))}var ct=class extends pu{constructor(e,i){super(e.id,`${i}-player`);this.kind=i;d(this,"id");d(this,"element",null);d(this,"container",null);d(this,"mediaStream",new MediaStream);d(this,"track");d(this,"url");d(this,"attr");d(this,"muted");d(this,"_log");d(this,"_pausedRetryCount");d(this,"_isElementPlayingFired",!1);d(this,"_interval");this.id=e.id,this._log=e.log,this.track=e.track,this.container=e.container,this.muted=e.muted,this._pausedRetryCount=Bs,this._state="STOPPED",this.bindTrackEvents()}get isPlaying(){return this._state==="PLAYING"}get isStopped(){return this._state==="STOPPED"}setAttr(e){this.attr=e}setTrack(e){if(e!==this.track&&(this.unbindTrackEvents(),this.track=e,this.emit(Xe.MEDIA_TRACK_CHANGED,e),e!==null&&(this.bindTrackEvents(),this.element))){let i=new MediaStream;i.addTrack(e),this.element.srcObject=i}}setUrl(e){this.track&&(this.unbindTrackEvents(),this.element&&(this.element.srcObject=null),this.track=null),e!==this.url&&(this.url=e,e!==null&&this.element&&(this.element.crossOrigin="anonymous",this.element.src=e))}setContainer(e){this.container=e,this.track&&this.element&&this.container&&this.container.appendChild(this.element)}play(){return _(this,null,function*(){if(this.element&&this.element.parentElement!==this.container&&this.container&&this.container.append(this.element),!this.isPlaying)try{this.bindAutoPlayEvent(),yield this.element.play()}catch(e){let i=y({key:C.PLAY_FAILED,data:{media:this.kind,error:e}});if(this.track&&!this.track.muted&&this._log.warn(e),i.includes("NotAllowedError"))throw new A({code:T.PLAY_NOT_ALLOWED,message:i})}})}stop(){this.unbindEvents(),this._isElementPlayingFired=!1,this.element&&(this.container&&this.container.removeChild(this.element),this.element.srcObject=null,this.element=null),this.handleStopped(u.ENDED),this._interval>0&&z.clearTask(this._interval)}pause(){var e;this.isPlaying&&((e=this.element)==null||e.pause())}resume(){return this.isPlaying?Promise.resolve():Ht?this.replay():this.play().catch(()=>{})}setMuted(e){this.element&&(this.element.muted=e),this.muted=e}setRect(e,i){this.element&&(this.element.style.width=`${e}px`,this.element.style.height=`${i}px`)}replay(){return this.stop(),this.play().catch(()=>{})}bindElementEvents(){if(this.element){let e=this.handleElementEvent.bind(this);Le(this.element,this.element).add(u.PLAYING,e).add(u.ENDED,e).add(u.PAUSE,e).add(u.ERROR,e).add(u.LOADEDDATA,e)}}bindTrackEvents(){if(this.track){let e=this.handleTrackEvent.bind(this);Bi==null||Bi.create(this.track,this.track).add(u.ENDED,e).add(u.MUTE,e).add(u.UNMUTE,e),this.track.readyState===u.ENDED&&this.handleTrackEvent({type:u.ENDED}),this.track.muted&&this.handleTrackEvent({type:u.MUTE})}}bindAutoPlayEvent(){E.on(p.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}unbindTrackEvents(){this.track&&pe(this.track)}unbindEvents(){this.element&&pe(this.element),this.unbindTrackEvents(),E.off(p.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}handleElementEvent(e){var o;switch(e.type){case u.PLAYING:this._isElementPlayingFired=!0,this._log.info(`${this.kind} player is playing`),this.handlePlaying(u.PLAYING),this._interval&&(z.clearTask(this._interval),this._interval=-1);break;case u.ENDED:this._log.info(`${this.kind} player is ended`),this.handleStopped(u.ENDED);break;case u.PAUSE:this._log.info(`${this.kind} player is paused`),this.handlePaused(u.PAUSE);let s=this.container&&document.getElementById(this.container.id);s||this._log.warn(`${this.kind} player has been remove, element ID: ${(o=this.container)==null?void 0:o.id}`);let n=It();this._pausedRetryCount>0&&(this.kind===u.VIDEO&&!ln()||this.kind===u.AUDIO&&(J(n)&&n<=70||!s))&&(this._log.info(`${this.kind} player auto resume when paused`),this.resume(),this._pausedRetryCount--),De&&(this._interval=z.run(Mi,()=>{this.element&&this._state==="PAUSED"&&this.resume()},{delay:3e3}));break;case u.ERROR:if(this.element&&this.element.error){let{code:a,message:c}=this.element.error;this._log.error(`${this.kind} player error observed. code: ${a} message: ${c} userAgent: ${navigator.userAgent}`),Z.uploadEvent({log:`stat-${this.kind}-${Ge.PLAYER_ERROR}-${a}-${navigator.userAgent}`,error:this.element.error})}break;case u.LOADEDDATA:this.kind===u.VIDEO&&this.emit(Xe.LOADED_DATA);break}}handleTrackEvent(e){switch(e.type){case u.ENDED:this._log.info(`${this.kind} track is ended`),this.handleStopped(u.ENDED);break;case u.MUTE:this._log.info(`${this.kind} track is unable to provide media output`),this.handlePaused(u.MUTE);break;case u.UNMUTE:this._log.info(`${this.kind} track is able to provide media output`),this._isElementPlayingFired&&this.handlePlaying(u.UNMUTE);break}}handlePlaying(e){this.emit(Xe.PLAYER_STATE_CHANGED,{type:this.kind,state:"PLAYING",reason:e})}handlePaused(e){this.emit(Xe.PLAYER_STATE_CHANGED,{type:this.kind,state:"PAUSED",reason:e})}handleStopped(e){this.emit(Xe.PLAYER_STATE_CHANGED,{type:this.kind,state:"STOPPED",reason:e})}getElement(){return this.element}};N([un([],"PLAYING")],ct.prototype,"handlePlaying",1),N([un("PLAYING","PAUSED",{ignoreError:!0})],ct.prototype,"handlePaused",1),N([un([],"STOPPED")],ct.prototype,"handleStopped",1);var ei=class extends ct{constructor(e){super(e,u.VIDEO);d(this,"mirror");d(this,"objectFit");I(e.mirror)||(this.mirror=e.mirror),I(e.objectFit)||(this.objectFit=e.objectFit)}initializeElement(){var o;let e=document.createElement(u.VIDEO);if(this.track){let s=new MediaStream;s.addTrack(this.track),e.srcObject=s}e.muted=!0;let i=`width: 100%; height: 100%; object-fit: ${this.objectFit};background-color: black;`;this.mirror&&(i+="transform: scaleX(-1);"),e.setAttribute("id",`video_${this.id}`),e.setAttribute("style",i),e.setAttribute("autoplay","autoplay"),e.setAttribute("playsinline","playsinline"),(o=this.container)==null||o.appendChild(e),this.element=e,this.bindElementEvents()}setAttr(e){let i=Object.assign({autoplay:"autoplay",playsinline:"playsinline",muted:!0},e);i.style=Object.assign({width:"100%",height:"100%"},i.style),super.setAttr(i)}setMirror(e){this.element&&(this.element.style.transform=e?"scaleX(-1)":""),this.mirror=e}setObjectFit(e){this.element&&(this.element.style.objectFit=`${e}`),this.objectFit=e}play(){return this.element||this.initializeElement(),super.play()}getVideoFrame(){if(!this.element)return"";let e=document.createElement("canvas");return e.width=this.element.videoWidth,e.height=this.element.videoHeight,e.getContext("2d").drawImage(this.element,0,0),e.toDataURL("image/png")}getElement(){return this.element}};var Eu="class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=Math.max(rms,this.volume*0.95);this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);",Rc=!1,hn=class{constructor(t){d(this,"context_");d(this,"blob_");this.context_=t.context,this.blob_=new Blob([Eu],{type:"application/javascript"}),this.addModuleToContext()}addModuleToContext(){return _(this,null,function*(){try{yield this.context_.audioWorklet.addModule(URL.createObjectURL(this.blob_)),g.info("worklet addModule success"),E.emit(p.WORKLET_LOADED_SUCCESS),Rc=!0}catch(t){g.info(`worklet addModule catch error. ${t.message}`),E.emit(p.WORKLET_LOADED_FAILED)}})}get initWorkletSuccess(){return Rc}},Cc=hn;typeof window!="undefined"&&(window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var $i=()=>{let r=new window.AudioContext,t=()=>{r.state==="suspended"?(r.resume(),document.addEventListener("click",t)):r.state==="interrupted"?r.resume():document.removeEventListener("click",t)};return document.addEventListener("click",t),r.onstatechange=()=>{g.info(`audioSource context state: ${r.state}`),t()},r};var xe,wo,Vo=0,_n=class{constructor(t){d(this,"_volume");d(this,"_log");d(this,"_track");d(this,"_stream");d(this,"_audioCtx");d(this,"_destination");d(this,"_streamSource");d(this,"_scriptProcessorNode");d(this,"_audioWorkletNode");d(this,"_interval");let{track:e,log:i}=t;this._volume=0,this._log=i,this._track=e,xe||(xe=$i()),this._audioCtx=xe,this._destination=this._audioCtx.destination;let o=new MediaStream;o.addTrack(this._track),this._streamSource=this._audioCtx.createMediaStreamSource(o),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._interval=200,E.on(p.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),Gs?(E.on(p.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),E.on(p.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor(),Vo+=1}preload(){wo?wo.initWorkletSuccess&&this.initAudioWorklet():wo=new Cc({context:xe})}initAudioWorklet(){if(!this._audioWorkletNode)try{this._audioWorkletNode=new AudioWorkletNode(this._audioCtx,"volume-meter"),this._audioWorkletNode.port.onmessage=t=>{this._volume=t.data.volume||0},this._streamSource.connect(this._audioWorkletNode).connect(this._destination),this.handleAudioLevelInterval({interval:this._interval})}catch(t){Z.logFailedEvent({userId:this._log.userId,eventType:Ge.LOAD_WORKLET,error:t}),this.initScriptProcessor()}}initScriptProcessor(){if(!this._scriptProcessorNode)try{this._scriptProcessorNode=this._audioCtx.createScriptProcessor(2048,1,1),this._scriptProcessorNode.onaudioprocess=t=>{let e=t.inputBuffer.getChannelData(0),i=0;for(let o=0;o<e.length;++o)i+=e[o]*e[o];this._volume=Math.sqrt(i/e.length)||0},this._streamSource.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._destination)}catch(t){this._log.error(`volumeMeter init script processor error: ${t}`)}}destroy(){this._streamSource&&this._streamSource.disconnect(),this._scriptProcessorNode&&(this._scriptProcessorNode.onaudioprocess=null,this._scriptProcessorNode.disconnect()),this._audioWorkletNode&&(this._audioWorkletNode.port.postMessage({name:"stop"}),this._audioWorkletNode.port.onmessage=null,this._audioWorkletNode.disconnect()),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._audioCtx=null,E.off(p.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),E.off(p.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),E.off(p.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),Vo>0&&(Vo-=1),Vo===0&&(xe==null||xe.close(),xe=null,wo=null)}resume(){xe==null||xe.resume()}getInternalAudioLevel(){return this._volume}getCalculatedVolume(){return parseFloat(this._volume.toFixed(2))}handleAudioLevelInterval(t){var i;let{interval:e}=t;this._interval=e,(i=this._audioWorkletNode)==null||i.port.postMessage({name:"setIntervalTime",intervalTime:e})}},Nc=_n;var ti=class extends ct{constructor(e){super(e,u.AUDIO);d(this,"_volumeMeter");d(this,"gainedTrack");d(this,"_outputDeviceId");d(this,"_volume",1);d(this,"_loop",!1);e.gainedTrack&&(this.gainedTrack=e.gainedTrack),this._outputDeviceId=e.outputDeviceId,this.track&&this.initVolumeMeter(this.track)}setTrack(e){this.track!==e&&(this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),e!==null&&this.initVolumeMeter(e)),super.setTrack(e)}initVolumeMeter(e){this._volumeMeter=new Nc({track:this.gainedTrack||e,log:this._log})}initializeElement(){if(($t==="15.2"||$t==="15.3"||$t==="15.4")&&this.muted){this._log.info("audioElement is muted.");return}let i=document.createElement(u.AUDIO);if(this.gainedTrack||this.track){let o=new MediaStream;o.addTrack(this.gainedTrack||this.track),i.srcObject=o}i.muted=this.muted,i.setAttribute("id",`audio_${this.id}`),i.setAttribute("autoplay","autoplay"),i.setAttribute("playsinline","playsinline"),this.element=i,this.bindElementEvents()}play(){return _(this,null,function*(){this.element||this.initializeElement(),this._outputDeviceId&&(yield this.setSinkId(this._outputDeviceId)),!this._volumeMeter&&this.track&&this.initVolumeMeter(this.track),this.setVolume(this._volume),yield Bt(ti.prototype,this,"play").call(this)})}stop(){this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),super.stop()}resume(){return _(this,null,function*(){yield Bt(ti.prototype,this,"resume").call(this),this._volumeMeter&&this._volumeMeter.resume()})}setSinkId(e){return _(this,null,function*(){this._outputDeviceId!==e&&(this.element&&(yield this.element.setSinkId(e)),this._outputDeviceId=e)})}setVolume(e){!this.element||(this.element.volume=e,this._volume=e)}setLoop(e){!this.element||(this.element.loop=e,this._loop=e)}getAudioLevel(){var e;return((e=this._volumeMeter)==null?void 0:e.getCalculatedVolume())||0}getInternalAudioLevel(){var e;return(e=this._volumeMeter)==null?void 0:e.getInternalAudioLevel()}};var ii=class extends Dc{constructor({userId:e,sdkAppId:i,mediaType:o,room:s,isInitPlayer:n=!0}){var a;super();d(this,"id",Js());d(this,"userId");d(this,"isRemote");d(this,"mediaType");d(this,"room");d(this,"user");d(this,"_log");d(this,"isPlayCalled");d(this,"mediaTrack",null);d(this,"mediaStream");d(this,"container",null);d(this,"subVideoPlayerMap");d(this,"playerMuted",!1);d(this,"abortCtrl");d(this,"audioOutputDeviceId");d(this,"audioVolume");d(this,"objectFit","cover");d(this,"mirror",!1);d(this,"gain");d(this,"isScreen",!1);I(e)||(this.userId=e),this.mediaType=o,this._log=g.createLogger({id:`${this.kind[0]}t`,userId:(a=s||this.room)==null?void 0:a.userId,remoteUserId:this instanceof Ee?void 0:this.userId,sdkAppId:i,type:this.mediaType===2?"auxiliary":"main",isLocal:this instanceof Ee}),n&&this.initPlayer()}get log(){return this._log||g}get kind(){return this.mediaType===1?u.AUDIO:u.VIDEO}get muted(){return!!(this.mediaTrack&&!this.mediaTrack.enabled)}get strMediaType(){return this.mediaType===4?u.VIDEO:this.mediaType===2?u.SCREEN:u.AUDIO}uninstallEvents(){}play(e,i){return _(this,null,function*(){let o=de(e)?e[0]:e;if(this.isPlayCalled){i&&!I(i.muted)&&this.setPlayerMute(i.muted),i&&!I(i.objectFit)&&(this.objectFit=i.objectFit),this.isScreen?this.mirror=!1:i&&!I(i.mirror)&&(this.mirror=i.mirror),this.kind===u.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror),this.container!==o&&o&&(this.container=o,this.player.setContainer(o)),de(e)&&e.length>=1&&(yield this.playSubContainer(e.slice(1),i)));return}if((!this.isRemote||this.kind===u.VIDEO)&&this.setPlayerMute(!0),i&&!I(i.muted)&&this.setPlayerMute(i.muted),i&&!I(i.objectFit)&&(this.objectFit=i.objectFit),this.isRemote||(this.mirror=!0),this.isScreen?this.mirror=!1:i&&!I(i.mirror)&&(this.mirror=i.mirror),this.kind===u.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror)),this.isPlayCalled=!0,o&&(this.container=o,this.player.setContainer(o)),E.emit(p.PLAY_TRACK_START,{track:this}),!!this.mediaTrack){this._log.info(`play with options: ${JSON.stringify(i)}`);try{yield this.player.play(),de(e)&&e.length>1&&(yield this.playSubContainer(e.slice(1),i))}catch(s){throw this.handleAutoPlayFailed(),this.emit("error",s),s}}})}playSubContainer(e,i){return _(this,null,function*(){if(!this.mediaTrack||this.kind===u.AUDIO)return;this.subVideoPlayerMap||(this.subVideoPlayerMap=new Map),this.subVideoPlayerMap.forEach((s,n)=>{var a;e.find(c=>n===c)||(s.stop(),s.setContainer(null),(a=this.subVideoPlayerMap)==null||a.delete(n))});for(let[s,n]of e.entries()){let a=this.subVideoPlayerMap.get(n);a?i&&(I(i.mirror)||a.setMirror(i.mirror),I(i.objectFit)||a.setObjectFit(i.objectFit)):this.subVideoPlayerMap.set(n,new ei({id:this.userId||this.id,track:this.mediaTrack,container:n,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log.createChild({id:`vp-sub${s+1}`})}))}let o=[...this.subVideoPlayerMap.values()];for(let s of o)yield s.play()})}initPlayer(){var e;this.log.info(`create ${this.kind}Player`),this.kind===u.AUDIO?this.player=new ti({id:this.userId||this.id,track:this.mediaTrack,gainedTrack:(e=this.gain)==null?void 0:e.audioTrack,container:this.container||null,muted:this.playerMuted,outputDeviceId:this.audioOutputDeviceId,log:this.log}):(this.player=new ei({id:this.userId||this.id,track:this.mediaTrack,container:this.container||null,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log}),this.player.on(Xe.LOADED_DATA,()=>{E.emit(p.VIDEO_LOADED_DATA,{track:this})}),this.player.on(Xe.MEDIA_TRACK_CHANGED,i=>{var o;(o=this.subVideoPlayerMap)==null||o.forEach(s=>s.setTrack(i))})),this.player.on(Xe.PLAYER_STATE_CHANGED,i=>{E.emit(p.PLAYER_STATE_CHANGED,R({track:this},i)),this.emit("player-state-changed",i)})}setAudioOutput(e){return _(this,null,function*(){var i;this.audioOutputDeviceId=e,yield(i=this.player)==null?void 0:i.setSinkId(e)})}setAudioVolume(e){var i;this.audioVolume=e,this.log.info(`setAudioVolume to ${e}`),(i=this.player)==null||i.setVolume(e)}getAudioLevel(){var e;return((e=this.player)==null?void 0:e.getAudioLevel())||0}getInternalAudioLevel(){var e;return((e=this.player)==null?void 0:e.getInternalAudioLevel())||0}stop(){!this.isPlayCalled||(this.isPlayCalled=!1,this.player&&(this.log.info(`stop ${this.kind} player`),this.player.stop(),this.player.setContainer(null)),this.subVideoPlayerMap&&this.subVideoPlayerMap.size>0&&this.subVideoPlayerMap.forEach(e=>{e.stop(),e.setContainer(null)}),this.container=null)}resume(){return _(this,null,function*(){var e;!this.isPlayCalled||(yield(e=this.player)==null?void 0:e.resume())})}close(){var e;this.log.info("close"),this.isPlayCalled&&this.stop(),!this.isRemote&&((e=this.mediaTrack)==null||e.stop(),this.mediaTrack=null,this.uninstallEvents())}setMute(e){return this.mediaTrack?(this.mediaTrack.enabled=!e,this.emit(e?"mute":"unmute",this),E.emit(e?p.TRACK_MUTED:p.TRACK_UNMUTED,{track:this}),!0):!1}setPlayerMute(e){this.playerMuted=e,this.player.setMuted(e)}setMediaStream(e){e!==this.mediaStream&&(this.mediaStream=e)}setMediaStreamTrack(e){this.mediaStream||(this.mediaStream=new MediaStream),this.mediaTrack&&this.mediaStream.removeTrack(this.mediaTrack);let i=this.mediaTrack;this.mediaTrack=e,this.mediaTrack&&(this.mediaTrack.enabled=!this.muted,this.mediaStream.addTrack(this.mediaTrack),this.isRemote||this.player.setTrack(this.mediaTrack)),this.updatePlayingState(!!e),this.emit("media-track-changed",this.mediaTrack,i)}setMediaType(e){this.mediaType=e}updatePlayingState(e){if(!(!this.isPlayCalled||e&&!this.player.isStopped||!e&&this.player.isStopped)&&this.isPlayCalled&&this.player.isStopped===e){if(this.log.info(`playing state updated, ${e?"play":"stop"} ${this.kind}`),e&&this.player.isStopped){if(this instanceof Se&&(!this.isSubscribed||!this.hasFlag))return;this.player.play().catch(()=>this.handleAutoPlayFailed())}!e&&!this.player.isStopped&&this.player.stop()}}handleAutoPlayFailed(){if(this.room&&this.room.enableAutoPlayDialog)new gc;else{let e=()=>{this.resume().then(()=>{document.removeEventListener("click",e,!0),document.removeEventListener("touchstart",e,!0)})};document.addEventListener("click",e,!0),document.addEventListener("touchstart",e,!0)}}};N([fu([],Dc.INIT)],ii.prototype,"close",1);var Tu=Object.prototype.hasOwnProperty,{toString:Bp}=Object.prototype;function Iu(r){if(r==null)return!0;if(typeof r=="boolean")return!1;if(typeof r=="number")return r===0;if(typeof r=="string"||typeof r=="function"||Array.isArray(r))return r.length===0;if(r instanceof Error)return r.message==="";if(ot(r))switch(Object.prototype.toString.call(r)){case"[object File]":case"[object Map]":case"[object Set]":return r.size===0;case"[object Object]":{for(let t in r)if(Tu.call(r,t))return!1;return!0}}return!1}var lt=Iu;import{EventEmitter as Su}from"eventemitter3";var Oc=r=>t=>t.deviceId===r;var yr=class{constructor(t,e="Input"){d(this,"kind");d(this,"type");d(this,"devices",[]);this.kind=t,this.type=e}update(t,e){let i=t.filter(o=>o.kind===`${this.kind}${this.type.toLocaleLowerCase()}`);e&&(i.forEach(o=>{if(o.deviceId&&!this.devices.find(Oc(o.deviceId))){let s=`${this.kind}${this.type}Added`;g.warn(`${s}: ${JSON.stringify(o)}`),e.emit(s,o)}}),this.devices.forEach(o=>{if(o.deviceId&&!i.find(Oc(o.deviceId))){let s=`${this.kind}${this.type}Removed`;g.warn(`${s}: ${JSON.stringify(o)}`),e.emit(s,o)}})),this.devices=i}hasDevice(t){return!!this.devices.find(e=>e.deviceId===t)}},pn=class extends Su{constructor(){super();d(this,"audioInputs",new yr(u.AUDIO));d(this,"videoInputs",new yr(u.VIDEO));d(this,"audioOutputs",new yr(u.AUDIO,"Output"));this.init(),navigator.mediaDevices&&navigator.mediaDevices.addEventListener("devicechange",this.update.bind(this))}init(){Uo().then(e=>{this.audioInputs.update(e),this.videoInputs.update(e),this.audioOutputs.update(e)})}update(){return _(this,null,function*(){let e=yield Uo();return this.audioInputs.update(e,this),this.videoInputs.update(e,this),this.audioOutputs.update(e,this),this})}},te=hr||Di?null:new pn;function Uo(){return _(this,null,function*(){return Qs()||!bo()?[]:(yield navigator.mediaDevices.enumerateDevices()).map((t,e)=>{let i={kind:t.kind,deviceId:t.deviceId,groupId:t.groupId,label:t.label||`${t.kind}_${e}`};return t.deviceId.length>0&&En.add(`${t.deviceId}_${t.kind}`),t.getCapabilities&&(i.getCapabilities=()=>t.getCapabilities()),i})})}function ge(){return te.update().then(r=>r.audioInputs.devices)}function ve(){return te.update().then(r=>r.videoInputs.devices)}function Hi(){return _(this,null,function*(){return te.update().then(r=>r.audioOutputs.devices)})}var En=new Set;function yc(r){if(r instanceof CanvasCaptureMediaStreamTrack||!(r instanceof MediaStreamTrack))return!1;let t=r.label.toLocaleLowerCase();if(t.includes("camera")||t.includes("webcam"))return!0;let i=`${((r==null?void 0:r.getSettings())||{}).deviceId}_${u.VIDEO_INPUT}`;return!!En.has(i)}function bc(r){if(r instanceof CanvasCaptureMediaStreamTrack||!(r instanceof MediaStreamTrack))return!1;let t=r.label.toLocaleLowerCase();if(t.includes("mic")||t.includes("\u9EA6\u514B\u98CE"))return!0;let i=`${((r==null?void 0:r.getSettings())||{}).deviceId}_${u.AUDIO_INPUT}`;return!!En.has(i)}function fn(r,t){return _(this,null,function*(){let i=(yield ge()).find(o=>o.deviceId===Xt);return(i==null?void 0:i.groupId)===r&&i.label===t})}function Lc(s){return _(this,arguments,function*({newDeviceId:r,oldDeviceId:t,oldGroupId:e,oldLabel:i,kind:o}){return r!==t?!1:o===u.AUDIO&&r===Xt?yield fn(e,i):!0})}var gu=function(r){return _(this,null,function*(){let t=Ru(r);g.info(`getUserMedia with constraints: ${JSON.stringify(t)}`);let e=[],i=[];t.audio&&(e=yield ge(),g.info(`microphones: ${zt(e,["label","deviceId"])}`)),t.video&&(i=yield ve(),g.info(`cameras: ${zt(i,["label","deviceId"])}`));try{let o=yield navigator.mediaDevices.getUserMedia(t);return en&&o.getTracks().forEach(s=>{g.info(`${s.kind} capabilities: ${zt(s.getCapabilities(),Co)}`)}),o}catch(o){if(o.name==="NotFoundError"){if(i&&i.length===0)throw new A({code:T.DEVICE_NOT_FOUND,message:y({key:C.CAMERA_NOT_FOUND})});if(e&&e.length===0)throw new A({code:T.DEVICE_NOT_FOUND,message:y({key:C.MICROPHONE_NOT_FOUND})})}throw new A({code:T.INITIALIZE_FAILED,name:o.name,message:o.message,constraint:o.constraint})}})},Au=Je({retryFunction:gu,settings:{retries:3,timeout:500},onError:(r,t,e,i)=>{r.name==="NotReadableError"?(i[0].video&&(i[0].maxResolution=!1,i[0].frameRate&&(i[0].frameRate=i[0].frameRate>10?10:5)),t()):e(r),i[0].microphoneId&&vc(i[0].microphoneId,!1),i[0].cameraId&&vc(i[0].cameraId,!0)},onRetrying:r=>{g.warn(`getUserMedia NotReadableError observed, retrying [${r}/3]`)}});function vc(r,t){return _(this,null,function*(){let i=(t?yield ve():yield ge()).find(o=>o.deviceId===r);i&&K(i.getCapabilities)&&g.warn(zt(i.getCapabilities(),Co))})}function Ru(r){return{audio:Cu(r),video:Nu(r)}}function Cu(r){if(!r.audio)return!1;let t={};return lt(r.microphoneId)||(t.deviceId=r.useExact?{exact:r.microphoneId}:r.microphoneId),J(r.channelCount)&&r.channelCount>1&&(t.channelCount=r.channelCount),re(r.echoCancellation)&&!r.echoCancellation&&(t.echoCancellation=!1),re(r.noiseSuppression)&&!r.noiseSuppression&&(t.noiseSuppression=!1),re(r.autoGainControl)&&!r.autoGainControl&&(t.autoGainControl=!1),lt(t)?!0:t}function Nu(r){if(!r.video)return!1;let{maxResolution:t=!0}=r,e={};return r.cameraId?e.deviceId=r.useExact?{exact:r.cameraId}:r.cameraId:r.facingMode&&(e.facingMode=r.facingMode),r.width&&(e.width={ideal:r.width},t&&(e.width.max=r.width)),r.height&&(e.height={ideal:r.height},t&&(e.height.max=r.height)),Y&&Fe&&r.width&&r.height&&r.width*r.height<352*288&&(e.width=r.width,e.height=r.height),r.frameRate&&(e.frameRate=r.frameRate),lt(e)?!0:e}var Pc=Au;function xo(r){return H((t,e)=>function(...i){return _(this,null,function*(){return yield r.apply(this,i),t.apply(this,i)})})}function Bo(r){return H((t,e)=>function(...i){return _(this,null,function*(){return r.call(this,t.apply(this,i))})})}function H(r){return function(t,e,i){return i.value=r(i.value,e),i}}var Ee=class extends ii{constructor(e,i=!0){super({mediaType:e,isInitPlayer:i});d(this,"isRemote",!1);d(this,"deviceId");d(this,"groupId","");d(this,"label","");d(this,"_isRecapturing",!1);d(this,"_lastRecaptureTime",0);d(this,"_onMuteTimeoutId",-1);this.onTrackMuted=this.onTrackMuted.bind(this),this.onTrackUnmuted=this.onTrackUnmuted.bind(this),this.onTrackEnded=this.onTrackEnded.bind(this)}installTrackEvent(e){e.addEventListener(u.MUTE,this.onTrackMuted),e.addEventListener(u.UNMUTE,this.onTrackUnmuted),e.addEventListener(u.ENDED,this.onTrackEnded),e.muted&&this.onTrackMuted(),e.readyState===u.ENDED&&this.onTrackEnded()}uninstallTrackEvent(e){e.removeEventListener(u.MUTE,this.onTrackMuted),e.removeEventListener(u.UNMUTE,this.onTrackUnmuted),e.removeEventListener(u.ENDED,this.onTrackEnded)}setStateToCapture(){}capture(e){return _(this,null,function*(){try{E.emit(p.LOCAL_TRACK_CAPTURE_START,{track:this});let i;e.customSource?(i=new MediaStream,i.addTrack(e.customSource)):i=yield Pc(e);let o=i.getTracks()[0];return this.setMediaStream(i),this.setMediaStreamTrack(o),e.customSource||(this.updateDeviceIdInUse(),this.listenDeviceChange()),E.emit(p.LOCAL_TRACK_CAPTURE_SUCCESS,{track:this}),i}catch(i){throw E.emit(p.LOCAL_TRACK_CAPTURE_FAILED,{track:this,error:i}),this.log.error(`getUserMedia error observed ${i}`),i}})}setMediaStreamTrack(e){this.state===Mc.INIT&&this.setStateToCapture(),this.mediaTrack&&this.uninstallTrackEvent(this.mediaTrack),super.setMediaStreamTrack(e),e&&this.installTrackEvent(e)}setPublishStarting(e){this.room=e}setPublishStarted(){}setPublishStopped(e,i){}publish(e){this.room=e,this.userId=e.userId,this._log.setUserId(e.userId),this._log.setSdkAppId(e.sdkAppId),E.emit(p.LOCAL_TRACK_PUBLISHED,{track:this}),this.setPublishStarted()}unpublish(){E.emit(p.LOCAL_TRACK_UNPUBLISHED,{track:this}),this.mediaType===2&&(this.mediaType=4),this.setPublishStopped("api-call"),this.room=void 0}get isPublishing(){return this.state==="publish"}updateDeviceIdInUse(){return _(this,null,function*(){if(this.mediaTrack&&st){let{deviceId:e,groupId:i}=this.mediaTrack.getSettings(),{label:o}=this.mediaTrack;(yield Lc({newDeviceId:e,oldDeviceId:this.deviceId,oldGroupId:this.groupId,oldLabel:this.label,kind:this.kind}))||(this.deviceId=e,this.label=o,i&&(this.groupId=i),Uo().then(n=>{let a=n.find(c=>c.deviceId===e);a&&this.emit("2",a)}))}})}setProfile(e){this.log.info("setProfile",e),Object.assign(this.profile,e)}isNeedToRecapture(e=!1){return!(!this.deviceId||!this.mediaTrack||this.kind===u.AUDIO&&!bc(this.mediaTrack)||this.kind===u.VIDEO&&!yc(this.mediaTrack)||this._isRecapturing||e&&Fe&&ke)}onTrackMuted(){if(!!this.isNeedToRecapture(!0)){if(Date.now()-this._lastRecaptureTime<Pi){setTimeout(()=>this.onTrackMuted(),Pi);return}this._onMuteTimeoutId=setTimeout(()=>_(this,null,function*(){var e;((e=this.mediaTrack)==null?void 0:e.muted)&&document.visibilityState==="visible"&&this.recapture(yield this.getRecoverCaptureDeviceId())}),5e3)}}onTrackUnmuted(){this._onMuteTimeoutId>0&&clearTimeout(this._onMuteTimeoutId)}onTrackEnded(){return _(this,null,function*(){if(!!this.isNeedToRecapture()){if(Date.now()-this._lastRecaptureTime<Pi){setTimeout(()=>this.onTrackEnded(),Pi);return}this.recapture(yield this.getRecoverCaptureDeviceId())}})}recapture(e){return _(this,null,function*(){var s;if(this._isRecapturing||!this.mediaTrack)return;let i;return this.log.warn("recapture trying"),(s=this.mediaTrack)==null||s.stop(),this._isRecapturing=!0,this._lastRecaptureTime=Date.now(),(this.kind==="audio"?yield ge():yield ve()).find(n=>n.deviceId===e)&&(i=e),this.capture({deviceId:i,useExact:!0}).then(()=>{var n;return(n=this.room)==null?void 0:n.replaceTrack(this)}).then(()=>{this._isRecapturing=!1,this.log.warn("recapture success"),this.emit("1",{deviceId:this.deviceId})}).catch(n=>{this._isRecapturing=!1,this.log.warn(`recapture failed ${n.message}`),this.emit("5",n)})})}getRecoverCaptureDeviceId(){return _(this,null,function*(){let{deviceId:e}=this;if(e){let i=(br.get(e)||0)+1;if(br.set(e,i),i>=3){let o=this.kind==="video"?(yield ve()).find(s=>!br.has(s.deviceId)):(yield ge()).find(s=>!br.has(s.deviceId));o&&(this.log.warn(`${e} capture fail ${i} times, change new ${o.deviceId}`),e=o.deviceId)}}return e})}};N([$o(Mc.INIT,"capture")],Ee.prototype,"setStateToCapture",1),N([$o("capture","publish_starting",{success(){this.emit("4",{mediaType:this.strMediaType,state:"starting",prevState:"stopped"})}})],Ee.prototype,"setPublishStarting",1),N([$o("publish_starting","publish",{ignoreError:!0,success(){this.emit("4",{mediaType:this.strMediaType,state:"started",prevState:"starting"})}})],Ee.prototype,"setPublishStarted",1),N([H(r=>function(t,e){let i=this.state.oldState||this.state;r.call(this,t,e),i!=="capture"&&this.emit("4",{mediaType:this.strMediaType,state:"stopped",prevState:this.state.oldState==="publish_starting"?"starting":"started",reason:t,error:e})}),$o(["publish","publish_starting"],"capture",{ignoreError:!0})],Ee.prototype,"setPublishStopped",1);var br=new Map;E.on(p.SWITCH_DEVICE_SUCCESS,r=>{r.track.deviceId&&br.delete(r.track.deviceId)});var Ae=class extends Ee{constructor(){super(1);d(this,"mediaType",1);d(this,"volume",0);d(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40});d(this,"playerMuted",!0)}getAudioLevel(){return this.volume||super.getAudioLevel()}capture({deviceId:e,useExact:i=!1}={}){return super.capture({video:!1,audio:!0,microphoneId:e,echoCancellation:this.profile.echoCancellation,autoGainControl:this.profile.autoGainControl,noiseSuppression:this.profile.noiseSuppression,sampleRate:this.profile.sampleRate,channelCount:this.profile.channelCount,useExact:i})}switchDevice(e){return _(this,null,function*(){if(!(!this.mediaStream||!this.mediaTrack)){if(this.deviceId===e)if(e===Xt){if(yield fn(this.groupId,this.label))return}else return;try{this.log.info(`switchDevice audio to: ${e}`),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),E.emit(p.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch microphone success")}catch(i){throw this.log.error(`switch microphone failed ${i}`),this.deviceId&&this.recapture(this.deviceId),i}}})}listenDeviceChange(){te&&!te.listeners("audioInputRemoved").includes(this.handleMicrophoneRemoved)&&te.on("audioInputRemoved",this.handleMicrophoneRemoved,this)}handleMicrophoneRemoved(e){return _(this,null,function*(){if(e.deviceId===this.deviceId){this.log.warn(`current microphone is lost: ${JSON.stringify(e)}`);let i=yield ge();i[0]?this.recapture(i[0].deviceId):te.on("audioInputAdded",this.handleMicrophoneAdded,this)}})}handleMicrophoneAdded(e){return _(this,null,function*(){this.log.warn(`microphone added: ${JSON.stringify(e)}`),this.recapture(e.deviceId)})}close(){te.off("audioInputAdded",this.handleMicrophoneAdded,this),te.off("audioInputRemoved",this.handleMicrophoneRemoved,this),super.close()}};var Be=class extends Ee{constructor(){super(4);d(this,"mediaType",4);d(this,"profile",{width:640,height:480,frameRate:15,bitrate:900});d(this,"states",{bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0});d(this,"small");d(this,"facingMode");d(this,"_canvas");d(this,"_canvasInterval");d(this,"canvasTrack")}capture({deviceId:e,facingMode:i,useExact:o=!1,customSource:s}={}){return super.capture({audio:!1,video:!0,facingMode:i||this.facingMode,cameraId:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,useExact:o,customSource:s})}genCanvasTrack(){if(this.canvasTrack||!this.mediaTrack)return;this.log.info("gen canvas track");let{width:e,height:i,frameRate:o}=this.mediaTrack.getSettings();this._canvas=document.createElement("canvas");let s=this._canvas.getContext("2d");e&&i&&(this._canvas.width=e,this._canvas.height=i),this._canvasInterval=z.run(rt,()=>{if(!this._canvas)return;if(this.mediaTrack){let c=this.mediaTrack.getSettings();(c.width!==this._canvas.width||c.height!==this._canvas.height)&&(this._canvas.width=c.width,this._canvas.height=c.height)}let a=this.player.getElement();a&&(s==null||s.drawImage(a,0,0,this._canvas.width,this._canvas.height))},{fps:Math.max(15,o||0)});let n=this._canvas.captureStream();this.canvasTrack=n.getVideoTracks()[0]}destoryCanvasTrack(){this._canvasInterval&&(z.clearTask(this._canvasInterval),this._canvasInterval=void 0,this._canvas=void 0,this.canvasTrack=void 0)}setPublishStarting(e){super.setPublishStarting(e),this.isNeedToResetVideoProfile(this.profile)&&this.setProfile(this.profile)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.isNeedToResetVideoProfile(this.profile)&&this.setProfile(this.profile)}setProfile(e){var o;if(!e)return;let i=e.bitrate&&e.bitrate!==this.profile.bitrate;return this.isNeedToResetVideoProfile(e)&&(this.log.warn("Resolution is reset to 1080p, need to upgrade ability here https://cloud.tencent.com/document/product/647/85386"),e.width=1920,e.height=1080),super.setProfile(e),(o=this.mediaTrack)==null?void 0:o.applyConstraints({width:e.width,height:e.height,frameRate:e.frameRate}).then(()=>{if(i&&this.room&&this.room.setBandWidth)return this.room.setBandWidth({bandwidth:e.bitrate,type:u.VIDEO,videoType:u.BIG})})}isNeedToResetVideoProfile(e){return!!(this.room&&this.room.scheduleResult&&!((this.room.scheduleResult.trtcAutoConf||{})["2k4k"]===1)&&!this.isScreen&&e.height*e.width>=2560*1440)}switchDevice(e){return _(this,null,function*(){try{if(!this.mediaStream||this.deviceId===e||this.facingMode===e)return;(e===u.FACING_MODE_USER||e===u.FACING_MODE_ENVIRONMENT)&&(this.facingMode=e,e=void 0),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),E.emit(p.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch camera success")}catch(i){throw this.log.error(`switch camera failed ${i}`),this.deviceId&&this.recapture(this.deviceId),i}})}listenDeviceChange(){te&&!te.listeners("audioInputRemoved").includes(this.handleCameraRemoved)&&te.on("videoInputRemoved",this.handleCameraRemoved,this)}handleCameraRemoved(e){return _(this,null,function*(){if(e.deviceId===this.deviceId){this.log.warn(`current camera is lost: ${JSON.stringify(e)}`);let i=yield ve();i[0]?this.recapture(i[0].deviceId):te.on("videoInputAdded",this.handleCameraAdded,this)}})}handleCameraAdded(e){return _(this,null,function*(){this.log.warn(`camera added: ${JSON.stringify(e)}`),this.recapture(e.deviceId)})}close(){te.off("videoInputAdded",this.handleCameraAdded,this),te.off("videoInputRemoved",this.handleCameraRemoved,this),this.destoryCanvasTrack(),super.close()}};var Ou=function(r){return _(this,null,function*(){let t=null,e=bu(r);g.info(`getDisplayMedia with constraints: ${JSON.stringify(e)}`);let i=yield navigator.mediaDevices.getDisplayMedia(e);if(r.systemAudio&&i.getAudioTracks().length===0&&(Ri&&Ci<74||ke||Y)&&g.warn("Your browser not support capture system audio"),r.frameRate&&i.getVideoTracks()[0]&&i.getVideoTracks()[0].applyConstraints({frameRate:{min:r.frameRate,ideal:r.frameRate},width:r.width,height:r.height}).catch(o=>{g.warn(`screen applyConstraints failed: ${o}`)}),r.audio){let o=yu(r);g.info(`getUserMedia with constraints: ${JSON.stringify(o)}`),t=yield navigator.mediaDevices.getUserMedia(o),i.addTrack(t.getAudioTracks()[0])}return i})};function yu(r){let t={echoCancellation:r.echoCancellation,autoGainControl:r.autoGainControl,noiseSuppression:r.noiseSuppression,sampleRate:r.sampleRate,channelCount:r.channelCount};return I(r.microphoneId)||(t.deviceId=r.microphoneId),{audio:t,video:!1}}function bu(r){let t={systemAudio:"include",selfBrowserSurface:"include",surfaceSwitching:"include"},e={width:ke?{max:r.width}:{ideal:r.width,max:r.width},height:ke?{max:r.height}:{ideal:r.height,max:r.height},frameRate:r.frameRate,displaySurface:"monitor"};if(t.video=e,r.systemAudio){let{echoCancellation:i=!0,noiseSuppression:o=!1,autoGainControl:s=!1}=r;t.audio={echoCancellation:i,noiseSuppression:o,autoGainControl:s,sampleRate:48e3}}return t}var wc=Ou;var Qe=class extends Be{constructor(){super();d(this,"profile",{width:1920,height:1080,frameRate:5,bitrate:1600});d(this,"objectFit","contain");d(this,"isScreen",!0);this._log.id=`s-${this._log.id}`}capture(){return _(this,arguments,function*({systemAudio:e=!1,autoGainControl:i,echoCancellation:o,noiseSuppression:s,audioTrack:n,videoTrack:a}={}){try{let c;return a||n?(c=new MediaStream,a&&c.addTrack(a),n&&c.addTrack(n)):c=yield wc({audio:!1,systemAudio:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,autoGainControl:i,echoCancellation:o,noiseSuppression:s}),this.setMediaStream(c),this.setMediaStreamTrack(c.getVideoTracks()[0]),c}catch(c){throw this.log.error(`getDisplayMedia error observed ${c}`),c instanceof A?c:new A({code:T.INITIALIZE_FAILED,name:c.name,message:c.message})}})}switchDevice(e){return _(this,null,function*(){throw new Error("Method not implemented.")})}};var ri=class extends Ae{constructor(){super(),this._log.id=`s-${this._log.id}`}setScreenAudioTrack(t,e){this.setMediaStream(e),this.setMediaStreamTrack(t)}};var Lr=class extends Ee{constructor(e){super(1,!1);d(this,"musicId");d(this,"mediaType",1);d(this,"volume",0);d(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40});d(this,"playerMuted",!1);d(this,"audio");d(this,"_audioContext");d(this,"_destination");d(this,"_source",null);this.initAudioContext(),this._destination=this._audioContext.createMediaStreamDestination(),this._destination.channelCount=1,this.audio=document.createElement("audio"),this.audio.src=e.url,this.audio.crossOrigin="anonymous",re(e.loop)&&this.loop(e.loop),J(e.volume)&&this.setVolume(e.volume),e.id&&(this.musicId=e.id),this._source=this._audioContext.createMediaElementSource(this.audio),this._source.connect(this._destination),this.setMediaStream(this._destination.stream),this.installPlayerEvent()}installPlayerEvent(){this.audio.addEventListener("error",this.handleAudioError.bind(this))}uninstallPlayerEvent(){this.audio.removeEventListener("error",this.handleAudioError.bind(this))}handleAudioError(e){this._log.warn(`local music ${this.musicId} audio error`,e)}initAudioContext(){this._audioContext=$i(),this._audioContext.state!=="running"&&this._log.warn(`local music ${this.musicId} context state: ${this._audioContext.state}`)}play(){return _(this,null,function*(){try{yield this.audio.play(),this._log.info(`music ${this.musicId} play success`)}catch(e){this._log.error(`music ${this.musicId} play error`,e)}})}destroy(){var e,i;(e=this._source)==null||e.disconnect(),(i=this._destination)==null||i.disconnect(),this.uninstallPlayerEvent(),this.player.stop(),this._audioContext.close().then(()=>{this._source=null,this._destination=null,this._audioContext=null})}getStream(){var e;return((e=this._destination)==null?void 0:e.stream)||null}seek(e){if(e<0&&e>this.duration()){this._log.warn("Time beyond song duration.");return}this.audio.currentTime=e}getPosition(){return this.audio.currentTime||0}setVolume(e){if(e>1&&e<0){this.log.warn("volume is out of range");return}this.audio.volume=e}getVolume(){return this.audio.volume||0}setPlayBackRate(e){if(e>8&&e<0){this.log.warn("rate is out of range");return}this.audio.playbackRate=e}getPlayBackRate(){return this.audio.playbackRate||0}duration(){return this.audio.duration||0}loop(e){return this.audio&&re(e)&&(this.audio.loop=e),this.audio.loop||!1}setOperation(e){e==="pause"&&this.audio.pause(),e==="resume"&&(this.audio.pause(),this.audio.play()),e==="stop"&&(this.audio.pause(),this.seek(0))}listenDeviceChange(){}};window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;var Vc=(()=>{let r;return()=>{if(r)return r;r=new window.AudioContext({sampleRate:48e3});let t=()=>{r.state==="suspended"?(r.resume(),document.removeEventListener("click",t)):r.state==="interrupted"?r.resume():document.removeEventListener("click",t)};return document.addEventListener("click",t),r.onstatechange=()=>{t()},r}})(),Lt="input",oi="output",Uc="ondump",xc="dumped";function Lu(r){let t;return vu(r)?t="intl-schedule.rtc.qq.com":t="schedule.rtc.qq.com",t}var vu=r=>(r=Number(r),r>0&&r<14e8);function Bc(o){return _(this,arguments,function*({sdkAppId:r,userId:t,userSig:e,timestamp:i}){let n=`https://${Lu(r)}/api/v1/audioAiAuth?sdkAppId=${r}&userId=${t}&userSig=${e}&timestamp=${i}`,a=yield fetch(n),{data:{errCode:c,errMsg:l,sign:h,status:m}}=yield a.json();if(m==="1")return{auth:!0,sign:h,status:m,message:l};let f="Init RTCAIDenoiser failed.",L="";switch(c){case 1:L="Please check your params.";break;case 2:L="You need to buy packages. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 3:L="Server is invalid. Please contact our engineer. ";break;case 4:L="Your packages is not active. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 5:L="Your packages is expired. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 6:L="Your version is not supported.";break}return{auth:!1,status:m,message:l?`${f} Reason: ${l}. ${L}`:`${f}, ${L}`}})}import Vu from"eventemitter3";function $c(r,t){t=t||{};let e=r.numberOfChannels,{sampleRate:i}=r,o=t.float32?3:1,s=o===3?32:16,n;return e===2?n=Mu(r.getChannelData(0),r.getChannelData(1)):n=r.getChannelData(0),Pu(n,o,i,e,s)}function Pu(r,t,e,i,o){let s=o/8,n=i*s,a=new ArrayBuffer(44+r.length*s),c=new DataView(a);return Ho(c,0,"RIFF"),c.setUint32(4,36+r.length*s,!0),Ho(c,8,"WAVE"),Ho(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,t,!0),c.setUint16(22,i,!0),c.setUint32(24,e,!0),c.setUint32(28,e*n,!0),c.setUint16(32,n,!0),c.setUint16(34,o,!0),Ho(c,36,"data"),c.setUint32(40,r.length*s,!0),t===1?wu(c,44,r):ku(c,44,r),a}function Mu(r,t){let e=r.length+t.length,i=new Float32Array(e),o=0,s=0;for(;o<e;)i[o++]=r[s],i[o++]=t[s],s++;return i}function ku(r,t,e){for(let i=0;i<e.length;i++,t+=4)r.setFloat32(t,e[i],!0)}function wu(r,t,e){for(let i=0;i<e.length;i++,t+=2){let o=Math.max(-1,Math.min(1,e[i]));r.setInt16(t,o<0?o*32768:o*32767,!0)}}function Ho(r,t,e){for(let i=0;i<e.length;i++)r.setUint8(t+i,e.charCodeAt(i))}var Tn=class{constructor(t){d(this,"audioContext_");d(this,"inputPCM_",new Float32Array);d(this,"outputPCM_",new Float32Array);this.audioContext_=t}onDump(t,e){if(e===Lt){let i=this.inputPCM_.length,o=new Float32Array(i+t[0].length);o.set(this.inputPCM_),o.set(t[0],i),this.inputPCM_=o}if(e===oi){let i=this.outputPCM_.length,o=new Float32Array(i+t[0].length);o.set(this.outputPCM_),o.set(t[0],i),this.outputPCM_=o}}getBlob(t){let e=t===Lt?this.inputPCM_:this.outputPCM_,i=this.audioContext_.createBuffer(2,e.length,48e3);i.copyToChannel(e,0,0),i.copyToChannel(e,1,0);let o=$c(i),s=new window.Blob([new DataView(o)],{type:"audio/wav"});return i=null,s}reset(){this.inputPCM_=new Float32Array,this.outputPCM_=new Float32Array}destroy(){this.reset()}},In=Tn;var Sn=class{constructor({sdkAppId:t,userId:e,audioContext:i,sign:o,status:s,worklet:n,timestamp:a,logger:c}){d(this,"audioContext_");d(this,"destination_");d(this,"gainNode_");d(this,"log_");d(this,"workletNode_");d(this,"isDumping_",!1);d(this,"dump_");d(this,"trackConstraint_",{});d(this,"audioTrack_");d(this,"source_");d(this,"denoiserTrack_");d(this,"enableDenoise_",!0);d(this,"emitter_",new Vu);this.audioContext_=i,this.destination_=this.audioContext_.createMediaStreamDestination(),this.gainNode_=this.audioContext_.createGain(),this.gainNode_.gain.value=1.1,this.log_=c,this.workletNode_=n,this.workletNode_.connect(this.gainNode_).connect(this.destination_),this.workletNode_.port.postMessage({type:"init",data:{sdkAppId:String(t),userId:e,timestamp:a,sign:o,status:s}}),this.workletNode_.port.onmessage=l=>{let{type:h,data:m}=l.data;if(h===Uc&&this.isDumping_){let{inputPCM:f,outputPCM:L}=m;this.dump_.onDump(f,Lt),this.dump_.onDump(L,oi)}h===xc&&this.dumped()},this.dump_=new In(this.audioContext_)}dumped(){this.isDumping_=!1;let t=this.dump_.getBlob(Lt),e=this.dump_.getBlob(oi);this.emitter_.emit("ondumpend",{blob:t,name:Lt}),this.emitter_.emit("ondumpend",{blob:e,name:oi}),this.dumpedWAV(t,Lt),this.dumpedWAV(e,oi),this.dump_.reset()}dumpedWAV(t,e){let i=window.URL.createObjectURL(t),o=document.createElement("a");o.href=i,o.download=`${e}-${Date.now()}.wav`,o.click(),window.URL.revokeObjectURL(i),o.href=""}process(t){return _(this,null,function*(){if(this.audioTrack_=t,!this.audioTrack_)throw new Error("RTCAIDenoiser: cannot process without audioTrack.");let e=new MediaStream;e.addTrack(this.audioTrack_),this.source_=this.audioContext_.createMediaStreamSource(e),yield this.source_.connect(this.workletNode_),this.trackConstraint_=this.audioTrack_.getConstraints(),this.trackConstraint_.noiseSuppression=!1,yield this.audioTrack_.applyConstraints(this.trackConstraint_);let i=this.destination_.stream;return this.denoiserTrack_=i.getAudioTracks()[0],this.log_.info(`RTCAIDenoiser: denoiser process track ID: ${t.id} success.`),this.denoiserTrack_})}updateTrack(t){return _(this,null,function*(){var o;let e=new MediaStream;yield e.addTrack(t);let i=this.audioContext_.createMediaStreamSource(e);this.source_.disconnect(),i.connect(this.workletNode_),(o=this.audioTrack_)==null||o.stop(),this.audioTrack_=t,this.source_=i,this.log_.info("RTCAIDenoiser: updateTrack success.")})}disable(){return _(this,null,function*(){var t,e;return this.enableDenoise_=!1,(t=this.workletNode_)==null||t.port.postMessage({type:"disable"}),this.trackConstraint_.noiseSuppression=!0,yield(e=this.audioTrack_)==null?void 0:e.applyConstraints(this.trackConstraint_),this.log_.info("RTCAIDenoiser: disable ai denoiser."),this.enableDenoise_})}enable(){return _(this,null,function*(){var t,e;return this.enableDenoise_=!0,(t=this.workletNode_)==null||t.port.postMessage({type:"enable"}),this.trackConstraint_.noiseSuppression=!1,yield(e=this.audioTrack_)==null?void 0:e.applyConstraints(this.trackConstraint_),this.log_.info("RTCAIDenoiser: enable ai denoiser."),this.enableDenoise_})}startDump(){return this.isDumping_?(this.log_.info("RTCAIDenoiser: data is currently being dumped."),!1):(this.workletNode_.port.postMessage({type:"startDump"}),this.dump_?this.dump_.reset():this.dump_=new In(this.audioContext_),this.isDumping_=!0,this.log_.info("RTCAIDenoiser: start dump data."),!0)}stopDump(){!this.isDumping_||(this.workletNode_.port.postMessage({type:"stopDump"}),this.isDumping_=!1,this.log_.info("RTCAIDenoiser: stop dump data."))}getAudioTrack(){return this.audioTrack_}getDenoiserTrack(){return this.destination_.stream.getAudioTracks()[0]}get enabled(){return this.enableDenoise_}destroy(){var t,e,i,o,s,n;this.log_.info("RTCAIDenoiser: destroy processor."),(t=this.audioTrack_)==null||t.stop(),(e=this.workletNode_)==null||e.port.postMessage({type:"destroy"}),this.workletNode_.port.onmessage=null,(i=this.source_)==null||i.disconnect(),(o=this.destination_)==null||o.disconnect(),(s=this.workletNode_)==null||s.disconnect(),(n=this.dump_)==null||n.destroy(),this.emitter_.removeAllListeners()}on(t,e,i){this.emitter_.on(t,e,i)}off(t,e,i){t==="*"?this.emitter_.removeAllListeners():this.emitter_.off(t,e,i)}},Hc=Sn;var gn=class{constructor({assetsPath:t,log:e}){this.isLoaded_=!1;this.audioContext_=Vc(),this.log_=e,this.assetsPath_=t}createProcessor(t){return _(this,null,function*(){let e=String(Date.now()).slice(0,-3),{auth:i,sign:o,status:s,message:n}=yield Bc(k(R({},t),{timestamp:e}));if(!i)throw this.log_.info(`RTCAIDenoiser: ${t.userId} auth result: ${i}. Message: ${n}`),new Error(n);try{yield this.load()}catch(l){throw new Error("Init wasm failed, please check your assetsPath.")}let a=yield this.initWorklet(),c=new Hc(k(R({},t),{audioContext:this.audioContext_,timestamp:e,sign:o,status:s,worklet:a,logger:this.log_}));return this.log_.info(`RTCAIDenoiser: ${t.userId} create denoiser processor success.`),c})}load(){return _(this,null,function*(){if(!this.isLoaded_)try{yield this.audioContext_.audioWorklet.addModule(`${this.assetsPath_}/denoiser-wasm.js`),this.isLoaded_=!0}catch(t){throw this.log_.error(`Init assets from ${this.assetsPath_} failed! Reason: ${t}`),t}})}initWorklet(){return _(this,null,function*(){try{return new AudioWorkletNode(this.audioContext_,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1})}catch(t){return yield this.load(),new AudioWorkletNode(this.audioContext_,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1})}})}destroy(){var t;(t=this.audioContext_)==null||t.close()}isSupported(){return"AudioWorklet"in window&&"WebAssembly"in window}},Fc=gn;var Fo=class{constructor({room:t}){d(this,"audioContext",null);d(this,"_destination",null);d(this,"_localAudioTrack",null);d(this,"_localScreenAudioTrack",null);d(this,"_localMediaStreamAudioTrack",null);d(this,"_audioTrackStreamSource",null);d(this,"_screenAudioTrackStreamSource",null);d(this,"_mixedMusicSet",new Set);d(this,"hasMusic",!1);d(this,"isDenoiserInit",!1);d(this,"isDenoiserEnabled",!1);d(this,"isDenoiserProcessed",!1);d(this,"mixedMusicMap",new Map);d(this,"cacheMusicMap",new Map);d(this,"_log");d(this,"originTrack",null);d(this,"denoiserTrack",null);d(this,"denoiser",null);d(this,"denoiserProcessor",null);d(this,"initProcessorOptions");this._log=g.createLogger({id:"am",userId:t.userId,sdkAppId:t.sdkAppId}),this.initAudioContext()}get hasScreenAudioTrack(){return this._localScreenAudioTrack!==null}get hasAudioTrack(){return this._localAudioTrack!==null}get isMixed(){return(this._localAudioTrack?1:0)+(this._localScreenAudioTrack?1:0)>=1}get mediaStreamTrack(){return this._destination.stream.getAudioTracks()[0]}addMusicSource(t){return _(this,null,function*(){this._log.info(`add music source, id: ${t.id} url: ${t.url}`),this.initAudioContext();let{id:e,url:i,loop:o,volume:s}=t;if(this.mixedMusicMap.has(e))return;let n;this.cacheMusicMap.has(e)?n=this.cacheMusicMap.get(e).localMusicTrack:n=new Lr(t);let{stream:a}=n._destination,c=document.createElement("audio");c.srcObject=a,n.play(),yield c.play(),this._log.info(`start mix audio ${e} success.`);let l=this.audioContext.createMediaStreamSource(a),h=this.audioContext.createGain();return l.connect(h),h.connect(this._destination),this._mixedMusicSet.add(e),this.mixedMusicMap.set(e,{localMusicTrack:n,streamSource:l,gainNode:h,audioPlayer:c}),this.cacheMusicMap.set(e,{localMusicTrack:n}),this.hasMusic=!0,n})}updateMusicSource(t){return _(this,null,function*(){let{id:e,volume:i,loop:o,operation:s,seekFrom:n}=t;if(this._log.info(`update music source, ${JSON.stringify(t)}`),this.mixedMusicMap.has(e)){let{localMusicTrack:a}=this.mixedMusicMap.get(e);I(i)||a.setVolume(i),I(o)||a.loop(o),I(s)||a.setOperation(s),I(n)||a.seek(n)}})}addAudioTrack(t){return _(this,null,function*(){var i;if(this._log.info(`start add audioTrack, userId: ${t.userId}`),this.initAudioContext(),!(t!=null&&t.mediaStream)||this._localMediaStreamAudioTrack===t.mediaTrack)return;let e=yield(i=t.mediaTrack)==null?void 0:i.getSettings();this._destination.channelCount=(e==null?void 0:e.channelCount)||1,this._localAudioTrack=t,this._localMediaStreamAudioTrack=t.mediaTrack,this.isDenoiserProcessed?this.denoiserProcessor.updateTrack(t.mediaTrack):(this._audioTrackStreamSource=this.audioContext.createMediaStreamSource(t.mediaStream),this._audioTrackStreamSource.connect(this._destination))})}removeAudioTrack(t){var e,i,o,s;this._localAudioTrack===t&&(this._log.info(`remove audioTrack, userId: ${t.userId}`),(e=this._audioTrackStreamSource)==null||e.disconnect(),this._audioTrackStreamSource=null,(i=this._localMediaStreamAudioTrack)==null||i.stop(),this._localMediaStreamAudioTrack=null,(o=this._localAudioTrack)==null||o.stop(),this._localAudioTrack=null,this.destroyDenoiserProcessor()),this._localScreenAudioTrack===t&&(this._log.info(`start remove screenTrack, userId: ${t.userId}`),(s=this._screenAudioTrackStreamSource)==null||s.disconnect(),this._localScreenAudioTrack.stop(),this._localScreenAudioTrack=null)}addScreenAudioTrack(t){this._log.info(`start add screenAudioTrack, userId: ${t.userId}`),this.initAudioContext(),!!(t!=null&&t.mediaStream)&&this._localScreenAudioTrack!==t&&(this._localScreenAudioTrack=t,this._screenAudioTrackStreamSource=this.audioContext.createMediaStreamSource(t.mediaStream),this._screenAudioTrackStreamSource.connect(this._destination))}removeAudioTrackSource(t){var e,i;this._log.info(`remove audio track source, type: ${t}`),t==="main"&&((e=this._audioTrackStreamSource)==null||e.disconnect(),this._audioTrackStreamSource=null,this._localAudioTrack=null),t==="screen"&&((i=this._screenAudioTrackStreamSource)==null||i.disconnect(),this._screenAudioTrackStreamSource=null,this._localScreenAudioTrack=null)}removeMusicSource({id:t}){if(this.mixedMusicMap.has(t)){this._log.info(`remove music source, music id: ${t}`);let{localMusicTrack:e,streamSource:i,gainNode:o,audioPlayer:s}=this.mixedMusicMap.get(t);i.disconnect(),o.disconnect(),s.pause(),s.srcObject=null,e.stop(),this.mixedMusicMap.delete(t),this._mixedMusicSet.delete(t),this._mixedMusicSet.size===0&&(this.hasMusic=!1)}t==="*"&&this.destroyAllMusic()}destroyAllMusic(){this._log.info("destroy all music source."),this._mixedMusicSet.forEach(t=>{this.removeMusicSource({id:t})})}destroyAllCache(){this._log.info("destroy all music cache."),this.cacheMusicMap.forEach(t=>{t.localMusicTrack.stop()})}initAudioContext(){this.audioContext||(this.audioContext=$i(),this.audioContext.state!=="running"&&this._log.warn(`context state: ${this.audioContext.state}`),this._destination=this.audioContext.createMediaStreamDestination(),this._destination.channelCount=1)}initDenoiser(t){return _(this,null,function*(){let{assetsPath:e,sdkAppId:i,userId:o,userSig:s}=t;try{this.denoiser||(this.denoiser=new Fc({assetsPath:e,log:this._log})),this.denoiserProcessor||(this.denoiserProcessor=yield this.denoiser.createProcessor({sdkAppId:i,userId:o,userSig:s})),this.isDenoiserInit=!0,this.initProcessorOptions=t}catch(n){throw n}})}enableDenoiser(t){return _(this,null,function*(){var e;if(this.isDenoiserEnabled=!0,!this.hasAudioTrack){this._log.warn("enableDenoiser failed, there is no audio");return}if(this.isDenoiserProcessed)this.denoiserProcessor.enable();else{if(this.originTrack=this._localAudioTrack.mediaTrack,!this.originTrack)return;(e=this._audioTrackStreamSource)==null||e.disconnect(),this.denoiserProcessor||(yield this.initDenoiser(this.initProcessorOptions)),this.denoiserTrack=yield this.denoiserProcessor.process(this.originTrack);let i=new MediaStream;i.addTrack(this.denoiserTrack),this._audioTrackStreamSource=this.audioContext.createMediaStreamSource(i),this._audioTrackStreamSource.connect(this._destination),this.isDenoiserProcessed=!0}})}disableDenoiser(){return _(this,null,function*(){this.isDenoiserEnabled&&(this.denoiserProcessor.disable(),this.isDenoiserEnabled=!1)})}destroyDenoiserProcessor(){var t;this.denoiserProcessor&&(this.denoiserProcessor.destroy(),this.denoiserProcessor=null,this.isDenoiserInit=!1,this.isDenoiserEnabled=!1,this.isDenoiserProcessed=!1,(t=this.denoiserTrack)==null||t.stop(),this.denoiserTrack=null,this.originTrack=null)}destroy(){var t;this.removeAudioTrackSource("main"),this.removeAudioTrackSource("aux"),this.audioContext.close(),this.destroyAllMusic(),this.destroyAllCache(),this.destroyDenoiserProcessor(),(t=this.denoiser)==null||t.destroy()}};import{ChangeState as Gc,FSM as Wc}from"afsm";var An=class extends ii{constructor(e,i,o){super({userId:i.userId,sdkAppId:e.sdkAppId,mediaType:o,room:e});this.room=e;this.user=i;d(this,"userId");d(this,"tinyId");d(this,"isRemote",!0);this.tinyId=i.tinyId,this.userId=i.userId}play(e,i){return this.hasFlag?super.play(e,i):(this.isPlayCalled=!0,this.container=e,e&&this.player.setContainer(e),Promise.resolve())}setMute(e){return this.hasFlag&&super.setMute(e)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.mediaTrack&&this.hasFlag&&this.isSubscribed&&this.player.setTrack(this.mediaTrack)}get isSubscribing(){return this.state.toString()==="subscribeing"}get isSubscribed(){return this.state===An.STATE_SUBSCRIBE}get streamType(){return(this.mediaType&2)===0?"main":"auxiliary"}subscribe(e){return e}unsubscribe(){this.player.setTrack(null),this.streamType==="main"&&this.kind==="video"&&this.room.changeType(!1,this.user)}onFlagChanged(){this.updatePlayingState(this.hasFlag),this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack)}},Se=An;d(Se,"STATE_SUBSCRIBE","subscribe"),N([Gc(Wc.INIT,Se.STATE_SUBSCRIBE,{success(){this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack),E.emit(p.REMOTE_TRACK_SUBSCRIBED,{track:this}),this.updatePlayingState(!0)},ignoreError:!0})],Se.prototype,"subscribe",1),N([Gc(Se.STATE_SUBSCRIBE,Wc.INIT,{success(){this.updatePlayingState(!1),E.emit(p.REMOTE_TRACK_UNSUBSCRIBED,{track:this})}})],Se.prototype,"unsubscribe",1);var Fi=class extends Se{constructor(e,i){super(e,i,1);d(this,"volume",0);d(this,"mediaType",1);d(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,end2EndDelay:0,jitterBufferDelay:0})}getAudioLevel(){return this.volume||super.getAudioLevel()}get hasFlag(){return this.user.muteState.hasAudio&&!this.user.muteState.audioMuted}isFlagChanged(e){let i=e.hasAudio&&!e.audioMuted;return this.hasFlag||(this.volume=0),this.hasFlag!==i}};var si=class extends Se{constructor(e,i,o=4){super(e,i,o);d(this,"mediaType",4);d(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,end2EndDelay:0,jitterBufferDelay:0})}changeType(e){this.room.changeType(e,this.user)}get hasFlag(){return this.user.muteState.hasVideo&&!this.user.muteState.videoMuted}isFlagChanged(e){let i=e.hasVideo&&!e.videoMuted;return this.hasFlag!==i}},Gi=class extends si{constructor(e,i){super(e,i,2);d(this,"mediaType",2);d(this,"objectFit","contain")}get hasFlag(){return this.user.muteState.hasAuxiliary}isFlagChanged(e){let i=e.hasAuxiliary;return this.hasFlag!==i}};function ne(...r){}var Uu=r=>r();function Cn(){this.dispose()}var xu=()=>typeof __FASTRX_DEVTOOLS__!="undefined",Bu=1,ut=class extends Function{toString(){return`${this.name}(${this.args.length?[...this.args].join(", "):""})`}subscribe(t){let e=new Rn(t,this,this.streamId++);return $e.subscribe({id:this.id,end:!1},{nodeId:e.sourceId,streamId:e.id}),this(e),e}},vr=class{constructor(){this.defers=new Set,this.disposed=!1}next(t){}complete(){this.dispose()}error(t){this.dispose()}get bindDispose(){return()=>this.dispose()}dispose(){this.disposed=!0,this.complete=ne,this.error=ne,this.next=ne,this.dispose=ne,this.subscribe=ne,this.doDefer()}subscribe(t){return t instanceof ut?t.subscribe(this):t(this),this}get bindSubscribe(){return t=>this.subscribe(t)}doDefer(){this.defers.forEach(Uu),this.defers.clear()}defer(t){this.defers.add(t)}removeDefer(t){this.defers.delete(t)}reset(){this.disposed=!1,delete this.complete,delete this.next,delete this.dispose,delete this.next,delete this.subscribe}resetNext(){delete this.next}resetComplete(){delete this.complete}resetError(){delete this.error}},v=class extends vr{constructor(t){super(),this.sink=t,t.defer(this.bindDispose)}next(t){this.sink.next(t)}complete(){this.sink.complete()}error(t){this.sink.error(t)}};function Kc(r,...t){return t.reduce((e,i)=>i(e),r)}function ht(r,t,e){if(xu()){let i=Object.defineProperties(Object.setPrototypeOf(r,ut.prototype),{streamId:{value:0,writable:!0,configurable:!0},name:{value:t,writable:!0,configurable:!0},args:{value:e,writable:!0,configurable:!0},id:{value:0,writable:!0,configurable:!0}});$e.create(i);for(let o=0;o<e.length;o++){let s=e[o];typeof s=="function"&&s instanceof ut&&$e.addSource(i,s)}return i}return r}function x(r,t){return function(...e){return i=>{if(i instanceof ut){let o=ht(s=>{let n=new r(s,...e);n.sourceId=o.id,n.subscribe(i)},t,arguments);return o.source=i,$e.pipe(o),o}else return o=>i(new r(o,...e))}}}function vt(r,t){window.postMessage({source:"fastrx-devtools-backend",payload:{event:r,payload:t}})}var Rn=class extends v{constructor(t,e,i){super(t),this.source=e,this.id=i,this.sourceId=t.sourceId,this.defer(()=>{$e.defer(this.source,this.id)})}next(t){$e.next(this.source,this.id,t),this.sink.next(t)}complete(){$e.complete(this.source,this.id),this.sink.complete()}error(t){$e.complete(this.source,this.id,t),this.sink.error(t)}},$e={addSource(r,t){vt("addSource",{id:r.id,name:r.toString(),source:{id:t.id,name:t.toString()}})},next(r,t,e){vt("next",{id:r.id,streamId:t,data:e&&e.toString()})},subscribe({id:r,end:t},e){vt("subscribe",{id:r,end:t,sink:{nodeId:e&&e.nodeId,streamId:e&&e.streamId}})},complete(r,t,e){vt("complete",{id:r.id,streamId:t,err:e?e.toString():null})},defer(r,t){vt("defer",{id:r.id,streamId:t})},pipe(r){vt("pipe",{name:r.toString(),id:r.id,source:{id:r.source.id,name:r.source.toString()}})},update(r){vt("update",{id:r.id,name:r.toString()})},create(r){r.id||(r.id=Bu++),vt("create",{name:r.toString(),id:r.id})}},Go=class extends Error{constructor(t){super(`timeout after ${t}ms`),this.timeout=t}};var Nn=class extends vr{constructor(t){super(),this.source=t,this.sinks=new Set}add(t){t.defer(()=>this.remove(t)),this.sinks.add(t).size===1&&(this.reset(),this.subscribe(this.source))}remove(t){this.sinks.delete(t),this.sinks.size===0&&this.dispose()}next(t){this.sinks.forEach(e=>e.next(t))}complete(){this.sinks.forEach(t=>t.complete()),this.sinks.clear()}error(t){this.sinks.forEach(e=>e.error(t)),this.sinks.clear()}};function Wo(){return r=>{let t=new Nn(r);if(r instanceof ut){let e=ht(i=>{t.add(i)},"share",arguments);return t.sourceId=e.id,e.source=r,$e.pipe(e),e}return ht(t.add.bind(t),"share",arguments)}}function $u(...r){return ht(t=>{let e=r.length,i=e,o=e,s=new Array(e),n=()=>{--o===0&&t.complete()},a=(c,l)=>{let h=new v(t);h.next=m=>{--i===0?(h.next=f=>{s[l]=f,t.next(s)},h.next(m)):s[l]=m},h.complete=n,h.subscribe(c)};r.forEach(a)},"combineLatest",arguments)}var Dn=class extends v{constructor(t,...e){super(t);let i=new v(this.sink);i.next=o=>this.buffer=o,i.complete=ne,i.subscribe($u(...e))}next(t){this.buffer&&this.sink.next([t,...this.buffer])}},_T=x(Dn,"withLatestFrom"),On=class extends v{constructor(t,e,i){super(t),this.bufferSize=e,this.startBufferEvery=i,this.buffer=[],this.count=0,this.startBufferEvery&&(this.buffers=[[]])}next(t){this.startBufferEvery?(this.count++===this.startBufferEvery&&(this.buffers.push([]),this.count=1),this.buffers.forEach(e=>{e.push(t)}),this.buffers[0].length===this.bufferSize&&this.sink.next(this.buffers.shift())):(this.buffer.push(t),this.buffer.length===this.bufferSize&&(this.sink.next(this.buffer),this.buffer=[]))}complete(){this.buffer.length?this.sink.next(this.buffer):this.buffers.length&&this.buffers.forEach(t=>this.sink.next(t)),super.complete()}},mT=x(On,"bufferCount"),yn=class extends v{constructor(t,e){super(t),this.buffer=[];let i=new v(t);i.next=o=>{t.next(this.buffer),this.buffer=[]},i.complete=ne,i.subscribe(e)}next(t){this.buffer.push(t)}complete(){this.buffer.length&&this.sink.next(this.buffer),super.complete()}},pT=x(yn,"buffer");function bn(r){let t=arguments,e=Wo()(ht(i=>{e.next=o=>i.next(o),e.complete=()=>i.complete(),e.error=o=>i.error(o),r&&i.subscribe(r)},"subject",t));return e.next=ne,e.complete=ne,e.error=ne,e}function jc(r){return ht(t=>{let e=0,i=setInterval(()=>t.next(e++),r);return t.defer(()=>{clearInterval(i)}),"interval"},"interval",arguments)}var Ln=class extends v{constructor(t,e,i){super(t),this.f=e;let o=()=>{this.sink.next(this.acc),this.sink.complete()};typeof i=="undefined"?this.next=s=>{this.acc=s,this.complete=o,this.resetNext()}:(this.acc=i,this.complete=o)}next(t){this.acc=this.f(this.acc,t)}},Hu=x(Ln,"reduce");var vn=class extends v{constructor(t,e,i){super(t),this.filter=e,this.thisArg=i}next(t){this.filter.call(this.thisArg,t)&&this.sink.next(t)}},Fu=x(vn,"filter"),Pn=class extends v{next(t){}},DT=x(Pn,"ignoreElements"),Mn=class extends v{constructor(t,e){super(t),this.count=e}next(t){this.sink.next(t),--this.count===0&&this.complete()}},Gu=x(Mn,"take"),kn=class extends v{constructor(t,e){super(t);let i=new v(t);i.next=()=>t.complete(),i.complete=Cn,i.subscribe(e)}},OT=x(kn,"takeUntil"),wn=class extends v{constructor(t,e){super(t),this.f=e}next(t){this.f(t)?this.sink.next(t):this.complete()}},Wu=x(wn,"takeWhile");var Vn=class extends v{constructor(t,e){super(t),this.count=e}next(t){--this.count===0&&(this.next=super.next)}},yT=x(Vn,"skip"),Un=class extends v{constructor(t,e){super(t),t.next=ne;let i=new v(t);i.next=()=>{i.dispose(),t.resetNext()},i.complete=Cn,i.subscribe(e)}},bT=x(Un,"skipUntil"),xn=class extends v{constructor(t,e){super(t),this.f=e}next(t){this.f(t)||(this.next=super.next,this.next(t))}},Ku=x(xn,"skipWhile"),ju={leading:!0,trailing:!1},Bn=class extends v{constructor(t,e,i){super(t),this.durationSelector=e,this.trailing=i}cacheValue(t){this.last=t,this.disposed&&this.throttle(t)}send(t){this.sink.next(t),this.throttle(t)}throttle(t){this.reset(),this.subscribe(this.durationSelector(t))}next(){this.complete()}complete(){this.dispose(),this.trailing&&this.send(this.last)}},$n=class extends v{constructor(t,e,i=ju){super(t),this.durationSelector=e,this.config=i,this._throttle=new Bn(this.sink,this.durationSelector,this.config.trailing),this._throttle.dispose()}next(t){this._throttle.disposed&&this.config.leading?this._throttle.send(t):this._throttle.cacheValue(t)}complete(){this._throttle.throttle=ne,this._throttle.complete(),super.complete()}},LT=x($n,"throttle");var Hn=class extends v{next(){this.complete()}complete(){this.dispose(),this.sink.next(this.last)}},Fn=class extends v{constructor(t,e){super(t),this.durationSelector=e,this._debounce=new Hn(this.sink),this._debounce.dispose()}next(t){this._debounce.dispose(),this._debounce.reset(),this._debounce.last=t,this._debounce.subscribe(this.durationSelector(t))}complete(){this._debounce.complete(),super.complete()}},vT=x(Fn,"debounce");var Gn=class extends v{constructor(t,e,i){super(t),this.count=e,this.defaultValue=i}next(t){this.count--===0&&(this.defaultValue=t,this.complete())}complete(){if(this.defaultValue===void 0){this.error(new Error("not enough elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},PT=x(Gn,"elementAt");var Wn=class extends v{constructor(t,e){super(t),this.f=e,this.i=0}next(t){this.f(t)?(this.sink.next(this.i++),this.complete()):++this.i}},MT=x(Wn,"findIndex"),Kn=class extends v{constructor(t,e,i){super(t),this.f=e,this.defaultValue=i,this.index=0}next(t){(!this.f||this.f(t,this.index++))&&(this.defaultValue=t,this.complete())}complete(){if(this.defaultValue===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},kT=x(Kn,"first"),jn=class extends v{constructor(t,e,i){super(t),this.f=e,this.defaultValue=i,this.index=0}next(t){(!this.f||this.f(t,this.index++))&&(this.defaultValue=t)}complete(){if(this.defaultValue===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},wT=x(jn,"last"),Jn=class extends v{constructor(t,e){super(t),this.predicate=e,this.index=0}next(t){this.predicate(t,this.index++)?this.result=!0:(this.result=!1,this.complete())}complete(){if(this.result===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.result);super.complete()}},VT=x(Jn,"every");var Yn=class extends v{constructor(t,e,i){super(t),this.f=e,typeof i=="undefined"?this.next=o=>{this.acc=o,this.resetNext(),this.sink.next(this.acc)}:this.acc=i}next(t){this.sink.next(this.acc=this.f(this.acc,t))}},$T=x(Yn,"scan"),Xn=class extends v{constructor(){super(...arguments),this.hasLast=!1}next(t){this.hasLast?this.sink.next([this.last,t]):this.hasLast=!0,this.last=t}},HT=x(Xn,"pairwise"),Qn=class extends v{constructor(t,e,i){super(t),this.mapper=e,this.thisArg=i}next(t){super.next(this.mapper.call(this.thisArg,t))}},Jc=x(Qn,"map");var Wi=class extends v{constructor(t,e,i){super(t),this.data=e,this.context=i}next(t){let e=this.context.combineResults;e?this.sink.next(e(this.data,t)):this.sink.next(t)}tryComplete(){this.context.resetComplete(),this.dispose()}},Ki=class extends v{constructor(t,e,i){super(t),this.makeSource=e,this.combineResults=i,this.index=0}subInner(t,e){let i=this.currentSink=new e(this.sink,t,this);this.complete=this.tryComplete,i.complete=i.tryComplete,i.subscribe(this.makeSource(t,this.index++))}tryComplete(){this.currentSink.resetComplete(),this.dispose()}},Ko=class extends Wi{},jo=class extends Ki{next(t){this.subInner(t,Ko),this.next=e=>{this.currentSink.dispose(),this.subInner(e,Ko)}}},Ju=x(jo,"switchMap");function Qo(r){return(t,e)=>r(()=>t,e)}var FT=Qo(x(jo,"switchMapTo")),qn=class extends Wi{tryComplete(){this.dispose(),this.context.sources.length?this.context.subNext():(this.context.resetNext(),this.context.resetComplete())}},Jo=class extends Ki{constructor(){super(...arguments),this.sources=[],this.next2=this.sources.push.bind(this.sources)}next(t){this.next2(t),this.subNext()}subNext(){this.next=this.next2,this.subInner(this.sources.shift(),qn),this.disposed&&this.sources.length===0&&this.currentSink.resetComplete()}tryComplete(){this.sources.length===0&&this.currentSink.resetComplete(),this.dispose()}},GT=x(Jo,"concatMap"),WT=Qo(x(Jo,"concatMapTo")),zn=class extends Wi{tryComplete(){this.context.inners.delete(this),super.dispose(),this.context.inners.size===0&&this.context.resetComplete()}},Yo=class extends Ki{constructor(){super(...arguments),this.inners=new Set}next(t){this.subInner(t,zn),this.inners.add(this.currentSink)}tryComplete(){this.inners.size===1?this.inners.forEach(t=>t.resetComplete()):this.dispose()}},KT=x(Yo,"mergeMap"),jT=Qo(x(Yo,"mergeMapTo")),Zn=class extends Wi{dispose(){this.context.resetNext(),super.dispose()}},Xo=class extends Ki{next(t){this.next=ne,this.subInner(t,Zn)}},JT=x(Xo,"exhaustMap"),YT=Qo(x(Xo,"exhaustMapTo")),ea=class extends v{constructor(t,e){super(t),this.f=e,this.groups=new Map}next(t){let e=this.f(t),i=this.groups.get(e);typeof i=="undefined"&&(i=bn(),i.key=e,this.groups.set(e,i),super.next(i)),i.next(t)}complete(){this.groups.forEach(t=>t.complete()),super.complete()}error(t){this.groups.forEach(e=>e.error(t)),super.error(t)}},XT=x(ea,"groupBy"),ta=class extends v{constructor(){super(...arguments),this.start=new Date}next(t){this.sink.next({value:t,interval:Number(new Date)-Number(this.start)}),this.start=new Date}},QT=x(ta,"timeInterval"),ia=class extends v{constructor(t,e){super(t),this.miniseconds=e,this.buffer=[],this.id=setInterval(()=>{this.sink.next(this.buffer.concat()),this.buffer.length=0},this.miniseconds)}next(t){this.buffer.push(t)}complete(){this.sink.next(this.buffer),super.complete()}dispose(){clearInterval(this.id),super.dispose()}},qT=x(ia,"bufferTime"),ra=class extends v{constructor(t,e){super(t),this.buffer=[],this.delayTime=e}dispose(){clearTimeout(this.timeoutId),super.dispose()}delay(t){this.timeoutId=setTimeout(()=>{let e=this.buffer.shift();if(e){let{time:i,data:o}=e;super.next(o),this.buffer.length&&this.delay(Number(this.buffer[0].time)-Number(i))}},t)}next(t){this.buffer.length||this.delay(this.delayTime),this.buffer.push({time:new Date,data:t})}complete(){this.timeoutId=setTimeout(()=>super.complete(),this.delayTime)}},zT=x(ra,"delay"),oa=class extends v{constructor(t,e){super(t),this.selector=e}error(t){this.dispose(),this.selector(t)(this.sink)}},ZT=x(oa,"catchError");var sa=class extends v{constructor(t,e){super(t),e instanceof Function?this.next=i=>{e(i),t.next(i)}:(e.next&&(this.next=i=>{e.next(i),t.next(i)}),e.complete&&(this.complete=()=>{e.complete(),t.complete()}),e.error&&(this.error=i=>{e.error(i),t.error(i)}))}},rI=x(sa,"tap"),na=class extends v{constructor(t,e){super(t),this.timeout=e,this.id=setTimeout(()=>this.error(new Go(this.timeout)),this.timeout)}next(t){super.next(t),clearTimeout(this.id),this.next=super.next}dispose(){clearTimeout(this.id),super.dispose()}},oI=x(na,"timeout");var gI=Kc(jc(250),Jc(()=>performance.now()),Wo());var ji=new Map;E.on(p.JOIN_SUCCESS,({room:r})=>{ce(r.userId,{eventId:32788,eventDesc:"join room"})});E.on(p.LEAVE_START,({room:r})=>{ce(r.userId,{eventId:32789,eventDesc:"leave room"})});E.on(p.LOCAL_TRACK_PUBLISHED,({track:r})=>{if(r.room){let t=32769;r.mediaType===4?t=32768:r.mediaType===2&&(t=32805),ce(r.room.userId,{eventId:t,eventDesc:`publish ${r.kind}`})}});E.on(p.LOCAL_TRACK_UNPUBLISHED,({track:r})=>{if(r.room){let t=32771;r.mediaType===4?t=32770:r.mediaType===2&&(t=32806),ce(r.room.userId,{eventId:t,eventDesc:`unpublish ${r.kind}`})}});E.on(p.TRACK_MUTED,({track:r})=>{r.room&&(r.kind===u.AUDIO?ce(r.room.userId,{eventId:r.isRemote?32785:32772,eventDesc:"mute audio",remoteUserId:r.isRemote?r.userId:void 0}):ce(r.room.userId,{eventId:r.isRemote?32784:32773,eventDesc:"mute video",remoteUserId:r.isRemote?r.userId:void 0}))});E.on(p.TRACK_UNMUTED,({track:r})=>{r.room&&(r.kind===u.AUDIO?ce(r.room.userId,{eventId:r.isRemote?32787:32774,eventDesc:"unmute audio",remoteUserId:r.isRemote?r.userId:void 0}):ce(r.room.userId,{eventId:r.isRemote?32786:32775,eventDesc:"unmute video",remoteUserId:r.isRemote?r.userId:void 0}))});E.on(p.REMOTE_TRACK_SUBSCRIBED,({track:r})=>{!r.room||(r.mediaType===1&&ce(r.room.userId,{eventId:32777,eventDesc:`${u.SUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===4&&ce(r.room.userId,{eventId:32776,eventDesc:`${u.SUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===8&&ce(r.room.userId,{eventId:32803,eventDesc:`${u.SUBSCRIBE} ${u.SMALL_VIDEO}`,remoteUserId:r.userId}))});E.on(p.REMOTE_TRACK_UNSUBSCRIBED,({track:r})=>{!r.room||(r.mediaType===1&&ce(r.room.userId,{eventId:32779,eventDesc:`${u.UNSUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===4&&ce(r.room.userId,{eventId:32778,eventDesc:`${u.UNSUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===8&&ce(r.room.userId,{eventId:32804,eventDesc:`${u.UNSUBSCRIBE} ${u.SMALL_VIDEO}`,remoteUserId:r.userId}))});E.on(p.SWITCH_DEVICE_SUCCESS,({track:r})=>{r.room&&ce(r.room.userId,{eventId:r.kind===u.VIDEO?32780:32781,eventDesc:`switch ${r.kind===u.VIDEO?"camera":"microphone"}`})});E.on(p.LOCAL_TRACK_REPLACED,({track:r})=>{r.room&&ce(r.room.userId,{eventId:r.kind===u.VIDEO?32782:32783,eventDesc:`replace ${r.kind}`})});E.on(p.SIGNAL_CONNECTION_STATE_CHANGED,({room:r,prevState:t,state:e})=>{let i,o;switch(e){case"CONNECTED":t==="RECONNECTING"?(i=32795,o="signal reconnected"):(i=32791,o="signal connected");break;case"DISCONNECTED":t==="RECONNECTING"?(i=32796,o="signal reconnect fail"):(i=32790,o="signal disconnected");break;case"RECONNECTING":i=32794,o="signal reconnecting";break}i&&o&&ce(r.userId,{eventId:i,eventDesc:o})});E.on(p.PEER_CONNECTION_STATE_CHANGED,({room:r,prevState:t,state:e,remoteUserId:i})=>{let o=!!i,s=o?"downlink":"uplink",n,a;switch(e){case"CONNECTED":t==="RECONNECTING"?(n=o?32801:32798,a=`${s} reconnected`):(n=o?32793:32792,a=`${s} connected`);break;case"DISCONNECTED":t==="RECONNECTING"&&(n=o?32802:32799,a=`${s} reconnect fail`);break;case"RECONNECTING":n=o?32800:32797,a=`${s} reconnecting`;break}n&&a&&ce(r.userId,{eventId:n,eventDesc:a,remoteUserId:i})});function ce(r,t){let e=k(R({},t),{timestamp:Zi()});ji.has(r)?ji.get(r).push(e):ji.set(r,[e])}function Yc(r){if(ji.has(r)){let t=ji.get(r).map(e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc}));return ji.delete(r),t}return[]}import{EventEmitter as Yu}from"eventemitter3";var qo=class extends Yu{constructor(e,i,o="userId"){super();this.mySelfId=e;this._log=i;this.key=o;d(this,"userMap",new Map);d(this,"remotePublishedUserMap",new Map)}getPublishedUser(e){return this.remotePublishedUserMap.get(e)}addUser(e){let i=e[this.key],{userId:o,tinyId:s,role:n}=e;if(this.userMap.has(i))return;let a={userId:o,tinyId:s,role:n===20?"anchor":"audience"};this.userMap.set(i,a),this.emit("1",a)}deleteUser(e,i){let o=this.userMap.get(e);if(!o)return;let s=`peer leave [${e}]`;I(i)||(s+=`:${$s[i]}`),this._log.info(s);let n=this.remotePublishedUserMap.get(e);if(n){let a=n.muteState;n.flag=0,this.emit("5",n.userId),this.deleteRemotePublishedUser(e),this.emit("6",{prevMuteState:a,muteState:n.muteState,flag:0})}this.userMap.delete(e),this.emit("2",o.userId)}setUserList(e){this.userMap.forEach(i=>{e.findIndex(o=>o[this.key]===i[this.key])<0&&this.deleteUser(i[this.key],0)}),e.forEach(i=>{!this.userMap.has(i[this.key])&&i[this.key]!==this.mySelfId&&this.addUser(i)})}addRemotePublishedUser(e){this.remotePublishedUserMap.has(e[this.key])||this.remotePublishedUserMap.set(e[this.key],e)}deleteRemotePublishedUser(e){!this.remotePublishedUserMap.has(e)||this.remotePublishedUserMap.delete(e)}setRemotePublishedUserList(e){this.remotePublishedUserMap.forEach(i=>{let o=i[this.key];if(e.findIndex(s=>s[this.key]===i[this.key])<0){this._log.info(`remote [${o}] unpublish`);let s=i.muteState;i.flag=0,this.emit("5",i.userId),this.deleteRemotePublishedUser(o),this.emit("6",{prevMuteState:s,muteState:i.muteState,flag:0})}}),e.forEach(i=>{var h;let o=i[this.key];if(o===this.mySelfId)return;let{flag:s,userId:n,tinyId:a}=i,c=Nt(s,n),l=(h=this.remotePublishedUserMap.get(o))==null?void 0:h.muteState;if(l){let m=this.remotePublishedUserMap.get(o);m&&m.flag!==s&&(m.flag=s,this._log.info(`remote publish updated: ${JSON.stringify(m.muteState)}`),this.emit("6",{prevMuteState:l,muteState:c,flag:s}))}else this._log.info(`remote publish. state: ${JSON.stringify(c)}`),this.addUser({userId:n,tinyId:a,role:20}),this.emit("3",i),this.emit("6",{prevMuteState:Nt(0,n),muteState:c,flag:s})})}clear(){this.userMap.clear(),this.remotePublishedUserMap.clear()}};function Xc({timesInSecond:r,maxSizeInSecond:t,getSize:e}){return H((i,o)=>{let s=new Map;return E.on(p.ROOM_DESTROY,({room:n})=>s.delete(n)),function(...n){let a=s.get(this);if(a||(a={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},s.set(this,a)),a.timestamp===0?a.timestamp=Date.now():Date.now()-a.timestamp>1e3&&(a.timestamp=Date.now(),a.callCountInSecond=0,a.totalSizeInSecond=0),e&&(a.totalSizeInSecond+=e(...n)),a.timestamp!==0&&Date.now()-a.timestamp<1e3&&(a.callCountInSecond>=r||a.totalSizeInSecond>t))throw new A({code:T.INVALID_OPERATION,message:y({key:C.CALL_FREQUENCY_LIMIT,data:{isTimes:a.callCountInSecond>=r,isSize:a.totalSizeInSecond>t,name:o,timesInSecond:r,maxSizeInSecond:t}})});a.callCountInSecond++,i.call(this,...n)}})}var Qc=!0,qc=function(){var r;Qc&&(Qc=!1,g.getLogLevel()!==5&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info(`*   API Document: ${ys}index.html`),console.info("*   Changelog: https://cloud.tencent.com/document/product/647/38958"),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),g.info("TRTC Web SDK Version:",_e),g.info("UA:",navigator.userAgent),g.info(`URL: ${location.href}${((r=self.frameElement)==null?void 0:r.tagName)==="IFRAME"?" in iframe":""}`))};var Pr={SCENE_LIVE:"live",SCENE_RTC:"rtc",ROLE_ANCHOR:"anchor",ROLE_AUDIENCE:"audience",STREAM_TYPE_MAIN:"main",STREAM_TYPE_SUB:"sub",AUDIO_PROFILE_STANDARD:"standard",AUDIO_PROFILE_STANDARD_STEREO:"standard-stereo",AUDIO_PROFILE_HIGH:"high",AUDIO_PROFILE_HIGH_STEREO:"high-stereo",QOS_PREFERENCE_SMOOTH:"smooth",QOS_PREFERENCE_CLEAR:"clear"};var $={INVALID_PARAMETER:5e3,INVALID_OPERATION:5100,ENV_NOT_SUPPORTED:5200,DEVICE_ERROR:5300,SERVER_ERROR:5400,OPERATION_FAILED:5500,OPERATION_ABORT:5998,UNKNOWN_ERROR:5999},Mt=(S=>(S[S.INVALID_PARAMETER=5e3]="INVALID_PARAMETER",S[S.INVALID_PARAMETER_REQUIRED=5001]="INVALID_PARAMETER_REQUIRED",S[S.INVALID_PARAMETER_TYPE=5002]="INVALID_PARAMETER_TYPE",S[S.INVALID_PARAMETER_EMPTY=5003]="INVALID_PARAMETER_EMPTY",S[S.INVALID_PARAMETER_INSTANCE=5004]="INVALID_PARAMETER_INSTANCE",S[S.INVALID_PARAMETER_RANGE=5005]="INVALID_PARAMETER_RANGE",S[S.INVALID_PARAMETER_LESS_THAN_ZERO=5006]="INVALID_PARAMETER_LESS_THAN_ZERO",S[S.INVALID_PARAMETER_MIN=5007]="INVALID_PARAMETER_MIN",S[S.INVALID_PARAMETER_MAX=5008]="INVALID_PARAMETER_MAX",S[S.INVALID_ELEMENT_ID=5009]="INVALID_ELEMENT_ID",S[S.INVALID_ELEMENT_ID_TYPE=5010]="INVALID_ELEMENT_ID_TYPE",S[S.INVALID_STREAM_ID=5011]="INVALID_STREAM_ID",S[S.INVALID_ROOM_ID_STRING=5012]="INVALID_ROOM_ID_STRING",S[S.INVALID_ROOM_ID_INTEGER=5013]="INVALID_ROOM_ID_INTEGER",S[S.INVALID_STREAM_TYPE=5014]="INVALID_STREAM_TYPE",S[S.INVALID_ROOM_ID_REQUIED=5015]="INVALID_ROOM_ID_REQUIED",S[S.INVALID_ROOM_ID_INTEGER_STRING=5016]="INVALID_ROOM_ID_INTEGER_STRING",S[S.INVALID_OPERATION=5100]="INVALID_OPERATION",S[S.INVALID_OPERATION_NOT_JOINED=5101]="INVALID_OPERATION_NOT_JOINED",S[S.INVALID_OPERATION_REMOTE_USER_NOT_EXIST=5102]="INVALID_OPERATION_REMOTE_USER_NOT_EXIST",S[S.INVALID_OPERATION_STREAM_TYPE_NOT_EXIST=5103]="INVALID_OPERATION_STREAM_TYPE_NOT_EXIST",S[S.INVALID_OPERATION_REPEAT_CALL=5104]="INVALID_OPERATION_REPEAT_CALL",S[S.ENV_NOT_SUPPORTED=5200]="ENV_NOT_SUPPORTED",S[S.NOT_SUPPORTED_HTTP=5201]="NOT_SUPPORTED_HTTP",S[S.NOT_SUPPORTED_WEBRTC=5202]="NOT_SUPPORTED_WEBRTC",S[S.NOT_SUPPORTED_H264_ENCODE=5203]="NOT_SUPPORTED_H264_ENCODE",S[S.NOT_SUPPORTED_H264_DECODE=5204]="NOT_SUPPORTED_H264_DECODE",S[S.NOT_SUPPORTED_SCREEN_SHARE=5205]="NOT_SUPPORTED_SCREEN_SHARE",S[S.NOT_SUPPORTED_SMALL_VIDEO=5206]="NOT_SUPPORTED_SMALL_VIDEO",S[S.NOT_SUPPORTED_SEI=5207]="NOT_SUPPORTED_SEI",S[S.DEVICE_ERROR=5300]="DEVICE_ERROR",S[S.DEVICE_NOT_FOUND_ERROR=5301]="DEVICE_NOT_FOUND_ERROR",S[S.DEVICE_NOT_ALLOWED_ERROR=5302]="DEVICE_NOT_ALLOWED_ERROR",S[S.DEVICE_NOT_READABLE_ERROR=5303]="DEVICE_NOT_READABLE_ERROR",S[S.DEVICE_OVERCONSTRAINED_ERROR=5304]="DEVICE_OVERCONSTRAINED_ERROR",S[S.DEVICE_INVALID_STATE_ERROR=5305]="DEVICE_INVALID_STATE_ERROR",S[S.DEVICE_SECURITY_ERROR=5306]="DEVICE_SECURITY_ERROR",S[S.DEVICE_ABORT_ERROR=5307]="DEVICE_ABORT_ERROR",S[S.CAMERA_RECOVER_FAILED=5308]="CAMERA_RECOVER_FAILED",S[S.MICROPHONE_RECOVER_FAILED=5309]="MICROPHONE_RECOVER_FAILED",S[S.SERVER_ERROR=5400]="SERVER_ERROR",S[S.ACCOUNT_NO_MONEY=-100013]="ACCOUNT_NO_MONEY",S[S.OPERATION_FAILED=5500]="OPERATION_FAILED",S[S.FIREWALL_RESTRICTION=5501]="FIREWALL_RESTRICTION",S[S.REJOIN_FAILED=5502]="REJOIN_FAILED",S[S.EVENT_HANDLER_ERROR=5503]="EVENT_HANDLER_ERROR",S[S.OPERATION_ABORT=5998]="OPERATION_ABORT",S[S.UNKNOWN_ERROR=5999]="UNKNOWN_ERROR",S))(Mt||{});function Zc({code:r,params:t,enableDocLink:e=!1}){let i="",o,s=Mt[r];try{o=zc[s]}catch(n){o=zc.UNKNOWN_ERROR}return K(o)?i=o(t):j(o)&&(i=o),e&&(i+=" doc:"),i}var zc={INVALID_PARAMETER({fnName:r}){return`the parameters of the '${r}' you called does not meet the requirements, please check the API documentation.`},INVALID_PARAMETER_REQUIRED({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' is a required param when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_TYPE({key:r,rule:t,fnName:e,value:i}){let o=`${r||t.name}`,s="";return Array.isArray(t.type)?s=t.type.join("|"):s=t.type,`'${o}' must be type of ${s} when calling ${e}(), received type: ${ee(i)}.`},INVALID_PARAMETER_EMPTY({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' cannot be '${i}' when calling ${e}().`},INVALID_PARAMETER_INSTANCE({key:r,rule:t,fnName:e,value:i}){let o=`${r||t.name}`,s=`${t.instanceOf.name||t.instanceOf}`;return`'${o}' must be instanceof ${s} when calling ${e}(), received type: ${ee(i)}.`},INVALID_PARAMETER_RANGE({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' must be one of ${t.values.join("|")} when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_LESS_THAN_ZERO({key:r,rule:t,fnName:e}){return`'${r||t.name}' cannot be less than 0 when calling ${e}().`},INVALID_PARAMETER_MIN({key:r,rule:t,value:e}){return`the min value of ${r||t.name} is ${t.min}, received: ${e}.`},INVALID_PARAMETER_MAX({key:r,rule:t,value:e}){return`the max value of ${r||t.name} is ${t.max}, received: ${e}.`},INVALID_ELEMENT_ID({key:r,fnName:t}){return`'${r}' is not found in the document object when calling ${t}().`},INVALID_ELEMENT_ID_TYPE({key:r,fnName:t,type:e}){return`the element corresponding to '${r}' must be instanceof HTMLElement when calling ${t}(), received: ${e}.`},INVALID_STREAM_ID({key:r}){return`'${r}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},INVALID_ROOM_ID_STRING({key:r}){return`'${r}' must be a valid string.`},INVALID_ROOM_ID_INTEGER({key:r}){return`'${r}' must be an integer between [1, 4294967294].`},INVALID_ROOM_ID_INTEGER_STRING({key:r}){return`'${r}' must be an integer but go a string, use 'parseInt' to convert it or use 'strRoomId' instead.`},INVALID_ROOM_ID_REQUIED(){return"at least one of 'roomId' and 'strRoomId' is required."},INVALID_STREAM_TYPE:({fnName:r})=>`'streamType' is required when 'userId' is not '*', calling ${r}()`,MIX_PARAMS_USER_Z_ORDER({key:r}){return`'${r}' is required and must be between 1 and 15.`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_OPERATION({fnName:r}){return`the API '${r}' you called does not meet the requirements, please check the API documentation.`},INVALID_OPERATION_NOT_JOINED({fnName:r}){return`cannot ${r} because you are not enter room yet.`},INVALID_OPERATION_REMOTE_USER_NOT_EXIST({fnName:r,value:t}){return`cannot ${r} because remote user(userId: ${t.userId}) does not publishing stream.`},INVALID_OPERATION_STREAM_TYPE_NOT_EXIST({fnName:r,value:t}){return`cannot ${r} because remote user(userId: ${t.userId}) does not publishing ${t.streamType} video.`},INVALID_OPERATION_REPEAT_CALL({fnName:r}){return`you are already ${r}(), cannot repeated call '${r}'.`},ENV_NOT_SUPPORTED({fnName:r}){return`the current browser does not support the capability of the function '${r}' you are calling, please check the API documentation.`},NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"the current browser does not support WebRTC capability, please check the SDK documentation.",NOT_SUPPORTED_H264_ENCODE:"this browser does not support H264 encode.",NOT_SUPPORTED_H264_DECODE:"this browser does not support H264 decode.",NOT_SUPPORTED_SCREEN_SHARE:"this browser does not support screen share, please check the browser version.",NOT_SUPPORTED_SMALL_VIDEO:"this browser does not support small video, please check the browser version.",NOT_SUPPORTED_SEI:"this browser does not support SEI, please check the browser version.",DEVICE_ERROR({fnName:r,error:t}){return`'${r}' got server exception${t?`, error: ${t.toString()}.`:"."}`},DEVICE_NOT_FOUND_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`NotFoundError, no ${t} detected, please check your device and the configuration on '${r}'${e?`, error: ${e.toString()}.`:"."}`},DEVICE_NOT_ALLOWED_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`NotAllowedError, you have disabled ${t} access, please allow the current application to use the ${t}${e?`, error: ${e.toString()}.`:"."}`},DEVICE_NOT_READABLE_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`NotReadableError, the ${t} maybe in use by another APP, please check if the device is pre-occupied by another APP.`},DEVICE_OVERCONSTRAINED_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`OverconstrainedError, the device ID is incorrect, please check whether the device ID passed in is correct${e?`, error: ${e.toString()}.`:"."}`},DEVICE_INVALID_STATE_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`InvalidStateError, after the user clicks and interacts with the page, turn on the ${t}${e?`, error: ${e.toString()}.`:"."}`},DEVICE_SECURITY_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`SecurityError, check whether the system security policy restricts the use of the ${t}, and it is recommended to turn on the ${t} after the user interacts with the page${e?`, error: ${e.toString()}.`:"."}`},DEVICE_ABORT_ERROR({fnName:r,deviceType:t=ni(r),error:e}){return`AbortError, an unknown exception in the system makes the device unusable, recommended to change the device or browser and re-check whether the device is normal${e?` error: ${e.toString()}.`:"."}`},CAMERA_RECOVER_FAILED({error:r}){return`camera recover capture failed ${(r==null?void 0:r.name)||""}: ${(r==null?void 0:r.originMessage)||(r==null?void 0:r.message)}`},MICROPHONE_RECOVER_FAILED({error:r}){return`microphone recover capture failed ${(r==null?void 0:r.name)||""}: ${(r==null?void 0:r.originMessage)||(r==null?void 0:r.message)}`},OPERATION_FAILED({fnName:r,error:t}){return`'${r}' failed, reason: ${t==null?void 0:t.toString()}`},FIREWALL_RESTRICTION(){return"media connection failure due to firewall restrictions, please try to change your network."},EVENT_HANDLER_ERROR({eventName:r}){return`an error was caught on trtc.on('${r}', handler), please check your code on 'handler'.`},SERVER_ERROR({fnName:r,error:t}){return`'${r}' got server error: ${t==null?void 0:t.toString()}, please check the SDK documentation.`},ACCOUNT_NO_MONEY:({fnParams:r})=>`your TRTC account run out of credit, please recharge.${r.sdkAppId?` SDKAppId: ${r.sdkAppId}`:""}`,OPERATION_ABORT({fnName:r}){return`'${r}' abort`},UNKNOWN_ERROR({fnName:r,error:t}){return`'${r}' throw unknown exception${t?`, error: ${t.toString()}.`:"."}`}};function ni(r){if(!r)return"camera";let t=r.toLowerCase();return t.includes("screen")?"screen share":t.includes("audio")?"microphone":"camera"}var Ji=class extends Error{constructor({code:e,extraCode:i,message:o="",messageParams:s,fnName:n="",originError:a}){let c;o?c=o:c=Zc({code:i||e,params:R({fnName:n,error:a},s)});super(c);d(this,"name","RtcError");d(this,"code");d(this,"extraCode");d(this,"functionName");d(this,"message");d(this,"originError");this.name=Mt[e],this.code=e,this.extraCode=i,this.functionName=n,this.originError=a,this.message=c}static convertFrom(e,i,o){let s=e;if(e instanceof A){let{stack:n}=e,a={code:$.UNKNOWN_ERROR,fnName:i,originError:e};switch(e.getCode()){case T.INVALID_PARAMETER:a.code=$.INVALID_PARAMETER;break;case T.INVALID_OPERATION:a.code=$.INVALID_OPERATION;break;case T.NOT_SUPPORTED:case T.NOT_SUPPORTED_H264:a.code=$.ENV_NOT_SUPPORTED,e.getCode()===T.NOT_SUPPORTED_H264&&(a.extraCode=e.message.includes(ue.NOT_SUPPORTED_H264ENCODE)?5203:5204);break;case T.DEVICE_NOT_FOUND:case T.DEVICE_AUTO_RECOVER_FAILED:a.code=$.DEVICE_ERROR;break;case T.JOIN_ROOM_FAILED:a.messageParams={fnParams:o};case T.SERVER_TIMEOUT:case T.SWITCH_ROLE_FAILED:a.code=$.SERVER_ERROR,a.extraCode=e.getExtraCode();break;case T.API_CALL_ABORTED:a.code=$.OPERATION_ABORT;break;case T.INITIALIZE_FAILED:a.code=5300,a.extraCode=Xu(e.name);break;case T.UNKNOWN:break;default:a.code=$.OPERATION_FAILED}s=new Ji(a),n&&(s.stack+=n.substr(n.indexOf(`
`)))}else s=new Ji({code:$.UNKNOWN_ERROR,fnName:i,originError:e});return s}};function Xu(r){let t;switch(r){case"NotFoundError":t=5301;break;case"NotAllowedError":t=5302;break;case"NotReadableError":t=5303;break;case"OverconstrainedError":t=5304;break;case"InvalidStateError":t=5305;break;case"SecurityError":t=5306;break;case"AbortError":t=5307;break;default:t=5300}return t}var M=Ji;var ed={type:"object",properties:{cameraId:{type:"string"},useFrontCamera:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"},small:{properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack}}},td={type:"object",properties:{systemAudio:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},profile:{type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack},audioTrack:{instanceOf:MediaStreamTrack}}},Yi={type:["string",HTMLElement,null,"array"],arrayItem:{instanceOf:HTMLElement},validate(r,t,e){if(j(r)){let i=document.getElementById(r);if(!i)throw new M({code:$.INVALID_PARAMETER,extraCode:5009,fnName:e,messageParams:{key:t}});if(!(i instanceof HTMLElement))throw new M({code:$.INVALID_PARAMETER,extraCode:5010,fnName:e,messageParams:{key:t,type:ee(i)}})}}},id={name:"userId",required:!0,type:"string"},rd={type:"object",properties:{microphoneId:{type:"string"},audioTrack:{instanceOf:MediaStreamTrack},captureVolume:{type:"number",min:0,max:100},earMonitorVolume:{type:"number",min:0,max:100},echoCancellation:{type:"boolean"},autoGainControl:{type:"boolean"},noiseSuppression:{type:"boolean"}}};function Qu(r,t,e,i){if(j(r))throw new M({code:$.INVALID_PARAMETER,extraCode:5016,fnName:e,messageParams:{key:t}});if(r===void 0)return;if(!(/^[1-9]\d*$/.test(String(r))&&r<4294967295))throw new M({code:$.INVALID_PARAMETER,extraCode:5013,fnName:e,messageParams:{key:t}})}function qu(r,t,e,i){if(!/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(r))throw new M({code:$.INVALID_PARAMETER,extraCode:5012,fnName:e,messageParams:{key:t}})}function Zo(r,t){if(!r)throw new M({code:$.INVALID_OPERATION,extraCode:5101,fnName:t})}function od(r,t,e){if(!r)throw new M({code:$.INVALID_OPERATION,extraCode:5102,fnName:t,messageParams:{value:e}})}var cg={type:"number",notLessThanZero:!0},zu={create:[{name:"RoomConfig",instanceOf:Function},{name:"CreateConfig",type:"object",properties:{plugins:{type:"array",arrayItem:{instanceOf:Function}}}}],enterRoom:{name:"EnterRoomConfig",type:"object",required:!0,validate(r,t,e){if(this._room.isJoined)throw new M({code:$.INVALID_OPERATION,extraCode:5104,fnName:e});if(!r.roomId&&!r.strRoomId)throw new M({code:$.INVALID_PARAMETER,extraCode:5015,fnName:e})},properties:{sdkAppId:{required:!0,type:"number",allowEmpty:!1},userId:{required:!0,type:"string",allowEmpty:!1},userSig:{required:!0,type:"string",allowEmpty:!1},scene:{type:"string",values:["live","rtc"]},role:{type:"string",values:["audience","anchor"]},roomId:{type:["string","number"],validate:Qu},strRoomId:{type:"string",validate:qu},proxy:{type:["object","string"],properties:{websocketProxy:{type:"string"},turnServer:{type:["object","array"],properties:{url:{required:!0,type:"string"},username:{type:"string"},credential:{type:"string"},credentialType:{type:"string",values:["password"]}}},loggerProxy:{type:"string"},webtransportProxy:{type:"string"}}},enableAutoPlayDialog:{type:"boolean"},userDefineRecordId:{type:"string"}}},startLocalVideo:{name:"LocalVideoConfig",type:"object",properties:{view:Yi,publish:{type:"boolean"},option:ed}},updateLocalVideo:{name:"updateLocalVideoConfig",type:"object",required:!0,properties:{view:k(R({},Yi),{required:!1}),publish:{type:"boolean"},mute:{type:"boolean"},option:ed}},startLocalAudio:{name:"LocalAudioConfig",type:"object",properties:{publish:{type:"boolean"},option:rd}},updateLocalAudio:{name:"updateLocalAudioConfig",type:"object",required:!0,properties:{publish:{type:"boolean"},mute:{type:"boolean"},option:rd}},startScreenShare:{name:"ScreenShareConfig",type:"object",properties:{view:Yi,publish:{type:"boolean"},option:td}},updateScreenShare:{name:"updateScreenShareConfig",type:"object",required:!0,properties:{view:Yi,publish:{type:"boolean"},option:td}},muteRemoteAudio:[id,{name:"mute",required:!0,type:"boolean"}],setRemoteAudioVolume:[id,{name:"volume",required:!0,type:"number",min:0,max:100}],startRemoteVideo:{name:"startRemoteVideoConfig",type:"object",required:!0,properties:{view:Yi,userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(r,t,e){Zo(this._room.isJoined,e);let i=this._room.remotePublishedUserMap.get(r.userId);if(od(!!i,e,r),i&&(r.streamType==="main"&&!i.muteState.videoAvailable||r.streamType==="sub"&&!i.muteState.hasAuxiliary))throw new M({code:$.INVALID_OPERATION,extraCode:5103,fnName:e,messageParams:{value:r}})}},updateRemoteVideo:{name:"updateRemoteVideoConfig",type:"object",required:!0,properties:{view:k(R({},Yi),{required:!1}),userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(r,t,e){Zo(this._room.isJoined,e);let i=this._room.remotePublishedUserMap.get(r.userId);if(od(!!i,e,r),i&&(r.streamType==="main"&&!i.muteState.videoAvailable||r.streamType==="sub"&&!i.muteState.hasAuxiliary))throw new M({code:$.INVALID_OPERATION,extraCode:5103,fnName:e,messageParams:{value:r}})}},stopRemoteVideo:{name:"stopRemoteVideoConfig",type:"object",required:!0,properties:{userId:{type:"string",required:!0},streamType:{values:["main","sub"]}},validate(r,t,e){if(r.userId!=="*"&&I(r.streamType))throw new M({code:$.INVALID_PARAMETER,extraCode:5014,fnName:e})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate(r,t,e){Zo(this._room.isJoined,e)}},enableAudioVolumeEvaluation:[{name:"interval",type:"number"},{name:"enableInBackground",type:"boolean"}],sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate(r,t,e,i){if(!bt)throw new M({code:$.ENV_NOT_SUPPORTED,fnName:e,extraCode:5207});if(!this._room.enableSEI)throw new M({code:$.INVALID_OPERATION,messageParams:{key:C.SEI_DISABLED}});if(r.byteLength>1e3)throw new M({code:$.INVALID_PARAMETER,messageParams:{key:C.SEI_OVERSIZE,data:r.byteLength}});if(r.byteLength===0)throw new M({code:$.INVALID_PARAMETER,messageParams:{key:C.SEI_EMPTY}});if(Zo(this._room.isJoined,e),!this._room.isMainStreamPublished)throw new M({code:$.INVALID_PARAMETER,messageParams:{key:C.SEI_BEFORE_PUBLISH}})}},{name:"options",type:"object",properties:{seiPayloadType:{type:"number",values:[5,243]}}}]},le={TRTC:zu};var he=class extends Error{};function Zu(r,t){let e=[];return je(e,r),je(e,t),e}function eh(r){this._resolve=Promise.resolve(r)}function th(r){this._reject=Promise.reject(r)}var Xi=class{constructor(t,e){this.instance=t;this.group=e;this.started=!1;this.ops=[];this.startSame=()=>!0;this.mergeUpdate=Zu;let i=Xi.instances.get(t);i?i.set(e,this):Xi.instances.set(t,new Map([[e,this]]))}static get(t,e){let i=Xi.instances.get(t);return i&&i.get(e)||new Xi(t,e)}action(t,e,i){let o=a=>{var c;return t===0?this.started=!0:t===3&&(this.started=!1),this.ops.shift(),(c=this.currentOp)==null||c.action(),a},s=a=>{var c,l;throw this.ops.shift(),t===0&&((c=this.currentOp)==null?void 0:c.type)===2&&this.ops.shift().reject(new he("start failed")),(l=this.currentOp)==null||l.action(),a},n={type:t,action:()=>e(...n.args).then(o,s),args:i,resolve:eh,reject:th};try{switch(this.state){case 1:if(t===0)throw new he("already started");break;case 4:if(t===2)throw new he("not started");break;default:return this.cacheOp(n)}}catch(a){return Promise.reject(a)}return this.ops.push(n),n.promise=e(...n.args).then(o,s)}cacheOp(t){if(this.ops.length===1)switch(this.state){case 0:case 2:if(t.type===0)throw new he("already start");break;case 3:switch(t.type){case 2:throw new he("update not allowed when stopping");case 3:return this.currentOp.promise}break;default:throw new he("unknown state")}else switch(t.type){case 3:switch(this.lastOpType){case 3:return this.lastOp.promise;default:let i=new he("keep stop");if(this.ops.slice(1).forEach(o=>o.reject(i)),this.ops=this.ops.slice(0,1),this.state===3)return this.currentOp.promise}break;case 2:switch(this.lastOpType){case 2:return this.lastOp.args=this.mergeUpdate(this.lastOp.args,t.args),this.lastOp.promise;case 3:throw new he("update not allowed after stop")}break;case 0:switch(this.lastOpType){case 2:throw new he("start not allowed after update");case 0:throw new he("duplicate start");case 3:if(this.startSame(this.currentOp.args,t.args))throw this.ops.pop().reject(new he("keep start")),new he("already start")}}t.promise=new Promise((i,o)=>{t._resolve?t._resolve.then(i):t.resolve=i,t._reject?t._reject.catch(o):t.reject=o});let{action:e}=t;return t.action=()=>e().then(t.resolve,t.reject),this.ops.push(t),t.promise}get lastOp(){return this.ops[this.ops.length-1]}get lastOpType(){return this.lastOp.type}get currentOp(){return this.ops[0]}get state(){return this.currentOp?this.currentOp.type:this.started?1:4}},_t=Xi;_t.instances=new WeakMap;var aa=(r,t)=>{if(t instanceof he){let{stack:e}=t;t=new M({code:$.OPERATION_ABORT,message:`${r} abort: ${t.message}`,fnName:r}),e&&(t.stack+=e.substr(e.indexOf(`
`)))}throw t};function kt(r,t){return H((e,i)=>function(...o){let s=_t.get(this,typeof r=="string"?r:r.call(this,...o));return t&&(s.startSame=t.bind(this)),s.action(0,e.bind(this),o).catch(aa.bind(null,i))})}function ai(r,t){return H((e,i)=>function(...o){let s=_t.get(this,typeof r=="string"?r:r.call(this,...o));return t&&(s.mergeUpdate=t.bind(this)),s.action(2,e.bind(this),o).catch(aa.bind(null,i))})}function wt(r){return H((t,e)=>function(...i){return _t.get(this,typeof r=="string"?r:r.call(this,...i)).action(3,t.bind(this),i).catch(aa.bind(null,e))})}var P={ERROR:"error",AUTOPLAY_FAILED:"autoplay-failed",KICKED_OUT:"kicked-out",REMOTE_USER_ENTER:"remote-user-enter",REMOTE_USER_EXIT:"remote-user-exit",REMOTE_AUDIO_AVAILABLE:"remote-audio-available",REMOTE_AUDIO_UNAVAILABLE:"remote-audio-unavailable",REMOTE_VIDEO_AVAILABLE:"remote-video-available",REMOTE_VIDEO_UNAVAILABLE:"remote-video-unavailable",AUDIO_VOLUME:"audio-volume",NETWORK_QUALITY:"network-quality",CONNECTION_STATE_CHANGED:"connection-state-changed",AUDIO_PLAY_STATE_CHANGED:"audio-play-state-changed",VIDEO_PLAY_STATE_CHANGED:"video-play-state-changed",SCREEN_SHARE_STOPPED:"screen-share-stopped",DEVICE_CHANGED:"device-changed",PUBLISH_STATE_CHANGED:"publish-state-changed",SEI_MESSAGE:"sei-message"};function ad(r){return r==="sub"?"auxiliary":r==="auxiliary"?"sub":"main"}function Mr(r){return r===Pr.QOS_PREFERENCE_CLEAR?"detail":r===Pr.QOS_PREFERENCE_SMOOTH?"motion":""}function es(r){return{room:r,innerEmitter:E,constants:Fs,environment:Gt,utils:me,eventLogger:Z,log:r.getLogger(),clearStarted(t,e){let i=t.getAlias(),o=_t.instances.get(r);if(!!o)if(e){let s=o.get(i+e);if(!s)return;s.started=!1}else o.forEach((s,n)=>{n.startsWith(i)&&(s.started=!1)})}}}var cd=(r,t)=>{let{emit:e}=r;return r.emit=(...i)=>{try{return e.apply(r,i)}catch(o){let s=y({key:C.CATCH_HANDLER_ERROR,data:{name:t,event:i[0]},addDocLink:!1});return g.warn(`${s}

${o.stack}`),!1}},r};var ts=new WeakMap;function dd(r,t){return H((e,i)=>function(...o){var a,c;let s=(a=ts.get(this))==null?void 0:a.get(t(...o));s&&s>0&&clearTimeout(s);let n=window.setTimeout(()=>{e.apply(this,o)},r);ts.has(this)?(c=ts.get(this))==null||c.set(t(...o),n):ts.set(this,new Map([[t(...o),n]]))})}var ld="5.1.0";function fe(...r){return H((t,e)=>function(...i){try{rs.call(this,r,i,e,this._name)}catch(o){return Promise.reject(o)}return t.apply(this,i)})}function ca(...r){return H((t,e)=>function(...i){try{rs.call(this,r,i,e,this._name)}catch(o){throw o}return t.apply(this,i)})}function rs(r,t,e,i){if(de(r))for(let o=0;o<r.length;o++)is.call(this,{rule:r[o],value:t[o],key:r[o].name,fnName:e,className:i});else is.call(this,{rule:r,value:t[0],key:r.name,fnName:e,className:i})}function is({rule:r,value:t,key:e,fnName:i,className:o}){function s(c){return{code:$.INVALID_PARAMETER,extraCode:c,fnName:i,messageParams:{key:e,rule:r,value:t}}}if(I(t)){if(r.required)throw new M(s(5001));if(I(r.defaultValue))return;t=r.defaultValue}if(Array.isArray(r.type)){let c=!1;for(let l=0;l<r.type.length;l++)r.type[l]===null&&t===null&&(c=!0),K(r.type[l])&&t instanceof r.type[l]&&(c=!0),j(r.type[l])&&ee(t)===r.type[l].toLowerCase()&&(c=!0);if(!c)throw new M({code:$.INVALID_PARAMETER,extraCode:5002,fnName:i,messageParams:{key:e,rule:{type:r.type.map(l=>Ar(l)?Oo(l):j(l)?l:ee(l))},value:t}})}else if(!I(r.type)&&ee(t)!==r.type)throw new M(s(5002));if(r.allowEmpty===!1){let c=J(t)&&(t===0||Number.isNaN(t)),l=j(t)&&t.trim()==="";if(c||l)throw new M(s(5003))}if(r.notLessThanZero&&J(t)&&t<0)throw new M(s(5006));if(!I(r.min)&&J(t)&&t<r.min)throw new M(s(5007));if(!I(r.max)&&J(t)&&t>r.max)throw new M(s(5008));if(j(r.instanceOf)){if(!t||t._name!==r.instanceOf)throw new M(s(5004))}else if(K(r.instanceOf)&&!(t instanceof r.instanceOf))throw new M(s(5004));if(Array.isArray(r.values)&&!r.values.includes(t))throw new M(s(5005));let{properties:n}=r;ot(n)&&qt(t)&&Object.keys(n).forEach(c=>{is.call(this,{rule:n[c],value:t&&t[c],key:`${c}`,fnName:i,className:o})});let{arrayItem:a}=r;ot(a)&&de(t)&&t.forEach((c,l)=>{is.call(this,{rule:a,value:c,key:`${e}[${l}]`,fnName:i,className:o})}),K(r.validate)&&r.validate.call(this,t,e,i,o,this)}function ae(){return H((r,t)=>function(...e){let i=this._log||loggerManager;e.length>0?i.info(`${t}() ${JSON.stringify(e,(o,s)=>{if(s===e||o in e)return s;try{return s instanceof HTMLElement?`id: ${s.id} type:${ee(s)}`:(JSON.stringify(s),s)}catch(n){return`type:${ee(s)}`}})}`):i.info(`${t}()`);try{let o=r.apply(this,e),s=w();return gr(o)?o.then(n=>(i.info(`${t}() success`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:t,cost:w()-s}),n)).catch(n=>{throw n=M.convertFrom.call(this,n,t,e.length===1?e[0]:e),i.error(`${t}() failed ${n}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:t,error:n}),n}):(E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:t,cost:w()-s}),o)}catch(o){throw o=M.convertFrom.call(this,o,t),i.error(`${t}() failed ${o}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:t,error:o}),o}})}var os=r=>H((t,e)=>function(i,o){return _(this,null,function*(){let s=this._plugins.get(i);if(!s){this._log.warn(`plugin ${i} is not found`);return}return rs.call(this,s.getValidateRule(r),[o],e,"TRTC"),t.call(this,s,o)})});var kr=class{constructor(t){this.core=t;this.core=t}getName(){return"AudioMixer"}getAlias(){return"ax"}getGroup(t){return t==null?void 0:t.id}getValidateRule(t){switch(t){case"start":return kr.startValidateRule;case"update":return kr.updateValidateRule;case"stop":return kr.stopValidateRule}}start(t){return _(this,null,function*(){let{room:e}=this.core;if(yield e.audioManager.addMusicSource(t),e.isJoined)for(let i of e.localTracks)i instanceof Ae&&(yield e.replaceTrack(i))})}update(t){return _(this,null,function*(){let{room:e}=this.core;yield e.audioManager.updateMusicSource(t)})}stop(t){return _(this,null,function*(){let{room:e}=this.core;yield e.audioManager.removeMusicSource(t)})}},ci=kr;d(ci,"startValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},url:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"}},validate(t,e,i){if(t.url!=="*"){let o=["mp3","ogg","wav","flac"],s=t.url.split(".").pop(),n=o.indexOf(s)>=0,a=t.url.startsWith("blob"),c=t.url.startsWith("data");if(!(n||a||c))throw new M({code:$.INVALID_PARAMETER,message:"start audioMixer plugin: music url is invalid, please check your file format.",fnName:i})}}}),d(ci,"updateValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"},seekFrom:{type:"number"},operation:{type:"string",values:["pause","resume","stop"]}}}),d(ci,"stopValidateRule",{name:"options",type:"object",required:!0,properties:{id:{type:"string",required:!0}}});var wr=class{constructor(t){this.core=t;this.core=t}getName(){return"AIDenoiser"}getAlias(){return"ad"}getGroup(t){return`AIDenoiser_${Date.now()}`}getValidateRule(t){switch(t){case"start":return wr.startValidateRule;case"update":return wr.updateValidateRule;case"stop":return wr.stopValidateRule}}start(t){return _(this,null,function*(){let{room:e}=this.core,{assetsPath:i,sdkAppId:o,userId:s,userSig:n}=t;if(i&&!e.audioManager.isDenoiserInit)try{yield e.audioManager.initDenoiser({assetsPath:i,sdkAppId:o,userId:s,userSig:n})}catch(a){if(a.message)throw new A({code:T.INVALID_PARAMETER,message:a.message})}if(yield e.audioManager.enableDenoiser(t),e.isJoined)for(let a of e.localTracks)a instanceof Ae&&(yield e.replaceTrack(a))})}update(t){return _(this,null,function*(){})}stop(t){return _(this,null,function*(){let{room:e}=this.core;yield e.audioManager.disableDenoiser()})}},di=wr;d(di,"startValidateRule",{name:"options",required:!0,type:"object",properties:{assetsPath:{type:"string",required:!0},sdkAppId:{type:"number",required:!0},userId:{type:"string",required:!0},userSig:{type:"string",required:!0}}}),d(di,"updateValidateRule",{type:"object"}),d(di,"stopValidateRule",{type:"object"});var oh=0,da=new Set,Re=null;Ns(ld);var Vr=class extends rh{constructor(e,i){super();d(this,"_room");d(this,"_eventListened",new Set);d(this,"_localVideoTrack",null);d(this,"_localAudioTrack",null);d(this,"_localScreenTrack",null);d(this,"_localScreenAudioTrack",null);d(this,"_localVideoConfig",null);d(this,"_localScreenConfig",null);d(this,"_localAudioConfig",null);d(this,"_remoteVideoConfigMap",new Map);d(this,"_remoteAudioConfigMap",new Map);d(this,"_remoteAudioMuteMap",new Map);d(this,"_log",g.createLogger({id:`t${++oh}`}));d(this,"_plugins",new Map);this._room=new e(R({logger:this._log,frameWorkType:Vr.frameWorkType},i)),i.plugins&&i.plugins.forEach(n=>{let a=new n(es(this._room));this._plugins.set(a.getName(),a)});let o=new ci(es(this._room));this._plugins.set(o.getName(),o);let s=new di(es(this._room));this._plugins.set(s.getName(),s),this._room.on("audio-volume",n=>{!n.find(a=>a.userId==="")&&this._localAudioTrack&&n.push({userId:"",volume:Math.floor(this._localAudioTrack.getAudioLevel()*100)}),this.emit(P.AUDIO_VOLUME,{result:n.sort((a,c)=>c.volume-a.volume)})}),this.on(P.REMOTE_AUDIO_UNAVAILABLE,({userId:n})=>{this._stopRemoteAudio({userId:n},!1).catch(()=>{})}),this.on(P.REMOTE_VIDEO_UNAVAILABLE,({userId:n,streamType:a})=>{this._stopRemoteVideo({userId:n,streamType:a},!1).catch(()=>{})}),Le(te,te).add("audioInputAdded",n=>{this.emit(P.DEVICE_CHANGED,{type:"microphone",action:"add",device:n})}).add("audioInputRemoved",n=>{this.emit(P.DEVICE_CHANGED,{type:"microphone",action:"remove",device:n})}).add("videoInputAdded",n=>{this.emit(P.DEVICE_CHANGED,{type:"camera",action:"add",device:n})}).add("videoInputRemoved",n=>{this.emit(P.DEVICE_CHANGED,{type:"camera",action:"remove",device:n})}).add("audioOutputAdded",n=>_(this,null,function*(){if(this.emit(P.DEVICE_CHANGED,{type:"speaker",action:"add",device:n}),Re&&Re.deviceId===Ir){let a=(yield Hi()).find(c=>c.deviceId===Ir);a&&Re.groupId!==a.groupId&&(Re=a,this.emit(P.DEVICE_CHANGED,{type:"speaker",action:"active",device:a}))}})).add("audioOutputRemoved",n=>_(this,null,function*(){this.emit(P.DEVICE_CHANGED,{type:"speaker",action:"remove",device:n});let a=(yield Hi())[0];a&&Re&&(Re.deviceId===n.deviceId||Re.deviceId===Ir&&Re.groupId!==a.groupId)&&(Re=a,this.emit(P.DEVICE_CHANGED,{type:"speaker",action:"active",device:a}))})),cd(this,"trtc")}static create(e){}static _create(e,i){qc();let o=new Vr(e,i||{});return da.add(o),Re?o.emit(P.DEVICE_CHANGED,{type:"speaker",action:"active",device:Re}):Hi().then(s=>{s[0]&&(Re=s[0],o.emit(P.DEVICE_CHANGED,{type:"speaker",action:"active",device:s[0]}))}),o}enterRoom(e){return _(this,null,function*(){var c,l;let{scene:i="rtc",enableAutoPlayDialog:o=!0,autoReceiveAudio:s=!0,autoReceiveVideo:n=!0}=e;e.proxy&&(this._room.setProxyServer(e.proxy),!j(e.proxy)&&e.proxy.turnServer&&((l=(c=this._room).setTurnServer)==null||l.call(c,e.proxy.turnServer,e.proxy.iceTransportPolicy))),this._room.enableAutoPlayDialog=o,this._room.autoReceiveAudio=s,this._room.autoReceiveVideo=n,re(e.enableHWEncoder)&&(this._room.enableHWEncoder=e.enableHWEncoder);let a={sdkAppId:e.sdkAppId,userId:e.userId,userSig:e.userSig,privateMapKey:e.privateMapKey||null,role:e.role==="audience"?21:20,roomId:e.roomId||0,strRoomId:e.strRoomId||"",businessInfo:e.businessInfo||null,streamId:null,userDefineRecordId:e.userDefineRecordId||null,frameWorkType:e.frameWorkType,component:e.component,language:e.language};e.strRoomId&&!e.roomId&&(this._room.useStringRoomId=!0),Le(this,this._room).add("peer-join",h=>{let{userId:m}=h;this.emit(P.REMOTE_USER_ENTER,{userId:m})}).add("peer-leave",h=>{this.emit(P.REMOTE_USER_EXIT,{userId:h})}).add("banned",h=>{this._exitRoom().then(()=>{this.emit(P.KICKED_OUT,{reason:h.reason})})}).add("error",h=>{this._exitRoom().then(()=>{this.emit(P.ERROR,M.convertFrom(h))})}).add("signal-connection-state-changed",h=>{this.emit(P.CONNECTION_STATE_CHANGED,h)}).add("network-quality",h=>{this.emit(P.NETWORK_QUALITY,h)}).add("remote-published",h=>{[h.remoteAudioTrack,h.remoteVideoTrack,h.remoteAuxiliaryTrack].forEach(f=>{Le(f,f).add("player-state-changed",L=>{let D=k(R({},L),{userId:h.userId});f.kind===u.VIDEO&&(D.streamType=ad(f.streamType)),this.emit(f.kind===u.AUDIO?P.AUDIO_PLAY_STATE_CHANGED:P.VIDEO_PLAY_STATE_CHANGED,D)}).add("error",L=>{L.getCode()===T.PLAY_NOT_ALLOWED&&this.emit(P.AUTOPLAY_FAILED)})})}).add("remote-unpublished",h=>{[h.remoteAudioTrack,h.remoteVideoTrack,h.remoteAuxiliaryTrack].forEach(f=>{pe(f)})}).add("remote-publish-state-changed",({prevMuteState:h,muteState:m})=>{let{userId:f}=m,L=this._room.remotePublishedUserMap.get(f),D=h.audioAvailable,Q=h.videoAvailable,{audioAvailable:Ie,videoAvailable:Et}=m;Ie||this._remoteAudioConfigMap.delete(f),Et||this._remoteVideoConfigMap.delete(`${f}_${"main"}`),m.hasAuxiliary||this._remoteVideoConfigMap.delete(`${f}_${"sub"}`),D!==Ie&&this.emit(Ie?P.REMOTE_AUDIO_AVAILABLE:P.REMOTE_AUDIO_UNAVAILABLE,{userId:f}),Q!==Et&&this.emit(Et?P.REMOTE_VIDEO_AVAILABLE:P.REMOTE_VIDEO_UNAVAILABLE,{userId:f,streamType:"main"}),h.hasAuxiliary!==m.hasAuxiliary&&this.emit(m.hasAuxiliary?P.REMOTE_VIDEO_AVAILABLE:P.REMOTE_VIDEO_UNAVAILABLE,{userId:f,streamType:"sub"})}).add("firewall-restriction",()=>{this.emit(P.ERROR,new M({code:$.OPERATION_FAILED,extraCode:5501}))}).add("sei-message",h=>{this.emit(P.SEI_MESSAGE,h)}),this._handleReceiveMode(),yield this._room.join(a,i,Vr.frameWorkType),this._checkTrackToPublish()})}exitRoom(){return _(this,null,function*(){return yield this._exitRoom()})}switchRole(e){return _(this,null,function*(){yield this._room.switchRole(e),e==="anchor"&&this._checkTrackToPublish()})}destroy(){pe(te),this.removeAllListeners(),this._room.destroy(),da.delete(this),this._localAudioTrack&&this.stopLocalAudio(),this._localVideoTrack&&this.stopLocalVideo(),this._localScreenTrack&&this.stopScreenShare()}startLocalAudio(){return _(this,arguments,function*(e={publish:!0}){if(this._localAudioTrack){this._log.warn("local audio is already started");return}let{publish:i=!0,option:o}=e,s=new Ae,n={},a={muted:!0};o&&(I(o.microphoneId)?I(o.audioTrack)||(n.customSource=o.audioTrack):n.deviceId=o.microphoneId,I(o.captureVolume),I(o.profile)||(j(o.profile)?To[o.profile]&&s.setProfile(To[o.profile]):s.setProfile(o.profile)),J(o.earMonitorVolume)&&(a.muted=!(o.earMonitorVolume>0),a.volume=o.earMonitorVolume),I(o.echoCancellation)||(s.profile.echoCancellation=o.echoCancellation),I(o.noiseSuppression)||(s.profile.noiseSuppression=o.noiseSuppression),I(o.autoGainControl)||(s.profile.autoGainControl=o.autoGainControl)),s.on("5",c=>{this.emit(P.ERROR,new M({code:$.DEVICE_ERROR,extraCode:5309,messageParams:{error:c}}))}),s.on("2",c=>{this.emit(P.DEVICE_CHANGED,{type:"microphone",action:"active",device:c})}),s.on("4",c=>{let l;c.error&&(l=M.convertFrom(c.error)),this.emit(P.PUBLISH_STATE_CHANGED,k(R({},c),{error:l}))}),yield s.capture(n),Le(s,s).add("player-state-changed",c=>{this.emit(P.AUDIO_PLAY_STATE_CHANGED,k(R({},c),{userId:""}))}),yield this._updateAudioPlayOption({playOption:a,track:s}),i&&this._room.isJoined&&this._room.publish(s).catch(()=>{}),this._localAudioTrack=s,this._localAudioConfig=k(R({},e),{publish:i})})}updateLocalAudio(e){return _(this,null,function*(){if(!this._localAudioTrack||!this._localAudioConfig)return;let{publish:i,mute:o,option:s}=e,n={};s&&(s.microphoneId?yield this._localAudioTrack.switchDevice(s.microphoneId):I(s.audioTrack)||(this._localAudioTrack.setMediaStreamTrack(s.audioTrack),yield this._room.replaceTrack(this._localAudioTrack)),I(s.captureVolume),I(s.earMonitorVolume)||(n.muted=!(s.earMonitorVolume>0),n.volume=s.earMonitorVolume)),yield this._updateAudioPlayOption({playOption:n,track:this._localAudioTrack,prevConfig:this._localAudioConfig}),this._room.isJoined&&!I(i)&&(i&&!this._localAudioConfig.publish&&this._room.publish(this._localAudioTrack).catch(()=>{}),this._localAudioConfig.publish&&!i&&this._room.unpublish(this._localAudioTrack).catch(()=>{})),I(o)||this._localAudioTrack.setMute(o),je(this._localAudioConfig,e)})}stopLocalAudio(){return _(this,null,function*(){!this._localAudioTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localAudioTrack).catch(()=>{})),this._localAudioTrack.stop(),this._localAudioTrack.close(),pe(this._localAudioTrack),this._localAudioTrack=null,this._localAudioConfig=null)})}startLocalVideo(){return _(this,arguments,function*(e={publish:!0,view:null}){if(this._localVideoTrack){this._log.warn("local video is already started");return}let{view:i,publish:o=!0,option:s}=e,n=new Be,a={},c={};if(s&&(s.cameraId?a.deviceId=s.cameraId:I(s.useFrontCamera)?I(s.videoTrack)||(a.customSource=s.videoTrack):a.facingMode=s.useFrontCamera?u.FACING_MODE_USER:u.FACING_MODE_ENVIRONMENT,I(s.profile)||(j(s.profile)?Jt[s.profile]&&n.setProfile(Jt[s.profile]):n.setProfile(s.profile)),I(s.fillMode)||(c.objectFit=s.fillMode),I(s.mirror)||(c.mirror=s.mirror),I(s.small)||(vo()?j(s.small)?n.small=Jt[s.small]:n.small=s.small:this._log.warn("small stream is not supported"))),n.on("5",l=>{this.emit(P.ERROR,new M({code:$.DEVICE_ERROR,extraCode:5308,messageParams:{error:l}}))}),n.on("2",l=>{this.emit(P.DEVICE_CHANGED,{type:"camera",action:"active",device:l})}),n.on("4",l=>{let h;l.error&&(h=M.convertFrom(l.error)),this.emit(P.PUBLISH_STATE_CHANGED,k(R({},l),{error:h}))}),yield n.capture(a),(s==null?void 0:s.qosPreference)&&n.mediaTrack){let l=Mr(s.qosPreference);n.mediaTrack.contentHint=l}Le(n,n).add("player-state-changed",l=>{this.emit(P.VIDEO_PLAY_STATE_CHANGED,k(R({},l),{userId:"",streamType:"main"}))}),yield this._updateVideoPlayOption({view:i,playOption:c,track:n}),o&&this._room.isJoined&&this._room.publish(n).catch(()=>{}),this._localVideoTrack=n,this._localVideoConfig=k(R({},e),{view:i,publish:o})})}updateLocalVideo(e){return _(this,null,function*(){if(!this._localVideoTrack||!this._localVideoConfig)return;let{view:i,publish:o,mute:s,option:n}=e,a={};if(n&&(n.cameraId?yield this._localVideoTrack.switchDevice(n.cameraId):I(n.useFrontCamera)?I(n.videoTrack)||(this._localVideoTrack.setMediaStreamTrack(n.videoTrack),yield this._room.replaceTrack(this._localVideoTrack)):yield this._localVideoTrack.switchDevice(n.useFrontCamera?u.FACING_MODE_USER:u.FACING_MODE_ENVIRONMENT),I(n.profile)||(j(n.profile)?Jt[n.profile]&&this._localVideoTrack.setProfile(Jt[n.profile]):this._localVideoTrack.setProfile(n.profile)),I(n.fillMode)||(a.objectFit=n.fillMode),I(n.mirror)||(a.mirror=n.mirror),n.qosPreference&&this._localVideoTrack.mediaTrack)){let c=Mr(n.qosPreference);this._localVideoTrack.mediaTrack.contentHint=c}yield this._updateVideoPlayOption({view:i,playOption:a,track:this._localVideoTrack,prevConfig:this._localVideoConfig}),this._room.isJoined&&!I(o)&&(o&&!this._localVideoConfig.publish&&this._room.publish(this._localVideoTrack).catch(()=>{}),this._localVideoConfig.publish&&!o&&this._room.unpublish(this._localVideoTrack).catch(()=>{})),I(s)||this._localVideoTrack.setMute(s),je(this._localVideoConfig,e)})}stopLocalVideo(){return _(this,null,function*(){!this._localVideoTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localVideoTrack).catch(()=>{})),this._localVideoTrack.stop(),this._localVideoTrack.close(),pe(this._localVideoTrack),this._localVideoTrack=null,this._localVideoConfig=null)})}startScreenShare(){return _(this,arguments,function*(e={publish:!0,view:null}){if(this._localScreenTrack){this._log.warn("screen share is already started");return}let{view:i=null,publish:o=!0,option:s}=e,n=new Qe;n.on("4",m=>{let f;m.error&&(f=M.convertFrom(m.error)),this.emit(P.PUBLISH_STATE_CHANGED,k(R({},m),{error:f}))});let a=null;n.setMediaType(2);let c={},l={};s&&(I(s.profile)||(j(s.profile)?Io[s.profile]&&n.setProfile(Io[s.profile]):n.setProfile(s.profile)),s.systemAudio&&(c.systemAudio=!0,c.echoCancellation=s.echoCancellation,c.noiseSuppression=s.noiseSuppression,c.autoGainControl=s.autoGainControl),I(s.fillMode)||(l.objectFit=s.fillMode),s.videoTrack&&(c.videoTrack=s.videoTrack),s.audioTrack&&(c.audioTrack=s.audioTrack));let h=yield n.capture(c);if(s!=null&&s.qosPreference){let m=Mr(s.qosPreference);n.mediaTrack.contentHint=m}if(n.mediaTrack.addEventListener(u.ENDED,()=>{this._stopScreenShare(),this.emit(P.SCREEN_SHARE_STOPPED)}),h.getAudioTracks()[0]&&(a=new ri,a.setScreenAudioTrack(h.getAudioTracks()[0],h)),Le(n,n).add("player-state-changed",m=>{this.emit(P.VIDEO_PLAY_STATE_CHANGED,k(R({},m),{userId:"",streamType:"sub"}))}),yield this._updateVideoPlayOption({view:i,playOption:l,track:n}),o&&this._room.isJoined){let m=[n];a&&m.push(a),this._room.publish(...m).catch(()=>{})}this._localScreenTrack=n,this._localScreenAudioTrack=a,this._localScreenConfig=k(R({},e),{view:i,publish:o})})}updateScreenShare(e){return _(this,null,function*(){if(!this._localScreenTrack||!this._localScreenConfig)return;let{view:i,publish:o,option:s}=e,n={};if(s&&(I(s.fillMode)||(n.objectFit=s.fillMode),s.qosPreference)){let a=Mr(s.qosPreference);this._localScreenTrack.mediaTrack.contentHint=a}yield this._updateVideoPlayOption({view:i,playOption:n,track:this._localScreenTrack,prevConfig:this._localScreenConfig}),this._room.isJoined&&!I(o)&&(o&&!this._localScreenConfig.publish&&this._room.publish(this._localScreenTrack).catch(()=>{}),this._localScreenConfig.publish&&!o&&this._room.unpublish(this._localScreenTrack).catch(()=>{})),je(this._localScreenConfig,e)})}stopScreenShare(){return _(this,null,function*(){return yield this._stopScreenShare()})}startRemoteVideo(e){return _(this,null,function*(){let{view:i,userId:o,streamType:s,option:n}=e,a=`${o}_${s}`;if(this._remoteVideoConfigMap.has(a)){this._log.warn(`remote video has already started. userId:${o}, streamType:${s}`);return}let c=this._room.remotePublishedUserMap.get(o);if(!c)return;let l={},h=s==="main"?c.remoteVideoTrack:c.remoteAuxiliaryTrack;n&&(I(n.fillMode)||(l.objectFit=n.fillMode),I(n.mirror)||(l.mirror=n.mirror),s==="main"&&!I(n.small)&&this._room.changeType(n.small,h.user)),yield this._room.subscribe(h),yield this._updateVideoPlayOption({view:i,playOption:l,track:h}),this._remoteVideoConfigMap.set(a,e)})}updateRemoteVideo(e){return _(this,null,function*(){let{view:i,userId:o,streamType:s,option:n}=e,a=`${o}_${s}`;if(!this._remoteVideoConfigMap.has(a)||!this._room.remotePublishedUserMap.has(o))return;let c={};n&&(I(n.fillMode)||(c.objectFit=n.fillMode),I(n.mirror)||(c.mirror=n.mirror));let l=null,h=this._room.remotePublishedUserMap.get(o);s==="main"&&(h==null?void 0:h.muteState.hasVideo)&&(l=h.remoteVideoTrack),s==="sub"&&(h==null?void 0:h.muteState.hasAuxiliary)&&(l=h.remoteAuxiliaryTrack);let m=this._remoteVideoConfigMap.get(a);l&&(s==="main"&&n&&!I(n.small)&&this._room.changeType(n.small,l.user),yield this._updateVideoPlayOption({view:i,playOption:c,track:l,prevConfig:m})),je(m,e)})}stopRemoteVideo(e){return _(this,null,function*(){return this._stopRemoteVideo(e)})}_stopRemoteVideo(e,i=!0){return _(this,null,function*(){let o=[],s=this._room.remotePublishedUserMap.get(e.userId);if(s){let{muteState:n,remoteVideoTrack:a,remoteAuxiliaryTrack:c}=s;e.streamType==="main"&&(a.stop(),n.hasVideo&&o.push(a)),e.streamType==="sub"&&(c.stop(),n.hasAuxiliary&&o.push(c))}for(let n of o)i&&(yield this._room.unsubscribe(n));this._remoteVideoConfigMap.delete(`${e.userId}_${e.streamType}`)})}muteRemoteAudio(e,i){return _(this,null,function*(){if(e==="*")if(i)yield this._stopRemoteAudio({userId:e});else{let o=[...this._room.remotePublishedUserMap.values()];for(let s of o)s.muteState.hasAudio&&(yield this._startRemoteAudio({userId:s.userId}))}else i?yield this._stopRemoteAudio({userId:e}):yield this._startRemoteAudio({userId:e});this._remoteAudioMuteMap.set(e,i)})}setRemoteAudioVolume(e,i){if(e==="*"){let o=[...this._room.remotePublishedUserMap.values()];for(let s of o)this._updateAudioPlayOption({playOption:{volume:i},track:s.remoteAudioTrack})}else if(e){let o=this._room.remotePublishedUserMap.get(e);o&&this._updateAudioPlayOption({playOption:{volume:i},track:o.remoteAudioTrack})}}startPlugin(e,i){return _(this,null,function*(){return e.start(i)})}updatePlugin(e,i){return _(this,null,function*(){return e.update(i)})}stopPlugin(e,i){return _(this,null,function*(){return e.stop(i)})}enableAudioVolumeEvaluation(e=2e3,i=!1){this._room.enableAudioVolumeEvaluation(e,i)}on(e,i,o){return super.on(e,i,o),this._eventListened.add(e),this}off(e,i,o){return e==="*"?(this._eventListened.clear(),this.removeAllListeners()):super.off(e,i,o),this}getVideoTrack(e={userId:"",streamType:"main"}){let{userId:i="",streamType:o="main"}=e;if(i===""){if(o==="main"&&this._localVideoTrack)return this._localVideoTrack.mediaTrack;if(o==="sub"&&this._localScreenTrack)return this._localScreenTrack.mediaTrack}else{let s=this._room.remotePublishedUserMap.get(i);if(s)return o==="main"?s.remoteVideoTrack.mediaTrack:s.remoteAuxiliaryTrack.mediaTrack}return null}getAudioTrack(e){if(e){let i=this._room.remotePublishedUserMap.get(e);if(i)return i.remoteAudioTrack.mediaTrack}else if(this._localAudioTrack)return this._localAudioTrack.mediaTrack;return null}setCurrentSpeaker(e){var i;(i=this._localAudioTrack)==null||i.setAudioOutput(e),this._room.remotePublishedUserMap.forEach(o=>o.remoteAudioTrack.setAudioOutput(e))}_startRemoteAudio(e){return _(this,null,function*(){let{userId:i,option:o}=e;if(this._remoteAudioConfigMap.has(i)){this._log.warn(`remote audio has already started. userId:${i}`);return}let s=this._room.remotePublishedUserMap.get(i);if(!s)return;let n={};o&&(I(o.volume)||(n.volume=o.volume));let a=s.remoteAudioTrack;yield this._room.subscribe(a),yield this._updateAudioPlayOption({playOption:n,track:a}),this._remoteAudioConfigMap.set(i,e)})}_stopRemoteAudio(e,i=!0){return _(this,null,function*(){let o=this._room.remotePublishedUserMap.get(e.userId);o&&(o.remoteAudioTrack.stop(),o.muteState.hasAudio&&i&&(yield this._room.unsubscribe(o.remoteAudioTrack))),this._remoteAudioConfigMap.delete(`${e.userId}`)})}_updateVideoPlayOption(n){return _(this,arguments,function*({view:e,playOption:i,track:o,prevConfig:s}){if(I(e)&&s&&s.view&&!Rr(i)){let a;de(s.view)?a=s.view:a=yo(s.view),a&&(yield o.play(a,i))}if(!I(e)){let a;de(e)?a=e:a=yo(e),a?yield o.play(a,i):o.stop()}})}_updateAudioPlayOption(s){return _(this,arguments,function*({playOption:e={},track:i,prevConfig:o}){i.isPlayCalled||(yield i.play(null,e)),I(e.muted)||i.setPlayerMute(e.muted),I(e.volume)||i.setAudioVolume(e.volume/100)})}_checkTrackToPublish(){var i,o,s;let e=[];if(((i=this._localAudioConfig)==null?void 0:i.publish)&&this._localAudioTrack&&e.push(this._localAudioTrack),((o=this._localVideoConfig)==null?void 0:o.publish)&&this._localVideoTrack&&e.push(this._localVideoTrack),(s=this._localScreenConfig)!=null&&s.publish&&(this._localScreenTrack&&e.push(this._localScreenTrack),this._localScreenAudioTrack&&e.push(this._localScreenAudioTrack)),e.length!==0)return this._room.publish(...e).catch(()=>{})}_handleReceiveMode(){this._room.autoReceiveAudio&&Le(this,this).add(P.REMOTE_AUDIO_AVAILABLE,i=>_(this,[i],function*({userId:e}){if(this._remoteAudioMuteMap.get("*")||this._remoteAudioMuteMap.get(e))return;let o=this._room.remotePublishedUserMap.get(e);o&&(yield this._room.subscribe(o.remoteAudioTrack).catch(()=>{}),yield this._updateAudioPlayOption({track:o.remoteAudioTrack}).catch(()=>{}),this._remoteAudioConfigMap.set(e,{userId:e}))})),this._room.autoReceiveVideo&&Le(this,this).add(P.REMOTE_VIDEO_AVAILABLE,({userId:e,streamType:i})=>{let o=this._room.remotePublishedUserMap.get(e);o&&(i==="main"?this._room.subscribe(o.remoteVideoTrack).catch(()=>{}):i==="sub"&&this._room.subscribe(o.remoteAuxiliaryTrack).catch(()=>{}))})}_exitRoom(){return _(this,null,function*(){this._room.isJoined&&(yield this._room.leave()),[...this._remoteAudioConfigMap.keys()].forEach(e=>{this._stopRemoteAudio({userId:e}).catch()}),[...this._remoteVideoConfigMap.keys()].forEach(e=>{let i=e.includes("main")?"main":"sub",o=e.split(`_${i}`)[0];o&&this._stopRemoteVideo({userId:o,streamType:i}).catch()}),this._remoteVideoConfigMap.clear(),this._remoteAudioConfigMap.clear(),this._remoteAudioMuteMap.clear(),this._room.remotePublishedUserMap.forEach(e=>{pe(e.remoteAudioTrack),pe(e.remoteVideoTrack),pe(e.remoteAuxiliaryTrack)}),pe(this)})}_stopScreenShare(){return _(this,null,function*(){var e,i,o;if(!!this._localScreenTrack){if(this._room.isJoined){let s=[this._localScreenTrack];this._localScreenAudioTrack&&s.push(this._localScreenAudioTrack),yield(e=this._room)==null?void 0:e.unpublish(...s).catch(()=>{})}this._localScreenTrack.stop(),this._localScreenTrack.close(),(i=this._localScreenAudioTrack)==null||i.stop(),(o=this._localScreenAudioTrack)==null||o.close(),pe(this._localScreenTrack),this._localScreenTrack=null,this._localScreenAudioTrack=null,this._localScreenConfig=null}})}sendSEIMessage(e,i){this._room.sendSEI(e,i||{seiPayloadType:243})}static setLogLevel(e,i){g.setLogLevel(e),I(i)||(i?g.enableUploadLog():g.disableUploadLog())}static isSupported(){return zs()}static getCameraList(){return ve()}static getMicrophoneList(){return ge()}static getSpeakerList(){return Hi()}static setCurrentSpeaker(e){return _(this,null,function*(){(yield Hi()).forEach(o=>{o.deviceId===e&&(da.forEach(s=>{s.setCurrentSpeaker(e),s.emit(P.DEVICE_CHANGED,{type:"speaker",action:"active",device:o})}),Re=o)})})}},F=Vr;d(F,"_loggerManager",g),d(F,"EVENT",P),d(F,"ERROR_CODE",$),d(F,"TYPE",Pr),d(F,"frameWorkType",30),N([fe(le.TRTC.enterRoom),kt("room",([r],[t])=>(r.roomId||r.strRoomId)===(t.roomId||t.strRoomId)&&r.userId===t.userId&&r.sdkAppId===t.sdkAppId),H(r=>function(t){return this._log.setUserId(t.userId),this._log.setSdkAppId(t.sdkAppId),r.call(this,t).catch(e=>{throw pe(this),e})}),ae()],F.prototype,"enterRoom",1),N([ae()],F.prototype,"exitRoom",1),N([fe(le.TRTC.switchRole),ai("room",(r,t)=>t),ae()],F.prototype,"switchRole",1),N([ae()],F.prototype,"destroy",1),N([fe(le.TRTC.startLocalAudio),kt("audio",([r],[t])=>{var e,i;return((e=r==null?void 0:r.option)==null?void 0:e.microphoneId)===((i=t==null?void 0:t.option)==null?void 0:i.microphoneId)}),ae()],F.prototype,"startLocalAudio",1),N([fe(le.TRTC.updateLocalAudio),ai("audio"),ae()],F.prototype,"updateLocalAudio",1),N([wt("audio"),ae()],F.prototype,"stopLocalAudio",1),N([fe(le.TRTC.startLocalVideo),kt("video",([r],[t])=>{var e,i;return((e=r==null?void 0:r.option)==null?void 0:e.cameraId)===((i=t==null?void 0:t.option)==null?void 0:i.cameraId)}),ae()],F.prototype,"startLocalVideo",1),N([fe(le.TRTC.updateLocalVideo),ai("video"),ae()],F.prototype,"updateLocalVideo",1),N([wt("video"),ae()],F.prototype,"stopLocalVideo",1),N([fe(le.TRTC.startScreenShare),kt("screen",()=>!0),ae()],F.prototype,"startScreenShare",1),N([fe(le.TRTC.updateScreenShare),ai("screen"),ae()],F.prototype,"updateScreenShare",1),N([ae()],F.prototype,"stopScreenShare",1),N([fe(le.TRTC.startRemoteVideo),kt(r=>`v${r.userId}${r.streamType}`,()=>!0),ae()],F.prototype,"startRemoteVideo",1),N([fe(le.TRTC.updateRemoteVideo),ai(r=>`v${r.userId}${r.streamType}`),ae()],F.prototype,"updateRemoteVideo",1),N([fe(le.TRTC.stopRemoteVideo),H(r=>function(t){return _(this,null,function*(){if(t.userId==="*"){let e=[];return this._room.remotePublishedUserMap.forEach(i=>{this._remoteVideoConfigMap.has(`${i.userId}_${"main"}`)&&e.push(this.stopRemoteVideo({streamType:"main",userId:i.userId}).catch(()=>{})),this._remoteVideoConfigMap.has(`${i.userId}_${"sub"}`)&&e.push(this.stopRemoteVideo({streamType:"sub",userId:i.userId}).catch(()=>{}))}),Promise.all(e)}return r.call(this,t)})}),ae()],F.prototype,"stopRemoteVideo",1),N([wt(r=>`v${r.userId}${r.streamType}`)],F.prototype,"_stopRemoteVideo",1),N([fe(...le.TRTC.muteRemoteAudio),ae()],F.prototype,"muteRemoteAudio",1),N([ca(...le.TRTC.setRemoteAudioVolume),dd(200,r=>r),ae()],F.prototype,"setRemoteAudioVolume",1),N([os("start"),kt((r,t)=>r.getAlias()+r.getGroup(t))],F.prototype,"startPlugin",1),N([os("update"),ai((r,t)=>r.getAlias()+r.getGroup(t))],F.prototype,"updatePlugin",1),N([os("stop"),wt((r,t)=>r.getAlias()+r.getGroup(t))],F.prototype,"stopPlugin",1),N([ca(...le.TRTC.enableAudioVolumeEvaluation)],F.prototype,"enableAudioVolumeEvaluation",1),N([kt(r=>`a${r.userId}`,()=>!0)],F.prototype,"_startRemoteAudio",1),N([H(r=>function(t){return _(this,null,function*(){return t.userId==="*"?Promise.all([...this._room.remotePublishedUserMap.values()].map(e=>this._stopRemoteAudio(k(R({},t),{userId:e.userId})).catch(()=>{}))):r.call(this,t)})}),wt(r=>`a${r.userId}`)],F.prototype,"_stopRemoteAudio",1),N([wt("room")],F.prototype,"_exitRoom",1),N([wt("screen")],F.prototype,"_stopScreenShare",1),N([fe(le.TRTC.sendSEIMessage),Xc({timesInSecond:30,maxSizeInSecond:8e3,getSize:(...r)=>r[0].byteLength})],F.prototype,"sendSEIMessage",1),N([fe(le.TRTC.create)],F,"_create",1);var Ur=F;var la=class{constructor(){this._set=new Set;E.on(p.LEAVE_SUCCESS,this.delete,this)}add({room:t,roomId:e}){if(t.scene==="rtc")return;let i=this.getKey(t.userId,e||t.roomId,t.sdkAppId,t.useStringRoomId);this._set.add(i)}delete({room:t,roomId:e}){if(t.scene==="rtc")return;let i=this.getKey(t.userId,t.roomId||e,t.sdkAppId,t.useStringRoomId);this._set.delete(i)}getKey(t,e,i,o){return`${i}_${e}_${t}_${o}`}isJoined({userId:t,roomId:e,sdkAppId:i,room:o}){return o.scene==="rtc"?!1:this._set.has(this.getKey(t,e,i,o.useStringRoomId))}};function sh(){return _(this,null,function*(){let r,t;try{let m=yield ge();r=m&&m.length}catch(m){}try{let m=yield ve();t=m&&m.length}catch(m){}let e={microphone:r,camera:t},{isH264EncodeSupported:i,isVp8EncodeSupported:o,isH264DecodeSupported:s,isVp8DecodeSupported:n}=this.checkSystemResult.detail,a=nt.basis(),c={webRTC:a.isWebRTCSupported,getUserMedia:a.isGetUserMediaSupported,webSocket:a.isWebSocketsSupported,screenShare:a.isScreenShareSupported,webAudio:a.isWebAudioSupported,h264Encode:i,h264Decode:s,vp8Encode:o,vp8Decode:n},l={browser:a.browser,os:a.os,trtc:c,devices:e},h={isWebCodecSupported:a.isWebCodecSupported,isMediaSessionSupported:a.isMediaSessionSupported,isWebTransportSupported:a.isWebTransportSupported};Z.uploadEvent({log:`trtcstats-${JSON.stringify(l)}`,userId:this.userId}),this._log.info(`TrtcStats-${JSON.stringify(l)}`),Z.uploadEvent({log:`trtcadvancedstats-${JSON.stringify(h)}`,userId:this.userId})})}function hd(){return H(r=>{let t=new la;return function(e,i,o){return _(this,null,function*(){let s=String(e.roomId||e.strRoomId);if(this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.userSig=e.userSig,this._log.setSdkAppId(this.sdkAppId),this._log.setUserId(this.userId),this.scene=i,e.privateMapKey=e.privateMapKey||"",this.isJoined)throw new A({code:T.INVALID_OPERATION,message:y({key:C.INVALID_JOIN})});if(this.checkDestroy(),t.isJoined({userId:this.userId,roomId:s,sdkAppId:this.sdkAppId,room:this}))throw new A({code:T.INVALID_OPERATION,message:y({key:C.REPEAT_JOIN,data:this.userId})});t.add({room:this,roomId:s}),this._log.info(`Join() => joining room: ${s} useStringRoomId: ${this.useStringRoomId} scene: ${this.scene} role: ${this.role}`),this.role=e.role===21?"audience":"anchor",E.emit(p.JOIN_START,{room:this,roomId:s,params:e}),this.checkSystemResult=yield nt.checkSystemRequirementsInternal(),this.checkDestroy();let n=me.getEnv();n||(n=tt.QCLOUD,this.proxy_ws&&(this.proxy_ws.startsWith(So.OLD_CLOUD_LADDER)?n=tt.OLD_CLOUD_LADDER:this.proxy_ws.startsWith(So.WEBRTC)&&(n=tt.WEBRTC))),Z.setConfig({env:n,sdkAppId:String(this.sdkAppId),userId:this.userId,roomId:s}),sh.call(this);let{isH264EncodeSupported:a,isVp8EncodeSupported:c}=this.checkSystemResult.detail;if(!nt.isWebRTCSupported()||!a&&!c)throw new A({code:T.NOT_SUPPORTED,message:y({key:C.NOT_SUPPORTED_WEBRTC})});try{!this.proxy_ws&&!this.proxy_wt&&!this.scheduleResult.domains&&!me.getEnv()&&(yield this.schedule(s,o,_e));let l=yield r.call(this,e,i,o);return this.roomId=s,this._joinedTimestamp=me.performanceNow(),E.emit(p.JOIN_SUCCESS,{room:this}),Z.uploadEvent({log:`stat-conv-${Number(we)}-${location.hostname}`,userId:this.userId}),l}catch(l){throw t.delete({room:this,roomId:s}),E.emit(p.JOIN_FAILED,{room:this,error:l}),l}})}})}var _d=()=>H(r=>function(...t){return _(this,null,function*(){E.emit(p.LEAVE_START,{room:this}),yield r.call(this),E.emit(p.LEAVE_SUCCESS,{room:this,roomId:this.roomId})})});function md(){return H(r=>function(...t){let e=r.apply(this,t);return t.forEach(i=>!i.isSubscribed&&i.subscribe(e)),e})}import nh from"eventemitter3";var ie={SETUP_SUCCESS:"1",SETUP_FAILED:"5",CONNECTION_STATE_CHANGED:"2",CONNECTED:"3",RECONNECT_FAILED:"4"},Ce={DISCONNECTED:"DISCONNECTED",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED"},qe={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772,REBUILD_PEER_CONNECTION_RES:4150,SPC_PUBLISH_RESULT:4146,SPC_SUBSCRIBE_RESULT:4156},pd=[qe.UPDATE_REMOTE_MUTE_STAT,qe.UPLINK_NETWORK_STATS,qe.USER_LIST_RES,qe.MUTE_RESULT],V={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res",REBUILD_PEER_CONNECTION_RES:"rebuild-pc-res",SPC_PUBLISH_RESULT:"spc-publish-result",SPC_SUBSCRIBE_RESULT:"spc-subscribe-result"},G={PUBLISH_CHANGE:"publish_change",JOIN_ROOM:"join",LEAVE_ROOM:"leave",ON_QUALITY_REPORT:"quality_report",UPDATE_MUTE_STAT:"mute_uplink",PUBLISH:"publish",PUBLISH_STATE_CHANGE:"publish_state_change",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",RECEIVE_DATA_USER_LIST:"receive_data_userlist",UNSUBSCRIBE:"unsubscribe",SUBSCRIBE_CHANGE:"subscribe_change",START_PUBLISH_TENCENT_CDN:"start_publishing",STOP_PUBLISH_TENCENT_CDN:"stop_publishing",START_PUBLISH_GIVEN_CDN:"start_push_user_cdn",STOP_PUBLISH_GIVEN_CDN:"stop_push_user_cdn",START_MIX_TRANSCODE:"start_mcu_mix",STOP_MIX_TRANSCODE:"stop_mcu_mix",GET_USER_LIST:"get_user_list",SWITCH_ROLE:"change_role",UPDATE_CONSTRAINT_CONFIG:"update_constraint_config",REBUILD_PEER_CONNECTION:"rebuild_pc",READY_TO_RECEIVE_DATA:"ready_to_receive",SPC_JOIN_ROOM:"join/v2",SPC_PUBLISH:"publish/v2",SPC_SUBSCRIBE:"subscribe/v3"};var xr=class{constructor(t){d(this,"_room");d(this,"_sdkAppId");d(this,"_userId");d(this,"_userSig");d(this,"_url");d(this,"_backupUrl");d(this,"_urlWithParam");d(this,"_backupUrlWithParam");d(this,"_socketInUse");d(this,"_socket");d(this,"_backupSocket");d(this,"_backupTimer",-1);d(this,"_signalInfo",{tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0});d(this,"_currentState",Ce.DISCONNECTED);d(this,"_reconnectionCount",0);d(this,"_reconnectionTimer",-1);d(this,"_seq",0);d(this,"_log");d(this,"_emitter");d(this,"_lastMessageTime",-1);d(this,"_prevTime",-1);this._room=t.room,this._sdkAppId=t.sdkAppId,this._userId=t.userId,this._userSig=t.userSig,this._url=t.url,this._backupUrl=t.backupUrl;let e=`?sdkAppId=${encodeURIComponent(this._sdkAppId)}&userId=${encodeURIComponent(this._userId)}&userSig=${encodeURIComponent(this._userSig)}`;this._urlWithParam=`${this._url}${e}`,this._backupUrlWithParam=`${this._backupUrl}${e}`,this._seq=0,this._log=g.createLogger({id:"ws",userId:this._userId,sdkAppId:this._sdkAppId}),this._emitter=new nh}get isConnected(){return this._currentState===Ce.CONNECTED}get isConnecting(){return this._currentState===Ce.CONNECTING}get isOnline(){return this._currentState===Ce.CONNECTED&&Date.now()-this._lastMessageTime<12*1e3}connect(){return new Promise((t,e)=>{this._prevTime<0&&(this._prevTime=w()),this._log.info(`connect to ${this._url}`),this.emitConnectionStateChanged(Ce.CONNECTING),this._socket=new WebSocket(this._urlWithParam),this.bindSocket(this._socket),this._backupTimer=setTimeout(()=>{this.isConnected||(this._log.info("trying to connect to backupUrl"),this.tryConnectBackup())},5e3),this.once(ie.CONNECTED,t),this.once(ie.RECONNECT_FAILED,e)})}tryConnectBackup(){this._backupSocket||(this.unbindAndCloseSocket(u.MAIN),this._log.debug(`try to connect to url: ${this._backupUrlWithParam}`),this._backupSocket=new WebSocket(this._backupUrlWithParam),this.bindSocket(this._backupSocket))}bindSocket(t){t.onopen=this.onopen.bind(this),t.onclose=this.onclose.bind(this),t.onerror=this.onerror.bind(this),t.onmessage=this.onmessage.bind(this)}unbindSocket(t){this.clearBackupTimer(),t.onopen=()=>{},t.onclose=()=>{},t.onerror=()=>{},t.onmessage=()=>{}}unbindAndCloseSocket(t){if(t===u.MAIN){if(this._socket){this.unbindSocket(this._socket);try{this._socket.close(1e3)}catch(e){}this._socket=null}}else if(this._backupSocket){this.unbindSocket(this._backupSocket);try{this._backupSocket.close(1e3)}catch(e){}this._backupSocket=null}}clearBackupTimer(){this._backupTimer!==-1&&(clearTimeout(this._backupTimer),this._backupTimer=-1)}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onopen(t){if(this.isConnected)return;this.isReconnecting&&!this._signalInfo.tinyId&&this.stopReconnection(),this.clearBackupTimer(),t.target===this._socket?(this.unbindAndCloseSocket(u.BACKUP),this._socketInUse=this._socket):(this.unbindAndCloseSocket(u.MAIN),this._socketInUse=this._backupSocket),this.emitConnectionStateChanged(Ce.CONNECTED),this._emitter.emit(ie.CONNECTED)}onclose(t){let{url:e}=t.target,i=t.target===this._socketInUse;if(this._log.info(`websocket[${e} InUse: ${i}] is closed with code: ${t.code}`),i&&(this.emitConnectionStateChanged(Ce.DISCONNECTED),!t.wasClean||t.code!==1e3)){this._log.warn(`onclose code:${t.code} reason:${t.reason}`),this._log.warn("close current websocket and schedule a reconnect timeout"),this._socketInUse.onclose=()=>{},this._socketInUse.close(4011);let o=this._socketInUse===this._socket;this._socket=null,this._backupSocket=null,this._socketInUse=null,this.reconnect(o?u.BACKUP:u.MAIN)}}onerror(t){let{url:e}=t.target;if(this._log.error(`websocket[${e}] error observed`),!this.isConnected)this.isReconnecting||E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:new Error("ws onerror")}),t.target==this._socket?(this.unbindAndCloseSocket(u.MAIN),this.reconnect(u.BACKUP)):(this.unbindAndCloseSocket(u.BACKUP),this.reconnect(u.MAIN));else if(t.target===this._socketInUse){this.unbindAndCloseSocket(u.MAIN),this.unbindAndCloseSocket(u.BACKUP);let i=this._socketInUse===this._socket;this._socketInUse=null,this.reconnect(i?u.BACKUP:u.MAIN)}}onmessage(t){if(!this.isConnected)return;this._lastMessageTime=Date.now();let e=JSON.parse(t.data),{cmd:i,data:o}=e,s=Object.values(qe),a=Object.keys(qe)[s.indexOf(i)],c=V[a];switch(pd.includes(i)||(this._log.debug(`received msg: ${t.data}`),this._log.info(`Received event: [ ${c||`unknown cmd: ${i}`} ]`)),i){case qe.CHANNEL_SETUP_RESULT:{if(e.code===0)this._signalInfo.clientIp=o.clientIp,this._signalInfo.signalIp=o.signalInnerIp,this._signalInfo.tinyId=e.tinyId,o.svrTime&&xa(o.svrTime),this._log.info("ChannelSetup Success"),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",cost:w()-this._prevTime}),this._prevTime=-1,this._emitter.emit(ie.SETUP_SUCCESS,{signalInfo:this._signalInfo});else{let l=new A({code:T.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:e.code,message:y({key:C.SIGNAL_CHANNEL_SETUP_FAILED,data:{errorCode:e.code,errorMsg:e.message}})});this._log.error(`${e.code}, ${e.message}`),this.close(),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:l}),this._emitter.emit(ie.SETUP_FAILED,l)}break}case qe.JOIN_ROOM_RESULT:{e.code===0&&(this._signalInfo.relayIp=o.relayOuterIp,this._signalInfo.relayInnerIp=o.relayInnerIp,this._signalInfo.relayPort=o.relayPort,this._log.info(`signalIp:${this._signalInfo.signalIp} clientIp:${this._signalInfo.clientIp} relayIp: ${this._signalInfo.relayIp}`)),this._emitter.emit(c,{data:e});break}case qe.CHANNEL_RECONNECT_RESULT:{e.code===0?(this._log.warn("reconnect success"),this.stopReconnection(),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",cost:w()-this._prevTime}),this._prevTime=-1,this._room.syncUserList(),this._room.checkConnectionsToReconnect()):(this._log.warn(`reconnect failed, ${e.code} ${e.message}`),this._room.reJoin());break}default:this._emitter.emit(c,{data:e});break}}reconnect(t=u.MAIN){if(this.isReconnecting)return;if(this._reconnectionCount>=fr){this._log.warn(`SDK has tried reconnect signal channel for ${fr} times, but all failed. please check your network`);let o=new A({code:T.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:y({key:C.SIGNAL_CHANNEL_RECONNECTION_FAILED})});E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",error:o}),this._emitter.emit(ie.RECONNECT_FAILED,o);return}this._reconnectionCount++,this._log.warn(`reconnect ${t} [${this._reconnectionCount}/${fr}]`);let e=this.getReconnectionUrl(t);this.emitConnectionStateChanged(Ce.CONNECTING),this._prevTime<0&&(this._prevTime=w()),t===u.MAIN?(this._socket=new WebSocket(e),this.bindSocket(this._socket)):(this._backupSocket=new WebSocket(e),this.bindSocket(this._backupSocket));let i=ye(this._reconnectionCount);this._reconnectionTimer=setTimeout(()=>{this._log.warn(`reconnect ${t} timeout(${i/1e3}s), try again`),this.clearReconnectionTimer(),this.unbindAndCloseSocket(u.MAIN),this.unbindAndCloseSocket(u.BACKUP),this.reconnect(t===u.MAIN?u.BACKUP:u.MAIN)},i)}get isReconnecting(){return this._reconnectionTimer!==-1}getReconnectionUrl(t){let e=t===u.MAIN?this._urlWithParam:this._backupUrlWithParam;if(this._signalInfo.tinyId&&e.indexOf("&rc=1")===-1){let{roomId:i,useStringRoomId:o}=this._room;e+=`&rc=1&relayInnerIp=${this._signalInfo.relayInnerIp}&relayOuterIp=${this._signalInfo.relayIp}&relayPort=${this._signalInfo.relayPort}&roomId=${i}&useStringRoomId=${o}`}return e}send(t,e={}){if(this.isConnected){let i={cmd:t,data:e,userId:this._userId,tinyId:this._signalInfo.tinyId,seq:++this._seq};return this._socketInUse.send(JSON.stringify(i)),i.seq}}sendWaitForResponse({command:t,data:e,timeout:i=5e3,responseCommand:o,commandDesc:s,enableLog:n=!0}){return new Promise((a,c)=>{let l=setTimeout(()=>{this.off(o,h);let f=new A({code:T.API_CALL_TIMEOUT,message:y({key:C.API_CALL_TIMEOUT,data:{commandDesc:s,command:t}})});n&&this._log.warn(f),c(f)},i),h=f=>{f.data.seq===m&&(clearTimeout(l),this.off(o,h),a(f))};this.on(o,h);let m=this.send(t,e)})}sendWaitForResponseWithRetry(t){let{commandDesc:e,command:i,retries:o=0,retryTimeout:s=0}=t;return Je({retryFunction:this.sendWaitForResponse,onRetrying:n=>{this._log.warn(`${e||i} timeout observed, retrying [${n}/${o}]`)},settings:{retries:o,timeout:s},context:this})(t)}getCurrentState(){return this._currentState}getSignalInfo(){return this._signalInfo}stopReconnection(){this.isReconnecting&&(this._reconnectionCount=0,this.clearReconnectionTimer())}close(){this._log.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._socketInUse=null,this.unbindAndCloseSocket(u.MAIN),this.unbindAndCloseSocket(u.BACKUP),this.emitConnectionStateChanged(Ce.DISCONNECTED)}on(t,e,i){this._emitter.on(t,e,i)}removeListener(t,e,i){this._emitter.removeListener(t,e,i)}once(t,e,i){this._emitter.once(t,e,i)}off(t,e,i){this._emitter.off(t,e,i)}emitConnectionStateChanged(t){t!==this._currentState&&(this._log.info(`${this._currentState} -> ${t}`),this._emitter.emit(ie.CONNECTION_STATE_CHANGED,{prevState:this._currentState,state:t}),this._currentState=t)}};import ah from"eventemitter3";var Br=class{constructor(t,e=!1){this.dataView=t;this.isSEI&&(e?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){let t=this.seiPayloadStartIndex,e=this.dataView.byteLength-2,i=[],o=0;for(let n=t;n<=e;n++){let a=this.dataView.getInt8(n);switch(a){case 0:case 1:case 2:case 3:o===2&&(i.push(3),o=0),a==0?o++:o=0,i.push(a);break;default:o=0,i.push(a);break}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));let s=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,t),...i]).buffer);this.dataView=s}removePreventionByte(){let t=this.seiPayloadStartIndex,e=this.dataView.byteLength-1,i=[],o=0;for(let n=t;n<=e;n++)switch(this.dataView.getInt8(n)){case 0:o++,i.push(this.dataView.getInt8(n));break;case 3:o!==2&&i.push(this.dataView.getInt8(n)),o=0;break;default:i.push(this.dataView.getInt8(n)),o=0;break}let s=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,t),...i]).buffer);this.dataView=s}get isSEI(){return this.dataView.getUint8(4)===6}get seiPayloadStartIndex(){let t=6;for(let e=6;e<this.dataView.buffer.byteLength&&(t++,this.dataView.getUint8(e)===255);e++);return t}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let t=0,e=6;for(let s=6;s<this.dataView.buffer.byteLength;s++){let n=this.dataView.getUint8(s);if(e++,n===255)t+=255;else{t+=n;break}}let i=new ArrayBuffer(t),o=new DataView(i);for(let s=0;s<i.byteLength;s++,e++)o.setInt8(s,this.dataView.getInt8(e));return o}};var ua=class{constructor(t,e,i){this._connection=t;this._log=e;this._isUplink=i;d(this,"_seiMessageList",[]);d(this,"_seiPayloadType",243);d(this,"_mainVideoSenderOrReceiver",null);d(this,"_mainVideoAbortController",null);d(this,"_abortMap",new Map);d(this,"onSEIMessage")}get isRunning(){return!!this._mainVideoAbortController}start(t){this._mainVideoSenderOrReceiver=t;let e=t.createEncodedStreams(),i=e.readable,o=e.writable,s=new TransformStream({transform:this._isUplink?this.encodeVideoFrame.bind(this):this.decodeVideoFrame.bind(this)});this._mainVideoAbortController=new AbortController,i.pipeThrough(s).pipeTo(o,this._mainVideoAbortController).catch(()=>{})}restart(t){this.stop(),this.start(t)}stop(){var t;(t=this._mainVideoAbortController)==null||t.abort(),this._mainVideoAbortController=null}destroy(){this.stop(),this._abortMap.forEach(t=>t.abort()),this._abortMap.clear(),this._log=null,this.onSEIMessage=null,this._mainVideoSenderOrReceiver=null,this._connection=null}handleEncodedStreams(){try{let t=this._connection.getPeerConnection();this.clearUnusedSenderOrReceiver(t),this._isUplink?t.getSenders().forEach((e,i)=>{if(i===1){if(e===this._mainVideoSenderOrReceiver)return;this.isRunning?this.restart(e):this.start(e)}else{if(this._abortMap.has(e))return;this.pipeSenderOrReceiver(e)}}):t.getReceivers().forEach((e,i)=>{var o;this._abortMap.has(e)||e===this._mainVideoSenderOrReceiver||(i===1&&((o=e.track)==null?void 0:o.kind)===u.VIDEO?this.isRunning?this.restart(e):this.start(e):this.pipeSenderOrReceiver(e))})}catch(t){this._log.warn(t)}}pipeSenderOrReceiver(t){let{readable:e,writable:i}=t.createEncodedStreams(),o=new AbortController;this._abortMap.set(t,o),e.pipeTo(i,o).catch(()=>{})}clearUnusedSenderOrReceiver(t){this._abortMap.forEach((e,i)=>{(this._isUplink?t.getSenders():t.getReceivers()).find(s=>s===i)||(e.abort(),this._abortMap.delete(i))})}push(t,e){e&&e.seiPayloadType&&(this._seiPayloadType=e.seiPayloadType),this._seiMessageList.push(t)}hasSEI(t){let e=new DataView(t);return e.getInt32(0)===1&&e.getInt8(4)===6}isEmptyFrame(t){return t.type==="empty"||t.data.byteLength===0}getNaluCount(t){let e=0,i=0,o=new DataView(t);for(let s=0;s<t.byteLength;s++)switch(o.getUint8(s)){case 0:e++;break;case 1:(e===2||e===3)&&i++,e=0;break;default:e=0;break}return i}encodeVideoFrame(t,e){try{if(this._connection.isH264&&this._seiMessageList.length>0&&!this.isEmptyFrame(t)){let o=9-this.getNaluCount(t.data);if(o<=0)return;let s=this._seiMessageList.splice(0,o).reverse().map(this.encodeSEINalu.bind(this)),n=s.reduce((m,f)=>m+f.dataView.byteLength,0),a=new ArrayBuffer(n+t.data.byteLength),c=new DataView(a),l=new DataView(t.data),h=0;for(let m=0;m<s.length;m++)for(let f=0;f<s[m].dataView.byteLength;f++)c.setInt8(h++,s[m].dataView.getInt8(f));for(let m=0;m<t.data.byteLength;m++)c.setInt8(h++,l.getInt8(m));t.data=a,this._log.debug(`${s.length} sei sent`)}}catch(i){this._log.warn(i)}e.enqueue(t)}decodeVideoFrame(t,e){try{if(this._connection.isH264&&!this.isEmptyFrame(t)&&this.hasSEI(t.data)){let i=[],o=new DataView(t.data),s=0,n=-1,a=-1;for(let c=0;c<t.data.byteLength;c++){let l=o.getUint8(c);if(l===0)s++;else if(l===1){if(s===2||s===3){let h=c-s;if(n===-1?n=h:a===-1&&(a=h,i.push(new Br(new DataView(o.buffer.slice(n,a)))),n=h,a=-1),!(o.getUint8(c+1)===6)){t.data=new DataView(o.buffer.slice(h)).buffer;break}}s=0}else s=0}this._log.debug(`${i.length} sei received`),K(this.onSEIMessage)&&i.reverse().forEach(c=>{this.onSEIMessage({seiPayloadType:c.seiPayloadType,data:c.seiPayload.buffer})})}}catch(i){this._log.warn(i)}e.enqueue(t)}encodeSEINalu(t){let e=t.byteLength,i=parseInt(e/255),o=e%255,s=[];s.push(0,0,0,1,6,this._seiPayloadType);for(let a=0;a<i;a++)s.push(255);s.push(o);let n=new DataView(t);return s.push(...new Uint8Array(n.buffer)),s.push(128),new Br(new DataView(new Uint8Array(s).buffer),!0)}},ss=ua;var ha=0,_a=!1,ns=new Set,ch=r=>ha>2&&!_a&&ns.size===0&&r,ma=!1,Ne=class{constructor(t){d(this,"userId");d(this,"tinyId");d(this,"_sdpSemantics");d(this,"_isUplink");d(this,"_room");d(this,"_log");d(this,"_signalChannel");d(this,"_isErrorObserved",!1);d(this,"_waitForPeerConnectionConnectedPromise");d(this,"_waitForPeerConnectionConnectedPromiseReject",null);d(this,"_peerConnection",null);d(this,"_emitter",new ah);d(this,"_currentState","DISCONNECTED");d(this,"_isReconnecting",!1);d(this,"_reconnectionCount",0);d(this,"_reconnectionTimer",-1);d(this,"_isFirstConnection",!0);d(this,"_prevTime",-1);d(this,"_enableSEI");d(this,"_sei");d(this,"_localAddress");d(this,"_remoteAddress");this.userId=t.userId,this.tinyId=t.tinyId,this._room=t.room,this._sdpSemantics=t.room.sdpSemantics,this._isUplink=t.isUplink,this._log=g.createLogger({id:"n",userId:this._room.userId,remoteUserId:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=t.signalChannel,this._enableSEI=t.enableSEI,this._enableSEI&&bt&&(this._sei=new ss(this,this._log,this._isUplink))}beforeConnect(){this._prevTime<0&&(this._prevTime=w())}afterConnect(t){return _(this,null,function*(){try{yield t,this._isFirstConnection?(this._isFirstConnection=!1,E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",cost:Math.min(w()-this._prevTime,30*1e3)})):this._isReconnecting&&E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",cost:w()-this._prevTime}),this._prevTime=-1}catch(e){throw this._isFirstConnection?(this._isFirstConnection=!1,E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",error:e})):this._isReconnecting&&this._reconnectionCount>=3&&E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",error:e}),e}})}initialize(){let t={encodedInsertableStreams:this._enableSEI&&bt,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this._peerConnection=new RTCPeerConnection(t),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(t){this._log.info("close connection"),this._emitter.emit("closed",t),this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this._sei&&(this._sei.destroy(),this._sei=null),ns.delete(this)}closePeerConnection(t=!1){this._peerConnection&&(this._log.info("close pc"),this._peerConnection.onconnectionstatechange=null,this._peerConnection.close(),this._peerConnection=null,t&&this.emitConnectionStateChangedEvent("DISCONNECTED")),this._waitForPeerConnectionConnectedPromiseReject&&this._waitForPeerConnectionConnectedPromiseReject(new A({code:T.API_CALL_ABORTED,message:"connection closed"}))}getDTLSTransportState(){if(!this._peerConnection)return Ue;let t=null;if(this._isUplink){if(!Ui()||this._peerConnection.getSenders().length===0)return Ue;t=this._peerConnection.getSenders()[0].transport}else{if(!Zt()||this._peerConnection.getReceivers().length===0)return Ue;t=this._peerConnection.getReceivers()[0].transport}return t?t.state:Ue}onConnectionStateChange(t){let e=this._peerConnection.iceConnectionState,i=this.getDTLSTransportState();if(this._log.info(`connectionState: ${t.target.connectionState}, ICE: ${e}, DTLS: ${i}`),t.target.connectionState===q.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),t.target.connectionState===q.FAILED||t.target.connectionState===q.CLOSED){let o=`connection ${t.target.connectionState}. ICE Transport state: ${e}, DTLS Transport state: ${i}`,s=new A({message:o,code:T.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection(),this._isErrorObserved||this._emitter.emit("error",s)}(t.target.connectionState===q.CONNECTED||t.target.connectionState===q.COMPLETED)&&(this.logSelectedCandidate(),Z.logSuccessEvent({userId:this._room.userId,eventType:Ge.ICE_CONNECTION_STATE}),this.emitConnectionStateChangedEvent("CONNECTED"))}emitConnectionStateChangedEvent(t){return t===this._currentState?!1:(t==="CONNECTED"?(ha=0,_a=!1,ma=!0,ns.add(this)):ns.delete(this),E.emit(p.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:t,remoteUserId:this._isUplink?void 0:this.userId}),this._emitter.emit("connection-state-changed",{prevState:this._currentState,state:t}),this._currentState=t,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}logSelectedCandidate(){return _(this,null,function*(){if(!this._peerConnection)return;let t=yield this._peerConnection.getStats();for(let[,e]of t)if(Ot(e)){let i=t.get(e.localCandidateId),o=t.get(e.remoteCandidateId);i&&(this._log.info(`local candidate: ${i.candidateType} ${i.protocol}:${i.ip||i.address}:${i.port} ${i.networkType||""} ${i.candidateType==="relay"?`relayProtocol:${i.relayProtocol}`:""}`),this._localAddress=`${i.ip||i.address}:${i.port}`),o&&(this._log.info(`remote candidate: ${o.candidateType} ${o.protocol}:${o.ip||o.address}:${o.port}`),this._remoteAddress=`${o.protocol}:${o.ip||o.address}`);break}})}getCurrentState(){return this._currentState}waitForPeerConnectionConnected(){return this._waitForPeerConnectionConnectedPromise?this._waitForPeerConnectionConnectedPromise:(this._waitForPeerConnectionConnectedPromise=new Promise((t,e)=>{if(this._currentState==="CONNECTED")return t();this._waitForPeerConnectionConnectedPromiseReject=e;let i=a=>{a.state==="CONNECTED"&&(clearTimeout(n),s(),t())},o=({room:a})=>{a===this._room&&(clearTimeout(n),s(),e(new A({code:T.API_CALL_ABORTED,message:y({key:C.CONNECTION_ABORTED,data:"leave room"})})))},s=()=>{E.off(p.LEAVE_SUCCESS,o,this),this._emitter.off("connection-state-changed",i,this)},n=setTimeout(()=>{s();let a=new A({code:T.API_CALL_TIMEOUT,message:"connection timeout"});ha+=1,ch(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),_a=!0,this._emitter.emit("firewall-restriction")),e(a)},Tr);E.on(p.LEAVE_SUCCESS,o,this),this._emitter.on("connection-state-changed",i,this)}),this._waitForPeerConnectionConnectedPromise=this._waitForPeerConnectionConnectedPromise.finally(()=>{this._waitForPeerConnectionConnectedPromise=null,this._waitForPeerConnectionConnectedPromiseReject=null}),this._waitForPeerConnectionConnectedPromise)}getReconnectionCount(){return this._reconnectionCount}startReconnection(){this._isReconnecting=!0,this.reconnect()}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}stopReconnection(){this._log.info("stop reconnection"),this._isReconnecting=!1,this._reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(ie.CONNECTED,this.reconnect,this)}beforeReconnect(){if(this._reconnectionTimer!==-1)return this._log.warn("reconnect() is reconnecting, ignore"),-1;if(this._reconnectionCount>=it()){this._log.warn(`SDK has tried reconnect for ${this._reconnectionCount} times, but all failed, please check your network`),this.stopReconnection();let t=new A({code:this._isUplink?T.UPLINK_RECONNECTION_FAILED:T.DOWNLINK_RECONNECTION_FAILED,message:y({key:this._isUplink?C.UPLINK_RECONNECTION_FAILED:C.DOWNLINK_RECONNECTION_FAILED})});return this.emitConnectionStateChangedEvent("DISCONNECTED"),this._emitter.emit("error",t),-1}return this._signalChannel.isConnected?(this._reconnectionCount+=1,this._log.warn(`reconnect() trying [${this._reconnectionCount}]`),1):(this._log.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this._signalChannel.once(ie.CONNECTED,this.reconnect,this),-1)}on(t,e,i){this._emitter.on(t,e,i)}off(t,e,i){this._emitter.off(t,e,i)}getIsReconnecting(){return this._isReconnecting}get isH264(){var t,e;return!!((e=(t=this._peerConnection)==null?void 0:t.remoteDescription)!=null&&e.sdp.includes("H264"))}};import Ed from"sdp-transform";var oe=function(r){return Ed.parse(r)},Pe=function(r){return Ed.write(r)},fd=function(r){let t=oe(r);return t.media.forEach(e=>{e.type===u.AUDIO&&e.fmtp.forEach(i=>{i.config+=";sprop-stereo=1;stereo=1"})}),Pe(t)};function Td(r){let t=oe(r);return t.media.forEach(e=>{var i,o;if(e.type===u.VIDEO){let s=new Set;e.rtp.forEach(({payload:a,codec:c})=>c==="H264"&&s.add(a)),e.fmtp.forEach(({payload:a,config:c})=>{let l=c.match(/apt=(\d+)/);l&&l[1]&&s.has(Number(l[1]))&&s.add(a)});let n=({payload:a})=>!s.has(a);e.rtp=e.rtp.filter(n),e.rtcpFb=(i=e.rtcpFb)==null?void 0:i.filter(n),e.fmtp=e.fmtp.filter(n),e.payloads=(o=e.payloads)==null?void 0:o.split(" ").filter(a=>!s.has(Number(a))).join(" ")}}),Pe(t)}function as(r){return Object.keys(r).filter(t=>r[t])}var Ea=class extends Ne{constructor(e){super(k(R({},e),{isUplink:!1}));d(this,"_flag",0);d(this,"role","anchor");d(this,"remoteAudioTrack");d(this,"remoteVideoTrack");d(this,"remoteAuxiliaryTrack");d(this,"ssrc",{audio:0,video:0,auxiliary:0});d(this,"_isSDPExchanging",!1);this.flag=e.flag,this.remoteAudioTrack=e.remoteAudioTrack||new Fi(this._room,this),this.remoteVideoTrack=e.remoteVideoTrack||new si(this._room,this),this.remoteAuxiliaryTrack=e.remoteAuxiliaryTrack||new Gi(this._room,this)}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(this.remoteVideoTrack.mediaType&8?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return Nt(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var i,o,s;e!==this._flag&&(this._flag=e,(i=this.remoteAudioTrack)==null||i.onFlagChanged(),(o=this.remoteVideoTrack)==null||o.onFlagChanged(),(s=this.remoteAuxiliaryTrack)==null||s.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===u.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){super.initialize(),this.installEvents(),this._peerConnection.ontrack=this.onTrack.bind(this)}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents()}installEvents(){}uninstallEvents(){this._emitter.removeAllListeners()}emitConnectionStateChangedEvent(e){var s,n;let i=this._currentState,o=super.emitConnectionStateChangedEvent(e);return o&&i!==e&&((s=this.remoteVideoTrack)==null||s.emit("connection-state-changed",{prevState:i,state:e}),(n=this.remoteAuxiliaryTrack)==null||n.emit("connection-state-changed",{prevState:i,state:e})),o}onTrack(e){let i=e.streams[0],{track:o}=e,s=i.id===Er?u.MAIN:u.AUXILIARY;this._log.debug(`ontrack ${s} ${o.kind}`);let n=u.AUDIO;o.kind===u.VIDEO&&(n=s===u.MAIN?u.VIDEO:u.AUXILIARY);let a=this.remoteAudioTrack;n===u.VIDEO?a=this.remoteVideoTrack:n===u.AUXILIARY&&(a=this.remoteAuxiliaryTrack),a.setMediaStream(i),a.setMediaStreamTrack(o)}addRRTRLine(e){let i=e.split(`\r
`),o=new Map;i.forEach((n,a)=>{/^a=rtcp-fb:/.test(n)&&i[a+1]&&!/^a=rtcp-fb:/.test(i[a+1])&&o.set(a+1,`${n.match(/^a=rtcp-fb:\d+/)[0]} rrtr`)});let s=[...o];for(let n=0;n<s.length;n++){let[a,c]=s[n];i.splice(a+n,0,c)}return i.join(`\r
`)}addSPSDescription(e){let i=oe(e);return i.media.forEach(o=>{o.type===u.VIDEO&&o.fmtp.forEach(s=>{s.config+=";sps-pps-idr-in-keyframe=1"})}),Pe(i)}removeSDESDescription(e){let i=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],o=oe(e);return o.media.forEach(s=>{!s.ext||(s.ext=s.ext.filter(n=>!i.includes(n.uri)))}),Pe(o)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,i){return _(this,null,function*(){var o,s;try{if((((o=this._peerConnection)==null?void 0:o.connectionState)===q.NEW||((s=this._peerConnection)==null?void 0:s.connectionState)===q.CONNECTING)&&(yield this.waitForPeerConnectionConnected()),this.isSubscriptionStateNotChanged(e)){this._peerConnection||(this.initialize(),yield this.connect(e));return}if(this._log.info(`subscribe ${i} ${JSON.stringify(e)}`),this._peerConnection||this._isSDPExchanging){let n="subscribe_change";Object.values(e).find(a=>a===!0)||(n="unsubscribe"),yield this.sendSubscription(n,e)}else this.initialize(),yield this.connect(e)}catch(n){throw this._room.isJoined&&this.isStreamUnpublished(i)?(this._log.warn(`${n.message} ${JSON.stringify(this.muteState)}`),new A({code:T.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId} unpublished stream`})):n}})}unsubscribe(o){return _(this,arguments,function*({remoteTracks:e,streamType:i}){if(this._currentState==="CONNECTED"&&(i==="main"&&!this.isMainStreamSubscribed||i==="auxiliary"&&!this.isAuxStreamSubscribed)){this._log.info(`${i} stream already unsubscribed`);return}let s=R({},this.subscribeState);e.forEach(a=>{switch(a.mediaType){case 1:s.audio=!1;break;case 4:s.video=!1;break;case 8:s.smallVideo=!1;break;case 2:s.auxiliary=!1;break;default:break}});let n="subscribe_change";Object.values(s).find(a=>a===!0)||(n="unsubscribe"),this._log.info(`${n==="unsubscribe"?n:"subscribe"} ${i} [${as(s)}]`),yield this.sendSubscription(n,s),n==="unsubscribe"&&(this.remoteAudioTrack.setMediaStreamTrack(null),this.remoteVideoTrack.setMediaStreamTrack(null),this.remoteAuxiliaryTrack.setMediaStreamTrack(null),this.closePeerConnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"))})}sendSubscription(e,i=this.subscribeState){let o={srcTinyId:this.tinyId,srcUserId:this.userId},s=G.UNSUBSCRIBE,n=V.UNSUBSCRIBE_RESULT;return e==="subscribe_change"&&(o={audio:i.audio,bigVideo:i.video,auxVideo:i.auxiliary,smallVideo:i.smallVideo,srcTinyId:this.tinyId},s=G.SUBSCRIBE_CHANGE,n=V.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:s,data:o,responseCommand:n,timeout:1e4}).then(({data:a})=>{if(a.code!==0){let c=new A({code:a.code,message:y({key:C.ERROR_MESSAGE,data:{type:e,message:a.message}})});throw this._log.error(c),c}})}connect(){return _(this,arguments,function*(e=this.subscribeState){try{yield this.exchangeSDP(e),yield this.waitForPeerConnectionConnected()}catch(i){throw this.closePeerConnection(!0),i}})}exchangeSDP(e){return _(this,null,function*(){try{this._isSDPExchanging=!0,yield this.createOffer(),this._log.info("createOffer success, sending offer");let{type:i,sdp:o}=this._peerConnection.localDescription,s={type:i,sdp:o,srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo},n=yield this._signalChannel.sendWaitForResponse({command:G.SUBSCRIBE,commandDesc:"exchange sdp",data:s,responseCommand:V.SUBSCRIBE_RESULT,timeout:xs});if(!this._peerConnection){let a=new A({code:T.INVALID_OPERATION,message:y({key:C.CONNECTION_CLOSED})});throw this._log.warn(a),a}yield this.onSubscribeResult(n),this._isSDPExchanging=!1}catch(i){throw this._isSDPExchanging=!1,i}})}createOffer(){return _(this,null,function*(){let e={voiceActivityDetection:!1};yt()&&this._sdpSemantics===At?(this._peerConnection.addTransceiver(u.AUDIO,{direction:W.RECVONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:W.RECVONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:W.RECVONLY})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);let i=yield this._peerConnection.createOffer(e);if(i.sdp){let{isH264DecodeSupported:o}=yield Lo();o||(this._log.warn("remove h264 desc from sdp"),i.sdp=Td(i.sdp)),i.sdp=this.addRRTRLine(i.sdp),i.sdp=this.addSPSDescription(i.sdp),i.sdp=fd(i.sdp),this._sdpSemantics===At&&(i.sdp=this.removeSDESDescription(i.sdp))}yield this._peerConnection.setLocalDescription(i)})}onSubscribeResult(e){return _(this,null,function*(){let{code:i,message:o=""}=e&&e.data||{},{type:s,sdp:n}=e&&e.data&&e.data.data||{};if(i===Yt)throw new A({code:T.NOT_SUPPORTED_H264,message:y({key:C.NOT_SUPPORTED_H264DECODE})});try{if(i!==0)throw new A({code:i,message:y({key:C.EXCHANGE_SDP_FAILED,data:{errMsg:o}})});this._log.debug(`accept remote answer: ${n}`),yield this._peerConnection.setRemoteDescription({type:s,sdp:n}),this._sei&&(this._sei.handleEncodedStreams(),this._sei.onSEIMessage=a=>{this._emitter.emit("sei-message",k(R({},a),{userId:this.userId}))}),this.updateSSRC(n)}catch(a){throw this._log.error(a),a}})}updateSSRC(e){try{oe(e).media.forEach(o=>{if(!!o.ssrcs)if(o.type===u.AUDIO){let s=o.ssrcs.find(n=>{var a;return(a=n.value)==null?void 0:a.includes(Er)});s&&(this.ssrc.audio=Number(s.id))}else{let s=o.ssrcs.find(a=>{var c;return(c=a.value)==null?void 0:c.includes(Er)}),n=o.ssrcs.find(a=>{var c;return(c=a.value)==null?void 0:c.includes(Ms)});s&&(this.ssrc.video=Number(s.id)),n&&(this.ssrc.auxiliary=Number(n.id))}})}catch(i){}}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}reconnect(){return _(this,null,function*(){if(!(Bt(Ea.prototype,this,"beforeReconnect").call(this)<0))try{this.closePeerConnection(),this.initialize(),yield this.connect(),this.stopReconnection(),this._log.warn("reconnect() success")}catch(i){let o=ye(this._reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${o/1e3}s`),this._reconnectionTimer=setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},o)}})}getIsReconnecting(){return this._isReconnecting}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}getCurrentState(){return this._currentState}setDelay({audioDelay:e,videoDelay:i}){this.remoteAudioTrack.stat.end2EndDelay=e,this.remoteVideoTrack.stat.end2EndDelay=i}},$r=Ea;N([H(r=>function(...t){return new Promise((e,i)=>{let o=s=>{this._emitter.off("closed",o),i(new A({code:T.API_CALL_ABORTED,message:y({key:C.CONNECTION_ABORTED,data:s})}))};this._emitter.on("closed",o),r.apply(this,t).then(e,i).finally(()=>{this._emitter.off("closed",o)})})})],$r.prototype,"subscribe",1),N([Bo(Ne.prototype.afterConnect),xo(Ne.prototype.beforeConnect)],$r.prototype,"connect",1);var pa=$r;var lh="let width,height,offscreen,ctx;onmessage=function(e){const{action,data}=e.data;switch(action){case'render':offscreen=data.canvas;width=offscreen.width;height=offscreen.height;ctx=offscreen.getContext('2d');draw(data.readable,data.writable);break}};function draw(readable,writable){const transformer=new TransformStream({async transform(cameraFrame,controller){ctx.drawImage(cameraFrame,0,0,width,height);const frame=new VideoFrame(offscreen,{timestamp:cameraFrame.timestamp});cameraFrame.close();controller.enqueue(frame)}});readable.pipeThrough(transformer).pipeTo(writable)}",uh=new Blob([lh],{type:"application/javascript"}),fa=class{constructor(t){d(this,"width");d(this,"height");d(this,"canvas");d(this,"offscreen");d(this,"smallGenerator");d(this,"smallWritable");d(this,"bigProcessor");d(this,"bigReadable");d(this,"worker");let{videoTrack:e}=t;this.width=void 0,this.height=void 0,this.canvas=null,this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:e}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(uh)),g.info("init worker processor success")}catch(t){g.warn(`init worker processor failed. ${t.error}`)}}setCanvasRect(t,e){this.width=t,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generateVideoTrack(){let t=new MediaStream([this.smallGenerator]);return t==null?void 0:t.getTracks()[0]}destroy(){this.worker.terminate()}},Sd=fa;var Ta=class{constructor(t){d(this,"_player");d(this,"_canvas");d(this,"_canvasCtx");this._player=t,this._canvas=document.createElement("canvas"),this._canvasCtx=this._canvas.getContext("2d")}setCanvasRect(t,e){!this._canvas||(this._canvas.width=t,this._canvas.height=e)}drawVideoToCanvas(){let t=this._player.getElement();this._canvas&&this._canvasCtx&&t&&this._canvasCtx.drawImage(t,0,0,this._canvas.width,this._canvas.height)}generateVideoTrack(t){return this._canvas.captureStream(t).getVideoTracks()[0]}generateStreamFromTrack(t){let e=new MediaStream;return e.addTrack(t),e}destroy(){var t;(t=this._player)==null||t.stop(),this._canvas&&(this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._canvasCtx=null)}get canvas(){return this._canvas}get canvasCtx(){return this._canvasCtx}get canDrawVideoToCanvas(){if(this._player){let t=this._player.getElement();if(t)return t.readyState===t.HAVE_ENOUGH_DATA}return!1}},Ia=Ta;var Sa=class{constructor(t){d(this,"_player");d(this,"_processor");d(this,"_initOffscreenSuccess");d(this,"_localVideoTrack");d(this,"_interval");this._localVideoTrack=t,this._player=t.player,this._processor=null,this._initOffscreenSuccess=!1}initialize(){return _(this,null,function*(){if(qs()&&(navigator==null?void 0:navigator.hardwareConcurrency)>=6)try{yield this.initOffscreen(),this._initOffscreenSuccess=!0,g.info("Initialize VideoGenerator successfully!")}catch(t){this.initCanvas()}else this.initCanvas()})}generateSmallVideoTrack(t){let e=this.getSmallVideoProfile(t),i;return this._initOffscreenSuccess?(this._processor.setCanvasRect(e.width,e.height),i=this._processor.generateVideoTrack(e.frameRate)):(this._processor.setCanvasRect(e.width,e.height),this._player.setRect(e.width,e.height),i=this._processor.generateVideoTrack(e.frameRate),this._interval=z.run(rt,this.render.bind(this),{fps:e.frameRate})),i}render(){this._processor instanceof Ia&&this._processor.drawVideoToCanvas()}destroy(){z.clearTask(this._interval),this._processor&&this._processor.destroy()}initOffscreen(){this._processor=new Sd({videoTrack:this._localVideoTrack.mediaTrack})}initCanvas(){this._player=new ei({track:this._localVideoTrack.mediaTrack,muted:!0,objectFit:"cover",mirror:!1,container:null,id:"video-player",log:this._localVideoTrack.log}),this._player.play().then(()=>{g.info("VideoGenerator: play local video success")}).catch(()=>{g.error("VideoGenerator: Failed to play local video")}),this._processor=new Ia(this._player)}getSmallVideoProfile(t){let e=this._localVideoTrack.mediaTrack,i=this._localVideoTrack.profile;if(st){let c=e.getSettings();c&&c.width&&c.height&&(i.width=c.width,i.height=c.height)}let o,s=i.width*i.height,n=t.width*t.height;return g.info(`big res: ${i.width}*${i.height} small res: ${t.width}*${t.height} `),s>n?o=s/n:(g.warn(`Small stream resolution is larger than big stream, which is invalid. big: ${i.width} * ${i.height} small: ${t.width} * ${t.height}`),o=s/(160*120)),{width:i.width/Math.sqrt(o),height:i.height/Math.sqrt(o),frameRate:t.frameRate}}},mt=Sa;var gd={voiceActivityDetection:!1},ga=class extends Ne{constructor(e){super(k(R({},e),{isUplink:!0}));d(this,"localMainAudioTrack",null);d(this,"localMainVideoTrack",null);d(this,"localAuxAudioTrack",null);d(this,"localAuxVideoTrack",null);d(this,"ssrc",{audio:0,video:0,small:0,auxiliary:0});d(this,"_isPublishingAux",!1);d(this,"_publishingLocalAudioTrack");d(this,"_publishingLocalVideoTrack");d(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0});d(this,"_smallGenerator");d(this,"_audioManager");this._audioManager=e.audioManager,this._smallGenerator=null}get isMainStreamPublished(){return!!(this.localMainAudioTrack||this.localMainVideoTrack)}get isAuxStreamPublished(){return!!(this.localAuxVideoTrack||this.localAuxAudioTrack)}get publishState(){var i,o,s,n;let e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let a=this._peerConnection.getSenders();a&&(be()?(e.audio=!!((i=a[0])!=null&&i.track),e.bigVideo=!!((o=a[1])!=null&&o.track),e.smallVideo=!!((s=a[2])!=null&&s.track),e.auxVideo=!!((n=a[3])!=null&&n.track)):a.forEach(c=>{c.track&&(c.track.kind===u.AUDIO?e.audio=!0:(e.bigVideo=!0,this._smallGenerator&&(e.smallVideo=!0)))}))}return e}initialize(){super.initialize(),this.installEvents()}reset(){this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){this._emitter.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this._emitter.on("connection-state-changed",this.handleConnectionStateChange,this)}uninstallEvents(){this._emitter.off("connection-state-changed",this.handleConnectionStateChange,this)}emitConnectionStateChangedEvent(e,i){var n,a,c;let o=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&o!==e&&(i?i.emit("connection-state-changed",{prevState:o,state:e}):((n=this.localMainVideoTrack)==null||n.emit("connection-state-changed",{prevState:o,state:e}),(a=this.localAuxVideoTrack)==null||a.emit("connection-state-changed",{prevState:o,state:e}),(c=this._publishingLocalVideoTrack)==null||c.emit("connection-state-changed",{prevState:o,state:e}))),s}publish(s){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,isAuxiliary:o}){var a;this._peerConnection||this.initialize(),e&&(this._publishingLocalAudioTrack=e),i&&(this._publishingLocalVideoTrack=i),this._isPublishingAux=o;let n;i&&!o&&i.small&&(this._smallGenerator=new mt(i),yield this._smallGenerator.initialize(),n=this._smallGenerator.generateSmallVideoTrack(i.small)),this.sendMediaSettings(),yt()?yield this.publishByTransceiver({localAudioTrack:e,localVideoTrack:i,smallTrack:n,isAuxiliary:o}):yield this.publishByAddTrack({localAudioTrack:e,localVideoTrack:i,smallTrack:n}),this._publishingLocalAudioTrack=null,this._publishingLocalVideoTrack=null,this._isPublishingAux=!1,o?(i&&(this.localAuxVideoTrack=i),e&&(this.localAuxAudioTrack=e)):(i&&(this.localMainVideoTrack=i),e&&(this.localMainAudioTrack=e)),(a=this._sei)==null||a.handleEncodedStreams(),this.installTrackMuteEvents(e,i),this.sendMutedFlag()})}publishByTransceiver(n){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,smallTrack:o,isAuxiliary:s}){this._log.info("publish by transceiver");let a=new MediaStream;i&&Ht&&ur&&i.genCanvasTrack();let c=(i==null?void 0:i.canvasTrack)||(i==null?void 0:i.mediaTrack),l=this._audioManager.mediaStreamTrack;l&&a.addTrack(l),c&&a.addTrack(c);let h=this._peerConnection.getTransceivers();if(h.length===0)this._peerConnection.addTransceiver(l||u.AUDIO,{direction:W.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(s?u.VIDEO:c||u.VIDEO,{direction:W.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(o||u.VIDEO,{direction:W.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(s?c||u.VIDEO:u.VIDEO,{direction:W.SENDONLY,streams:[a]}),yield this.connect();else{let m=[];if(l&&(h[0].sender.track||m.push(0),yield h[0].sender.replaceTrack(l),yield this.setBandwidth({bandwidth:(e==null?void 0:e.profile.bitrate)||40,type:u.AUDIO})),c){let f=s?3:1;yield h[f].sender.replaceTrack(c),yield this.setBandwidth({bandwidth:i.profile.bitrate,type:u.VIDEO,videoType:s?u.AUXILIARY:u.BIG}),m.push(f),o&&(yield h[2].sender.replaceTrack(o),yield this.setBandwidth({bandwidth:i.small.bitrate,type:u.VIDEO,videoType:u.SMALL}),m.push(2))}yield this.setTransceiverDirection(W.SENDONLY,m),yield this.doPublishChange(),i==null||i.emit("connection-state-changed",{prevState:"DISCONNECTED",state:"CONNECTING"}),i==null||i.emit("connection-state-changed",{prevState:"CONNECTING",state:"CONNECTED"})}})}publishByAddTrack(s){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,smallTrack:o}){this._log.info("publish by addtrack");let n=i==null?void 0:i.mediaTrack,a=e!=null&&e.mediaTrack?this._audioManager.mediaStreamTrack:null;if(this._peerConnection&&this._peerConnection.connectionState!=="new"){a&&(yield this.addTrack(e)),n&&(yield this.addTrack(i));return}let c=new MediaStream;if(a&&c.addTrack(a),n&&c.addTrack(n),a&&this._peerConnection.addTrack(a,c),n&&(this._peerConnection.addTrack(n,c),o)){let l=new MediaStream;l.addTrack(o),this._peerConnection.addTrack(o,l)}yield this.connect()})}installTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.on("mute",this.sendMutedFlag,this),i==null||i.on("unmute",this.sendMutedFlag,this))})}uninstallTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.off("mute",this.sendMutedFlag,this),i==null||i.off("unmute",this.sendMutedFlag,this))})}unpublish(o){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i}){if(!be()){if(e&&e.mediaTrack&&!i&&this.localMainVideoTrack){yield this.removeTrack(e),this.localMainAudioTrack=null;return}if(i&&i.mediaTrack&&!e&&this.localMainAudioTrack){yield this.removeTrack(i),this.localMainVideoTrack=null;return}yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,i),this.emitConnectionStateChangedEvent("DISCONNECTED",i);return}let s=i&&i===this.localAuxVideoTrack,n=e==null?void 0:e.mediaTrack,a=i==null?void 0:i.mediaTrack,c=this._peerConnection.getSenders(),l=[];n&&(this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield c[0].replaceTrack(null),l.push(0),this.localMainAudioTrack=null)),a&&(s?(yield c[3].replaceTrack(null),this.localAuxVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),l.push(3)):(yield c[1].replaceTrack(null),yield c[2].replaceTrack(null),this.localMainVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),l.push(1,2))),this.isMainStreamPublished||this.isAuxStreamPublished?(yield this.setTransceiverDirection(W.INACTIVE,l),yield this.doPublishChange(!1)):yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,i),i==null||i.emit("connection-state-changed",{prevState:this._currentState,state:"DISCONNECTED"})})}doPublishChange(e=!0){return _(this,null,function*(){let i={state:this.publishState,constraintConfig:this._mediaSettings},o=yield this._signalChannel.sendWaitForResponse({command:G.PUBLISH_STATE_CHANGE,data:i,responseCommand:V.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(o.data.code,o.data.message)})}doUnpublish(e=!1){return this._signalChannel.sendWaitForResponse({command:G.UNPUBLISH,commandDesc:"unpublish",responseCommand:V.UNPUBLISH_RESULT,enableLog:e}).catch(i=>{if(i.getCode()===T.API_CALL_TIMEOUT)return Promise.resolve();throw i})}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:i}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":i&&(this._mediaSettings.videoCodec="VP8");let o=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:s,localAuxVideoTrack:n}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?n=this._publishingLocalVideoTrack:s=this._publishingLocalVideoTrack),st){if(o&&o.mediaTrack){let a=o.mediaTrack.getSettings();this._mediaSettings.audioChannel=a.channelCount||1,this._mediaSettings.audioBps=o.profile.bitrate*1e3,this._mediaSettings.audioFs=a.sampleRate||0}if(s&&s.mediaTrack){let a=s.mediaTrack.getSettings();this._mediaSettings.videoWidth=a.width||0,this._mediaSettings.videoHeight=a.height||0,this._mediaSettings.videoFps=a.frameRate||0,this._mediaSettings.videoBps=s.profile.bitrate*1e3,s.small&&(this._mediaSettings.smallVideoWidth=s.small.width,this._mediaSettings.smallVideoHeight=s.small.height,this._mediaSettings.smallVideoFps=s.small.frameRate,this._mediaSettings.smallVideoBps=s.small.bitrate*1e3)}if(n&&n.mediaTrack){let a=n.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=a.width||0,this._mediaSettings.auxVideoHeight=a.height||0,this._mediaSettings.auxVideoFps=a.frameRate||0,this._mediaSettings.auxVideoBps=n.profile.bitrate*1e3}}else o&&o.mediaTrack&&(this._mediaSettings.audioChannel=o.profile.channelCount,this._mediaSettings.audioBps=o.profile.bitrate*1e3,this._mediaSettings.audioFs=o.profile.sampleRate),s&&s.mediaTrack&&(this._mediaSettings.videoWidth=s.profile.width,this._mediaSettings.videoHeight=s.profile.height,this._mediaSettings.videoFps=s.profile.frameRate,this._mediaSettings.videoBps=s.profile.bitrate*1e3);this._log.info(`updateMediaSettings: ${JSON.stringify(this._mediaSettings)}`)}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:G.UPDATE_CONSTRAINT_CONFIG,data:this._mediaSettings,responseCommand:V.UPDATE_CONSTRAINT_CONFIG_RES}).then(e=>{e.data.code!==0&&this._log.warn(e.data.message)}).catch(()=>{})}addTrack(e){return _(this,null,function*(){var o;if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is adding ${e.kind} track to current published local ${i?u.AUXILIARY:u.MAIN} stream`),(o=this._sei)==null||o.handleEncodedStreams(),be()?yield this.addTrackByTransceiver(e,i):yield this.addTrackBySender(e)})}addTrackByTransceiver(e,i){return _(this,null,function*(){var n;if(!e.mediaTrack)return;let o=this._peerConnection.getTransceivers(),s=e.mediaTrack;if(e.kind===u.AUDIO)this._audioManager.addAudioTrack(e),s=this._audioManager.mediaStreamTrack,yield o[0].sender.replaceTrack(s);else{let a=i?3:1;if(yield o[a].sender.replaceTrack(s),a===1&&((n=this.localMainVideoTrack)==null?void 0:n.small)){this._smallGenerator=new mt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let c=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield o[2].sender.replaceTrack(c)}o[a].direction===W.INACTIVE&&(yield this.setTransceiverDirection(W.SENDONLY,[a]))}this.updateMediaSettings(),yield this.doPublishChange()})}addTrackBySender(e){return _(this,null,function*(){if(!e.mediaTrack)return;let i=e.mediaTrack;be()&&this._peerConnection.getTransceivers().findIndex(n=>n.direction==="stopped")>=0&&(this._log.warn("transceiver is stopping, negotiate sdp first"),yield this.updateOffer("remove",i));let o=this._peerConnection.getSenders().find(n=>n.track&&n.track.kind===i.kind);if(o&&o.track){this._log.warn("sender already exists, remove sender first");let n=o.track;this.removeSender(o),yield this.updateOffer("remove",n)}let{mediaStream:s}=e;if(this._peerConnection.addTrack(i,s),i.kind===u.VIDEO&&e instanceof Be&&e.small){this._smallGenerator=new mt(e),yield this._smallGenerator.initialize();let n=this._smallGenerator.generateSmallVideoTrack(e.small),a=new MediaStream;a.addTrack(n),this._peerConnection.addTrack(n,a)}yield this.updateOffer("add",i)})}isNeedToResetOfferOrder(){if(this._sdpSemantics===bi||!this._peerConnection||!this._peerConnection.localDescription)return!1;let{sdp:e}=this._peerConnection.localDescription,i=oe(e);for(let o=0;o<i.media.length;o++)if(Number(i.media[o].mid)===0&&i.media[o].type===u.VIDEO)return!0;return!1}removeSender(e){let i=null;be()&&(i=this._peerConnection.getTransceivers().find(o=>o.sender&&o.sender.track===e.track)),this._peerConnection.removeTrack(e),i&&K(i.stop)&&(this._log.info("stop transceiver"),i.stop())}removeTrack(e){return _(this,null,function*(){if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is removing ${e.kind} track from current published local ${i?u.AUXILIARY:u.MAIN} stream`),be()?yield this.removeTrackByTransceiver(e,i):yield this.removeTrackBySender(e)})}removeTrackByTransceiver(e,i){return _(this,null,function*(){if(!e.mediaTrack)return;let o=this._peerConnection.getTransceivers();if(e.kind===u.AUDIO)this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield o[0].sender.replaceTrack(null));else{let s=i?3:1;yield o[s].sender.replaceTrack(null),s===1&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield o[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(W.INACTIVE,[s])}this.updateMediaSettings(),yield this.doPublishChange()})}setTransceiverDirection(e,i){return _(this,null,function*(){if(!Y)return;let o=!1,s=!1;this._log.info(`setting transceiver ${i.join(",")} direction to ${e}`);let n=this._peerConnection.getTransceivers();if(i.forEach(l=>{n[l].direction!==e&&(n[l].direction=e,o=!0)}),o){this._log.info("updating offer");let l=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(l)}let a=-1,c=this._peerConnection.remoteDescription.sdp.split(`\r
`).map(l=>{if(l.match(new RegExp(`a=(${W.INACTIVE}|${W.RECVONLY}|${W.SENDONLY})`))&&a++,i.includes(a)){if(e===W.INACTIVE&&l.includes(`a=${W.RECVONLY}`))return s=!0,`a=${e}`;if(e===W.SENDONLY&&l.includes(`a=${W.INACTIVE}`))return s=!0,`a=${W.RECVONLY}`}return l}).join(`\r
`);s&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:c}))})}removeTrackBySender(e){return _(this,null,function*(){var o,s;if(!e.mediaTrack)return;if(e.kind===u.VIDEO&&this.isNeedToResetOfferOrder()&&this.localMainAudioTrack){this.reset(),this.initialize(),(s=(o=this.localMainVideoTrack)==null?void 0:o.mediaStream)==null||s.removeTrack(e.mediaTrack),yield this.publish({localAudioTrack:this.localMainAudioTrack,isAuxiliary:!1});return}let i=this._peerConnection.getSenders().find(n=>n.track===e.mediaTrack);i&&(this.removeSender(i),e.kind===u.VIDEO&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,this._peerConnection.getSenders().forEach(n=>{n.track&&n.track.kind===u.VIDEO&&this.removeSender(n)}))),yield this.updateOffer("remove",e.mediaTrack)})}replaceTrack(e){return _(this,null,function*(){var n,a;let i=(n=this._peerConnection)==null?void 0:n.getSenders();if(!i||i.length===0||!e.mediaTrack)return;let o=e.mediaTrack,s=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;if(this._log.info(`is replacing ${o.kind} track on ${s?u.AUXILIARY:u.MAIN} stream`),o.kind===u.AUDIO&&i[0])this._audioManager.addAudioTrack(e),this._audioManager.isMixed&&(o=this._audioManager.mediaStreamTrack),yield i[0].replaceTrack(o);else if(o.kind===u.VIDEO){if(!s&&i[1]&&(yield i[1].replaceTrack(o),this._smallGenerator&&i[2])){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new mt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let c=this._smallGenerator.generateSmallVideoTrack(((a=this.localMainVideoTrack)==null?void 0:a.small)||this._room.smallStreamConfig);yield i[2].replaceTrack(c)}s&&i[3]&&(yield i[3].replaceTrack(o))}})}updateOffer(e,i){return _(this,null,function*(){try{let o=yield this._peerConnection.createOffer(gd);Y&&o.sdp&&(o.sdp=this.setSDPDirection(o.sdp,"sendrecv")),yield this._peerConnection.setLocalDescription(o);let s=this.updateMediaSettings(),n={action:e,trackId:i.id,kind:i.kind===u.VIDEO?"bigVideo":i.kind,type:"offer",sdp:this._peerConnection.localDescription.sdp,constraintConfig:s,state:this.publishState};this._log.info("createOffer success, sending updated offer to remote server"),this._log.debug(`updatedOffer: ${n.sdp}`);let a=yield this._signalChannel.sendWaitForResponse({command:G.PUBLISH_CHANGE,data:n,responseCommand:V.UPDATE_OFFER_RESULT,timeout:Us,commandDesc:"update offer"}),{code:c,message:l}=a.data;c!==0&&this.checkPublishResultCode(c,l),yield this.acceptAnswer(a.data.data),o.sdp&&this.updateSSRC(o.sdp)}catch(o){throw this._log.error(o),o}})}setBandwidth(n){return _(this,arguments,function*({bandwidth:e,type:i,videoType:o,sdp:s}){if(!Nr())return s?i===u.VIDEO?this.updateVideoBandwidthRestriction(s,e,o):this.updateAudioBandwidthRestriction(s,e):void 0;let a=0;i===u.VIDEO&&(o===u.SMALL?a=2:o===u.AUXILIARY?a=3:a=1);let c=this._peerConnection.getSenders()[a];if(c){let l=c.getParameters();(!l.encodings||l.encodings.length===0)&&(l.encodings=[{}]),l.encodings[0].maxBitrate=e*1e3;try{return yield c.setParameters(l),this._log.info(`${o||""}${i} bandwidth ${e} kbps`),s}catch(h){if(this._log.info(`failed to set bandwidth by setting maxBitrate: ${h}`),s)return i===u.VIDEO?this.updateVideoBandwidthRestriction(s,e,o):this.updateAudioBandwidthRestriction(s,e)}}return s})}updateVideoBandwidthRestriction(e,i,o){let s="AS";Y&&(s="TIAS",i=i*1e3);let n=0,a=-1;return o===u.SMALL?n=1:o===u.AUXILIARY&&(n=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,c=>(a+=1,a===n?`${c}b=${s}:${i}\r
`:c)),e}updateAudioBandwidthRestriction(e,i){let o="AS";return Y&&(o="TIAS",i=i*1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,`m=audio $1\r
c=IN $2\r
b=${o}:${i}\r
`),e}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}connect(){return _(this,null,function*(){try{yield this.exchangeSDP(),yield this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),this.uninstallEvents(),e}})}exchangeSDP(){return _(this,null,function*(){try{yield this.createOffer(),this._log.info("createOffer success, sending offer to remote server"),yield this.doExchangeSDP()}catch(e){throw e}})}createOffer(){return _(this,null,function*(){try{let e=yield this._peerConnection.createOffer(gd);yield this._peerConnection.setLocalDescription(e),e.sdp&&this.updateSSRC(e.sdp)}catch(e){throw e}})}doExchangeSDP(){let e={command:G.PUBLISH,responseCommand:V.PUBLISH_RESULT,data:{type:this._peerConnection.localDescription.type,sdp:this.removeVideoOrientation(this._peerConnection.localDescription.sdp),screen:this.localMainVideoTrack instanceof Qe||this.localAuxVideoTrack instanceof Qe,state:this.publishState,constraintConfig:this._mediaSettings},enableLog:!1};return this._log.debug(`sending sdp offer: ${e.data.sdp}`),this._signalChannel.sendWaitForResponse(e).then(i=>{let{code:o,message:s,data:n}=i.data;return o===0?this.acceptAnswer(n):this.checkPublishResultCode(o,s)})}setSDPDirection(e,i,o="all"){let s=oe(e);return s.media.forEach(n=>{(o==="all"||n.type===o)&&(n.direction=i)}),Pe(s)}acceptAnswer(e){return _(this,null,function*(){var i,o,s,n,a;try{let c;if(this._publishingLocalAudioTrack||this._publishingLocalVideoTrack||this.isMainStreamPublished){let m=((i=this._publishingLocalVideoTrack)==null?void 0:i.profile.bitrate)||((o=this.localMainVideoTrack)==null?void 0:o.profile.bitrate),f=((s=this._publishingLocalAudioTrack)==null?void 0:s.profile.bitrate)||((n=this.localMainAudioTrack)==null?void 0:n.profile.bitrate);if(m){let L=this._isPublishingAux?u.AUXILIARY:u.BIG;c=yield this.setBandwidth({bandwidth:m,type:u.VIDEO,sdp:c,videoType:L})}f&&(c=yield this.setBandwidth({bandwidth:f,type:u.AUDIO,sdp:c}))}if(c=this.removeVideoOrientation(e.sdp),(a=this._publishingLocalVideoTrack)!=null&&a.small){let{smallStreamConfig:m}=this._room;c=yield this.setBandwidth({bandwidth:this._publishingLocalVideoTrack.small.bitrate||m.bitrate,type:u.VIDEO,videoType:u.SMALL,sdp:c})}let h={type:e.type,sdp:c};yield this._peerConnection.setRemoteDescription(h),this._log.debug(`accepted answer: ${c}`)}catch(c){throw this._log.error(`failed to accept remote answer ${c}`),c}})}sendMutedFlag(e){var s,n,a;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let o={audio:!!((s=this.localMainAudioTrack)!=null&&s.muted),bigVideo:!!((n=this.localMainVideoTrack)!=null&&n.muted),auxVideo:!!((a=this.localAuxVideoTrack)!=null&&a.muted)};this._log.info(`send muted state: ${JSON.stringify(o)}`),this._signalChannel.send(G.UPDATE_MUTE_STAT,o)}getIsReconnecting(){return this._isReconnecting}reconnect(){return _(this,null,function*(){if(!(Bt(ga.prototype,this,"beforeReconnect").call(this)<0))try{yield this._signalChannel.sendWaitForResponse({command:G.UNPUBLISH,responseCommand:V.UNPUBLISH_RESULT,enableLog:!1}),this.closePeerConnection(),this.initialize(),this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0})),this._log.warn("reconnect() uplink reconnect successfully"),this.stopReconnection()}catch(i){let o=ye(this._reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${o/1e3}s`),this._reconnectionTimer=setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},o)}})}handleConnectionStateChange(e){e.state==="CONNECTED"&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&E.emit(p.SEND_FIRST_VIDEO_FRAME,{room:this._room})}updateSSRC(e){try{oe(e).media.forEach((o,s)=>{if(o.type===u.AUDIO){let n=o.ssrcs&&o.ssrcs[0];n&&(this.ssrc.audio=Number(n.id))}else{if(this._sdpSemantics===bi&&o.ssrcGroups){o.ssrcGroups.forEach((a,c)=>{let l=Number(a.ssrcs.split(" ")[0]);c===0?this.ssrc.video=l:c===1&&(this.ssrc.small=l)});return}let n=o.ssrcs&&o.ssrcs[0];if(!n)return;switch(s){case 1:this.ssrc.video=Number(n.id);break;case 2:this.ssrc.small=Number(n.id);break;case 3:this.ssrc.auxiliary=Number(n.id);break;default:break}}})}catch(i){}}getVideoTrackId(e=u.VIDEO){if(this._peerConnection){let i=this._peerConnection.getSenders();if(e===u.AUXILIARY&&i[3]&&i[3].track)return i[3].track.id;if(e===u.VIDEO&&i[1]&&i[1].track)return i[1].track.id}if(this.localMainVideoTrack&&e===u.VIDEO){let i=this.localMainVideoTrack.mediaTrack;if(i)return i.id}if(this.localAuxVideoTrack&&e===u.AUXILIARY){let i=this.localAuxVideoTrack.mediaTrack;if(i)return i.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,i){if(e!==0)throw e===Yt?(this._log.error(ue.NOT_SUPPORTED_H264ENCODE),new A({code:T.NOT_SUPPORTED_H264,message:y({key:C.NOT_SUPPORTED_H264ENCODE})})):new A({code:T.UNKNOWN,message:y({key:C.SIGNAL_RESPONSE_FAILED,data:{signalResponse:V.PUBLISH_RESULT,code:e,message:i}})})}sendSEI(e,i){var o;(o=this._sei)==null||o.push(e,i)}},Hr=ga;N([H(r=>function(...t){return new Promise((e,i)=>{let o=s=>{this._emitter.off("closed",o),i(new A({code:T.API_CALL_ABORTED,message:y({key:C.CONNECTION_ABORTED,data:s})}))};this._emitter.on("closed",o),r.apply(this,t).then(e,i).finally(()=>{this._emitter.off("closed",o)})})})],Hr.prototype,"publish",1),N([Bo(Ne.prototype.afterConnect),xo(Ne.prototype.beforeConnect)],Hr.prototype,"connect",1);var cs=Hr;var Fr=class{constructor(t,e){this.room=t;d(this,"_log");d(this,"_prevReportTime");d(this,"_prevReport",{});d(this,"_prevEncoderImplementation");d(this,"_prevQualityLimitationReason");d(this,"_prevAuxQualityLimitationReason");d(this,"_prevDecoderImplementationMap",new Map);d(this,"_spcStats",null);this._log=e,this._prevReportTime=0,this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevAuxQualityLimitationReason=""}get statInterval(){return this._prevReportTime===0?2:(Date.now()-this._prevReportTime)/1e3}getSenderStats(t){return _(this,null,function*(){let e={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},i=t.getPeerConnection(),o=t.getSSRC();if(i)try{if((this._spcStats||(yield i.getStats())).forEach(n=>{if(n.type==="outbound-rtp")if(n.mediaType===u.VIDEO){let a;if(n.ssrc===o.video?a=u.VIDEO:n.ssrc===o.small?a=u.SMALL:n.ssrc===o.auxiliary&&(a=u.AUXILIARY),!a)return;e[a].bytesSent=n.bytesSent,e[a].packetsSent=n.packetsSent,e[a].framesEncoded=n.framesEncoded,n.ssrc===o.video?(!I(n.encoderImplementation)&&this._prevEncoderImplementation!==n.encoderImplementation&&(this._log.info(`encoderImplementation change to ${n.encoderImplementation}`),this._prevEncoderImplementation=n.encoderImplementation),!I(n.qualityLimitationReason)&&n.bytesSent!==0&&this._prevQualityLimitationReason!==n.qualityLimitationReason&&(this._log.info(`qualityLimitationReason change to ${n.qualityLimitationReason}`),this._prevQualityLimitationReason=n.qualityLimitationReason)):n.ssrc===o.auxiliary&&!I(n.qualityLimitationReason)&&n.bytesSent!==0&&this._prevAuxQualityLimitationReason!==n.qualityLimitationReason&&(this._log.info(`aux qualityLimitationReason change to ${n.qualityLimitationReason}`),this._prevAuxQualityLimitationReason=n.qualityLimitationReason)}else n.mediaType===u.AUDIO&&(e.audio.bytesSent=n.bytesSent,e.audio.packetsSent=n.packetsSent);else n.type==="candidate-pair"?Ot(n)&&J(n.currentRoundTripTime)&&(e.rtt=Math.floor(n.currentRoundTripTime*1e3)):n.type==="media-source"&&(n.kind===u.AUDIO?(e.audio.audioLevel=n.audioLevel||0,e.audio.totalAudioEnergy=n.totalAudioEnergy||0):n.kind===u.VIDEO&&(n.trackIdentifier===t.getVideoTrackId(u.VIDEO)?e.video.fpsCapture=n.framesPerSecond:n.trackIdentifier===t.getVideoTrackId(u.AUXILIARY)?e.auxiliary.fpsCapture=n.framesPerSecond:e.small.fpsCapture=n.framesPerSecond));if(I(n.audioLevel)||(e.audio.audioLevel=n.audioLevel||0),!I(n.frameWidth)){let a=u.SMALL;n.trackIdentifier===t.getVideoTrackId(u.VIDEO)||n.ssrc===o.video?a=u.VIDEO:(n.trackIdentifier===t.getVideoTrackId(u.AUXILIARY)||n.ssrc===o.auxiliary)&&(a=u.AUXILIARY),e[a].frameWidth=n.frameWidth,e[a].frameHeight=n.frameHeight,e[a].framesSent=n.framesSent}}),t.localMainAudioTrack){let n=t.localMainAudioTrack.getInternalAudioLevel();e.audio.micAudioLevel=n,e.audio.audioLevel===0&&(e.audio.audioLevel=n)}}catch(s){this._log.warn(`failed to getStats on sender connection ${s}`)}return e})}getReceiverStats(t){return _(this,null,function*(){let e={tinyId:t.tinyId,userId:t.userId,rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0,insertedSamplesForDeceleration:0,removedSamplesForAcceleration:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0}},i=t.getPeerConnection();if(i)try{let{ssrc:o}=t,{muteState:s}=t;(this._spcStats||(yield i.getStats())).forEach(a=>{if(a.type==="inbound-rtp"){if(a.mediaType===u.AUDIO&&a.ssrc===o.audio&&s.hasAudio){e.audio.packetsReceived=a.packetsReceived,e.audio.bytesReceived=a.bytesReceived,e.audio.packetsLost=a.packetsLost,a.insertedSamplesForDeceleration&&(e.audio.insertedSamplesForDeceleration=a.insertedSamplesForDeceleration),a.removedSamplesForAcceleration&&(e.audio.removedSamplesForAcceleration=a.removedSamplesForAcceleration);let{remoteAudioTrack:c}=t;c.stat.packetsReceived=a.packetsReceived,c.stat.bytesReceived=a.bytesReceived,c.stat.packetsLost=a.packetsLost,a.jitterBufferDelay&&(c.stat.jitterBufferDelay=Math.floor(a.jitterBufferDelay/a.jitterBufferEmittedCount*1e3)),e.hasAudio=!0}else if(a.mediaType===u.VIDEO){if(Y&&a.bytesReceived===0)return;let c;a.ssrc===o.video&&s.hasVideo&&(e.video.packetsReceived=a.packetsReceived,e.video.bytesReceived=a.bytesReceived,e.video.packetsLost=a.packetsLost,e.video.framesReceived=a.framesReceived,e.video.framesDecoded=a.framesDecoded,e.video.fpsDecoded=a.framesPerSecond,e.hasVideo=!0,c=t.remoteVideoTrack,a.decoderImplementation&&(!this._prevDecoderImplementationMap.has(e.userId)||this._prevDecoderImplementationMap.get(e.userId)!==a.decoderImplementation)&&(this._log.info(`${e.userId} decoderImplementation change to ${a.decoderImplementation}`),this._prevDecoderImplementationMap.set(e.userId,a.decoderImplementation))),a.ssrc===o.auxiliary&&s.hasAuxiliary&&(e.auxiliary.packetsReceived=a.packetsReceived,e.auxiliary.bytesReceived=a.bytesReceived,e.auxiliary.packetsLost=a.packetsLost,e.auxiliary.framesReceived=a.framesReceived,e.auxiliary.framesDecoded=a.framesDecoded,e.auxiliary.fpsDecoded=a.framesPerSecond,c=t.remoteAuxiliaryTrack,e.hasAuxiliary=!0),c&&(c.stat.packetsReceived=a.packetsReceived,c.stat.bytesReceived=a.bytesReceived,c.stat.packetsLost=a.packetsLost,c.stat.framesReceived=a.framesReceived,c.stat.framesDecoded=a.framesDecoded,a.jitterBufferDelay&&(c.stat.jitterBufferDelay=Math.floor(a.jitterBufferDelay/a.jitterBufferEmittedCount*1e3)))}}else a.type==="candidate-pair"&&Ot(a)&&J(a.currentRoundTripTime)&&(e.rtt=Math.floor(a.currentRoundTripTime*1e3));I(a.frameWidth)||((a.trackIdentifier===t.getMainStreamVideoTrackId()||a.ssrc===o.video)&&(e.video.frameWidth=a.frameWidth,e.video.frameHeight=a.frameHeight,t.remoteVideoTrack.stat.frameWidth=a.frameWidth,t.remoteVideoTrack.stat.frameHeight=a.frameHeight),(a.trackIdentifier===t.getAuxStreamVideoTrackId()||a.ssrc===o.auxiliary)&&(e.auxiliary.frameWidth=a.frameWidth,e.auxiliary.frameHeight=a.frameHeight,t.remoteAuxiliaryTrack.stat.frameWidth=a.frameWidth,t.remoteAuxiliaryTrack.stat.frameHeight=a.frameHeight)),I(a.audioLevel)||(e.audio.audioLevel=a.audioLevel||0,e.audio.totalAudioEnergy=a.totalAudioEnergy||0)}),e.audio.audioLevel===0&&(e.audio.audioLevel=t.remoteAudioTrack.getInternalAudioLevel()||0)}catch(o){this._log.warn(`failed to getStats on receiver connection ${o}`)}return e})}getStats(t,e){return _(this,null,function*(){let i={},o=[];if(this.room.singlePC){let s=this.room.singlePC.getPeerConnection();if(!s)return{senderStats:i,receiverStats:o};let n=yield s.getStats(),a=[],c=new Set(["inbound-rtp","outbound-rtp","track","candidate-pair","media-source"]);n.forEach(l=>c.has(l.type)&&a.push(l)),this._spcStats=a}t&&(i=yield this.getSenderStats(t));for(let[s,n]of e){let a=yield this.getReceiverStats(n);o.push(a)}return{senderStats:i,receiverStats:o}})}getDifferenceValue(t,e){if(lt(t))return e;let i=e-t;return i<0?0:i}prepareReport({stats:t,report:e,freezeMap:i}){if(!lt(t.senderStats)){let h={uint32_audio_level:t.senderStats.audio.audioLevel*Rt,uint32_audio_energy:t.senderStats.audio.totalAudioEnergy*1e6,uint32_audio_codec_bitrate:t.senderStats.audio.bytesSent};t.senderStats.audio.micAudioLevel&&(h.uint32_mic_audio_level=t.senderStats.audio.micAudioLevel*Rt);let m=[],f={uint32_video_stream_type:2,uint32_video_codec_fps:t.senderStats.video.framesSent,uint32_video_capture_fps:t.senderStats.video.fpsCapture,uint32_video_width:t.senderStats.video.frameWidth,uint32_video_height:t.senderStats.video.frameHeight,uint32_video_codec_bitrate:t.senderStats.video.bytesSent,uint32_video_enc_fps:t.senderStats.video.framesEncoded};if(m.push(f),t.senderStats.small.bytesSent){let D={uint32_video_stream_type:3,uint32_video_codec_fps:t.senderStats.small.framesSent||0,uint32_video_capture_fps:t.senderStats.small.fpsCapture||0,uint32_video_width:t.senderStats.small.frameWidth||0,uint32_video_height:t.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.small.bytesSent,uint32_video_enc_fps:t.senderStats.small.framesEncoded||0};m.push(D)}if(t.senderStats.auxiliary.bytesSent){let D={uint32_video_stream_type:7,uint32_video_codec_fps:t.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:t.senderStats.auxiliary.fpsCapture||0,uint32_video_width:t.senderStats.auxiliary.frameWidth||0,uint32_video_height:t.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:t.senderStats.auxiliary.framesEncoded||0};m.push(D)}let L={uint32_bitrate:0,uint32_lost:0,uint32_rtt:t.senderStats.rtt};e.msg_up_stream_info={msg_audio_status:h,msg_video_status:m,msg_network_status:L}}let{statInterval:o}=this;e.msg_down_stream_info=[],t.receiverStats.forEach(h=>{let m={msg_user_info:{str_identifier:h.userId,uint64_tinyid:h.tinyId},msg_network_status:{uint32_rtt:h.rtt,uint32_bitrate:0,uint32_lost:0},msg_audio_status:{},msg_video_status:[]};if(h.hasAudio){let f={uint32_audio_codec_bitrate:h.audio.bytesReceived,uint32_audio_total_bitrate:h.audio.bytesReceived,uint32_audio_level:h.audio.audioLevel*1e8,uint32_audio_energy:h.audio.totalAudioEnergy*1e6,uint32_audio_receive:h.audio.packetsReceived,uint32_audio_origin_lost:h.audio.packetsLost};m.msg_audio_status=f}if(h.hasVideo){let f=i.get(`${h.userId}_${ks}`),L=f?f.duration:0,D={uint32_video_stream_type:2,uint32_video_receive_fps:h.video.framesReceived,uint32_video_width:h.video.frameWidth,uint32_video_height:h.video.frameHeight,uint32_video_codec_bitrate:h.video.bytesReceived,uint32_video_receive:h.video.packetsReceived,uint32_video_origin_lost:h.video.packetsLost,uint32_video_block_time:L,uint32_video_dec_fps:h.video.framesDecoded};m.msg_video_status.push(D)}if(h.hasAuxiliary){let f=i.get(`${h.userId}_${ws}`),L=f?f.duration:0,D={uint32_video_stream_type:7,uint32_video_receive_fps:h.auxiliary.framesReceived,uint32_video_width:h.auxiliary.frameWidth,uint32_video_height:h.auxiliary.frameHeight,uint32_video_codec_bitrate:h.auxiliary.bytesReceived,uint32_video_receive:h.auxiliary.packetsReceived+h.auxiliary.packetsLost,uint32_video_origin_lost:h.auxiliary.packetsLost,uint32_video_block_time:L,uint32_video_dec_fps:h.auxiliary.framesDecoded};m.msg_video_status.push(D)}e.msg_down_stream_info.push(m)});let s=this._prevReport;if(this._prevReport=JSON.parse(JSON.stringify(e)),e.msg_up_stream_info.msg_audio_status&&s.msg_up_stream_info.msg_audio_status){let h=s.msg_up_stream_info.msg_audio_status,m=e.msg_up_stream_info.msg_audio_status;if(h.uint32_audio_codec_bitrate===0){m.uint32_audio_codec_bitrate=0;return}let f=this.getDifferenceValue(h.uint32_audio_codec_bitrate,m.uint32_audio_codec_bitrate);m.uint32_audio_codec_bitrate=Math.round(f*8/o),e.msg_up_stream_info.msg_network_status.uint32_bitrate+=m.uint32_audio_codec_bitrate}let n=s.msg_up_stream_info.msg_video_status;e.msg_up_stream_info.msg_video_status.forEach(h=>{let m=n.find(Ie=>Ie.uint32_video_stream_type===h.uint32_video_stream_type);if(!m||m.uint32_video_codec_bitrate===0){h.uint32_video_codec_bitrate=0,h.uint32_video_enc_fps=0,h.uint32_video_codec_fps=0;return}let f=0,L=0,D=0;m&&h.uint32_video_codec_bitrate>=m.uint32_video_codec_bitrate&&(f=m.uint32_video_codec_bitrate,L=m.uint32_video_enc_fps,D=m.uint32_video_codec_fps);let Q=this.getDifferenceValue(f,h.uint32_video_codec_bitrate);h.uint32_video_codec_bitrate=Math.round(Q*8/o),e.msg_up_stream_info.msg_network_status.uint32_bitrate+=h.uint32_video_codec_bitrate,h.uint32_video_enc_fps=Math.round(this.getDifferenceValue(L,h.uint32_video_enc_fps)/o),h.uint32_video_codec_fps=Math.round(this.getDifferenceValue(D,h.uint32_video_codec_fps)/o),Tt&&It()===115&&m.uint32_video_width===0&&m.uint32_video_height===0&&m.uint32_video_codec_fps===0&&(h.uint32_video_codec_fps=h.uint32_video_enc_fps)});let c=e.msg_down_stream_info,l=s.msg_down_stream_info;return c.forEach(h=>{let m=l.find(f=>f.msg_user_info.uint64_tinyid===h.msg_user_info.uint64_tinyid);if(!!m){if(!lt(h.msg_audio_status)&&!lt(m.msg_audio_status)){let f=h.msg_audio_status,L=m.msg_audio_status;f.uint32_audio_origin_lost=this.getDifferenceValue(L.uint32_audio_origin_lost,f.uint32_audio_origin_lost),f.uint32_audio_receive=this.getDifferenceValue(L.uint32_audio_receive,f.uint32_audio_receive),f.uint32_audio_receive+=f.uint32_audio_origin_lost;let D=this.getDifferenceValue(L.uint32_audio_codec_bitrate,f.uint32_audio_codec_bitrate);f.uint32_audio_codec_bitrate=Math.round(D*8/o),f.uint32_audio_total_bitrate=Math.round(D*8/o)}else h.msg_audio_status={};if(h.msg_video_status&&m.msg_video_status){let f=m.msg_video_status;h.msg_video_status=h.msg_video_status.filter(D=>f.find(Q=>Q.uint32_video_stream_type===D.uint32_video_stream_type)),h.msg_video_status.forEach(D=>{let Q=f.find(Kd=>Kd.uint32_video_stream_type===D.uint32_video_stream_type),Ie=Q.uint32_video_receive,Et=Q.uint32_video_origin_lost,Yr=Q.uint32_video_codec_bitrate,Hd=Q.uint32_video_receive_fps,Fd=Q.uint32_video_dec_fps;D.uint32_video_origin_lost=this.getDifferenceValue(Et,D.uint32_video_origin_lost),D.uint32_video_receive=this.getDifferenceValue(Ie,D.uint32_video_receive)+D.uint32_video_origin_lost;let Gd=this.getDifferenceValue(Yr,D.uint32_video_codec_bitrate);D.uint32_video_codec_bitrate=Math.round(Gd*8/o);let Wd=this.getDifferenceValue(Hd,D.uint32_video_receive_fps);D.uint32_video_receive_fps=Math.round(Wd/o),D.uint32_video_dec_fps=Math.round(this.getDifferenceValue(Fd,D.uint32_video_dec_fps)/o)})}}}),e}getStatsReport(o){return _(this,arguments,function*({uplinkConnection:t,downlinkConnections:e,freezeMap:i}){let s={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:0},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}}]},n=yield this.getStats(t,e);return JSON.stringify(this._prevReport)==="{}"&&(this._prevReport=JSON.parse(JSON.stringify(s))),this.prepareReport({stats:n,report:s,freezeMap:i}),this._prevReportTime=Date.now(),s})}reset(){this._prevReportTime=0,this._prevReport={},this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevDecoderImplementationMap=new Map}};import hh from"eventemitter3";var Aa=class extends hh{constructor({signalChannel:e,room:i}){super();d(this,"_room");d(this,"_signalChannel");d(this,"_log");d(this,"_uplinkRTT",0);d(this,"_uplinkLoss",0);d(this,"_downlinkRTT",0);d(this,"_downlinkLoss",0);d(this,"_downlinkPrevStatMap",new Map);d(this,"_downlinkLossAndRTTMap",new Map);d(this,"_interval",-1);d(this,"_uplinkNetworkQuality",0);d(this,"_downlinkNetworkQuality",0);this._room=i,this._signalChannel=e,this._log=g.createLogger({id:"q",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this.initialize()}get uplinkNetworkQuality(){return this._uplinkNetworkQuality}set uplinkNetworkQuality(e){e!==this._uplinkNetworkQuality&&this._log.info(`uplink network quality change ${this.uplinkNetworkQuality} -> ${e}, rtt: ${this._uplinkRTT}, loss: ${this._uplinkLoss}`),this._uplinkNetworkQuality=e}get downlinkNetworkQuality(){return this._downlinkNetworkQuality}set downlinkNetworkQuality(e){if(e!==this._downlinkNetworkQuality){let{rtt:i,loss:o}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._log.info(`downlink network quality change ${this.downlinkNetworkQuality} -> ${e}, rtt: ${i}, loss: ${o}`)}this._downlinkNetworkQuality=e}initialize(){this._signalChannel.on(V.UPLINK_NETWORK_STATS,e=>{this.handleUplinkNetworkQuality(e)}),this._signalChannel.on(ie.CONNECTION_STATE_CHANGED,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){var c,l;if(e.data.code!==0)return;let i=e.data.data;if(i.delay&&this.updateDelay(i.delay),!this._room.uplinkConnection){this.uplinkNetworkQuality=0,this._uplinkLoss=0,this._uplinkRTT=0;return}let o=(l=(c=this._room)==null?void 0:c.uplinkConnection)==null?void 0:l.getPeerConnection();if(o&&this.isPeerConnectionDisconnected(o)){this.uplinkNetworkQuality=6,this._uplinkLoss=0,this._uplinkRTT=0;return}let s=i.expectAudPkg+i.expectVidPkg,n=i.recvAudPkg+i.recvVidPkg,a=s-n;s===0&&n===0||(a<=0?this._uplinkLoss=0:this._uplinkLoss=Math.round(a/s*100),this._uplinkRTT=i.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this._uplinkLoss,this._uplinkRTT))}handleDownlinkNetworkQuality(){return _(this,null,function*(){if(this._room.remotePublishedUserMap.size===0){this.downlinkNetworkQuality=0;return}let e=[...this._room.remotePublishedUserMap.values()],i=e.filter(a=>{var c;return((c=a.getPeerConnection())==null?void 0:c.connectionState)===q.CONNECTED});if(e.filter(a=>this.isPeerConnectionDisconnected(a.getPeerConnection())).length===e.length){this.downlinkNetworkQuality=6;return}for(let a=0;a<i.length;a++){let c=i[a].getPeerConnection();if(!c)return;let{rtt:l,totalPacketsLost:h,totalPacketsReceived:m}=yield this.getStat(c);if(!this._downlinkPrevStatMap.has(c)){this._downlinkPrevStatMap.set(c,{totalPacketsLost:h,totalPacketsReceived:m});continue}let f=0,L=this._downlinkPrevStatMap.get(c),D=h-L.totalPacketsLost,Q=m-L.totalPacketsReceived;D<=0||Q<0?f=0:f=Math.round(D/(D+Q)*100),this._downlinkPrevStatMap.set(c,{totalPacketsLost:h,totalPacketsReceived:m}),this._downlinkLossAndRTTMap.set(c,{rtt:l,loss:f,userId:i[a].getUserId(),audioDelay:i[a].remoteAudioTrack.stat.end2EndDelay,videoDelay:i[a].remoteVideoTrack.stat.end2EndDelay})}if([...this._downlinkPrevStatMap.keys()].forEach(a=>{this.isPeerConnectionDisconnected(a)&&(this._downlinkPrevStatMap.delete(a),this._downlinkLossAndRTTMap.delete(a))}),this._downlinkLossAndRTTMap.size===0)return;let{rtt:s,loss:n}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._downlinkRTT=s,this._downlinkLoss=n,this.downlinkNetworkQuality=this.getNetworkQuality(n,s)})}getStat(e){return _(this,null,function*(){let i={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!Zt())return i;let o=e.getReceivers();try{for(let s=0;s<o.length;s++)(yield o[s].getStats()).forEach(c=>{c.type==="candidate-pair"&&J(c.currentRoundTripTime)&&(i.rtt=Math.round(c.currentRoundTripTime*1e3)),c.type==="inbound-rtp"&&(c.mediaType===u.AUDIO||c.mediaType===u.VIDEO)&&(i.totalPacketsLost+=c.packetsLost,i.totalPacketsReceived+=c.packetsReceived)});return i}catch(s){return i}})}getAverageLossAndRTT(e){let i={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach(o=>{i.rtt+=o.rtt,i.loss+=o.loss}),Object.keys(i).forEach(o=>{i[o]=Math.round(i[o]/e.length)})),i}getNetworkQuality(e,i){return e>50||i>500?5:e>30||i>350?4:e>20||i>200?3:e>10||i>100?2:e>=0||i>=0?1:0}handleSignalConnectionStateChange(e){e.state===Ce.DISCONNECTED?(this._uplinkRTT=0,this._uplinkLoss=0,this.uplinkNetworkQuality=6):e.state===Ce.CONNECTED&&this.uplinkNetworkQuality===6&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange({state:e}){e==="DISCONNECTED"?(this._uplinkLoss=0,this._uplinkRTT=0,this.uplinkNetworkQuality=6):e==="CONNECTED"&&this.uplinkNetworkQuality===6&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!!(e&&(e.connectionState===q.DISCONNECTED||e.connectionState===q.FAILED||e.connectionState===q.CLOSED))}setUplinkConnection(e){this._room.uplinkConnection=e,this._room.uplinkConnection?this._room.uplinkConnection.on(mc.CONNECTION_STATE_CHANGED,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this._uplinkRTT=0,this._uplinkLoss=0)}start(){if(this._interval!==-1){this._log.info("network quality calculating is already started");return}this._log.debug("start network quality calculating"),this._interval=z.run(We,()=>{this.handleDownlinkNetworkQuality();let e=[...this._downlinkLossAndRTTMap.values()];E.emit(p.NETWORK_QUALITY,{room:this._room,uplink:{rtt:this._uplinkRTT,loss:this._uplinkLoss},downlinks:e}),this.emit(Aa.EVENT_NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this._uplinkRTT,uplinkLoss:this._uplinkLoss,downlinkRTT:this._downlinkRTT,downlinkLoss:this._downlinkLoss,downlinkInfo:e})},{delay:2e3})}stop(){this._log.info("stop network quality calculating"),this._interval!==-1&&(z.clearTask(this._interval),this._interval=-1),this._downlinkLossAndRTTMap.clear(),this._downlinkPrevStatMap.clear()}updateDelay(e){let{tinyIdToUserIdMap:i}=this._room;e.forEach(({srcTinyId:o,videoDelay:s,audioDelay:n})=>{let a=i.get(o);if(a){let c=this._room.remotePublishedUserMap.get(a);c==null||c.setDelay({videoDelay:s,audioDelay:n})}})}},ui=Aa;d(ui,"EVENT_NETWORK_QUALITY","0");import{FSM as Th}from"afsm";var pt=new WeakMap;function Gr({settings:r={retries:5,timeout:2e3},onError:t,onRetrying:e,onRetryFailed:i}){return function(o,s,n){let a=Je({retryFunction:n.value,settings:r,onError(c,l,h){t&&t.call(this,c,()=>{var m;(m=pt.get(o))!=null&&m.has(s)?l():h(c)},h)},onRetrying:(c,l)=>{var h;K(e)&&e(c,l),(h=pt.get(o))!=null&&h.has(s)&&(pt.get(o).get(s).stopRetry=l)},onRetryFailed:i});return n.value=function(...c){let l=pt.get(o);return l?l.set(s,{args:c}):pt.set(o,new Map([[s,{args:c}]])),a.apply(this,c).finally(()=>{var h;return(h=pt.get(o))==null?void 0:h.delete(s)})},n}}function Wr({fnName:r,callback:t,validateArgs:e=!0}){return function(i,o,s){let n=s.value;return s.value=function(...a){var c,l;if((c=pt.get(i))!=null&&c.has(r)){let{stopRetry:h,args:m}=pt.get(i).get(r),f=!0;if(e){for(let L of m)if(!a.find(D=>D===L)){f=!1;break}}f&&(t&&t.apply(this,a),h&&h(),(l=pt.get(i))==null||l.delete(r))}return n.apply(this,a)},s}}function mh({fn:r,context:t}){return function(...e){try{let i=r.apply(t||this,e);return gr(i)?i.catch(o=>g.error(`${r.name}() error observed ${o}`)):i}catch(i){g.error(`${r.name}() error observed ${i}`)}}}var ds=class{constructor(t){this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0};this._apiSuccessRateMap=new Map;this._eventMap=new Map;this._frameWorkType=t.frameWorkType||30,this._component=t.component||0,this.connectionType=t.connectionType||1,this._language=t.language||0,this._room=t.room,this._keyPrefix="key_point",this._log=g.createLogger({id:"kpm",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),Object.getOwnPropertyNames(this.__proto__).forEach(e=>{e.startsWith("handle")&&K(this[e])&&(this[e]=mh({fn:this[e],context:this}))}),this.initData(),this.installEvents(),this._intervalId=z.run(We,this.setStorage.bind(this),{delay:2e4})}get _storageKey(){return`${this._keyPrefix}_${this._room.userId}`}initData(){this._firstPublishedUserList=[],this._networkQuality={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this._basicInfo={string_sdk_version:_e,uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:this._room.scene==="live"?1:0,uint32_joining_duration:0,uint32_networkType:St[Do()],uint32_framework:this._frameWorkType,uint32_component:this._component,uint32_connection_type:this.connectionType,uint32_caller_coding_language:this._language,string_domain:location.hostname},this._pathJoinRoom={uint64_start_time:0,uint64_init_audio_start_time:0,uint64_init_audio_end_time:0,uint64_init_camera_start_time:0,uint64_init_camera_end_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_init_audio_ret:0,int32_init_camera_ret:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this._pathLeaveRoom={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this._localStreamStat={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this._pathMainVideoMap=new Map,this._pathMainAudioMap=new Map,this._pathAuxiliaryMap=new Map,this._remoteStreamStatMap=new Map,this._apiSuccessRateMap.clear()}addEvent(t,e){return this._eventMap.set(t,e),E.on(t,e),this}installEvents(){this._room.once("banned",()=>this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId})),this.addEvent(p.JOIN_START,this.handleJoinStart).addEvent(p.JOIN_SIGNAL_CONNECTION_START,this.handleSignalConnectionStart).addEvent(p.JOIN_SIGNAL_CONNECTION_END,this.handleSignalConnectionEnd).addEvent(p.JOIN_SEND_CMD,this.handleJoinSendCMD).addEvent(p.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce).addEvent(p.JOIN_SUCCESS,this.handleJoinSuccess).addEvent(p.JOIN_FAILED,this.handleJoinFailed).addEvent(p.LEAVE_START,this.handleLeaveStart).addEvent(p.LEAVE_SUCCESS,this.handleLeaveSuccess).addEvent(p.LEAVE_SEND_CMD,this.handleLeaveSendCMD).addEvent(p.LOCAL_TRACK_CAPTURE_START,this.handleTrackCaptureStart).addEvent(p.LOCAL_TRACK_CAPTURE_SUCCESS,this.handleTrackCaptureSuccess).addEvent(p.LOCAL_TRACK_CAPTURE_FAILED,this.handleTrackCaptureFailed).addEvent(p.PUBLISH_START,this.handlePublishStart).addEvent(p.SEND_FIRST_VIDEO_FRAME,this.handleSendFirstVideoFrame).addEvent(p.SUBSCRIBE_START,this.handleSubscribeStart).addEvent(p.SUBSCRIBE_SUCCESS,this.handleSubscribed).addEvent(p.PLAY_TRACK_START,this.handlePlayStart).addEvent(p.VIDEO_LOADED_DATA,this.handleVideoLoadedData).addEvent(p.PLAYER_STATE_CHANGED,({track:t,state:e,type:i})=>{!Ct(t)||!this.hitTest(t.room)||e==="PLAYING"&&(i===u.AUDIO?this.handleAudioPlaying(t):this.handleVideoPlaying(t))}).addEvent(p.NETWORK_QUALITY,this.handleNetworkQuality).addEvent(p.HEARTBEAT_REPORT,this.handleHeartbeatStats).addEvent(p.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList).addEvent(p.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:i})=>{if(!this.hitTest(t))return;let o=e.hasAudio||e.hasVideo||e.hasSmall,s=e.hasAuxiliary,n=i.hasAudio||i.hasVideo||i.hasSmall,a=i.hasAuxiliary;!o&&n&&this.handleRemoteStreamAdded(i.userId,"main"),!s&&a&&this.handleRemoteStreamAdded(i.userId,"auxiliary")}).addEvent(p.API_SUCCESS_RATE,this.handleAPISuccessRate)}uninstallEvents(){this._eventMap.forEach((t,e)=>E.off(e,t)),this._eventMap.clear()}destroy(){this.uninstallEvents(),z.clearTask(this._intervalId)}handleJoinStart(t){this.hitTest(t.room)&&(this._pathJoinRoom.uint64_start_time===0&&(this._pathJoinRoom.uint64_start_time=Date.now(),this.checkStorage()),t.params&&(I(t.params.frameWorkType)||(this._frameWorkType=t.params.frameWorkType,this._basicInfo.uint32_framework=this._frameWorkType),I(t.params.component)||(this._component=t.params.component,this._basicInfo.uint32_component=this._component),I(t.params.language)||(this._language=t.params.language,this._basicInfo.uint32_caller_coding_language=this._language)))}handleSignalConnectionStart({room:t}){this.hitTest(t)&&this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time===0&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleSignalConnectionEnd({room:t,error:e}){this.hitTest(t)&&this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time===0&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time=Date.now(),e&&(this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret=e instanceof A?Number(e.getExtraCode()||e.getCode()):T.UNKNOWN,this._pathJoinRoom.int32_end_ret=2))}handleJoinSendCMD(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time===0&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time===0&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time=Date.now(),this._pathJoinRoom.int32_send_request_enter_room_cmd_ret=t.code,t.code!==0&&(this._pathJoinRoom.int32_end_ret=3))}handleJoinSuccess(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_end_time===0&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret=0,this._signalInfo=t.room.getSignalInfo())}handleJoinFailed({room:t}){this.hitTest(t)&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret===0&&(this._pathJoinRoom.int32_end_ret=3),setTimeout(()=>{this.report()}))}handleReceivedPublishUserList(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_recv_userlist_time===0&&(this._pathJoinRoom.uint64_recv_userlist_time=Date.now(),this._firstPublishedUserList=t.publishedUserList||[])}handleSendFirstVideoFrame({room:t}){!this.hitTest(t)||this._pathJoinRoom.uint64_send_first_video_frame_time===0&&this._pathJoinRoom.uint64_start_time!==0&&(this._pathJoinRoom.uint64_send_first_video_frame_time=Date.now())}handleLeaveStart(t){this.hitTest(t.room)&&(this._pathLeaveRoom.uint64_start_time=Date.now())}handleLeaveSuccess(t){this.hitTest(t.room)&&this._pathLeaveRoom.uint64_end_time===0&&(this._pathLeaveRoom.uint64_end_time=Date.now(),this._pathJoinRoom.uint64_end_time!==0?this._basicInfo.uint32_joining_duration=this._pathLeaveRoom.uint64_end_time-this._pathJoinRoom.uint64_end_time:this._log.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(t){this.hitTest(t.room)&&(this._pathLeaveRoom.uint64_send_request_exit_room_cmd_start_time=Date.now(),this._pathLeaveRoom.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded(t,e){var o;let i=`${t}_${e}`;if(!this._remoteStreamStatMap.has(i)){let s={userId:t,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:k(R({},ph),{msg_user_info:new Kr({userId:t,tinyId:(o=this._room.remotePublishedUserMap.get(t))==null?void 0:o.tinyId,role:20})})};s.statsToReport.uint32_stream_type=e==="main"?2:7,this._remoteStreamStatMap.set(i,s)}}handleSubscribeStart({room:t,remotePublishedUser:e,streamType:i,subscribeState:o}){if(!this.hitTest(t))return;let{userId:s,tinyId:n,role:a}=e,c=new Kr({userId:s,tinyId:n,role:a==="anchor"?20:21}),l=Date.now(),h=`${s}_${i}`,m=this._remoteStreamStatMap.get(h);m&&m.subscribeStartTime===0&&(m.subscribeStartTime=l),i==="main"?(e.muteState.hasVideo&&(o.video||o.smallVideo)&&!this._pathMainVideoMap.has(h)&&this._pathMainVideoMap.set(h,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0},userId:s,sendSubscribeCMDTime:l}),e.muteState.hasAudio&&o.audio&&!this._pathMainAudioMap.has(h)&&this._pathMainAudioMap.set(h,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_play_first_frame_time:0},userId:s,sendSubscribeCMDTime:l})):e.muteState.hasAuxiliary&&o.auxiliary&&!this._pathAuxiliaryMap.has(h)&&this._pathAuxiliaryMap.set(h,{sendSubscribeCMDTime:l})}handleSubscribed({room:t,remotePublishedUser:e,streamType:i}){if(this.hitTest(t)){let o=`${e.userId}_${i}`,s=this._remoteStreamStatMap.get(o);s&&s.subscribedTime===0&&(s.subscribedTime=Date.now())}}handlePlayStart({track:t}){if(!Ct(t)||!this.hitTest(t.room))return;let e=`${t.userId}_${t.streamType}`,i=this._remoteStreamStatMap.get(e);(i==null?void 0:i.playStreamTime)===0&&(i.playStreamTime=Date.now())}handleVideoLoadedData({track:t}){if(!Ct(t)||!this.hitTest(t.room))return;let e=`${t.userId}_${t.streamType}`,i=this._pathMainVideoMap.get(e);i&&i.statsToReport.uint64_combine_first_frame_time===0&&(i.statsToReport.uint64_combine_first_frame_time=Date.now())}handleVideoPlaying(t){let e=`${t.userId}_${t.streamType}`,i=Date.now(),o=this._pathMainVideoMap.get(e),s=this._remoteStreamStatMap.get(e);if(o&&(o.statsToReport.uint64_render_first_frame_time===0&&(o.statsToReport.uint64_render_first_frame_time=i),s)){let{statsToReport:a,playStreamTime:c,subscribedTime:l}=s;a.uint32_video_render_first===0&&c-l<=100&&(a.uint32_video_render_first=i-o.sendSubscribeCMDTime)}let n=this._pathAuxiliaryMap.get(e);if(n&&s){let{statsToReport:a,playStreamTime:c,subscribedTime:l}=s;a.uint32_video_render_first===0&&c-l<=100&&(a.uint32_video_render_first=i-n.sendSubscribeCMDTime)}}handleAudioPlaying(t){let e=`${t.userId}_${t.streamType}`,i=this._pathMainAudioMap.get(e);i&&i.statsToReport.uint64_play_first_frame_time===0&&(i.statsToReport.uint64_play_first_frame_time=Date.now())}handleNetworkQuality(t){this.hitTest(t.room)&&(this._networkQuality.totalUplinkLoss+=t.uplink.loss,this._networkQuality.totalUplinkRTT+=t.uplink.rtt,this._networkQuality.count++,t.downlinks.forEach(({rtt:e,loss:i,userId:o,videoDelay:s,audioDelay:n})=>{let a=this._networkQuality.totalDownlinkRTTAndLossMap.get(o);if(a)a.totalRTT+=e,a.totalLoss+=i,s&&(a.totalVideoDelay=(a.totalVideoDelay||0)+s,a.videoDelayCount=(a.videoDelayCount||0)+1),n&&(a.totalAudioDelay=(a.totalAudioDelay||0)+n,a.audioDelayCount=(a.audioDelayCount||0)+1),a.count++;else{let c,l,h,m;s&&(l=s,h=1),n&&(c=n,m=1),this._networkQuality.totalDownlinkRTTAndLossMap.set(o,{totalRTT:e,totalLoss:i,count:1,totalAudioDelay:c,totalVideoDelay:l,audioDelayCount:m,videoDelayCount:h})}}))}handleHeartbeatStats(t){if(this.hitTest(t.room)){let{msg_up_stream_info:e,msg_down_stream_info:i}=t.report;if(e.msg_video_status[0]){let{uint32_video_codec_bitrate:o,uint32_video_enc_fps:s,uint32_video_width:n,uint32_video_height:a}=e.msg_video_status[0];this._localStreamStat.totalVideoBitrate+=o,this._localStreamStat.totalVideoFPS+=s,this._localStreamStat.totalVideoWidth+=n,this._localStreamStat.totalVideoHeight+=a,this._localStreamStat.videoCount++}if(e.msg_audio_status){let{uint32_audio_level:o}=e.msg_audio_status;Math.floor(o/Rt*100)>0&&(this._localStreamStat.totalAudioLevel+=o/Rt,this._localStreamStat.audioLevelCount++)}i.forEach(o=>{let{msg_user_info:s,msg_audio_status:n,msg_video_status:a}=o,c=s.str_identifier,l=this._room.remotePublishedUserMap.get(c);if(a.forEach(h=>{let m=h.uint32_video_stream_type===2,f=h.uint32_video_stream_type===7,L=`${c}_${m?"main":"auxiliary"}`,D=this._remoteStreamStatMap.get(L);if(!!D&&(m&&(l==null?void 0:l.remoteVideoTrack.isSubscribed)||f&&(l==null?void 0:l.remoteAuxiliaryTrack))){D.totalVideoFPS+=h.uint32_video_receive_fps,D.totalVideoBitrate+=h.uint32_video_codec_bitrate,D.videoCount++,D.statsToReport.uint32_video_width===0&&(D.statsToReport.uint32_video_width=h.uint32_video_width),D.statsToReport.uint32_video_height===0&&(D.statsToReport.uint32_video_height=h.uint32_video_height);let Q=m?l.remoteVideoTrack:l.remoteAuxiliaryTrack;Q.stat.jitterBufferDelay&&(D.videoJitterBufferDelay=Q.stat.jitterBufferDelay),Q.stat.framesReceived&&(D.statsToReport.uint32_video_consume_render_rate=Math.floor(Q.stat.framesDecoded/Q.stat.framesReceived*Qr(10,6)))}}),n){let h=`${c}_${"main"}`,m=this._remoteStreamStatMap.get(h);this._remoteStreamStatMap.has(h)&&m&&(l==null?void 0:l.remoteAudioTrack.isSubscribed)&&(m.totalAudioBitrate+=n.uint32_audio_codec_bitrate,m.audioCount++,l.remoteAudioTrack.stat.jitterBufferDelay&&(m.audioJitterBufferDelay=l.remoteAudioTrack.stat.jitterBufferDelay),Math.floor(n.uint32_audio_level/Rt*100)>0&&(m.totalAudioLevel+=n.uint32_audio_level/Rt,m.audioLevelCount++))}})}}handlePublishStart({room:t}){this.hitTest(t)&&this._localStreamStat.publishStartTime===0&&(this._localStreamStat.publishStartTime=Date.now())}handleTrackCaptureStart({track:t}){t.mediaType===1&&this._pathJoinRoom.uint64_init_audio_start_time===0&&(this._pathJoinRoom.uint64_init_audio_start_time=Date.now()),t.mediaType===4&&this._pathJoinRoom.uint64_init_camera_start_time===0&&(this._pathJoinRoom.uint64_init_camera_start_time=Date.now())}handleTrackCaptureSuccess({track:t}){t.mediaType===1&&this._pathJoinRoom.uint64_init_audio_end_time===0&&(this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),t.mediaType===4&&this._pathJoinRoom.uint64_init_camera_end_time===0&&(this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleTrackCaptureFailed({track:t,error:e}){let i={NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5},o=e instanceof A?e.getExtraCode()||e.getCode():i[e.name]||T.UNKNOWN;t.mediaType===1&&this._pathJoinRoom.uint64_init_audio_end_time===0&&(this._pathJoinRoom.int32_init_audio_ret=o,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),t.mediaType===4&&this._pathJoinRoom.uint64_init_camera_end_time===0&&(this._pathJoinRoom.int32_init_camera_ret=o,this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleAPISuccessRate({room:t,apiName:e,error:i,cost:o}){if(!this.hitTest(t))return;let s=Ad[e],n={uint32_function_request_type:s,uint32_avg_value:0,uint32_max_value:0,uint32_request_count:1,uint32_success_count:0,msg_error_code:[]};if(i){let c=T.UNKNOWN;i instanceof A&&(c=i.extraCode||i.code),Z.uploadEvent({log:`stat-${e}-failed-${c}`,userId:this._room.userId,error:i});let l={int32_error_code:c,error_count:1};n.msg_error_code.push(l)}else J(o)&&(n.uint32_avg_value=o,n.uint32_max_value=o,n.uint32_success_count=1);let a=this._apiSuccessRateMap.get(s);a?(a.uint32_success_count+n.uint32_success_count>0&&(a.uint32_avg_value=(a.uint32_avg_value*a.uint32_success_count+n.uint32_avg_value)/(a.uint32_success_count+n.uint32_success_count)),a.uint32_max_value=Math.max(a.uint32_max_value,n.uint32_max_value),a.uint32_request_count+=1,a.uint32_success_count=a.uint32_success_count+n.uint32_success_count,n.msg_error_code.forEach(c=>{let l=a.msg_error_code.find(h=>h.int32_error_code===c.int32_error_code);l?l.error_count+=1:a.msg_error_code.push(c)})):this._apiSuccessRateMap.set(s,n)}hasVideoFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&Oi)>=0}hasAudioFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&yi)>=0}hasAuxFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&pr)>=0}hitTest(t){return t===this._room}checkStorage(){return _(this,null,function*(){try{let t=Vi.getItem(this._storageKey);t&&(yield this.upload(t),Vi.deleteItem(this._storageKey))}catch(t){this._log.warn(t)}})}setStorage(){this.prepareReport();let t=this.getReportData();t.msg_path_enter_room.uint64_start_time!==0&&Vi.setItem(this._storageKey,t)}prepareReport(){if(this._networkQuality.count>0&&(this._basicInfo.uint32_avg_rtt=Math.floor(this._networkQuality.totalUplinkRTT/this._networkQuality.count),this._basicInfo.uint32_avg_up_loss=Math.floor(this._networkQuality.totalUplinkLoss/this._networkQuality.count)),this._localStreamStat.videoCount>0){this._localStreamStat.statsToReport.uint32_video_big_capture_fps=Math.floor(this._localStreamStat.totalVideoFPS/this._localStreamStat.videoCount),this._localStreamStat.statsToReport.uint32_video_big_bitrate=Math.floor(this._localStreamStat.totalVideoBitrate/this._localStreamStat.videoCount);let t=Math.floor(this._localStreamStat.totalVideoWidth/this._localStreamStat.videoCount),e=Math.floor(this._localStreamStat.totalVideoHeight/this._localStreamStat.videoCount);this._localStreamStat.statsToReport.uint32_video_big_resolution=t<<16|e}this._localStreamStat.audioLevelCount>0&&(this._localStreamStat.statsToReport.uint32_audio_capture_db=Math.floor(this._localStreamStat.totalAudioLevel/this._localStreamStat.audioLevelCount*100)),this._remoteStreamStatMap.forEach((t,e)=>{let{userId:i}=t,o=this._networkQuality.totalDownlinkRTTAndLossMap.get(i);if(o){let{totalLoss:h,count:m,audioDelayCount:f,videoDelayCount:L,totalAudioDelay:D,totalVideoDelay:Q}=o;t.statsToReport.uint32_avg_down_loss=Math.floor(h/m),f&&D&&(t.statsToReport.uint32_audio_network_p2p_delay=Math.floor(D/f),t.audioJitterBufferDelay&&(t.statsToReport.uint32_p2p_delay=Math.floor(t.statsToReport.uint32_audio_network_p2p_delay+t.audioJitterBufferDelay))),L&&Q&&(t.statsToReport.uint32_video_network_p2p_delay=Math.floor(Q/L))}t.videoCount>0&&(t.statsToReport.uint32_video_avg_fps=Math.floor(t.totalVideoFPS/t.videoCount),t.statsToReport.uint32_video_avg_bitrate=Math.floor(t.totalVideoBitrate/t.videoCount)),t.audioCount>0&&(t.statsToReport.uint32_audio_recv_bitrate=t.statsToReport.uint32_audio_bitrate=Math.floor(t.totalAudioBitrate/t.audioCount)),t.audioLevelCount>0&&(t.statsToReport.uint32_audio_play_db=Math.floor(t.totalAudioLevel/t.audioLevelCount*100));let{callDurationCalculator:s}=this._room;s&&(t.statsToReport.uint32_audio_play_time=s.getDuration(e,u.AUDIO),t.statsToReport.uint32_video_play_time=s.getDuration(e,u.VIDEO)),t.statsToReport.uint32_video_render_first=Math.min(t.statsToReport.uint32_video_render_first,hi);let{badCaseDetector:n}=this._room,{dataFreeze:a,count:c}=n.getDataFreezeDuration(e),{renderFreeze:l}=n.getRenderFreezeDuration(e);t.statsToReport.uint32_video_block_count=c,t.statsToReport.uint32_video_block_time=Math.min(a,t.statsToReport.uint32_video_play_time),t.statsToReport.uint32_video_external_block_time=Math.min(l,t.statsToReport.uint32_video_play_time),n.isBlackStream(e)&&t.statsToReport.uint32_video_avg_fps===0?t.statsToReport.uint32_video_black_screen_subjective=1:t.statsToReport.uint32_video_black_screen_subjective=0,(t.subscribeStartTime===0||t.subscribeStartTime-t.streamAddedTime>100||t.playStreamTime===0)&&(this._pathMainAudioMap.delete(e),this._pathMainVideoMap.delete(e),t.statsToReport.uint32_video_render_first=0)}),this._pathMainAudioMap.forEach((t,e)=>{if(!this.hasAudioFlag(t.userId)){this._pathMainAudioMap.delete(e);return}t.statsToReport.uint64_play_first_frame_time-t.statsToReport.uint64_start_enter_time>hi&&(t.statsToReport.uint64_play_first_frame_time=t.statsToReport.uint64_start_enter_time+hi)}),this._pathMainVideoMap.forEach((t,e)=>{if(!this.hasVideoFlag(t.userId)){this._pathMainVideoMap.delete(e);return}t.statsToReport.uint64_render_first_frame_time-t.statsToReport.uint64_start_enter_time>hi&&(t.statsToReport.uint64_render_first_frame_time=t.statsToReport.uint64_start_enter_time+hi)}),this._pathJoinRoom.uint64_end_time-this._pathJoinRoom.uint64_start_time>hi&&(this._pathJoinRoom.uint64_end_time=this._pathJoinRoom.uint64_start_time+hi)}getReportData(){return{uint32_sdk_app_id:Number(this._room.sdkAppId),msg_user_info:new Kr({userId:this._room.userId,tinyId:this._room.tinyId,role:this._room.role==="anchor"?20:21}),msg_basic_info:this._basicInfo,uint32_acc_ip:Cr(this._signalInfo.relayIp),uint32_client_ip:Cr(this._signalInfo.clientIp,!1),uint32_acc_port:this._signalInfo.relayPort||0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*2147483648),msg_path_enter_room:this._pathJoinRoom,msg_path_exit_room:this._pathLeaveRoom,msg_path_recv_video:[...this._pathMainVideoMap.values()].map(e=>e.statsToReport),msg_quality_statistics:[...this._remoteStreamStatMap.values()].map(e=>e.statsToReport),str_room_name:String(this._room.roomId||0),msg_path_recv_audio:[...this._pathMainAudioMap.values()].map(e=>e.statsToReport),uint32_info_client_ip:Cr(this._signalInfo.clientIp,!1),error_code:[],msg_local_statistics:this._localStreamStat.statsToReport,msg_function_request_stats:[...this._apiSuccessRateMap.values()]}}report(){return _(this,null,function*(){try{this.prepareReport();let t=this.getReportData();yield this.upload(t),Vi.deleteItem(this._storageKey),this.initData()}catch(t){this._log.warn(t)}})}upload(t){return _(this,null,function*(){if(we||t.msg_path_enter_room.uint64_start_time===0||[Eo,Ds,Os].findIndex(s=>s===location.host)>=0)return;let e=Number(this._room.sdkAppId),i=Qt(e,jt.KEY_POINT),o=yield Dt({url:i,body:JSON.stringify(t)});if(o.data!=="ok")throw`key point upload failed: ${o.data}`})}setConnectionType(t){this.connectionType=t,this._basicInfo.uint32_connection_type=t}};N([Gr({settings:{timeout:500,retries:3}})],ds.prototype,"upload",1);var hi=5e3,ph={msg_user_info:null,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0,uint32_video_consume_render_rate:0},Kr=class{constructor(t){this.str_identifier=String(t.userId),this.str_tinyid=String(t.tinyId||0),this.uint32_role=t.role}},Ad=(O=>(O[O.enterRoom=50001]="enterRoom",O[O.exitRoom=50002]="exitRoom",O[O.switchRole=50003]="switchRole",O[O.destroy=50004]="destroy",O[O.startLocalAudio=50005]="startLocalAudio",O[O.updateLocalAudio=50006]="updateLocalAudio",O[O.stopLocalAudio=50007]="stopLocalAudio",O[O.startLocalVideo=50008]="startLocalVideo",O[O.updateLocalVideo=50009]="updateLocalVideo",O[O.stopLocalVideo=50010]="stopLocalVideo",O[O.startScreenShare=50011]="startScreenShare",O[O.updateScreenShare=50012]="updateScreenShare",O[O.stopScreenShare=50013]="stopScreenShare",O[O.enableAudioVolumeEvaluation=50014]="enableAudioVolumeEvaluation",O[O.startRemoteVideo=50015]="startRemoteVideo",O[O.updateRemoteVideo=50016]="updateRemoteVideo",O[O.stopRemoteVideo=50017]="stopRemoteVideo",O[O.muteRemoteAudio=50018]="muteRemoteAudio",O[O.setRemoteAudioVolume=50019]="setRemoteAudioVolume",O[O.startMixTranscode=50020]="startMixTranscode",O[O.stopMixTranscode=50021]="stopMixTranscode",O[O.startPublishCDNStream=50022]="startPublishCDNStream",O[O.stopPublishCDNStream=50023]="stopPublishCDNStream",O[O.PeerConnectionConnect=50024]="PeerConnectionConnect",O[O.PeerConnectionReconnect=50025]="PeerConnectionReconnect",O[O.WebsocketConnect=50026]="WebsocketConnect",O[O.WebsocketReconnect=50027]="WebsocketReconnect",O[O.schedule=50028]="schedule",O[O.SPCConnect=50029]="SPCConnect",O[O.SPCReconnect=50030]="SPCReconnect",O))(Ad||{}),Rd=ds;var Ra=class{constructor(){d(this,"_startTime");d(this,"_endTime");this._startTime=0,this._endTime=0,this.start()}start(){this._startTime===0&&(this._startTime=w())}stop(){this._endTime===0&&(this._endTime=w())}getDuration(){return this._endTime===0?w()-this._startTime:this._endTime-this._startTime}get endTime(){return this._endTime}},Qi=Ra;var Ca=class{constructor(t){d(this,"_room",null);d(this,"_durationMap");d(this,"_eventMap",new Map);this._room=t.room,this._durationMap=new Map,this.installEvents()}installEvents(){this._eventMap.set(p.SUBSCRIBE_SUCCESS,this.handleSubscribed).set(p.UNSUBSCRIBE_SUCCESS,this.handleStreamStopped).set(p.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:i})=>{var n;let{userId:o}=i;if(!this.hitTest(t))return;e.hasAudio&&!i.hasAudio&&this.stopDurationItem(`${o}_${"main"}`,u.AUDIO),e.hasVideo&&!i.hasVideo&&this.stopDurationItem(`${o}_${"main"}`,u.VIDEO),e.hasAuxiliary&&!i.hasAuxiliary&&this.stopDurationItem(`${o}_${"auxiliary"}`,u.VIDEO);let s=(n=this._room)==null?void 0:n.remotePublishedUserMap.get(o);!s||(!e.hasAudio&&i.hasAudio&&s.remoteAudioTrack.isSubscribed&&this.addDuractionItem(o,u.AUDIO,"main"),!e.hasVideo&&i.hasVideo&&s.remoteVideoTrack.isSubscribed&&this.addDuractionItem(o,u.VIDEO,"main"),!e.hasAuxiliary&&i.hasAuxiliary&&s.remoteAuxiliaryTrack.isSubscribed&&this.addDuractionItem(o,u.VIDEO,"auxiliary"))}),this._eventMap.forEach((t,e)=>E.on(e,t,this))}uninstallEvents(){this._eventMap.forEach((t,e)=>E.off(e,t,this)),this._eventMap.clear()}handleSubscribed({room:t,streamType:e,remotePublishedUser:i}){if(!this.hitTest(t))return;let{userId:o}=i,s=`${o}_${e}`;if(i.muteState.hasAudio&&e==="main")if(i.remoteAudioTrack.isSubscribed){let n=new Qi,a=this._durationMap.get(s);a?this.isRecording(a.audio)||a.audio.push(n):this._durationMap.set(s,{userId:o,type:e,audio:[n],video:[]})}else this.stopDurationItem(s,u.AUDIO);if(i.muteState.hasVideo||i.muteState.hasAuxiliary)if(i.remoteVideoTrack.isSubscribed||i.remoteAuxiliaryTrack.isSubscribed){let n=new Qi,a=this._durationMap.get(s);a?this.isRecording(a.video)||a.video.push(n):this._durationMap.set(s,{userId:o,type:e,audio:[],video:[n]})}else this.stopDurationItem(s,u.VIDEO)}handleStreamStopped({room:t,streamType:e,remotePublishedUser:i}){if(!this.hitTest(t))return;let{userId:o}=i,s=`${o}_${e}`;this.stopDurationItem(s,u.AUDIO),this.stopDurationItem(s,u.VIDEO)}isRecording(t){return t.findIndex(e=>e.endTime===0)>=0}addDuractionItem(t,e,i){let o=`${t}_${i}`,s=new Qi,n=this._durationMap.get(o);n?this.isRecording(n[e])||n[e].push(s):this._durationMap.set(o,{userId:t,type:i,audio:e===u.AUDIO?[s]:[],video:e===u.AUDIO?[]:[s]})}stopDurationItem(t,e){if(this._durationMap.has(t)){let o=this._durationMap.get(t)[e].find(s=>s.endTime===0);o&&o.stop()}}hitTest(t){return this._room===t}getDuration(t,e){return this._durationMap.has(t)?this._durationMap.get(t)[e].reduce((o,s)=>o+s.getDuration(),0):0}getDurationMap(){return this._durationMap}reset(){this._durationMap.clear()}destroy(){this._room=null,this.uninstallEvents()}},Cd=Ca;var Na=class{constructor(t){d(this,"_room");d(this,"_renderFreezeMap",new Map);d(this,"_isVideoPlayingEventFiredMap",new Map);d(this,"_dataFreezeMap",new Map);d(this,"_monitorFreezeData",new Map);d(this,"_eventMap",new Map);this._room=t.room,this.installEvents()}installEvents(){this._eventMap.set(p.LEAVE_SUCCESS,({room:t})=>{this.hitTest(t)&&this.stop()}).set(p.PLAY_TRACK_START,this.onPlayTrackStart).set(p.UNSUBSCRIBE_SUCCESS,({room:t,streamType:e,remotePublishedUser:i})=>{if(!this.hitTest(t))return;let{userId:o}=i,s=`${o}_${e}`;this.stopDataFreeze({key:s,userId:o,type:e})}).set(p.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:i})=>{if(!this.hitTest(t))return;let{userId:o}=i;if(e.hasVideo&&!i.hasVideo){let s="main",n=`${i.userId}_${s}`;this.stopDataFreeze({key:n,userId:o,type:s})}if(e.hasAuxiliary&&!i.hasAuxiliary){let s="auxiliary",n=`${i.userId}_${s}`;this.stopDataFreeze({key:n,userId:o,type:s})}}).set(p.PLAYER_STATE_CHANGED,({track:t,state:e,reason:i,type:o})=>{if(!(!Ct(t)||!this.hitTest(t.room)||o!==u.VIDEO)){if(e==="PLAYING"){let s=`${t.userId}_${t.streamType}`;this._isVideoPlayingEventFiredMap.set(s,!0)}i===u.MUTE?this.onVideoTrackMuted(t):i===u.UNMUTE&&this.onVideoTrackUnmuted(t)}}).set(p.HEARTBEAT_REPORT,this.onHearBeatReport),this._eventMap.forEach((t,e)=>E.on(e,t,this))}uninstallEvents(){this._eventMap.forEach((t,e)=>E.off(e,t,this)),this._eventMap.clear()}stop(){this._renderFreezeMap.clear(),this._dataFreezeMap.clear(),this._isVideoPlayingEventFiredMap.clear()}onVideoTrackMuted(t){if(!t.isSubscribed)return;let{userId:e,streamType:i}=t,o=`${e}_${i}`,s=this._dataFreezeMap.get(o),n=new Qi;s?s.durationItemList.push(n):this._dataFreezeMap.set(o,{userId:e,type:i,durationItemList:[n],isFreezing(){let a=this.durationItemList[this.durationItemList.length-1];return a&&a.endTime===0}})}onVideoTrackUnmuted(t){if(!t.isSubscribed)return;let{userId:e,streamType:i}=t,o=`${e}_${i}`;this.stopDataFreeze({key:o,userId:e,type:i})}onHearBeatReport({room:t,report:e}){!this.hitTest(t)||e.msg_down_stream_info.forEach(i=>{let o=this._room.remotePublishedUserMap.get(i.msg_user_info.str_identifier);if(!o)return;let{userId:s,muteState:n}=o;i.msg_video_status.forEach(a=>{a.uint32_video_stream_type===2&&n.hasVideo&&!n.videoMuted&&o.remoteVideoTrack.isSubscribed&&this.handleRenderFreeze({userId:s,fps:a.uint32_video_dec_fps,type:"main"}),a.uint32_video_stream_type===7&&n.hasAuxiliary&&o.remoteAuxiliaryTrack.isSubscribed&&this.handleRenderFreeze({userId:s,fps:a.uint32_video_dec_fps,type:"auxiliary"})})})}stopDataFreeze({key:t,userId:e,type:i}){let o=this._dataFreezeMap.get(t);if(!o||!o.isFreezing())return;let s=o.durationItemList[o.durationItemList.length-1];s.stop();let n=s.getDuration();n>Ro?this._monitorFreezeData.set(t,{userId:e,type:i,duration:n}):o.durationItemList.pop()}getTotalDuration(t){return t.reduce((e,i)=>{let o=i.getDuration();return e+Math.min(o,5e3)},0)}handleRenderFreeze(o){return _(this,arguments,function*({userId:t,fps:e,type:i}){let s=`${t}_${i}`,n=this._renderFreezeMap.get(s);if(e<=2){let a=w();n&&!n.isFreeze&&(n.freezeTimeline.push({startTime:a,endTime:0}),n.isFreeze=!0),n||this._renderFreezeMap.set(s,{userId:t,type:i,isFreeze:!0,freezeTimeline:[{startTime:a,endTime:0}],renderFreezeTotal:0})}else if(n&&n.isFreeze){n.isFreeze=!1;let a=n.freezeTimeline.pop();if(a){a.endTime=w();let c=a.endTime-a.startTime;n.freezeTimeline.push(a),n.renderFreezeTotal+=Math.min(5e3,c)}}})}onPlayTrackStart({track:t}){if(!Ct(t)||!this.hitTest(t.room)||t.kind!==u.VIDEO||t.hasFlag)return;let e=`${t.userId}_${t.streamType}`;this._isVideoPlayingEventFiredMap.has(e)||this._isVideoPlayingEventFiredMap.set(e,!1)}getDataFreezeDuration(t){let e={dataFreeze:0,count:0},i=this._dataFreezeMap.get(t);if(i){if(i.isFreezing()){let o=i.durationItemList[i.durationItemList.length-1];o.stop(),o.getDuration()<Ro&&i.durationItemList.pop()}e.dataFreeze=this.getTotalDuration(i.durationItemList),e.count=i.durationItemList.length}return e}getRenderFreezeDuration(t){let e=this._renderFreezeMap.get(t),i=0,o=0;if(e)if(!e.isFreeze)i=e.renderFreezeTotal;else{let s=w(),n=e.freezeTimeline[e.freezeTimeline.length-1],a=s-n.startTime;i=e.renderFreezeTotal+Math.min(a,5e3),o=e.freezeTimeline.length}return{renderFreeze:i,count:o}}getMonitorFreeze(){return this._monitorFreezeData}isBlackStream(t){return this._isVideoPlayingEventFiredMap.has(t)?!this._isVideoPlayingEventFiredMap.get(t):!1}resetMonitor(){this._monitorFreezeData.clear()}hitTest(t){return t===this._room}destroy(){this.uninstallEvents()}},Nd=Na;function yd(a){return _(this,arguments,function*({userId:r,sdkAppId:t,useStringRoomId:e,roomId:i,userSig:o,version:s,frameWorkType:n}){let c={delta:0,count:[1,1],msg:[]};try{let l=new FormData;l.append("userId",String(r)),l.append("sdkAppId",String(t)),l.append("isStrGroupId",String(e)),l.append("groupId",String(i)),l.append("sdkVersion",s),l.append("userSig",String(o)),l.append("frameWorkType",String(n));let h=w(),m=yield fh(l,c,t);return c.delta=w()-h,m}catch(l){let h=de(l)?l[0]:l,m=J(h.code)?h.code:0,f=`get websocket url failed: ${h.message.includes("timeout")?"timeout":h.message}`,L=new A({code:T.SCHEDULE_FAILED,extraCode:m,message:y({key:C.JOIN_ROOM_FAILED,data:{error:f,code:m}})});throw g.error(L),L}})}function Dd(r,t=u.MAIN){let e;return No(r)?e=t===u.MAIN?Li.MAIN_OVERSEA:Li.BACKUP_OVERSEA:e=t===u.MAIN?Li.MAIN:Li.BACKUP,`https://${e}/api/v1/config`}function Eh(r,t,e){return new Promise((i,o)=>{Dt({url:r,body:t,timeout:e.timeout}).then(s=>{s.data.code===0?i(s.data.data):o({code:s.data.code,message:s.data.msg})}).catch(o)})}var Od=(r,t)=>Je({retryFunction:Eh,settings:{retries:3,timeout:0},onError:t,onRetrying:r});function fh(r,t,e){return new Promise((i,o)=>{let s=null;Ws([Od(n=>t.count[0]=n+1,(n,a)=>{t.msg[0]=n.message,s||a()})(Dd(e,u.MAIN),r,{get timeout(){return ki(2+t.count[0])*1e3}}),Od(n=>t.count[1]=n+1,(n,a)=>{t.msg[1]=n.message,s||a()})(Dd(e,u.BACKUP),r,{get timeout(){return ki(2+t.count[1])*1e3}})]).then(n=>{s=n,i(s)}).catch(o)})}var Ih=0;var ls=class extends Th{constructor(e){super("room");this.seq=++Ih;this.role="anchor";this.localTracks=new Set;this.enableAutoPlayDialog=!0;this.autoReceiveAudio=!0;this.autoReceiveVideo=!0;this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null};this._log=g.createLogger({id:`r${this.seq}`});this._joinedTimestamp=0;this._isDestroyed=!1;this.useStringRoomId=!!e.useStringRoomId,re(e.autoReceiveAudio)&&(this.autoReceiveAudio=e.autoReceiveAudio),re(e.autoReceiveVideo)&&(this.autoReceiveVideo=e.autoReceiveVideo),re(e.enableAutoPlayDialog)&&(this.enableAutoPlayDialog=e.enableAutoPlayDialog),this.keyPointManager=new Rd({room:this,frameWorkType:e.frameWorkType,component:e.component,language:e.language}),this.callDurationCalculator=new Cd({room:this}),this.badCaseDetector=new Nd({room:this}),this.audioManager=new Fo({room:this})}get isMainStreamPublished(){for(let e of this.localTracks)if(e.mediaType&4)return!0;return!1}get isAuxStreamPublished(){for(let e of this.localTracks)if(e.mediaType&2)return!0;return!1}get hasAuxStream(){for(let e of this.remotePublishedUserMap.values())if(e.muteState.hasAuxiliary)return!0;return this.isAuxStreamPublished}getLogger(){return this._log}get isJoined(){return this.state==="joined"}addTrack(e){return _(this,null,function*(){return this.publish(e)})}removeTrack(e){return _(this,null,function*(){return this.unpublish(e)})}replaceTrack(e){return _(this,null,function*(){})}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAIVoice(e){throw new Error("Method not implemented.")}getRemoteAudioStats(){return _(this,null,function*(){let e={};return this.remotePublishedUserMap.forEach(i=>{e[i.userId]=i.remoteAudioTrack.stat}),e})}getTransportStats(){return _(this,null,function*(){var i;let e={rtt:((i=this.quality)==null?void 0:i.uplinkRTT)||0,downlinksRTT:{}};if(this.quality)for(let o of this.quality.downlinkInfo)e.downlinksRTT[o.userId]=o.rtt;return e})}getRemoteVideoStats(){return _(this,arguments,function*(e="main"){let i={};return this.remotePublishedUserMap.forEach(o=>{let s=e==="auxiliary"?o.remoteAuxiliaryTrack:o.remoteVideoTrack;i[o.userId]=s.stat}),i})}checkDestroy(){if(this._isDestroyed)throw new A({code:T.INVALID_OPERATION,message:y({key:C.CLIENT_DESTROYED,data:{funName:"join"}})})}destroy(){if(this.isJoined)throw this._log.warn(ue.INVALID_DESTROY),new A({code:T.INVALID_OPERATION,message:y({key:C.INVALID_DESTROY})});this._log.info("destroy room"),this.keyPointManager.destroy(),this.callDurationCalculator.destroy(),this.badCaseDetector.destroy(),this._isDestroyed=!0,E.emit(p.ROOM_DESTROY,{room:this})}schedule(e,i,o){return _(this,null,function*(){var n,a;let s=w();try{let c=yield yd({userId:this.userId,sdkAppId:this.sdkAppId,roomId:e,useStringRoomId:this.useStringRoomId,version:o,userSig:this.userSig,frameWorkType:i});this._log.info(`schedule: ${JSON.stringify(c)}`),this.scheduleResult=R(R({},this.scheduleResult),c),J((n=c.config)==null?void 0:n.retryCount)&&Vs(c.config.retryCount),j((a=c.config)==null?void 0:a.loggerDomain)&&mr(c.config.loggerDomain),E.emit(p.JOIN_SCHEDULE_SUCCESS,{room:this,schedule:this.scheduleResult}),E.emit(p.API_SUCCESS_RATE,{room:this,apiName:"schedule",cost:w()-s})}catch(c){throw E.emit(p.API_SUCCESS_RATE,{room:this,apiName:"schedule",error:c}),c}})}};var Vt=new WeakMap,ze=new WeakMap;function jr(){return function(r,t,e){let i=e.value,o=({fn:s,args:n,context:a,resolve:c,reject:l})=>{s.apply(a,n).then(c,l)};return e.value=function(...s){return new Promise((a,c)=>{if(Vt.has(this)){let l=Vt.get(this),{length:h}=l;l.push({fn:i,args:s,context:this,resolve:a,reject:c}),h===0&&o({fn:i,args:s,context:this,resolve:a,reject:c})}else Vt.set(this,[{fn:i,args:s,context:this,resolve:a,reject:c}]),o({fn:i,args:s,context:this,resolve:a,reject:c})}).finally(()=>{let a=Vt.get(this);a&&(a.shift(),a[0]&&o(R({},a[0])))})},e}}function bd(r){return function(t,e,i){let o=i.value;return i.value=function(...s){let n=Vt.get(this);if(n){let a=n.filter((c,l)=>{if(l===0)return!0;let h=!0;return c.args.forEach(m=>{s.find(f=>f===m)||(h=!1)}),h?(c.reject(new A({code:T.API_CALL_ABORTED,message:r})),!1):!0});Vt.set(this,a)}return o.apply(this,s)},i}}function Ld(r){return function(t,e,i){let o=i.value;return i.value=function(...s){var a,c;let n=[];return(a=Vt.get(this))==null||a.forEach(l=>n.push(l)),(c=ze.get(this))==null||c.forEach(l=>l.forEach(h=>n.push(h))),n.forEach(l=>{l.reject(new A({code:T.API_CALL_ABORTED,message:r}))}),Vt.delete(this),ze.delete(this),o.apply(this,s)},i}}function Da(r){return function(t,e,i){let o=i.value,s=a=>J(r)?a[r]:r(...a),n=({fn:a,args:c,context:l,resolve:h,reject:m})=>{a.apply(l,c).then(h,m).finally(()=>{if(ze.has(l)&&ze.get(l).has(s(c))){let f=ze.get(l).get(s(c));f&&(f.shift(),f[0]&&n(R({},f[0])))}})};return i.value=function(...a){return new Promise((c,l)=>{if(ze.has(this))if(ze.get(this).has(s(a))){let h=ze.get(this).get(s(a));if(h){let{length:m}=h;h.push({fn:o,args:a,context:this,resolve:c,reject:l}),m===0&&n({fn:o,args:a,context:this,resolve:c,reject:l})}}else ze.get(this).set(s(a),[{fn:o,args:a,context:this,resolve:c,reject:l}]),n({fn:o,args:a,context:this,resolve:c,reject:l});else{let h=new Map;h.set(s(a),[{fn:o,args:a,context:this,resolve:c,reject:l}]),ze.set(this,h),n({fn:o,args:a,context:this,resolve:c,reject:l})}})},i}}import{ChangeState as $d,FSM as Lh}from"afsm";import Ch from"eventemitter3";import vd from"sdp-transform";var Pd=r=>{let t=oe(r),e={audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0};return t.media.forEach((i,o)=>{var s;if(i.ssrcs&&!I(i.ssrcs[0].id)){let n=Number(i.ssrcs[0].id),a=Number((s=i.ssrcs.filter(c=>c.attribute==="cname")[1])==null?void 0:s.id);switch(o){case 0:e.audioSsrc=n;break;case 1:e.bigVideoSsrc=n,e.bigVideoRtxSsrc=a;break;case 2:e.smallVideoSsrc=n,e.smallVideoRtxSsrc=a;break;case 3:e.auxVideoSsrc=n,e.auxVideoRtxSsrc=a;break}}}),e},Md=(r,t)=>{var a,c;let e=oe(r),i={ice:{ufrag:"",password:""},dtls:{hash:"",fingerprint:"",setup:""},audio:{codecs:[],extensions:[]},video:{codecs:[],extensions:[]},useDataChannel:t};i.ice.ufrag=String(e.media[0].iceUfrag),i.ice.password=e.media[0].icePwd||"",e.fingerprint&&(i.dtls.hash=e.fingerprint.type,i.dtls.fingerprint=e.fingerprint.hash,i.dtls.setup=e.setup||""),e.media[0].fingerprint&&(i.dtls.hash=e.media[0].fingerprint.type,i.dtls.fingerprint=e.media[0].fingerprint.hash),i.dtls.setup=e.media[0].setup||"";let o=e.media[0],s=e.media[1];o.ext&&(i.audio.extensions=o.ext.map(l=>({id:l.value,uri:l.uri}))),s.ext&&(i.video.extensions=s.ext.map(l=>({id:l.value,uri:l.uri})));let n={codec:o.rtp[0].codec,fmtp:o.fmtp[0].config,payload:o.fmtp[0].payload,rate:o.rtp[0].rate,channel:o.rtp[0].encoding,rtcpFb:[],rtx:0};(a=o.rtcpFb)==null||a.forEach(({payload:l,type:h,subtype:m})=>{if(l===n.payload){let f={id:h,params:[]};m&&f.params.push(m),n.rtcpFb.push(f)}}),i.audio.codecs.push(n);for(let l=0;l<s.rtp.length;l++){if(["rtx","red","ulpfec"].includes(s.rtp[l].codec))continue;let h=s.fmtp.filter(m=>m.payload===s.rtp[l].payload)[0];i.video.codecs.push({payload:s.rtp[l].payload,codec:s.rtp[l].codec,fmtp:h?h.config:"",rate:s.rtp[l].rate,rtx:((c=s.rtp[l+1])==null?void 0:c.codec)==="rtx"?s.rtp[l+1].payload:0,rtcpFb:((s==null?void 0:s.rtcpFb)||[]).filter(m=>m.payload===s.rtp[l].payload).map(({type:m,subtype:f})=>({id:m,params:f?[f]:[]}))})}return i},kd=({serverAbility:r,clientAbility:t,offerSDP:e,enableCustomMessage:i})=>{let o=oe(e),s={extmapAllowMixed:"extmap-allow-mixed",groups:o.groups,icelite:"ice-lite",media:[],msidSemantic:{semantic:"",token:"WMS"},name:"-",origin:{address:"127.0.0.1",username:"-",sessionId:String(Date.now()),sessionVersion:1,netType:"IN",ipVer:4},timing:{start:0,stop:0},version:0},n={candidates:r.candidates.map(a=>({component:1,foundation:"1",generation:0,ip:a.ip,port:a.port,priority:a.priority,transport:a.foundation,type:a.type})),connection:{version:4,ip:"0.0.0.0"},direction:u.TRANSCEIVER_DIRECTION_RECVONLY,ext:r.audio.extensions.map(a=>({value:a.id,uri:a.uri})),fingerprint:{type:r.dtls.hash,hash:r.dtls.fingerprint},fmtp:[{payload:r.audio.codecs[0].payload,config:r.audio.codecs[0].fmtp}],icePwd:r.ice.password,iceUfrag:r.ice.ufrag,mid:"0",payloads:String(r.audio.codecs[0].payload),port:o.media[0].port,protocol:o.media[0].protocol,type:u.AUDIO,setup:r.dtls.setup,rtcpFb:r.audio.codecs[0].rtcpfb.map(a=>({payload:r.audio.codecs[0].payload,type:a.id,subtype:a.params[0]})),rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[{payload:r.audio.codecs[0].payload,codec:r.audio.codecs[0].codec,rate:r.audio.codecs[0].rate,encoding:r.audio.codecs[0].channels}]};return s.media.push(n),[1,2,3].forEach(a=>{s.media.push(Oa({mid:a,serverAbility:r,clientAbility:t,parsedOffer:o}))}),i&&s.media.push(o.media.find(a=>a.mid==="dc")),Pe(s)},Oa=({mid:r,serverAbility:t,clientAbility:e,parsedOffer:i,useAllCodec:o=!1})=>{let s={candidates:t.candidates.map(n=>({component:1,foundation:"1",generation:0,ip:n.ip,port:n.port,priority:n.priority,transport:n.foundation,type:n.type})),connection:{version:4,ip:"0.0.0.0"},direction:u.TRANSCEIVER_DIRECTION_RECVONLY,ext:t.video.extensions.map(n=>({value:n.id,uri:n.uri})),fingerprint:{type:t.dtls.hash,hash:t.dtls.fingerprint},fmtp:[],icePwd:t.ice.password,iceUfrag:t.ice.ufrag,mid:String(r),payloads:"",port:i.media[0].port,protocol:i.media[0].protocol,type:u.VIDEO,setup:t.dtls.setup,rtcpFb:[],rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[]};if(t.video.codecs.length>0)if(o)for(let n=0;n<t.video.codecs.length;n++)us(s,t.video.codecs[n]);else{let n=t.video.codecs.findIndex(a=>a.codec.toLowerCase()===(t.useVp8?"vp8":"h264"));us(s,t.video.codecs[n])}else if(o)for(let n=0;n<e.video.codecs.length;n++)us(s,e.video.codecs[n]);else us(s,e.video.codecs[0]);return s.payloads=s.payloads.trim(),s},us=(r,t)=>{r.payloads=`${r.payloads} ${t.payload}`,r.fmtp.push({payload:t.payload,config:t.fmtp}),r.rtcpFb=[...r.rtcpFb||[],...(t.rtcpfb||t.rtcpFb).map(e=>({payload:t.payload,type:e.id,subtype:e.params[0]}))],r.rtp.push({payload:t.payload,codec:t.codec.toUpperCase(),rate:t.rate}),t.rtx&&(r.payloads=`${r.payloads} ${t.rtx}`,r.fmtp.push({payload:t.rtx,config:`apt=${t.payload}`}),r.rtp.push({payload:t.rtx,codec:"rtx",rate:t.rate}))};function Sh(r){let t=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);r.ext&&(r.ext=r.ext.filter(e=>!t.has(e.uri)))}function gh(r){if(!r.rtcpFb)return;let t=[];r.rtcpFb.forEach((e,i)=>{var o;t.push(e),r.rtcpFb&&((o=r.rtcpFb[i+1])==null?void 0:o.payload)!==e.payload&&e.type!=="rrtr"&&t.push({payload:e.payload,type:"rrtr"})}),r.rtcpFb=t}function Ah(r){r.type===u.VIDEO&&r.fmtp&&r.fmtp.forEach(t=>{t.config.includes("apt")||(t.config+=";sps-pps-idr-in-keyframe=1")})}function Rh(r){r.type===u.AUDIO&&r.fmtp&&r.fmtp.forEach(t=>{t.config+=";sprop-stereo=1;stereo=1"})}var wd=r=>{let t=vd.parse(r);return t.media.forEach(e=>{var i;(e.type===u.AUDIO||e.type===u.VIDEO)&&(gh(e),Ah(e),Rh(e),Sh(e)),((i=e.payloads)==null?void 0:i.includes("datachannel"))&&t.groups&&e.mid&&(t.groups[0].mids=t.groups[0].mids.replace(e.mid,"dc"),e.mid="dc")}),vd.write(t)};var Ut=(a=>(a.TRACK="track",a.DATA_CHANNEL_MESSAGE="data_channel_msg",a[a.CONNECTION_STATE_CHANGED="connection-state-changed"]="CONNECTION_STATE_CHANGED",a[a.FIREWALL_RESTRICTION="firewall-restriction"]="FIREWALL_RESTRICTION",a.RECONNECTED="spc-reconnected",a.RECONNECT_FAILED="spc-reconnect-failed",a.ERROR="error",a))(Ut||{}),Ud=0,xd=!1,Nh=new Set,Dh=r=>Ud>2&&!xd&&Nh.size===0&&r,Oh=1,qi=class extends Ch{constructor({signalChannel:e,room:i,enableCustomMessage:o}){super();d(this,"currentState","DISCONNECTED");d(this,"_room");d(this,"_signalChannel");d(this,"_peerConnection",null);d(this,"_datachannel",null);d(this,"_enableCustomMessage");d(this,"_log");d(this,"_downlinkMIDMap",new Map);d(this,"_reconnectionTimer",-1);d(this,"reconnectionCount",0);d(this,"_clientAbility",null);d(this,"_serverAbility",null);d(this,"addDownlinkQueue",new Set);d(this,"removeDownlinkQueue",new Set);d(this,"_parsedAnswer",null);d(this,"_updateSDPPromise",null);d(this,"_waitForPCConnectedPromise");d(this,"_waitForPCConnectedPromiseReject",null);d(this,"_isSDPLogged",!1);this._room=i,this._enableCustomMessage=o,this._signalChannel=e,this._log=g.createLogger({id:`spc${Oh++}`,userId:this._room.userId,sdkAppId:this._room.sdkAppId})}get isH264EncodeSupported(){let e=this._room.checkSystemResult.detail.isH264EncodeSupported;return this._serverAbility&&(e=e&&!!this._serverAbility.video.codecs.find(i=>i.codec.toLowerCase()==="h264")),e}get isVP8EncodeSupported(){let e=this._room.checkSystemResult.detail.isVp8EncodeSupported;return this._serverAbility&&(e=e&&this._serverAbility.useVp8),e}get uplinkSSRC(){return this._peerConnection&&this._peerConnection.localDescription?Pd(this._peerConnection.localDescription.sdp):{audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0}}get isReconnecting(){return this.currentState==="RECONNECTING"||this._reconnectionTimer>0||this.reconnectionCount>0}initialize(){return _(this,null,function*(){try{this._peerConnection=new RTCPeerConnection({offerExtmapAllowMixed:!0,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._room.sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"}),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this),this._peerConnection.ontrack=i=>this.emit("track",i),this._enableCustomMessage&&(this._datachannel=this._peerConnection.createDataChannel(`${this._room.userId}dc`),this._datachannel.binaryType="arraybuffer",this._datachannel.onopen=()=>{this._log.info("datachannel open")},this._datachannel.onclose=()=>{this._log.warn("datachannel close")},this._datachannel.onmessage=i=>{let o=new ba(i.data);this.emit("data_channel_msg",{data:o})},this._datachannel.onerror=i=>{this._log.warn("datachannel error",i)}),this._peerConnection.addTransceiver(u.AUDIO,{direction:u.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:u.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:u.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:u.TRANSCEIVER_DIRECTION_SENDONLY});let e=yield this._peerConnection.createOffer();return yield this.setOffer(e),this._clientAbility=Md(e.sdp,this._enableCustomMessage),this._clientAbility}catch(e){throw this._log.error(`initialize failed ${e}`),e}})}connect(e,i=!1){return _(this,null,function*(){try{if(this.currentState==="CONNECTED")return;let o=w(),s={type:"answer",sdp:kd({serverAbility:e,clientAbility:this._clientAbility,offerSDP:this._peerConnection.localDescription.sdp,enableCustomMessage:this._enableCustomMessage})};this._serverAbility=e,yield this.setAnswer(s),yield this.waitForPeerConnectionConnected(),i||E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCConnect",cost:Math.min(w()-o,30*1e3)})}catch(o){let s=o instanceof A&&o.code===T.API_CALL_ABORTED;throw s||this._log.error(`connect failed: ${o} ${e}`),this.reset(),!s&&!this.isReconnecting&&(E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCConnect",error:o}),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()),o}})}reconnect(){return _(this,null,function*(){if(this._reconnectionTimer!==-1){this._log.warn("reconnect() is reconnecting, ignore current reconnection");return}if(!this._signalChannel.isConnected){this._log.warn("reconnect() wait signal channel is connected"),this._signalChannel.once(ie.CONNECTED,this.reconnect,this);return}try{this.reconnectionCount++,this._log.warn(`reconnect() trying [${this.reconnectionCount}]`),this.reset();let e=yield this.initialize(),i=yield this._signalChannel.sendWaitForResponse({command:G.REBUILD_PEER_CONNECTION,responseCommand:V.REBUILD_PEER_CONNECTION_RES,data:{ability:e},enableLog:!1});yield this.connect(i.data.data.ability,!0),this._log.warn("reconnect() successfully"),this.stopReconnection(),this.emit("spc-reconnected")}catch(e){if(!this.isReconnecting)return;if(e!=null&&e.message.includes("timeout")){let i=ye(this.reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${i/1e3}s`),this._reconnectionTimer=window.setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},i)}else this._log.error(`reconnect() failed ${e}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCReconnect",error:e}),this.reconnectionCount>=it()&&this._log.warn(`SDK has tried reconnect for ${it()} times, but all failed, please check your network`),this.stopReconnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.emit("error")}})}getPeerConnection(){return this._peerConnection}startReconnection(){return _(this,null,function*(){this._log.warn("start reconnect"),this.emitConnectionStateChangedEvent("RECONNECTING");let e=w();yield this.reconnect(),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCReconnect",cost:Math.min(w()-e,30*1e3)})})}stopReconnection(){this.isReconnecting&&(this._log.info("stop reconnect"),this.reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(ie.CONNECTED,this.reconnect,this))}checkPeerConnectionToReconnect(){var e;!this.isReconnecting&&((e=this._peerConnection)==null?void 0:e.connectionState)===q.CLOSED&&this.startReconnection()}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onConnectionStateChange(e){let i=this._peerConnection.iceConnectionState,o=this.getDTLSTransportState();if(this._log.info(`connectionState: ${e.target.connectionState}, ICE: ${i}, DTLS: ${o}`),e.target.connectionState===q.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),e.target.connectionState===q.FAILED||e.target.connectionState===q.CLOSED){let s=`ICE/DTLS Transport connection ${e.target.connectionState}. ICE Transport state: ${i}, DTLS Transport state: ${o}`,n=new A({message:s,code:T.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()}(e.target.connectionState===q.CONNECTED||e.target.connectionState===q.COMPLETED)&&(this.logSelectedCandidate(),this.emitConnectionStateChangedEvent("CONNECTED"))}getDTLSTransportState(){if(!this._peerConnection)return Ue;let e=null;return!Ui()||this._peerConnection.getSenders().length===0?Ue:(e=this._peerConnection.getSenders()[0].transport,!Zt()||this._peerConnection.getReceivers().length===0?Ue:e?e.state:Ue)}emitConnectionStateChangedEvent(e){e!==this.currentState&&(this.currentState==="RECONNECTING"&&e==="CONNECTING"||(this.emit(Ut.CONNECTION_STATE_CHANGED,{prevState:this.currentState,state:e}),this.currentState=e))}logSelectedCandidate(){return _(this,null,function*(){if(!this._peerConnection)return;let e=yield this._peerConnection.getStats();for(let[i,o]of e)if(Ot(o)){let s=e.get(o.localCandidateId),n=e.get(o.remoteCandidateId);s&&this._log.info(`local candidate: ${s.candidateType} ${s.protocol}:${s.ip||s.address}:${s.port} ${s.networkType||""} ${s.candidateType==="relay"?`relayProtocol:${s.relayProtocol}`:""}`),n&&this._log.info(`remote candidate: ${n.candidateType} ${n.protocol}:${n.ip||n.address}:${n.port}`);break}})}waitForPeerConnectionConnected(){return this._waitForPCConnectedPromise?this._waitForPCConnectedPromise:(this._waitForPCConnectedPromise=new Promise((e,i)=>{if(this.currentState==="CONNECTED")return e();this._waitForPCConnectedPromiseReject=i;let o=c=>{c.state==="CONNECTED"&&(clearTimeout(a),n(),e())},s=({room:c})=>{c===this._room&&(clearTimeout(a),n(),i(new A({code:T.API_CALL_ABORTED,message:y({key:C.CONNECTION_ABORTED,data:"leave room"})})))},n=()=>{E.off(p.LEAVE_SUCCESS,s,this),this.off(Ut.CONNECTION_STATE_CHANGED,o,this)},a=setTimeout(()=>{n();let c=new A({code:T.API_CALL_TIMEOUT,message:"connection timeout"});Ud+=1,Dh(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),xd=!0,this.emit(Ut.FIREWALL_RESTRICTION)),i(c)},Tr);E.on(p.LEAVE_SUCCESS,s,this),this.on(Ut.CONNECTION_STATE_CHANGED,o,this)}),this._waitForPCConnectedPromise=this._waitForPCConnectedPromise.finally(()=>{this._waitForPCConnectedPromise=null,this._waitForPCConnectedPromiseReject=null}),this._waitForPCConnectedPromise)}waitForReconnected(){return this.isReconnecting?new Promise((e,i)=>{this.once("spc-reconnected",e),this.once("error",i)}):Promise.resolve()}addDownlink(e){return _(this,null,function*(){if(this._log.info(`addDownlink(${e.userId}) trying`),this.isReconnecting&&(yield this.waitForReconnected()),this.updateLocalAndRemoteSDPConfig(e),this.addDownlinkQueue.size===0)try{yield this.updateSDP({isNeedToCreateOffer:!0}),this._log.info(`addDownlink(${e.userId}) done`)}catch(i){this._log.info(`addDownlink(${e.userId}) failed`),yield this.startReconnection()}})}updateLocalAndRemoteSDPConfig({ssrc:e,tinyId:i}){if(!this._peerConnection)return;this._log.info(`updateLocalAndRemoteSDPConfig ${JSON.stringify(e)} ${i}`);let o=this._peerConnection.getTransceivers().filter(l=>l.direction==="inactive").slice(0,3).map(l=>(l.direction=u.TRANSCEIVER_DIRECTION_RECVONLY,Number(l.mid)));o.length===0&&(this._peerConnection.addTransceiver(u.AUDIO,{direction:u.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:u.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(u.VIDEO,{direction:u.TRANSCEIVER_DIRECTION_RECVONLY})),this._parsedAnswer||(this._parsedAnswer=oe(this._peerConnection.remoteDescription.sdp));let s,n,a;if(o.length===3)s=this._parsedAnswer.media.find(l=>Number(l.mid)===Number(o[0])),n=this._parsedAnswer.media.find(l=>Number(l.mid)===Number(o[1])),a=this._parsedAnswer.media.find(l=>Number(l.mid)===Number(o[2]));else{s=JSON.parse(JSON.stringify(this._parsedAnswer.media[0]));let l=Oa({mid:1,serverAbility:this._serverAbility,clientAbility:this._clientAbility,parsedOffer:oe(this._peerConnection.localDescription.sdp),useAllCodec:!0});n=JSON.parse(JSON.stringify(l)),a=JSON.parse(JSON.stringify(l)),s.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(s),n.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(n),a.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(a)}s.direction=u.TRANSCEIVER_DIRECTION_SENDONLY,s.ssrcs=[{id:e.audio,attribute:"cname",value:`${i}`},{id:e.audio,attribute:"msid",value:`${i}-${u.MAIN} ${i}-audio`}],n.direction=u.TRANSCEIVER_DIRECTION_SENDONLY,n.ssrcs=[{id:e.video,attribute:"cname",value:`${i}`},{id:e.video,attribute:"msid",value:`${i}-${u.MAIN} ${i}-bigvideo`},{id:e.videoRtx,attribute:"cname",value:`${i}`},{id:e.videoRtx,attribute:"msid",value:`${i}-${u.MAIN} ${i}-bigvideo`}],n.ssrcGroups=[{semantics:"FID",ssrcs:`${e.video} ${e.videoRtx}`}],a.direction=u.TRANSCEIVER_DIRECTION_SENDONLY;let c=`${i}-aux`;a.ssrcs=[{id:e.auxiliary,attribute:"cname",value:c},{id:e.auxiliary,attribute:"msid",value:`${c} ${i}-aux${u.VIDEO}`},{id:e.auxiliaryRtx,attribute:"cname",value:`${c} ${i}-aux${u.VIDEO}`},{id:e.auxiliaryRtx,attribute:"msid",value:`${c} ${i}-aux${u.VIDEO}`}],a.ssrcGroups=[{semantics:"FID",ssrcs:`${e.auxiliary} ${e.auxiliaryRtx}`}],this._parsedAnswer.groups&&(this._parsedAnswer.groups[0].mids=this._parsedAnswer.media.map(l=>l.mid).join(" ")),this._downlinkMIDMap.set(i,[s.mid,n.mid,a.mid])}removeDownlink(e,i){return _(this,null,function*(){if(!this._downlinkMIDMap.has(e)||!this._peerConnection)return;this._log.info(`removeDownlink(${i}) trying`),this.isReconnecting&&(yield this.waitForReconnected());let o=this._downlinkMIDMap.get(e),s=!1;this._peerConnection.getTransceivers().forEach(n=>{o!=null&&o.includes(Number(n.mid))&&(s=!0,n.direction="inactive")}),this._parsedAnswer||(this._parsedAnswer=oe(this._peerConnection.remoteDescription.sdp)),this._parsedAnswer.media.forEach(n=>{o!=null&&o.includes(Number(n.mid))&&(s=!0,n.direction="inactive",n.ssrcs=[],n.ssrcGroups=[])}),this.removeDownlinkQueue.size===0&&s&&(yield this.updateSDP({isNeedToCreateOffer:!0,tinyIdRemoving:e})),this._downlinkMIDMap.delete(e),this._log.info(`removeDownlink(${i}) done`)})}getDownlinkMids(e){return this._downlinkMIDMap.get(e)}setBandwidth(e){return _(this,null,function*(){if(!this._peerConnection)return;let{audio:i,bigVideo:o,smallVideo:s,auxVideo:n}=e;try{if(Nr()){let a=this._peerConnection.getSenders().slice(0,4);for(let c=0;c<a.length;c++){let l=a[c],h;c===0&&i?h=i:c===1&&o?h=o:c===2&&s?h=s:c===3&&n&&(h=n),h&&(yield this.setSenderMaxBitrate(l,h))}}else yield this.setBandwidthBySDP(e);Object.keys(e).forEach(a=>{e[a]&&this._log.info(`${a} bandwidth was set to ${e[a]} kbps`)})}catch(a){this._log.error(`failed to set bandwidth${a}`)}})}setSenderMaxBitrate(e,i){let o=e.getParameters();return(!o.encodings||o.encodings.length===0)&&(o.encodings=[{}]),i==="unlimited"?delete o.encodings[0].maxBitrate:o.encodings[0].maxBitrate=i*1e3,e.setParameters(o)}setBandwidthBySDP({audio:e,bigVideo:i,smallVideo:o,auxVideo:s}){if(!this._peerConnection||!this._peerConnection.localDescription)return;let n=oe(this._peerConnection.localDescription.sdp);this._parsedAnswer||(this._parsedAnswer=oe(this._peerConnection.remoteDescription.sdp));let a=Y?"TIAS":"AS";e&&(n.media[0].bandwidth=[{type:a,limit:Y?e*1e3:e}],this._parsedAnswer.media[0].bandwidth=[{type:a,limit:Y?e*1e3:e}]),i&&(n.media[1].bandwidth=[{type:a,limit:Y?i*1e3:i}],this._parsedAnswer.media[1].bandwidth=[{type:a,limit:Y?i*1e3:i}]),o&&(n.media[2].bandwidth=[{type:a,limit:Y?o*1e3:o}],this._parsedAnswer.media[2].bandwidth=[{type:a,limit:Y?o*1e3:o}]),s&&(n.media[3].bandwidth=[{type:a,limit:Y?s*1e3:s}],this._parsedAnswer.media[3].bandwidth=[{type:a,limit:Y?s*1e3:s}]);let c={type:"offer",sdp:Pe(n)};return this.updateSDP({localDescription:c})}updateSDP({isNeedToCreateOffer:e=!1,localDescription:i,tinyIdRemoving:o}){if(!this._parsedAnswer)return;let s=Pe(this._parsedAnswer);return this._updateSDPPromise=new Promise((n,a)=>_(this,null,function*(){var c,l;try{e&&this._peerConnection&&(this._log.info("creating offer"),i=yield this._peerConnection.createOffer()),i&&(yield this.setOffer(i)),yield this.setAnswer({type:"answer",sdp:s}),this._updateSDPPromise=null,n()}catch(h){this._log.error(h),!this._isSDPLogged&&this._peerConnection&&(this._log.warn(`transceivers: ${JSON.stringify(this._peerConnection.getTransceivers().map(({mid:m,currentDirection:f,direction:L,stopped:D})=>({mid:m,currentDirection:f,direction:L,stopped:D})))}`),this._log.warn(`parsedAnswer: ${JSON.stringify(this._parsedAnswer)}`),this._log.warn(`local sdp: ${i==null?void 0:i.sdp}`||((c=this._peerConnection.localDescription)==null?void 0:c.sdp)),this._log.warn(`remote sdp: ${s}`||((l=this._peerConnection.remoteDescription)==null?void 0:l.sdp)),this._isSDPLogged=!0),this._updateSDPPromise=null,a(h)}})),this._updateSDPPromise}setOffer(e){return this._log.info("setting offer"),this._peerConnection.setLocalDescription({type:"offer",sdp:wd(e.sdp)})}setAnswer(e){return this._log.info("setting answer"),this._room.enableHWEncoder&&e.sdp&&(e.sdp=e.sdp.replaceAll("42e01f","42001f")),this._peerConnection.setRemoteDescription(e)}sendDataChannelMessage(e){var i;(i=this._datachannel)==null||i.send(e)}reset(){var e;(e=this._peerConnection)==null||e.close(),this._waitForPCConnectedPromise=null,this._parsedAnswer=null}close(){this._log.info("close pc"),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._downlinkMIDMap.clear(),this.stopReconnection(),this.removeAllListeners()}};N([jr()],qi.prototype,"updateSDP",1);var ya=class{constructor(t){d(this,"tag");d(this,"len");d(this,"data");let e=new DataView(t);this.tag=e.getUint16(),this.len=e.getUint16(2),this.data=new Uint8Array(t).slice(4,2+2+this.len).buffer}},ba=class{constructor(t){d(this,"tinyId");d(this,"data");let e=new DataView(t),i=0,o=[];for(;i<e.byteLength;){let s=e.getUint16(i+2),n=new ya(new Uint8Array(t).slice(i,i+2+2+s).buffer);o.push(n),i+=2+2+s}o.forEach(s=>{s.tag===1?this.tinyId=new TextDecoder().decode(s.data):s.tag===2&&(this.data=s.data)})}},Vd=new Set;function _i(){let r=Math.floor(Math.random()*4294967296);return Vd.has(r)?_i():(Vd.add(r),r)}import yh from"eventemitter3";var mi=class extends yh{constructor(e){super();d(this,"userId");d(this,"tinyId");d(this,"_sdpSemantics");d(this,"_isUplink");d(this,"_room");d(this,"_log");d(this,"_signalChannel");d(this,"_currentState","DISCONNECTED");d(this,"_prevTime",-1);d(this,"_enableSEI");d(this,"_sei");this.userId=e.userId,this.tinyId=e.tinyId,this._room=e.room,this._sdpSemantics=e.room.sdpSemantics,this._isUplink=e.isUplink,this._log=g.createLogger({id:"n",userId:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=e.signalChannel,this._enableSEI=e.enableSEI,this._enableSEI&&bt&&(this._sei=new ss(this,this._log,this._isUplink))}get _peerConnection(){var e;return((e=this.singlePC)==null?void 0:e.getPeerConnection())||null}get singlePC(){return this._room.singlePC}close(e){this._log.info("close connection"),this.emit("closed",e),this._sei&&(this._sei.destroy(),this._sei=null)}emitConnectionStateChangedEvent(e){return e===this._currentState?!1:(E.emit(p.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:e,remoteUserId:this._isUplink?void 0:this.userId}),this.emit("connection-state-changed",{prevState:this._currentState,state:e}),this._currentState=e,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}getCurrentState(){return this._currentState}get isH264(){var e,i;return!!((i=(e=this._peerConnection)==null?void 0:e.remoteDescription)!=null&&i.sdp.includes("H264"))}};var La=class extends mi{constructor(e){super(k(R({},e),{isUplink:!0}));d(this,"localMainAudioTrack",null);d(this,"localMainVideoTrack",null);d(this,"localAuxAudioTrack",null);d(this,"localAuxVideoTrack",null);d(this,"_isPublishingAux",!1);d(this,"_publishingLocalAudioTrack");d(this,"_publishingLocalVideoTrack");d(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0});d(this,"_smallGenerator");d(this,"_audioManager");this._audioManager=e.audioManager,this._smallGenerator=null,this.initialize()}get ssrc(){if(!this.singlePC)return{audio:0,video:0,videoRtx:0,small:0,smallRtx:0,auxiliary:0,auxiliaryRtx:0};let{audioSsrc:e,bigVideoSsrc:i,bigVideoRtxSsrc:o,smallVideoSsrc:s,smallVideoRtxSsrc:n,auxVideoSsrc:a,auxVideoRtxSsrc:c}=this.singlePC.uplinkSSRC;return{audio:e||0,video:i||0,videoRtx:o||0,small:s||0,smallRtx:n||0,auxiliary:a||0,auxiliaryRtx:c||0}}get isMainStreamPublished(){return!!(this.localMainAudioTrack||this.localMainVideoTrack)}get isAuxStreamPublished(){return!!(this.localAuxVideoTrack||this.localAuxAudioTrack)}get publishState(){var i,o,s,n;let e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let a=this._peerConnection.getSenders();a&&(be()?(e.audio=!!((i=a[0])!=null&&i.track),e.bigVideo=!!((o=a[1])!=null&&o.track),e.smallVideo=!!((s=a[2])!=null&&s.track),e.auxVideo=!!((n=a[3])!=null&&n.track)):a.forEach(c=>{c.track&&(c.track.kind===u.AUDIO?e.audio=!0:(e.bigVideo=!0,this._smallGenerator&&(e.smallVideo=!0)))}))}return e}initialize(){this.installEvents()}reset(){this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){var e;this.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this.on("connection-state-changed",this.handleConnectionStateChange,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||(e=this.singlePC)==null||e.on("spc-reconnected",this.onSinglePCReconnected,this)}uninstallEvents(){var e;this.off("connection-state-changed",this.handleConnectionStateChange,this),(e=this.singlePC)==null||e.off("spc-reconnected",this.onSinglePCReconnected,this)}emitConnectionStateChangedEvent(e,i){var n,a,c;let o=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&o!==e&&(i?i.emit("connection-state-changed",{prevState:o,state:e}):((n=this.localMainVideoTrack)==null||n.emit("connection-state-changed",{prevState:o,state:e}),(a=this.localAuxVideoTrack)==null||a.emit("connection-state-changed",{prevState:o,state:e}),(c=this._publishingLocalVideoTrack)==null||c.emit("connection-state-changed",{prevState:o,state:e}))),s}publish(s){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,isAuxiliary:o}){var a,c,l,h,m,f;if(!this.singlePC)return;if(yield this.singlePC.waitForPeerConnectionConnected(),e&&(this._publishingLocalAudioTrack=e),i){if(!this.singlePC.isH264EncodeSupported&&!this.singlePC.isVP8EncodeSupported)throw new A({code:T.NOT_SUPPORTED_H264,message:y({key:C.NOT_SUPPORTED_H264ENCODE})});this._publishingLocalVideoTrack=i}this._isPublishingAux=o;let n;i&&!o&&i.small&&(this._smallGenerator=new mt(i),yield this._smallGenerator.initialize(),n=this._smallGenerator.generateSmallVideoTrack(i.small)),yt()&&(yield this.publishByTransceiver({localAudioTrack:e,localVideoTrack:i,smallTrack:n,isAuxiliary:o})),this._publishingLocalAudioTrack=null,this._publishingLocalVideoTrack=null,this._isPublishingAux=!1,o?(i&&(this.localAuxVideoTrack=i),e&&(this.localAuxAudioTrack=e)):(i&&(this.localMainVideoTrack=i),e&&(this.localMainAudioTrack=e)),yield this.singlePC.setBandwidth({audio:((a=this.localMainAudioTrack)==null?void 0:a.profile.bitrate)||((c=this.localAuxAudioTrack)==null?void 0:c.profile.bitrate),bigVideo:(l=this.localMainVideoTrack)==null?void 0:l.profile.bitrate,smallVideo:(m=(h=this.localMainVideoTrack)==null?void 0:h.small)==null?void 0:m.bitrate,auxVideo:(f=this.localAuxVideoTrack)==null?void 0:f.profile.bitrate}),yield this._signalChannel.sendWaitForResponse({command:G.SPC_PUBLISH,responseCommand:V.SPC_PUBLISH_RESULT,data:k(R({},this.singlePC.uplinkSSRC),{state:this.publishState})}),this.sendMediaSettings(),this.installTrackMuteEvents(e,i),this.sendMutedFlag()})}publishByTransceiver({localAudioTrack:e,localVideoTrack:i,smallTrack:o,isAuxiliary:s}){this._log.info("publish by transceiver");let n=new MediaStream;i&&Ht&&ur&&i.genCanvasTrack();let a=(i==null?void 0:i.canvasTrack)||(i==null?void 0:i.mediaTrack),c=this._audioManager.mediaStreamTrack,l=this._peerConnection.getTransceivers(),h=[];if(c){n.addTrack(c);let m=l[0].sender.replaceTrack(c);h.push(m)}if(a)if(n.addTrack(a),s){let m=l[3].sender.replaceTrack(a);h.push(m)}else{let m=l[1].sender.replaceTrack(a);h.push(m)}if(o){let m=l[2].sender.replaceTrack(o);h.push(m)}return Promise.all(h)}installTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.on("mute",this.sendMutedFlag,this),i==null||i.on("unmute",this.sendMutedFlag,this))})}uninstallTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.off("mute",this.sendMutedFlag,this),i==null||i.off("unmute",this.sendMutedFlag,this))})}unpublish(o){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i}){let s=i&&i===this.localAuxVideoTrack,n=e==null?void 0:e.mediaTrack,a=i==null?void 0:i.mediaTrack,c=this._peerConnection.getSenders(),l=[];n&&(this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield c[0].replaceTrack(null),l.push(0),this.localMainAudioTrack=null)),a&&(s?(yield c[3].replaceTrack(null),this.localAuxVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),l.push(3)):(yield c[1].replaceTrack(null),yield c[2].replaceTrack(null),this.localMainVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),l.push(1,2))),this.isMainStreamPublished||this.isAuxStreamPublished?(yield this.setTransceiverDirection(W.INACTIVE,l),yield this.doPublishChange(!1)):yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,i),i==null||i.emit("connection-state-changed",{prevState:this._currentState,state:"DISCONNECTED"})})}doPublishChange(e=!0){return _(this,null,function*(){let i={state:this.publishState,constraintConfig:this._mediaSettings},o=yield this._signalChannel.sendWaitForResponse({command:G.PUBLISH_STATE_CHANGE,data:i,responseCommand:V.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(o.data.code,o.data.message)})}doUnpublish(e=!1){return this._signalChannel.sendWaitForResponse({command:G.UNPUBLISH,commandDesc:"unpublish",responseCommand:V.UNPUBLISH_RESULT,enableLog:e}).catch(i=>{if(i.getCode()===T.API_CALL_TIMEOUT)return Promise.resolve();throw i})}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:i}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":i&&(this._mediaSettings.videoCodec="VP8");let o=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:s,localAuxVideoTrack:n}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?n=this._publishingLocalVideoTrack:s=this._publishingLocalVideoTrack),st){if(o&&o.mediaTrack){let a=o.mediaTrack.getSettings();this._mediaSettings.audioChannel=a.channelCount||1,this._mediaSettings.audioBps=o.profile.bitrate*1e3,this._mediaSettings.audioFs=a.sampleRate||0}if(s&&s.mediaTrack){let a=s.mediaTrack.getSettings();this._mediaSettings.videoWidth=a.width||0,this._mediaSettings.videoHeight=a.height||0,this._mediaSettings.videoFps=a.frameRate||0,this._mediaSettings.videoBps=s.profile.bitrate*1e3,s.small&&(this._mediaSettings.smallVideoWidth=s.small.width,this._mediaSettings.smallVideoHeight=s.small.height,this._mediaSettings.smallVideoFps=s.small.frameRate,this._mediaSettings.smallVideoBps=s.small.bitrate*1e3)}if(n&&n.mediaTrack){let a=n.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=a.width||0,this._mediaSettings.auxVideoHeight=a.height||0,this._mediaSettings.auxVideoFps=a.frameRate||0,this._mediaSettings.auxVideoBps=n.profile.bitrate*1e3}}else o&&o.mediaTrack&&(this._mediaSettings.audioChannel=o.profile.channelCount,this._mediaSettings.audioBps=o.profile.bitrate*1e3,this._mediaSettings.audioFs=o.profile.sampleRate),s&&s.mediaTrack&&(this._mediaSettings.videoWidth=s.profile.width,this._mediaSettings.videoHeight=s.profile.height,this._mediaSettings.videoFps=s.profile.frameRate,this._mediaSettings.videoBps=s.profile.bitrate*1e3);this._log.info(`updateMediaSettings: ${JSON.stringify(this._mediaSettings)}`)}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:G.UPDATE_CONSTRAINT_CONFIG,data:this._mediaSettings,responseCommand:V.UPDATE_CONSTRAINT_CONFIG_RES}).then(e=>{e.data.code!==0&&this._log.warn(e.data.message)}).catch(()=>{})}addTrack(e){return _(this,null,function*(){var o;if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is adding ${e.kind} track to current published local ${i?u.AUXILIARY:u.MAIN} stream`),(o=this._sei)==null||o.handleEncodedStreams(),be()&&(yield this.addTrackByTransceiver(e,i))})}addTrackByTransceiver(e,i){return _(this,null,function*(){var n;if(!e.mediaTrack)return;let o=this._peerConnection.getTransceivers(),s=e.mediaTrack;if(e.kind===u.AUDIO)this._audioManager.addAudioTrack(e),s=this._audioManager.mediaStreamTrack,yield o[0].sender.replaceTrack(s);else{let a=i?3:1;if(yield o[a].sender.replaceTrack(s),a===1&&((n=this.localMainVideoTrack)==null?void 0:n.small)){this._smallGenerator=new mt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let c=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield o[2].sender.replaceTrack(c)}o[a].direction===W.INACTIVE&&(yield this.setTransceiverDirection(W.SENDONLY,[a]))}this.updateMediaSettings(),yield this.doPublishChange()})}removeTrack(e){return _(this,null,function*(){if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is removing ${e.kind} track from current published local ${i?u.AUXILIARY:u.MAIN} stream`),be()&&(yield this.removeTrackByTransceiver(e,i))})}removeTrackByTransceiver(e,i){return _(this,null,function*(){if(!e.mediaTrack)return;let o=this._peerConnection.getTransceivers();if(e.kind===u.AUDIO)this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield o[0].sender.replaceTrack(null));else{let s=i?3:1;yield o[s].sender.replaceTrack(null),s===1&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield o[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(W.INACTIVE,[s])}this.updateMediaSettings(),yield this.doPublishChange()})}setTransceiverDirection(e,i){return _(this,null,function*(){if(!Y)return;let o=!1,s=!1;this._log.info(`setting transceiver ${i.join(",")} direction to ${e}`);let n=this._peerConnection.getTransceivers();if(i.forEach(l=>{n[l].direction!==e&&(n[l].direction=e,o=!0)}),o){this._log.info("updating offer");let l=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(l)}let a=-1,c=this._peerConnection.remoteDescription.sdp.split(`\r
`).map(l=>{if(l.match(new RegExp(`a=(${W.INACTIVE}|${W.RECVONLY}|${W.SENDONLY})`))&&a++,i.includes(a)){if(e===W.INACTIVE&&l.includes(`a=${W.RECVONLY}`))return s=!0,`a=${e}`;if(e===W.SENDONLY&&l.includes(`a=${W.INACTIVE}`))return s=!0,`a=${W.RECVONLY}`}return l}).join(`\r
`);s&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:c}))})}replaceTrack(e){return _(this,null,function*(){var n;let i=(n=this._peerConnection)==null?void 0:n.getSenders();if(!i||i.length===0||!e.mediaTrack)return;let o=e.mediaTrack,s=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;if(this._log.info(`is replacing ${o.kind} track on ${s?u.AUXILIARY:u.MAIN} stream`),o.kind===u.AUDIO&&i[0]&&(this._audioManager.addAudioTrack(e),this._audioManager.isMixed&&(o=this._audioManager.mediaStreamTrack),yield i[0].replaceTrack(o)),o.kind===u.VIDEO){if(!s&&i[1]&&(yield i[1].replaceTrack(o),this._smallGenerator&&i[2])){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new mt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let a=this._smallGenerator.generateSmallVideoTrack(this._room.smallStreamConfig);yield i[2].replaceTrack(a)}s&&i[3]&&(yield i[3].replaceTrack(o))}})}setBandwidth(s){return _(this,arguments,function*({bandwidth:e,type:i,videoType:o}){if(this.singlePC){let n={};i===u.AUDIO?n.audio=e:o==="big"?n.bigVideo=e:o==="small"?n.smallVideo=e:n.auxVideo=e,yield this.singlePC.setBandwidth(n)}})}sendMutedFlag(e){var s,n,a;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let o={audio:!!((s=this.localMainAudioTrack)!=null&&s.muted),bigVideo:!!((n=this.localMainVideoTrack)!=null&&n.muted),auxVideo:!!((a=this.localAuxVideoTrack)!=null&&a.muted)};this._log.info(`send muted state: ${JSON.stringify(o)}`),this._signalChannel.send(G.UPDATE_MUTE_STAT,o)}handleConnectionStateChange(e){e.state==="CONNECTED"&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&E.emit(p.SEND_FIRST_VIDEO_FRAME,{room:this._room})}getVideoTrackId(e=u.VIDEO){if(this._peerConnection){let i=this._peerConnection.getSenders();if(e===u.AUXILIARY&&i[3]&&i[3].track)return i[3].track.id;if(e===u.VIDEO&&i[1]&&i[1].track)return i[1].track.id}if(this.localMainVideoTrack&&e===u.VIDEO){let i=this.localMainVideoTrack.mediaTrack;if(i)return i.id}if(this.localAuxVideoTrack&&e===u.AUXILIARY){let i=this.localAuxVideoTrack.mediaTrack;if(i)return i.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,i){if(e!==0)throw e===Yt?(this._log.error(ue.NOT_SUPPORTED_H264ENCODE),new A({code:T.NOT_SUPPORTED_H264,message:y({key:C.NOT_SUPPORTED_H264ENCODE})})):new A({code:T.UNKNOWN,message:y({key:C.SIGNAL_RESPONSE_FAILED,data:{signalResponse:V.PUBLISH_RESULT,code:e,message:i}})})}sendSEI(e,i){var o;(o=this._sei)==null||o.push(e,i)}onSinglePCReconnected(){return _(this,null,function*(){this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0}))})}},va=La;function bh(r){return Object.keys(r).filter(t=>r[t])}var hs=class extends mi{constructor(e){super(k(R({},e),{isUplink:!1}));d(this,"_flag",0);d(this,"role","anchor");d(this,"remoteAudioTrack");d(this,"remoteVideoTrack");d(this,"remoteAuxiliaryTrack");d(this,"ssrc",{audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0});this.flag=e.flag,this.remoteAudioTrack=new Fi(this._room,this),this.remoteVideoTrack=new si(this._room,this),this.remoteAuxiliaryTrack=new Gi(this._room,this),this.initialize()}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(this.remoteVideoTrack.mediaType&8?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return Nt(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var i,o,s;e!==this._flag&&(this._flag=e,(i=this.remoteAudioTrack)==null||i.onFlagChanged(),(o=this.remoteVideoTrack)==null||o.onFlagChanged(),(s=this.remoteAuxiliaryTrack)==null||s.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===u.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){this.installEvents()}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents(),this.removeDownlink()}installEvents(){!this.singlePC||(this.listeners("track").includes(this.onTrack)||this.singlePC.on("track",this.onTrack,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||this.singlePC.on("spc-reconnected",this.onSinglePCReconnected,this))}uninstallEvents(){!this.singlePC||(this.singlePC.off("track",this.onTrack,this),this.singlePC.off("spc-reconnected",this.onSinglePCReconnected,this))}emitConnectionStateChangedEvent(e){var s,n;let i=this._currentState,o=super.emitConnectionStateChangedEvent(e);return o&&i!==e&&((s=this.remoteVideoTrack)==null||s.emit("connection-state-changed",{prevState:i,state:e}),(n=this.remoteAuxiliaryTrack)==null||n.emit("connection-state-changed",{prevState:i,state:e})),o}onTrack(e){let i=e.streams[0],{track:o}=e;if(i.id.split("-")[0]!==this.tinyId)return;let a=i.id.includes("aux")?"auxiliary":"main";this._log.debug(`ontrack ${a} ${o.kind}`);let c=u.AUDIO;o.kind===u.VIDEO&&(c=a===u.MAIN?u.VIDEO:u.AUXILIARY);let l=this.remoteAudioTrack;c===u.VIDEO?l=this.remoteVideoTrack:c===u.AUXILIARY&&(l=this.remoteAuxiliaryTrack),l.setMediaStream(i),l.setMediaStreamTrack(o)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,i){return _(this,null,function*(){try{if(this.isSubscriptionStateNotChanged(e))return;if(this._log.info(`subscribe ${i} ${JSON.stringify(e)}`),this.hasSSRC){let o="subscribe_change";Object.values(e).find(s=>s===!0)||(o="unsubscribe"),yield this.sendSubscription(o,e)}else yield this.doSubscribe(e)}catch(o){throw this._room.isJoined&&this.isStreamUnpublished(i)?(this._log.warn(`${o.message} ${JSON.stringify(this.muteState)}`),new A({code:T.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId} unpublished stream`})):o}})}unsubscribe(o){return _(this,arguments,function*({remoteTracks:e,streamType:i}){var a;if(i==="main"&&!this.isMainStreamSubscribed||i==="auxiliary"&&!this.isAuxStreamSubscribed){this._log.info(`${i} stream already unsubscribed`);return}let s=R({},this.subscribeState);e.forEach(c=>{switch(c.mediaType){case 1:s.audio=!1;break;case 4:s.video=!1;break;case 8:s.smallVideo=!1;break;case 2:s.auxiliary=!1;break;default:break}});let n="subscribe_change";Object.values(s).find(c=>c===!0)||(n="unsubscribe"),this._log.info(`${n==="unsubscribe"?n:"subscribe"} ${i} [${bh(s)}]`),n==="unsubscribe"&&((a=this.singlePC)==null||a.removeDownlinkQueue.add(this.tinyId)),yield this.sendSubscription(n,s),n==="unsubscribe"&&(this.remoteAudioTrack.setMediaStreamTrack(null),this.remoteVideoTrack.setMediaStreamTrack(null),this.remoteAuxiliaryTrack.setMediaStreamTrack(null),yield this.removeDownlink())})}sendSubscription(e,i=this.subscribeState){let o={srcTinyId:this.tinyId,srcUserId:this.userId},s=G.UNSUBSCRIBE,n=V.UNSUBSCRIBE_RESULT;return e==="subscribe_change"&&(o={audio:i.audio,bigVideo:i.video,auxVideo:i.auxiliary,smallVideo:i.smallVideo,srcTinyId:this.tinyId},s=G.SUBSCRIBE_CHANGE,n=V.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:s,data:o,responseCommand:n,timeout:1e4}).then(({data:a})=>{if(a.code!==0){let c=new A({code:a.code,message:y({key:C.ERROR_MESSAGE,data:{type:e,message:a.message}})});throw this._log.error(c),c}})}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}setDelay({audioDelay:e,videoDelay:i}){this.remoteAudioTrack.stat.end2EndDelay=e,this.remoteVideoTrack.stat.end2EndDelay=i}onSinglePCReconnected(){(this.ssrc.audio||this.ssrc.video||this.ssrc.auxiliary)&&this.doSubscribe(this.subscribeState,!1)}get hasSSRC(){return this.ssrc.audio&&this.ssrc.video&&this.ssrc.auxiliary}doSubscribe(){return _(this,arguments,function*(e=this.subscribeState,i=!0){if(!!this.singlePC){if(this.singlePC.addDownlinkQueue.add(this.tinyId),yield this.singlePC.waitForPeerConnectionConnected(),i||!this.hasSSRC){let o={audioSsrc:_i(),bigVideoSsrc:_i(),bigVideoRtxSsrc:_i(),auxVideoSsrc:_i(),auxVideoRtxSsrc:_i()},{audioSsrc:s,bigVideoSsrc:n,bigVideoRtxSsrc:a,auxVideoSsrc:c,auxVideoRtxSsrc:l}=o;this.ssrc={audio:s,video:n,videoRtx:a,auxiliary:c,auxiliaryRtx:l},this.singlePC.addDownlinkQueue.delete(this.tinyId),yield this.singlePC.addDownlink({userId:this.userId,tinyId:this.tinyId,ssrc:this.ssrc});let h=yield this._signalChannel.sendWaitForResponse({command:G.SPC_SUBSCRIBE,responseCommand:V.SPC_SUBSCRIBE_RESULT,data:{srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo,customData:!0,ssrc:o}});if(h.data.code!==0)throw yield this.removeDownlink(),new A({code:h.data.code,message:h.data.message});return}this.singlePC.addDownlinkQueue.delete(this.tinyId),yield this.singlePC.addDownlink({userId:this.userId,tinyId:this.tinyId,ssrc:this.ssrc})}})}removeDownlink(){return _(this,null,function*(){!this.singlePC||(this.ssrc={audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0},this.singlePC.removeDownlinkQueue.delete(this.tinyId),yield this.singlePC.removeDownlink(this.tinyId,this.userId))})}};N([H(r=>function(...t){return new Promise((e,i)=>{let o=s=>{this.off("closed",o),i(new A({code:T.API_CALL_ABORTED,message:y({key:C.CONNECTION_ABORTED,data:s})}))};this.on("closed",o),r.apply(this,t).then(e,i).finally(()=>{this.off("closed",o)})})})],hs.prototype,"subscribe",1);var Bd=hs;var{isString:Pa,isPlainObject:vh,isUndefined:xt,getNetworkType:Ph,getTerminalType:Mh,isEmpty:Jr}=me,Ze=class extends ls{constructor(e){super(e);this.privateMapKey="";this._heartbeat=-1;this._lastHeartBeatTime=-1;this._joinTimeout=-1;this._firstPublishedList=null;this._joinReject=null;this._isPublishing=!1;this._isRelayChanged=!1;this.uplinkConnection=null;this.singlePC=null;this._enableSPC=!0;this._changeBigSmallRecords=new Map;this._networkQuality=null;this._networkType=Ph();this._turnServers=[];this._syncUserListInterval=-1;this._smallStreamConfig={bitrate:100,frameRate:15,height:120,width:160};this.enableSEI=!1;this._enableAudioVolumeEvaluation=!1;this._audioVolumeIntervalId=null;this._enableMultiAuxStream=!1;this._pureAudioPushMode=!1;this.enableHWEncoder=!1;this._stats=new Fr(this,this._log),this.userManager=new qo(this.userId,this._log),this._version=_e,this.sdpSemantics=bi,xt(e.sdpSemantics)?nt.isUnifiedPlanDefault()&&(this.sdpSemantics=At):this.sdpSemantics=e.sdpSemantics,this._log.info(`sdpSemantics: ${this.sdpSemantics}, netType: ${this._networkType}`),e.iceTransportPolicy&&(this._iceTransportPolicy=e.iceTransportPolicy),this._enableMultiAuxStream=xt(e.enableMultiAuxStream)?!1:e.enableMultiAuxStream,this.enableSEI=e.enableSEI,!xt(e.enableSPC)&&Po&&(this._enableSPC=e.enableSPC),this.enableHWEncoder=e.enableHWEncoder||!1,this._initBusinessInfo(e)}get isMainStreamPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.isMainStreamPublished)}get isMainAudioPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.localMainAudioTrack)}get isAuxStreamPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.isAuxStreamPublished)}get hasAuxStream(){return[...this.remotePublishedUserMap.values()].findIndex(e=>e.muteState.hasAuxiliary)>=0}get userMap(){return this.userManager.userMap}get remotePublishedUserMap(){return this.userManager.remotePublishedUserMap}get tinyIdToUserIdMap(){return new Map([...this.remotePublishedUserMap.values()].map(e=>[e.tinyId,e.userId]))}join(e,i,o){return _(this,null,function*(){this.userManager.mySelfId=this.userId,this.userManager.on("1",n=>{this.emit("peer-join",n)}),this.userManager.on("2",n=>{this.closeDownLinkConnection(n,"remote user exitRoom"),this.emit("peer-leave",n)}),this.userManager.on("3",this.createDownlinkConnection,this),this.userManager.on("5",this.closeDownLinkConnection,this),this.userManager.on("6",a=>{var n=wa(a,[]);E.emit(p.REMOTE_PUBLISH_STATE_CHANGED,R({room:this},n)),this.emit("remote-publish-state-changed",R({},n))});let s=String(e.roomId||e.strRoomId);return this._joinOptions=e,new Promise((n,a)=>_(this,null,function*(){this._joinReject=a;try{this.checkDestroy(),yield this.initialize(),yield this.doJoin(e),n(),this._firstPublishedList&&this.onPublishedUserList({data:{userList:this._firstPublishedList}})}catch(c){this.reset(),a(c)}this._joinReject=null}))})}doJoin(e){return new Promise((i,o)=>_(this,null,function*(){var c,l,h;xt(e.role)||(this.role=e.role===20?"anchor":"audience"),xt(e.privateMapKey)||(this.privateMapKey=e.privateMapKey),this._signalChannel.once(ie.SETUP_FAILED,m=>{this.clearJoinTimeout(),E.emit(p.JOIN_SIGNAL_CONNECTION_END,{room:this,error:m}),o(m)}),re((l=(c=this.scheduleResult)==null?void 0:c.config)==null?void 0:l.singlePC)&&Po&&(this._enableSPC=this.scheduleResult.config.singlePC);let s;if(this._enableSPC&&!this.singlePC){this.singlePC=new qi({signalChannel:this._signalChannel,room:this,enableCustomMessage:!1}),this.singlePC.once("error",()=>this.fallbackToMPC());try{s=yield this.singlePC.initialize()}catch(m){this.fallbackToMPC()}}this.keyPointManager.setConnectionType(this.singlePC?1:2);let n={roomId:String(e.roomId||e.strRoomId),useStringRoomId:this.useStringRoomId,privateMapKey:this.privateMapKey,trtcRole:this.role==="anchor"?20:21,trtcScene:this.scene==="live"?2:1,sdpSemantics:this.sdpSemantics,version:this._version,ua:navigator&&navigator.userAgent||"",terminalType:Mh(),netType:St[this._networkType],bussinessInfo:this._businessInfo,ability:s};this._log.debug(`join room signal data: ${JSON.stringify(n)}`);let a=5e3;((h=this.scheduleResult.config)==null?void 0:h.enterRoomTimeout)&&this.scheduleResult.config.enterRoomTimeout>=1&&(a=this.scheduleResult.config.enterRoomTimeout*1e3),this._joinTimeout=window.setTimeout(()=>{this._log.error("join room timeout observed"),o(new A({code:T.JOIN_ROOM_FAILED,message:y({key:C.JOIN_ROOM_TIMEOUT})}))},a),E.emit(p.JOIN_SEND_CMD,{room:this}),this._signalChannel.send(this.singlePC?G.SPC_JOIN_ROOM:G.JOIN_ROOM,n),this._signalChannel.once(V.JOIN_ROOM_RESULT,m=>{this.clearJoinTimeout();let{code:f,message:L,data:D}=m.data;E.emit(p.JOIN_RECEIVED_CMD_RES,{room:this,code:f}),f===0?(this._log.info("Join room success, start heartbeat"),this.startHeartbeat(),this.syncUserList(),this.startSyncUserListInterval(),this._firstPublishedList=D.publishers,this.singlePC&&this.singlePC.connect(D.ability).catch(()=>{}),i()):(this._log.error(`Join room failed result: ${f} error: ${L}`),o(new A({code:T.JOIN_ROOM_FAILED,extraCode:f,message:y({key:C.JOIN_ROOM_FAILED,data:{error:L,code:f}})})))})}))}reJoin(){return _(this,null,function*(){if(!this.isJoined){this._log.warn("reJoin abort");return}try{this._log.warn(`reJoin pending: ${this._joinOptions.roomId}`),this.singlePC&&(this.singlePC.close(),this.singlePC=null),this._signalChannel.close(),yield this._signalChannel.connect(),yield this.doJoin(k(R({},this._joinOptions),{role:this.role==="anchor"?20:21,privateMapKey:this.privateMapKey})),this._log.warn("reJoin success"),Z.logSuccessEvent({userId:this.userId,eventType:Ge.REJOIN}),this.singlePC?(yield this.singlePC.waitForPeerConnectionConnected(),this.uplinkConnection instanceof va&&this.uplinkConnection.onSinglePCReconnected(),this.remotePublishedUserMap.forEach(e=>{e.installEvents(),e.doSubscribe()})):(this.checkConnectionsToReconnect(),this.uplinkConnection instanceof cs&&!this.uplinkConnection.getIsReconnecting()&&this.uplinkConnection.startReconnection())}catch(e){this._log.warn(`reJoin fail ${e}`),this.reset(),Z.logFailedEvent({userId:this.userId,eventType:Ge.REJOIN,error:e}),this.emit("error",new A({code:T.JOIN_ROOM_FAILED,message:y({key:C.REJOIN_ROOM_FAILED,data:{roomId:this._joinOptions.roomId}})}))}})}initialize(){this._log.info("setup signal channel");let{mainUrl:e,backupUrl:i}=this.getSignalChannelUrl();return this._signalChannel=new xr({sdkAppId:this.sdkAppId,userId:this.userId,userSig:this.userSig,url:e,backupUrl:i,room:this}),this._networkQuality||(this._networkQuality=new ui({signalChannel:this._signalChannel,room:this}),this._networkQuality.on(ui.EVENT_NETWORK_QUALITY,o=>{this.emit("network-quality",o)})),this._signalChannel.on(ie.CONNECTION_STATE_CHANGED,o=>{E.emit(p.SIGNAL_CONNECTION_STATE_CHANGED,R({room:this},o)),this.emit("signal-connection-state-changed",o)}),this._signalChannel.on(ie.RECONNECT_FAILED,o=>{this.reset(),this.emit("error",o)}),this._signalChannel.once(ie.SETUP_SUCCESS,o=>{this.tinyId=o.signalInfo.tinyId,E.emit(p.JOIN_SIGNAL_CONNECTION_END,{room:this})}),this._signalChannel.on(V.PEER_JOIN,o=>{let{srcTinyId:s,userId:n,role:a}=o.data.data;this.userManager.addUser({userId:n,tinyId:s,role:a})}),this._signalChannel.on(V.PEER_LEAVE,o=>{let{userId:s,reason:n=0}=o.data.data;this.userManager.deleteUser(s,n)}),this._signalChannel.on(V.UPDATE_REMOTE_MUTE_STAT,o=>{this._lastHeartBeatTime>0&&Date.now()-this._lastHeartBeatTime>=10*1e3&&this.doHeartbeat(),this.onPublishedUserList(o.data)}),this._signalChannel.on(V.CLIENT_BANNED,o=>{let s=o.data.data,{reason:n}=s;if(Z.uploadEvent({log:`stat-banned:${n}`,userId:this.userId}),n==="user_time_out"){this._log.warn(`${n} last heart beat time: ${this._lastHeartBeatTime} interval: ${Date.now()-this._lastHeartBeatTime}, visibility: ${document.visibilityState}`),this.reJoin();return}this._log[n==="kick"?"error":"info"](`user was banned because of [${n}]`),this.reset(),this.emit("banned",{reason:n})}),E.emit(p.JOIN_SIGNAL_CONNECTION_START,{room:this}),this._signalChannel.connect()}leave(){return _(this,null,function*(){try{yield this.doHeartbeat()}catch(e){}E.emit(p.LEAVE_SEND_CMD,{room:this}),this._log.info("leave() => leaving room"),this._signalChannel.send(G.LEAVE_ROOM),this.reset()})}clearNetworkQuality(){this._networkQuality&&(this._networkQuality.stop(),this._networkQuality=null)}closeConnections(){this.remotePublishedUserMap.forEach(e=>{this.closeDownLinkConnection(e.userId,"you exitRoom")})}clearJoinTimeout(){clearTimeout(this._joinTimeout),this._joinTimeout=-1}startHeartbeat(){this._heartbeat===-1&&(this._heartbeat=z.run(We,this.doHeartbeat.bind(this),{delay:2e3}))}stopHeartbeat(){this._heartbeat!==-1&&(this._log.info("stopHeartbeat"),z.clearTask(this._heartbeat),this._heartbeat=-1,this._lastHeartBeatTime=-1)}doHeartbeat(){return _(this,null,function*(){var a;let e=this.badCaseDetector.getMonitorFreeze(),i=yield this._stats.getStatsReport({uplinkConnection:this.uplinkConnection,downlinkConnections:this.remotePublishedUserMap,freezeMap:e});if(this.badCaseDetector.resetMonitor(),!((a=this._signalChannel)!=null&&a.isConnected))return;let o=this._signalChannel.isConnected?Yc(this.userId):[],s=R({str_sdk_version:Wt,uint64_datetime:new Date().getTime(),msg_user_info:{str_identifier:this.userId,uint64_tinyid:this.tinyId},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:St[this._networkType]},msg_event_msg:o,str_acc_ip:this.getSignalInfo().relayIp,str_client_ip:this.getSignalInfo().clientIp},i);E.emit(p.HEARTBEAT_REPORT,{room:this,report:s}),this._signalChannel.send(G.ON_QUALITY_REPORT,s);let n=Date.now();this._lastHeartBeatTime>0&&n-this._lastHeartBeatTime>1e4&&this._log.warn(`heartbeat took ${n-this._lastHeartBeatTime}`),this._signalChannel.isConnected&&(this._lastHeartBeatTime=n),!this._isRelayChanged&&this.isRelayMaybeFailed()&&(this.reJoin(),this._isRelayChanged=!0)})}onPublishedUserList(e){if(!this.isJoined)return;let i=e.data.userList.map(({userId:o,srcTinyId:s,flag:n})=>{let a=this.remotePublishedUserMap.get(o);return a&&this._changeBigSmallRecords.has(o)&&this.checkSubscribeBigSmallVideo(a),{userId:o,tinyId:s,flag:n}});E.emit(p.RECEIVED_PUBLISHED_USER_LIST,{room:this,publishedUserList:i}),this.userManager.setRemotePublishedUserList(i)}closeUplink(e="you unpublished"){this.uplinkConnection&&(this.localTracks.size>0&&this.uplinkConnection.doUnpublish(),this.uplinkConnection.close(e),this.uplinkConnection=null),this.localTracks.forEach(i=>i.unpublish()),this.localTracks.clear()}createDownlinkConnection({userId:e,tinyId:i,flag:o}){let s=new(this.singlePC?Bd:pa)({userId:e,tinyId:i,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:o});this.userManager.addRemotePublishedUser(s),this.installDownlinkEvents(s,e),this.emit("remote-published",s)}closeDownLinkConnection(e,i="remote user unpublished"){let o=this.remotePublishedUserMap.get(e);o&&(o.close(i),this.emit("remote-unpublished",o))}installDownlinkEvents(e,i){e.on("sei-message",o=>{this.emit("sei-message",o)}),e.on("error",o=>{let s=o.getCode();s!==T.ICE_TRANSPORT_ERROR&&(s===T.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLinkConnection(i),this.emit("error",o))}),e.on("connection-state-changed",o=>{this.emit("media-connection-state-changed",k(R({},o),{userId:e.userId}))}),e.on("firewall-restriction",()=>{this.emit("firewall-restriction")})}startSyncUserListInterval(){this._syncUserListInterval===-1&&(this._syncUserListInterval=z.run(We,this.syncUserList.bind(this)))}stopSyncUserListInterval(){z.clearTask(this._syncUserListInterval),this._syncUserListInterval=-1}syncUserList(){return this.getUserList().then(e=>{this.userManager.setUserList(e)}).catch(e=>{this._log.debug(`sync user list failed: ${e}`)})}getUserList(){var e;return(e=this._signalChannel)!=null&&e.isConnected?this._signalChannel.sendWaitForResponse({command:G.GET_USER_LIST,responseCommand:V.USER_LIST_RES,enableLog:!1,timeout:2e3}).then(({data:i})=>{let{code:o,message:s}=i;if(o===0)return(i.data&&i.data.userList||[]).map(({userId:a,srcTinyId:c,role:l})=>({userId:a,tinyId:c,role:l}));throw y({key:C.SIGNAL_RESPONSE_FAILED,data:{signalResponse:V.USER_LIST_RES,code:o,message:s}})}):Promise.reject("not connected")}getAllConnections(){let e=[...this.remotePublishedUserMap.values()];return this.uplinkConnection&&e.push(this.uplinkConnection),e}isRelayMaybeFailed(){if(!this._signalChannel.isOnline||!ma)return!1;if(this.singlePC)return this.singlePC.reconnectionCount>6;let e=this.getAllConnections();if(e.length===0)return!1;for(let i=0;i<e.length;i++)if(e[i].getReconnectionCount()<6)return!1;return!0}checkConnectionsToReconnect(){this.singlePC||this.getAllConnections().forEach(i=>{if(i instanceof Ne&&!i.getIsReconnecting()){let o=i.getPeerConnection();o&&o.connectionState===q.CLOSED&&(this._log.warn(`[${i.getUserId()}] pc is closed but not reconnect`),i.startReconnection())}})}fallbackToMPC(){return _(this,null,function*(){var e;if(this._log.warn("fallback to multi pc"),Z.uploadEvent({log:"stat-fallback",userId:this.userId}),this._enableSPC=!1,(e=this.singlePC)==null||e.close(),this.singlePC=null,yield this.reJoin(),this.uplinkConnection){let i=this.uplinkConnection;this.uplinkConnection=new cs({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),i.isMainStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:i.localMainAudioTrack,localVideoTrack:i.localMainVideoTrack,isAuxiliary:!1})),i.isAuxStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:i.localAuxAudioTrack,localVideoTrack:i.localAuxVideoTrack,isAuxiliary:!0}))}this.remotePublishedUserMap.forEach(i=>{let o=new pa({userId:i.userId,tinyId:i.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:i.flag,remoteAudioTrack:i.remoteAudioTrack,remoteVideoTrack:i.remoteVideoTrack,remoteAuxiliaryTrack:i.remoteAuxiliaryTrack});this.installDownlinkEvents(o,i.userId),this.remotePublishedUserMap.set(i.userId,o),i.isMainStreamSubscribed&&o.subscribe(i.subscribeState,"main"),i.isAuxStreamSubscribed&&o.subscribe(i.subscribeState,"auxiliary")})})}destroy(){this._isDestroyed||(super.destroy(),this._joinReject&&(this._joinReject(new A({code:T.INVALID_OPERATION,message:y({key:C.CLIENT_DESTROYED,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.removeAllListeners())}switchRole(e){return _(this,null,function*(){this.role!==e&&(e==="audience"&&this.uplinkConnection&&this.closeUplink("you switch role to audience"),yield this.doSwitchRole(e))})}doSwitchRole(e){let i={command:G.SWITCH_ROLE,data:{role:e==="anchor"?20:21,privateMapKey:this.privateMapKey},responseCommand:V.SWITCH_ROLE_RES,retries:1};return this._log.info(`switchRole signal data: ${JSON.stringify(i.data)}`),this._signalChannel.sendWaitForResponseWithRetry(i).then(o=>{let{code:s,message:n}=o.data;if(s!==0)throw new A({code:T.SWITCH_ROLE_FAILED,message:y({key:C.SWITCH_ROLE_FAILED,data:{message:n,code:s}})});this.role=e}).catch(o=>{throw o instanceof A&&o.getCode()===T.API_CALL_TIMEOUT&&(o=new A({code:T.SWITCH_ROLE_FAILED,message:y({key:C.SWITCH_ROLE_TIMEOUT})})),this._log.error(o),o})}publish(...e){return _(this,null,function*(){if(this.scene==="live"&&this.role!=="anchor")return;E.emit(p.PUBLISH_START,{room:this});let i={},o={};this._isPublishing=!0,e.forEach(s=>{!s.mediaTrack||(s instanceof Ae&&(s instanceof ri?(o.audio=s,this.audioManager.addScreenAudioTrack(s)):(i.audio=s,this.audioManager.addAudioTrack(s))),s instanceof Be&&(s instanceof Qe&&s.mediaType===2?o.video=s:i.video=s),s.setPublishStarting(this))});try{let s=Jr(i),n=Jr(o);(!s||!n)&&!this.uplinkConnection&&(this.singlePC?this.uplinkConnection=new va({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}):this.uplinkConnection=new cs({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),this.uplinkConnection.on("connection-state-changed",c=>{this.emit("media-connection-state-changed",k(R({},c),{userId:this.userId}))}),this.uplinkConnection.on("firewall-restriction",()=>{this.emit("firewall-restriction")}),this.uplinkConnection.on("error",c=>{let l=c.getCode();l!==T.ICE_TRANSPORT_ERROR&&(l===T.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emit("error",c))}));let a=e.map(c=>c.kind).join(",");s||(this._log.info(`publish() => main ${a}`),yield this.uplinkConnection.publish({localAudioTrack:i.audio,localVideoTrack:i.video,isAuxiliary:!1}),this._log.info("main is published")),n||(this._log.info(`publish() => aux ${a}`),yield this.uplinkConnection.publish({localAudioTrack:o.audio,localVideoTrack:o.video,isAuxiliary:!0}),this._log.info("aux is published")),this._isPublishing=!1,e.forEach(c=>{!c.mediaTrack||(this.localTracks.add(c),c.publish(this))})}catch(s){throw e.forEach(n=>{let a="error";s.message.includes("timeout")?a="timeout":s.code===T.API_CALL_ABORTED&&(a="api-call"),n.setPublishStopped(a,a==="error"?s:void 0)}),this._isPublishing=!1,s}})}unpublish(...e){return _(this,null,function*(){if(this.scene==="live"&&this.role!=="anchor"||!this.isMainStreamPublished&&!this.isAuxStreamPublished||!this.uplinkConnection)return;let i={},o={};e.forEach(s=>{!s.mediaTrack||(s instanceof Ae&&(s instanceof ri?o.audio=s:i.audio=s),s instanceof Be&&(s instanceof Qe&&s.mediaType===2?o.video=s:i.video=s))});try{let s=e.map(n=>n.kind).join(",");Jr(i)||(this._log.info(`unpublish() => main ${s}`),yield this.uplinkConnection.unpublish({localAudioTrack:i.audio,localVideoTrack:i.video})),Jr(o)||(this._log.info(`unpublish() => aux ${s}`),yield this.uplinkConnection.unpublish({localAudioTrack:o.audio,localVideoTrack:o.video}))}catch(s){}e.forEach(s=>{!s.mediaTrack||(s.unpublish(),this.localTracks.delete(s))}),this.localTracks.size===0&&!this.audioManager.isMixed&&this.closeUplink("you unpublished")})}addTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():(e.setPublishStarting(this),this.uplinkConnection.addTrack(e).then(i=>(e.publish(this),i)))}removeTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():this.uplinkConnection.removeTrack(e).then(i=>(e.unpublish(),i))}replaceTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():this.uplinkConnection.replaceTrack(e).then(i=>{E.emit(p.LOCAL_TRACK_REPLACED,{track:e})})}setBandWidth(e){return _(this,null,function*(){!this.uplinkConnection||(yield this.uplinkConnection.setBandwidth(e),yield this.uplinkConnection.sendMediaSettings())})}subscribe(...e){return _(this,null,function*(){if(e=e.filter(n=>!n.isSubscribed),e.length===0)return;let{userId:i}=e[0],o=this.remotePublishedUserMap.get(i);if(!o)return;let s=e.find(n=>n.mediaType===2)?"auxiliary":"main";try{let n=R({},o.subscribeState);e.forEach(c=>{switch(c.mediaType){case 1:n.audio=!0;break;case 4:n.video=!0;break;case 2:n.auxiliary=!0;break}});let a=this._changeBigSmallRecords.get(i);a&&a.options.smallVideo&&o.muteState.hasSmall&&n.video&&(n.video=!1,n.smallVideo=!0),E.emit(p.SUBSCRIBE_START,{room:this,streamType:s,remotePublishedUser:o,subscribeState:n}),this._log.info(`subscribe() => ${i} ${s} [${as(n)}] prev: [${as(o.subscribeState)}]`),yield o.subscribe(n,s),o.remoteVideoTrack.setMediaType(n.smallVideo?8:4),E.emit(p.SUBSCRIBE_SUCCESS,{room:this,streamType:s,remotePublishedUser:o})}catch(n){let a=n instanceof A?n.getCode():T.UNKNOWN,c=n;throw n instanceof A?a===T.REMOTE_STREAM_NOT_EXIST&&(c=new A({code:T.API_CALL_ABORTED,message:y({key:C.API_CALL_ABORTED,data:{message:n.message,userId:i,streamType:s}})}),this._log.warn(c)):(c=new A({code:a,message:y({key:C.SUBSCRIBE_FAILED,data:{message:n.message,userId:i,streamType:s}})}),this._log.error(c)),c}})}unsubscribe(...e){return _(this,null,function*(){let{userId:i}=e[0],o=this.remotePublishedUserMap.get(i);if(!o)return;let s=e.find(n=>n.mediaType===2)?"auxiliary":"main";this._log.info(`unsubscribe() => ${i} ${s}`);try{yield o.unsubscribe({remoteTracks:e,streamType:s})}catch(n){this._log.warn(`unsubscribe() => failed ${n}`)}e.forEach(n=>{n.unsubscribe(),n.mediaType===8&&n.setMediaType(4)}),E.emit(p.UNSUBSCRIBE_SUCCESS,{room:this,streamType:s,remotePublishedUser:o})})}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAudioVolumeEvaluation(e=2e3,i){if(e<=0){this._enableAudioVolumeEvaluation=!1,z.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null;return}e=Math.floor(Math.max(e,100)),E.emit(p.AUDIO_LEVEL_INTERVAL,{interval:e}),this._audioVolumeIntervalId&&(z.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null),this._enableAudioVolumeEvaluation=!0,this._audioVolumeIntervalId=z.run(rt,()=>{var s,n;let o=[];if((s=this.uplinkConnection)!=null&&s.localMainAudioTrack){let a=Math.floor(this.uplinkConnection.localMainAudioTrack.getAudioLevel()*100);o.push({userId:"",volume:a})}(n=this.remotePublishedUserMap)==null||n.forEach(a=>{if(a.muteState.hasAudio){let c=Math.floor(a.remoteAudioTrack.getAudioLevel()*100);o.push({userId:a.userId,volume:c})}}),this.emit("audio-volume",o)},{fps:1e3/e,backgroundTask:i})}getLocalAudioStats(){return _(this,null,function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0},this.uplinkConnection){let i=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:i.audio.bytesSent,packetsSent:i.audio.packetsSent}}return e})}getLocalVideoStats(){return _(this,null,function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection){let{video:{bytesSent:i,packetsSent:o,framesEncoded:s,framesSent:n,frameWidth:a,frameHeight:c}}=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:i,packetsSent:o,framesEncoded:s,framesSent:n,frameWidth:a,frameHeight:c}}return e})}getTransportStats(){return _(this,null,function*(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection){let i=yield this._stats.getSenderStats(this.uplinkConnection);e.rtt=i.rtt}for(let[,i]of this.remotePublishedUserMap){let o=yield this._stats.getReceiverStats(i);e.downlinksRTT[o.userId]=o.rtt}return e})}getRemoteVideoStats(e){return _(this,null,function*(){let i={};for(let[o,s]of this.remotePublishedUserMap)e==="main"&&s.muteState.hasVideo&&(i[o]=s.remoteVideoTrack.stat),e==="auxiliary"&&s.muteState.hasAuxiliary&&(i[o]=s.remoteAuxiliaryTrack.stat);return i})}getRemoteAudioStats(){return _(this,null,function*(){let e={};for(let[i,o]of this.remotePublishedUserMap)o.muteState.hasAudio&&(e[i]=o.remoteAudioTrack.stat);return e})}setProxyServer(e){if(Pa(e)){if(!e.startsWith("wss://"))throw new A({code:T.INVALID_PARAMETER,message:"invalid websocket url"});this.proxy_ws=e}else if(vh(e)){let{websocketProxy:i,loggerProxy:o}=e;i&&(this.proxy_ws=i),o&&mr(o)}}setTurnServer(e,i){this._log.info(`set turn server: ${JSON.stringify(e)} ${i||""}`);let o=[];Array.isArray(e)?e.forEach(s=>o.push(me.getTurnServer(s))):me.isPlainObject(e)&&o.push(me.getTurnServer(e)),this._turnServers=o,i&&(this._iceTransportPolicy=i)}sendStartMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:G.START_MIX_TRANSCODE,data:e,timeout:5e3,responseCommand:V.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"})}sendStopMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:G.STOP_MIX_TRANSCODE,data:e,timeout:5e3,responseCommand:V.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"})}sendStartPublishCDN(e,i=!0){return this._signalChannel.sendWaitForResponse({command:i?G.START_PUBLISH_TENCENT_CDN:G.START_PUBLISH_GIVEN_CDN,data:e,timeout:5e3,responseCommand:i?V.START_PUBLISH_TENCENT_CDN_RES:V.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDN"})}sendStopPublishCDN(e,i=!0){return this._signalChannel.sendWaitForResponse({command:i?G.STOP_PUBLISH_TENCENT_CDN:G.STOP_PUBLISH_GIVEN_CDN,data:e,timeout:5e3,responseCommand:i?V.STOP_PUBLISH_TENCENT_CDN_RES:V.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDN"})}getIceServers(){return this._turnServers.length===0&&this.scheduleResult.iceServers?this.scheduleResult.iceServers:this._turnServers}getIceTransportPolicy(){return this._iceTransportPolicy||this.scheduleResult.iceTransportPolicy||"all"}getLogger(){return this._log}enableAIVoice(){throw new Error("Method not implemented.")}getSignalChannelUrl(){let e={mainUrl:"",backupUrl:""},i=me.getEnv();return i?(e.mainUrl=`wss://${i}.rtc.qq.com`,e.backupUrl=e.mainUrl):this.proxy_ws?(e.mainUrl=this.proxy_ws,e.backupUrl=e.mainUrl):Array.isArray(this.scheduleResult.domains)&&this.scheduleResult.domains.length>0&&(e.mainUrl=`wss://${this.scheduleResult.domains[0]}`,e.backupUrl=e.mainUrl,this.scheduleResult.domains[1]&&(e.backupUrl=`wss://${this.scheduleResult.domains[1]}`)),e}getSignalInfo(){var e;return((e=this._signalChannel)==null?void 0:e.getSignalInfo())||{}}reset(){this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.clearNetworkQuality(),this.closeUplink("you exitRoom"),this._signalChannel&&(this._log.info("destroying SignalChannel"),this._signalChannel.close()),this._stats.reset(),this.userManager.clear(),this.userManager.removeAllListeners(),this.singlePC&&(this.singlePC.close(),this.singlePC=null)}checkSubscribeBigSmallVideo(e){return _(this,null,function*(){let i=e==null?void 0:e.muteState.hasSmall,o=e==null?void 0:e.muteState.hasVideo;if(!i&&!o||!e.isBigStreamSubscribed&&!e.isSmallStreamSubscribed)return;let s=e.getUserId(),n=this._changeBigSmallRecords.get(s)||{},{subscribeState:a}=e,{options:c,isSubscribing:l,reSubscribeCount:h}=n;if(c.video&&a.video||c.smallVideo&&a.smallVideo&&i||l)return;let m={audio:e.remoteAudioTrack.isSubscribed||e.remoteAudioTrack.isSubscribing,auxiliary:e.remoteAuxiliaryTrack.isSubscribed||e.remoteAuxiliaryTrack.isSubscribing,video:c.video,smallVideo:c.smallVideo};if(i&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed)try{c&&!l&&h>=1&&(n.isSubscribing=!0,n.reSubscribeCount=h-1,!i&&e.isSmallStreamSubscribed&&(m.video=!0,m.smallVideo=!1),yield e==null?void 0:e.subscribe(m,"main"),e.remoteVideoTrack.setMediaType(m.smallVideo?8:4),this._log.info(`change [${s}] to ${m.smallVideo?"small":"big"} video successfully. count ${vi-n.reSubscribeCount}.`),n.isSubscribing=!1,n.reSubscribeCount=vi)}catch(f){this._log.info(`change [${s}] to ${m.smallVideo?"small":"big"} video failed. count ${vi-n.reSubscribeCount}.`),n.isSubscribing=!1,h===0&&this._changeBigSmallRecords.delete(s)}})}changeType(e,i){let s={options:{video:!e,smallVideo:e},isSubscribing:!1,reSubscribeCount:vi};this._changeBigSmallRecords.set(i.userId,s),this._log.info(`set [${i.userId}] video prefer type: ${e?"small":"big"}`)}get smallStreamConfig(){return this._smallStreamConfig}_initBusinessInfo(e){this._businessInfo=e.businessInfo;let i={};if(Pa(e.businessInfo)&&(i=JSON.parse(e.businessInfo)),!xt(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new A({code:T.INVALID_PARAMETER,message:y({key:C.INVALID_PURE_AUDIO})});this._pureAudioPushMode=e.pureAudioPushMode,i.Str_uc_params||(i.Str_uc_params={}),i.Str_uc_params.pure_audio_push_mod=this._pureAudioPushMode}if(!xt(e.userDefineRecordId)){let o=/^[A-Za-z0-9_-]{1,64}$/gi;if(e.userDefineRecordId.match(o)===null)throw new A({code:T.INVALID_PARAMETER,message:y({key:C.INVALID_USER_DEFINE_RECORDID})});i.Str_uc_params||(i.Str_uc_params={}),i.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!xt(e.userDefinePushArgs))if(Pa(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256)i.Str_uc_params||(i.Str_uc_params={}),i.Str_uc_params.userdefine_push_args=e.userDefinePushArgs;else throw new A({code:T.INVALID_PARAMETER,message:y({key:C.INVALID_USER_DEFINE_PUSH_ARGS})});Jr(i)||(this._businessInfo=JSON.stringify(i))}sendSEI(e,i){var o;(o=this.uplinkConnection)==null||o.sendSEI(e,i)}};N([$d(["left",Lh.INIT],"joined"),hd()],Ze.prototype,"join",1),N([$d("joined","left",{ignoreError:!0}),_d(),Ld("leave room"),Wr({fnName:"publish",validateArgs:!1}),Wr({fnName:"unsubscribe",validateArgs:!1})],Ze.prototype,"leave",1),N([jr(),Gr({settings:{retries:it,timeout:r=>ye(r)},onError(r,t,e){var i;(i=r.message)!=null&&i.includes("timeout")?(this._log.warn("publish timeout"),t()):(this._log.error(`publish failed: ${r}`),e(r))}})],Ze.prototype,"publish",1),N([Wr({fnName:"publish",callback(...r){var t;this.localTracks.size===0&&((t=this.uplinkConnection)==null||t.close("you unpublished"),this.uplinkConnection=null,r.forEach(e=>e.setPublishStopped("api-call")))}}),bd("api-call"),jr()],Ze.prototype,"unpublish",1),N([Da((...r)=>r[0].userId),md(),Gr({settings:{retries:it,timeout:r=>ye(r)},onError(r,t,e){r.message.includes("timeout")?(this._log.warn("subscribe timeout"),t()):(this._log.error(`subscribe failed: ${r}`),e(r))}})],Ze.prototype,"subscribe",1),N([Wr({fnName:"subscribe",callback(...r){this.singlePC||r.forEach(t=>{let e=this.remotePublishedUserMap.get(t.userId);e&&!e.isMainStreamSubscribed&&!e.isAuxStreamSubscribed&&e.close("you unsubscribed")})}}),Da((...r)=>r[0].userId)],Ze.prototype,"unsubscribe",1);Ur.create=Ur._create.bind(Ur,Ze);var aL=Ur;export{aL as default};
