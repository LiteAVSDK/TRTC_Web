var Fl=Object.create;var mr=Object.defineProperty,Gl=Object.defineProperties,mc=Object.getOwnPropertyDescriptor,Wl=Object.getOwnPropertyDescriptors,Kl=Object.getOwnPropertyNames,Ss=Object.getOwnPropertySymbols,_c=Object.getPrototypeOf,$o=Object.prototype.hasOwnProperty,pc=Object.prototype.propertyIsEnumerable,Jl=Reflect.get;var gs=Math.pow,Bo=(r,t,e)=>t in r?mr(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,R=(r,t)=>{for(var e in t||(t={}))$o.call(t,e)&&Bo(r,e,t[e]);if(Ss)for(var e of Ss(t))pc.call(t,e)&&Bo(r,e,t[e]);return r},k=(r,t)=>Gl(r,Wl(t));var Ec=(r,t)=>{var e={};for(var i in r)$o.call(r,i)&&t.indexOf(i)<0&&(e[i]=r[i]);if(r!=null&&Ss)for(var i of Ss(r))t.indexOf(i)<0&&pc.call(r,i)&&(e[i]=r[i]);return e};var _r=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),pr=(r,t)=>{for(var e in t)mr(r,e,{get:t[e],enumerable:!0})},jl=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Kl(t))!$o.call(r,s)&&s!==e&&mr(r,s,{get:()=>t[s],enumerable:!(i=mc(t,s))||i.enumerable});return r};var Ne=(r,t,e)=>(e=r!=null?Fl(_c(r)):{},jl(t||!r||!r.__esModule?mr(e,"default",{value:r,enumerable:!0}):e,r));var y=(r,t,e,i)=>{for(var s=i>1?void 0:i?mc(t,e):t,o=r.length-1,n;o>=0;o--)(n=r[o])&&(s=(i?n(t,e,s):n(s))||s);return i&&s&&mr(t,e,s),s};var d=(r,t,e)=>(Bo(r,typeof t!="symbol"?t+"":t,e),e);var ii=(r,t,e)=>Jl(_c(r),e,t);var _=(r,t,e)=>new Promise((i,s)=>{var o=c=>{try{a(e.next(c))}catch(l){s(l)}},n=c=>{try{a(e.throw(c))}catch(l){s(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(o,n);a((e=e.apply(r,t)).next())});var Me=_r((Dm,Ho)=>{"use strict";var Yl=Object.prototype.hasOwnProperty,Te="~";function Er(){}Object.create&&(Er.prototype=Object.create(null),new Er().__proto__||(Te=!1));function Xl(r,t,e){this.fn=r,this.context=t,this.once=e||!1}function fc(r,t,e,i,s){if(typeof e!="function")throw new TypeError("The listener must be a function");var o=new Xl(e,i||r,s),n=Te?Te+t:t;return r._events[n]?r._events[n].fn?r._events[n]=[r._events[n],o]:r._events[n].push(o):(r._events[n]=o,r._eventsCount++),r}function As(r,t){--r._eventsCount===0?r._events=new Er:delete r._events[t]}function Ee(){this._events=new Er,this._eventsCount=0}Ee.prototype.eventNames=function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)Yl.call(e,i)&&t.push(Te?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};Ee.prototype.listeners=function(t){var e=Te?Te+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var s=0,o=i.length,n=new Array(o);s<o;s++)n[s]=i[s].fn;return n};Ee.prototype.listenerCount=function(t){var e=Te?Te+t:t,i=this._events[e];return i?i.fn?1:i.length:0};Ee.prototype.emit=function(t,e,i,s,o,n){var a=Te?Te+t:t;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,m;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,s),!0;case 5:return c.fn.call(c.context,e,i,s,o),!0;case 6:return c.fn.call(c.context,e,i,s,o,n),!0}for(m=1,u=new Array(l-1);m<l;m++)u[m-1]=arguments[m];c.fn.apply(c.context,u)}else{var f=c.length,O;for(m=0;m<f;m++)switch(c[m].once&&this.removeListener(t,c[m].fn,void 0,!0),l){case 1:c[m].fn.call(c[m].context);break;case 2:c[m].fn.call(c[m].context,e);break;case 3:c[m].fn.call(c[m].context,e,i);break;case 4:c[m].fn.call(c[m].context,e,i,s);break;default:if(!u)for(O=1,u=new Array(l-1);O<l;O++)u[O-1]=arguments[O];c[m].fn.apply(c[m].context,u)}}return!0};Ee.prototype.on=function(t,e,i){return fc(this,t,e,i,!1)};Ee.prototype.once=function(t,e,i){return fc(this,t,e,i,!0)};Ee.prototype.removeListener=function(t,e,i,s){var o=Te?Te+t:t;if(!this._events[o])return this;if(!e)return As(this,o),this;var n=this._events[o];if(n.fn)n.fn===e&&(!s||n.once)&&(!i||n.context===i)&&As(this,o);else{for(var a=0,c=[],l=n.length;a<l;a++)(n[a].fn!==e||s&&!n[a].once||i&&n[a].context!==i)&&c.push(n[a]);c.length?this._events[o]=c.length===1?c[0]:c:As(this,o)}return this};Ee.prototype.removeAllListeners=function(t){var e;return t?(e=Te?Te+t:t,this._events[e]&&As(this,e)):(this._events=new Er,this._eventsCount=0),this};Ee.prototype.off=Ee.prototype.removeListener;Ee.prototype.addListener=Ee.prototype.on;Ee.prefixed=Te;Ee.EventEmitter=Ee;typeof Ho!="undefined"&&(Ho.exports=Ee)});var Fa=_r((MN,ol)=>{var sl=ol.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var t="candidate:%s %d %s %d %s %d typ %s";return t+=r.raddr!=null?" raddr %s rport %d":"%v%v",t+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(t+=" generation %d"),t+=r["network-id"]!=null?" network-id %d":"%v",t+=r["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var t="ssrc:%d";return r.attribute!=null&&(t+=" %s",r.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var t="mediaclk:";return t+=r.id!=null?"id=%s %s":"%v%s",t+=r.mediaClockValue!=null?"=%s":"",t+=r.rateNumerator!=null?" rate=%s":"",t+=r.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(sl).forEach(function(r){var t=sl[r];t.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})});var cl=_r(Ot=>{var dr=function(r){return String(Number(r))===r?Number(r):r},em=function(r,t,e,i){if(i&&!e)t[i]=dr(r[1]);else for(var s=0;s<e.length;s+=1)r[s+1]!=null&&(t[e[s]]=dr(r[s+1]))},tm=function(r,t,e){var i=r.name&&r.names;r.push&&!t[r.push]?t[r.push]=[]:i&&!t[r.name]&&(t[r.name]={});var s=r.push?{}:i?t[r.name]:t;em(e.match(r.reg),s,r.names,r.name),r.push&&t[r.push].push(s)},nl=Fa(),im=RegExp.prototype.test.bind(/^([a-z])=(.*)/);Ot.parse=function(r){var t={},e=[],i=t;return r.split(/(\r\n|\r|\n)/).filter(im).forEach(function(s){var o=s[0],n=s.slice(2);o==="m"&&(e.push({rtp:[],fmtp:[]}),i=e[e.length-1]);for(var a=0;a<(nl[o]||[]).length;a+=1){var c=nl[o][a];if(c.reg.test(n))return tm(c,i,n)}}),t.media=e,t};var al=function(r,t){var e=t.split(/=(.+)/,2);return e.length===2?r[e[0]]=dr(e[1]):e.length===1&&t.length>1&&(r[e[0]]=void 0),r};Ot.parseParams=function(r){return r.split(/;\s?/).reduce(al,{})};Ot.parseFmtpConfig=Ot.parseParams;Ot.parsePayloads=function(r){return r.toString().split(" ").map(Number)};Ot.parseRemoteCandidates=function(r){for(var t=[],e=r.split(" ").map(dr),i=0;i<e.length;i+=3)t.push({component:e[i],ip:e[i+1],port:e[i+2]});return t};Ot.parseImageAttributes=function(r){return r.split(" ").map(function(t){return t.substring(1,t.length-1).split(",").reduce(al,{})})};Ot.parseSimulcastStreamList=function(r){return r.split(";").map(function(t){return t.split(",").map(function(e){var i,s=!1;return e[0]!=="~"?i=dr(e):(i=dr(e.substring(1,e.length)),s=!0),{scid:i,paused:s}})})}});var ll=_r((wN,dl)=>{var Ga=Fa(),rm=/%[sdv%]/g,sm=function(r){var t=1,e=arguments,i=e.length;return r.replace(rm,function(s){if(t>=i)return s;var o=e[t];switch(t+=1,s){case"%%":return"%";case"%s":return String(o);case"%d":return Number(o);case"%v":return""}})},us=function(r,t,e){var i=t.format instanceof Function?t.format(t.push?e:e[t.name]):t.format,s=[r+"="+i];if(t.names)for(var o=0;o<t.names.length;o+=1){var n=t.names[o];t.name?s.push(e[t.name][n]):s.push(e[t.names[o]])}else s.push(e[t.name]);return sm.apply(null,s)},om=["v","o","s","i","u","e","p","c","b","t","r","z","a"],nm=["i","c","b","a"];dl.exports=function(r,t){t=t||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(o){o.payloads==null&&(o.payloads="")});var e=t.outerOrder||om,i=t.innerOrder||nm,s=[];return e.forEach(function(o){Ga[o].forEach(function(n){n.name in r&&r[n.name]!=null?s.push(us(o,n,r)):n.push in r&&r[n.push]!=null&&r[n.push].forEach(function(a){s.push(us(o,n,a))})})}),r.media.forEach(function(o){s.push(us("m",Ga.m[0],o)),i.forEach(function(n){Ga[n].forEach(function(a){a.name in o&&o[a.name]!=null?s.push(us(n,a,o)):a.push in o&&o[a.push]!=null&&o[a.push].forEach(function(c){s.push(us(n,a,c))})})})}),s.join(`\r
`)+`\r
`}});var Wa=_r(Dt=>{var yi=cl(),am=ll();Dt.write=am;Dt.parse=yi.parse;Dt.parseParams=yi.parseParams;Dt.parseFmtpConfig=yi.parseFmtpConfig;Dt.parsePayloads=yi.parsePayloads;Dt.parseRemoteCandidates=yi.parseRemoteCandidates;Dt.parseImageAttributes=yi.parseImageAttributes;Dt.parseSimulcastStreamList=yi.parseSimulcastStreamList});import cL from"webrtc-adapter";var qd=Ne(Me());var Tc=(v=>(v[v.INVALID_PARAMETER=4096]="INVALID_PARAMETER",v[v.INVALID_OPERATION=4097]="INVALID_OPERATION",v[v.NOT_SUPPORTED=4098]="NOT_SUPPORTED",v[v.DEVICE_NOT_FOUND=4099]="DEVICE_NOT_FOUND",v[v.INITIALIZE_FAILED=4100]="INITIALIZE_FAILED",v[v.SIGNAL_CHANNEL_SETUP_FAILED=16385]="SIGNAL_CHANNEL_SETUP_FAILED",v[v.SIGNAL_CHANNEL_ERROR=16386]="SIGNAL_CHANNEL_ERROR",v[v.ICE_TRANSPORT_ERROR=16387]="ICE_TRANSPORT_ERROR",v[v.JOIN_ROOM_FAILED=16388]="JOIN_ROOM_FAILED",v[v.CREATE_OFFER_FAILED=16389]="CREATE_OFFER_FAILED",v[v.SIGNAL_CHANNEL_RECONNECTION_FAILED=16390]="SIGNAL_CHANNEL_RECONNECTION_FAILED",v[v.UPLINK_RECONNECTION_FAILED=16391]="UPLINK_RECONNECTION_FAILED",v[v.DOWNLINK_RECONNECTION_FAILED=16392]="DOWNLINK_RECONNECTION_FAILED",v[v.REMOTE_STREAM_NOT_EXIST=16400]="REMOTE_STREAM_NOT_EXIST",v[v.CLIENT_BANNED=16448]="CLIENT_BANNED",v[v.SERVER_TIMEOUT=16449]="SERVER_TIMEOUT",v[v.SUBSCRIPTION_TIMEOUT=16450]="SUBSCRIPTION_TIMEOUT",v[v.PLAY_NOT_ALLOWED=16451]="PLAY_NOT_ALLOWED",v[v.DEVICE_AUTO_RECOVER_FAILED=16452]="DEVICE_AUTO_RECOVER_FAILED",v[v.START_PUBLISH_CDN_FAILED=16453]="START_PUBLISH_CDN_FAILED",v[v.STOP_PUBLISH_CDN_FAILED=16454]="STOP_PUBLISH_CDN_FAILED",v[v.START_MIX_TRANSCODE_FAILED=16455]="START_MIX_TRANSCODE_FAILED",v[v.STOP_MIX_TRANSCODE_FAILED=16456]="STOP_MIX_TRANSCODE_FAILED",v[v.NOT_SUPPORTED_H264=16457]="NOT_SUPPORTED_H264",v[v.SWITCH_ROLE_FAILED=16458]="SWITCH_ROLE_FAILED",v[v.API_CALL_TIMEOUT=16459]="API_CALL_TIMEOUT",v[v.SCHEDULE_FAILED=16460]="SCHEDULE_FAILED",v[v.API_CALL_ABORTED=16461]="API_CALL_ABORTED",v[v.UNKNOWN=65535]="UNKNOWN",v))(Tc||{}),I=Tc;var Ql=function(r){for(let t in I)if(I[t]===r)return t;return"UNKNOWN"},Fo=class extends Error{constructor({name:e="RtcError",message:i,code:s=I.UNKNOWN,extraCode:o=0,constraint:n}){let a=`<${Ql(s)} 0x${s.toString(16)}>`,c=`${i}${n?` constraint: ${n}`:""}${i!=null&&i.includes(a)?"":` ${a}`}`;super(c);d(this,"code");d(this,"extraCode");d(this,"message");d(this,"originMessage");d(this,"name");d(this,"constraint");this.code=s,this.extraCode=o,this.name=e,this.message=c,this.constraint=n,this.originMessage=i}getCode(){return this.code}getExtraCode(){return this.extraCode}toString(){return this.originMessage}},A=Fo;var Ic=new Date().getTime(),Go=0,Sc=function(r){Ic=r,Go=Ic-new Date().getTime();let t=new Date;t.setTime(r),g.info(`baseTime from server: ${t} offset: ${Go}`)},fr=function(){return new Date().getTime()+Go},Rs=function(){let r=new Date;return r.setTime(fr()),r.toLocaleString()};var Se={};pr(Se,{bytes2ms:()=>Mu,copyProperties:()=>Pu,deepMerge:()=>it,fibonacci:()=>Xi,formatedTime:()=>Hu,getConstructorName:()=>Zs,getContainerFromElement:()=>eo,getEnv:()=>vu,getInternalVersion:()=>xu,getLoggerUrl:()=>ui,getMuteStateFromFlag:()=>Bt,getNetworkQuality:()=>Vu,getNetworkType:()=>zs,getOSType:()=>Pc,getReconnectionTimeout:()=>we,getSysInfo:()=>Lu,getTerminalType:()=>Lc,getTurnServer:()=>Bu,getValueType:()=>ie,glog:()=>wc,ipv4ToUint32:()=>Gr,isArray:()=>he,isArrayOrObject:()=>Br,isAudioWorkletSupported:()=>Tn,isBoolean:()=>te,isConstructor:()=>Hr,isEmpty:()=>Fr,isFunction:()=>j,isLangChinese:()=>tt,isMediaStreamTrack:()=>wu,isNumber:()=>Q,isObject:()=>hi,isOverseaSdkAppId:()=>qs,isPlainObject:()=>ft,isPromise:()=>$r,isRemoteTrack:()=>Vt,isString:()=>X,isUndefined:()=>T,ms2bytes:()=>ku,ms2samples:()=>kc,performanceNow:()=>V,promiseAny:()=>In,samples2ms:()=>Mc,stringify:()=>$t,stringifyIncludeValue:()=>Sn});var oi={};pr(oi,{ANDROID_VERSION:()=>Jo,CHROME_MAJOR_VERSION:()=>Bi,CHROME_VERSION:()=>$s,EDGE_VERSION:()=>Ns,EDG_MAJOR_VERSION:()=>Yo,EDG_VERSION:()=>ys,FIREFOX_MAJOR_VERSION:()=>jo,FIREFOX_VERSION:()=>Cs,HUAWEI_VERSION:()=>xs,IE_VERSION:()=>tu,IOS_MAIN_VERSION:()=>zo,IOS_VERSION:()=>Mt,IPADQQB_VERSION:()=>ks,IS_ANDROID:()=>ye,IS_ANDROID_WEBVIEW:()=>nu,IS_ANY_SAFARI:()=>ou,IS_CHROME:()=>Vi,IS_CHROME_ONLY:()=>Qo,IS_CHROME_OS:()=>Nc,IS_EDG:()=>ki,IS_EDGE:()=>Mi,IS_ELECTRON:()=>ru,IS_FIREFOX:()=>Y,IS_HEADLESS_CHROME:()=>qo,IS_HUAWEI:()=>su,IS_HUAWEIBROWSER:()=>yr,IS_IE:()=>Cc,IS_IE8:()=>eu,IS_IOS:()=>$e,IS_IOS_13_OR_14:()=>au,IS_IOS_15_1:()=>si,IS_IPAD:()=>Pi,IS_IPADQQB:()=>Rr,IS_IPAD_PRO:()=>Ko,IS_IPHONE:()=>Pt,IS_IPOD:()=>Rc,IS_LINUX:()=>Cr,IS_LOCAL:()=>He,IS_MAC:()=>ut,IS_MACQQB:()=>Ar,IS_MIBROWSER:()=>Nr,IS_MQQB:()=>Ui,IS_NATIVE_ANDROID:()=>Zl,IS_OLD_ANDROID:()=>zl,IS_OPPOBROWSER:()=>Dr,IS_SAFARI:()=>ke,IS_SAFARI_15_1:()=>vr,IS_SAMSUNGBROWSER:()=>Or,IS_SOGOU:()=>Ir,IS_SOGOUM:()=>Tr,IS_TBS:()=>Qe,IS_UCBROWSER:()=>Xo,IS_VIVOBROWSER:()=>br,IS_WECHAT:()=>wi,IS_WIN:()=>ri,IS_WQQB:()=>gr,IS_WX:()=>iu,IS_X5MQQB:()=>xi,IS_XWEB:()=>Sr,MACQQB_VERSION:()=>Ms,MI_VERSION:()=>ws,MQQB_VERSION:()=>Li,OPPO_VERSION:()=>Vs,SAFARI_VERSION:()=>$i,SAMSUNG_VERSION:()=>Us,SOGOUM_VERSION:()=>Os,SOGOU_VERSION:()=>Ds,TBS_VERSION:()=>bs,USER_AGENT:()=>Be,VIVO_VERSION:()=>Bs,WECHAT_VERSION:()=>Ls,WQQB_VERSION:()=>Ps,XWEB_VERSION:()=>vs,browserInfo:()=>Xe,getBrowserInfo:()=>yc,getChromeMajorVersion:()=>qe,getOSName:()=>Hs,getOSString:()=>Zo,getUserAgentData:()=>Lr,isLocalStorageEnabled:()=>ht});var Be=typeof navigator=="undefined"?"":navigator.userAgent,H=r=>new RegExp(r,"i").test(Be),ae=r=>{if(H(r)){let t=new RegExp(`${r}\\/([\\d.]+)`),e=Be.match(t);if(e&&e[1])return e[1]}return""},Wo=r=>{if(H(r)){let t=new RegExp(`${r}\\/(\\d+)`),e=Be.match(t);if(e&&e[1])return parseFloat(e[1])}return NaN},gc=/AppleWebKit\/([\d.]+)/i.exec(Be),ql=gc?parseFloat(gc[1]):NaN,Pi=H("iPad"),Ko=typeof navigator!="undefined"&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&H("Macintosh"),Pt=H("iPhone")&&!Pi,Rc=H("iPod"),$e=Pt||Pi||Rc||Ko,ye=H("Android"),Jo=function(){if(ye){let r=Be.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(r){let t=r[1]&&parseFloat(r[1]),e=r[2]&&parseFloat(r[2]);if(t&&e)return parseFloat(`${r[1]}.${r[2]}`);if(t)return t}}return NaN}(),zl=ye&&H("webkit")&&Jo<2.3,Zl=ye&&Jo<5&&ql<537,Y=H("Firefox"),Cs=ae("Firefox"),jo=Wo("Firefox"),Mi=H("Edge"),Ns=ae("Edge"),ki=H("Edg"),ys=ae("Edg"),Yo=Wo("Edg"),Tr=H("SogouMobileBrowser"),Os=ae("SogouMobileBrowser"),Ir=H("MetaSr\\s"),Ds=ae("MetaSr\\s"),Qe=H("TBS"),bs=ae("TBS"),Sr=H("XWEB"),vs=ae("XWEB"),eu=H("MSIE\\s8\\.0"),Cc=H("MSIE\\/\\d+"),tu=function(){if(Cc){let r=/MSIE\s(\d+)\.\d/.exec(Be),t=r&&parseFloat(r[1]);return!t&&/Trident\/7.0/i.test(Be)&&/rv:11.0/.test(Be)&&(t=11),t}return NaN}(),wi=H("(micromessenger|webbrowser)"),Ls=ae("MicroMessenger"),xi=!Qe&&H("MQQBrowser")&&H("COVC"),Ui=!Qe&&H("MQQBrowser")&&!H("COVC"),Li=Ui||xi?ae("MQQBrowser"):"",gr=!Qe&&H(" QQBrowser"),Ps=ae(" QQBrowser"),Ar=!Qe&&H("QQBrowserLite"),Ms=ae("QQBrowserLite"),Rr=!Qe&&H("MQBHD"),ks=ae("MQBHD"),ri=H("Windows"),ut=!$e&&H("MAC OS X"),Cr=!ye&&H("Linux"),Nc=H("CrOS"),iu=H("MicroMessenger"),Xo=H("UCBrowser"),ru=H("Electron"),Nr=H("MiuiBrowser"),ws=ae("MiuiBrowser"),yr=H("HuaweiBrowser"),su=H("Huawei"),xs=ae("HuaweiBrowser"),Or=H("SamsungBrowser"),Us=ae("SamsungBrowser"),Dr=H("HeyTapBrowser"),Vs=ae("HeyTapBrowser"),br=H("VivoBrowser"),Bs=ae("VivoBrowser"),qe=()=>Wo("Chrome"),Qo=H("Chrome"),Vi=!Mi&&!Ir&&!Tr&&!Qe&&!Sr&&!ki&&!gr&&!Nr&&!yr&&!Or&&!Dr&&!br&&Qo,qo=H("HeadlessChrome"),Bi=qe(),$s=ae("Chrome"),ke=!Qo&&!Ui&&!xi&&!Ar&&!Rr&&H("Safari"),ou=ke||$e,$i=ae("Version"),nu=/Android.*(wv|.0.0.0)/.test(Be),Mt=(()=>{if(Ko)return $i;if($e){let r=Be.match(/OS (\d+)_(\d+)/i);if(r&&r[1]){let t=r[1];return r[2]&&(t+=`.${r[2]}`),t}}return""})(),zo=Number(Mt.split(".")[0]),vr=$i==="15.1",si=Mt==="15.1",au=(()=>{let r=Number(Mt.split(".")[0]);return r===14||r===13})(),He=typeof location!="undefined"?location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1":!1,ht=(()=>{let r;return()=>{if(T(r))try{r=!!window.localStorage}catch(t){r=!1}return r}})(),Xe=yc();function yc(){let r=new Map([[Y,["Firefox",Cs]],[ki,["Edg",ys]],[Vi,["Chrome",$s]],[ke,["Safari",$i]],[Qe,["TBS",bs]],[Sr,["XWEB",vs]],[wi&&Pt,["WeChat",Ls]],[gr,["QQ(Win)",Ps]],[Ui,["QQ(Mobile)",Li]],[xi,["QQ(Mobile X5)",Li]],[Ar,["QQ(Mac)",Ms]],[Rr,["QQ(iPad)",ks]],[Nr,["MI",ws]],[yr,["HW",xs]],[Or,["Samsung",Us]],[Dr,["OPPO",Vs]],[br,["VIVO",Bs]],[Mi,["EDGE",Ns]],[Tr,["SogouMobile",Os]],[Ir,["Sogou",Ds]]]),t="unknown",e="unknown";return r.has(!0)&&([t,e]=r.get(!0)),{name:t,version:e}}var Re=null;function Lr(){return _(this,null,function*(){if(Re)return Re;if(!navigator.userAgentData||!j(navigator.userAgentData.getHighEntropyValues))return null;try{return Re=yield navigator.userAgentData.getHighEntropyValues(["architecture","bitness","model","platformVersion","fullVersionList"]),Re}catch(r){return null}})}var Ac=new Map([[ye,"Android"],[$e,"iOS"],[ri,"Windows"],[ut,"MacOS"],[Cr,"Linux"],[Nc,"ChromeOS"]]),Hs=function(){return Ac.get(!0)?Ac.get(!0):Re?Re.platform:"unknown"},Zo=()=>{let r=Hs();return r+=`/${Xe.name}/${ke?Xe.version:Xe.version.split(".")[0]}`,Re!=null&&Re.platformVersion&&(r+=`/${Re.platformVersion}`),Re!=null&&Re.architecture&&(r+=`/${Re.architecture}`),r};var fn={};pr(fn,{AUDIO_MUTE_BIT:()=>js,AUDIO_STAT_BIT:()=>Gi,AUX_STAT_BIT:()=>kr,AUX_STREAM_MSID:()=>cn,BACKEND_ENV:()=>Js,BASE_DOC_URL:()=>ze,BASE_HOST:()=>Fs,CAPABILITIES_KEYS:()=>Qs,CLASS_NAME:()=>Nu,CLOUD_CONSOLE_URL:()=>du,DATA_FREEZE_TIMING:()=>Xs,DOC_URL:()=>lu,DTLS_STATE_UNKNOWN:()=>Ge,ENV_NAME:()=>mt,EXCHANGE_SDP_TIMEOUT:()=>mn,INTERVAL:()=>En,IS_WORKER:()=>Hi,IS_WORKLET:()=>Pr,KIBANA_EVENT:()=>Ze,LOCAL_STREAM_PUBLISH_STATE:()=>bc,LOGGER_CMD_TYPE:()=>ci,LOGGER_DOMAIN:()=>sn,LOGGER_DOMAIN_OVERSEA:()=>on,LOG_LEVEL:()=>Fe,LOG_LEVEL_NAME:()=>Ou,MAIN_STREAM_MSID:()=>wr,MICROPHONE_COMMUNICATIONS:()=>yu,MICROPHONE_DEFAULT:()=>li,NAME:()=>h,NETWORK_TYPE:()=>kt,NOT_SUPPORTED_H264:()=>di,PAUSED_RETRY_COUNT:()=>_n,PEERCONNECTION_CONNECTING_TIMEOUT:()=>Ur,PEER_CONNECTION_STATE:()=>Z,PEER_LEAVE_REASON:()=>pn,RAF:()=>Et,RECOVER_CAPTURE_INTERVAL:()=>ji,REMOTE_STREAM_TYPE_AUX:()=>ln,REMOTE_STREAM_TYPE_MAIN:()=>dn,RENDER_FREEZE_TIMING:()=>gu,RIC:()=>et,SCHEDULE_DOMAIN:()=>Ki,SCHEDULE_TIMEOUT:()=>Cu,SDP_SEMANTICS_PLAN_B:()=>Wi,SDP_SEMANTICS_UNIFIED_PLAN:()=>xt,SECOND_HOST:()=>tn,SIGNAL_PING_PONG_INTERVAL:()=>hu,SIGNAL_PING_TIMEOUT:()=>uu,SIGNAL_RECONNECTION_COUNT:()=>xr,SMALL_STAT_BIT:()=>an,SPEAKER_DEFAULT:()=>Vr,STORAGE_EXPIRES_TIME:()=>Gs,STREAM_TYPE_BIG:()=>Au,STREAM_TYPE_SMALL:()=>Ru,SUBSCRIBE_SMALL_RETRY_COUNT:()=>Ji,SYNC_USER_LIST_INTERVAL:()=>Su,Scene:()=>wt,Switch:()=>Oc,THIRD_HOST:()=>rn,TIMEOUT:()=>Yi,TRANSPORT_DIRECTION:()=>G,TRTC_ERROR_ASSISTANCE:()=>nn,TRTC_QUALITY_BAD:()=>fu,TRTC_QUALITY_DISCONNECTED:()=>Iu,TRTC_QUALITY_EXCELLENT:()=>_u,TRTC_QUALITY_GOOD:()=>pu,TRTC_QUALITY_POOR:()=>Eu,TRTC_QUALITY_UNKNOWN:()=>mu,TRTC_QUALITY_VERY_BAD:()=>Tu,UPDATE_OFFER_TIMEOUT:()=>hn,VIDEO_MUTE_BIT:()=>Ys,VIDEO_STAT_BIT:()=>Fi,audioProfileMap:()=>Ws,getRetryCount:()=>pt,getScriptDir:()=>cu,innerVersion:()=>ni,loggerProxy:()=>Mr,screenProfileMap:()=>Ks,setLoggerProxy:()=>ai,setRetryCount:()=>un,setVersion:()=>en,version:()=>Ie,videoProfileMap:()=>_t});var ni="4.15.00.1600",Ie="5.0.0";function en(r){Ie=r;let[t,e,i]=r.split(".").map(s=>parseInt(s,10));ni=`${t}.${Math.min(15,e)}.${Math.min(15,i)}.${e.toString().padStart(2,"0")}${i.toString().padStart(2,"0")}`}var Hi=typeof importScripts!="undefined",Pr=typeof registerProcessor!="undefined",cu=()=>{let r=Hi?self.location.href:document.currentScript.src;return r.substring(0,r.lastIndexOf("/")+1)},Mr="",ai=r=>Mr=r,Fs="web.sdk.qcloud.com",tn="web.sdk.tencent.cn",rn="web.sdk.cloud.tencent.cn",du="https://console.cloud.tencent.com/trtc",ze=`https://${Fs}/trtc/webrtc/v5/doc`,lu=`${ze}/zh-cn/`,sn="https://yun.tim.qq.com",on="https://videoapi-sgp.im.qcloud.com",nn="trtc_error_assistance",ci={LOG:"jssdk_log",EVENT:"jssdk_event",KEY_POINT:"jssdk_new_endreport"},mt={QCLOUD:"qcloud",OLD_CLOUD_LADDER:"trtc",WEBRTC:"webrtc"},Fe=(n=>(n[n.TRACE=0]="TRACE",n[n.DEBUG=1]="DEBUG",n[n.INFO=2]="INFO",n[n.WARN=3]="WARN",n[n.ERROR=4]="ERROR",n[n.NONE=5]="NONE",n))(Fe||{}),uu=18e3,hu=2e3,kt={unknown:0,wifi:1,"3g":2,"2g":3,"4g":4,wired:5},Gs=7*24*3600*1e3,Oc=(s=>(s.USEAINS="useAINS",s.ENABLEDEBUG="enableDebug",s.USEV2="useV2",s.USEWT="useWt",s))(Oc||{}),Ws={standard:{sampleRate:48e3,channelCount:1,bitrate:40},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},high:{sampleRate:48e3,channelCount:1,bitrate:192},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}},_t={"120p":{width:160,height:120,frameRate:15,bitrate:200},"120p_2":{width:160,height:120,frameRate:15,bitrate:100},"180p":{width:320,height:180,frameRate:15,bitrate:350},"180p_2":{width:320,height:180,frameRate:15,bitrate:150},"240p":{width:320,height:240,frameRate:15,bitrate:400},"240p_2":{width:320,height:240,frameRate:15,bitrate:200},"360p":{width:640,height:360,frameRate:15,bitrate:800},"360p_2":{width:640,height:360,frameRate:15,bitrate:400},"480p":{width:640,height:480,frameRate:15,bitrate:900},"480p_2":{width:640,height:480,frameRate:15,bitrate:500},"720p":{width:1280,height:720,frameRate:15,bitrate:1500},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"1440p":{width:2560,height:1440,frameRate:30,bitrate:4860},"4K":{width:3840,height:2160,frameRate:30,bitrate:9e3}},Ks={"480p":{width:640,height:480,frameRate:5,bitrate:900},"480p_2":{width:640,height:480,frameRate:30,bitrate:1e3},"720p":{width:1280,height:720,frameRate:5,bitrate:1200},"720p_2":{width:1280,height:720,frameRate:30,bitrate:3e3},"1080p":{width:1920,height:1080,frameRate:5,bitrate:1600},"1080p_2":{width:1920,height:1080,frameRate:30,bitrate:4e3}},h={CANVAS:"canvas",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",SMALL:"small",BIG:"big",AUXILIARY:"auxiliary",SMALL_VIDEO:"smallVideo",FACING_MODE_USER:"user",FACING_MODE_ENVIRONMENT:"environment",MUTE:"mute",UNMUTE:"unmute",ENDED:"ended",PLAYING:"playing",PAUSE:"pause",ERROR:"error",LOADEDDATA:"loadeddata",AUDIO_INPUT:"audioinput",VIDEO_INPUT:"videoinput",DETAIL:"detail",TEXT:"text",MAIN:"main",BACKUP:"backup",BANNED:"banned",KICK:"kick",USER_TIME_OUT:"user_time_out",ROOM_DISBAND:"room_disband",SEI_MESSAGE:"sei-message",ADD:"add",REMOVE:"remove",REPLACE:"replace",TRACK:"track",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",TRANSCEIVER_DIRECTION_SENDONLY:"sendonly",TRANSCEIVER_DIRECTION_RECVONLY:"recvonly"},G={INACTIVE:"inactive",SENDONLY:"sendonly",RECVONLY:"recvonly"},Js={OLD_CLOUD_LADDER:"wss://trtc.rtc.qq.com",WEBRTC:"wss://webrtc.qq.com"},wt=(e=>(e.LIVE="live",e.RTC="rtc",e))(wt||{}),Fi=1,an=2,kr=4,Gi=8,js=64,Ys=16,wr="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",cn="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",dn=h.MAIN,ln=h.AUXILIARY,mu=0,_u=1,pu=2,Eu=3,fu=4,Tu=5,Iu=6,Ge="unknown",Z={NEW:"new",CONNECTING:"connecting",FAILED:"failed",CLOSED:"closed",DISCONNECTED:"disconnected",CONNECTED:"connected",COMPLETED:"completed"},Dc=1/0;function un(r){Dc=r}function pt(){return Dc}var xr=30,Ze={JOIN:"join",DELTA_JOIN:"delta-join",REJOIN:"rejoin",LEAVE:"leave",DELTA_LEAVE:"delta-leave",PUBLISH:"publish",DELTA_PUBLISH:"delta-publish",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",UPLINK_CONNECTION:"uplink-connection",UPLINK_RECONNECTION:"uplink-reconnection",DOWNLINK_CONNECTION:"downlink-connection",DOWNLINK_RECONNECTION:"downlink-reconnection",ON_TRACK:"ontrack",ICE_CONNECTION_STATE:"iceConnectionState",LOCAL_STREAM_INITIALIZE:"stream-initialize",SIGNAL_CONNECTION:"websocketConnectionState",SIGNAL_RECONNECTION:"websocketReconnectionState",UPDATE_STREAM:"update-stream",RECOVER_LOCAL_AUDIO_TRACK:"recover-local-audio-track",RECOVER_LOCAL_VIDEO_TRACK:"recover-local-video-track",RECOVER_SUBSCRIPTION:"recover-subscription",START_MIX_TRANSCODE:"start-mix-transcode",STOP_MIX_TRANSCODE:"stop-mix-transcode",PLAYER_ERROR:"player-error",SCHEDULE:"schedule",LOAD_WORKLET:"load-worklet",VIDEO_FROZEN_COUNT:"videoFrozenCount"},Su=1e4,hn=1e4,mn=1e4,xt="unified-plan",Wi="plan-b",di=1028,bc=(i=>(i[i.UNPUBLISH=-1]="UNPUBLISH",i[i.PUBLISHING=0]="PUBLISHING",i[i.PUBLISHED=1]="PUBLISHED",i))(bc||{}),Xs=500,gu=1e3,Au=h.BIG,Ru=h.SMALL,Ur=10*1e3,Ki={MAIN:"schedule.rtc.qq.com",BACKUP:"schedule.rtc.qcloud.com",MAIN_OVERSEA:"schedule.rtc.tencentcloud.com",BACKUP_OVERSEA:"schedule-ecdn.rtc.tencentcloud.com"},Cu=2e3,Nu={TRTC:"TRTC",CLIENT:"Client",LOCAL_STREAM:"LocalStream",REMOTE_STREAM:"RemoteStream",STREAM:"Stream"},_n=5,li="default",Vr=li,yu="communications",Ou=Object.keys(Fe),pn=["normal leave","timeout leave","kick","role change"],Ji=10,ji=2e3,et="ric",Et="raf",En="interval",Yi="timeout",Qs=["width","height","frameRate","facingMode","sampleRate","sampleSize","channelCount","deviceId"];var Ut=1e8;var bu="trtc_env",vu=function(){return new URLSearchParams(location.search).get(bu)||""},qs=r=>Number(r)<14e8,ui=function(r,t){let e;Mr?e=Mr:e=qs(r)?on:sn;let i=Math.floor(Math.random()*gs(2,31));return`${e}/v5/AVQualityReportSvc/C2S?random=${i}&sdkappid=${r}&cmdtype=${t}`};function Lc(){return ye?4:Pt?2:Pi?3:ut?12:ri?5:Cr?13:1}function Pc(){return ye?"Android":Pt?"iPhone":Pi?"iPad":ut?"Mac":ri?"Windows":Cr?"Linux":"unknown"}function zs(){let{userAgent:r,connection:t}=navigator,e=(r.match(/NetType\/\S+/)||[])[0]||"";e=e.toLowerCase().replace("nettype/",""),e==="3gnet"&&(e="3g");let i=t&&t.type&&t.type.toLowerCase(),s=t&&t.effectiveType&&t.effectiveType.toLowerCase();s==="slow-2"&&(s="2g");let o=e||"unknown";if(i)switch(i){case"cellular":case"wimax":o=s||"unknown";break;case"wifi":o="wifi";break;case"ethernet":o="wired";break;case"none":case"other":case"unknown":default:o="unknown";break}return o}var Lu=function(r){return{AbilityOption:{AVLimit:r,GeneralLimit:{CPULimit:{uint32_CPU_num:navigator.hardwareConcurrency||0,str_CPU_name:String(navigator.platform),uint32_CPU_maxfreq:0,model:"",uint32_total_memory:0},uint32_terminal_type:Lc(),uint32_device_type:0,str_os_verion:Pc(),uint32_link_type:1,str_client_version:ni,uint32_net_type:kt[zs()],ua:navigator.userAgent,version:""}}}};function Pu(r,t){for(let e of Reflect.ownKeys(t))if(e!=="constructor"&&e!=="prototype"&&e!=="name"){let i=Object.getOwnPropertyDescriptor(t,e)||"";Object.defineProperty(r,e,i)}return r}function Mu(r,t=48e3){return Mc(r/4,t)}function Mc(r,t=48e3){return r*1e3/t}function ku(r,t=48e3){return kc(r,t)*4}function kc(r,t=48e3){return r*t/1e3}var wc=typeof window!="undefined"&&typeof window.glog=="function"?window.glog:()=>{},tt=()=>{let r=navigator.language;return r=r.substring(0,2),r==="zh"},ft=function(r){if(!r||typeof r!="object"||Object.prototype.toString.call(r)!="[object Object]")return!1;let t=Object.getPrototypeOf(r);if(t===null)return!0;let e=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return typeof e=="function"&&e instanceof e&&Function.prototype.toString.call(e)===Function.prototype.toString.call(Object)};function Xi(r,t=1,e=1){return r<=1?e:Xi(r-1,e,t+e)}function we(r){return r>8?30*1e3:Xi(r)*1e3}function ie(r){return Reflect.apply(Object.prototype.toString,r,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var j=r=>typeof r=="function",T=r=>typeof r=="undefined",X=r=>typeof r=="string",Q=r=>typeof r=="number",te=r=>typeof r=="boolean",hi=r=>ie(r)==="object",he=r=>ie(r)==="array",wu=r=>ie(r)==="MediaStreamTrack".toLowerCase(),Vt=r=>r.isRemote,$r=r=>ie(r)==="promise",Hr=r=>j(r)&&r.prototype.constructor===r,Zs=r=>Hr(r)?r.prototype.constructor.name:"",Tn=typeof AudioWorkletNode!="undefined";function In(r){return new Promise((t,e)=>{let i=[];r.forEach(s=>{s.then(t).catch(o=>{i.push(o),i.length===r.length&&e(i)})})})}function V(){return!performance||!performance.now?Date.now():Math.floor(performance.now())}var vc=r=>+r<10?`0${r}`:r,xu=r=>{let t=r.match(/^\d+\.\d+\.\d+/)[0];if(!t)return r;let e=t.split("."),i=vc(e[1])+vc(e[2]);return e[1]-15>0&&(e[1]="15"),e[2]-15>0&&(e[2]="15"),`${e.join(".")}.${i}`},Uu=Object.prototype.hasOwnProperty,{toString:Fm}=Object.prototype;function Fr(r){if(r==null)return!0;if(typeof r=="boolean")return!1;if(typeof r=="number")return r===0;if(typeof r=="string"||typeof r=="function"||Array.isArray(r))return r.length===0;if(r instanceof Error)return r.message==="";if(ft(r))switch(Object.prototype.toString.call(r)){case"[object File]":case"[object Map]":case"[object Set]":return r.size===0;case"[object Object]":{for(let t in r)if(Uu.call(r,t))return!1;return!0}}return!1}function Bt(r,t){return{userId:t,hasAudio:!!(r&Gi),hasVideo:!!(r&Fi),hasAuxiliary:!!(r&kr),hasSmall:!!(r&an),audioMuted:!!(r&js),videoMuted:!!(r&Ys),audioAvailable:!!(r&Gi)&&!(r&js),videoAvailable:!!(r&Fi)&&!(r&Ys)}}function Vu(r,t){return r>50||t>500?5:r>30||t>350?4:r>20||t>200?3:r>10||t>100?2:r>=0||t>=0?1:0}function Bu(r){let t={urls:`turn:${r.url}`};return!T(r.username)&&!T(r.credential)&&(t.username=r.username,t.credential=r.credential,t.credentialType="password",T(r.credentialType)||(t.credentialType=r.credentialType)),t}function Gr(r,t=!0){if(!X(r))return 0;let e=r.split(".");return t?(Number(e[0])<<24|Number(e[1])<<16|Number(e[2])<<8|Number(e[3]))>>>0:(Number(e[3])<<24|Number(e[2])<<16|Number(e[1])<<8|Number(e[0]))>>>0}var Br=function(r){return he(r)||hi(r)},it=function(r,t,e,i){if(!(Br(r)&&Br(t)))return 0;let s=0,o=Object.keys(t),n;for(let a=0,c=o.length;a<c;a++)if(n=o[a],!(T(t[n])||e&&e.includes(n)))if(Br(r[n])&&Br(t[n]))s+=it(r[n],t[n],e,i);else{if(i&&i.includes(t[n]))continue;r[n]!==t[n]&&(r[n]=t[n],s+=1)}return s},eo=r=>X(r)?document.getElementById(r):r,$u=new Intl.DateTimeFormat("zh-CN",{dateStyle:"short",timeStyle:"medium"}),Hu=()=>$u.format(new Date);function $t(r,t){try{if(he(r))return`[${r.map(s=>$t(s,t)).join(",")}]`;if(!ft(r)||!he(t))return JSON.stringify(r);let e={},i=new Set(t);return Object.keys(r).forEach(s=>{i.has(s)&&(e[s]=r[s])}),JSON.stringify(e)}catch(e){return"{}"}}function Sn(r,t=!1){let e=[];return Object.keys(r).forEach(i=>{t===r[i]&&e.push(i)}),$t(r,e)}function Ht({url:r,body:t,method:e,timeout:i}){let s=new XMLHttpRequest;return new Promise((o,n)=>{s.onreadystatechange=()=>{if(s.readyState===4)if(s.status>=200&&s.status<300)try{let a=JSON.parse(s.response);o({data:a})}catch(a){o({data:s.response})}else n({status:s.status,statusText:s.statusText||"request failed!"})},s.timeout=i||5e3,s.open(e||"POST",r,!0),s.send(t)})}var Fu=0,Gu=1,xc=2;function Wu({retryFunction:r,settings:t,onError:e,onRetrying:i,onRetryFailed:s,context:o}){return function(...n){let{retries:a=5,timeout:c=1e3}=t,l=0,u=-1,m=Fu,f=(O,N)=>_(this,null,function*(){let w=o||this;try{let oe=yield r.apply(w,n);l=0,O(oe)}catch(oe){let Lt=()=>{clearTimeout(u),l=0,m=xc,N(oe)},Is=()=>{m!==xc&&l<(j(a)?a():a)?(l++,m=Gu,j(i)&&i.call(this,l,Lt),u=window.setTimeout(()=>{u=-1,f(O,N)},j(c)?c(l):c)):(Lt(),j(s)&&s.call(this,oe))};j(e)?e.call(w,oe,Is,N,n):Is()}});return new Promise(f)}}var rt=Wu;var Qi=class{constructor(t){d(this,"userId");d(this,"remoteUserId");d(this,"id");d(this,"sdkAppId");d(this,"type");d(this,"isLocal");this.id=t.id,this.userId=t.userId,this.sdkAppId=t.sdkAppId,this.remoteUserId=t.remoteUserId,this.isLocal=te(t.isLocal)?t.isLocal:!0,this.type=this.isLocal?"":t.type}createChild(t){return Object.setPrototypeOf(t,this)}setUserId(t){this.userId=t}setSdkAppId(t){this.sdkAppId=t}log(t,e){let i=this.isLocal?this.userId:this.remoteUserId;e.unshift(`[${this.isLocal?"\u2191":"\u2193"}${this.type&&this.type!=="main"?"*":""}${this.id}${i?`|${i}`:""}]`),g.log(t,e,T(this.userId)||Fr(this.userId),this.userId,this.sdkAppId)}info(...t){this.log(2,t)}debug(...t){this.log(1,t)}warn(...t){this.log(3,t)}error(...t){this.log(4,t)}};var Uc=Ne(Me(),1),Ku=new Uc.default,E=Ku;var to=(x=>(x.ROOM_DESTROY="1",x.JOIN_START="21",x.JOIN_SCHEDULE_SUCCESS="22",x.JOIN_SIGNAL_CONNECTION_START="23",x.JOIN_SIGNAL_CONNECTION_END="24",x.JOIN_SEND_CMD="25",x.JOIN_RECEIVED_CMD_RES="26",x.JOIN_SUCCESS="27",x.JOIN_FAILED="28",x.LEAVE_START="51",x.LEAVE_SEND_CMD="52",x.LEAVE_SUCCESS="53",x.PUBLISH_START="61",x.SEND_FIRST_VIDEO_FRAME="62",x.PUBLISH_FAILED="63",x.SUBSCRIBE_START="81",x.SUBSCRIBE_SUCCESS="82",x.SUBSCRIBE_FAILED="84",x.UNSUBSCRIBE_SUCCESS="83",x.LOCAL_TRACK_CAPTURE_START="101",x.LOCAL_TRACK_CAPTURE_SUCCESS="102",x.LOCAL_TRACK_CAPTURE_FAILED="103",x.LOCAL_TRACK_PUBLISHED="104",x.LOCAL_TRACK_UNPUBLISHED="105",x.LOCAL_TRACK_REPLACED="106",x.SWITCH_DEVICE_SUCCESS="107",x.TRACK_MUTED="108",x.TRACK_UNMUTED="109",x.REMOTE_TRACK_SUBSCRIBED="110",x.REMOTE_TRACK_UNSUBSCRIBED="111",x.PLAY_TRACK_START="151",x.PLAYER_STATE_CHANGED="152",x.VIDEO_LOADED_DATA="153",x.AUTOPLAY_DIALOG_CLICK_CONFIRM="154",x.WORKLET_LOADED_SUCCESS="155",x.WORKLET_LOADED_FAILED="156",x.SIGNAL_CONNECTION_STATE_CHANGED="201",x.PEER_CONNECTION_STATE_CHANGED="202",x.HEARTBEAT_REPORT="251",x.RECEIVED_PUBLISHED_USER_LIST="252",x.REMOTE_PUBLISH_STATE_CHANGED="253",x.AUDIO_LEVEL_INTERVAL="260",x.NETWORK_QUALITY="261",x.API_SUCCESS_RATE="262",x))(to||{});var p=to;var Ju="%cTRTC%c%s",ju="padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;",Yu="display: inline",Xu=!($e||ye||qo),gn=class{constructor(){d(this,"_isEnableUploadLog",!0);d(this,"_localJoinedUser",new Map);d(this,"_queue",[]);d(this,"_timeoutId",-1);d(this,"_logLevel",1);d(this,"_logLevelToUpload",2);!Hi&&!Pr&&(this.checkURLParam(),this.installEvents())}get isAbleToUpload(){return this._isEnableUploadLog&&this._timeoutId!==-1}installEvents(){E.on(p.JOIN_SCHEDULE_SUCCESS,({schedule:t})=>{var e;((e=t==null?void 0:t.config)==null?void 0:e.logLevelToUpload)&&Fe[t.config.logLevelToUpload]&&(this._logLevelToUpload=t.config.logLevelToUpload)}),E.on(p.JOIN_SUCCESS,({room:t})=>{this.addJoinedUser({userId:t.userId,sdkAppId:t.sdkAppId}),this.startUpload()}),E.once(p.JOIN_FAILED,()=>{this.startUpload()}),E.on(p.LEAVE_SUCCESS,({room:t})=>{this.deleteJoinedUser(t.userId)})}startUpload(){this._timeoutId===-1&&this.uploadInterval()}addJoinedUser(t){this._localJoinedUser.set(t.userId,t),this.startUpload()}deleteJoinedUser(t){this._localJoinedUser.delete(t)}uploadInterval(){this.upload().catch(()=>{}),this._timeoutId=window.setTimeout(()=>this.uploadInterval(),2e3)}getLogsToUpload(){let t={map:new Map,splicedQueue:[]};if(this._queue[0].forAllJoinedClients&&this._localJoinedUser.size===0)return t;let e=0;for(;e<this._queue.length&&e!==50;e++){let i=this._queue[e];if(i.forAllJoinedClients)this._localJoinedUser.forEach(({userId:s,sdkAppId:o})=>{t.map.has(s)?t.map.get(s).logs.push(i):t.map.set(s,{userId:s,sdkAppId:o,logs:[i]})});else if(X(i.userId)&&Q(i.sdkAppId)){let{userId:s,sdkAppId:o}=i;t.map.has(s)?t.map.get(s).logs.push(i):t.map.set(s,{userId:s,sdkAppId:o,logs:[i]})}}return t.map.size>0&&(t.splicedQueue=this._queue.splice(0,e)),t}upload(){return _(this,null,function*(){if(this._queue.length===0||!this._isEnableUploadLog)return;let{map:t,splicedQueue:e}=this.getLogsToUpload();if(t.size===0)return;try{let s=[...t.values()];for(let o=0;o<s.length;o++){let{userId:n,sdkAppId:a,logs:c}=s[o];yield this.uploadLogWithRetry(JSON.stringify({timestamp:Rs(),sdkAppId:String(a),userId:n,version:Ie,log:c.map(l=>l.log).join(`
`)}),a),c.forEach(l=>l.uploaded=!0)}}catch(s){}let i=e.filter(s=>!s.uploaded);i.length>0&&(this._queue=i.concat(this._queue))})}uploadLogWithRetry(t,e){return rt({retryFunction:()=>Ht({url:ui(e,ci.LOG),body:t,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(i,s)=>{s()}})()}getPrefix(t){let e=new Date;e.setTime(fr());let i=String(e.getMilliseconds());return"padStart"in String.prototype&&(i=i.toString().padStart(3,"0")),`[${e.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${i}] <${Fe[t]}>`}getLogLevel(){return this._logLevel}setLogLevel(t){T(Fe[t])||(this._logLevel!==t&&this.info("setLogLevel",t),this._logLevel=t)}enableUploadLog(){this._isEnableUploadLog=!0}disableUploadLog(){this.warn("disableUploadLog"),this._isEnableUploadLog=!1}logChunkToString(t){if(X(t))return t;try{return JSON.stringify(t)}catch(e){return""}}log(t,e,i=!0,s,o){var a;if(e.unshift(this.getPrefix(t)),this._isEnableUploadLog&&t>=this._logLevelToUpload&&this._queue.push({log:e.reduce((c,l)=>`${c} ${this.logChunkToString(l)}`.trim(),""),level:t,userId:s,sdkAppId:o,forAllJoinedClients:i}),t<this._logLevel)return;let n=((a=Fe[t])==null?void 0:a.toLowerCase())||"info";Xu?console[n](Ju,ju,Yu,...e):console[n](...e)}debug(...t){this.log(1,t)}info(...t){this.log(2,t)}warn(...t){this.log(3,t)}error(...t){this.log(4,t)}createLogger(t){return new Qi(t)}checkURLParam(){let e=new URLSearchParams(location.search).get("logLevelToUpload"),i=e?Number(e):-1;Fe[i]&&(this._logLevelToUpload=i)}},g=new gn;var Qu=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let t=Math.random()*16|0;return(r=="x"?t:t&3|8).toString(16)})},An=Qu;var Rn=class{constructor(){d(this,"_prefix","TRTC");d(this,"_queue",new Map);this.checkStorage()}getRealKey(t){return`${this._prefix}_${t}`}checkStorage(){if(!ht())return;setInterval(this.doFlush.bind(this),2e4),Object.keys(localStorage).filter(i=>{if(i.startsWith(this._prefix)){let s=JSON.parse(localStorage.getItem(i));if(s&&s.expiresIn<Date.now())return!0}return!1}).forEach(i=>localStorage.removeItem(i))}doFlush(){if(!!ht())try{for(let[t,e]of this._queue)localStorage.setItem(t,JSON.stringify(e))}catch(t){g.warn(t)}}getItem(t){if(!ht())return null;try{let e=JSON.parse(localStorage.getItem(this.getRealKey(t)));return e&&e.expiresIn>=Date.now()?e.value:null}catch(e){g.warn(e)}}setItem(t,e){if(!!ht())try{let i={expiresIn:Date.now()+Gs,value:e};this._queue.set(this.getRealKey(t),i)}catch(i){g.warn(i)}}deleteItem(t){if(!ht())return!1;try{return t=this.getRealKey(t),this._queue.delete(t),localStorage.removeItem(t),!0}catch(e){return g.warn(e),!1}}clear(){if(!!ht())try{localStorage.clear()}catch(t){g.warn(t)}}},qi=new Rn;var Tt={};pr(Tt,{HTTPS_API:()=>rh,IS_GET_CAPABILITIES_SUPPORTED:()=>On,IS_GET_SETTINGS_SUPPORTED:()=>Ke,IS_SEI_SUPPORTED:()=>Wt,IS_SPC_SUPPORTED:()=>Kr,basis:()=>ah,checkSystemRequirementsInternal:()=>yn,decodeSupportStatus:()=>ro,encodeSupportStatus:()=>Fc,getBrowserInfo:()=>th,getDisplayResolution:()=>Gc,isAddTransceiverSupported:()=>We,isBrowserSupported:()=>Cn,isGetReceiversSupported:()=>mi,isGetSendersSupported:()=>zi,isGetTransceiversSupported:()=>ot,isGetUserMediaSupported:()=>Wc,isMediaDevicesSupported:()=>io,isMediaSessionSupported:()=>Yc,isMediaStreamTrackProcessorSupported:()=>Nn,isReplaceTrackSupported:()=>nh,isScreenCaptureApiAvailable:()=>Wr,isSelectedCandidatePair:()=>Gt,isSetParametersSupported:()=>Jr,isSmallStreamAPISupported:()=>Jc,isSmallStreamSupported:()=>so,isStopTransceiverSupported:()=>oh,isTRTCSupported:()=>ih,isUnifiedPlanDefault:()=>sh,isUsedInHttpProtocol:()=>Ft,isWebAudioSupported:()=>Kc,isWebCodecSupported:()=>jc,isWebCodecsSupported:()=>Hc,isWebRTCSupported:()=>Dn,isWebTransportSupported:()=>Xc});var C={AVOID_REPEATED_CALL:"AVOID_REPEATED_CALL",INVALID_PARAMETER_REQUIRED:"INVALID_PARAMETER_REQUIRED",INVALID_PARAMETER_TYPE:"INVALID_PARAMETER_TYPE",INVALID_PARAMETER_EMPTY:"INVALID_PARAMETER_EMPTY",INVALID_PARAMETER_INSTANCE:"INVALID_PARAMETER_INSTANCE",INVALID_PARAMETER_RANGE:"INVALID_PARAMETER_RANGE",INVALID_PARAMETER_MIN:"INVALID_PARAMETER_MIN",INVALID_PARAMETER_MAX:"INVALID_PARAMETER_MAX",INVALID_PARAMETER_STREAMTYPE:"INVALID_PARAMETER_STREAMTYPE",API_CALL_TIMEOUT:"API_CALL_TIMEOUT",SIGNAL_CHANNEL_RECONNECTION_FAILED:"SIGNAL_CHANNEL_RECONNECTION_FAILED",SIGNAL_CHANNEL_SETUP_FAILED:"SIGNAL_CHANNEL_SETUP_FAILED",ERROR_MESSAGE:"ERROR_MESSAGE",EXCHANGE_SDP_TIMEOUT:"EXCHANGE_SDP_TIMEOUT",DOWNLINK_RECONNECTION_FAILED:"DOWNLINK_RECONNECTION_FAILED",EXCHANGE_SDP_FAILED:"EXCHANGE_SDP_FAILED",UPDATE_OFFER_TIMEOUT:"UPDATE_OFFER_TIMEOUT",UPLINK_RECONNECTION_FAILED:"UPLINK_RECONNECTION_FAILED",INVALID_RECORDID:"INVALID_RECORDID",INVALID_PURE_AUDIO:"INVALID_PURE_AUDIO",INVALID_STREAMID:"INVALID_STREAMID",INVALID_USER_DEFINE_RECORDID:"INVALID_USER_DEFINE_RECORDID",INVALID_USER_DEFINE_PUSH_ARGS:"INVALID_USER_DEFINE_PUSH_ARGS",INVALID_PROXY:"INVALID_PROXY",INVALID_JOIN:"INVALID_JOIN",INVALID_ROOMID_STRING:"INVALID_ROOMID_STRING",INVALID_ROOMID_INTEGER:"INVALID_ROOMID_INTEGER",INVALID_SIGNAL_CHANNEL:"INVALID_SIGNAL_CHANNEL",JOIN_ROOM_TIMEOUT:"JOIN_ROOM_TIMEOUT",JOIN_ROOM_FAILED:"JOIN_ROOM_FAILED",REJOIN_ROOM_FAILED:"REJOIN_ROOM_FAILED",INVALID_DESTROY:"INVALID_DESTROY",INVALID_PUBLISH:"INVALID_PUBLISH",INVALID_UNPUBLISH:"INVALID_UNPUBLISH",INVALID_AUDIENCE:"INVALID_AUDIENCE",INVALID_INITIALIZE:"INVALID_INITIALIZE",INVALID_DUPLICATE_PUBLISHING:"INVALID_DUPLICATE_PUBLISHING",INVALID_SUBSCRIBE_UNDEFINED:"INVALID_SUBSCRIBE_UNDEFINED",INVALID_SUBSCRIBE_LOCAL:"INVALID_SUBSCRIBE_LOCAL",INVALID_REMOTE_STREAM:"INVALID_REMOTE_STREAM",SUBSCRIBE_FAILED:"SUBSCRIBE_FAILED",INVALID_ROLE:"INVALID_ROLE",INVALID_PARAMETER_SWITCH_ROLE:"INVALID_PARAMETER_SWITCH_ROLE",INVALID_OPERATION_SWITCH_ROLE:"INVALID_OPERATION_SWITCH_ROLE",SWITCH_ROLE_TIMEOUT:"SWITCH_ROLE_TIMEOUT",SWITCH_ROLE_FAILED:"SWITCH_ROLE_FAILED",CLIENT_BANNED:"CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"INVALID_OPERATION_START_PUBLISH_CDN",INVALID_OPERATION_STOP_PUBLISH_CDN:"INVALID_OPERATION_STOP_PUBLISH_CDN",INVALID_STREAM_ID:"INVALID_STREAM_ID",START_PUBLISH_CDN_FAILED:"START_PUBLISH_CDN_FAILED",STOP_PUBLISH_CDN_FAILED:"STOP_PUBLISH_CDN_FAILED",START_MIX_TRANSCODE:"START_MIX_TRANSCODE",STOP_MIX_TRANSCODE:"STOP_MIX_TRANSCODE",INVALID_AUDIO_VOLUME:"INVALID_AUDIO_VOLUME",ENABLE_SMALL_STREAM_PUBLISHED:"ENABLE_SMALL_STREAM_PUBLISHED",DISABLE_SMALL_STREAM_PUBLISHED:"DISABLE_SMALL_STREAM_PUBLISHED",NOT_SUPPORTED_SMALL_STREAM:"NOT_SUPPORTED_SMALL_STREAM",INVALID_SMALL_STREAM_PROFILE:"INVALID_SMALL_STREAM_PROFILE",INVALID_PARAMETER_REMOTE_STREAM:"INVALID_PARAMETER_REMOTE_STREAM",INVALID_OPERATION_CHANGE_SMALL:"INVALID_OPERATION_CHANGE_SMALL",REMOTE_NOT_PUBLISH_SMALL_STREAM:"REMOTE_NOT_PUBLISH_SMALL_STREAM",INVALID_SWITCH_DEVICE:"INVALID_SWITCH_DEVICE",INVALID_SWITCH_DEVICE_PUBLISHING:"INVALID_SWITCH_DEVICE_PUBLISHING",INVALID_REPLACE_TRACK:"INVALID_REPLACE_TRACK",INVALID_INITIALIZE_LOCAL_STREAM:"INVALID_INITIALIZE_LOCAL_STREAM",INVALID_ADD_TRACK_REPETITIVE:"INVALID_ADD_TRACK_REPETITIVE",INVALID_ADD_TRACK_REMOVING:"INVALID_ADD_TRACK_REMOVING",INVALID_ADD_TRACK_PUBLISHING:"INVALID_ADD_TRACK_PUBLISHING",INVALID_STREAM_INITIALIZED:"INVALID_STREAM_INITIALIZED",INVALID_ADD_TRACK_NUMBER:"INVALID_ADD_TRACK_NUMBER",INVALID_REMOVE_AUDIO_TRACK:"INVALID_REMOVE_AUDIO_TRACK",INVALID_REMOVE_AUDIO_ADDING:"INVALID_REMOVE_AUDIO_ADDING",INVALID_REMOVE_AUDIO_ON:"INVALID_REMOVE_AUDIO_ON",INVALID_REMOVE_TRACK_PUBLISHING:"INVALID_REMOVE_TRACK_PUBLISHING",INVALID_REMOVE_TRACK_NOT_TRACK:"INVALID_REMOVE_TRACK_NOT_TRACK",INVALID_REMOVE_TRACK_NUMBER:"INVALID_REMOVE_TRACK_NUMBER",INVALID_REPLACE_TRACK_NO_TRACK:"INVALID_REPLACE_TRACK_NO_TRACK",REPEAT_JOIN:"REPEAT_JOIN",CLIENT_DESTROYED:"CLIENT_DESTROYED",NOT_BUG_PACKAGE:"NOT_BUG_PACKAGE",START_MIX_TRANSCODE_FAILED:"START_MIX_TRANSCODE_FAILED",STOP_MIX_TRANSCODE_FAILED:"STOP_MIX_TRANSCODE_FAILED",MIX_TRANSCODE_NOT_STARTED:"MIX_TRANSCODE_NOT_STARTED",CANNOT_LESS_THAN_ZERO:"CANNOT_LESS_THAN_ZERO",MIX_PARAMS_VIDEO_FRAMERATE:"MIX_PARAMS_VIDEO_FRAMERATE",MIX_PARAMS_VIDEO_GOP:"MIX_PARAMS_VIDEO_GOP",MIX_PARAMS_AUDIO_BITRATE:"MIX_PARAMS_AUDIO_BITRATE",MIX_PARAMS_USER_Z_ORDER:"MIX_PARAMS_USER_Z_ORDER",MIX_PARAMS_NOT_SELF:"MIX_PARAMS_NOT_SELF",MIX_PARAMS_USER_STREAM:"MIX_PARAMS_USER_STREAM",INVALID_PLAY:"INVALID_PLAY",INVALID_ELEMENT_ID:"INVALID_ELEMENT_ID",INVALID_ELEMENT_ID_TYPE:"INVALID_ELEMENT_ID_TYPE",PLAY_FAILED:"PLAY_FAILED",INVALID_USERID:"INVALID_USERID",INVALID_CREATE_STREAM_SOURCE:"INVALID_CREATE_STREAM_SOURCE",INVALID_CREATE_STREAM_SCREEN:"INVALID_CREATE_STREAM_SCREEN",INVALID_CREATE_STREAM_AUDIO:"INVALID_CREATE_STREAM_AUDIO",INVALID_CREATE_STREAM_SCREEN_AUDIO:"INVALID_CREATE_STREAM_SCREEN_AUDIO",NOT_SUPPORTED_HTTP:"NOT_SUPPORTED_HTTP",NOT_SUPPORTED_WEBRTC:"NOT_SUPPORTED_WEBRTC",NOT_SUPPORTED_PROFILE:"NOT_SUPPORTED_PROFILE",NOT_SUPPORTED_MEDIA:"NOT_SUPPORTED_MEDIA",NOT_SUPPORTED_H264ENCODE:"NOT_SUPPORTED_H264ENCODE",NOT_SUPPORTED_H264DECODE:"NOT_SUPPORTED_H264DECODE",NOT_SUPPORTED_TRACK:"NOT_SUPPORTED_TRACK",NOT_SUPPORTED_SWITCH_DEVICE:"NOT_SUPPORTED_SWITCH_DEVICE",NOT_SUPPORTED_CAPTURE:"NOT_SUPPORTED_CAPTURE",NOT_SUPPORTED_AUX:"NOT_SUPPORTED_AUX",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",SIGNAL_RESPONSE_FAILED:"SIGNAL_RESPONSE_FAILED",CATCH_HANDLER_ERROR:"CATCH_HANDLER_ERROR",API_NOT_EXIST:"API_NOT_EXIST",CONNECTION_CLOSED:"CONNECTION_CLOSED",SUBSCRIBE_ALL_FALSE:"SUBSCRIBE_ALL_FALSE",SEI_NOT_SUPPORT:"SEI_NOT_SUPPORT",SEI_DISABLED:"SEI_DISABLED",SEI_EMPTY:"SEI_EMPTY",SEI_OVERSIZE:"SEI_OVERSIZE",SEI_BEFORE_PUBLISH:"SEI_BEFORE_PUBLISH",SEI_NOT_VIDEO:"SEI_NOT_VIDEO",CALL_FREQUENCY_LIMIT:"CALL_FREQUENCY_LIMIT",CONNECTION_ABORTED:"CONNECTION_ABORTED",API_CALL_ABORTED:"API_CALL_ABORTED",DUPLICATE_AUX:"DUPLICATE_AUX"},le={AVOID_REPEATED_CALL(r){return`previous ${r.name}() is ongoing, please avoid repeated calls.`},INVALID_PARAMETER_REQUIRED({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' is a required param when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_TYPE({key:r,rule:t,fnName:e,value:i}){let s=`${r||t.name}`,o="";return Array.isArray(t.type)?o=t.type.join("|"):o=t.type,`'${s}' must be type of ${o} when calling ${e}(), received type: ${ie(i)}.`},INVALID_PARAMETER_EMPTY({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' cannot be '${i}' when calling ${e}().`},INVALID_PARAMETER_INSTANCE({key:r,rule:t,fnName:e,value:i}){let s=`${r||t.name}`,o=`${t.instanceOf.name||t.instanceOf}`;return`'${s}' must be instanceof ${o} when calling ${e}(), received type: ${ie(i)}.`},INVALID_PARAMETER_RANGE({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' must be one of ${t.values.join("|")} when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_MIN({key:r,rule:t,fnName:e,value:i}){return`the min value of ${r||t.name} is ${t.min}, received: ${i}.`},INVALID_PARAMETER_MAX({key:r,rule:t,fnName:e,value:i}){return`the max value of ${r||t.name} is ${t.max}, received: ${i}.`},API_CALL_TIMEOUT(r){return`${r.commandDesc||r.command} timeout observed.`},SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED(r){return`SignalChannel setup failure: (errorCode: ${r.errorCode}, errorMsg: ${r.errorMsg} }).`},ERROR_MESSAGE(r){let t=`${r.type} failed`;return r.message&&(t=`${t}: ${r.message}.`),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED(r){return`exchange sdp failed ${r.errMsg}.`},UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING(r){return`'${r}' must be validate string when useStringRoomId is true.`},INVALID_ROOMID_INTEGER(r){return`'${r}' must be an integer between [1, 4294967294] when useStringRoomId is false.`},INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED({error:r,code:t}){return`Failed to join room - ${r} code: ${t}`},REJOIN_ROOM_FAILED(r){return`reJoin room: ${r.roomId} failed, please check your network.`},INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:`no permission to publish() under live/${"audience"}, please call switchRole("${"anchor"}") firstly before publish().`,INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING(r){return`duplicate ${r} stream publishing, please unpublish your prev ${r} stream and then re-publish.`},INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED({message:r,userId:t,streamType:e}){return`failed to subscribe ${t} ${e} stream, reason: ${r}.`},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:`role could only be set to a value as ${"anchor"} or ${"audience"}.`,INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED(r){return`switchRole failed, errCode: ${r.code} errMsg: ${r.message}.`},CLIENT_BANNED(r){return`client was banned because of ${r.message}.`},INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() after join room and publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED(r){return`startPublishCDNStream failed, errMsg: ${r.message}.`},STOP_PUBLISH_CDN_FAILED(r){return`stopPublishCDNStream failed, errMsg: ${r.message}.`},INVALID_STREAM_ID(r){return`'${r}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_TRACK:"localStream has not this track.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK(r){return`cannot replace ${r.kind} track because stream has not ${r.kind} track`},NOT_BUG_PACKAGE:"You need to buy packages, refer to tencent console.",START_MIX_TRANSCODE_FAILED(r){return`startMixTranscode failed, errMsg: ${r.message}.`},STOP_MIX_TRANSCODE_FAILED(r){return`stopMixTranscode failed, errMsg: ${r.message}.`},MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' cannot be less than 0 when calling ${e}().`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER(r){return`'${r}' is required and must be between 1 and 15.`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:({key:r,fnName:t})=>`'${r}' is not found in the document object when calling ${t}().`,INVALID_ELEMENT_ID_TYPE:({key:r,fnName:t,type:e})=>`the element corresponding to '${r}' must be instanceof HTMLElement when calling ${t}(), received: ${e}.`,PLAY_FAILED:r=>`${r.media} play failed\uFF0Cbrowser exception: ${r.error.toString()}`,INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture microphone, camera and screen. please use https to deploy your page.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK(r){return`${r}Track is not supported on your browser.`},NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone.",CAMERA_NOT_FOUND:"no camera detected, please check your camera.",SIGNAL_RESPONSE_FAILED(r){return`${r.signalResponse} failed, response code is ${r.code} , errMsg: ${r.message}.`},CATCH_HANDLER_ERROR({name:r,event:t}){return`an error was caught on ${r}.on('${t}', handler), please check your code on 'handler'.`},API_NOT_EXIST({name:r}){return`experimental api ${r} does not exist.`},REPEAT_JOIN:r=>`[${r}] is calling client.join api or has already joined room, please avoid repeated join.`,CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED({funName:r}){return`failed to call ${r}() because client was destroyed.`},SEI_NOT_SUPPORT:r=>`not support to sendSEIMessage${r===!1?" without using h264 codec":""}`,SEI_DISABLED:"SEI is disabled",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:r=>`buffer size(${r}) is over 1000 Bytes`,SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:({isSize:r,name:t,timesInSecond:e,maxSizeInSecond:i})=>`api ${t} call ${r?"size":"times"} is over ${r?`${i} bytes`:e} in a second.`,CONNECTION_ABORTED(r){return`connection aborted due to: ${r}`},API_CALL_ABORTED(r){let t;return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t=`Subscribe ${r.userId} ${r.streamType} stream aborted, reason: remote user ${r.userId} unpublished stream.`:t=`API aborted, reason: ${r.message}`,t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser.",INVALID_PARAMETER_STREAMTYPE:r=>`'streamType' is required when 'userId' is not '*', calling ${r}()`};function Vc(r){return Reflect.apply(Object.prototype.toString,r,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var qu={AVOID_REPEATED_CALL(r){return`\u524D\u4E00\u4E2A ${r.name}() \u8C03\u7528\u6B63\u5728\u8FDB\u884C\u4E2D, \u8BF7\u907F\u514D\u91CD\u590D\u8C03\u7528\u3002`},INVALID_PARAMETER_REQUIRED({key:r,rule:t,fnName:e,value:i}){return`\u8C03\u7528 ${e}() \u65B9\u6CD5\u7684\u65F6\u5019 '${r||t.name}' \u662F\u5FC5\u987B\u7684\u53C2\u6570, \u6536\u5230\u7684\u503C\u4E3A: ${i}\u3002`},INVALID_PARAMETER_TYPE({key:r,rule:t,fnName:e,value:i}){let s=`${r||t.name}`,o="";return Array.isArray(t.type)?o=t.type.join("|"):o=t.type,`\u8C03\u7528 ${e}() \u65B9\u6CD5\u7684\u65F6\u5019 '${s}' \u5FC5\u987B\u662F ${o} \u7C7B\u578B, \u6536\u5230\u7684\u7C7B\u578B\u662F: ${Vc(i)}\u3002`},INVALID_PARAMETER_EMPTY({key:r,rule:t,fnName:e,value:i}){return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${r||t.name}' \u4E0D\u80FD\u662F '${i}'\u3002`},INVALID_PARAMETER_INSTANCE({key:r,rule:t,fnName:e,value:i}){let s=`${r||t.name}`,o=`${t.instanceOf.name||t.instanceOf}`;return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${s}' \u539F\u578B\u5FC5\u987B\u662F ${o} , \u6536\u5230\u7684\u662F: ${Vc(i)}\u3002`},INVALID_PARAMETER_RANGE({key:r,rule:t,fnName:e,value:i}){return`\u8C03\u7528 ${e}() \u7684\u65F6\u5019 '${r||t.name}' \u5FC5\u987B\u662F ${t.values.join("|")} \u7684\u5176\u4E2D\u4E00\u79CD, \u6536\u5230\u7684\u662F: ${i}\u3002`},API_CALL_TIMEOUT(r){return`${r.commandDesc||r.command} \u8D85\u65F6\u3002`},SIGNAL_CHANNEL_RECONNECTION_FAILED:"\u4FE1\u4EE4\u901A\u9053\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u4F60\u7684\u7F51\u7EDC\u3002",SIGNAL_CHANNEL_SETUP_FAILED(r){return`\u4FE1\u4EE4\u901A\u9053\u5EFA\u7ACB\u5931\u8D25: (\u9519\u8BEF\u7801: ${r.errorCode}, \u9519\u8BEF\u4FE1\u606F: ${r.errorMsg} })\u3002`},ERROR_MESSAGE(r){let t=`${r.type} \u5931\u8D25\u3002`;return r.message&&(t=`${t}: ${r.message}\u3002`),t},SUBSCRIPTION_TIMEOUT:"\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0D\u54CD\u5E94\u8BA2\u9605\u884C\u4E3A\u3002",EXCHANGE_SDP_TIMEOUT:"\u4EA4\u6362 sdp \u8D85\u65F6\uFF0C\u8BF7\u5237\u65B0\u7F51\u7EDC\u91CD\u8BD5\u3002",DOWNLINK_RECONNECTION_FAILED:"\u4E0B\u884C\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u7F51\u7EDC\u5E76\u91CD\u65B0\u52A0\u5165\u623F\u95F4\u3002",EXCHANGE_SDP_FAILED(r){return`\u4EA4\u6362 SDP \u5931\u8D25\uFF0C\u539F\u56E0 ${r.errMsg}\u3002`},REPLACE_TRACK_INVALID:"LocalStream \u53D1\u5E03\u4E4B\u540E\u624D\u53EF\u4EE5\u8C03\u7528 replaceTrack\u3002",UPDATE_OFFER_TIMEOUT:"\u66F4\u65B0 offer \u8D85\u65F6\uFF0C\u8BF7\u5237\u65B0\u7F51\u7EDC\u91CD\u8BD5\u3002",UPLINK_RECONNECTION_FAILED:"\u4E0A\u884C\u91CD\u8FDE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u7F51\u7EDC\u5E76\u91CD\u65B0\u63A8\u6D41\u3002",INVALID_RECORDID:"recordId \u5FC5\u987B\u662F\u6570\u5B57\u3002",INVALID_PURE_AUDIO:"pureAudioPushMode \u5FC5\u987B\u662F\u6570\u5B571\u62162\u3002",INVALID_STREAMID:"streamId \u5FC5\u987B\u662F 64 \u5B57\u8282\u4EE5\u5185\u7684\u5B57\u7B26\u4E32\uFF0C\u5E76\u4E14\u4E0D\u80FD\u4E3A\u7A7A\u3002",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId \u5FC5\u987B\u662F\u5305\u542B (a-zA-Z)\u3001(0-9)\u3001\u4E0B\u5212\u7EBF\u548C\u8FDE\u5B57\u7B26\u7684\u5B57\u7B26\u4E32\u5B57\u9762\u91CF\uFF0C64 \u4E2A\u5B57\u8282\u4EE5\u5185\uFF0C\u4E14\u4E0D\u4E3A\u7A7A\u3002",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs \u5FC5\u987B\u662F 256 \u5B57\u8282\u4EE5\u5185\u7684\u5B57\u7B26\u4E32\u6587\u5B57\uFF0C\u5E76\u4E14\u4E0D\u80FD\u4E3A\u7A7A\u3002",INVALID_PROXY:"\u4EE3\u7406\u670D\u52A1\u5668 url \u5FC5\u987B\u4EE5\u201Cwss://\u201D\u5F00\u5934\u3002",INVALID_JOIN:"join() \u65B9\u6CD5\u4E0D\u80FD\u88AB\u91CD\u590D\u8C03\u7528\u3002",INVALID_ROOMID_STRING(r){return`\u5F53 useStringRoomId \u4E3A true \u65F6\uFF0C'${r}' \u5FC5\u987B\u662F\u5408\u6CD5\u5B57\u7B26\u4E32\u3002`},INVALID_ROOMID_INTEGER(r){return`\u5F53 useStringRoomId \u4E3A false \u65F6\uFF0C'${r}' \u5FC5\u987B\u662F\u5408\u6CD5\u6574\u6570\u5728\u533A\u95F4[1, 4294967294]\u3002`},INVALID_SIGNAL_CHANNEL:"SignalChannel \u8FD8\u672A\u521D\u59CB\u5316\u597D\u3002",JOIN_ROOM_TIMEOUT:"\u8FDB\u623F\u8D85\u65F6\u3002",JOIN_ROOM_FAILED(r){return`\u8FDB\u623F\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A${r.error}\u3002`},REJOIN_ROOM_FAILED(r){return`\u91CD\u8FDB\u623F: ${r.roomId} \u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u72B6\u51B5\u3002`},INVALID_LEAVE:"\u8BF7\u5728\u8C03\u7528 destroy() \u65B9\u6CD5\u4E4B\u524D\u8C03\u7528 leave()\u3002",INVALID_PUBLISH:"\u8BF7\u5728\u8C03\u7528 publish() \u65B9\u6CD5\u4E4B\u524D\u8C03\u7528 join()\u3002",INVALID_UNPUBLISH:"\u8FD8\u6CA1\u6709\u88AB publish\u3002",INVALID_AUDIENCE:"\u5728\u89C2\u4F17\u6A21\u5F0F\u4E0B\u4E0D\u5141\u8BB8\u8C03\u7528 publish()\uFF0C\u8BF7\u5148\u5207\u6362\u6210\u4E3B\u64AD\u6A21\u5F0F\u3002",INVALID_INITIALIZE:"\u65E0\u6CD5\u53D1\u5E03 stream\uFF0C\u539F\u56E0\uFF1AlocalStream \u672A\u521D\u59CB\u5316\u3001\u6B63\u5728\u5207\u6362\u8BBE\u5907\u3001\u5DF2\u7ECF\u8C03\u7528 localStream.close() \u5173\u95ED\u91C7\u96C6",INVALID_DUPLICATE_PUBLISHING:"\u91CD\u590D\u53D1\u5E03\uFF0C\u8BF7\u5148 unpublish \u4E4B\u540E\uFF0C\u518D\u91CD\u65B0 publish\u3002",INVALID_SUBSCRIBE_UNDEFINED:"stream \u53C2\u6570\u662F undefined \u6216\u8005 null\u3002",INVALID_SUBSCRIBE_LOCAL:"stream \u53C2\u6570\u4E0D\u80FD\u4E3A\u672C\u5730\u6D41\u3002",INVALID_REMOTE_STREAM:"remoteStream \u4E0D\u5B58\u5728\uFF0C\u5DF2\u88AB\u8FDC\u7AEF client \u53D6\u6D88\u53D1\u5E03\u3002",SUBSCRIBE_FAILED(r){let t="\u8BA2\u9605\u6D41\u5931\u8D25\uFF0C\u539F\u56E0: ";return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t+="\u8FDC\u7AEF\u7528\u6237\u5DF2\u53D6\u6D88\u63A8\u6D41\uFF0C\u65E0\u6CD5\u8BA2\u9605\u8BE5\u8FDC\u7AEF\u6D41\u3002":t+=`${r.message}\u3002`,t},INVALID_ROLE:"\u53EA\u6709\u76F4\u64AD\u6A21\u5F0F\u624D\u53EF\u4EE5\u8FDB\u884C\u89D2\u8272\u5207\u6362\u3002",INVALID_PARAMETER_SWITCH_ROLE:"role \u53EA\u80FD\u8BBE\u7F6E\u4E3A anchor \u6216\u8005 audience\u3002",INVALID_OPERATION_SWITCH_ROLE:"\u8BF7\u5728\u4F7F\u7528 switchRole() \u65B9\u6CD5\u524D\u5148\u8FDB\u623F\u3002",SWITCH_ROLE_TIMEOUT:"\u5207\u6362\u89D2\u8272\u8D85\u65F6\u3002",SWITCH_ROLE_FAILED(r){return`\u5207\u6362\u89D2\u8272\u5931\u8D25\u3002\u9519\u8BEF\u7801: ${r.code} \u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},CLIENT_BANNED(r){return`\u60A8\u88AB\u52A8\u9000\u623F\u4E86\uFF0C\u539F\u56E0\u4E3A\uFF1A${r.reason}\u3002`},INVALID_OPERATION_START_PUBLISH_CDN:"\u8BF7\u5728\u8FDB\u623F\u524D\u6216\u8005\u8FDB\u623F\u5E76\u6210\u529F\u53D1\u5E03\u672C\u5730\u6D41\u540E\u8C03\u7528 startPublishCDNStream() \u65B9\u6CD5\u3002",INVALID_OPERATION_STOP_PUBLISH_CDN:"\u5728\u8C03\u7528 stopPublishCDNStream() \u65B9\u6CD5\u524D\u9700\u8981\u5148 startPublishCDNStream()\u3002",INVALID_STREAM_ID(r){return`'${r}' \u53EA\u80FD\u7531\u5927\u5C0F\u5199\u5B57\u6BCD\uFF08a-zA-z\uFF09, \u6570\u5B57\uFF080-9\uFF09, \u8FDE\u5B57\u7B26\u548C\u4E0B\u5212\u7EBF\u7EC4\u6210`},START_PUBLISH_CDN_FAILED(r){return`startPublishCDNStream \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},STOP_PUBLISH_CDN_FAILED(r){return`stopPublishCDNStream \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},START_MIX_TRANSCODE:"\u8C03\u7528 startMixTranscode() \u65B9\u6CD5\u524D\u9700\u8981\u5148\u8C03\u7528 join()\u3002",STOP_MIX_TRANSCODE:"\u8C03\u7528 stopMixTranscode \u4E4B\u524D\u9700\u8981\u8C03\u7528 startMixTranscode\u3002",INVALID_AUDIO_VOLUME:"interval \u5FC5\u987B\u662F\u6570\u5B57\u3002",ENABLE_SMALL_STREAM_PUBLISHED:"\u53D1\u5E03 localStream \u4E4B\u540E\u4E0D\u5141\u8BB8\u5F00\u542F\u5C0F\u6D41\u3002",DISABLE_SMALL_STREAM_PUBLISHED:"\u53D1\u5E03 localStream \u4E4B\u540E\u4E0D\u5141\u8BB8\u5173\u95ED\u5C0F\u6D41\u3002",NOT_SUPPORTED_SMALL_STREAM:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u5F00\u542F\u5C0F\u6D41\u3002",INVALID_SMALL_STREAM_PROFILE:"\u5C0F\u6D41\u53C2\u6570\u4E0D\u5408\u6CD5\u3002",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream \u4E0D\u5408\u6CD5\u3002",REMOTE_NOT_PUBLISH_SMALL_STREAM:"\u8FDC\u7AEF\u7528\u6237\u6CA1\u6709\u53D1\u5E03\u5C0F\u6D41\u3002",INVALID_SWITCH_DEVICE:"\u5F53\u524D\u7684\u6D41\u4E0D\u53EF\u4EE5\u8C03\u7528 switchDevice\u3002",INVALID_SWITCH_DEVICE_PUBLISHING:"\u53D1\u5E03\u672C\u5730\u6D41\u65F6\u4E0D\u80FD\u5207\u6362\u8BBE\u5907\u3002",INVALID_REPLACE_TRACK:"client.publish \u63A5\u53E3\u5C1A\u672A\u8C03\u7528\u5B8C\u6210\uFF0C\u8BF7\u7B49\u5176\u8C03\u7528\u5B8C\u6210\u540E\u518D\u8C03\u7528 replaceTrack \u63A5\u53E3\u3002",INVALID_INITIALIZE_LOCAL_STREAM:"\u672C\u5730\u6D41\u8FD8\u6CA1\u6709\u521D\u59CB\u5316\u3002",INVALID_ADD_TRACK_REPETITIVE:"\u524D\u4E00\u4E2A addTrack \u6B63\u5728\u8FDB\u884C\uFF0C\u8BF7\u907F\u514D\u91CD\u590D\u8C03\u7528\u3002",INVALID_ADD_TRACK_REMOVING:"track \u5728\u79FB\u52A8\u7684\u65F6\u5019\u4E0D\u80FD\u6DFB\u52A0\u65B0\u7684 track\u3002",INVALID_ADD_TRACK_PUBLISHING:"\u5728\u53D1\u5E03\u672C\u5730\u6D41\u7684\u65F6\u5019\u4E0D\u80FD\u6DFB\u52A0\u65B0\u7684 track\u3002",INVALID_STREAM_INITIALIZED:"\u60A8\u7684\u672C\u5730\u6D41\u8FD8\u6CA1\u6709\u521D\u59CB\u5316\u3002",INVALID_ADD_TRACK_NUMBER:"\u4E00\u6761\u6D41\u6700\u591A\u6709\u4E00\u4E2A\u97F3\u9891\u8F68\u9053\u548C\u4E00\u4E2A\u89C6\u9891\u8F68\u9053\u3002",INVALID_REMOVE_AUDIO_TRACK:"remove audio track \u662F\u4E0D\u5141\u8BB8\u7684\u3002",INVALID_REMOVE_AUDIO_ADDING:"\u5F53\u4E00\u4E2A track \u88AB addTrack \u7684\u65F6\u5019\u4E0D\u80FD\u5BF9\u6D41\u8FDB\u884C removeTrack \u64CD\u4F5C\u3002",INVALID_REMOVE_AUDIO_ON:"\u524D\u4E00\u6B21\u8C03\u7528\u7684 removeTrack \u6B63\u5728\u8FDB\u884C\u4E2D\uFF0C\u8BF7\u907F\u514D\u91CD\u590D\u64CD\u4F5C\u3002",INVALID_REMOVE_TRACK_PUBLISHING:"\u53D1\u5E03\u6D41\u7684\u8FC7\u7A0B\u4E2D\u4E0D\u80FD\u8FDB\u884C removeTrack \u64CD\u4F5C\u3002",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"\u88AB remove \u7684 track \u6CA1\u6709\u88AB\u53D1\u5E03\u3002",INVALID_REMOVE_TRACK_NUMBER:"\u4E0D\u652F\u6301\u79FB\u9664\u552F\u4E00\u7684\u89C6\u9891\u8F68\u9053\uFF0C\u8BF7\u4F7F\u7528 replaceTrack \u6216\u8005 muteVideo \u65B9\u6CD5\u3002",INVALID_REPLACE_TRACK_NO_TRACK(r){return`LocalStream \u6CA1\u6709 ${r.kind} track\uFF0C\u65E0\u6CD5\u8FDB\u884C\u66FF\u6362\u3002`},START_MIX_TRANSCODE_FAILED(r){return`startMixTranscode \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F: ${r.message}\u3002`},STOP_MIX_TRANSCODE_FAILED(r){return`stopMixTranscode \u8C03\u7528\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F:  ${r.message}\u3002`},MIX_TRANSCODE_NOT_STARTED:"\u8FD8\u6CA1\u6709\u5F00\u59CB mixTranscode\u3002",CANNOT_LESS_THAN_ZERO({key:r,rule:t,fnName:e}){return`'\u5F53\u8C03\u7528 ${e}() \u51FD\u6570\u65F6\uFF0C\u8981\u6C42\u53C2\u6570 ${r||t.name}' \u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E0`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' \u5E94\u8BE5\u662F (0, 30] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' \u5E94\u8BE5\u662F [1, 8] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' \u5E94\u8BE5\u662F [32, 192] \u533A\u95F4\u5185\u7684\u6574\u6570\u3002",MIX_PARAMS_USER_Z_ORDER(r){return`'${r}' \u662F\u5FC5\u4F20\u7684\uFF0C\u4E14\u8981\u6C42\u4E3A [1 ,15] \u4E4B\u95F4\u7684\u6574\u6570\u3002`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' \u5FC5\u987B\u5305\u542B\u53D1\u8D77\u6DF7\u6D41\u7684\u7528\u6237\u4FE1\u606F\u3002",MIX_PARAMS_USER_STREAM:"\u8F93\u51FA\u6D41\u7684 'config.videoWidth' \u548C 'config.videoHeight' \u5E94\u8BE5\u5BB9\u7EB3\u6240\u6709\u6DF7\u5165\u6D41\u3002",INVALID_PLAY:"play() \u88AB\u91CD\u590D\u8C03\u7528\uFF0C\u8BF7\u5148 stop()\uFF0C\u7136\u540E\u518D\u91CD\u65B0\u8C03\u7528 play\u3002",INVALID_ELEMENT_ID:({key:r,fnName:t})=>`\u5728\u8C03\u7528 ${t}() \u65F6\uFF0Cdocument \u5BF9\u8C61\u4E2D\u627E\u4E0D\u5230 ${r} \u5BF9\u5E94\u7684\u5143\u7D20\uFF0C\u8BF7\u68C0\u67E5\u3002`,INVALID_ELEMENT_ID_TYPE:({key:r,type:t,fnName:e})=>`\u5728\u8C03\u7528 ${e}() \u65B9\u6CD5\u65F6\uFF0C${r} \u53C2\u6570\u5BF9\u5E94\u7684 HTML \u6807\u7B7E\u5143\u7D20\u5FC5\u987B\u662F HTMLElement \u5B9E\u4F8B\uFF0C\u60A8\u4F20\u5165\u7684\u662F\uFF1A${t}\u3002`,PLAY_FAILED:r=>`${r.media} \u64AD\u653E\u88AB\u4E2D\u65AD\uFF0C\u6D4F\u89C8\u5668\u5F02\u5E38\u539F\u56E0\uFF1A${r.error.toString()}`,INVALID_USERID:"userId \u4E0D\u80FD\u4E3A\u7A7A\u683C\u3002",INVALID_CREATE_STREAM_SOURCE:"createStream() \u751F\u6210 LocalStream \u53EF\u4EE5\u4F7F\u7528 audio & video \u6216 audioSource & videoSource \u521B\u5EFA\uFF0C\u4F46\u4E0D\u80FD\u6DF7\u5408\u4F7F\u7528\u3002",INVALID_CREATE_STREAM_SCREEN:"screen \u548C video \u4E0D\u80FD\u540C\u65F6\u4E3A true\u3002",INVALID_CREATE_STREAM_AUDIO:"audio \u548C screenAudio \u4E0D\u80FD\u540C\u65F6\u4E3A true\u3002",INVALID_CREATE_STREAM_SCREEN_AUDIO:"screen \u4E3A true \u65F6\uFF0C\u4E0D\u80FD\u8BBE\u7F6E screenAudio\u3002",NOT_SUPPORTED_HTTP:"\u7531\u4E8E\u6D4F\u89C8\u5668\u5B89\u5168\u7B56\u7565\u9650\u5236\uFF0C\u4E0D\u652F\u6301\u5728 http \u534F\u8BAE\u4E0B\u4F7F\u7528\u91C7\u96C6\u3001\u63A8\u6D41\u7B49\u80FD\u529B\uFF0C\u8BF7\u4F7F\u7528 https \u534F\u8BAE\u3002",NOT_SUPPORTED_WEBRTC:"\u5F53\u524D\u6D4F\u89C8\u5668\u6216\u73AF\u5883\u4E0D\u5B8C\u5168\u652F\u6301 WebRTC \u80FD\u529B\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_PROFILE:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 setVideoProfile \u65B9\u6CD5\u3002\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_MEDIA:"\u5F53\u524D\u6D4F\u89C8\u5668\u6216\u73AF\u5883\u4E0D\u652F\u6301 navigator.mediaDevices\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_H264ENCODE:"\u5F53\u524D\u7684\u8BBE\u5907\u6216\u73AF\u5883\u4E0D\u652F\u6301 H264 \u7F16\u7801\uFF0C\u4E0D\u652F\u6301 H264 \u683C\u5F0F\u8FDB\u884C\u63A8\u6D41\u3002",NOT_SUPPORTED_H264DECODE:"\u5F53\u524D\u7684\u8BBE\u5907\u6216\u73AF\u5883\u4E0D\u652F\u6301 H264 \u89E3\u7801\uFF0C\u4E0D\u652F\u6301 H264 \u683C\u5F0F\u8FDB\u884C\u62C9\u6D41\u3002",NOT_SUPPORTED_TRACK(r){return`\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 ${r}Track \u65B9\u6CD5\u3002`},NOT_SUPPORTED_REPLACE_TRACK:"\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 replaceTrack \u65B9\u6CD5\uFF0C\u8BF7\u4F7F\u7528 switchDevice \u6216\u8005 addTrack\u3002",NOT_SUPPORTED_CAPTURE:"\u60A8\u5F53\u524D\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u5C4F\u5E55\u5206\u4EAB\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u548C\u9875\u9762\u8BBF\u95EE\u534F\u8BAE\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\u3002",NOT_SUPPORTED_AUX:"\u60A8\u5F53\u524D\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u63A8\u8F85\u6D41\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u7248\u672C\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\uFF08Chrome 69+, Safari 11+, Firefox 59+\uFF09\u3002",MICROPHONE_NOT_FOUND:"\u672A\u68C0\u6D4B\u5230\u9EA6\u514B\u98CE\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u9EA6\u514B\u98CE\u548C TRTC.createStream \u4E0A\u7684\u914D\u7F6E\u3002",CAMERA_NOT_FOUND:"\u672A\u68C0\u6D4B\u5230\u6444\u50CF\u5934\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u6444\u50CF\u5934\u548C TRTC.createStream \u4E0A\u7684\u914D\u7F6E\u3002",CATCH_HANDLER_ERROR:({name:r,event:t})=>` \u5728 ${r}.on('${t}', handler) \u4E8B\u4EF6\u4E2D\u6355\u83B7\u5230\u4E1A\u52A1\u4FA7\u9519\u8BEF\uFF0C\u8BF7\u6839\u636E\u4E0B\u8FF0\u9519\u8BEF\u4FE1\u606F\uFF0C\u68C0\u67E5\u60A8\u5728 handler \u4E2D\u7684\u4E1A\u52A1\u4EE3\u7801\u3002`,REPEAT_JOIN:r=>`\u7528\u6237 [${r}] \u6B63\u5728\u8C03\u7528\u8FDB\u623F\u63A5\u53E3\u6216\u8005\u5DF2\u7ECF\u5728\u623F\u95F4\u5185\uFF0C\u8BF7\u52FF\u91CD\u590D\u521B\u5EFA\u76F8\u540C userId \u7684 client \u8FDB\u5165\u540C\u4E00\u4E2A\u623F\u95F4\u3002`,CLIENT_DESTROYED:({funName:r})=>`client \u5DF2\u7ECF\u88AB\u9500\u6BC1\uFF0C\u8C03\u7528 ${r}() \u65B9\u6CD5\u5931\u8D25\u3002`,API_CALL_ABORTED(r){let t;return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t=`\u4E2D\u65AD\u8BA2\u9605\u7528\u6237 ${r.userId} \u7684 ${r.streamType} stream, \u539F\u56E0: \u5728\u60A8\u8BA2\u9605\u8FC7\u7A0B\u4E2D\uFF0C\u8FDC\u7AEF\u7528\u6237 ${r.userId} \u53D6\u6D88\u4E86\u63A8\u6D41\uFF0C\u60A8\u53EF\u4EE5\u5728\u4E0B\u6B21\u8FDC\u7AEF\u63A8\u6D41\u65F6\u518D\u8FDB\u884C\u8BA2\u9605\u3002`:t=`\u4E2D\u65AD\u63A5\u53E3\u8C03\u7528, \u539F\u56E0: ${r.message}\u3002`,t},SEI_BEFORE_PUBLISH:"\u5F53\u524D client \u6CA1\u6709\u63A8 localStream(\u4E3B\u6D41\uFF0C\u975E\u5C4F\u5E55\u5206\u4EAB\u6D41)\uFF0C\u65E0\u6CD5\u8C03\u7528 client.sendSEIMessage() \u63A5\u53E3\u3002"},zu={INVALID_USER_DEFINE_RECORDID:"TRTC.html#createClient",INVALID_PROXY:"Client.html#setProxyServer",INVALID_JOIN:"Client.html#join",INVALID_ROOMID_STRING:"Client.html#join",INVALID_ROOMID_INTEGER:"Client.html#join",INVALID_PUBLISH:"Client.html#publish",INVALID_UNPUBLISH:"Client.html#unpublish",INVALID_AUDIENCE:"Client.html#switchRole",INVALID_INITIALIZE:"Client.html#publish",INVALID_DUPLICATE_PUBLISHING:"Client.html#publish",INVALID_SUBSCRIBE_UNDEFINED:"Client.html#subscribe",INVALID_SUBSCRIBE_LOCAL:"Client.html#subscribe",INVALID_REMOTE_STREAM:"Client.html#subscribe",INVALID_ROLE:"Client.html#switchRole",INVALID_PARAMETER_SWITCH_ROLE:"Client.html#switchRole",INVALID_OPERATION_SWITCH_ROLE:"Client.html#switchRole",CLIENT_BANNED:"module-ClientEvent.html#.CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"Client.html#startPublishCDNStream",INVALID_OPERATION_STOP_PUBLISH_CDN:"Client.html#stopPublishCDNStream",START_MIX_TRANSCODE:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE:"Client.html#stopMixTranscode",INVALID_AUDIO_VOLUME:"Client.html#enableAudioVolumeEvaluation",ENABLE_SMALL_STREAM_PUBLISHED:"Client.html#enableSmallStream",DISABLE_SMALL_STREAM_PUBLISHED:"Client.html#disableSmallStream",NOT_SUPPORTED_SMALL_STREAM:"tutorial-27-advanced-small-stream.html#h2-4",INVALID_SMALL_STREAM_PROFILE:"Client.html#setSmallStreamProfile",REMOTE_NOT_PUBLISH_SMALL_STREAM:"Client.html#setRemoteVideoStreamType",INVALID_SWITCH_DEVICE:"LocalStream.html#switchDevice",INVALID_SWITCH_DEVICE_PUBLISHING:"LocalStream.html#switchDevice",INVALID_REPLACE_TRACK:"LocalStream.html#replaceTrack",INVALID_INITIALIZE_LOCAL_STREAM:"LocalStream.html#replaceTrack",INVALID_ADD_TRACK_REPETITIVE:"LocalStream.html#addTrack",INVALID_ADD_TRACK_REMOVING:"LocalStream.html#addTrack",INVALID_ADD_TRACK_PUBLISHING:"LocalStream.html#addTrack",INVALID_STREAM_INITIALIZED:"LocalStream.html#addTrack",INVALID_ADD_TRACK_NUMBER:"LocalStream.html#addTrack",INVALID_REMOVE_AUDIO_TRACK:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ADDING:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ON:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NUMBER:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHED:"LocalStream.html#removeTrack",START_MIX_TRANSCODE_TIMEOUT:"Client.html#startMixTranscode",START_MIX_TRANSCODE_FAILED:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE_FAILED:"Client.html#stopMixTranscode",MIX_TRANSCODE_NOT_STARTED:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_FRAMERATE:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_GOP:"Client.html#startMixTranscode",MIX_PARAMS_AUDIO_BITRATE:"Client.html#startMixTranscode",MIX_PARAMS_USER_Z_ORDER:"Client.html#startMixTranscode",MIX_PARAMS_NOT_SELF:"Client.html#startMixTranscode",MIX_PARAMS_USER_STREAM:"Client.html#startMixTranscode",INVALID_PLAY:"Stream.html#play",PLAY_FAILED:"Stream.html#play",INVALID_USERID:"TRTC.html#createClient",INVALID_CREATE_STREAM_SOURCE:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN:"TRTC.html#createStream",INVALID_CREATE_STREAM_AUDIO:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN_AUDIO:"TRTC.html#createStream",NOT_SUPPORTED_HTTP:"tutorial-05-info-browser.html#h2-2",NOT_SUPPORTED_WEBRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_TRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_PROFILE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_MEDIA:"tutorial-05-info-browser.html",NOT_SUPPORTED_H264ENCODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_H264DECODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_TRACK:"LocalStream.html#addTrack",NOT_SUPPORTED_REPLACE_TRACK:"LocalStream.html#replaceTrack",NOT_SUPPORTED_CAPTURE:"tutorial-05-info-browser.html",MICROPHONE_NOT_FOUND:"TRTC.html#createStream",CAMERA_NOT_FOUND:"TRTC.html#createStream",SUBSCRIBE_FAILED:"Client.html#subscribe",API_CALL_ABORTED(r){let t;return r.message.includes("REMOTE_STREAM_NOT_EXIST")?t="Client.html#subscribe":t="module-ErrorCode.html#.API_CALL_ABORTED",t}};typeof window!="undefined"&&(window.TRTC_ERROR_INFO=qu,window.TRTC_ERROR_LINK=zu);var Bc=(r,t)=>t?`${ze}/${r}/${t}`:`${ze}/${r}/index.html`;var Zu=()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};let r=localStorage.getItem(nn);if(r){r=JSON.parse(r);let t=document.createElement("script");t.type="text/javascript",t.text=r.message,document.body.appendChild(t);let e=window.TRTC_ERROR_INFO,i=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:e,TRTC_ERROR_LINK:i}}return{}};function b(r){let{key:t,data:e,link:i,addDocLink:s=!0}=r,o="",n="",a="";j(le[t])?o=le[t](e):X(le[t])&&(o=le[t]);let{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:l}=Zu();i?a=`${i.className}.html#${i.fnName}`:l&&l[t]&&(j(l[t])?a=l[t](e):X(l[t])&&(a=l[t]));let u=o;return tt()&&(c&&c[t]&&(j(c[t])?n=c[t](e):X(c[t])&&(n=c[t])),n&&(s?u=`${n}
\u8BF7\u67E5\u770B\u6587\u6863: ${Bc("zh-cn",a)}

`:u=`${n}

`,u+=o)),s&&(u+=` 
Refer to: ${Bc("en",a)}
`),u}var q={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isWebCodecsSupported:!1,isMediaDevicesSupported:!1,isScreenShareSupported:!1,isSmallStreamSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}},eh=new Map([[Y,["Firefox",Cs]],[ki,["Edg",ys]],[Vi,["Chrome",$s]],[ke,["Safari",$i]],[Qe,["TBS",bs]],[Sr,["XWEB",vs]],[wi&&Pt,["WeChat",Ls]],[gr,["QQ(Win)",Ps]],[Ui,["QQ(Mobile)",Li]],[xi,["QQ(Mobile X5)",Li]],[Ar,["QQ(Mac)",Ms]],[Rr,["QQ(iPad)",ks]],[Nr,["MI",ws]],[yr,["HW",xs]],[Or,["Samsung",Us]],[Dr,["OPPO",Vs]],[br,["VIVO",Bs]],[Mi,["EDGE",Ns]],[Tr,["SogouMobile",Os]],[Ir,["Sogou",Ds]]]);function th(){let r=eh.get(!0),t=r?r[0]:"unknown",e=r?r[1]:"unknown";return{browserName:t,browserVersion:e}}var Cn=function(){return!(Xo||Mi||ki&&Yo<80||Y&&jo<56)},Hc=function(){return["VideoDecoder","VideoEncoder","AudioEncoder","AudioDecoder","MediaStreamTrackGenerator"].every(t=>t in window)},io=function(){if(!navigator.mediaDevices)return Ft()||g.error(le.NOT_SUPPORTED_MEDIA),!1;let r=["getUserMedia","enumerateDevices"];return r.filter(t=>t in navigator.mediaDevices).length===r.length},$c=!1;function Ft(){return location.protocol==="http:"&&!He?($c||g.error(b({key:C.NOT_SUPPORTED_HTTP})),$c=!0,!0):!1}var Nn=function(){return(window==null?void 0:window.OffscreenCanvas)&&(window==null?void 0:window.MediaStreamTrackProcessor)&&(window==null?void 0:window.MediaStreamTrackGenerator)},Fc=function(){return _(this,null,function*(){if(q.detail.isH264EncodeSupported||q.detail.isVp8EncodeSupported)return{isH264EncodeSupported:q.detail.isH264EncodeSupported,isVp8EncodeSupported:q.detail.isVp8EncodeSupported};let r,t=!1,e=!1;try{let i=new RTCPeerConnection,s=document.createElement(h.CANVAS);s.getContext("2d");let o=s.captureStream(0);return i.addTrack(o.getVideoTracks()[0],o),r=yield i.createOffer(),r.sdp.toLowerCase().indexOf("h264")!==-1&&(t=!0),r.sdp.toLowerCase().indexOf("vp8")!==-1&&(e=!0),i.close(),q.detail.isH264EncodeSupported=t,q.detail.isVp8EncodeSupported=e,{isH264EncodeSupported:q.detail.isH264EncodeSupported,isVp8EncodeSupported:q.detail.isVp8EncodeSupported}}catch(i){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}})},ro=function(){return _(this,null,function*(){if(q.detail.isH264DecodeSupported&&q.detail.isVp8DecodeSupported)return{isH264DecodeSupported:q.detail.isH264DecodeSupported,isVp8DecodeSupported:q.detail.isVp8DecodeSupported};let r,t=!1,e=!1;try{let i=new RTCPeerConnection;return r=yield i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),r.sdp.toLowerCase().indexOf("h264")!==-1&&(t=!0),r.sdp.toLowerCase().indexOf("vp8")!==-1&&(e=!0),i.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:e}}catch(i){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}})},yn=function(){return _(this,null,function*(){if(q.result)return q;let r=Cn(),t=Dn(),e=Hc(),i=io(),{isH264EncodeSupported:s,isVp8EncodeSupported:o}=yield Fc(),{isH264DecodeSupported:n,isVp8DecodeSupported:a}=yield ro();return q.result=r&&t&&i&&(s||o)&&(n||a),q.detail.isBrowserSupported=r,q.detail.isWebRTCSupported=t,q.detail.isWebCodecsSupported=e,q.detail.isMediaDevicesSupported=i,q.detail.isScreenShareSupported=Wr(),q.detail.isSmallStreamSupported=so(),q.detail.isH264EncodeSupported=s,q.detail.isVp8EncodeSupported=o,q.detail.isH264DecodeSupported=n,q.detail.isVp8DecodeSupported=a,q.result||g.error(`${navigator.userAgent} ${Sn(q.detail,!1)}`),q})},ih=function(){return q.result},Wr=function(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)},rh=(r,t,e)=>{location.protocol==="http:"&&!He&&(r[t]=()=>{throw new A({code:I.INVALID_OPERATION,message:le.NOT_SUPPORTED_HTTP})})},Gt=function(r){return r.type==="candidate-pair"&&r.nominated&&(r.state==="in-progress"||r.state==="succeeded")?!(te(r.selected)&&!r.selected):!1};function Gc(){let r="";if(screen.width){let t=screen.width?screen.width*window.devicePixelRatio:"",e=screen.height?screen.height*window.devicePixelRatio:"";r+=`${t} * ${e}`}return r}function Wc(){return navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function Kc(){let r={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let e=0;e<t.length;e++)if(t[e]in window){r.isSupported=!0;break}return r.isSupported}function Jc(){return"captureStream"in HTMLCanvasElement.prototype}function so(){return wi||$e||Bi&&Bi<63?!1:!!(Cn()&&Jc())}var sh=function(){if(T(window.RTCRtpTransceiver)||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let r=null,t=!1;try{r=new RTCPeerConnection({sdpSemantics:xt}),r.addTransceiver(h.AUDIO),t=!0}catch(e){}return r==null||r.close(),t};function mi(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function zi(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function ot(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function We(){return zo===11?!1:"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype}var Kr=We();function oh(){return"RTCRtpTransceiver"in window&&"stop"in window.RTCRtpTransceiver.prototype}function nh(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}function Jr(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&zi()}var Ke=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,On=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype,Wt="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&qe()>=86,Dn=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter(t=>t in window).length>0};function jc(){let r={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return T(window.AudioDecoder)||(r.AudioDecoder=!0),T(window.AudioEncoder)||(r.AudioEncoder=!0),T(window.VideoDecoder)||(r.VideoDecoder=!0),T(window.VideoEncoder)||(r.VideoEncoder=!0),T(window.ImageDecoder)||(r.ImageDecoder=!0),r}function Yc(){return"mediaSession"in navigator&&!T(navigator.mediaSession.setActionHandler)}function Xc(){return!T(window.WebTransport)}function ah(){let r={browser:`${Xe.name}/${Xe.version}`,os:Hs(),displayResolution:Gc(),isScreenShareSupported:Wr(),isWebRTCSupported:Dn(),isGetUserMediaSupported:Wc(),isWebAudioSupported:Kc(),isWebSocketsSupported:"WebSocket"in window&&window.WebSocket.CLOSING===2,isWebCodecSupported:jc(),isMediaSessionSupported:Yc(),isWebTransportSupported:Xc()};return navigator.userAgent.includes("miniProgram")&&(r.browser=`mini/${r.browser}`),r}var qc=Ne(Me(),1);var Qc=Symbol("instance"),$_=Symbol("abortCtrl"),bn=Symbol("cacheResult"),jr=class{constructor(t,e,i){this.oldState=t,this.newState=e,this.action=i,this.aborted=!1}abort(t){this.aborted=!0,Qr.call(t,this.oldState,new Error(`action '${this.action}' aborted`))}toString(){return`${this.action}ing`}},Yr=class extends Error{constructor(t,e,i){super(e),this.state=t,this.message=e,this.cause=i}};function ch(r){return typeof r=="object"&&r&&"then"in r}var Xr=new Map;function me(r,t,e={}){return(i,s,o)=>{let n=e.action||s;if(!e.context){let c=Xr.get(i)||[];Xr.has(i)||Xr.set(i,c),c.push({from:r,to:t,action:n})}let a=o.value;o.value=function(...c){let l=this;if(e.context&&(l=F.get(typeof e.context=="function"?e.context.call(this,...c):e.context)),l.state===t)return l[bn];l.state instanceof jr&&l.state.action==e.abortAction&&l.state.abort(l);let u=null;if(Array.isArray(r)?r.length==0?l.state instanceof jr&&l.state.abort(l):(typeof l.state!="string"||!r.includes(l.state))&&(u=new Yr(l._state,`${l.name} ${n} to ${t} failed: current state ${l._state} not in from config`)):r!==l.state&&(u=new Yr(l._state,`${l.name} ${n} to ${t} failed: current state ${l._state} not from ${r}`)),u)if(e.fail)e.fail.call(this,u);else{if(e.ignoreError)return u;throw u}let m=l.state,f=new jr(m,t,n);Qr.call(l,f);let O=w=>{var oe;return l[bn]=w,f.aborted||(Qr.call(l,t),(oe=e.success)===null||oe===void 0||oe.call(this,l[bn])),w},N=w=>{let oe=w instanceof Error?w.message:String(w);if(Qr.call(l,m,w),e.fail)e.fail.call(this,new Yr(l._state,`action '${n}' failed :${oe}`,w instanceof Error?w:new Error(oe)));else{if(e.ignoreError)return w;throw w}};try{let w=a.apply(this,c);return ch(w)?w.then(O).catch(N):O(w)}catch(w){N(w)}}}}var dh=(()=>typeof window!="undefined"&&window.__AFSM__?(e,i)=>{window.dispatchEvent(new CustomEvent(e,{detail:i}))}:typeof importScripts!="undefined"?(e,i)=>{postMessage({type:e,payload:i})}:()=>{})();function Qr(r,t){let e=this._state;this._state=r;let i=r.toString();r&&this.emit(i,e),this.emit(F.STATECHANGED,r,e,t),this.updateDevTools({value:r,old:e,err:t instanceof Error?t.message:String(t)})}var F=class extends qc.default{constructor(t,e,i){super(),this.name=t,this.groupName=e,this._state=F.INIT,t||(t=Date.now().toString(36)),i?Object.setPrototypeOf(this,i):i=Object.getPrototypeOf(this),e||(this.groupName=this.constructor.name);let s=i[Qc];s?this.name=s.name+"-"+s.count++:i[Qc]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram})}get stateDiagram(){let t=Object.getPrototypeOf(this),e=Xr.get(t)||[],i=new Set,s=[],o=[],n=new Set,a=Object.getPrototypeOf(t);Xr.has(a)&&(a.stateDiagram.forEach(l=>i.add(l)),a.allStates.forEach(l=>n.add(l))),e.forEach(({from:l,to:u,action:m})=>{typeof l=="string"?s.push({from:l,to:u,action:m}):l.length?l.forEach(f=>{s.push({from:f,to:u,action:m})}):o.push({to:u,action:m})}),s.forEach(({from:l,to:u,action:m})=>{n.add(l),n.add(u),n.add(m+"ing"),i.add(`${l} --> ${m}ing : ${m}`),i.add(`${m}ing --> ${u} : ${m} \u{1F7E2}`),i.add(`${m}ing --> ${l} : ${m} \u{1F534}`)}),o.forEach(({to:l,action:u})=>{i.add(`${u}ing --> ${l} : ${u} \u{1F7E2}`),n.forEach(m=>{m!==l&&i.add(`${m} --> ${u}ing : ${u}`)})});let c=[...i];return Object.defineProperties(t,{stateDiagram:{value:c},allStates:{value:n}}),c}static get(t){let e;return typeof t=="string"?(e=F.instances.get(t),e||F.instances.set(t,e=new F(t,void 0,Object.create(F.prototype)))):(e=F.instances2.get(t),e||F.instances2.set(t,e=new F(t.constructor.name,void 0,Object.create(F.prototype)))),e}static getState(t){var e;return(e=F.get(t))===null||e===void 0?void 0:e.state}updateDevTools(t={}){dh(F.UPDATEAFSM,Object.assign({name:this.name,group:this.groupName},t))}get state(){return this._state}set state(t){Qr.call(this,t)}};F.STATECHANGED="stateChanged";F.UPDATEAFSM="updateAFSM";F.INIT="[*]";F.ON="on";F.OFF="off";F.instances=new Map;F.instances2=new WeakMap;var zc=(window==null?void 0:window.requestIdleCallback)||function(r){let t=Date.now();return setTimeout(()=>{r({didTimeout:!1,timeRemaining(){return Math.max(0,50-(Date.now()-t))}})},1e3)},lh=(window==null?void 0:window.cancelIdleCallback)||function(r){clearTimeout(r)},uh=(window==null?void 0:window.cancelAnimationFrame)||(window==null?void 0:window.mozCancelAnimationFrame),qr=class{static generateTaskID(){return this.currentTaskID++}static run(t=Yi,e,i){t===En?i=R({delay:2e3,count:0,backgroundTask:!0},i):t===et?i=R({delay:1e4,count:0},i):t===Et?i=R({fps:60,delay:16.6,count:0,backgroundTask:!0},i):i=R({delay:2e3,count:0,backgroundTask:!0},i),hi(e)&&(i=R(R({},i),e)),j(t)&&(e=t,t=Yi);let s=R({taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:t,callback:e},i);return this.taskMap.set(s.taskID,s),this[t](s),s.taskID}static interval(t){let e=()=>{t.callback(),t.loopCount+=1,this.isBreakLoop(t)};return t.intervalID=setInterval(e,t.delay)}static timeout(t){let e=()=>{if(t.callback(),t.loopCount+=1,!this.isBreakLoop(t))return t.timeoutID=setTimeout(e,t.delay)};return t.timeoutID=setTimeout(e,t.delay)}static ric(t){let e=V(),i,s=()=>{if(i=V()-e,i>=t.delay&&(e=V()-Math.floor(i%t.delay),t.callback(),t.loopCount+=1),!this.isBreakLoop(t))return t.ricID=zc(s,{timeout:t.delay})};return t.ricID=zc(s,{timeout:t.delay})}static raf(t){t.delay=(1e3/t.fps).toFixed(2);let e=V(),i,s=()=>{if(document.hidden&&t.backgroundTask)return i=V()-e,e=V(),t.callback(),t.loopCount+=1,this.isBreakLoop(t)?void 0:t.timeoutID=setTimeout(s,t.delay-Math.floor(i%t.delay));if(i=V()-e,i>=t.delay&&(e=V()-Math.floor(i%t.delay),t.callback(),t.loopCount+=1),!this.isBreakLoop(t))return t.rafID=requestAnimationFrame(s)};if(t.rafID=requestAnimationFrame(s),t.backgroundTask){let o=()=>{if(document.hidden){let n=V()-e;n>=t.delay?s():t.timeoutID=setTimeout(s,t.delay-n)}};document.addEventListener("visibilitychange",o),t.onVisibilitychange=o,document.hidden&&o()}return t.taskID}static hasTask(t){return this.taskMap.has(t)}static clearTask(t){if(!this.taskMap.has(t))return!0;let{intervalID:e,timeoutID:i,rafID:s,ricID:o,onVisibilitychange:n}=this.taskMap.get(t);return e&&clearInterval(e),i&&clearTimeout(i),s&&uh(s),o&&lh(o),n&&document.removeEventListener("visibilitychange",n),this.taskMap.delete(t),!0}static isBreakLoop(t){return this.taskMap.has(t.taskID)?t.count!==0&&t.loopCount>=t.count?(this.clearTask(t.taskID),!0):!1:!0}};qr.taskMap=new Map,qr.currentTaskID=1;var ee=qr;var Zc={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_PUBLISHED:"stream-published",STREAM_SUBSCRIBED:"stream-subscribed",STREAM_UNSUBSCRIBED:"stream-unsubscribed",STATE_CHANGED:"state-changed",ERROR:"error",CONNECTION_STATE_CHANGED:"connection-state-changed",SEI_MESSAGE:h.SEI_MESSAGE},Y_={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_SUBSCRIBED:"stream-subscribed",CONNECTION_STATE_CHANGED:"connection-state-changed",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",MUTE_AUDIO:"mute-audio",MUTE_VIDEO:"mute-video",UNMUTE_AUDIO:"unmute-audio",UNMUTE_VIDEO:"unmute-video",CLIENT_BANNED:"client-banned",NETWORK_QUALITY:"network-quality",AUDIO_VOLUME:"audio-volume",SEI_MESSAGE:h.SEI_MESSAGE,ERROR:"error"};var nt={LOADED_DATA:h.LOADEDDATA,MEDIA_TRACK_CHANGED:"media-track-changed",PLAYER_STATE_CHANGED:"player-state-changed"};var vn=class{constructor(){this._roomIdMap=new Map;typeof registerProcessor=="undefined"&&(this._configs={sdkAppId:"",userId:"",version:Ie,env:mt.QCLOUD,browserVersion:Xe.name+Xe.version,ua:navigator.userAgent})}setConfig({sdkAppId:t,env:e,userId:i,roomId:s}){t!==this._configs.sdkAppId&&(this._configs.sdkAppId=String(t)),this._configs.env=e,this._configs.userId=i,this._roomIdMap.set(i,String(s))}logSuccessEvent(t){He||!g.isAbleToUpload||this._configs.env===mt.QCLOUD&&this.uploadEventToKibana(k(R({},t),{result:"success"}))}logFailedEvent(t){if(He||!g.isAbleToUpload)return;let{eventType:e,code:i,error:s,userId:o}=t,n={roomId:this._roomIdMap.get(o||this._configs.userId),userId:o,eventType:e,result:"failed",code:i||(s==null?void 0:s.extraCode)||(s==null?void 0:s.code)||I.UNKNOWN};this._configs.env===mt.QCLOUD&&this.uploadEventToKibana(k(R({},n),{error:s}))}uploadEventToKibana(t){let e=`stat-${t.eventType}-${t.result}`;(t.eventType==="delta-join"||t.eventType==="delta-leave"||t.eventType==="delta-publish")&&(e=`${t.eventType}:${t.delta}`),this.uploadEvent({log:e,userId:t.userId}),t.result==="failed"&&(e=`stat-${t.eventType}-${t.result}-${t.code}`,this.uploadEvent({log:e,userId:t.userId,error:t.error}))}uploadEvent({log:t,userId:e,error:i}){let s={timestamp:Rs(),sdkAppId:this._configs.sdkAppId,userId:e||this._configs.userId,version:Ie,log:t};i&&(s.errorInfo=i.message),this.sendRequest(ui(this._configs.sdkAppId,ci.LOG),s)}sendRequest(t,e){if(!g.isAbleToUpload){setTimeout(()=>{this.sendRequest(t,e)},1e3);return}Ht({url:t,body:JSON.stringify(e)}).catch(()=>{})}},z=new vn;var It="trtc_autoplay",Ln=`${It}_mask`,Zi=`${It}_wrapper`,ed=`${It}_header`,Pn=`${It}_content`,oo=`${It}_action_wrapper`,Mn=`${It}_question`,kn=`${It}_collapse`,no=`${It}_action_confirm`,td=`${It}_detail`,id="#2473E8",xn="dialog",hh=`${xn}-show`,mh=`${xn}-1`,_h=`${xn}-2`,rd=!1,Un=()=>!!document.querySelector(`.${Zi}`),od=`${ze}/${tt()?"zh-cn":"en"}/tutorial-21-advanced-auto-play-policy.html`,sd=`<br><a href='${od}' target='_blank'>${tt()?"\u5176\u4ED6\u65B9\u6848\uFF1F":"Any other solution?"}</a>`,ph=`${tt()?`\u6D4F\u89C8\u5668\u81EA\u52A8\u64AD\u653E\u7B56\u7565\uFF1A\u5728\u7528\u6237\u4E0E\u9875\u9762\u4EA7\u751F\u4EA4\u4E92\uFF08\u70B9\u51FB\u3001\u89E6\u6478\uFF09\u4E4B\u524D\uFF0C\u6D4F\u89C8\u5668\u7981\u6B62\u64AD\u653E\u6709\u58F0\u5A92\u4F53\u3002\u8BE5\u5F39\u7A97\u7528\u4E8E\u5E2E\u52A9\u7528\u6237\u6062\u590D\u97F3\u89C6\u9891\u64AD\u653E\u3002${sd}`:`Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ${sd}`}`,wn=class{constructor(){d(this,"content","\u97F3\u89C6\u9891\u64AD\u653E\u88AB\u6D4F\u89C8\u5668\u62E6\u622A\uFF0C\u8BF7\u70B9\u51FB\u201C\u6062\u590D\u64AD\u653E\u201D\u3002");d(this,"_dialogNode",null);d(this,"_bodyPosition","");d(this,"_showDetail",!1);d(this,"_isCollapseClicked",!1);d(this,"_isQuestionClicked",!1);if(tt()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!rd){let t=document.createElement("style");t.innerHTML=`.${Ln}{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.${Ln} div:not(.${oo}){display:block !important;}.${Zi}{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.${Zi} a{color:${id};}.${ed}{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.${Pn}{margin:8px 0;}.${oo}{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.${kn}{margin-right:auto;cursor:pointer}.${Mn}{height:100%;line-height:16px;cursor:pointer;}.${no}{margin-left:8px;color:#fff;background:${id};padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.${no}:hover{opacity:0.9;}.${kn},.${no},.${Pn},.${Mn}{font-size:14px;}@media screen and (max-width:750px){.${Zi}{width:80vw;}}`,document.head.appendChild(t),rd=!0}this.addDiaLog()}createDiaLog(){let t=document.createElement("template");t.innerHTML=`<div class="${Ln}"><div class='${Zi}'><div class='${ed}'>${location.host}</div><div class='${Pn}'>${this.content}</div><div class='${td}' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">${ph}</div><div class='${oo}'></div></div></div>`.trim();let e=document.createElement("button");e.className=no,e.innerText=tt()?"\u6062\u590D\u64AD\u653E":"Resume",e.onclick=this.onConfirm.bind(this);let i=document.createElement("div");i.className=Mn,i.innerHTML=`<?xml version="1.0" encoding="UTF-8"?>
    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>
    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>
    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>
    </svg>
    `,i.onclick=this.onQuestionClick.bind(this);let s=document.createElement("div");s.className=kn,s.innerText=`${tt()?"\u8BE6\u60C5 >":"Detail >"}`,s.onclick=this.onCollapseClick.bind(this);let o=t.content.firstChild,n=o.querySelector(`.${oo}`);return n.appendChild(s),n.appendChild(i),n.appendChild(e),o}addDiaLog(){Un()||(this._dialogNode=this.createDiaLog(),document.body.appendChild(this._dialogNode),this._dialogNode.onclick=this.onConfirm.bind(this),this._dialogNode.querySelector(`.${Zi}`).onclick=t=>t.stopPropagation(),this._bodyPosition=document.body.style.position,document.body.style.position="fixed",g.info("show autoplay dialog"),z.uploadEvent({log:hh}))}deleteDiaLog(){this._dialogNode&&(document.body.removeChild(this._dialogNode),document.body.style.position=this._bodyPosition,this._dialogNode=null)}onConfirm(){g.warn("confirm clicked, try resume stream"),E.emit(p.AUTOPLAY_DIALOG_CLICK_CONFIRM),this.deleteDiaLog()}onCollapseClick(){let t=this._dialogNode.querySelector(`.${td}`);t.style.visibility=`${this._showDetail?"hidden":"visible"}`,t.style.height=`${this._showDetail?0:"fit-content"}`,this._showDetail=!this._showDetail,this._isCollapseClicked||z.uploadEvent({log:mh}),this._isCollapseClicked=!0}onQuestionClick(){window.open(od,"_blank"),this._isQuestionClicked||z.uploadEvent({log:_h}),this._isQuestionClicked=!0}},nd=wn;var _i={};pr(_i,{create:()=>xe,remove:()=>_e});var zr=new WeakMap;function xe(r,t){zr.has(r)||zr.set(r,[]);let e=zr.get(r),s={add:(o,n)=>("addEventListener"in t?(e.push(t.removeEventListener.bind(t,o,n)),t.addEventListener(o,n)):(e.push(t.off.bind(t,o,n)),t.on(o,n)),s)};return s}function _e(r){let t=zr.get(r);t&&(t.forEach(e=>e()),zr.delete(r))}var St=class extends F{constructor(e,i){super(e.id,`${i}-player`);this.kind=i;d(this,"id");d(this,"element",null);d(this,"container",null);d(this,"mediaStream",new MediaStream);d(this,"track");d(this,"url");d(this,"attr");d(this,"muted");d(this,"_log");d(this,"_pausedRetryCount");d(this,"_isElementPlayingFired",!1);d(this,"_interval");this.id=e.id,this._log=e.log,this.track=e.track,this.container=e.container,this.muted=e.muted,this._pausedRetryCount=_n,this._state="STOPPED",this.bindTrackEvents()}get isPlaying(){return this._state==="PLAYING"}get isStopped(){return this._state==="STOPPED"}setAttr(e){this.attr=e}setTrack(e){if(e!==this.track&&(this.unbindTrackEvents(),this.track=e,this.emit(nt.MEDIA_TRACK_CHANGED,e),e!==null&&(this.bindTrackEvents(),this.element))){let i=new MediaStream;i.addTrack(e),this.element.srcObject=i}}setUrl(e){this.track&&(this.unbindTrackEvents(),this.element&&(this.element.srcObject=null),this.track=null),e!==this.url&&(this.url=e,e!==null&&this.element&&(this.element.crossOrigin="anonymous",this.element.src=e))}setContainer(e){this.container=e,this.track&&this.element&&this.container&&this.container.appendChild(this.element)}play(){return _(this,null,function*(){if(this.element&&this.element.parentElement!==this.container&&this.container&&this.container.append(this.element),!this.isPlaying)try{this.bindAutoPlayEvent(),yield this.element.play()}catch(e){let i=b({key:C.PLAY_FAILED,data:{media:this.kind,error:e}});if(this.track&&!this.track.muted&&this._log.warn(e),i.includes("NotAllowedError"))throw new A({code:I.PLAY_NOT_ALLOWED,message:i})}})}stop(){this.unbindEvents(),this._isElementPlayingFired=!1,this.element&&(this.container&&this.container.removeChild(this.element),this.element.srcObject=null,this.element=null),this.handleStopped(h.ENDED),this._interval>0&&ee.clearTask(this._interval)}pause(){var e;this.isPlaying&&((e=this.element)==null||e.pause())}resume(){return this.isPlaying?Promise.resolve():si?this.replay():this.play().catch(()=>{})}setMuted(e){this.element&&(this.element.muted=e),this.muted=e}setRect(e,i){this.element&&(this.element.style.width=`${e}px`,this.element.style.height=`${i}px`)}replay(){return this.stop(),this.play().catch(()=>{})}bindElementEvents(){if(this.element){let e=this.handleElementEvent.bind(this);xe(this.element,this.element).add(h.PLAYING,e).add(h.ENDED,e).add(h.PAUSE,e).add(h.ERROR,e).add(h.LOADEDDATA,e)}}bindTrackEvents(){if(this.track){let e=this.handleTrackEvent.bind(this);_i==null||_i.create(this.track,this.track).add(h.ENDED,e).add(h.MUTE,e).add(h.UNMUTE,e),this.track.readyState===h.ENDED&&this.handleTrackEvent({type:h.ENDED}),this.track.muted&&this.handleTrackEvent({type:h.MUTE})}}bindAutoPlayEvent(){E.on(p.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}unbindTrackEvents(){this.track&&_e(this.track)}unbindEvents(){this.element&&_e(this.element),this.unbindTrackEvents(),E.off(p.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}handleElementEvent(e){var s;switch(e.type){case h.PLAYING:this._isElementPlayingFired=!0,this._log.info(`${this.kind} player is playing`),this.handlePlaying(h.PLAYING),this._interval&&(ee.clearTask(this._interval),this._interval=-1);break;case h.ENDED:this._log.info(`${this.kind} player is ended`),this.handleStopped(h.ENDED);break;case h.PAUSE:this._log.info(`${this.kind} player is paused`),this.handlePaused(h.PAUSE);let o=this.container&&document.getElementById(this.container.id);o||this._log.warn(`${this.kind} player has been remove, element ID: ${(s=this.container)==null?void 0:s.id}`);let n=qe();this._pausedRetryCount>0&&(this.kind===h.VIDEO&&!Un()||this.kind===h.AUDIO&&(Q(n)&&n<=70||!o))&&(this._log.info(`${this.kind} player auto resume when paused`),this.resume(),this._pausedRetryCount--),$e&&(this._interval=ee.run(Yi,()=>{this.element&&this._state==="PAUSED"&&this.resume()},{delay:3e3}));break;case h.ERROR:if(this.element&&this.element.error){let{code:a,message:c}=this.element.error;this._log.error(`${this.kind} player error observed. code: ${a} message: ${c} userAgent: ${navigator.userAgent}`),z.uploadEvent({log:`stat-${this.kind}-${Ze.PLAYER_ERROR}-${a}-${navigator.userAgent}`,error:this.element.error})}break;case h.LOADEDDATA:this.kind===h.VIDEO&&this.emit(nt.LOADED_DATA);break}}handleTrackEvent(e){switch(e.type){case h.ENDED:this._log.info(`${this.kind} track is ended`),this.handleStopped(h.ENDED);break;case h.MUTE:this._log.info(`${this.kind} track is unable to provide media output`),this.handlePaused(h.MUTE);break;case h.UNMUTE:this._log.info(`${this.kind} track is able to provide media output`),this._isElementPlayingFired&&this.handlePlaying(h.UNMUTE);break}}handlePlaying(e){this.emit(nt.PLAYER_STATE_CHANGED,{type:this.kind,state:"PLAYING",reason:e})}handlePaused(e){this.emit(nt.PLAYER_STATE_CHANGED,{type:this.kind,state:"PAUSED",reason:e})}handleStopped(e){this.emit(nt.PLAYER_STATE_CHANGED,{type:this.kind,state:"STOPPED",reason:e})}getElement(){return this.element}};y([me([],"PLAYING")],St.prototype,"handlePlaying",1),y([me("PLAYING","PAUSED",{ignoreError:!0})],St.prototype,"handlePaused",1),y([me([],"STOPPED")],St.prototype,"handleStopped",1);var pi=class extends St{constructor(e){super(e,h.VIDEO);d(this,"mirror");d(this,"objectFit");T(e.mirror)||(this.mirror=e.mirror),T(e.objectFit)||(this.objectFit=e.objectFit)}initializeElement(){var s;let e=document.createElement(h.VIDEO);if(this.track){let o=new MediaStream;o.addTrack(this.track),e.srcObject=o}e.muted=!0;let i=`width: 100%; height: 100%; object-fit: ${this.objectFit};background-color: black;`;this.mirror&&(i+="transform: scaleX(-1);"),e.setAttribute("id",`video_${this.id}`),e.setAttribute("style",i),e.setAttribute("autoplay","autoplay"),e.setAttribute("playsinline","playsinline"),(s=this.container)==null||s.appendChild(e),this.element=e,this.bindElementEvents()}setAttr(e){let i=Object.assign({autoplay:"autoplay",playsinline:"playsinline",muted:!0},e);i.style=Object.assign({width:"100%",height:"100%"},i.style),super.setAttr(i)}setMirror(e){this.element&&(this.element.style.transform=e?"scaleX(-1)":""),this.mirror=e}setObjectFit(e){this.element&&(this.element.style.objectFit=`${e}`),this.objectFit=e}play(){return this.element||this.initializeElement(),super.play()}getVideoFrame(){if(!this.element)return"";let e=document.createElement("canvas");return e.width=this.element.videoWidth,e.height=this.element.videoHeight,e.getContext("2d").drawImage(this.element,0,0),e.toDataURL("image/png")}getElement(){return this.element}};var Eh="class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=rms;this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);",cd=!1,Vn=class{constructor(t){d(this,"context_");d(this,"blob_");this.context_=t.context,this.blob_=new Blob([Eh],{type:"application/javascript"}),this.addModuleToContext()}addModuleToContext(){return _(this,null,function*(){try{yield this.context_.audioWorklet.addModule(URL.createObjectURL(this.blob_)),g.info("worklet addModule success"),E.emit(p.WORKLET_LOADED_SUCCESS),cd=!0}catch(t){g.info(`worklet addModule catch error. ${t.message}`),E.emit(p.WORKLET_LOADED_FAILED)}})}get initWorkletSuccess(){return cd}},dd=Vn;typeof window!="undefined"&&(window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var ld=0,Kt=()=>{let r=new window.AudioContext;ld+=1;let t=()=>{r.state==="suspended"?(r.resume(),document.addEventListener("click",t)):r.state==="interrupted"?r.resume():document.removeEventListener("click",t)};document.addEventListener("click",t);let e=ld;return r.onstatechange=()=>{g.info(`audioContext[${e}] state: ${r.state}`),t()},r};var Je,ao,co=0,Bn=class{constructor(t){d(this,"_volume");d(this,"_log");d(this,"_track");d(this,"_stream");d(this,"_audioCtx");d(this,"_destination");d(this,"_streamSource");d(this,"_scriptProcessorNode");d(this,"_audioWorkletNode");d(this,"_interval");let{track:e,log:i}=t;this._volume=0,this._log=i,this._track=e,Je||(Je=Kt()),this._audioCtx=Je,this._destination=this._audioCtx.destination;let s=new MediaStream;s.addTrack(this._track),this._streamSource=this._audioCtx.createMediaStreamSource(s),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._interval=200,E.on(p.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),Tn?(E.on(p.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),E.on(p.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor(),co+=1}preload(){ao?ao.initWorkletSuccess&&this.initAudioWorklet():ao=new dd({context:Je})}initAudioWorklet(){if(!this._audioWorkletNode)try{this._audioWorkletNode=new AudioWorkletNode(this._audioCtx,"volume-meter"),this._audioWorkletNode.port.onmessage=t=>{this._volume=t.data.volume||0},this._streamSource.connect(this._audioWorkletNode).connect(this._destination),this.handleAudioLevelInterval({interval:this._interval})}catch(t){z.logFailedEvent({userId:this._log.userId,eventType:Ze.LOAD_WORKLET,error:t}),this.initScriptProcessor()}}initScriptProcessor(){if(!this._scriptProcessorNode)try{this._scriptProcessorNode=this._audioCtx.createScriptProcessor(2048,1,1),this._scriptProcessorNode.onaudioprocess=t=>{let e=t.inputBuffer.getChannelData(0),i=0;for(let s=0;s<e.length;++s)i+=e[s]*e[s];this._volume=Math.sqrt(i/e.length)||0},this._streamSource.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._destination)}catch(t){this._log.error(`volumeMeter init script processor error: ${t}`)}}destroy(){this._streamSource&&this._streamSource.disconnect(),this._scriptProcessorNode&&(this._scriptProcessorNode.onaudioprocess=null,this._scriptProcessorNode.disconnect()),this._audioWorkletNode&&(this._audioWorkletNode.port.postMessage({name:"stop"}),this._audioWorkletNode.port.onmessage=null,this._audioWorkletNode.disconnect()),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._audioCtx=null,E.off(p.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),E.off(p.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),E.off(p.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),co>0&&(co-=1),co===0&&(Je==null||Je.close(),Je=null,ao=null)}resume(){Je==null||Je.resume()}getInternalAudioLevel(){return this._volume}getCalculatedVolume(){return parseFloat(this._volume.toFixed(2))}handleAudioLevelInterval(t){var i;let{interval:e}=t;this._interval=e,(i=this._audioWorkletNode)==null||i.port.postMessage({name:"setIntervalTime",intervalTime:e})}},ud=Bn;var Jt=null,$n=0,Ei=class extends St{constructor(e){super(e,h.AUDIO);d(this,"_volumeMeter");d(this,"_gainedTrack",null);d(this,"_gainNode",null);d(this,"_destination",null);d(this,"_mediaStreamSource",null);d(this,"_sourceElement",null);d(this,"_outputDeviceId");d(this,"_volume",1);d(this,"_loop",!1);e.gainedTrack&&(this._gainedTrack=e.gainedTrack),this._outputDeviceId=e.outputDeviceId,this.track&&this.initVolumeMeter(this.track)}setTrack(e){this.track!==e&&(this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),e!==null&&this.initVolumeMeter(e)),super.setTrack(e)}initVolumeMeter(e){this._volumeMeter=new ud({track:this._gainedTrack||e,log:this._log})}initializeElement(){if((Mt==="15.2"||Mt==="15.3"||Mt==="15.4")&&this.muted){this._log.info("audioElement is muted.");return}let i=document.createElement(h.AUDIO);this.track&&(i.srcObject=new MediaStream([this._gainedTrack||this.track])),i.muted=this.muted,i.setAttribute("id",`audio_${this.id}`),i.setAttribute("autoplay","autoplay"),i.setAttribute("playsinline","playsinline"),this.element=i,this.bindElementEvents()}play(){return _(this,null,function*(){this.element||this.initializeElement(),this._outputDeviceId&&(yield this.setSinkId(this._outputDeviceId)),!this._volumeMeter&&this.track&&this.initVolumeMeter(this.track),this.setVolume(this._volume),yield ii(Ei.prototype,this,"play").call(this)})}stop(){this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),this.destroyGain(),super.stop()}resume(){return _(this,null,function*(){yield ii(Ei.prototype,this,"resume").call(this),this._volumeMeter&&this._volumeMeter.resume()})}setSinkId(e){return _(this,null,function*(){this._outputDeviceId!==e&&(this.element&&(yield this.element.setSinkId(e)),this._outputDeviceId=e)})}setVolume(e){this._volume=e,this._gainNode?this._gainNode.gain.value=e:e>1?this.createGain(e):this.element&&(this.element.volume=e)}createGain(e){Jt||(Jt=Kt()),this._log.info(`create gainNode ${e}`);let i=Jt.createMediaStreamSource(new MediaStream([this.track])),s=Jt.createGain(),o=Jt.createMediaStreamDestination();i.connect(s),s.connect(o),s.gain.value=e,this._gainNode=s,this._destination=o,this._mediaStreamSource=i,this._gainedTrack=o.stream.getAudioTracks()[0],$n+=1,this.element&&(_e(this.element),this._sourceElement=this.element,this.element.muted=!0,this.element=null),this.play()}destroyGain(){var e,i,s;!this._gainNode||(this._log.info("destroy gainNode"),(e=this._gainNode)==null||e.disconnect(),(i=this._destination)==null||i.disconnect(),(s=this._mediaStreamSource)==null||s.disconnect(),this._gainNode=null,this._destination=null,this._mediaStreamSource=null,this._sourceElement&&(this._sourceElement.srcObject=null,this._sourceElement=null),this._gainedTrack=null,$n-=1,$n===0&&Jt&&(this._log.info("destroy gain audioContext"),Jt.close(),Jt=null))}setLoop(e){!this.element||(this.element.loop=e,this._loop=e)}getAudioLevel(){var e;return((e=this._volumeMeter)==null?void 0:e.getCalculatedVolume())||0}getInternalAudioLevel(){var e;return(e=this._volumeMeter)==null?void 0:e.getInternalAudioLevel()}};var fi=class extends F{constructor({userId:e,sdkAppId:i,mediaType:s,room:o,isInitPlayer:n=!0}){var a;super();d(this,"id",An());d(this,"userId");d(this,"isRemote");d(this,"mediaType");d(this,"room");d(this,"user");d(this,"_log");d(this,"isPlayCalled");d(this,"mediaTrack",null);d(this,"mediaStream");d(this,"container",null);d(this,"subVideoPlayerMap");d(this,"playerMuted",!1);d(this,"abortCtrl");d(this,"audioOutputDeviceId");d(this,"audioVolume");d(this,"objectFit","cover");d(this,"mirror",!1);d(this,"gain");d(this,"isScreen",!1);T(e)||(this.userId=e),this.mediaType=s,this._log=g.createLogger({id:`${this.kind[0]}t`,userId:(a=o||this.room)==null?void 0:a.userId,remoteUserId:this instanceof ge?void 0:this.userId,sdkAppId:i,type:this.mediaType===2?"auxiliary":"main",isLocal:this instanceof ge}),n&&this.initPlayer()}get log(){return this._log||g}get kind(){return this.mediaType===1?h.AUDIO:h.VIDEO}get muted(){return!!(this.mediaTrack&&!this.mediaTrack.enabled)}get strMediaType(){return this.mediaType===4?h.VIDEO:this.mediaType===2?h.SCREEN:h.AUDIO}uninstallEvents(){}play(e,i){return _(this,null,function*(){let s=he(e)?e[0]:e;if(this.isPlayCalled){this.log.info(`play update options: ${i}`),i&&!T(i.muted)&&this.setPlayerMute(i.muted),i&&!T(i.objectFit)&&(this.objectFit=i.objectFit),this.isScreen?this.mirror=!1:i&&!T(i.mirror)&&(this.mirror=i.mirror),this.kind===h.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror),this.container!==s&&s&&(this.container=s,this.player.setContainer(s)),he(e)&&e.length>=1&&(yield this.playSubContainer(e.slice(1),i)));return}if((!this.isRemote||this.kind===h.VIDEO)&&this.setPlayerMute(!0),i&&!T(i.muted)&&this.setPlayerMute(i.muted),i&&!T(i.objectFit)&&(this.objectFit=i.objectFit),this.isRemote||(this.mirror=!0),this.isScreen?this.mirror=!1:i&&!T(i.mirror)&&(this.mirror=i.mirror),this.kind===h.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror)),this.isPlayCalled=!0,s&&(this.container=s,this.player.setContainer(s)),E.emit(p.PLAY_TRACK_START,{track:this}),!this.mediaTrack){this.log.info("play has not mediaTrack, abort");return}this._log.info(`play with options: ${JSON.stringify(i)}`);try{yield this.player.play(),he(e)&&e.length>1&&(yield this.playSubContainer(e.slice(1),i))}catch(o){throw this.handleAutoPlayFailed(),this.emit("error",o),o}})}playSubContainer(e,i){return _(this,null,function*(){if(!this.mediaTrack||this.kind===h.AUDIO)return;this.subVideoPlayerMap||(this.subVideoPlayerMap=new Map),this.subVideoPlayerMap.forEach((o,n)=>{var a;e.find(c=>n===c)||(o.stop(),o.setContainer(null),(a=this.subVideoPlayerMap)==null||a.delete(n))});for(let[o,n]of e.entries()){let a=this.subVideoPlayerMap.get(n);a?i&&(T(i.mirror)||a.setMirror(i.mirror),T(i.objectFit)||a.setObjectFit(i.objectFit)):this.subVideoPlayerMap.set(n,new pi({id:this.userId||this.id,track:this.mediaTrack,container:n,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log.createChild({id:`vp-sub${o+1}`})}))}let s=[...this.subVideoPlayerMap.values()];for(let o of s)yield o.play()})}initPlayer(){var e;this.log.info(`create ${this.kind}Player`),this.kind===h.AUDIO?this.player=new Ei({id:this.userId||this.id,track:this.mediaTrack,gainedTrack:(e=this.gain)==null?void 0:e.audioTrack,container:this.container||null,muted:this.playerMuted,outputDeviceId:this.audioOutputDeviceId,log:this.log}):(this.player=new pi({id:this.userId||this.id,track:this.mediaTrack,container:this.container||null,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log}),this.player.on(nt.LOADED_DATA,()=>{E.emit(p.VIDEO_LOADED_DATA,{track:this})}),this.player.on(nt.MEDIA_TRACK_CHANGED,i=>{var s;(s=this.subVideoPlayerMap)==null||s.forEach(o=>o.setTrack(i))})),this.player.on(nt.PLAYER_STATE_CHANGED,i=>{E.emit(p.PLAYER_STATE_CHANGED,R({track:this},i)),this.emit("player-state-changed",i)})}setAudioOutput(e){return _(this,null,function*(){var i;this.audioOutputDeviceId=e,yield(i=this.player)==null?void 0:i.setSinkId(e)})}setAudioVolume(e){var i;this.audioVolume=e,this.log.info(`setAudioVolume to ${e}`),(i=this.player)==null||i.setVolume(e)}getAudioLevel(){var e;return((e=this.player)==null?void 0:e.getAudioLevel())||0}getInternalAudioLevel(){var e;return((e=this.player)==null?void 0:e.getInternalAudioLevel())||0}stop(){!this.isPlayCalled||(this.isPlayCalled=!1,this.player&&(this.log.info(`stop ${this.kind} player`),this.player.stop(),this.player.setContainer(null)),this.subVideoPlayerMap&&this.subVideoPlayerMap.size>0&&this.subVideoPlayerMap.forEach(e=>{e.stop(),e.setContainer(null)}),this.container=null)}resume(){return _(this,null,function*(){var e;!this.isPlayCalled||(yield(e=this.player)==null?void 0:e.resume())})}close(){var e;this.log.info("close"),this.isPlayCalled&&this.stop(),!this.isRemote&&((e=this.mediaTrack)==null||e.stop(),this.mediaTrack=null,this.uninstallEvents())}setMute(e){return this.mediaTrack?(this.mediaTrack.enabled=!e,this.emit(e?"mute":"unmute",this),E.emit(e?p.TRACK_MUTED:p.TRACK_UNMUTED,{track:this}),!0):!1}setPlayerMute(e){this.playerMuted=e,this.player.setMuted(e)}setMediaStream(e){e!==this.mediaStream&&(this.mediaStream=e)}setMediaStreamTrack(e){this.mediaStream||(this.mediaStream=new MediaStream),this.mediaTrack&&this.mediaStream.removeTrack(this.mediaTrack);let i=this.mediaTrack;this.mediaTrack=e,this.mediaTrack&&(this.mediaTrack.enabled=!this.muted,this.mediaStream.addTrack(this.mediaTrack),this.isRemote||this.player.setTrack(this.mediaTrack)),this.updatePlayingState(!!e),this.emit("media-track-changed",this.mediaTrack,i)}setMediaType(e){this.mediaType=e}updatePlayingState(e){if(!this.isPlayCalled||e&&!this.player.isStopped||!e&&this.player.isStopped){this.log.debug(`updatePlayingState abort ${this.isPlayCalled} ${e} ${this.player.isStopped}`);return}if(this.log.info(`playing state updated, ${e?"play":"stop"} ${this.kind}`),e){if(this instanceof Oe&&(!this.isSubscribed||!this.hasFlag)){this.log.info(`abort play, isSubscribed:${this.isSubscribed} hasFlag:${this.hasFlag}`);return}this.player.play().catch(()=>this.handleAutoPlayFailed())}else this.player.stop()}handleAutoPlayFailed(){if(this.room&&this.room.enableAutoPlayDialog)new nd;else{let e=()=>{this.resume().then(()=>{document.removeEventListener("click",e,!0),document.removeEventListener("touchstart",e,!0)})};document.addEventListener("click",e,!0),document.addEventListener("touchstart",e,!0)}}};y([me([],F.INIT)],fi.prototype,"close",1);var fh=Object.prototype.hasOwnProperty,{toString:UE}=Object.prototype;function Th(r){if(r==null)return!0;if(typeof r=="boolean")return!1;if(typeof r=="number")return r===0;if(typeof r=="string"||typeof r=="function"||Array.isArray(r))return r.length===0;if(r instanceof Error)return r.message==="";if(ft(r))switch(Object.prototype.toString.call(r)){case"[object File]":case"[object Map]":case"[object Set]":return r.size===0;case"[object Object]":{for(let t in r)if(fh.call(r,t))return!1;return!0}}return!1}var At=Th;var md=Ne(Me(),1);var hd=r=>t=>t.deviceId===r;var Zr=class{constructor(t,e="Input"){d(this,"kind");d(this,"type");d(this,"devices",[]);this.kind=t,this.type=e}update(t,e){let i=t.filter(s=>s.kind===`${this.kind}${this.type.toLocaleLowerCase()}`);e&&(i.forEach(s=>{if(s.deviceId&&!this.devices.find(hd(s.deviceId))){let o=`${this.kind}${this.type}Added`;g.warn(`${o}: ${JSON.stringify(s)}`),e.emit(o,s)}}),this.devices.forEach(s=>{if(s.deviceId&&!i.find(hd(s.deviceId))){let o=`${this.kind}${this.type}Removed`;g.warn(`${o}: ${JSON.stringify(s)}`),e.emit(o,s)}})),this.devices=i}hasDevice(t){return!!this.devices.find(e=>e.deviceId===t)}},Fn=class extends md.EventEmitter{constructor(){super();d(this,"audioInputs",new Zr(h.AUDIO));d(this,"videoInputs",new Zr(h.VIDEO));d(this,"audioOutputs",new Zr(h.AUDIO,"Output"));this.init(),navigator.mediaDevices&&navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.update.bind(this))}init(){lo().then(e=>{this.audioInputs.update(e),this.videoInputs.update(e),this.audioOutputs.update(e)})}update(){return _(this,null,function*(){let e=yield lo();return this.audioInputs.update(e,this),this.videoInputs.update(e,this),this.audioOutputs.update(e,this),this})}},re=Pr||Hi?null:new Fn;function lo(){return _(this,null,function*(){return Ft()||!io()?[]:(yield navigator.mediaDevices.enumerateDevices()).map((t,e)=>{let i={kind:t.kind,deviceId:t.deviceId,groupId:t.groupId,label:t.label||`${t.kind}_${e}`};return t.deviceId.length>0&&Gn.add(`${t.deviceId}_${t.kind}`),t.getCapabilities&&(i.getCapabilities=()=>t.getCapabilities()),i})})}function De(){return re.update().then(r=>r.audioInputs.devices)}function Ue(){return re.update().then(r=>r.videoInputs.devices)}function er(){return _(this,null,function*(){return re.update().then(r=>r.audioOutputs.devices)})}var Gn=new Set;function _d(r){if(r instanceof CanvasCaptureMediaStreamTrack||!(r instanceof MediaStreamTrack))return!1;let t=r.label.toLocaleLowerCase();if(t.includes("camera")||t.includes("webcam"))return!0;let i=`${((r==null?void 0:r.getSettings())||{}).deviceId}_${h.VIDEO_INPUT}`;return!!Gn.has(i)}function pd(r){if(r instanceof CanvasCaptureMediaStreamTrack||!(r instanceof MediaStreamTrack))return!1;let t=r.label.toLocaleLowerCase();if(t.includes("mic")||t.includes("\u9EA6\u514B\u98CE"))return!0;let i=`${((r==null?void 0:r.getSettings())||{}).deviceId}_${h.AUDIO_INPUT}`;return!!Gn.has(i)}function Wn(r,t){return _(this,null,function*(){let i=(yield De()).find(s=>s.deviceId===li);return(i==null?void 0:i.groupId)===r&&i.label===t})}function Ed(o){return _(this,arguments,function*({newDeviceId:r,oldDeviceId:t,oldGroupId:e,oldLabel:i,kind:s}){return r!==t?!1:s===h.AUDIO&&r===li?yield Wn(e,i):!0})}var Ih=function(r){return _(this,null,function*(){let t=gh(r);g.info(`getUserMedia with constraints: ${JSON.stringify(t)}`);let e=[],i=[];t.audio&&(e=yield De(),g.info(`microphones: ${$t(e,["label","deviceId"])}`)),t.video&&(i=yield Ue(),g.info(`cameras: ${$t(i,["label","deviceId"])}`));try{let s=yield navigator.mediaDevices.getUserMedia(t);return On&&s.getTracks().forEach(o=>{g.info(`${o.kind} capabilities: ${$t(o.getCapabilities(),Qs)}`)}),s}catch(s){if(s.name==="NotFoundError"){if(i&&i.length===0)throw new A({code:I.DEVICE_NOT_FOUND,message:b({key:C.CAMERA_NOT_FOUND})});if(e&&e.length===0)throw new A({code:I.DEVICE_NOT_FOUND,message:b({key:C.MICROPHONE_NOT_FOUND})})}throw new A({code:I.INITIALIZE_FAILED,name:s.name,message:s.message,constraint:s.constraint})}})},Sh=rt({retryFunction:Ih,settings:{retries:3,timeout:500},onError:(r,t,e,i)=>{r.name==="NotReadableError"?(i[0].video&&(i[0].maxResolution=!1,i[0].frameRate&&(i[0].frameRate=i[0].frameRate>10?10:5)),t()):e(r),i[0].microphoneId&&fd(i[0].microphoneId,!1),i[0].cameraId&&fd(i[0].cameraId,!0)},onRetrying:r=>{g.warn(`getUserMedia NotReadableError observed, retrying [${r}/3]`)}});function fd(r,t){return _(this,null,function*(){let i=(t?yield Ue():yield De()).find(s=>s.deviceId===r);i&&j(i.getCapabilities)&&g.warn($t(i.getCapabilities(),Qs))})}function gh(r){return{audio:Ah(r),video:Rh(r)}}function Ah(r){if(!r.audio)return!1;let t={};return At(r.microphoneId)||(t.deviceId=r.useExact?{exact:r.microphoneId}:r.microphoneId),Q(r.channelCount)&&r.channelCount>1&&(t.channelCount=r.channelCount),te(r.echoCancellation)&&!r.echoCancellation&&(t.echoCancellation=!1),te(r.noiseSuppression)&&!r.noiseSuppression&&(t.noiseSuppression=!1),te(r.autoGainControl)&&!r.autoGainControl&&(t.autoGainControl=!1),At(t)?!0:t}function Rh(r){if(!r.video)return!1;let{maxResolution:t=!0}=r,e={};return r.cameraId?e.deviceId=r.useExact?{exact:r.cameraId}:r.cameraId:r.facingMode&&(e.facingMode=r.facingMode),r.width&&(e.width={ideal:r.width},t&&!Y&&(e.width.max=r.width)),r.height&&(e.height={ideal:r.height},t&&!Y&&(e.height.max=r.height)),Y&&ut&&r.width&&r.height&&r.width*r.height<352*288&&(e.width=r.width,e.height=r.height),r.frameRate&&(e.frameRate=r.frameRate),At(e)?!0:e}var Td=Sh;function uo(r){return W((t,e)=>function(...i){return _(this,null,function*(){return yield r.apply(this,i),t.apply(this,i)})})}function ho(r){return W((t,e)=>function(...i){return _(this,null,function*(){return r.call(this,t.apply(this,i))})})}function W(r){return function(t,e,i){return i.value=r(i.value,e),i}}var ge=class extends fi{constructor(e,i=!0){super({mediaType:e,isInitPlayer:i});d(this,"isRemote",!1);d(this,"deviceId");d(this,"groupId","");d(this,"label","");d(this,"_isRecapturing",!1);d(this,"_lastRecaptureTime",0);d(this,"_onMuteTimeoutId",-1);this.onTrackMuted=this.onTrackMuted.bind(this),this.onTrackUnmuted=this.onTrackUnmuted.bind(this),this.onTrackEnded=this.onTrackEnded.bind(this)}installTrackEvent(e){e.addEventListener(h.MUTE,this.onTrackMuted),e.addEventListener(h.UNMUTE,this.onTrackUnmuted),e.addEventListener(h.ENDED,this.onTrackEnded),e.muted&&this.onTrackMuted(),e.readyState===h.ENDED&&this.onTrackEnded()}uninstallTrackEvent(e){e.removeEventListener(h.MUTE,this.onTrackMuted),e.removeEventListener(h.UNMUTE,this.onTrackUnmuted),e.removeEventListener(h.ENDED,this.onTrackEnded)}setStateToCapture(){}capture(e){return _(this,null,function*(){try{E.emit(p.LOCAL_TRACK_CAPTURE_START,{track:this});let i;e.customSource?(i=new MediaStream,i.addTrack(e.customSource)):i=yield Td(e);let s=i.getTracks()[0];return this.setMediaStream(i),this.setMediaStreamTrack(s),e.customSource||(this.updateDeviceIdInUse(),this.listenDeviceChange()),E.emit(p.LOCAL_TRACK_CAPTURE_SUCCESS,{track:this}),i}catch(i){throw E.emit(p.LOCAL_TRACK_CAPTURE_FAILED,{track:this,error:i}),this.log.error(`getUserMedia error observed ${i}`),i}})}setMediaStreamTrack(e){this.state===F.INIT&&this.setStateToCapture(),this.mediaTrack&&this.uninstallTrackEvent(this.mediaTrack),super.setMediaStreamTrack(e),e&&this.installTrackEvent(e)}setPublishStarting(e){this.room=e}setPublishStarted(){}setPublishStopped(e,i){}publish(e){this.room=e,this.userId=e.userId,this._log.setUserId(e.userId),this._log.setSdkAppId(e.sdkAppId),E.emit(p.LOCAL_TRACK_PUBLISHED,{track:this}),this.setPublishStarted()}unpublish(){E.emit(p.LOCAL_TRACK_UNPUBLISHED,{track:this}),this.mediaType===2&&(this.mediaType=4),this.setPublishStopped("api-call"),this.room=void 0}get isPublishing(){return this.state==="publish"}updateDeviceIdInUse(){return _(this,null,function*(){if(this.mediaTrack&&Ke){let{deviceId:e,groupId:i}=this.mediaTrack.getSettings(),{label:s}=this.mediaTrack;(yield Ed({newDeviceId:e,oldDeviceId:this.deviceId,oldGroupId:this.groupId,oldLabel:this.label,kind:this.kind}))||(this.deviceId=e,this.label=s,i&&(this.groupId=i),lo().then(n=>{let a=n.find(c=>c.deviceId===e);a&&this.emit("2",a)}))}})}setProfile(e){this.log.info("setProfile",e),Object.assign(this.profile,e)}isNeedToRecapture(e=!1){return!(!this.deviceId||!this.mediaTrack||this.kind===h.AUDIO&&!pd(this.mediaTrack)||this.kind===h.VIDEO&&!_d(this.mediaTrack)||this._isRecapturing||e&&ut&&ke)}onTrackMuted(){if(!!this.isNeedToRecapture(!0)){if(Date.now()-this._lastRecaptureTime<ji){setTimeout(()=>this.onTrackMuted(),ji);return}this._onMuteTimeoutId=setTimeout(()=>_(this,null,function*(){var e;((e=this.mediaTrack)==null?void 0:e.muted)&&document.visibilityState==="visible"&&this.recapture(yield this.getRecoverCaptureDeviceId())}),5e3)}}onTrackUnmuted(){this._onMuteTimeoutId>0&&clearTimeout(this._onMuteTimeoutId)}onTrackEnded(){return _(this,null,function*(){if(!!this.isNeedToRecapture()){if(Date.now()-this._lastRecaptureTime<ji){setTimeout(()=>this.onTrackEnded(),ji);return}this.recapture(yield this.getRecoverCaptureDeviceId())}})}recapture(e){return _(this,null,function*(){var o;if(this._isRecapturing||!this.mediaTrack)return;let i;return this.log.warn("recapture trying"),(o=this.mediaTrack)==null||o.stop(),this._isRecapturing=!0,this._lastRecaptureTime=Date.now(),(this.kind==="audio"?yield De():yield Ue()).find(n=>n.deviceId===e)&&(i=e),this.capture({deviceId:i,useExact:!0}).then(()=>{var n;return(n=this.room)==null?void 0:n.replaceTrack(this)}).then(()=>{this._isRecapturing=!1,this.log.warn("recapture success"),this.emit("1",{deviceId:this.deviceId})}).catch(n=>{this._isRecapturing=!1,this.log.warn(`recapture failed ${n.message}`),this.emit("5",n)})})}getRecoverCaptureDeviceId(){return _(this,null,function*(){let{deviceId:e}=this;if(e){let i=(es.get(e)||0)+1;if(es.set(e,i),i>=3){let s=this.kind==="video"?(yield Ue()).find(o=>!es.has(o.deviceId)):(yield De()).find(o=>!es.has(o.deviceId));s&&(this.log.warn(`${e} capture fail ${i} times, change new ${s.deviceId}`),e=s.deviceId)}}return e})}};y([me(F.INIT,"capture")],ge.prototype,"setStateToCapture",1),y([me("capture","publish_starting",{success(){this.emit("4",{mediaType:this.strMediaType,state:"starting",prevState:"stopped"})}})],ge.prototype,"setPublishStarting",1),y([me("publish_starting","publish",{ignoreError:!0,success(){this.emit("4",{mediaType:this.strMediaType,state:"started",prevState:"starting"})}})],ge.prototype,"setPublishStarted",1),y([W(r=>function(t,e){let i=this.state.oldState||this.state;r.call(this,t,e),i!=="capture"&&this.emit("4",{mediaType:this.strMediaType,state:"stopped",prevState:this.state.oldState==="publish_starting"?"starting":"started",reason:t,error:e})}),me(["publish","publish_starting"],"capture",{ignoreError:!0})],ge.prototype,"setPublishStopped",1);var es=new Map;E.on(p.SWITCH_DEVICE_SUCCESS,r=>{r.track.deviceId&&es.delete(r.track.deviceId)});var be=class extends ge{constructor(){super(1);d(this,"mediaType",1);d(this,"volume",0);d(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40});d(this,"playerMuted",!0)}getAudioLevel(){return this.volume||super.getAudioLevel()}capture({deviceId:e,customSource:i,useExact:s=!1}={}){return super.capture({video:!1,audio:!0,microphoneId:e,echoCancellation:this.profile.echoCancellation,autoGainControl:this.profile.autoGainControl,noiseSuppression:this.profile.noiseSuppression,sampleRate:this.profile.sampleRate,channelCount:this.profile.channelCount,useExact:s,customSource:i})}switchDevice(e){return _(this,null,function*(){if(!(!this.mediaStream||!this.mediaTrack)){if(this.deviceId===e)if(e===li){if(yield Wn(this.groupId,this.label))return}else return;try{this.log.info(`switchDevice audio to: ${e}`),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),E.emit(p.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch microphone success")}catch(i){throw this.log.error(`switch microphone failed ${i}`),this.deviceId&&this.recapture(this.deviceId),i}}})}listenDeviceChange(){re&&!re.listeners("audioInputRemoved").includes(this.handleMicrophoneRemoved)&&re.on("audioInputRemoved",this.handleMicrophoneRemoved,this)}handleMicrophoneRemoved(e){return _(this,null,function*(){if(e.deviceId===this.deviceId){this.log.warn(`current microphone is lost: ${JSON.stringify(e)}`);let i=yield De();i[0]?this.recapture(i[0].deviceId):re.on("audioInputAdded",this.handleMicrophoneAdded,this)}})}handleMicrophoneAdded(e){return _(this,null,function*(){this.log.warn(`microphone added: ${JSON.stringify(e)}`),this.recapture(e.deviceId)})}close(){re.off("audioInputAdded",this.handleMicrophoneAdded,this),re.off("audioInputRemoved",this.handleMicrophoneRemoved,this),super.close()}};var je=class extends ge{constructor(){super(4);d(this,"mediaType",4);d(this,"profile",{width:640,height:480,frameRate:15,bitrate:500});d(this,"states",{bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0});d(this,"small");d(this,"facingMode");d(this,"_canvas");d(this,"_canvasInterval");d(this,"canvasTrack")}capture({deviceId:e,facingMode:i,useExact:s=!1,customSource:o}={}){return super.capture({audio:!1,video:!0,facingMode:i||this.facingMode,cameraId:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,useExact:s,customSource:o})}genCanvasTrack(){if(this.canvasTrack||!this.mediaTrack)return;this.log.info("gen canvas track");let{width:e,height:i,frameRate:s}=this.mediaTrack.getSettings();this._canvas=document.createElement("canvas");let o=this._canvas.getContext("2d");e&&i&&(this._canvas.width=e,this._canvas.height=i),this._canvasInterval=ee.run(Et,()=>{if(!this._canvas)return;if(this.mediaTrack){let c=this.mediaTrack.getSettings();(c.width!==this._canvas.width||c.height!==this._canvas.height)&&(this._canvas.width=c.width,this._canvas.height=c.height)}let a=this.player.getElement();a&&(o==null||o.drawImage(a,0,0,this._canvas.width,this._canvas.height))},{fps:Math.max(15,s||0)});let n=this._canvas.captureStream();this.canvasTrack=n.getVideoTracks()[0]}destoryCanvasTrack(){this._canvasInterval&&(ee.clearTask(this._canvasInterval),this._canvasInterval=void 0,this._canvas=void 0,this.canvasTrack=void 0)}setPublishStarting(e){super.setPublishStarting(e),this.isNeedToResetVideoProfile(this.profile)&&this.setProfile(this.profile)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.isNeedToResetVideoProfile(this.profile)&&this.setProfile(this.profile)}setProfile(e){var s;if(!e)return;let i=e.bitrate&&e.bitrate!==this.profile.bitrate;return this.isNeedToResetVideoProfile(e)&&(this.log.warn("Resolution is reset to 1080p, need to upgrade ability here https://cloud.tencent.com/document/product/647/85386"),e.width=1920,e.height=1080),super.setProfile(e),(s=this.mediaTrack)==null?void 0:s.applyConstraints({width:e.width,height:e.height,frameRate:e.frameRate}).then(()=>{if(i&&this.room&&this.room.setBandWidth)return this.room.setBandWidth({bandwidth:e.bitrate,type:h.VIDEO,videoType:h.BIG})})}isNeedToResetVideoProfile(e){return!!(this.room&&this.room.scheduleResult&&!((this.room.scheduleResult.trtcAutoConf||{})["2k4k"]===1)&&!this.isScreen&&e.height*e.width>=2560*1440)}switchDevice(e){return _(this,null,function*(){try{if(!this.mediaStream||this.deviceId===e||this.facingMode===e)return;(e===h.FACING_MODE_USER||e===h.FACING_MODE_ENVIRONMENT)&&(this.facingMode=e,e=void 0),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),E.emit(p.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch camera success")}catch(i){throw this.log.error(`switch camera failed ${i}`),this.deviceId&&this.recapture(this.deviceId),i}})}listenDeviceChange(){re&&!re.listeners("audioInputRemoved").includes(this.handleCameraRemoved)&&re.on("videoInputRemoved",this.handleCameraRemoved,this)}handleCameraRemoved(e){return _(this,null,function*(){if(e.deviceId===this.deviceId){this.log.warn(`current camera is lost: ${JSON.stringify(e)}`);let i=yield Ue();i[0]?this.recapture(i[0].deviceId):re.on("videoInputAdded",this.handleCameraAdded,this)}})}handleCameraAdded(e){return _(this,null,function*(){this.log.warn(`camera added: ${JSON.stringify(e)}`),this.recapture(e.deviceId)})}close(){re.off("videoInputAdded",this.handleCameraAdded,this),re.off("videoInputRemoved",this.handleCameraRemoved,this),this.destoryCanvasTrack(),super.close()}};var Nh=function(r){return _(this,null,function*(){let t=null,e=Oh(r);g.info(`getDisplayMedia with constraints: ${JSON.stringify(e)}`);let i=yield navigator.mediaDevices.getDisplayMedia(e);if(r.systemAudio&&i.getAudioTracks().length===0&&(Vi&&Bi<74||ke||Y)&&g.warn("Your browser not support capture system audio"),r.frameRate&&i.getVideoTracks()[0]&&i.getVideoTracks()[0].applyConstraints({frameRate:{min:r.frameRate,ideal:r.frameRate},width:r.width,height:r.height}).catch(s=>{g.warn(`screen applyConstraints failed: ${s}`)}),r.audio){let s=yh(r);g.info(`getUserMedia with constraints: ${JSON.stringify(s)}`),t=yield navigator.mediaDevices.getUserMedia(s),i.addTrack(t.getAudioTracks()[0])}return i})};function yh(r){let t={echoCancellation:r.echoCancellation,autoGainControl:r.autoGainControl,noiseSuppression:r.noiseSuppression,sampleRate:r.sampleRate,channelCount:r.channelCount};return T(r.microphoneId)||(t.deviceId=r.microphoneId),{audio:t,video:!1}}function Oh(r){let t={systemAudio:"include",selfBrowserSurface:"include",surfaceSwitching:"include"},e={width:ke?{max:r.width}:{ideal:r.width,max:r.width},height:ke?{max:r.height}:{ideal:r.height,max:r.height},frameRate:r.frameRate,displaySurface:"monitor"};if(t.video=e,r.systemAudio){let{echoCancellation:i=!0,noiseSuppression:s=!1,autoGainControl:o=!1}=r;t.audio={echoCancellation:i,noiseSuppression:s,autoGainControl:o,sampleRate:48e3}}return t}var Sd=Nh;var at=class extends je{constructor(){super();d(this,"profile",{width:1920,height:1080,frameRate:5,bitrate:1600});d(this,"objectFit","contain");d(this,"isScreen",!0);this._log.id=`s-${this._log.id}`}capture(){return _(this,arguments,function*({systemAudio:e=!1,autoGainControl:i,echoCancellation:s,noiseSuppression:o,audioTrack:n,videoTrack:a}={}){try{let c;return a||n?(c=new MediaStream,a&&c.addTrack(a),n&&c.addTrack(n)):c=yield Sd({audio:!1,systemAudio:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,autoGainControl:i,echoCancellation:s,noiseSuppression:o}),this.setMediaStream(c),this.setMediaStreamTrack(c.getVideoTracks()[0]),c}catch(c){throw this.log.error(`getDisplayMedia error observed ${c}`),c instanceof A?c:new A({code:I.INITIALIZE_FAILED,name:c.name,message:c.message})}})}switchDevice(e){return _(this,null,function*(){throw new Error("Method not implemented.")})}};var Ti=class extends be{constructor(){super(),this._log.id=`s-${this._log.id}`}setScreenAudioTrack(t,e){this.setMediaStream(e),this.setMediaStreamTrack(t)}};var ts=class extends ge{constructor(e){super(1,!1);d(this,"musicId");d(this,"mediaType",1);d(this,"volume",0);d(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40});d(this,"playerMuted",!1);d(this,"audio");d(this,"_audioContext");d(this,"_destination");d(this,"_source",null);this.initAudioContext(),this._destination=this._audioContext.createMediaStreamDestination(),this._destination.channelCount=1,this.audio=document.createElement("audio"),this.audio.src=e.url,this.audio.crossOrigin="anonymous",te(e.loop)&&this.loop(e.loop),Q(e.volume)&&this.setVolume(e.volume),e.id&&(this.musicId=e.id),this._source=this._audioContext.createMediaElementSource(this.audio),this._source.connect(this._destination),this.setMediaStream(this._destination.stream),this.installPlayerEvent()}installPlayerEvent(){this.audio.addEventListener("error",this.handleAudioError.bind(this))}uninstallPlayerEvent(){this.audio.removeEventListener("error",this.handleAudioError.bind(this))}handleAudioError(e){this._log.warn(`local music ${this.musicId} audio error`,e)}initAudioContext(){this._audioContext=Kt(),this._audioContext.state!=="running"&&this._log.warn(`local music ${this.musicId} context state: ${this._audioContext.state}`)}play(){return _(this,null,function*(){try{yield this.audio.play(),this._log.info(`music ${this.musicId} play success`)}catch(e){this._log.error(`music ${this.musicId} play error`,e)}})}destroy(){var e,i;(e=this._source)==null||e.disconnect(),(i=this._destination)==null||i.disconnect(),this.uninstallPlayerEvent(),this.player.stop(),this._audioContext.close().then(()=>{this._source=null,this._destination=null,this._audioContext=null})}getStream(){var e;return((e=this._destination)==null?void 0:e.stream)||null}seek(e){if(e<0&&e>this.duration()){this._log.warn("Time beyond song duration.");return}this.audio.currentTime=e}getPosition(){return this.audio.currentTime||0}setVolume(e){if(e>1&&e<0){this.log.warn("volume is out of range");return}this.audio.volume=e}getVolume(){return this.audio.volume||0}setPlayBackRate(e){if(e>8&&e<0){this.log.warn("rate is out of range");return}this.audio.playbackRate=e}getPlayBackRate(){return this.audio.playbackRate||0}duration(){return this.audio.duration||0}loop(e){return this.audio&&te(e)&&(this.audio.loop=e),this.audio.loop||!1}setOperation(e){e==="pause"&&this.audio.pause(),e==="resume"&&(this.audio.pause(),this.audio.play()),e==="stop"&&(this.audio.pause(),this.seek(0))}listenDeviceChange(){}};window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;var gd=(()=>{let r;return()=>{if(r)return r;r=new window.AudioContext({sampleRate:48e3});let t=()=>{r.state==="suspended"?(r.resume(),document.removeEventListener("click",t)):r.state==="interrupted"?r.resume():document.removeEventListener("click",t)};return document.addEventListener("click",t),r.onstatechange=()=>{t()},r}})(),jt="input",Ii="output",Ad="ondump",Rd="dumped";function Dh(r){let t;return bh(r)?t="intl-schedule.rtc.qq.com":t="schedule.rtc.qq.com",t}var bh=r=>(r=Number(r),r>0&&r<14e8);function Cd(s){return _(this,arguments,function*({sdkAppId:r,userId:t,userSig:e,timestamp:i}){let n=`https://${Dh(r)}/api/v1/audioAiAuth?sdkAppId=${r}&userId=${t}&userSig=${e}&timestamp=${i}`,a=yield fetch(n),{data:{errCode:c,errMsg:l,sign:u,status:m}}=yield a.json();if(m==="1")return{auth:!0,sign:u,status:m,message:l};let f="Init RTCAIDenoiser failed.",O="";switch(c){case 1:O="Please check your params.";break;case 2:O="You need to buy packages. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 3:O="Server is invalid. Please contact our engineer. ";break;case 4:O="Your packages is not active. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 5:O="Your packages is expired. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 6:O="Your version is not supported.";break}return{auth:!1,status:m,message:l?`${f} Reason: ${l}. ${O}`:`${f}, ${O}`}})}var yd=Ne(Me(),1);function Nd(r,t){t=t||{};let e=r.numberOfChannels,{sampleRate:i}=r,s=t.float32?3:1,o=s===3?32:16,n;return e===2?n=Lh(r.getChannelData(0),r.getChannelData(1)):n=r.getChannelData(0),vh(n,s,i,e,o)}function vh(r,t,e,i,s){let o=s/8,n=i*o,a=new ArrayBuffer(44+r.length*o),c=new DataView(a);return mo(c,0,"RIFF"),c.setUint32(4,36+r.length*o,!0),mo(c,8,"WAVE"),mo(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,t,!0),c.setUint16(22,i,!0),c.setUint32(24,e,!0),c.setUint32(28,e*n,!0),c.setUint16(32,n,!0),c.setUint16(34,s,!0),mo(c,36,"data"),c.setUint32(40,r.length*o,!0),t===1?Mh(c,44,r):Ph(c,44,r),a}function Lh(r,t){let e=r.length+t.length,i=new Float32Array(e),s=0,o=0;for(;s<e;)i[s++]=r[o],i[s++]=t[o],o++;return i}function Ph(r,t,e){for(let i=0;i<e.length;i++,t+=4)r.setFloat32(t,e[i],!0)}function Mh(r,t,e){for(let i=0;i<e.length;i++,t+=2){let s=Math.max(-1,Math.min(1,e[i]));r.setInt16(t,s<0?s*32768:s*32767,!0)}}function mo(r,t,e){for(let i=0;i<e.length;i++)r.setUint8(t+i,e.charCodeAt(i))}var Kn=class{constructor(t){d(this,"audioContext_");d(this,"inputPCM_",new Float32Array);d(this,"outputPCM_",new Float32Array);this.audioContext_=t}onDump(t,e){if(e===jt){let i=this.inputPCM_.length,s=new Float32Array(i+t[0].length);s.set(this.inputPCM_),s.set(t[0],i),this.inputPCM_=s}if(e===Ii){let i=this.outputPCM_.length,s=new Float32Array(i+t[0].length);s.set(this.outputPCM_),s.set(t[0],i),this.outputPCM_=s}}getBlob(t){let e=t===jt?this.inputPCM_:this.outputPCM_,i=this.audioContext_.createBuffer(2,e.length,48e3);i.copyToChannel(e,0,0),i.copyToChannel(e,1,0);let s=Nd(i),o=new window.Blob([new DataView(s)],{type:"audio/wav"});return i=null,o}reset(){this.inputPCM_=new Float32Array,this.outputPCM_=new Float32Array}destroy(){this.reset()}},Jn=Kn;var jn=class{constructor({sdkAppId:t,userId:e,audioContext:i,sign:s,status:o,worklet:n,timestamp:a,logger:c}){d(this,"audioContext_");d(this,"destination_");d(this,"gainNode_");d(this,"log_");d(this,"workletNode_");d(this,"isDumping_",!1);d(this,"dump_");d(this,"trackConstraint_",{});d(this,"audioTrack_");d(this,"source_");d(this,"denoiserTrack_");d(this,"enableDenoise_",!0);d(this,"emitter_",new yd.default);this.audioContext_=i,this.destination_=this.audioContext_.createMediaStreamDestination(),this.gainNode_=this.audioContext_.createGain(),this.gainNode_.gain.value=1.1,this.log_=c,this.workletNode_=n,this.workletNode_.connect(this.gainNode_).connect(this.destination_),this.workletNode_.port.postMessage({type:"init",data:{sdkAppId:String(t),userId:e,timestamp:a,sign:s,status:o}}),this.workletNode_.port.onmessage=l=>{let{type:u,data:m}=l.data;if(u===Ad&&this.isDumping_){let{inputPCM:f,outputPCM:O}=m;this.dump_.onDump(f,jt),this.dump_.onDump(O,Ii)}u===Rd&&this.dumped()},this.dump_=new Jn(this.audioContext_)}dumped(){this.isDumping_=!1;let t=this.dump_.getBlob(jt),e=this.dump_.getBlob(Ii);this.emitter_.emit("ondumpend",{blob:t,name:jt}),this.emitter_.emit("ondumpend",{blob:e,name:Ii}),this.dumpedWAV(t,jt),this.dumpedWAV(e,Ii),this.dump_.reset()}dumpedWAV(t,e){let i=window.URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=`${e}-${Date.now()}.wav`,s.click(),window.URL.revokeObjectURL(i),s.href=""}process(t){return _(this,null,function*(){if(this.audioTrack_=t,!this.audioTrack_)throw new Error("RTCAIDenoiser: cannot process without audioTrack.");let e=new MediaStream;e.addTrack(this.audioTrack_),this.source_=this.audioContext_.createMediaStreamSource(e),yield this.source_.connect(this.workletNode_),this.trackConstraint_=this.audioTrack_.getConstraints(),this.trackConstraint_.noiseSuppression=!1,yield this.audioTrack_.applyConstraints(this.trackConstraint_);let i=this.destination_.stream;return this.denoiserTrack_=i.getAudioTracks()[0],this.log_.info(`RTCAIDenoiser: denoiser process track ID: ${t.id} success.`),this.denoiserTrack_})}updateTrack(t){return _(this,null,function*(){var s;let e=new MediaStream;yield e.addTrack(t);let i=this.audioContext_.createMediaStreamSource(e);this.source_.disconnect(),i.connect(this.workletNode_),(s=this.audioTrack_)==null||s.stop(),this.audioTrack_=t,this.source_=i,this.log_.info("RTCAIDenoiser: updateTrack success.")})}disable(){return _(this,null,function*(){var t,e;return this.enableDenoise_=!1,(t=this.workletNode_)==null||t.port.postMessage({type:"disable"}),this.trackConstraint_.noiseSuppression=!0,yield(e=this.audioTrack_)==null?void 0:e.applyConstraints(this.trackConstraint_),this.log_.info("RTCAIDenoiser: disable ai denoiser."),this.enableDenoise_})}enable(){return _(this,null,function*(){var t,e;return this.enableDenoise_=!0,(t=this.workletNode_)==null||t.port.postMessage({type:"enable"}),this.trackConstraint_.noiseSuppression=!1,yield(e=this.audioTrack_)==null?void 0:e.applyConstraints(this.trackConstraint_),this.log_.info("RTCAIDenoiser: enable ai denoiser."),this.enableDenoise_})}startDump(){return this.isDumping_?(this.log_.info("RTCAIDenoiser: data is currently being dumped."),!1):(this.workletNode_.port.postMessage({type:"startDump"}),this.dump_?this.dump_.reset():this.dump_=new Jn(this.audioContext_),this.isDumping_=!0,this.log_.info("RTCAIDenoiser: start dump data."),!0)}stopDump(){!this.isDumping_||(this.workletNode_.port.postMessage({type:"stopDump"}),this.isDumping_=!1,this.log_.info("RTCAIDenoiser: stop dump data."))}getAudioTrack(){return this.audioTrack_}getDenoiserTrack(){return this.destination_.stream.getAudioTracks()[0]}get enabled(){return this.enableDenoise_}destroy(){var t,e,i,s,o,n;this.log_.info("RTCAIDenoiser: destroy processor."),(t=this.audioTrack_)==null||t.stop(),(e=this.workletNode_)==null||e.port.postMessage({type:"destroy"}),this.workletNode_.port.onmessage=null,(i=this.source_)==null||i.disconnect(),(s=this.destination_)==null||s.disconnect(),(o=this.workletNode_)==null||o.disconnect(),(n=this.dump_)==null||n.destroy(),this.emitter_.removeAllListeners()}on(t,e,i){this.emitter_.on(t,e,i)}off(t,e,i){t==="*"?this.emitter_.removeAllListeners():this.emitter_.off(t,e,i)}},Od=jn;var Yn=class{constructor({assetsPath:t,log:e}){this.isLoaded_=!1;this.audioContext_=gd(),this.log_=e,this.assetsPath_=t}createProcessor(t){return _(this,null,function*(){let e=String(Date.now()).slice(0,-3),{auth:i,sign:s,status:o,message:n}=yield Cd(k(R({},t),{timestamp:e}));if(!i)throw this.log_.info(`RTCAIDenoiser: ${t.userId} auth result: ${i}. Message: ${n}`),new Error(n);try{yield this.load()}catch(l){throw new Error("Init wasm failed, please check your assetsPath.")}let a=yield this.initWorklet(),c=new Od(k(R({},t),{audioContext:this.audioContext_,timestamp:e,sign:s,status:o,worklet:a,logger:this.log_}));return this.log_.info(`RTCAIDenoiser: ${t.userId} create denoiser processor success.`),c})}load(){return _(this,null,function*(){if(!this.isLoaded_)try{yield this.audioContext_.audioWorklet.addModule(`${this.assetsPath_}/denoiser-wasm.js`),this.isLoaded_=!0}catch(t){throw this.log_.error(`Init assets from ${this.assetsPath_} failed! Reason: ${t}`),t}})}initWorklet(){return _(this,null,function*(){try{return new AudioWorkletNode(this.audioContext_,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1})}catch(t){return yield this.load(),new AudioWorkletNode(this.audioContext_,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1})}})}destroy(){var t;(t=this.audioContext_)==null||t.close()}isSupported(){return"AudioWorklet"in window&&"WebAssembly"in window}},Dd=Yn;var _o=class{constructor({room:t}){d(this,"audioContext",null);d(this,"_destination",null);d(this,"_localAudioTrack",null);d(this,"_localScreenAudioTrack",null);d(this,"_localMediaStreamAudioTrack",null);d(this,"_audioTrackStreamSource",null);d(this,"_screenAudioTrackStreamSource",null);d(this,"_mixedMusicSet",new Set);d(this,"hasMusic",!1);d(this,"isDenoiserInit",!1);d(this,"isDenoiserEnabled",!1);d(this,"isDenoiserProcessed",!1);d(this,"mixedMusicMap",new Map);d(this,"cacheMusicMap",new Map);d(this,"_log");d(this,"originTrack",null);d(this,"denoiserTrack",null);d(this,"denoiser",null);d(this,"denoiserProcessor",null);d(this,"initProcessorOptions");this._log=g.createLogger({id:"am",userId:t.userId,sdkAppId:t.sdkAppId}),this.initAudioContext()}get hasScreenAudioTrack(){return this._localScreenAudioTrack!==null}get hasAudioTrack(){return this._localAudioTrack!==null}get isMixed(){return(this._localAudioTrack?1:0)+(this._localScreenAudioTrack?1:0)>=1}get mediaStreamTrack(){return this._destination.stream.getAudioTracks()[0]}addMusicSource(t){return _(this,null,function*(){this._log.info(`add music source, id: ${t.id} url: ${t.url}`),this.initAudioContext();let{id:e,url:i,loop:s,volume:o}=t;if(this.mixedMusicMap.has(e))return;let n;this.cacheMusicMap.has(e)?n=this.cacheMusicMap.get(e).localMusicTrack:n=new ts(t);let{stream:a}=n._destination,c=document.createElement("audio");c.srcObject=a,n.play(),yield c.play(),this._log.info(`start mix audio ${e} success.`);let l=this.audioContext.createMediaStreamSource(a),u=this.audioContext.createGain();return l.connect(u),u.connect(this._destination),this._mixedMusicSet.add(e),this.mixedMusicMap.set(e,{localMusicTrack:n,streamSource:l,gainNode:u,audioPlayer:c}),this.cacheMusicMap.set(e,{localMusicTrack:n}),this.hasMusic=!0,n})}updateMusicSource(t){return _(this,null,function*(){let{id:e,volume:i,loop:s,operation:o,seekFrom:n}=t;if(this._log.info(`update music source, ${JSON.stringify(t)}`),this.mixedMusicMap.has(e)){let{localMusicTrack:a}=this.mixedMusicMap.get(e);T(i)||a.setVolume(i),T(s)||a.loop(s),T(o)||a.setOperation(o),T(n)||a.seek(n)}})}addAudioTrack(t){return _(this,null,function*(){var e;if(this._log.info(`start add audioTrack, userId: ${t.userId}`),this.initAudioContext(),!!(t!=null&&t.mediaStream)&&this._localMediaStreamAudioTrack!==t.mediaTrack){if(Ke){let i=yield(e=t.mediaTrack)==null?void 0:e.getSettings();this._destination.channelCount=(i==null?void 0:i.channelCount)||1}this._localAudioTrack=t,this._localMediaStreamAudioTrack=t.mediaTrack,this.isDenoiserProcessed?this.denoiserProcessor.updateTrack(t.mediaTrack):(this._audioTrackStreamSource=this.audioContext.createMediaStreamSource(t.mediaStream),this._audioTrackStreamSource.connect(this._destination))}})}removeAudioTrack(t){var e,i;this._localAudioTrack===t&&(this._log.info(`remove audioTrack, userId: ${t.userId}`),(e=this._audioTrackStreamSource)==null||e.disconnect(),this._audioTrackStreamSource=null,this._localMediaStreamAudioTrack=null,this._localAudioTrack=null,this.destroyDenoiserProcessor()),this._localScreenAudioTrack===t&&(this._log.info(`start remove screenTrack, userId: ${t.userId}`),(i=this._screenAudioTrackStreamSource)==null||i.disconnect(),this._localScreenAudioTrack=null)}addScreenAudioTrack(t){this._log.info(`start add screenAudioTrack, userId: ${t.userId}`),this.initAudioContext(),!!(t!=null&&t.mediaStream)&&this._localScreenAudioTrack!==t&&(this._localScreenAudioTrack=t,this._screenAudioTrackStreamSource=this.audioContext.createMediaStreamSource(t.mediaStream),this._screenAudioTrackStreamSource.connect(this._destination))}removeAudioTrackSource(t){var e,i;this._log.info(`remove audio track source, type: ${t}`),t==="main"&&((e=this._audioTrackStreamSource)==null||e.disconnect(),this._audioTrackStreamSource=null,this._localAudioTrack=null),t==="screen"&&((i=this._screenAudioTrackStreamSource)==null||i.disconnect(),this._screenAudioTrackStreamSource=null,this._localScreenAudioTrack=null)}removeMusicSource({id:t}){if(this.mixedMusicMap.has(t)){this._log.info(`remove music source, music id: ${t}`);let{localMusicTrack:e,streamSource:i,gainNode:s,audioPlayer:o}=this.mixedMusicMap.get(t);i.disconnect(),s.disconnect(),o.pause(),o.srcObject=null,e.stop(),this.mixedMusicMap.delete(t),this._mixedMusicSet.delete(t),this._mixedMusicSet.size===0&&(this.hasMusic=!1)}t==="*"&&this.destroyAllMusic()}destroyAllMusic(){this._log.info("destroy all music source."),this._mixedMusicSet.forEach(t=>{this.removeMusicSource({id:t})})}destroyAllCache(){this._log.info("destroy all music cache."),this.cacheMusicMap.forEach(t=>{t.localMusicTrack.stop()})}initAudioContext(){this.audioContext||(this.audioContext=Kt(),this.audioContext.state!=="running"&&this._log.warn(`context state: ${this.audioContext.state}`),this._destination=this.audioContext.createMediaStreamDestination(),this._destination.channelCount=1)}initDenoiser(t){return _(this,null,function*(){let{assetsPath:e,sdkAppId:i,userId:s,userSig:o}=t;try{this.denoiser||(this.denoiser=new Dd({assetsPath:e,log:this._log})),this.denoiserProcessor||(this.denoiserProcessor=yield this.denoiser.createProcessor({sdkAppId:i,userId:s,userSig:o})),this.isDenoiserInit=!0,this.initProcessorOptions=t}catch(n){throw n}})}enableDenoiser(t){return _(this,null,function*(){var e;if(this.isDenoiserEnabled=!0,!this.hasAudioTrack){this._log.warn("enableDenoiser failed, there is no audio");return}if(this.isDenoiserProcessed)this.denoiserProcessor.enable();else{if(this.originTrack=this._localAudioTrack.mediaTrack,!this.originTrack)return;(e=this._audioTrackStreamSource)==null||e.disconnect(),this.denoiserProcessor||(yield this.initDenoiser(this.initProcessorOptions)),this.denoiserTrack=yield this.denoiserProcessor.process(this.originTrack);let i=new MediaStream;i.addTrack(this.denoiserTrack),this._audioTrackStreamSource=this.audioContext.createMediaStreamSource(i),this._audioTrackStreamSource.connect(this._destination),this.isDenoiserProcessed=!0}})}disableDenoiser(){return _(this,null,function*(){this.isDenoiserEnabled&&(this.denoiserProcessor.disable(),this.isDenoiserEnabled=!1)})}destroyDenoiserProcessor(){var t;this.denoiserProcessor&&(this.denoiserProcessor.destroy(),this.denoiserProcessor=null,this.isDenoiserInit=!1,this.isDenoiserEnabled=!1,this.isDenoiserProcessed=!1,(t=this.denoiserTrack)==null||t.stop(),this.denoiserTrack=null,this.originTrack=null)}destroy(){var t;this.removeAudioTrackSource("main"),this.removeAudioTrackSource("aux"),this.audioContext.close(),this.destroyAllMusic(),this.destroyAllCache(),this.destroyDenoiserProcessor(),(t=this.denoiser)==null||t.destroy()}};var Xn=class extends fi{constructor(e,i,s){super({userId:i.userId,sdkAppId:e.sdkAppId,mediaType:s,room:e});this.room=e;this.user=i;d(this,"userId");d(this,"tinyId");d(this,"isRemote",!0);this.tinyId=i.tinyId,this.userId=i.userId}play(e,i){return this.hasFlag?super.play(e,i):(this.isPlayCalled=!0,this.container=e,e&&this.player.setContainer(e),Promise.resolve())}setMute(e){return this.hasFlag&&super.setMute(e)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.mediaTrack&&this.hasFlag&&this.isSubscribed&&this.player.setTrack(this.mediaTrack)}get isSubscribing(){return this.state.toString()==="subscribeing"}get isSubscribed(){return this.state===Xn.STATE_SUBSCRIBE}get streamType(){return(this.mediaType&2)===0?"main":"auxiliary"}subscribe(e){return e}unsubscribe(){this.player.setTrack(null),this.streamType==="main"&&this.kind==="video"&&this.room.changeType(!1,this.user)}onFlagChanged(){this.updatePlayingState(this.hasFlag),this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack)}},Oe=Xn;d(Oe,"STATE_SUBSCRIBE","subscribe"),y([me(F.INIT,Oe.STATE_SUBSCRIBE,{success(){this.log.info("subscribed"),this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack),E.emit(p.REMOTE_TRACK_SUBSCRIBED,{track:this}),this.updatePlayingState(!0)},ignoreError:!0})],Oe.prototype,"subscribe",1),y([me(Oe.STATE_SUBSCRIBE,F.INIT,{success(){this.log.info("unsubscribed"),this.updatePlayingState(!1),E.emit(p.REMOTE_TRACK_UNSUBSCRIBED,{track:this})}})],Oe.prototype,"unsubscribe",1);var tr=class extends Oe{constructor(e,i){super(e,i,1);d(this,"volume",0);d(this,"mediaType",1);d(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,end2EndDelay:0,jitterBufferDelay:0})}getAudioLevel(){return this.volume||super.getAudioLevel()}get hasFlag(){return this.user.muteState.hasAudio&&!this.user.muteState.audioMuted}isFlagChanged(e){let i=e.hasAudio&&!e.audioMuted;return this.hasFlag||(this.volume=0),this.hasFlag!==i}};var Si=class extends Oe{constructor(e,i,s=4){super(e,i,s);d(this,"mediaType",4);d(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,end2EndDelay:0,jitterBufferDelay:0})}changeType(e){this.room.changeType(e,this.user)}get hasFlag(){return this.user.muteState.hasVideo&&!this.user.muteState.videoMuted}isFlagChanged(e){let i=e.hasVideo&&!e.videoMuted;return this.hasFlag!==i}},ir=class extends Si{constructor(e,i){super(e,i,2);d(this,"mediaType",2);d(this,"objectFit","contain")}get hasFlag(){return this.user.muteState.hasAuxiliary}isFlagChanged(e){let i=e.hasAuxiliary;return this.hasFlag!==i}};function ce(...r){}var kh=r=>r();function qn(){this.dispose()}var wh=()=>typeof __FASTRX_DEVTOOLS__!="undefined",xh=1,Rt=class extends Function{toString(){return`${this.name}(${this.args.length?[...this.args].join(", "):""})`}subscribe(t){let e=new Qn(t,this,this.streamId++);return Ye.subscribe({id:this.id,end:!1},{nodeId:e.sourceId,streamId:e.id}),this(e),e}},is=class{constructor(){this.defers=new Set,this.disposed=!1}next(t){}complete(){this.dispose()}error(t){this.dispose()}get bindDispose(){return()=>this.dispose()}dispose(){this.disposed=!0,this.complete=ce,this.error=ce,this.next=ce,this.dispose=ce,this.subscribe=ce,this.doDefer()}subscribe(t){return t instanceof Rt?t.subscribe(this):t(this),this}get bindSubscribe(){return t=>this.subscribe(t)}doDefer(){this.defers.forEach(kh),this.defers.clear()}defer(t){this.defers.add(t)}removeDefer(t){this.defers.delete(t)}reset(){this.disposed=!1,delete this.complete,delete this.next,delete this.dispose,delete this.next,delete this.subscribe}resetNext(){delete this.next}resetComplete(){delete this.complete}resetError(){delete this.error}},P=class extends is{constructor(t){super(),this.sink=t,t.defer(this.bindDispose)}next(t){this.sink.next(t)}complete(){this.sink.complete()}error(t){this.sink.error(t)}};function bd(r,...t){return t.reduce((e,i)=>i(e),r)}function Ct(r,t,e){if(wh()){let i=Object.defineProperties(Object.setPrototypeOf(r,Rt.prototype),{streamId:{value:0,writable:!0,configurable:!0},name:{value:t,writable:!0,configurable:!0},args:{value:e,writable:!0,configurable:!0},id:{value:0,writable:!0,configurable:!0}});Ye.create(i);for(let s=0;s<e.length;s++){let o=e[s];typeof o=="function"&&o instanceof Rt&&Ye.addSource(i,o)}return i}return r}function $(r,t){return function(...e){return i=>{if(i instanceof Rt){let s=Ct(o=>{let n=new r(o,...e);n.sourceId=s.id,n.subscribe(i)},t,arguments);return s.source=i,Ye.pipe(s),s}else return s=>i(new r(s,...e))}}}function Yt(r,t){window.postMessage({source:"fastrx-devtools-backend",payload:{event:r,payload:t}})}var Qn=class extends P{constructor(t,e,i){super(t),this.source=e,this.id=i,this.sourceId=t.sourceId,this.defer(()=>{Ye.defer(this.source,this.id)})}next(t){Ye.next(this.source,this.id,t),this.sink.next(t)}complete(){Ye.complete(this.source,this.id),this.sink.complete()}error(t){Ye.complete(this.source,this.id,t),this.sink.error(t)}},Ye={addSource(r,t){Yt("addSource",{id:r.id,name:r.toString(),source:{id:t.id,name:t.toString()}})},next(r,t,e){Yt("next",{id:r.id,streamId:t,data:e&&e.toString()})},subscribe({id:r,end:t},e){Yt("subscribe",{id:r,end:t,sink:{nodeId:e&&e.nodeId,streamId:e&&e.streamId}})},complete(r,t,e){Yt("complete",{id:r.id,streamId:t,err:e?e.toString():null})},defer(r,t){Yt("defer",{id:r.id,streamId:t})},pipe(r){Yt("pipe",{name:r.toString(),id:r.id,source:{id:r.source.id,name:r.source.toString()}})},update(r){Yt("update",{id:r.id,name:r.toString()})},create(r){r.id||(r.id=xh++),Yt("create",{name:r.toString(),id:r.id})}},po=class extends Error{constructor(t){super(`timeout after ${t}ms`),this.timeout=t}};var zn=class extends is{constructor(t){super(),this.source=t,this.sinks=new Set}add(t){t.defer(()=>this.remove(t)),this.sinks.add(t).size===1&&(this.reset(),this.subscribe(this.source))}remove(t){this.sinks.delete(t),this.sinks.size===0&&this.dispose()}next(t){this.sinks.forEach(e=>e.next(t))}complete(){this.sinks.forEach(t=>t.complete()),this.sinks.clear()}error(t){this.sinks.forEach(e=>e.error(t)),this.sinks.clear()}};function Eo(){return r=>{let t=new zn(r);if(r instanceof Rt){let e=Ct(i=>{t.add(i)},"share",arguments);return t.sourceId=e.id,e.source=r,Ye.pipe(e),e}return Ct(t.add.bind(t),"share",arguments)}}function Uh(...r){return Ct(t=>{let e=r.length,i=e,s=e,o=new Array(e),n=()=>{--s===0&&t.complete()},a=(c,l)=>{let u=new P(t);u.next=m=>{--i===0?(u.next=f=>{o[l]=f,t.next(o)},u.next(m)):o[l]=m},u.complete=n,u.subscribe(c)};r.forEach(a)},"combineLatest",arguments)}var Zn=class extends P{constructor(t,...e){super(t);let i=new P(this.sink);i.next=s=>this.buffer=s,i.complete=ce,i.subscribe(Uh(...e))}next(t){this.buffer&&this.sink.next([t,...this.buffer])}},lI=$(Zn,"withLatestFrom"),ea=class extends P{constructor(t,e,i){super(t),this.bufferSize=e,this.startBufferEvery=i,this.buffer=[],this.count=0,this.startBufferEvery&&(this.buffers=[[]])}next(t){this.startBufferEvery?(this.count++===this.startBufferEvery&&(this.buffers.push([]),this.count=1),this.buffers.forEach(e=>{e.push(t)}),this.buffers[0].length===this.bufferSize&&this.sink.next(this.buffers.shift())):(this.buffer.push(t),this.buffer.length===this.bufferSize&&(this.sink.next(this.buffer),this.buffer=[]))}complete(){this.buffer.length?this.sink.next(this.buffer):this.buffers.length&&this.buffers.forEach(t=>this.sink.next(t)),super.complete()}},uI=$(ea,"bufferCount"),ta=class extends P{constructor(t,e){super(t),this.buffer=[];let i=new P(t);i.next=s=>{t.next(this.buffer),this.buffer=[]},i.complete=ce,i.subscribe(e)}next(t){this.buffer.push(t)}complete(){this.buffer.length&&this.sink.next(this.buffer),super.complete()}},hI=$(ta,"buffer");function ia(r){let t=arguments,e=Eo()(Ct(i=>{e.next=s=>i.next(s),e.complete=()=>i.complete(),e.error=s=>i.error(s),r&&i.subscribe(r)},"subject",t));return e.next=ce,e.complete=ce,e.error=ce,e}function vd(r){return Ct(t=>{let e=0,i=setInterval(()=>t.next(e++),r);return t.defer(()=>{clearInterval(i)}),"interval"},"interval",arguments)}var ra=class extends P{constructor(t,e,i){super(t),this.f=e;let s=()=>{this.sink.next(this.acc),this.sink.complete()};typeof i=="undefined"?this.next=o=>{this.acc=o,this.complete=s,this.resetNext()}:(this.acc=i,this.complete=s)}next(t){this.acc=this.f(this.acc,t)}},Vh=$(ra,"reduce");var sa=class extends P{constructor(t,e,i){super(t),this.filter=e,this.thisArg=i}next(t){this.filter.call(this.thisArg,t)&&this.sink.next(t)}},Bh=$(sa,"filter"),oa=class extends P{next(t){}},RI=$(oa,"ignoreElements"),na=class extends P{constructor(t,e){super(t),this.count=e}next(t){this.sink.next(t),--this.count===0&&this.complete()}},$h=$(na,"take"),aa=class extends P{constructor(t,e){super(t);let i=new P(t);i.next=()=>t.complete(),i.complete=qn,i.subscribe(e)}},CI=$(aa,"takeUntil"),ca=class extends P{constructor(t,e){super(t),this.f=e}next(t){this.f(t)?this.sink.next(t):this.complete()}},Hh=$(ca,"takeWhile");var da=class extends P{constructor(t,e){super(t),this.count=e}next(t){--this.count===0&&(this.next=super.next)}},NI=$(da,"skip"),la=class extends P{constructor(t,e){super(t),t.next=ce;let i=new P(t);i.next=()=>{i.dispose(),t.resetNext()},i.complete=qn,i.subscribe(e)}},yI=$(la,"skipUntil"),ua=class extends P{constructor(t,e){super(t),this.f=e}next(t){this.f(t)||(this.next=super.next,this.next(t))}},Fh=$(ua,"skipWhile"),Gh={leading:!0,trailing:!1},ha=class extends P{constructor(t,e,i){super(t),this.durationSelector=e,this.trailing=i}cacheValue(t){this.last=t,this.disposed&&this.throttle(t)}send(t){this.sink.next(t),this.throttle(t)}throttle(t){this.reset(),this.subscribe(this.durationSelector(t))}next(){this.complete()}complete(){this.dispose(),this.trailing&&this.send(this.last)}},ma=class extends P{constructor(t,e,i=Gh){super(t),this.durationSelector=e,this.config=i,this._throttle=new ha(this.sink,this.durationSelector,this.config.trailing),this._throttle.dispose()}next(t){this._throttle.disposed&&this.config.leading?this._throttle.send(t):this._throttle.cacheValue(t)}complete(){this._throttle.throttle=ce,this._throttle.complete(),super.complete()}},OI=$(ma,"throttle");var _a=class extends P{next(){this.complete()}complete(){this.dispose(),this.sink.next(this.last)}},pa=class extends P{constructor(t,e){super(t),this.durationSelector=e,this._debounce=new _a(this.sink),this._debounce.dispose()}next(t){this._debounce.dispose(),this._debounce.reset(),this._debounce.last=t,this._debounce.subscribe(this.durationSelector(t))}complete(){this._debounce.complete(),super.complete()}},DI=$(pa,"debounce");var Ea=class extends P{constructor(t,e,i){super(t),this.count=e,this.defaultValue=i}next(t){this.count--===0&&(this.defaultValue=t,this.complete())}complete(){if(this.defaultValue===void 0){this.error(new Error("not enough elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},bI=$(Ea,"elementAt");var fa=class extends P{constructor(t,e){super(t),this.f=e,this.i=0}next(t){this.f(t)?(this.sink.next(this.i++),this.complete()):++this.i}},vI=$(fa,"findIndex"),Ta=class extends P{constructor(t,e,i){super(t),this.f=e,this.defaultValue=i,this.index=0}next(t){(!this.f||this.f(t,this.index++))&&(this.defaultValue=t,this.complete())}complete(){if(this.defaultValue===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},LI=$(Ta,"first"),Ia=class extends P{constructor(t,e,i){super(t),this.f=e,this.defaultValue=i,this.index=0}next(t){(!this.f||this.f(t,this.index++))&&(this.defaultValue=t)}complete(){if(this.defaultValue===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.defaultValue);super.complete()}},PI=$(Ia,"last"),Sa=class extends P{constructor(t,e){super(t),this.predicate=e,this.index=0}next(t){this.predicate(t,this.index++)?this.result=!0:(this.result=!1,this.complete())}complete(){if(this.result===void 0){this.error(new Error("no elements in sequence"));return}else this.sink.next(this.result);super.complete()}},MI=$(Sa,"every");var ga=class extends P{constructor(t,e,i){super(t),this.f=e,typeof i=="undefined"?this.next=s=>{this.acc=s,this.resetNext(),this.sink.next(this.acc)}:this.acc=i}next(t){this.sink.next(this.acc=this.f(this.acc,t))}},UI=$(ga,"scan"),Aa=class extends P{constructor(){super(...arguments),this.hasLast=!1}next(t){this.hasLast?this.sink.next([this.last,t]):this.hasLast=!0,this.last=t}},VI=$(Aa,"pairwise"),Ra=class extends P{constructor(t,e,i){super(t),this.mapper=e,this.thisArg=i}next(t){super.next(this.mapper.call(this.thisArg,t))}},Ld=$(Ra,"map");var rr=class extends P{constructor(t,e,i){super(t),this.data=e,this.context=i}next(t){let e=this.context.combineResults;e?this.sink.next(e(this.data,t)):this.sink.next(t)}tryComplete(){this.context.resetComplete(),this.dispose()}},sr=class extends P{constructor(t,e,i){super(t),this.makeSource=e,this.combineResults=i,this.index=0}subInner(t,e){let i=this.currentSink=new e(this.sink,t,this);this.complete=this.tryComplete,i.complete=i.tryComplete,i.subscribe(this.makeSource(t,this.index++))}tryComplete(){this.currentSink.resetComplete(),this.dispose()}},fo=class extends rr{},To=class extends sr{next(t){this.subInner(t,fo),this.next=e=>{this.currentSink.dispose(),this.subInner(e,fo)}}},Wh=$(To,"switchMap");function Ao(r){return(t,e)=>r(()=>t,e)}var BI=Ao($(To,"switchMapTo")),Ca=class extends rr{tryComplete(){this.dispose(),this.context.sources.length?this.context.subNext():(this.context.resetNext(),this.context.resetComplete())}},Io=class extends sr{constructor(){super(...arguments),this.sources=[],this.next2=this.sources.push.bind(this.sources)}next(t){this.next2(t),this.subNext()}subNext(){this.next=this.next2,this.subInner(this.sources.shift(),Ca),this.disposed&&this.sources.length===0&&this.currentSink.resetComplete()}tryComplete(){this.sources.length===0&&this.currentSink.resetComplete(),this.dispose()}},$I=$(Io,"concatMap"),HI=Ao($(Io,"concatMapTo")),Na=class extends rr{tryComplete(){this.context.inners.delete(this),super.dispose(),this.context.inners.size===0&&this.context.resetComplete()}},So=class extends sr{constructor(){super(...arguments),this.inners=new Set}next(t){this.subInner(t,Na),this.inners.add(this.currentSink)}tryComplete(){this.inners.size===1?this.inners.forEach(t=>t.resetComplete()):this.dispose()}},FI=$(So,"mergeMap"),GI=Ao($(So,"mergeMapTo")),ya=class extends rr{dispose(){this.context.resetNext(),super.dispose()}},go=class extends sr{next(t){this.next=ce,this.subInner(t,ya)}},WI=$(go,"exhaustMap"),KI=Ao($(go,"exhaustMapTo")),Oa=class extends P{constructor(t,e){super(t),this.f=e,this.groups=new Map}next(t){let e=this.f(t),i=this.groups.get(e);typeof i=="undefined"&&(i=ia(),i.key=e,this.groups.set(e,i),super.next(i)),i.next(t)}complete(){this.groups.forEach(t=>t.complete()),super.complete()}error(t){this.groups.forEach(e=>e.error(t)),super.error(t)}},JI=$(Oa,"groupBy"),Da=class extends P{constructor(){super(...arguments),this.start=new Date}next(t){this.sink.next({value:t,interval:Number(new Date)-Number(this.start)}),this.start=new Date}},jI=$(Da,"timeInterval"),ba=class extends P{constructor(t,e){super(t),this.miniseconds=e,this.buffer=[],this.id=setInterval(()=>{this.sink.next(this.buffer.concat()),this.buffer.length=0},this.miniseconds)}next(t){this.buffer.push(t)}complete(){this.sink.next(this.buffer),super.complete()}dispose(){clearInterval(this.id),super.dispose()}},YI=$(ba,"bufferTime"),va=class extends P{constructor(t,e){super(t),this.buffer=[],this.delayTime=e}dispose(){clearTimeout(this.timeoutId),super.dispose()}delay(t){this.timeoutId=setTimeout(()=>{let e=this.buffer.shift();if(e){let{time:i,data:s}=e;super.next(s),this.buffer.length&&this.delay(Number(this.buffer[0].time)-Number(i))}},t)}next(t){this.buffer.length||this.delay(this.delayTime),this.buffer.push({time:new Date,data:t})}complete(){this.timeoutId=setTimeout(()=>super.complete(),this.delayTime)}},XI=$(va,"delay"),La=class extends P{constructor(t,e){super(t),this.selector=e}error(t){this.dispose(),this.selector(t)(this.sink)}},QI=$(La,"catchError");var Pa=class extends P{constructor(t,e){super(t),e instanceof Function?this.next=i=>{e(i),t.next(i)}:(e.next&&(this.next=i=>{e.next(i),t.next(i)}),e.complete&&(this.complete=()=>{e.complete(),t.complete()}),e.error&&(this.error=i=>{e.error(i),t.error(i)}))}},eS=$(Pa,"tap"),Ma=class extends P{constructor(t,e){super(t),this.timeout=e,this.id=setTimeout(()=>this.error(new po(this.timeout)),this.timeout)}next(t){super.next(t),clearTimeout(this.id),this.next=super.next}dispose(){clearTimeout(this.id),super.dispose()}},tS=$(Ma,"timeout");var TS=bd(vd(250),Ld(()=>performance.now()),Eo());var or=new Map;E.on(p.JOIN_SUCCESS,({room:r})=>{ue(r.userId,{eventId:32788,eventDesc:"join room"})});E.on(p.LEAVE_START,({room:r})=>{ue(r.userId,{eventId:32789,eventDesc:"leave room"})});E.on(p.LOCAL_TRACK_PUBLISHED,({track:r})=>{if(r.room){let t=32769;r.mediaType===4?t=32768:r.mediaType===2&&(t=32805),ue(r.room.userId,{eventId:t,eventDesc:`publish ${r.kind}`})}});E.on(p.LOCAL_TRACK_UNPUBLISHED,({track:r})=>{if(r.room){let t=32771;r.mediaType===4?t=32770:r.mediaType===2&&(t=32806),ue(r.room.userId,{eventId:t,eventDesc:`unpublish ${r.kind}`})}});E.on(p.TRACK_MUTED,({track:r})=>{r.room&&(r.kind===h.AUDIO?ue(r.room.userId,{eventId:r.isRemote?32785:32772,eventDesc:"mute audio",remoteUserId:r.isRemote?r.userId:void 0}):ue(r.room.userId,{eventId:r.isRemote?32784:32773,eventDesc:"mute video",remoteUserId:r.isRemote?r.userId:void 0}))});E.on(p.TRACK_UNMUTED,({track:r})=>{r.room&&(r.kind===h.AUDIO?ue(r.room.userId,{eventId:r.isRemote?32787:32774,eventDesc:"unmute audio",remoteUserId:r.isRemote?r.userId:void 0}):ue(r.room.userId,{eventId:r.isRemote?32786:32775,eventDesc:"unmute video",remoteUserId:r.isRemote?r.userId:void 0}))});E.on(p.REMOTE_TRACK_SUBSCRIBED,({track:r})=>{!r.room||(r.mediaType===1&&ue(r.room.userId,{eventId:32777,eventDesc:`${h.SUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===4&&ue(r.room.userId,{eventId:32776,eventDesc:`${h.SUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===8&&ue(r.room.userId,{eventId:32803,eventDesc:`${h.SUBSCRIBE} ${h.SMALL_VIDEO}`,remoteUserId:r.userId}))});E.on(p.REMOTE_TRACK_UNSUBSCRIBED,({track:r})=>{!r.room||(r.mediaType===1&&ue(r.room.userId,{eventId:32779,eventDesc:`${h.UNSUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===4&&ue(r.room.userId,{eventId:32778,eventDesc:`${h.UNSUBSCRIBE} ${r.kind}`,remoteUserId:r.userId}),r.mediaType===8&&ue(r.room.userId,{eventId:32804,eventDesc:`${h.UNSUBSCRIBE} ${h.SMALL_VIDEO}`,remoteUserId:r.userId}))});E.on(p.SWITCH_DEVICE_SUCCESS,({track:r})=>{r.room&&ue(r.room.userId,{eventId:r.kind===h.VIDEO?32780:32781,eventDesc:`switch ${r.kind===h.VIDEO?"camera":"microphone"}`})});E.on(p.LOCAL_TRACK_REPLACED,({track:r})=>{r.room&&ue(r.room.userId,{eventId:r.kind===h.VIDEO?32782:32783,eventDesc:`replace ${r.kind}`})});E.on(p.SIGNAL_CONNECTION_STATE_CHANGED,({room:r,prevState:t,state:e})=>{let i,s;switch(e){case"CONNECTED":t==="RECONNECTING"?(i=32795,s="signal reconnected"):(i=32791,s="signal connected");break;case"DISCONNECTED":t==="RECONNECTING"?(i=32796,s="signal reconnect fail"):(i=32790,s="signal disconnected");break;case"RECONNECTING":i=32794,s="signal reconnecting";break}i&&s&&ue(r.userId,{eventId:i,eventDesc:s})});E.on(p.PEER_CONNECTION_STATE_CHANGED,({room:r,prevState:t,state:e,remoteUserId:i})=>{let s=!!i,o=s?"downlink":"uplink",n,a;switch(e){case"CONNECTED":t==="RECONNECTING"?(n=s?32801:32798,a=`${o} reconnected`):(n=s?32793:32792,a=`${o} connected`);break;case"DISCONNECTED":t==="RECONNECTING"&&(n=s?32802:32799,a=`${o} reconnect fail`);break;case"RECONNECTING":n=s?32800:32797,a=`${o} reconnecting`;break}n&&a&&ue(r.userId,{eventId:n,eventDesc:a,remoteUserId:i})});function ue(r,t){let e=k(R({},t),{timestamp:fr()});or.has(r)?or.get(r).push(e):or.set(r,[e])}function Pd(r){if(or.has(r)){let t=or.get(r).map(e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc}));return or.delete(r),t}return[]}var Md=Ne(Me(),1);var Ro=class extends Md.EventEmitter{constructor(e,i,s="userId"){super();this.mySelfId=e;this._log=i;this.key=s;d(this,"userMap",new Map);d(this,"remotePublishedUserMap",new Map)}getPublishedUser(e){return this.remotePublishedUserMap.get(e)}addUser(e){let i=e[this.key],{userId:s,tinyId:o,role:n}=e;if(this.userMap.has(i))return;let a={userId:s,tinyId:o,role:n===20?"anchor":"audience"};this.userMap.set(i,a),this.emit("1",a)}deleteUser(e,i){let s=this.userMap.get(e);if(!s)return;let o=`peer leave [${e}]`;T(i)||(o+=`:${pn[i]}`),this._log.info(o);let n=this.remotePublishedUserMap.get(e);if(n){let a=n.muteState;n.flag=0,this.emit("5",n.userId),this.deleteRemotePublishedUser(e),this.emit("6",{prevMuteState:a,muteState:n.muteState,flag:0})}this.userMap.delete(e),this.emit("2",s.userId)}setUserList(e){this.userMap.forEach(i=>{e.findIndex(s=>s[this.key]===i[this.key])<0&&this.deleteUser(i[this.key],0)}),e.forEach(i=>{!this.userMap.has(i[this.key])&&i[this.key]!==this.mySelfId&&this.addUser(i)})}addRemotePublishedUser(e){this.remotePublishedUserMap.has(e[this.key])||this.remotePublishedUserMap.set(e[this.key],e)}deleteRemotePublishedUser(e){!this.remotePublishedUserMap.has(e)||this.remotePublishedUserMap.delete(e)}setRemotePublishedUserList(e){this.remotePublishedUserMap.forEach(i=>{let s=i[this.key];if(e.findIndex(o=>o[this.key]===i[this.key])<0){this._log.info(`remote [${s}] unpublish`);let o=i.muteState;i.flag=0,this.emit("5",i.userId),this.deleteRemotePublishedUser(s),this.emit("6",{prevMuteState:o,muteState:i.muteState,flag:0})}}),e.forEach(i=>{var u;let s=i[this.key];if(s===this.mySelfId)return;let{flag:o,userId:n,tinyId:a}=i,c=Bt(o,n),l=(u=this.remotePublishedUserMap.get(s))==null?void 0:u.muteState;if(l){let m=this.remotePublishedUserMap.get(s);m&&m.flag!==o&&(m.flag=o,this._log.info(`remote publish updated: ${JSON.stringify(m.muteState)}`),this.emit("6",{prevMuteState:l,muteState:c,flag:o}))}else this._log.info(`remote publish. state: ${JSON.stringify(c)}`),this.addUser({userId:n,tinyId:a,role:20}),this.emit("3",i),this.emit("6",{prevMuteState:Bt(0,n),muteState:c,flag:o})})}clear(){this.userMap.clear(),this.remotePublishedUserMap.clear()}};function kd({timesInSecond:r,maxSizeInSecond:t,getSize:e}){return W((i,s)=>{let o=new Map;return E.on(p.ROOM_DESTROY,({room:n})=>o.delete(n)),function(...n){let a=o.get(this);if(a||(a={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},o.set(this,a)),a.timestamp===0?a.timestamp=Date.now():Date.now()-a.timestamp>1e3&&(a.timestamp=Date.now(),a.callCountInSecond=0,a.totalSizeInSecond=0),e&&(a.totalSizeInSecond+=e(...n)),a.timestamp!==0&&Date.now()-a.timestamp<1e3&&(a.callCountInSecond>=r||a.totalSizeInSecond>t))throw new A({code:I.INVALID_OPERATION,message:b({key:C.CALL_FREQUENCY_LIMIT,data:{isTimes:a.callCountInSecond>=r,isSize:a.totalSizeInSecond>t,name:s,timesInSecond:r,maxSizeInSecond:t}})});a.callCountInSecond++,i.call(this,...n)}})}var wd=!0,xd=function(){var r;wd&&(wd=!1,g.getLogLevel()!==5&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info(`*   API Document: ${ze}/en/index.html`),console.info(`*   Changelog: ${ze}/en/tutorial-01-info-changelog.html`),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),g.info("TRTC Web SDK Version:",Ie),g.info("UA:",navigator.userAgent),g.info(`URL: ${location.href}${((r=self.frameElement)==null?void 0:r.tagName)==="IFRAME"?" in iframe":""}`),Lr().then(t=>{if(t){let e=`UAData: ${t.platform}/${t.platformVersion}`;t.architecture&&t.bitness&&(e+=` ${t.architecture}/${t.bitness}`),t.mobile&&(e+=" mobile"),t.model&&(e+=` model: ${t.model}`),t.fullVersionList&&(e+=` ${t.fullVersionList.filter(i=>i.brand!=="Not/A)Brand").map(i=>`${i.brand}/${i.version}`).join(",")}`),g.info(e)}}))};var rs={SCENE_LIVE:"live",SCENE_RTC:"rtc",ROLE_ANCHOR:"anchor",ROLE_AUDIENCE:"audience",STREAM_TYPE_MAIN:"main",STREAM_TYPE_SUB:"sub",AUDIO_PROFILE_STANDARD:"standard",AUDIO_PROFILE_STANDARD_STEREO:"standard-stereo",AUDIO_PROFILE_HIGH:"high",AUDIO_PROFILE_HIGH_STEREO:"high-stereo",QOS_PREFERENCE_SMOOTH:"smooth",QOS_PREFERENCE_CLEAR:"clear"};var U={INVALID_PARAMETER:5e3,INVALID_OPERATION:5100,ENV_NOT_SUPPORTED:5200,DEVICE_ERROR:5300,SERVER_ERROR:5400,OPERATION_FAILED:5500,OPERATION_ABORT:5998,UNKNOWN_ERROR:5999},Xt=(S=>(S[S.INVALID_PARAMETER=5e3]="INVALID_PARAMETER",S[S.INVALID_PARAMETER_REQUIRED=5001]="INVALID_PARAMETER_REQUIRED",S[S.INVALID_PARAMETER_TYPE=5002]="INVALID_PARAMETER_TYPE",S[S.INVALID_PARAMETER_EMPTY=5003]="INVALID_PARAMETER_EMPTY",S[S.INVALID_PARAMETER_INSTANCE=5004]="INVALID_PARAMETER_INSTANCE",S[S.INVALID_PARAMETER_RANGE=5005]="INVALID_PARAMETER_RANGE",S[S.INVALID_PARAMETER_LESS_THAN_ZERO=5006]="INVALID_PARAMETER_LESS_THAN_ZERO",S[S.INVALID_PARAMETER_MIN=5007]="INVALID_PARAMETER_MIN",S[S.INVALID_PARAMETER_MAX=5008]="INVALID_PARAMETER_MAX",S[S.INVALID_ELEMENT_ID=5009]="INVALID_ELEMENT_ID",S[S.INVALID_ELEMENT_ID_TYPE=5010]="INVALID_ELEMENT_ID_TYPE",S[S.INVALID_STREAM_ID=5011]="INVALID_STREAM_ID",S[S.INVALID_ROOM_ID_STRING=5012]="INVALID_ROOM_ID_STRING",S[S.INVALID_ROOM_ID_INTEGER=5013]="INVALID_ROOM_ID_INTEGER",S[S.INVALID_STREAM_TYPE=5014]="INVALID_STREAM_TYPE",S[S.INVALID_ROOM_ID_REQUIED=5015]="INVALID_ROOM_ID_REQUIED",S[S.INVALID_ROOM_ID_INTEGER_STRING=5016]="INVALID_ROOM_ID_INTEGER_STRING",S[S.INVALID_OPERATION=5100]="INVALID_OPERATION",S[S.INVALID_OPERATION_NOT_JOINED=5101]="INVALID_OPERATION_NOT_JOINED",S[S.INVALID_OPERATION_REMOTE_USER_NOT_EXIST=5102]="INVALID_OPERATION_REMOTE_USER_NOT_EXIST",S[S.INVALID_OPERATION_STREAM_TYPE_NOT_EXIST=5103]="INVALID_OPERATION_STREAM_TYPE_NOT_EXIST",S[S.INVALID_OPERATION_REPEAT_CALL=5104]="INVALID_OPERATION_REPEAT_CALL",S[S.ENV_NOT_SUPPORTED=5200]="ENV_NOT_SUPPORTED",S[S.NOT_SUPPORTED_HTTP=5201]="NOT_SUPPORTED_HTTP",S[S.NOT_SUPPORTED_WEBRTC=5202]="NOT_SUPPORTED_WEBRTC",S[S.NOT_SUPPORTED_H264_ENCODE=5203]="NOT_SUPPORTED_H264_ENCODE",S[S.NOT_SUPPORTED_H264_DECODE=5204]="NOT_SUPPORTED_H264_DECODE",S[S.NOT_SUPPORTED_SCREEN_SHARE=5205]="NOT_SUPPORTED_SCREEN_SHARE",S[S.NOT_SUPPORTED_SMALL_VIDEO=5206]="NOT_SUPPORTED_SMALL_VIDEO",S[S.NOT_SUPPORTED_SEI=5207]="NOT_SUPPORTED_SEI",S[S.DEVICE_ERROR=5300]="DEVICE_ERROR",S[S.DEVICE_NOT_FOUND_ERROR=5301]="DEVICE_NOT_FOUND_ERROR",S[S.DEVICE_NOT_ALLOWED_ERROR=5302]="DEVICE_NOT_ALLOWED_ERROR",S[S.DEVICE_NOT_READABLE_ERROR=5303]="DEVICE_NOT_READABLE_ERROR",S[S.DEVICE_OVERCONSTRAINED_ERROR=5304]="DEVICE_OVERCONSTRAINED_ERROR",S[S.DEVICE_INVALID_STATE_ERROR=5305]="DEVICE_INVALID_STATE_ERROR",S[S.DEVICE_SECURITY_ERROR=5306]="DEVICE_SECURITY_ERROR",S[S.DEVICE_ABORT_ERROR=5307]="DEVICE_ABORT_ERROR",S[S.CAMERA_RECOVER_FAILED=5308]="CAMERA_RECOVER_FAILED",S[S.MICROPHONE_RECOVER_FAILED=5309]="MICROPHONE_RECOVER_FAILED",S[S.SERVER_ERROR=5400]="SERVER_ERROR",S[S.ACCOUNT_NO_MONEY=-100013]="ACCOUNT_NO_MONEY",S[S.OPERATION_FAILED=5500]="OPERATION_FAILED",S[S.FIREWALL_RESTRICTION=5501]="FIREWALL_RESTRICTION",S[S.REJOIN_FAILED=5502]="REJOIN_FAILED",S[S.EVENT_HANDLER_ERROR=5503]="EVENT_HANDLER_ERROR",S[S.OPERATION_ABORT=5998]="OPERATION_ABORT",S[S.UNKNOWN_ERROR=5999]="UNKNOWN_ERROR",S))(Xt||{});function Vd({code:r,params:t,enableDocLink:e=!1}){let i="",s,o=Xt[r];try{s=Ud[o]}catch(n){s=Ud.UNKNOWN_ERROR}return j(s)?i=s(t):X(s)&&(i=s),e&&(i+=" doc:"),i}var Ud=k(R({},le),{INVALID_PARAMETER({fnName:r}){return`the parameters of the '${r}' you called does not meet the requirements, please check the API documentation.`},INVALID_PARAMETER_REQUIRED({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' is a required param when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_TYPE({key:r,rule:t,fnName:e,value:i}){let s=`${r||t.name}`,o="";return Array.isArray(t.type)?o=t.type.join("|"):o=t.type,`'${s}' must be type of ${o} when calling ${e}(), received type: ${ie(i)}.`},INVALID_PARAMETER_EMPTY({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' cannot be '${i}' when calling ${e}().`},INVALID_PARAMETER_INSTANCE({key:r,rule:t,fnName:e,value:i}){let s=`${r||t.name}`,o=`${t.instanceOf.name||t.instanceOf}`;return`'${s}' must be instanceof ${o} when calling ${e}(), received type: ${ie(i)}.`},INVALID_PARAMETER_RANGE({key:r,rule:t,fnName:e,value:i}){return`'${r||t.name}' must be one of ${t.values.join("|")} when calling ${e}(), received: ${i}.`},INVALID_PARAMETER_LESS_THAN_ZERO({key:r,rule:t,fnName:e}){return`'${r||t.name}' cannot be less than 0 when calling ${e}().`},INVALID_PARAMETER_MIN({key:r,rule:t,value:e}){return`the min value of ${r||t.name} is ${t.min}, received: ${e}.`},INVALID_PARAMETER_MAX({key:r,rule:t,value:e}){return`the max value of ${r||t.name} is ${t.max}, received: ${e}.`},INVALID_ELEMENT_ID({key:r,fnName:t}){return`'${r}' is not found in the document object when calling ${t}().`},INVALID_ELEMENT_ID_TYPE({key:r,fnName:t,type:e}){return`the element corresponding to '${r}' must be instanceof HTMLElement when calling ${t}(), received: ${e}.`},INVALID_STREAM_ID({key:r}){return`'${r}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},INVALID_ROOM_ID_STRING({key:r}){return`'${r}' must be a valid string.`},INVALID_ROOM_ID_INTEGER({key:r}){return`'${r}' must be an integer between [1, 4294967294].`},INVALID_ROOM_ID_INTEGER_STRING({key:r}){return`'${r}' must be an integer but go a string, use 'parseInt' to convert it or use 'strRoomId' instead.`},INVALID_ROOM_ID_REQUIED(){return"at least one of 'roomId'(between [1, 4294967294]) and 'strRoomId'(not empty) is required."},INVALID_STREAM_TYPE:({fnName:r})=>`'streamType' is required when 'userId' is not '*', calling ${r}()`,MIX_PARAMS_USER_Z_ORDER({key:r}){return`'${r}' is required and must be between 1 and 15.`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_OPERATION({fnName:r}){return`the API '${r}' you called does not meet the requirements, please check the API documentation.`},INVALID_OPERATION_NOT_JOINED({fnName:r}){return`cannot ${r} because you are not enter room yet.`},INVALID_OPERATION_REMOTE_USER_NOT_EXIST({fnName:r,value:t}){return`cannot ${r} because remote user(userId: ${t.userId}) does not publishing stream.`},INVALID_OPERATION_STREAM_TYPE_NOT_EXIST({fnName:r,value:t}){return`cannot ${r} because remote user(userId: ${t.userId}) does not publishing ${t.streamType} video.`},INVALID_OPERATION_REPEAT_CALL({fnName:r}){return`you are already ${r}(), cannot repeated call '${r}'.`},ENV_NOT_SUPPORTED({fnName:r}){return`the current browser does not support the capability of the function '${r}' you are calling, please check the API documentation.`},NOT_SUPPORTED_WEBRTC:"the current browser does not support WebRTC capability, please check the SDK documentation.",NOT_SUPPORTED_H264_ENCODE:"this browser does not support H264 encode.",NOT_SUPPORTED_H264_DECODE:"this browser does not support H264 decode.",NOT_SUPPORTED_SCREEN_SHARE:"this browser does not support screen share, please check the browser version.",NOT_SUPPORTED_SMALL_VIDEO:"this browser does not support small video, please check the browser version.",NOT_SUPPORTED_SEI:"this browser does not support SEI, please check the browser version.",DEVICE_ERROR({fnName:r,error:t}){return`'${r}' got server exception${t?`, error: ${t.toString()}.`:"."}`},DEVICE_NOT_FOUND_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`NotFoundError, no ${t} detected, please check your device and the configuration on '${r}'${e?`, error: ${e.toString()}.`:"."}`},DEVICE_NOT_ALLOWED_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`NotAllowedError, you have disabled ${t} access, please allow the current application to use the ${t}${e?`, error: ${e.toString()}.`:"."}`},DEVICE_NOT_READABLE_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`NotReadableError, the ${t} maybe in use by another APP, please check if the device is pre-occupied by another APP.`},DEVICE_OVERCONSTRAINED_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`OverconstrainedError, the device ID is incorrect, please check whether the device ID passed in is correct${e?`, error: ${e.toString()}.`:"."}`},DEVICE_INVALID_STATE_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`InvalidStateError, after the user clicks and interacts with the page, turn on the ${t}${e?`, error: ${e.toString()}.`:"."}`},DEVICE_SECURITY_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`SecurityError, check whether the system security policy restricts the use of the ${t}, and it is recommended to turn on the ${t} after the user interacts with the page${e?`, error: ${e.toString()}.`:"."}`},DEVICE_ABORT_ERROR({fnName:r,deviceType:t=gi(r),error:e}){return`AbortError, an unknown exception in the system makes the device unusable, recommended to change the device or browser and re-check whether the device is normal${e?` error: ${e.toString()}.`:"."}`},CAMERA_RECOVER_FAILED({error:r}){return`camera recover capture failed ${(r==null?void 0:r.name)||""}: ${(r==null?void 0:r.originMessage)||(r==null?void 0:r.message)}`},MICROPHONE_RECOVER_FAILED({error:r}){return`microphone recover capture failed ${(r==null?void 0:r.name)||""}: ${(r==null?void 0:r.originMessage)||(r==null?void 0:r.message)}`},OPERATION_FAILED({fnName:r,error:t}){return`'${r}' failed, reason: ${t==null?void 0:t.toString()}`},FIREWALL_RESTRICTION(){return"media connection failure due to firewall restrictions, please try to change your network."},EVENT_HANDLER_ERROR({eventName:r}){return`an error was caught on trtc.on('${r}', handler), please check your code on 'handler'.`},SERVER_ERROR({fnName:r,error:t}){return`'${r}' got server error: ${t==null?void 0:t.toString()}, please check the SDK documentation.`},ACCOUNT_NO_MONEY:({fnParams:r})=>`your TRTC account run out of credit, please recharge.${r.sdkAppId?` SDKAppId: ${r.sdkAppId}`:""}`,OPERATION_ABORT({fnName:r}){return`'${r}' abort`},UNKNOWN_ERROR({fnName:r,error:t}){return`'${r}' throw unknown exception${t?`, error: ${t.toString()}.`:"."}`}});function gi(r){if(!r)return"camera";let t=r.toLowerCase();return t.includes("screen")?"screen share":t.includes("audio")?"microphone":"camera"}var nr=class extends Error{constructor({code:e,extraCode:i,message:s="",messageParams:o,fnName:n="",originError:a}){let c;s?c=s:c=Vd({code:i||e,params:R({fnName:n,error:a},o)});super(c);d(this,"name","RtcError");d(this,"code");d(this,"extraCode");d(this,"functionName");d(this,"message");d(this,"originError");this.name=Xt[e],this.code=e,this.extraCode=i,this.functionName=n,this.originError=a,this.message=c}static convertFrom(e,i,s){let o=e;if(e instanceof A){let{stack:n}=e,a={code:U.UNKNOWN_ERROR,fnName:i,originError:e};switch(e.getCode()){case I.INVALID_PARAMETER:a.code=U.INVALID_PARAMETER;break;case I.INVALID_OPERATION:a.code=U.INVALID_OPERATION;break;case I.NOT_SUPPORTED:case I.NOT_SUPPORTED_H264:a.code=U.ENV_NOT_SUPPORTED,e.getCode()===I.NOT_SUPPORTED_H264&&(a.extraCode=e.message.includes(le.NOT_SUPPORTED_H264ENCODE)?5203:5204);break;case I.DEVICE_NOT_FOUND:case I.DEVICE_AUTO_RECOVER_FAILED:a.code=U.DEVICE_ERROR;break;case I.JOIN_ROOM_FAILED:a.messageParams={fnParams:s};case I.SERVER_TIMEOUT:case I.SWITCH_ROLE_FAILED:a.code=U.SERVER_ERROR,a.extraCode=e.getExtraCode();break;case I.API_CALL_ABORTED:a.code=U.OPERATION_ABORT;break;case I.INITIALIZE_FAILED:a.code=5300,a.extraCode=Kh(e.name);break;case I.UNKNOWN:break;default:a.code=U.OPERATION_FAILED}o=new nr(a),n&&(o.stack+=n.substr(n.indexOf(`
`)))}else o=new nr({code:U.UNKNOWN_ERROR,fnName:i,originError:e});return o}};function Kh(r){let t;switch(r){case"NotFoundError":t=5301;break;case"NotAllowedError":t=5302;break;case"NotReadableError":t=5303;break;case"OverconstrainedError":t=5304;break;case"InvalidStateError":t=5305;break;case"SecurityError":t=5306;break;case"AbortError":t=5307;break;default:t=5300}return t}var L=nr;var Bd={type:"object",properties:{cameraId:{type:"string"},useFrontCamera:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"},small:{properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack}}},$d={type:"object",properties:{systemAudio:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},profile:{type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack},audioTrack:{instanceOf:MediaStreamTrack}}},ar={type:["string",HTMLElement,null,"array"],arrayItem:{instanceOf:HTMLElement},validate(r,t,e){if(X(r)){let i=document.getElementById(r);if(!i)throw new L({code:U.INVALID_PARAMETER,extraCode:5009,fnName:e,messageParams:{key:t}});if(!(i instanceof HTMLElement))throw new L({code:U.INVALID_PARAMETER,extraCode:5010,fnName:e,messageParams:{key:t,type:ie(i)}})}}},Hd={name:"userId",required:!0,type:"string"},Fd={type:"object",properties:{microphoneId:{type:"string"},audioTrack:{instanceOf:MediaStreamTrack},captureVolume:{type:"number",min:0,max:100},earMonitorVolume:{type:"number",min:0,max:100},echoCancellation:{type:"boolean"},autoGainControl:{type:"boolean"},noiseSuppression:{type:"boolean"}}};function No(r,t){if(!r)throw new L({code:U.INVALID_OPERATION,extraCode:5101,fnName:t})}function Gd(r,t,e){if(!r)throw new L({code:U.INVALID_OPERATION,extraCode:5102,fnName:t,messageParams:{value:e}})}var hA={type:"number",notLessThanZero:!0},Jh={create:[{name:"RoomConfig",instanceOf:Function},{name:"CreateConfig",type:"object",properties:{plugins:{type:"array",arrayItem:{instanceOf:Function}}}}],enterRoom:{name:"EnterRoomConfig",type:"object",required:!0,validate(r,t,e){if(this._room.isJoined)throw new L({code:U.INVALID_OPERATION,extraCode:5104,fnName:e});if(r.roomId){if(X(r.roomId))throw new L({code:U.INVALID_PARAMETER,extraCode:5016,fnName:e,messageParams:{key:t}});if(!(/^[1-9]\d*$/.test(String(r.roomId))&&r.roomId<4294967295))throw new L({code:U.INVALID_PARAMETER,extraCode:5013,fnName:e,messageParams:{key:t}})}else if(r.strRoomId){if(!/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(r.strRoomId))throw new L({code:U.INVALID_PARAMETER,extraCode:5012,fnName:e,messageParams:{key:t}})}else throw new L({code:U.INVALID_PARAMETER,extraCode:5015,fnName:e})},properties:{sdkAppId:{required:!0,type:"number",allowEmpty:!1},userId:{required:!0,type:"string",allowEmpty:!1},userSig:{required:!0,type:"string",allowEmpty:!1},scene:{type:"string",values:["live","rtc"]},role:{type:"string",values:["audience","anchor"]},roomId:{type:["string","number"]},strRoomId:{type:"string"},proxy:{type:["object","string"],properties:{websocketProxy:{type:"string"},turnServer:{type:["object","array"],properties:{url:{required:!0,type:"string"},username:{type:"string"},credential:{type:"string"},credentialType:{type:"string",values:["password"]}}},loggerProxy:{type:"string"},webtransportProxy:{type:"string"}}},enableAutoPlayDialog:{type:"boolean"},userDefineRecordId:{type:"string"}}},startLocalVideo:{name:"LocalVideoConfig",type:"object",properties:{view:ar,publish:{type:"boolean"},option:Bd},validate(r){var t;if(!((t=r==null?void 0:r.option)!=null&&t.videoTrack)&&Ft())throw new L({code:U.ENV_NOT_SUPPORTED,extraCode:5201})}},updateLocalVideo:{name:"updateLocalVideoConfig",type:"object",required:!0,properties:{view:k(R({},ar),{required:!1}),publish:{type:"boolean"},mute:{type:"boolean"},option:Bd}},startLocalAudio:{name:"LocalAudioConfig",type:"object",properties:{publish:{type:"boolean"},option:Fd},validate(r){var t;if(!((t=r==null?void 0:r.option)!=null&&t.audioTrack)&&Ft())throw new L({code:U.ENV_NOT_SUPPORTED,extraCode:5201})}},updateLocalAudio:{name:"updateLocalAudioConfig",type:"object",required:!0,properties:{publish:{type:"boolean"},mute:{type:"boolean"},option:Fd}},startScreenShare:{name:"ScreenShareConfig",type:"object",properties:{view:ar,publish:{type:"boolean"},option:$d},validate(r,t,e,i,s){var o;if(!((o=r==null?void 0:r.option)!=null&&o.videoTrack)&&Ft())throw new L({code:U.ENV_NOT_SUPPORTED,extraCode:5201});if(!Wr())throw new L({code:U.ENV_NOT_SUPPORTED,fnName:e,extraCode:5205})}},updateScreenShare:{name:"updateScreenShareConfig",type:"object",required:!0,properties:{view:ar,publish:{type:"boolean"},option:$d}},muteRemoteAudio:[Hd,{name:"mute",required:!0,type:"boolean"}],setRemoteAudioVolume:[Hd,{name:"volume",required:!0,type:"number",min:0}],startRemoteVideo:{name:"startRemoteVideoConfig",type:"object",required:!0,properties:{view:ar,userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(r,t,e){No(this._room.isJoined,e);let i=this._room.remotePublishedUserMap.get(r.userId);if(Gd(!!i,e,r),i&&(r.streamType==="main"&&!i.muteState.videoAvailable||r.streamType==="sub"&&!i.muteState.hasAuxiliary))throw new L({code:U.INVALID_OPERATION,extraCode:5103,fnName:e,messageParams:{value:r}})}},updateRemoteVideo:{name:"updateRemoteVideoConfig",type:"object",required:!0,properties:{view:k(R({},ar),{required:!1}),userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(r,t,e){No(this._room.isJoined,e);let i=this._room.remotePublishedUserMap.get(r.userId);if(Gd(!!i,e,r),i&&(r.streamType==="main"&&!i.muteState.videoAvailable||r.streamType==="sub"&&!i.muteState.hasAuxiliary))throw new L({code:U.INVALID_OPERATION,extraCode:5103,fnName:e,messageParams:{value:r}})}},stopRemoteVideo:{name:"stopRemoteVideoConfig",type:"object",required:!0,properties:{userId:{type:"string",required:!0},streamType:{values:["main","sub"]}},validate(r,t,e){if(r.userId!=="*"&&T(r.streamType))throw new L({code:U.INVALID_PARAMETER,extraCode:5014,fnName:e})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate(r,t,e){No(this._room.isJoined,e)}},enableAudioVolumeEvaluation:[{name:"interval",type:"number"},{name:"enableInBackground",type:"boolean"}],sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate(r,t,e,i){if(!Wt)throw new L({code:U.ENV_NOT_SUPPORTED,fnName:e,extraCode:5207});if(!this._room.enableSEI)throw new L({code:U.INVALID_OPERATION,messageParams:{key:C.SEI_DISABLED}});if(r.byteLength>1e3)throw new L({code:U.INVALID_PARAMETER,messageParams:{key:C.SEI_OVERSIZE,data:r.byteLength}});if(r.byteLength===0)throw new L({code:U.INVALID_PARAMETER,messageParams:{key:C.SEI_EMPTY}});if(No(this._room.isJoined,e),!this._room.isMainStreamPublished)throw new L({code:U.INVALID_PARAMETER,messageParams:{key:C.SEI_BEFORE_PUBLISH}})}},{name:"options",type:"object",properties:{seiPayloadType:{type:"number",values:[5,243]}}}]},pe={TRTC:Jh};var fe=class extends Error{};function jh(r,t){let e=[];return it(e,r),it(e,t),e}function Yh(r){this._resolve=Promise.resolve(r)}function Xh(r){this._reject=Promise.reject(r)}var cr=class{constructor(t,e){this.instance=t;this.group=e;this.started=!1;this.ops=[];this.startSame=()=>!0;this.mergeUpdate=jh;let i=cr.instances.get(t);i?i.set(e,this):cr.instances.set(t,new Map([[e,this]]))}static get(t,e){let i=cr.instances.get(t);return i&&i.get(e)||new cr(t,e)}action(t,e,i){let s=a=>{var c;return t===0?this.started=!0:t===3&&(this.started=!1),this.ops.shift(),(c=this.currentOp)==null||c.action(),a},o=a=>{var c,l;throw this.ops.shift(),t===0&&((c=this.currentOp)==null?void 0:c.type)===2&&this.ops.shift().reject(new fe("start failed")),(l=this.currentOp)==null||l.action(),a},n={type:t,action:()=>e(...n.args).then(s,o),args:i,resolve:Yh,reject:Xh};try{switch(this.state){case 1:if(t===0)throw new fe("already started");break;case 4:if(t===2)throw new fe("not started");break;default:return this.cacheOp(n)}}catch(a){return Promise.reject(a)}return this.ops.push(n),n.promise=e(...n.args).then(s,o)}cacheOp(t){if(this.ops.length===1)switch(this.state){case 0:case 2:if(t.type===0)throw new fe("already start");break;case 3:switch(t.type){case 2:throw new fe("update not allowed when stopping");case 3:return this.currentOp.promise}break;default:throw new fe("unknown state")}else switch(t.type){case 3:switch(this.lastOpType){case 3:return this.lastOp.promise;default:let i=new fe("keep stop");if(this.ops.slice(1).forEach(s=>s.reject(i)),this.ops=this.ops.slice(0,1),this.state===3)return this.currentOp.promise}break;case 2:switch(this.lastOpType){case 2:return this.lastOp.args=this.mergeUpdate(this.lastOp.args,t.args),this.lastOp.promise;case 3:throw new fe("update not allowed after stop")}break;case 0:switch(this.lastOpType){case 2:throw new fe("start not allowed after update");case 0:throw new fe("duplicate start");case 3:if(this.startSame(this.currentOp.args,t.args))throw this.ops.pop().reject(new fe("keep start")),new fe("already start")}}t.promise=new Promise((i,s)=>{t._resolve?t._resolve.then(i):t.resolve=i,t._reject?t._reject.catch(s):t.reject=s});let{action:e}=t;return t.action=()=>e().then(t.resolve,t.reject),this.ops.push(t),t.promise}get lastOp(){return this.ops[this.ops.length-1]}get lastOpType(){return this.lastOp.type}get currentOp(){return this.ops[0]}get state(){return this.currentOp?this.currentOp.type:this.started?1:4}},yt=cr;yt.instances=new WeakMap;var ka=(r,t)=>{if(t instanceof fe){let{stack:e}=t;t=new L({code:U.OPERATION_ABORT,message:`${r} abort: ${t.message}`,fnName:r}),e&&(t.stack+=e.substr(e.indexOf(`
`)))}throw t};function Qt(r,t){return W((e,i)=>function(...s){let o=yt.get(this,typeof r=="string"?r:r.call(this,...s));return t&&(o.startSame=t.bind(this)),o.action(0,e.bind(this),s).catch(ka.bind(null,i))})}function Ai(r,t){return W((e,i)=>function(...s){let o=yt.get(this,typeof r=="string"?r:r.call(this,...s));return t&&(o.mergeUpdate=t.bind(this)),o.action(2,e.bind(this),s).catch(ka.bind(null,i))})}function qt(r){return W((t,e)=>function(...i){return yt.get(this,typeof r=="string"?r:r.call(this,...i)).action(3,t.bind(this),i).catch(ka.bind(null,e))})}var M={ERROR:"error",AUTOPLAY_FAILED:"autoplay-failed",KICKED_OUT:"kicked-out",REMOTE_USER_ENTER:"remote-user-enter",REMOTE_USER_EXIT:"remote-user-exit",REMOTE_AUDIO_AVAILABLE:"remote-audio-available",REMOTE_AUDIO_UNAVAILABLE:"remote-audio-unavailable",REMOTE_VIDEO_AVAILABLE:"remote-video-available",REMOTE_VIDEO_UNAVAILABLE:"remote-video-unavailable",AUDIO_VOLUME:"audio-volume",NETWORK_QUALITY:"network-quality",CONNECTION_STATE_CHANGED:"connection-state-changed",AUDIO_PLAY_STATE_CHANGED:"audio-play-state-changed",VIDEO_PLAY_STATE_CHANGED:"video-play-state-changed",SCREEN_SHARE_STOPPED:"screen-share-stopped",DEVICE_CHANGED:"device-changed",PUBLISH_STATE_CHANGED:"publish-state-changed",SEI_MESSAGE:"sei-message"};function Jd(r){return r==="sub"?"auxiliary":r==="auxiliary"?"sub":"main"}function ss(r){return r===rs.QOS_PREFERENCE_CLEAR?"detail":r===rs.QOS_PREFERENCE_SMOOTH?"motion":""}function yo(r){return{room:r,innerEmitter:E,constants:fn,environment:oi,utils:Se,eventLogger:z,log:r.getLogger(),clearStarted(t,e){let i=t.getAlias(),s=yt.instances.get(r);if(!!s)if(e){let o=s.get(i+e);if(!o)return;o.started=!1}else s.forEach((o,n)=>{n.startsWith(i)&&(o.started=!1)})}}}var jd=(r,t)=>{let{emit:e}=r;return r.emit=(...i)=>{try{return e.apply(r,i)}catch(s){let o=b({key:C.CATCH_HANDLER_ERROR,data:{name:t,event:i[0]},addDocLink:!1});return g.warn(`${o}

${s.stack}`),!1}},r};var Oo=new WeakMap;function Yd(r,t){return W((e,i)=>function(...s){var a,c;let o=(a=Oo.get(this))==null?void 0:a.get(t(...s));o&&o>0&&clearTimeout(o);let n=window.setTimeout(()=>{e.apply(this,s)},r);Oo.has(this)?(c=Oo.get(this))==null||c.set(t(...s),n):Oo.set(this,new Map([[t(...s),n]]))})}var Xd="5.1.3";function Ae(...r){return W((t,e)=>function(...i){try{bo.call(this,r,i,e,this._name)}catch(s){return Promise.reject(s)}return t.apply(this,i)})}function wa(...r){return W((t,e)=>function(...i){try{bo.call(this,r,i,e,this._name)}catch(s){throw s}return t.apply(this,i)})}function bo(r,t,e,i){if(he(r))for(let s=0;s<r.length;s++)Do.call(this,{rule:r[s],value:t[s],key:r[s].name,fnName:e,className:i});else Do.call(this,{rule:r,value:t[0],key:r.name,fnName:e,className:i})}function Do({rule:r,value:t,key:e,fnName:i,className:s}){function o(c){return{code:U.INVALID_PARAMETER,extraCode:c,fnName:i,messageParams:{key:e,rule:r,value:t}}}if(T(t)){if(r.required)throw new L(o(5001));if(T(r.defaultValue)){j(r.validate)&&r.validate.call(this,t,e,i,s,this);return}t=r.defaultValue}if(Array.isArray(r.type)){let c=!1;for(let l=0;l<r.type.length;l++)r.type[l]===null&&t===null&&(c=!0),j(r.type[l])&&t instanceof r.type[l]&&(c=!0),X(r.type[l])&&ie(t)===r.type[l].toLowerCase()&&(c=!0);if(!c)throw new L({code:U.INVALID_PARAMETER,extraCode:5002,fnName:i,messageParams:{key:e,rule:{type:r.type.map(l=>Hr(l)?Zs(l):X(l)?l:ie(l))},value:t}})}else if(!T(r.type)&&ie(t)!==r.type)throw new L(o(5002));if(r.allowEmpty===!1){let c=Q(t)&&(t===0||Number.isNaN(t)),l=X(t)&&t.trim()==="";if(c||l)throw new L(o(5003))}if(r.notLessThanZero&&Q(t)&&t<0)throw new L(o(5006));if(!T(r.min)&&Q(t)&&t<r.min)throw new L(o(5007));if(!T(r.max)&&Q(t)&&t>r.max)throw new L(o(5008));if(X(r.instanceOf)){if(!t||t._name!==r.instanceOf)throw new L(o(5004))}else if(j(r.instanceOf)&&!(t instanceof r.instanceOf))throw new L(o(5004));if(Array.isArray(r.values)&&!r.values.includes(t))throw new L(o(5005));let{properties:n}=r;ft(n)&&hi(t)&&Object.keys(n).forEach(c=>{Do.call(this,{rule:n[c],value:t&&t[c],key:`${c}`,fnName:i,className:s})});let{arrayItem:a}=r;ft(a)&&he(t)&&t.forEach((c,l)=>{Do.call(this,{rule:a,value:c,key:`${e}[${l}]`,fnName:i,className:s})}),j(r.validate)&&r.validate.call(this,t,e,i,s,this)}function de(r=()=>""){return W((t,e)=>function(...i){let s=this._log||loggerManager;i.length>0?s.info(`${e}() ${JSON.stringify(i,(o,n)=>{if(n===i||o in i)return n;try{return n instanceof HTMLElement?`id: ${n.id} type:${ie(n)}`:(JSON.stringify(n),n)}catch(a){return`type:${ie(n)}`}})}`):s.info(`${e}()`);try{let o=t.apply(this,i),n=V();return $r(o)?o.then(a=>(s.info(`${e}() success ${r.call(this,...i)}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:e,cost:V()-n}),a)).catch(a=>{throw a=L.convertFrom.call(this,a,e,i.length===1?i[0]:i),s.error(`${e}() failed ${r.call(this,...i)} ${a}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:e,error:a}),a}):(E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:e,cost:V()-n}),o)}catch(o){throw o=L.convertFrom.call(this,o,e),s.error(`${e}() failed ${o}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:e,error:o}),o}})}var vo=r=>W((t,e)=>function(i,s){return _(this,null,function*(){let o=this._plugins.get(i);if(!o){this._log.warn(`plugin ${i} is not found`);return}return bo.call(this,o.getValidateRule(r),[s],e,"TRTC"),t.call(this,o,s)})});var os=class{constructor(t){this.core=t;this.core=t}getName(){return"AudioMixer"}getAlias(){return"ax"}getGroup(t){return t==null?void 0:t.id}getValidateRule(t){switch(t){case"start":return os.startValidateRule;case"update":return os.updateValidateRule;case"stop":return os.stopValidateRule}}start(t){return _(this,null,function*(){let{room:e}=this.core;if(yield e.audioManager.addMusicSource(t),e.isJoined)for(let i of e.localTracks)i instanceof be&&(yield e.replaceTrack(i))})}update(t){return _(this,null,function*(){let{room:e}=this.core;yield e.audioManager.updateMusicSource(t)})}stop(t){return _(this,null,function*(){let{room:e}=this.core;yield e.audioManager.removeMusicSource(t)})}},Ri=os;d(Ri,"startValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},url:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"}},validate(t,e,i){if(t.url!=="*"){let s=["mp3","ogg","wav","flac"],o=t.url.split(".").pop(),n=s.indexOf(o)>=0,a=t.url.startsWith("blob"),c=t.url.startsWith("data");if(!(n||a||c))throw new L({code:U.INVALID_PARAMETER,message:"start audioMixer plugin: music url is invalid, please check your file format.",fnName:i})}}}),d(Ri,"updateValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"},seekFrom:{type:"number"},operation:{type:"string",values:["pause","resume","stop"]}}}),d(Ri,"stopValidateRule",{name:"options",type:"object",required:!0,properties:{id:{type:"string",required:!0}}});var ns=class{constructor(t){this.core=t;this.core=t}getName(){return"AIDenoiser"}getAlias(){return"ad"}getGroup(t){return`AIDenoiser_${Date.now()}`}getValidateRule(t){switch(t){case"start":return ns.startValidateRule;case"update":return ns.updateValidateRule;case"stop":return ns.stopValidateRule}}start(t){return _(this,null,function*(){let{room:e}=this.core,{assetsPath:i,sdkAppId:s,userId:o,userSig:n}=t;if(i&&!e.audioManager.isDenoiserInit)try{yield e.audioManager.initDenoiser({assetsPath:i,sdkAppId:s,userId:o,userSig:n})}catch(a){if(a.message)throw new A({code:I.INVALID_PARAMETER,message:a.message})}if(yield e.audioManager.enableDenoiser(t),e.isJoined)for(let a of e.localTracks)a instanceof be&&(yield e.replaceTrack(a))})}update(t){return _(this,null,function*(){})}stop(t){return _(this,null,function*(){let{room:e}=this.core;yield e.audioManager.disableDenoiser()})}},Ci=ns;d(Ci,"startValidateRule",{name:"options",required:!0,type:"object",properties:{assetsPath:{type:"string",required:!0},sdkAppId:{type:"number",required:!0},userId:{type:"string",required:!0},userSig:{type:"string",required:!0}}}),d(Ci,"updateValidateRule",{type:"object"}),d(Ci,"stopValidateRule",{type:"object"});var qh=0,xa=new Set,ve=null;en(Xd);var as=class extends qd.EventEmitter{constructor(e,i){super();d(this,"_room");d(this,"_eventListened",new Set);d(this,"_localVideoTrack",null);d(this,"_localAudioTrack",null);d(this,"_localScreenTrack",null);d(this,"_localScreenAudioTrack",null);d(this,"_localVideoConfig",null);d(this,"_localScreenConfig",null);d(this,"_localAudioConfig",null);d(this,"_remoteVideoConfigMap",new Map);d(this,"_remoteAudioConfigMap",new Map);d(this,"_remoteAudioMuteMap",new Map);d(this,"_log",g.createLogger({id:`t${++qh}`}));d(this,"_plugins",new Map);this._room=new e(R({logger:this._log,frameWorkType:as.frameWorkType},i)),i.plugins&&i.plugins.forEach(n=>{let a=new n(yo(this._room));this._plugins.set(a.getName(),a)});let s=new Ri(yo(this._room));this._plugins.set(s.getName(),s);let o=new Ci(yo(this._room));this._plugins.set(o.getName(),o),this._room.on("audio-volume",n=>{!n.find(a=>a.userId==="")&&this._localAudioTrack&&n.push({userId:"",volume:Math.floor(this._localAudioTrack.getAudioLevel()*100)}),this.emit(M.AUDIO_VOLUME,{result:n.sort((a,c)=>c.volume-a.volume)})}),this.on(M.REMOTE_AUDIO_UNAVAILABLE,({userId:n})=>{this._stopRemoteAudio({userId:n},!1).catch(()=>{})}),this.on(M.REMOTE_VIDEO_UNAVAILABLE,({userId:n,streamType:a})=>{this._stopRemoteVideo({userId:n,streamType:a},!1).catch(()=>{})}),xe(re,re).add("audioInputAdded",n=>{this.emit(M.DEVICE_CHANGED,{type:"microphone",action:"add",device:n})}).add("audioInputRemoved",n=>{this.emit(M.DEVICE_CHANGED,{type:"microphone",action:"remove",device:n})}).add("videoInputAdded",n=>{this.emit(M.DEVICE_CHANGED,{type:"camera",action:"add",device:n})}).add("videoInputRemoved",n=>{this.emit(M.DEVICE_CHANGED,{type:"camera",action:"remove",device:n})}).add("audioOutputAdded",n=>_(this,null,function*(){if(this.emit(M.DEVICE_CHANGED,{type:"speaker",action:"add",device:n}),ve&&ve.deviceId===Vr){let a=(yield er()).find(c=>c.deviceId===Vr);a&&ve.groupId!==a.groupId&&(ve=a,this.emit(M.DEVICE_CHANGED,{type:"speaker",action:"active",device:a}))}})).add("audioOutputRemoved",n=>_(this,null,function*(){this.emit(M.DEVICE_CHANGED,{type:"speaker",action:"remove",device:n});let a=(yield er())[0];a&&ve&&(ve.deviceId===n.deviceId||ve.deviceId===Vr&&ve.groupId!==a.groupId)&&(ve=a,this.emit(M.DEVICE_CHANGED,{type:"speaker",action:"active",device:a}))})),jd(this,"trtc")}static create(e){}static _create(e,i){xd();let s=new as(e,i||{});return xa.add(s),ve?s.emit(M.DEVICE_CHANGED,{type:"speaker",action:"active",device:ve}):er().then(o=>{o[0]&&(ve=o[0],s.emit(M.DEVICE_CHANGED,{type:"speaker",action:"active",device:o[0]}))}),s}enterRoom(e){return _(this,null,function*(){var c,l;let{scene:i="rtc",enableAutoPlayDialog:s=!0,autoReceiveAudio:o=!0,autoReceiveVideo:n=!0}=e;e.proxy&&(this._room.setProxyServer(e.proxy),!X(e.proxy)&&e.proxy.turnServer&&((l=(c=this._room).setTurnServer)==null||l.call(c,e.proxy.turnServer,e.proxy.iceTransportPolicy))),this._room.enableAutoPlayDialog=s,this._room.autoReceiveAudio=o,this._room.autoReceiveVideo=n,te(e.enableHWEncoder)&&(this._room.enableHWEncoder=e.enableHWEncoder);let a={sdkAppId:e.sdkAppId,userId:e.userId,userSig:e.userSig,privateMapKey:e.privateMapKey||null,role:e.role==="audience"?21:20,roomId:e.roomId||0,strRoomId:e.strRoomId||"",businessInfo:e.businessInfo||null,streamId:null,userDefineRecordId:e.userDefineRecordId||null,frameWorkType:e.frameWorkType,component:e.component,language:e.language};e.strRoomId&&!e.roomId&&(this._room.useStringRoomId=!0),xe(this,this._room).add("peer-join",u=>{let{userId:m}=u;this.emit(M.REMOTE_USER_ENTER,{userId:m})}).add("peer-leave",u=>{this.emit(M.REMOTE_USER_EXIT,{userId:u})}).add("banned",u=>{this._exitRoom().then(()=>{this.emit(M.KICKED_OUT,{reason:u.reason})})}).add("error",u=>{this._exitRoom().then(()=>{this.emit(M.ERROR,L.convertFrom(u))})}).add("signal-connection-state-changed",u=>{this.emit(M.CONNECTION_STATE_CHANGED,u)}).add("network-quality",u=>{this.emit(M.NETWORK_QUALITY,u)}).add("remote-published",u=>{[u.remoteAudioTrack,u.remoteVideoTrack,u.remoteAuxiliaryTrack].forEach(f=>{xe(f,f).add("player-state-changed",O=>{let N=k(R({},O),{userId:u.userId});f.kind===h.VIDEO&&(N.streamType=Jd(f.streamType)),this.emit(f.kind===h.AUDIO?M.AUDIO_PLAY_STATE_CHANGED:M.VIDEO_PLAY_STATE_CHANGED,N)}).add("error",O=>{O.getCode()===I.PLAY_NOT_ALLOWED&&this.emit(M.AUTOPLAY_FAILED,{userId:f.userId})})})}).add("remote-unpublished",u=>{[u.remoteAudioTrack,u.remoteVideoTrack,u.remoteAuxiliaryTrack].forEach(f=>{_e(f)})}).add("remote-publish-state-changed",({prevMuteState:u,muteState:m})=>{let{userId:f}=m,O=this._room.remotePublishedUserMap.get(f),N=u.audioAvailable,w=u.videoAvailable,{audioAvailable:oe,videoAvailable:Lt}=m;oe||this._remoteAudioConfigMap.delete(f),Lt||this._remoteVideoConfigMap.delete(`${f}_${"main"}`),m.hasAuxiliary||this._remoteVideoConfigMap.delete(`${f}_${"sub"}`),N!==oe&&this.emit(oe?M.REMOTE_AUDIO_AVAILABLE:M.REMOTE_AUDIO_UNAVAILABLE,{userId:f}),w!==Lt&&this.emit(Lt?M.REMOTE_VIDEO_AVAILABLE:M.REMOTE_VIDEO_UNAVAILABLE,{userId:f,streamType:"main"}),u.hasAuxiliary!==m.hasAuxiliary&&this.emit(m.hasAuxiliary?M.REMOTE_VIDEO_AVAILABLE:M.REMOTE_VIDEO_UNAVAILABLE,{userId:f,streamType:"sub"})}).add("firewall-restriction",()=>{this.emit(M.ERROR,new L({code:U.OPERATION_FAILED,extraCode:5501}))}).add("sei-message",u=>{this.emit(M.SEI_MESSAGE,u)}),this._handleReceiveMode(),yield this._room.join(a,i,as.frameWorkType),this._checkTrackToPublish()})}exitRoom(){return _(this,null,function*(){return yield this._exitRoom()})}switchRole(e){return _(this,null,function*(){yield this._room.switchRole(e),e==="anchor"&&this._checkTrackToPublish()})}destroy(){_e(re),this.removeAllListeners(),this._room.destroy(),xa.delete(this),this._localAudioTrack&&this.stopLocalAudio(),this._localVideoTrack&&this.stopLocalVideo(),this._localScreenTrack&&this.stopScreenShare()}startLocalAudio(){return _(this,arguments,function*(e={publish:!0}){if(this._localAudioTrack){this._log.warn("local audio is already started");return}let{publish:i=!0,option:s}=e,o=new be,n={},a={muted:!0};s&&(T(s.microphoneId)?T(s.audioTrack)||(n.customSource=s.audioTrack):n.deviceId=s.microphoneId,T(s.captureVolume),T(s.profile)||(X(s.profile)?Ws[s.profile]&&o.setProfile(Ws[s.profile]):o.setProfile(s.profile)),Q(s.earMonitorVolume)&&(a.muted=!(s.earMonitorVolume>0),a.volume=s.earMonitorVolume),T(s.echoCancellation)||(o.profile.echoCancellation=s.echoCancellation),T(s.noiseSuppression)||(o.profile.noiseSuppression=s.noiseSuppression),T(s.autoGainControl)||(o.profile.autoGainControl=s.autoGainControl)),o.on("5",c=>{this.emit(M.ERROR,new L({code:U.DEVICE_ERROR,extraCode:5309,messageParams:{error:c}}))}),o.on("2",c=>{this.emit(M.DEVICE_CHANGED,{type:"microphone",action:"active",device:c})}),o.on("4",c=>{let l;c.error&&(l=L.convertFrom(c.error)),this.emit(M.PUBLISH_STATE_CHANGED,k(R({},c),{error:l}))}),yield o.capture(n),xe(o,o).add("player-state-changed",c=>{this.emit(M.AUDIO_PLAY_STATE_CHANGED,k(R({},c),{userId:""}))}),yield this._updateAudioPlayOption({playOption:a,track:o}),i&&this._room.isJoined&&this._room.publish(o).catch(()=>{}),this._localAudioTrack=o,this._localAudioConfig=k(R({},e),{publish:i})})}updateLocalAudio(e){return _(this,null,function*(){if(!this._localAudioTrack||!this._localAudioConfig)return;let{publish:i,mute:s,option:o}=e,n={};o&&(o.microphoneId?yield this._localAudioTrack.switchDevice(o.microphoneId):T(o.audioTrack)||(this._localAudioTrack.setMediaStreamTrack(o.audioTrack),yield this._room.replaceTrack(this._localAudioTrack)),T(o.captureVolume),T(o.earMonitorVolume)||(n.muted=!(o.earMonitorVolume>0),n.volume=o.earMonitorVolume)),yield this._updateAudioPlayOption({playOption:n,track:this._localAudioTrack,prevConfig:this._localAudioConfig}),this._room.isJoined&&!T(i)&&(i&&!this._localAudioConfig.publish&&this._room.publish(this._localAudioTrack).catch(()=>{}),this._localAudioConfig.publish&&!i&&this._room.unpublish(this._localAudioTrack).catch(()=>{})),T(s)||this._localAudioTrack.setMute(s),it(this._localAudioConfig,e)})}stopLocalAudio(){return _(this,null,function*(){!this._localAudioTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localAudioTrack).catch(()=>{})),this._localAudioTrack.stop(),this._localAudioTrack.close(),_e(this._localAudioTrack),this._localAudioTrack=null,this._localAudioConfig=null)})}startLocalVideo(){return _(this,arguments,function*(e={publish:!0,view:null}){if(this._localVideoTrack){this._log.warn("local video is already started");return}let{view:i,publish:s=!0,option:o}=e,n=new je,a={},c={};if(o&&(o.cameraId?a.deviceId=o.cameraId:T(o.useFrontCamera)?T(o.videoTrack)||(a.customSource=o.videoTrack):a.facingMode=o.useFrontCamera?h.FACING_MODE_USER:h.FACING_MODE_ENVIRONMENT,T(o.profile)||(X(o.profile)?_t[o.profile]&&n.setProfile(_t[o.profile]):n.setProfile(o.profile)),T(o.fillMode)||(c.objectFit=o.fillMode),T(o.mirror)||(c.mirror=o.mirror),T(o.small)||(so()?X(o.small)?n.small=_t[o.small]:n.small=o.small:this._log.warn("small stream is not supported"))),n.on("5",l=>{this.emit(M.ERROR,new L({code:U.DEVICE_ERROR,extraCode:5308,messageParams:{error:l}}))}),n.on("2",l=>{this.emit(M.DEVICE_CHANGED,{type:"camera",action:"active",device:l})}),n.on("4",l=>{let u;l.error&&(u=L.convertFrom(l.error)),this.emit(M.PUBLISH_STATE_CHANGED,k(R({},l),{error:u}))}),yield n.capture(a),(o==null?void 0:o.qosPreference)&&n.mediaTrack){let l=ss(o.qosPreference);n.mediaTrack.contentHint=l}xe(n,n).add("player-state-changed",l=>{this.emit(M.VIDEO_PLAY_STATE_CHANGED,k(R({},l),{userId:"",streamType:"main"}))}),yield this._updateVideoPlayOption({view:i,playOption:c,track:n}),s&&this._room.isJoined&&this._room.publish(n).catch(()=>{}),this._localVideoTrack=n,this._localVideoConfig=k(R({},e),{view:i,publish:s})})}updateLocalVideo(e){return _(this,null,function*(){if(!this._localVideoTrack||!this._localVideoConfig)return;let{view:i,publish:s,mute:o,option:n}=e,a={};if(n&&(n.cameraId?yield this._localVideoTrack.switchDevice(n.cameraId):T(n.useFrontCamera)?T(n.videoTrack)||(this._localVideoTrack.setMediaStreamTrack(n.videoTrack),yield this._room.replaceTrack(this._localVideoTrack)):yield this._localVideoTrack.switchDevice(n.useFrontCamera?h.FACING_MODE_USER:h.FACING_MODE_ENVIRONMENT),T(n.profile)||(X(n.profile)?_t[n.profile]&&this._localVideoTrack.setProfile(_t[n.profile]):this._localVideoTrack.setProfile(n.profile)),T(n.fillMode)||(a.objectFit=n.fillMode),T(n.mirror)||(a.mirror=n.mirror),n.qosPreference&&this._localVideoTrack.mediaTrack)){let c=ss(n.qosPreference);this._localVideoTrack.mediaTrack.contentHint=c}yield this._updateVideoPlayOption({view:i,playOption:a,track:this._localVideoTrack,prevConfig:this._localVideoConfig}),this._room.isJoined&&!T(s)&&(s&&!this._localVideoConfig.publish&&this._room.publish(this._localVideoTrack).catch(()=>{}),this._localVideoConfig.publish&&!s&&this._room.unpublish(this._localVideoTrack).catch(()=>{})),T(o)||this._localVideoTrack.setMute(o),it(this._localVideoConfig,e)})}stopLocalVideo(){return _(this,null,function*(){!this._localVideoTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localVideoTrack).catch(()=>{})),this._localVideoTrack.stop(),this._localVideoTrack.close(),_e(this._localVideoTrack),this._localVideoTrack=null,this._localVideoConfig=null)})}startScreenShare(){return _(this,arguments,function*(e={publish:!0,view:null}){if(this._localScreenTrack){this._log.warn("screen share is already started");return}let{view:i=null,publish:s=!0,option:o}=e,n=new at;n.on("4",m=>{let f;m.error&&(f=L.convertFrom(m.error)),this.emit(M.PUBLISH_STATE_CHANGED,k(R({},m),{error:f}))});let a=null;n.setMediaType(2);let c={},l={};o&&(T(o.profile)||(X(o.profile)?Ks[o.profile]&&n.setProfile(Ks[o.profile]):n.setProfile(o.profile)),o.systemAudio&&(c.systemAudio=!0,c.echoCancellation=o.echoCancellation,c.noiseSuppression=o.noiseSuppression,c.autoGainControl=o.autoGainControl),T(o.fillMode)||(l.objectFit=o.fillMode),o.videoTrack&&(c.videoTrack=o.videoTrack),o.audioTrack&&(c.audioTrack=o.audioTrack));let u=yield n.capture(c);if(o!=null&&o.qosPreference){let m=ss(o.qosPreference);n.mediaTrack.contentHint=m}if(n.mediaTrack.addEventListener(h.ENDED,()=>{this._stopScreenShare(),this.emit(M.SCREEN_SHARE_STOPPED)}),u.getAudioTracks()[0]&&(a=new Ti,a.setScreenAudioTrack(u.getAudioTracks()[0],u)),xe(n,n).add("player-state-changed",m=>{this.emit(M.VIDEO_PLAY_STATE_CHANGED,k(R({},m),{userId:"",streamType:"sub"}))}),yield this._updateVideoPlayOption({view:i,playOption:l,track:n}),s&&this._room.isJoined){let m=[n];a&&m.push(a),this._room.publish(...m).catch(()=>{})}this._localScreenTrack=n,this._localScreenAudioTrack=a,this._localScreenConfig=k(R({},e),{view:i,publish:s})})}updateScreenShare(e){return _(this,null,function*(){if(!this._localScreenTrack||!this._localScreenConfig)return;let{view:i,publish:s,option:o}=e,n={};if(o&&(T(o.fillMode)||(n.objectFit=o.fillMode),o.qosPreference)){let a=ss(o.qosPreference);this._localScreenTrack.mediaTrack.contentHint=a}yield this._updateVideoPlayOption({view:i,playOption:n,track:this._localScreenTrack,prevConfig:this._localScreenConfig}),this._room.isJoined&&!T(s)&&(s&&!this._localScreenConfig.publish&&this._room.publish(this._localScreenTrack).catch(()=>{}),this._localScreenConfig.publish&&!s&&this._room.unpublish(this._localScreenTrack).catch(()=>{})),it(this._localScreenConfig,e)})}stopScreenShare(){return _(this,null,function*(){return yield this._stopScreenShare()})}startRemoteVideo(e){return _(this,null,function*(){let{view:i,userId:s,streamType:o,option:n}=e,a=`${s}_${o}`;if(this._remoteVideoConfigMap.has(a)){this._log.warn(`remote video has already started. userId:${s}, streamType:${o}`);return}let c=this._room.remotePublishedUserMap.get(s);if(!c)return;let l={},u=o==="main"?c.remoteVideoTrack:c.remoteAuxiliaryTrack;n&&(T(n.fillMode)||(l.objectFit=n.fillMode),T(n.mirror)||(l.mirror=n.mirror),o==="main"&&!T(n.small)&&this._room.changeType(n.small,u.user)),yield this._room.subscribe(u),yield this._updateVideoPlayOption({view:i,playOption:l,track:u}),this._remoteVideoConfigMap.set(a,e)})}updateRemoteVideo(e){return _(this,null,function*(){let{view:i,userId:s,streamType:o,option:n}=e,a=`${s}_${o}`;if(!this._remoteVideoConfigMap.has(a)||!this._room.remotePublishedUserMap.has(s))return;let c={};n&&(T(n.fillMode)||(c.objectFit=n.fillMode),T(n.mirror)||(c.mirror=n.mirror));let l=null,u=this._room.remotePublishedUserMap.get(s);o==="main"&&(u==null?void 0:u.muteState.hasVideo)&&(l=u.remoteVideoTrack),o==="sub"&&(u==null?void 0:u.muteState.hasAuxiliary)&&(l=u.remoteAuxiliaryTrack);let m=this._remoteVideoConfigMap.get(a);l&&(o==="main"&&n&&!T(n.small)&&this._room.changeType(n.small,l.user),yield this._updateVideoPlayOption({view:i,playOption:c,track:l,prevConfig:m})),it(m,e)})}stopRemoteVideo(e){return _(this,null,function*(){return this._stopRemoteVideo(e)})}_stopRemoteVideo(e,i=!0){return _(this,null,function*(){let s=[],o=this._room.remotePublishedUserMap.get(e.userId);if(o){let{muteState:n,remoteVideoTrack:a,remoteAuxiliaryTrack:c}=o;e.streamType==="main"&&(a.stop(),n.hasVideo&&s.push(a)),e.streamType==="sub"&&(c.stop(),n.hasAuxiliary&&s.push(c))}for(let n of s)i&&(yield this._room.unsubscribe(n));this._remoteVideoConfigMap.delete(`${e.userId}_${e.streamType}`)})}muteRemoteAudio(e,i){return _(this,null,function*(){if(e==="*")if(i)yield this._stopRemoteAudio({userId:e});else{let s=[...this._room.remotePublishedUserMap.values()];for(let o of s)o.muteState.hasAudio&&(yield this._startRemoteAudio({userId:o.userId}))}else i?yield this._stopRemoteAudio({userId:e}):yield this._startRemoteAudio({userId:e});this._remoteAudioMuteMap.set(e,i)})}setRemoteAudioVolume(e,i){if(e==="*"){let s=[...this._room.remotePublishedUserMap.values()];for(let o of s)this._updateAudioPlayOption({playOption:{volume:i},track:o.remoteAudioTrack})}else if(e){let s=this._room.remotePublishedUserMap.get(e);s&&this._updateAudioPlayOption({playOption:{volume:i},track:s.remoteAudioTrack})}}startPlugin(e,i){return _(this,null,function*(){return e.start(i)})}updatePlugin(e,i){return _(this,null,function*(){return e.update(i)})}stopPlugin(e,i){return _(this,null,function*(){return e.stop(i)})}enableAudioVolumeEvaluation(e=2e3,i=!1){this._room.enableAudioVolumeEvaluation(e,i)}on(e,i,s){return super.on(e,i,s),this._eventListened.add(e),this}off(e,i,s){return e==="*"?(this._eventListened.clear(),this.removeAllListeners()):super.off(e,i,s),this}getVideoTrack(e={userId:"",streamType:"main"}){let{userId:i="",streamType:s="main"}=e;if(i===""){if(s==="main"&&this._localVideoTrack)return this._localVideoTrack.mediaTrack;if(s==="sub"&&this._localScreenTrack)return this._localScreenTrack.mediaTrack}else{let o=this._room.remotePublishedUserMap.get(i);if(o)return s==="main"?o.remoteVideoTrack.mediaTrack:o.remoteAuxiliaryTrack.mediaTrack}return null}getAudioTrack(e){if(e){let i=this._room.remotePublishedUserMap.get(e);if(i)return i.remoteAudioTrack.mediaTrack}else if(this._localAudioTrack)return this._localAudioTrack.mediaTrack;return null}setCurrentSpeaker(e){var i;(i=this._localAudioTrack)==null||i.setAudioOutput(e),this._room.remotePublishedUserMap.forEach(s=>s.remoteAudioTrack.setAudioOutput(e))}_startRemoteAudio(e){return _(this,null,function*(){let{userId:i,option:s}=e;if(this._remoteAudioConfigMap.has(i)){this._log.warn(`remote audio has already started. userId:${i}`);return}let o=this._room.remotePublishedUserMap.get(i);if(!o)return;let n={};s&&(T(s.volume)||(n.volume=s.volume));let a=o.remoteAudioTrack;yield this._room.subscribe(a),yield this._updateAudioPlayOption({playOption:n,track:a}),this._remoteAudioConfigMap.set(i,e)})}_stopRemoteAudio(e,i=!0){return _(this,null,function*(){let s=this._room.remotePublishedUserMap.get(e.userId);s&&(s.remoteAudioTrack.stop(),s.muteState.hasAudio&&i&&(yield this._room.unsubscribe(s.remoteAudioTrack))),this._remoteAudioConfigMap.delete(`${e.userId}`)})}_updateVideoPlayOption(n){return _(this,arguments,function*({view:e,playOption:i,track:s,prevConfig:o}){if(T(e)&&o&&o.view&&!Fr(i)){let a;he(o.view)?a=o.view:a=eo(o.view),a&&(yield s.play(a,i))}if(!T(e)){let a;he(e)?a=e:a=eo(e),a?yield s.play(a,i):s.stop()}})}_updateAudioPlayOption(o){return _(this,arguments,function*({playOption:e={},track:i,prevConfig:s}){i.isPlayCalled||(yield i.play(null,e)),T(e.muted)||i.setPlayerMute(e.muted),T(e.volume)||i.setAudioVolume(e.volume/100)})}_checkTrackToPublish(){var i,s,o;let e=[];if(((i=this._localAudioConfig)==null?void 0:i.publish)&&this._localAudioTrack&&e.push(this._localAudioTrack),((s=this._localVideoConfig)==null?void 0:s.publish)&&this._localVideoTrack&&e.push(this._localVideoTrack),(o=this._localScreenConfig)!=null&&o.publish&&(this._localScreenTrack&&e.push(this._localScreenTrack),this._localScreenAudioTrack&&e.push(this._localScreenAudioTrack)),e.length!==0)return this._room.publish(...e).catch(()=>{})}_handleReceiveMode(){this._room.autoReceiveAudio&&xe(this,this).add(M.REMOTE_AUDIO_AVAILABLE,i=>_(this,[i],function*({userId:e}){if(this._remoteAudioMuteMap.get("*")||this._remoteAudioMuteMap.get(e))return;let s=this._room.remotePublishedUserMap.get(e);s&&(yield this._room.subscribe(s.remoteAudioTrack).catch(()=>{}),yield this._updateAudioPlayOption({track:s.remoteAudioTrack}).catch(()=>{}),this._remoteAudioConfigMap.set(e,{userId:e}))})),this._room.autoReceiveVideo&&xe(this,this).add(M.REMOTE_VIDEO_AVAILABLE,({userId:e,streamType:i})=>{let s=this._room.remotePublishedUserMap.get(e);s&&(i==="main"?this._room.subscribe(s.remoteVideoTrack).catch(()=>{}):i==="sub"&&this._room.subscribe(s.remoteAuxiliaryTrack).catch(()=>{}))})}_exitRoom(){return _(this,null,function*(){this._room.isJoined&&(yield this._room.leave()),[...this._remoteAudioConfigMap.keys()].forEach(e=>{this._stopRemoteAudio({userId:e}).catch()}),[...this._remoteVideoConfigMap.keys()].forEach(e=>{let i=e.includes("main")?"main":"sub",s=e.split(`_${i}`)[0];s&&this._stopRemoteVideo({userId:s,streamType:i}).catch()}),this._remoteVideoConfigMap.clear(),this._remoteAudioConfigMap.clear(),this._remoteAudioMuteMap.clear(),this._room.remotePublishedUserMap.forEach(e=>{_e(e.remoteAudioTrack),_e(e.remoteVideoTrack),_e(e.remoteAuxiliaryTrack)}),_e(this)})}_stopScreenShare(){return _(this,null,function*(){var e,i,s;if(!!this._localScreenTrack){if(this._room.isJoined){let o=[this._localScreenTrack];this._localScreenAudioTrack&&o.push(this._localScreenAudioTrack),yield(e=this._room)==null?void 0:e.unpublish(...o).catch(()=>{})}this._localScreenTrack.stop(),this._localScreenTrack.close(),(i=this._localScreenAudioTrack)==null||i.stop(),(s=this._localScreenAudioTrack)==null||s.close(),_e(this._localScreenTrack),this._localScreenTrack=null,this._localScreenAudioTrack=null,this._localScreenConfig=null}})}sendSEIMessage(e,i){this._room.sendSEI(e,i||{seiPayloadType:243})}static setLogLevel(e,i){g.setLogLevel(e),T(i)||(i?g.enableUploadLog():g.disableUploadLog())}static isSupported(){return yn()}static getCameraList(){return Ue()}static getMicrophoneList(){return De()}static getSpeakerList(){return er()}static setCurrentSpeaker(e){return _(this,null,function*(){(yield er()).forEach(s=>{s.deviceId===e&&(xa.forEach(o=>{o.setCurrentSpeaker(e),o.emit(M.DEVICE_CHANGED,{type:"speaker",action:"active",device:s})}),ve=s)})})}},K=as;d(K,"_loggerManager",g),d(K,"EVENT",M),d(K,"ERROR_CODE",U),d(K,"TYPE",rs),d(K,"frameWorkType",30),y([Ae(pe.TRTC.enterRoom),Qt("room",([r],[t])=>(r.roomId||r.strRoomId)===(t.roomId||t.strRoomId)&&r.userId===t.userId&&r.sdkAppId===t.sdkAppId),W(r=>function(t){return this._log.setUserId(t.userId),this._log.setSdkAppId(t.sdkAppId),r.call(this,t).catch(e=>{throw _e(this),e})}),de()],K.prototype,"enterRoom",1),y([de()],K.prototype,"exitRoom",1),y([Ae(pe.TRTC.switchRole),Ai("room",(r,t)=>t),de()],K.prototype,"switchRole",1),y([de()],K.prototype,"destroy",1),y([Ae(pe.TRTC.startLocalAudio),Qt("audio",([r],[t])=>{var e,i;return((e=r==null?void 0:r.option)==null?void 0:e.microphoneId)===((i=t==null?void 0:t.option)==null?void 0:i.microphoneId)}),de()],K.prototype,"startLocalAudio",1),y([Ae(pe.TRTC.updateLocalAudio),Ai("audio"),de()],K.prototype,"updateLocalAudio",1),y([qt("audio"),de()],K.prototype,"stopLocalAudio",1),y([Ae(pe.TRTC.startLocalVideo),Qt("video",([r],[t])=>{var e,i;return((e=r==null?void 0:r.option)==null?void 0:e.cameraId)===((i=t==null?void 0:t.option)==null?void 0:i.cameraId)}),de()],K.prototype,"startLocalVideo",1),y([Ae(pe.TRTC.updateLocalVideo),Ai("video"),de()],K.prototype,"updateLocalVideo",1),y([qt("video"),de()],K.prototype,"stopLocalVideo",1),y([Ae(pe.TRTC.startScreenShare),Qt("screen",()=>!0),de()],K.prototype,"startScreenShare",1),y([Ae(pe.TRTC.updateScreenShare),Ai("screen"),de()],K.prototype,"updateScreenShare",1),y([de()],K.prototype,"stopScreenShare",1),y([Ae(pe.TRTC.startRemoteVideo),Qt(r=>`v${r.userId}${r.streamType}`,()=>!0),de(r=>`${r.userId}_${r.streamType}`)],K.prototype,"startRemoteVideo",1),y([Ae(pe.TRTC.updateRemoteVideo),Ai(r=>`v${r.userId}${r.streamType}`),de(r=>`${r.userId}_${r.streamType}`)],K.prototype,"updateRemoteVideo",1),y([Ae(pe.TRTC.stopRemoteVideo),W(r=>function(t){return _(this,null,function*(){if(t.userId==="*"){let e=[];return this._room.remotePublishedUserMap.forEach(i=>{this._remoteVideoConfigMap.has(`${i.userId}_${"main"}`)&&e.push(this.stopRemoteVideo({streamType:"main",userId:i.userId}).catch(()=>{})),this._remoteVideoConfigMap.has(`${i.userId}_${"sub"}`)&&e.push(this.stopRemoteVideo({streamType:"sub",userId:i.userId}).catch(()=>{}))}),Promise.all(e)}return r.call(this,t)})}),de(r=>`${r.userId}_${r.streamType}`)],K.prototype,"stopRemoteVideo",1),y([qt(r=>`v${r.userId}${r.streamType}`)],K.prototype,"_stopRemoteVideo",1),y([Ae(...pe.TRTC.muteRemoteAudio),de(r=>r)],K.prototype,"muteRemoteAudio",1),y([wa(...pe.TRTC.setRemoteAudioVolume),Yd(200,r=>r),de(r=>r)],K.prototype,"setRemoteAudioVolume",1),y([vo("start"),Qt((r,t)=>r.getAlias()+r.getGroup(t))],K.prototype,"startPlugin",1),y([vo("update"),Ai((r,t)=>r.getAlias()+r.getGroup(t))],K.prototype,"updatePlugin",1),y([vo("stop"),qt((r,t)=>r.getAlias()+r.getGroup(t))],K.prototype,"stopPlugin",1),y([wa(...pe.TRTC.enableAudioVolumeEvaluation)],K.prototype,"enableAudioVolumeEvaluation",1),y([Qt(r=>`a${r.userId}`,()=>!0)],K.prototype,"_startRemoteAudio",1),y([W(r=>function(t){return _(this,null,function*(){return t.userId==="*"?Promise.all([...this._room.remotePublishedUserMap.values()].map(e=>this._stopRemoteAudio(k(R({},t),{userId:e.userId})).catch(()=>{}))):r.call(this,t)})}),qt(r=>`a${r.userId}`)],K.prototype,"_stopRemoteAudio",1),y([qt("room")],K.prototype,"_exitRoom",1),y([qt("screen")],K.prototype,"_stopScreenShare",1),y([Ae(pe.TRTC.sendSEIMessage),kd({timesInSecond:30,maxSizeInSecond:8e3,getSize:(...r)=>r[0].byteLength})],K.prototype,"sendSEIMessage",1),y([Ae(pe.TRTC.create)],K,"_create",1);var cs=K;var Ua=class{constructor(){this._set=new Set;E.on(p.LEAVE_SUCCESS,this.delete,this)}add({room:t,roomId:e}){if(t.scene==="rtc")return;let i=this.getKey(t.userId,e||t.roomId,t.sdkAppId,t.useStringRoomId);this._set.add(i)}delete({room:t,roomId:e}){if(t.scene==="rtc")return;let i=this.getKey(t.userId,t.roomId||e,t.sdkAppId,t.useStringRoomId);this._set.delete(i)}getKey(t,e,i,s){return`${i}_${e}_${t}_${s}`}isJoined({userId:t,roomId:e,sdkAppId:i,room:s}){return s.scene==="rtc"?!1:this._set.has(this.getKey(t,e,i,s.useStringRoomId))}};function zh(){return _(this,null,function*(){let r,t;try{let m=yield De();r=m&&m.length}catch(m){}try{let m=yield Ue();t=m&&m.length}catch(m){}let e={microphone:r,camera:t},{isH264EncodeSupported:i,isVp8EncodeSupported:s,isH264DecodeSupported:o,isVp8DecodeSupported:n}=this.checkSystemResult.detail,a=Tt.basis(),c={webRTC:a.isWebRTCSupported,getUserMedia:a.isGetUserMediaSupported,webSocket:a.isWebSocketsSupported,screenShare:a.isScreenShareSupported,webAudio:a.isWebAudioSupported,h264Encode:i,h264Decode:o,vp8Encode:s,vp8Decode:n},l={browser:a.browser,os:a.os,trtc:c,devices:e},u={isWebCodecSupported:a.isWebCodecSupported,isMediaSessionSupported:a.isMediaSessionSupported,isWebTransportSupported:a.isWebTransportSupported};z.uploadEvent({log:`trtcstats-${JSON.stringify(l)}`,userId:this.userId}),this._log.info(`TrtcStats-${JSON.stringify(l)}`),z.uploadEvent({log:`trtcadvancedstats-${JSON.stringify(u)}`,userId:this.userId})})}function zd(){return W(r=>{let t=new Ua;return function(e,i,s){return _(this,null,function*(){let o=String(e.roomId||e.strRoomId);if(this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.userSig=e.userSig,this._log.setSdkAppId(this.sdkAppId),this._log.setUserId(this.userId),this.scene=i,e.privateMapKey=e.privateMapKey||"",this.isJoined)throw new A({code:I.INVALID_OPERATION,message:b({key:C.INVALID_JOIN})});if(this.checkDestroy(),t.isJoined({userId:this.userId,roomId:o,sdkAppId:this.sdkAppId,room:this}))throw new A({code:I.INVALID_OPERATION,message:b({key:C.REPEAT_JOIN,data:this.userId})});t.add({room:this,roomId:o}),this._log.info(`Join() => joining room: ${o} useStringRoomId: ${this.useStringRoomId} scene: ${this.scene} role: ${this.role}`),this.role=e.role===21?"audience":"anchor",E.emit(p.JOIN_START,{room:this,roomId:o,params:e}),this.checkSystemResult=yield Tt.checkSystemRequirementsInternal(),this.checkDestroy();let n=Se.getEnv();n||(n=mt.QCLOUD,this.proxy_ws&&(this.proxy_ws.startsWith(Js.OLD_CLOUD_LADDER)?n=mt.OLD_CLOUD_LADDER:this.proxy_ws.startsWith(Js.WEBRTC)&&(n=mt.WEBRTC))),z.setConfig({env:n,sdkAppId:String(this.sdkAppId),userId:this.userId,roomId:o}),zh.call(this);let{isH264EncodeSupported:a,isVp8EncodeSupported:c}=this.checkSystemResult.detail;if(!Tt.isWebRTCSupported()||!a&&!c)throw new A({code:I.NOT_SUPPORTED,message:b({key:C.NOT_SUPPORTED_WEBRTC})});try{!this.proxy_ws&&!this.proxy_wt&&!this.scheduleResult.domains&&!Se.getEnv()&&(yield this.schedule(o,s,Ie));let l=yield r.call(this,e,i,s);return this.roomId=o,this._joinedTimestamp=Se.performanceNow(),E.emit(p.JOIN_SUCCESS,{room:this}),z.uploadEvent({log:`stat-conv-${Number(He)}-${location.hostname}`,userId:this.userId}),l}catch(l){throw t.delete({room:this,roomId:o}),E.emit(p.JOIN_FAILED,{room:this,error:l}),l}})}})}var Zd=()=>W(r=>function(...t){return _(this,null,function*(){E.emit(p.LEAVE_START,{room:this}),yield r.call(this),E.emit(p.LEAVE_SUCCESS,{room:this,roomId:this.roomId})})});function el(){return W(r=>function(...t){let e=r.apply(this,t);return t.forEach(i=>!i.isSubscribed&&i.subscribe(e)),e})}var il=Ne(Me());var se={SETUP_SUCCESS:"1",SETUP_FAILED:"5",CONNECTION_STATE_CHANGED:"2",CONNECTED:"3",RECONNECT_FAILED:"4"},Le={DISCONNECTED:"DISCONNECTED",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED"},ct={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772,REBUILD_PEER_CONNECTION_RES:4150,SPC_PUBLISH_RESULT:4146,SPC_SUBSCRIBE_RESULT:4156},tl=[ct.UPDATE_REMOTE_MUTE_STAT,ct.UPLINK_NETWORK_STATS,ct.USER_LIST_RES,ct.MUTE_RESULT],B={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res",REBUILD_PEER_CONNECTION_RES:"rebuild-pc-res",SPC_PUBLISH_RESULT:"spc-publish-result",SPC_SUBSCRIBE_RESULT:"spc-subscribe-result"},J={PUBLISH_CHANGE:"publish_change",JOIN_ROOM:"join",LEAVE_ROOM:"leave",ON_QUALITY_REPORT:"quality_report",UPDATE_MUTE_STAT:"mute_uplink",PUBLISH:"publish",PUBLISH_STATE_CHANGE:"publish_state_change",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",RECEIVE_DATA_USER_LIST:"receive_data_userlist",UNSUBSCRIBE:"unsubscribe",SUBSCRIBE_CHANGE:"subscribe_change",START_PUBLISH_TENCENT_CDN:"start_publishing",STOP_PUBLISH_TENCENT_CDN:"stop_publishing",START_PUBLISH_GIVEN_CDN:"start_push_user_cdn",STOP_PUBLISH_GIVEN_CDN:"stop_push_user_cdn",START_MIX_TRANSCODE:"start_mcu_mix",STOP_MIX_TRANSCODE:"stop_mcu_mix",GET_USER_LIST:"get_user_list",SWITCH_ROLE:"change_role",UPDATE_CONSTRAINT_CONFIG:"update_constraint_config",REBUILD_PEER_CONNECTION:"rebuild_pc",READY_TO_RECEIVE_DATA:"ready_to_receive",SPC_JOIN_ROOM:"join/v2",SPC_PUBLISH:"publish/v2",SPC_SUBSCRIBE:"subscribe/v3"};var ds=class{constructor(t){d(this,"_room");d(this,"_sdkAppId");d(this,"_userId");d(this,"_userSig");d(this,"_url");d(this,"_backupUrl");d(this,"_urlWithParam");d(this,"_backupUrlWithParam");d(this,"_socketInUse");d(this,"_socket");d(this,"_backupSocket");d(this,"_backupTimer",-1);d(this,"_signalInfo",{tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0});d(this,"_currentState",Le.DISCONNECTED);d(this,"_reconnectionCount",0);d(this,"_reconnectionTimer",-1);d(this,"_seq",0);d(this,"_log");d(this,"_emitter");d(this,"_lastMessageTime",-1);d(this,"_prevTime",-1);this._room=t.room,this._sdkAppId=t.sdkAppId,this._userId=t.userId,this._userSig=t.userSig,this._url=t.url,this._backupUrl=t.backupUrl;let e=`?sdkAppId=${encodeURIComponent(this._sdkAppId)}&userId=${encodeURIComponent(this._userId)}&userSig=${encodeURIComponent(this._userSig)}`;this._urlWithParam=`${this._url}${e}`,this._backupUrlWithParam=`${this._backupUrl}${e}`,this._seq=0,this._log=g.createLogger({id:"ws",userId:this._userId,sdkAppId:this._sdkAppId}),this._emitter=new il.default}get isConnected(){return this._currentState===Le.CONNECTED}get isConnecting(){return this._currentState===Le.CONNECTING}get isOnline(){return this._currentState===Le.CONNECTED&&Date.now()-this._lastMessageTime<12*1e3}connect(t){return new Promise((e,i)=>{this._prevTime<0&&(this._prevTime=V()),this._log.info(`connect to ${this._url}${t?` timeout: ${t}`:""}`),this.emitConnectionStateChanged(Le.CONNECTING),this._socket=new WebSocket(this._urlWithParam),this.bindSocket(this._socket),this._backupTimer=setTimeout(()=>{this.isConnected||(this._log.info("trying to connect to backupUrl"),this.tryConnectBackup())},5e3);let s=-1;t&&(s=setTimeout(()=>{this.close(),i(new A({code:I.JOIN_ROOM_FAILED,message:"join room timeout"}))},t)),this.once(se.CONNECTED,()=>{clearTimeout(s),e()}),this.once(se.RECONNECT_FAILED,o=>{clearTimeout(s),i(o)})})}tryConnectBackup(){this._backupSocket||(this.unbindAndCloseSocket(h.MAIN),this._log.debug(`try to connect to url: ${this._backupUrlWithParam}`),this._backupSocket=new WebSocket(this._backupUrlWithParam),this.bindSocket(this._backupSocket))}bindSocket(t){t.onopen=this.onopen.bind(this),t.onclose=this.onclose.bind(this),t.onerror=this.onerror.bind(this),t.onmessage=this.onmessage.bind(this)}unbindSocket(t){this.clearBackupTimer(),t.onopen=()=>{},t.onclose=()=>{},t.onerror=()=>{},t.onmessage=()=>{}}unbindAndCloseSocket(t){if(t===h.MAIN){if(this._socket){this.unbindSocket(this._socket);try{this._socket.close(1e3)}catch(e){}this._socket=null}}else if(this._backupSocket){this.unbindSocket(this._backupSocket);try{this._backupSocket.close(1e3)}catch(e){}this._backupSocket=null}}clearBackupTimer(){this._backupTimer!==-1&&(clearTimeout(this._backupTimer),this._backupTimer=-1)}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onopen(t){if(this.isConnected)return;this.isReconnecting&&!this._signalInfo.tinyId&&this.stopReconnection(),this.clearBackupTimer(),t.target===this._socket?(this.unbindAndCloseSocket(h.BACKUP),this._socketInUse=this._socket):(this.unbindAndCloseSocket(h.MAIN),this._socketInUse=this._backupSocket),this.emitConnectionStateChanged(Le.CONNECTED),this._emitter.emit(se.CONNECTED)}onclose(t){let{url:e}=t.target,i=t.target===this._socketInUse;if(this._log.info(`websocket[${e} InUse: ${i}] is closed with code: ${t.code}`),i&&(this.emitConnectionStateChanged(Le.DISCONNECTED),!t.wasClean||t.code!==1e3)){this._log.warn(`onclose code:${t.code} reason:${t.reason}`),this._log.warn("close current websocket and schedule a reconnect timeout"),this._socketInUse.onclose=()=>{},this._socketInUse.close(4011);let s=this._socketInUse===this._socket;this._socket=null,this._backupSocket=null,this._socketInUse=null,this.reconnect(s?h.BACKUP:h.MAIN)}}onerror(t){let{url:e}=t.target;if(this._log.error(`websocket[${e}] error observed`),!this.isConnected)this.isReconnecting||E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:new Error("ws onerror")}),t.target==this._socket?(this.unbindAndCloseSocket(h.MAIN),this.reconnect(h.BACKUP)):(this.unbindAndCloseSocket(h.BACKUP),this.reconnect(h.MAIN));else if(t.target===this._socketInUse){this.unbindAndCloseSocket(h.MAIN),this.unbindAndCloseSocket(h.BACKUP);let i=this._socketInUse===this._socket;this._socketInUse=null,this.reconnect(i?h.BACKUP:h.MAIN)}}onmessage(t){if(!this.isConnected)return;this._lastMessageTime=Date.now();let e=JSON.parse(t.data),{cmd:i,data:s}=e,o=Object.values(ct),a=Object.keys(ct)[o.indexOf(i)],c=B[a];switch(tl.includes(i)||(this._log.debug(`received msg: ${t.data}`),this._log.info(`Received event: [ ${c||`unknown cmd: ${i}`} ]`)),i){case ct.CHANNEL_SETUP_RESULT:{if(e.code===0)this._signalInfo.clientIp=s.clientIp,this._signalInfo.signalIp=s.signalInnerIp,this._signalInfo.tinyId=e.tinyId,s.svrTime&&Sc(s.svrTime),this._log.info("ChannelSetup Success"),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",cost:V()-this._prevTime}),this._prevTime=-1,this._emitter.emit(se.SETUP_SUCCESS,{signalInfo:this._signalInfo});else{let l=new A({code:I.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:e.code,message:b({key:C.SIGNAL_CHANNEL_SETUP_FAILED,data:{errorCode:e.code,errorMsg:e.message}})});this._log.error(`${e.code}, ${e.message}`),this.close(),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:l}),this._emitter.emit(se.SETUP_FAILED,l)}break}case ct.JOIN_ROOM_RESULT:{e.code===0&&(this._signalInfo.relayIp=s.relayOuterIp,this._signalInfo.relayInnerIp=s.relayInnerIp,this._signalInfo.relayPort=s.relayPort,this._log.info(`signalIp:${this._signalInfo.signalIp} clientIp:${this._signalInfo.clientIp} relayIp: ${this._signalInfo.relayIp}`)),this._emitter.emit(c,{data:e});break}case ct.CHANNEL_RECONNECT_RESULT:{e.code===0?(this._log.warn("reconnect success"),this.stopReconnection(),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",cost:V()-this._prevTime}),this._prevTime=-1,this._room.syncUserList(),this._room.checkConnectionsToReconnect()):(this._log.warn(`reconnect failed, ${e.code} ${e.message}`),this._room.reJoin());break}default:this._emitter.emit(c,{data:e});break}}reconnect(t=h.MAIN){if(this.isReconnecting)return;if(this._reconnectionCount>=xr){this._log.warn(`SDK has tried reconnect signal channel for ${xr} times, but all failed. please check your network`);let s=new A({code:I.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:b({key:C.SIGNAL_CHANNEL_RECONNECTION_FAILED})});E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",error:s}),this._emitter.emit(se.RECONNECT_FAILED,s);return}this._reconnectionCount++,this._log.warn(`reconnect ${t} [${this._reconnectionCount}/${xr}]`);let e=this.getReconnectionUrl(t);this.emitConnectionStateChanged(Le.CONNECTING),this._prevTime<0&&(this._prevTime=V()),t===h.MAIN?(this._socket=new WebSocket(e),this.bindSocket(this._socket)):(this._backupSocket=new WebSocket(e),this.bindSocket(this._backupSocket));let i=we(this._reconnectionCount);this._reconnectionTimer=setTimeout(()=>{this._log.warn(`reconnect ${t} timeout(${i/1e3}s), try again`),this.clearReconnectionTimer(),this.unbindAndCloseSocket(h.MAIN),this.unbindAndCloseSocket(h.BACKUP),this.reconnect(t===h.MAIN?h.BACKUP:h.MAIN)},i)}get isReconnecting(){return this._reconnectionTimer!==-1}getReconnectionUrl(t){let e=t===h.MAIN?this._urlWithParam:this._backupUrlWithParam;if(this._signalInfo.tinyId&&e.indexOf("&rc=1")===-1){let{roomId:i,useStringRoomId:s}=this._room;e+=`&rc=1&relayInnerIp=${this._signalInfo.relayInnerIp}&relayOuterIp=${this._signalInfo.relayIp}&relayPort=${this._signalInfo.relayPort}&roomId=${i}&useStringRoomId=${s}`}return e}send(t,e={}){if(this.isConnected){let i={cmd:t,data:e,userId:this._userId,tinyId:this._signalInfo.tinyId,seq:++this._seq};return this._socketInUse.send(JSON.stringify(i)),i.seq}}sendWaitForResponse({command:t,data:e,timeout:i=5e3,responseCommand:s,commandDesc:o,enableLog:n=!0}){return new Promise((a,c)=>{let l=setTimeout(()=>{this.off(s,u);let f=new A({code:I.API_CALL_TIMEOUT,message:b({key:C.API_CALL_TIMEOUT,data:{commandDesc:o,command:t}})});n&&this._log.warn(f),c(f)},i),u=f=>{f.data.seq===m&&(clearTimeout(l),this.off(s,u),a(f))};this.on(s,u);let m=this.send(t,e)})}sendWaitForResponseWithRetry(t){let{commandDesc:e,command:i,retries:s=0,retryTimeout:o=0}=t;return rt({retryFunction:this.sendWaitForResponse,onRetrying:n=>{this._log.warn(`${e||i} timeout observed, retrying [${n}/${s}]`)},settings:{retries:s,timeout:o},context:this})(t)}getCurrentState(){return this._currentState}getSignalInfo(){return this._signalInfo}stopReconnection(){this.isReconnecting&&(this._reconnectionCount=0,this.clearReconnectionTimer())}close(){this._log.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._socketInUse=null,this.unbindAndCloseSocket(h.MAIN),this.unbindAndCloseSocket(h.BACKUP),this.emitConnectionStateChanged(Le.DISCONNECTED)}on(t,e,i){this._emitter.on(t,e,i)}removeListener(t,e,i){this._emitter.removeListener(t,e,i)}once(t,e,i){this._emitter.once(t,e,i)}off(t,e,i){this._emitter.off(t,e,i)}emitConnectionStateChanged(t){t!==this._currentState&&(this._log.info(`${this._currentState} -> ${t}`),this._emitter.emit(se.CONNECTION_STATE_CHANGED,{prevState:this._currentState,state:t}),this._currentState=t)}};var rl=Ne(Me());var ls=class{constructor(t,e=!1){this.dataView=t;this.isSEI&&(e?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){let t=this.seiPayloadStartIndex,e=this.dataView.byteLength-2,i=[],s=0;for(let n=t;n<=e;n++){let a=this.dataView.getInt8(n);switch(a){case 0:case 1:case 2:case 3:s===2&&(i.push(3),s=0),a==0?s++:s=0,i.push(a);break;default:s=0,i.push(a);break}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));let o=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,t),...i]).buffer);this.dataView=o}removePreventionByte(){let t=this.seiPayloadStartIndex,e=this.dataView.byteLength-1,i=[],s=0;for(let n=t;n<=e;n++)switch(this.dataView.getInt8(n)){case 0:s++,i.push(this.dataView.getInt8(n));break;case 3:s!==2&&i.push(this.dataView.getInt8(n)),s=0;break;default:i.push(this.dataView.getInt8(n)),s=0;break}let o=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,t),...i]).buffer);this.dataView=o}get isSEI(){return this.dataView.getUint8(4)===6}get seiPayloadStartIndex(){let t=6;for(let e=6;e<this.dataView.buffer.byteLength&&(t++,this.dataView.getUint8(e)===255);e++);return t}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let t=0,e=6;for(let o=6;o<this.dataView.buffer.byteLength;o++){let n=this.dataView.getUint8(o);if(e++,n===255)t+=255;else{t+=n;break}}let i=new ArrayBuffer(t),s=new DataView(i);for(let o=0;o<i.byteLength;o++,e++)s.setInt8(o,this.dataView.getInt8(e));return s}};var Va=class{constructor(t,e,i){this._connection=t;this._log=e;this._isUplink=i;d(this,"_seiMessageList",[]);d(this,"_seiPayloadType",243);d(this,"_mainVideoSenderOrReceiver",null);d(this,"_mainVideoAbortController",null);d(this,"_abortMap",new Map);d(this,"onSEIMessage")}get isRunning(){return!!this._mainVideoAbortController}start(t){this._mainVideoSenderOrReceiver=t;let e=t.createEncodedStreams(),i=e.readable,s=e.writable,o=new TransformStream({transform:this._isUplink?this.encodeVideoFrame.bind(this):this.decodeVideoFrame.bind(this)});this._mainVideoAbortController=new AbortController,i.pipeThrough(o).pipeTo(s,this._mainVideoAbortController).catch(()=>{})}restart(t){this.stop(),this.start(t)}stop(){var t;(t=this._mainVideoAbortController)==null||t.abort(),this._mainVideoAbortController=null}destroy(){this.stop(),this._abortMap.forEach(t=>t.abort()),this._abortMap.clear(),this._log=null,this.onSEIMessage=null,this._mainVideoSenderOrReceiver=null,this._connection=null}handleEncodedStreams(){try{let t=this._connection.getPeerConnection();this.clearUnusedSenderOrReceiver(t),this._isUplink?t.getSenders().forEach((e,i)=>{if(i===1){if(e===this._mainVideoSenderOrReceiver)return;this.isRunning?this.restart(e):this.start(e)}else{if(this._abortMap.has(e))return;this.pipeSenderOrReceiver(e)}}):t.getReceivers().forEach((e,i)=>{var s;this._abortMap.has(e)||e===this._mainVideoSenderOrReceiver||(i===1&&((s=e.track)==null?void 0:s.kind)===h.VIDEO?this.isRunning?this.restart(e):this.start(e):this.pipeSenderOrReceiver(e))})}catch(t){this._log.warn(t)}}pipeSenderOrReceiver(t){let{readable:e,writable:i}=t.createEncodedStreams(),s=new AbortController;this._abortMap.set(t,s),e.pipeTo(i,s).catch(()=>{})}clearUnusedSenderOrReceiver(t){this._abortMap.forEach((e,i)=>{(this._isUplink?t.getSenders():t.getReceivers()).find(o=>o===i)||(e.abort(),this._abortMap.delete(i))})}push(t,e){e&&e.seiPayloadType&&(this._seiPayloadType=e.seiPayloadType),this._seiMessageList.push(t)}hasSEI(t){let e=new DataView(t);return e.getInt32(0)===1&&e.getInt8(4)===6}isEmptyFrame(t){return t.type==="empty"||t.data.byteLength===0}getNaluCount(t){let e=0,i=0,s=new DataView(t);for(let o=0;o<t.byteLength;o++)switch(s.getUint8(o)){case 0:e++;break;case 1:(e===2||e===3)&&i++,e=0;break;default:e=0;break}return i}encodeVideoFrame(t,e){try{if(this._connection.isH264&&this._seiMessageList.length>0&&!this.isEmptyFrame(t)){let s=9-this.getNaluCount(t.data);if(s<=0)return;let o=this._seiMessageList.splice(0,s).reverse().map(this.encodeSEINalu.bind(this)),n=o.reduce((m,f)=>m+f.dataView.byteLength,0),a=new ArrayBuffer(n+t.data.byteLength),c=new DataView(a),l=new DataView(t.data),u=0;for(let m=0;m<o.length;m++)for(let f=0;f<o[m].dataView.byteLength;f++)c.setInt8(u++,o[m].dataView.getInt8(f));for(let m=0;m<t.data.byteLength;m++)c.setInt8(u++,l.getInt8(m));t.data=a,this._log.debug(`${o.length} sei sent`)}}catch(i){this._log.warn(i)}e.enqueue(t)}decodeVideoFrame(t,e){try{if(this._connection.isH264&&!this.isEmptyFrame(t)&&this.hasSEI(t.data)){let i=[],s=new DataView(t.data),o=0,n=-1,a=-1;for(let c=0;c<t.data.byteLength;c++){let l=s.getUint8(c);if(l===0)o++;else if(l===1){if(o===2||o===3){let u=c-o;if(n===-1?n=u:a===-1&&(a=u,i.push(new ls(new DataView(s.buffer.slice(n,a)))),n=u,a=-1),!(s.getUint8(c+1)===6)){t.data=new DataView(s.buffer.slice(u)).buffer;break}}o=0}else o=0}this._log.debug(`${i.length} sei received`),j(this.onSEIMessage)&&i.reverse().forEach(c=>{this.onSEIMessage({seiPayloadType:c.seiPayloadType,data:c.seiPayload.buffer})})}}catch(i){this._log.warn(i)}e.enqueue(t)}encodeSEINalu(t){let e=t.byteLength,i=parseInt(e/255),s=e%255,o=[];o.push(0,0,0,1,6,this._seiPayloadType);for(let a=0;a<i;a++)o.push(255);o.push(s);let n=new DataView(t);return o.push(...new Uint8Array(n.buffer)),o.push(128),new ls(new DataView(new Uint8Array(o).buffer),!0)}},Lo=Va;var Ba=0,$a=!1,Po=new Set,Zh=r=>Ba>2&&!$a&&Po.size===0&&r,Ha=!1,Pe=class{constructor(t){d(this,"userId");d(this,"tinyId");d(this,"_sdpSemantics");d(this,"_isUplink");d(this,"_room");d(this,"_log");d(this,"_signalChannel");d(this,"_isErrorObserved",!1);d(this,"_waitForPeerConnectionConnectedPromise");d(this,"_waitForPeerConnectionConnectedPromiseReject",null);d(this,"_peerConnection",null);d(this,"_emitter",new rl.default);d(this,"_currentState","DISCONNECTED");d(this,"_isReconnecting",!1);d(this,"_reconnectionCount",0);d(this,"_reconnectionTimer",-1);d(this,"_isFirstConnection",!0);d(this,"_prevTime",-1);d(this,"_enableSEI");d(this,"_sei");d(this,"_localAddress");d(this,"_remoteAddress");this.userId=t.userId,this.tinyId=t.tinyId,this._room=t.room,this._sdpSemantics=t.room.sdpSemantics,this._isUplink=t.isUplink,this._log=g.createLogger({id:"n",userId:this._room.userId,remoteUserId:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=t.signalChannel,this._enableSEI=t.enableSEI,this._enableSEI&&Wt&&(this._sei=new Lo(this,this._log,this._isUplink))}beforeConnect(){this._prevTime<0&&(this._prevTime=V())}afterConnect(t){return _(this,null,function*(){try{yield t,this._isFirstConnection?(this._isFirstConnection=!1,E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",cost:Math.min(V()-this._prevTime,30*1e3)})):this._isReconnecting&&E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",cost:V()-this._prevTime}),this._prevTime=-1}catch(e){throw this._isFirstConnection?(this._isFirstConnection=!1,E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",error:e})):this._isReconnecting&&this._reconnectionCount>=3&&E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",error:e}),e}})}initialize(){let t={encodedInsertableStreams:this._enableSEI&&Wt,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this._peerConnection=new RTCPeerConnection(t),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(t){this._log.info("close connection"),this._emitter.emit("closed",t),this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this._sei&&(this._sei.destroy(),this._sei=null),Po.delete(this)}closePeerConnection(t=!1){this._peerConnection&&(this._log.info("close pc"),this._peerConnection.onconnectionstatechange=null,this._peerConnection.close(),this._peerConnection=null,t&&this.emitConnectionStateChangedEvent("DISCONNECTED")),this._waitForPeerConnectionConnectedPromiseReject&&this._waitForPeerConnectionConnectedPromiseReject(new A({code:I.API_CALL_ABORTED,message:"connection closed"}))}getDTLSTransportState(){if(!this._peerConnection)return Ge;let t=null;if(this._isUplink){if(!zi()||this._peerConnection.getSenders().length===0)return Ge;t=this._peerConnection.getSenders()[0].transport}else{if(!mi()||this._peerConnection.getReceivers().length===0)return Ge;t=this._peerConnection.getReceivers()[0].transport}return t?t.state:Ge}onConnectionStateChange(t){let e=this._peerConnection.iceConnectionState,i=this.getDTLSTransportState();if(this._log.info(`connectionState: ${t.target.connectionState}, ICE: ${e}, DTLS: ${i}`),t.target.connectionState===Z.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),t.target.connectionState===Z.FAILED||t.target.connectionState===Z.CLOSED){let s=`connection ${t.target.connectionState}. ICE Transport state: ${e}, DTLS Transport state: ${i}`,o=new A({message:s,code:I.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection(),this._isErrorObserved||this._emitter.emit("error",o)}(t.target.connectionState===Z.CONNECTED||t.target.connectionState===Z.COMPLETED)&&(this.logSelectedCandidate(),z.logSuccessEvent({userId:this._room.userId,eventType:Ze.ICE_CONNECTION_STATE}),this.emitConnectionStateChangedEvent("CONNECTED"))}emitConnectionStateChangedEvent(t){return t===this._currentState?!1:(t==="CONNECTED"?(Ba=0,$a=!1,Ha=!0,Po.add(this)):Po.delete(this),E.emit(p.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:t,remoteUserId:this._isUplink?void 0:this.userId}),this._emitter.emit("connection-state-changed",{prevState:this._currentState,state:t}),this._currentState=t,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}logSelectedCandidate(){return _(this,null,function*(){if(!this._peerConnection)return;let t=yield this._peerConnection.getStats();for(let[,e]of t)if(Gt(e)){let i=t.get(e.localCandidateId),s=t.get(e.remoteCandidateId);i&&(this._log.info(`local candidate: ${i.candidateType} ${i.protocol}:${i.ip||i.address}:${i.port} ${i.networkType||""} ${i.candidateType==="relay"?`relayProtocol:${i.relayProtocol}`:""}`),this._localAddress=`${i.ip||i.address}:${i.port}`),s&&(this._log.info(`remote candidate: ${s.candidateType} ${s.protocol}:${s.ip||s.address}:${s.port}`),this._remoteAddress=`${s.protocol}:${s.ip||s.address}`);break}})}getCurrentState(){return this._currentState}waitForPeerConnectionConnected(){return this._waitForPeerConnectionConnectedPromise?this._waitForPeerConnectionConnectedPromise:(this._waitForPeerConnectionConnectedPromise=new Promise((t,e)=>{if(this._currentState==="CONNECTED")return t();this._waitForPeerConnectionConnectedPromiseReject=e;let i=a=>{a.state==="CONNECTED"&&(clearTimeout(n),o(),t())},s=({room:a})=>{a===this._room&&(clearTimeout(n),o(),e(new A({code:I.API_CALL_ABORTED,message:b({key:C.CONNECTION_ABORTED,data:"leave room"})})))},o=()=>{E.off(p.LEAVE_SUCCESS,s,this),this._emitter.off("connection-state-changed",i,this)},n=setTimeout(()=>{o();let a=new A({code:I.API_CALL_TIMEOUT,message:"connection timeout"});Ba+=1,Zh(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),$a=!0,this._emitter.emit("firewall-restriction")),e(a)},Ur);E.on(p.LEAVE_SUCCESS,s,this),this._emitter.on("connection-state-changed",i,this)}),this._waitForPeerConnectionConnectedPromise=this._waitForPeerConnectionConnectedPromise.finally(()=>{this._waitForPeerConnectionConnectedPromise=null,this._waitForPeerConnectionConnectedPromiseReject=null}),this._waitForPeerConnectionConnectedPromise)}getReconnectionCount(){return this._reconnectionCount}startReconnection(){this._isReconnecting=!0,this.reconnect()}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}stopReconnection(){this._log.info("stop reconnection"),this._isReconnecting=!1,this._reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(se.CONNECTED,this.reconnect,this)}beforeReconnect(){if(this._reconnectionTimer!==-1)return this._log.warn("reconnect() is reconnecting, ignore"),-1;if(this._reconnectionCount>=pt()){this._log.warn(`SDK has tried reconnect for ${this._reconnectionCount} times, but all failed, please check your network`),this.stopReconnection();let t=new A({code:this._isUplink?I.UPLINK_RECONNECTION_FAILED:I.DOWNLINK_RECONNECTION_FAILED,message:b({key:this._isUplink?C.UPLINK_RECONNECTION_FAILED:C.DOWNLINK_RECONNECTION_FAILED})});return this.emitConnectionStateChangedEvent("DISCONNECTED"),this._emitter.emit("error",t),-1}return this._signalChannel.isConnected?(this._reconnectionCount+=1,this._log.warn(`reconnect() trying [${this._reconnectionCount}]`),1):(this._log.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this._signalChannel.once(se.CONNECTED,this.reconnect,this),-1)}on(t,e,i){this._emitter.on(t,e,i)}off(t,e,i){this._emitter.off(t,e,i)}getIsReconnecting(){return this._isReconnecting}get isH264(){var t,e;return!!((e=(t=this._peerConnection)==null?void 0:t.remoteDescription)!=null&&e.sdp.includes("H264"))}};var Ka=Ne(Wa());var ne=function(r){return Ka.default.parse(r)},Ve=function(r){return Ka.default.write(r)},ul=function(r){let t=ne(r);return t.media.forEach(e=>{e.type===h.AUDIO&&e.fmtp.forEach(i=>{i.config+=";sprop-stereo=1;stereo=1"})}),Ve(t)};function hl(r){let t=ne(r);return t.media.forEach(e=>{var i,s;if(e.type===h.VIDEO){let o=new Set;e.rtp.forEach(({payload:a,codec:c})=>c==="H264"&&o.add(a)),e.fmtp.forEach(({payload:a,config:c})=>{let l=c.match(/apt=(\d+)/);l&&l[1]&&o.has(Number(l[1]))&&o.add(a)});let n=({payload:a})=>!o.has(a);e.rtp=e.rtp.filter(n),e.rtcpFb=(i=e.rtcpFb)==null?void 0:i.filter(n),e.fmtp=e.fmtp.filter(n),e.payloads=(s=e.payloads)==null?void 0:s.split(" ").filter(a=>!o.has(Number(a))).join(" ")}}),Ve(t)}function Mo(r){return Object.keys(r).filter(t=>r[t])}var ja=class extends Pe{constructor(e){super(k(R({},e),{isUplink:!1}));d(this,"_flag",0);d(this,"role","anchor");d(this,"remoteAudioTrack");d(this,"remoteVideoTrack");d(this,"remoteAuxiliaryTrack");d(this,"ssrc",{audio:0,video:0,auxiliary:0});d(this,"_isSDPExchanging",!1);this.flag=e.flag,this.remoteAudioTrack=e.remoteAudioTrack||new tr(this._room,this),this.remoteVideoTrack=e.remoteVideoTrack||new Si(this._room,this),this.remoteAuxiliaryTrack=e.remoteAuxiliaryTrack||new ir(this._room,this)}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(this.remoteVideoTrack.mediaType&8?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return Bt(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var i,s,o;e!==this._flag&&(this._flag=e,(i=this.remoteAudioTrack)==null||i.onFlagChanged(),(s=this.remoteVideoTrack)==null||s.onFlagChanged(),(o=this.remoteAuxiliaryTrack)==null||o.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===h.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){super.initialize(),this.installEvents(),this._peerConnection.ontrack=this.onTrack.bind(this)}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents()}installEvents(){}uninstallEvents(){this._emitter.removeAllListeners()}emitConnectionStateChangedEvent(e){var o,n;let i=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&i!==e&&((o=this.remoteVideoTrack)==null||o.emit("connection-state-changed",{prevState:i,state:e}),(n=this.remoteAuxiliaryTrack)==null||n.emit("connection-state-changed",{prevState:i,state:e})),s}onTrack(e){let i=e.streams[0],{track:s}=e,o=i.id===wr?h.MAIN:h.AUXILIARY;this._log.debug(`ontrack ${o} ${s.kind}`);let n=h.AUDIO;s.kind===h.VIDEO&&(n=o===h.MAIN?h.VIDEO:h.AUXILIARY);let a=this.remoteAudioTrack;n===h.VIDEO?a=this.remoteVideoTrack:n===h.AUXILIARY&&(a=this.remoteAuxiliaryTrack),a.setMediaStream(i),a.setMediaStreamTrack(s)}addRRTRLine(e){let i=e.split(`\r
`),s=new Map;i.forEach((n,a)=>{/^a=rtcp-fb:/.test(n)&&i[a+1]&&!/^a=rtcp-fb:/.test(i[a+1])&&s.set(a+1,`${n.match(/^a=rtcp-fb:\d+/)[0]} rrtr`)});let o=[...s];for(let n=0;n<o.length;n++){let[a,c]=o[n];i.splice(a+n,0,c)}return i.join(`\r
`)}addSPSDescription(e){let i=ne(e);return i.media.forEach(s=>{s.type===h.VIDEO&&s.fmtp.forEach(o=>{o.config+=";sps-pps-idr-in-keyframe=1"})}),Ve(i)}removeSDESDescription(e){let i=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],s=ne(e);return s.media.forEach(o=>{!o.ext||(o.ext=o.ext.filter(n=>!i.includes(n.uri)))}),Ve(s)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,i){return _(this,null,function*(){var s,o;try{if((((s=this._peerConnection)==null?void 0:s.connectionState)===Z.NEW||((o=this._peerConnection)==null?void 0:o.connectionState)===Z.CONNECTING)&&(yield this.waitForPeerConnectionConnected()),this.isSubscriptionStateNotChanged(e)){this._peerConnection||(this.initialize(),yield this.connect(e));return}if(this._log.info(`subscribe ${i} ${JSON.stringify(e)}`),this._peerConnection||this._isSDPExchanging){let n="subscribe_change";Object.values(e).find(a=>a===!0)||(n="unsubscribe"),yield this.sendSubscription(n,e)}else this.initialize(),yield this.connect(e)}catch(n){throw this._room.isJoined&&this.isStreamUnpublished(i)?(this._log.warn(`${n.message} ${JSON.stringify(this.muteState)}`),new A({code:I.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId} unpublished stream`})):n}})}unsubscribe(s){return _(this,arguments,function*({remoteTracks:e,streamType:i}){if(this._currentState==="CONNECTED"&&(i==="main"&&!this.isMainStreamSubscribed||i==="auxiliary"&&!this.isAuxStreamSubscribed)){this._log.info(`${i} stream already unsubscribed`);return}let o=R({},this.subscribeState);e.forEach(a=>{switch(a.mediaType){case 1:o.audio=!1;break;case 4:o.video=!1;break;case 8:o.smallVideo=!1;break;case 2:o.auxiliary=!1;break;default:break}});let n="subscribe_change";Object.values(o).find(a=>a===!0)||(n="unsubscribe"),this._log.info(`${n==="unsubscribe"?n:"subscribe"} ${i} [${Mo(o)}]`),yield this.sendSubscription(n,o),n==="unsubscribe"&&(this.remoteAudioTrack.setMediaStreamTrack(null),this.remoteVideoTrack.setMediaStreamTrack(null),this.remoteAuxiliaryTrack.setMediaStreamTrack(null),this.closePeerConnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"))})}sendSubscription(e,i=this.subscribeState){let s={srcTinyId:this.tinyId,srcUserId:this.userId},o=J.UNSUBSCRIBE,n=B.UNSUBSCRIBE_RESULT;return e==="subscribe_change"&&(s={audio:i.audio,bigVideo:i.video,auxVideo:i.auxiliary,smallVideo:i.smallVideo,srcTinyId:this.tinyId},o=J.SUBSCRIBE_CHANGE,n=B.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:o,data:s,responseCommand:n,timeout:1e4}).then(({data:a})=>{if(a.code!==0){let c=new A({code:a.code,message:b({key:C.ERROR_MESSAGE,data:{type:e,message:a.message}})});throw this._log.error(c),c}})}connect(){return _(this,arguments,function*(e=this.subscribeState){try{yield this.exchangeSDP(e),yield this.waitForPeerConnectionConnected()}catch(i){throw this.closePeerConnection(!0),i}})}exchangeSDP(e){return _(this,null,function*(){try{this._isSDPExchanging=!0,yield this.createOffer(),this._log.info("createOffer success, sending offer");let{type:i,sdp:s}=this._peerConnection.localDescription,o={type:i,sdp:s,srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo},n=yield this._signalChannel.sendWaitForResponse({command:J.SUBSCRIBE,commandDesc:"exchange sdp",data:o,responseCommand:B.SUBSCRIBE_RESULT,timeout:mn});if(!this._peerConnection){let a=new A({code:I.INVALID_OPERATION,message:b({key:C.CONNECTION_CLOSED})});throw this._log.warn(a),a}yield this.onSubscribeResult(n),this._isSDPExchanging=!1}catch(i){throw this._isSDPExchanging=!1,i}})}createOffer(){return _(this,null,function*(){let e={voiceActivityDetection:!1};We()&&this._sdpSemantics===xt?(this._peerConnection.addTransceiver(h.AUDIO,{direction:G.RECVONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:G.RECVONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:G.RECVONLY})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);let i=yield this._peerConnection.createOffer(e);if(i.sdp){let{isH264DecodeSupported:s}=yield ro();s||(this._log.warn("remove h264 desc from sdp"),i.sdp=hl(i.sdp)),i.sdp=this.addRRTRLine(i.sdp),i.sdp=this.addSPSDescription(i.sdp),i.sdp=ul(i.sdp),this._sdpSemantics===xt&&(i.sdp=this.removeSDESDescription(i.sdp))}yield this._peerConnection.setLocalDescription(i)})}onSubscribeResult(e){return _(this,null,function*(){let{code:i,message:s=""}=e&&e.data||{},{type:o,sdp:n}=e&&e.data&&e.data.data||{};if(i===di)throw new A({code:I.NOT_SUPPORTED_H264,message:b({key:C.NOT_SUPPORTED_H264DECODE})});try{if(i!==0)throw new A({code:i,message:b({key:C.EXCHANGE_SDP_FAILED,data:{errMsg:s}})});this._log.debug(`accept remote answer: ${n}`),yield this._peerConnection.setRemoteDescription({type:o,sdp:n}),this._sei&&(this._sei.handleEncodedStreams(),this._sei.onSEIMessage=a=>{this._emitter.emit("sei-message",k(R({},a),{userId:this.userId}))}),this.updateSSRC(n)}catch(a){throw this._log.error(a),a}})}updateSSRC(e){try{ne(e).media.forEach(s=>{if(!!s.ssrcs)if(s.type===h.AUDIO){let o=s.ssrcs.find(n=>{var a;return(a=n.value)==null?void 0:a.includes(wr)});o&&(this.ssrc.audio=Number(o.id))}else{let o=s.ssrcs.find(a=>{var c;return(c=a.value)==null?void 0:c.includes(wr)}),n=s.ssrcs.find(a=>{var c;return(c=a.value)==null?void 0:c.includes(cn)});o&&(this.ssrc.video=Number(o.id)),n&&(this.ssrc.auxiliary=Number(n.id))}})}catch(i){}}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}reconnect(){return _(this,null,function*(){if(!(ii(ja.prototype,this,"beforeReconnect").call(this)<0))try{this.closePeerConnection(),this.initialize(),yield this.connect(),this.stopReconnection(),this._log.warn("reconnect() success")}catch(i){let s=we(this._reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${s/1e3}s`),this._reconnectionTimer=setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},s)}})}getIsReconnecting(){return this._isReconnecting}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}getCurrentState(){return this._currentState}setDelay({audioDelay:e,videoDelay:i}){this.remoteAudioTrack.stat.end2EndDelay=e,this.remoteVideoTrack.stat.end2EndDelay=i}},hs=ja;y([W(r=>function(...t){return new Promise((e,i)=>{let s=o=>{this._emitter.off("closed",s),i(new A({code:I.API_CALL_ABORTED,message:b({key:C.CONNECTION_ABORTED,data:o})}))};this._emitter.on("closed",s),r.apply(this,t).then(e,i).finally(()=>{this._emitter.off("closed",s)})})})],hs.prototype,"subscribe",1),y([ho(Pe.prototype.afterConnect),uo(Pe.prototype.beforeConnect)],hs.prototype,"connect",1);var Ja=hs;var dm="let width,height,offscreen,ctx;onmessage=function(e){const{action,data}=e.data;switch(action){case'render':offscreen=data.canvas;width=offscreen.width;height=offscreen.height;ctx=offscreen.getContext('2d');draw(data.readable,data.writable);break}};function draw(readable,writable){const transformer=new TransformStream({async transform(cameraFrame,controller){ctx.drawImage(cameraFrame,0,0,width,height);const frame=new VideoFrame(offscreen,{timestamp:cameraFrame.timestamp});cameraFrame.close();controller.enqueue(frame)}});readable.pipeThrough(transformer).pipeTo(writable)}",lm=new Blob([dm],{type:"application/javascript"}),Ya=class{constructor(t){d(this,"width");d(this,"height");d(this,"canvas");d(this,"offscreen");d(this,"smallGenerator");d(this,"smallWritable");d(this,"bigProcessor");d(this,"bigReadable");d(this,"worker");let{videoTrack:e}=t;this.width=void 0,this.height=void 0,this.canvas=null,this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:e}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(lm)),g.info("init worker processor success")}catch(t){g.warn(`init worker processor failed. ${t.error}`)}}setCanvasRect(t,e){this.width=t,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generateVideoTrack(){let t=new MediaStream([this.smallGenerator]);return t==null?void 0:t.getTracks()[0]}destroy(){this.worker.terminate()}},_l=Ya;var Xa=class{constructor(t){d(this,"_player");d(this,"_canvas");d(this,"_canvasCtx");this._player=t,this._canvas=document.createElement("canvas"),this._canvasCtx=this._canvas.getContext("2d")}setCanvasRect(t,e){!this._canvas||(this._canvas.width=t,this._canvas.height=e)}drawVideoToCanvas(){let t=this._player.getElement();this._canvas&&this._canvasCtx&&t&&this._canvasCtx.drawImage(t,0,0,this._canvas.width,this._canvas.height)}generateVideoTrack(t){return this._canvas.captureStream(t).getVideoTracks()[0]}generateStreamFromTrack(t){let e=new MediaStream;return e.addTrack(t),e}destroy(){var t;(t=this._player)==null||t.stop(),this._canvas&&(this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._canvasCtx=null)}get canvas(){return this._canvas}get canvasCtx(){return this._canvasCtx}get canDrawVideoToCanvas(){if(this._player){let t=this._player.getElement();if(t)return t.readyState===t.HAVE_ENOUGH_DATA}return!1}},Qa=Xa;var qa=class{constructor(t){d(this,"_player");d(this,"_processor");d(this,"_initOffscreenSuccess");d(this,"_localVideoTrack");d(this,"_interval");this._localVideoTrack=t,this._player=t.player,this._processor=null,this._initOffscreenSuccess=!1}initialize(){return _(this,null,function*(){if(Nn()&&(navigator==null?void 0:navigator.hardwareConcurrency)>=6)try{yield this.initOffscreen(),this._initOffscreenSuccess=!0,g.info("Initialize VideoGenerator successfully!")}catch(t){this.initCanvas()}else this.initCanvas()})}generateSmallVideoTrack(t){let e=this.getSmallVideoProfile(t),i;return this._initOffscreenSuccess?(this._processor.setCanvasRect(e.width,e.height),i=this._processor.generateVideoTrack(e.frameRate)):(this._processor.setCanvasRect(e.width,e.height),this._player.setRect(e.width,e.height),i=this._processor.generateVideoTrack(e.frameRate),this._interval=ee.run(Et,this.render.bind(this),{fps:e.frameRate})),i}render(){this._processor instanceof Qa&&this._processor.drawVideoToCanvas()}destroy(){ee.clearTask(this._interval),this._processor&&this._processor.destroy()}initOffscreen(){this._processor=new _l({videoTrack:this._localVideoTrack.mediaTrack})}initCanvas(){this._player=new pi({track:this._localVideoTrack.mediaTrack,muted:!0,objectFit:"cover",mirror:!1,container:null,id:"video-player",log:this._localVideoTrack.log}),this._player.play().then(()=>{g.info("VideoGenerator: play local video success")}).catch(()=>{g.error("VideoGenerator: Failed to play local video")}),this._processor=new Qa(this._player)}getSmallVideoProfile(t){let e=this._localVideoTrack.mediaTrack,i=this._localVideoTrack.profile;if(Ke){let c=e.getSettings();c&&c.width&&c.height&&(i.width=c.width,i.height=c.height)}let s,o=i.width*i.height,n=t.width*t.height;return g.info(`big res: ${i.width}*${i.height} small res: ${t.width}*${t.height} `),o>n?s=o/n:(g.warn(`Small stream resolution is larger than big stream, which is invalid. big: ${i.width} * ${i.height} small: ${t.width} * ${t.height}`),s=o/(160*120)),{width:i.width/Math.sqrt(s),height:i.height/Math.sqrt(s),frameRate:t.frameRate}}},bt=qa;var pl={voiceActivityDetection:!1},za=class extends Pe{constructor(e){super(k(R({},e),{isUplink:!0}));d(this,"localMainAudioTrack",null);d(this,"localMainVideoTrack",null);d(this,"localAuxAudioTrack",null);d(this,"localAuxVideoTrack",null);d(this,"ssrc",{audio:0,video:0,small:0,auxiliary:0});d(this,"_isPublishingAux",!1);d(this,"_publishingLocalAudioTrack");d(this,"_publishingLocalVideoTrack");d(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0});d(this,"_smallGenerator");d(this,"_audioManager");this._audioManager=e.audioManager,this._smallGenerator=null}get isMainStreamPublished(){return!!(this.localMainAudioTrack||this.localMainVideoTrack)}get isAuxStreamPublished(){return!!(this.localAuxVideoTrack||this.localAuxAudioTrack)}get publishState(){var i,s,o,n;let e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let a=this._peerConnection.getSenders();a&&(ot()?(e.audio=!!((i=a[0])!=null&&i.track),e.bigVideo=!!((s=a[1])!=null&&s.track),e.smallVideo=!!((o=a[2])!=null&&o.track),e.auxVideo=!!((n=a[3])!=null&&n.track)):a.forEach(c=>{c.track&&(c.track.kind===h.AUDIO?e.audio=!0:(e.bigVideo=!0,this._smallGenerator&&(e.smallVideo=!0)))}))}return e}initialize(){super.initialize(),this.installEvents()}reset(){this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){this._emitter.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this._emitter.on("connection-state-changed",this.handleConnectionStateChange,this)}uninstallEvents(){this._emitter.off("connection-state-changed",this.handleConnectionStateChange,this)}emitConnectionStateChangedEvent(e,i){var n,a,c;let s=this._currentState,o=super.emitConnectionStateChangedEvent(e);return o&&s!==e&&(i?i.emit("connection-state-changed",{prevState:s,state:e}):((n=this.localMainVideoTrack)==null||n.emit("connection-state-changed",{prevState:s,state:e}),(a=this.localAuxVideoTrack)==null||a.emit("connection-state-changed",{prevState:s,state:e}),(c=this._publishingLocalVideoTrack)==null||c.emit("connection-state-changed",{prevState:s,state:e}))),o}publish(o){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,isAuxiliary:s}){var a;this._peerConnection||this.initialize(),e&&(this._publishingLocalAudioTrack=e),i&&(this._publishingLocalVideoTrack=i),this._isPublishingAux=s;let n;i&&!s&&i.small&&(this._smallGenerator=new bt(i),yield this._smallGenerator.initialize(),n=this._smallGenerator.generateSmallVideoTrack(i.small)),this.sendMediaSettings(),We()?yield this.publishByTransceiver({localAudioTrack:e,localVideoTrack:i,smallTrack:n,isAuxiliary:s}):yield this.publishByAddTrack({localAudioTrack:e,localVideoTrack:i,smallTrack:n}),this._publishingLocalAudioTrack=null,this._publishingLocalVideoTrack=null,this._isPublishingAux=!1,s?(i&&(this.localAuxVideoTrack=i),e&&(this.localAuxAudioTrack=e)):(i&&(this.localMainVideoTrack=i),e&&(this.localMainAudioTrack=e)),(a=this._sei)==null||a.handleEncodedStreams(),this.installTrackMuteEvents(e,i),this.sendMutedFlag()})}publishByTransceiver(n){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,smallTrack:s,isAuxiliary:o}){this._log.info("publish by transceiver");let a=new MediaStream;i&&si&&vr&&i.genCanvasTrack();let c=(i==null?void 0:i.canvasTrack)||(i==null?void 0:i.mediaTrack),l=this._audioManager.mediaStreamTrack;l&&a.addTrack(l),c&&a.addTrack(c);let u=this._peerConnection.getTransceivers();if(u.length===0)this._peerConnection.addTransceiver(l||h.AUDIO,{direction:G.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(o?h.VIDEO:c||h.VIDEO,{direction:G.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(s||h.VIDEO,{direction:G.SENDONLY,streams:[a]}),this._peerConnection.addTransceiver(o?c||h.VIDEO:h.VIDEO,{direction:G.SENDONLY,streams:[a]}),yield this.connect();else{let m=[];if(l&&(u[0].sender.track||m.push(0),yield u[0].sender.replaceTrack(l),yield this.setBandwidth({bandwidth:(e==null?void 0:e.profile.bitrate)||40,type:h.AUDIO})),c){let f=o?3:1;yield u[f].sender.replaceTrack(c),yield this.setBandwidth({bandwidth:i.profile.bitrate,type:h.VIDEO,videoType:o?h.AUXILIARY:h.BIG}),m.push(f),s&&(yield u[2].sender.replaceTrack(s),yield this.setBandwidth({bandwidth:i.small.bitrate,type:h.VIDEO,videoType:h.SMALL}),m.push(2))}yield this.setTransceiverDirection(G.SENDONLY,m),yield this.doPublishChange(),i==null||i.emit("connection-state-changed",{prevState:"DISCONNECTED",state:"CONNECTING"}),i==null||i.emit("connection-state-changed",{prevState:"CONNECTING",state:"CONNECTED"})}})}publishByAddTrack(o){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,smallTrack:s}){this._log.info("publish by addtrack");let n=i==null?void 0:i.mediaTrack,a=e!=null&&e.mediaTrack?this._audioManager.mediaStreamTrack:null;if(this._peerConnection&&this._peerConnection.connectionState!=="new"){a&&(yield this.addTrack(e)),n&&(yield this.addTrack(i));return}let c=new MediaStream;if(a&&c.addTrack(a),n&&c.addTrack(n),a&&this._peerConnection.addTrack(a,c),n&&(this._peerConnection.addTrack(n,c),s)){let l=new MediaStream;l.addTrack(s),this._peerConnection.addTrack(s,l)}yield this.connect()})}installTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.on("mute",this.sendMutedFlag,this),i==null||i.on("unmute",this.sendMutedFlag,this))})}uninstallTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.off("mute",this.sendMutedFlag,this),i==null||i.off("unmute",this.sendMutedFlag,this))})}unpublish(s){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i}){if(!ot()){if(e&&e.mediaTrack&&!i&&this.localMainVideoTrack){yield this.removeTrack(e),this.localMainAudioTrack=null;return}if(i&&i.mediaTrack&&!e&&this.localMainAudioTrack){yield this.removeTrack(i),this.localMainVideoTrack=null;return}yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,i),this.emitConnectionStateChangedEvent("DISCONNECTED",i);return}let o=i&&i===this.localAuxVideoTrack,n=e==null?void 0:e.mediaTrack,a=i==null?void 0:i.mediaTrack,c=this._peerConnection.getSenders(),l=[];n&&(this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield c[0].replaceTrack(null),l.push(0)),o?this.localAuxAudioTrack=null:this.localMainAudioTrack=null),a&&(o?(yield c[3].replaceTrack(null),this.localAuxVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),l.push(3)):(yield c[1].replaceTrack(null),yield c[2].replaceTrack(null),this.localMainVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),l.push(1,2))),this.isMainStreamPublished||this.isAuxStreamPublished?(yield this.setTransceiverDirection(G.INACTIVE,l),yield this.doPublishChange(!1)):yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,i),i==null||i.emit("connection-state-changed",{prevState:this._currentState,state:"DISCONNECTED"})})}doPublishChange(e=!0){return _(this,null,function*(){let i={state:this.publishState,constraintConfig:this._mediaSettings},s=yield this._signalChannel.sendWaitForResponse({command:J.PUBLISH_STATE_CHANGE,data:i,responseCommand:B.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(s.data.code,s.data.message)})}doUnpublish(e=!1){return this._signalChannel.sendWaitForResponse({command:J.UNPUBLISH,commandDesc:"unpublish",responseCommand:B.UNPUBLISH_RESULT,enableLog:e}).catch(i=>{if(i.getCode()===I.API_CALL_TIMEOUT)return Promise.resolve();throw i})}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:i}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":i&&(this._mediaSettings.videoCodec="VP8");let s=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:o,localAuxVideoTrack:n}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?n=this._publishingLocalVideoTrack:o=this._publishingLocalVideoTrack),Ke){if(s&&s.mediaTrack){let a=s.mediaTrack.getSettings();this._mediaSettings.audioChannel=a.channelCount||1,this._mediaSettings.audioBps=s.profile.bitrate*1e3,this._mediaSettings.audioFs=a.sampleRate||0}if(o&&o.mediaTrack){let a=o.mediaTrack.getSettings();this._mediaSettings.videoWidth=a.width||0,this._mediaSettings.videoHeight=a.height||0,this._mediaSettings.videoFps=a.frameRate||0,this._mediaSettings.videoBps=o.profile.bitrate*1e3,o.small&&(this._mediaSettings.smallVideoWidth=o.small.width,this._mediaSettings.smallVideoHeight=o.small.height,this._mediaSettings.smallVideoFps=o.small.frameRate,this._mediaSettings.smallVideoBps=o.small.bitrate*1e3)}if(n&&n.mediaTrack){let a=n.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=a.width||0,this._mediaSettings.auxVideoHeight=a.height||0,this._mediaSettings.auxVideoFps=a.frameRate||0,this._mediaSettings.auxVideoBps=n.profile.bitrate*1e3}}else s&&s.mediaTrack&&(this._mediaSettings.audioChannel=s.profile.channelCount,this._mediaSettings.audioBps=s.profile.bitrate*1e3,this._mediaSettings.audioFs=s.profile.sampleRate),o&&o.mediaTrack&&(this._mediaSettings.videoWidth=o.profile.width,this._mediaSettings.videoHeight=o.profile.height,this._mediaSettings.videoFps=o.profile.frameRate,this._mediaSettings.videoBps=o.profile.bitrate*1e3);this._log.info(`updateMediaSettings: ${JSON.stringify(this._mediaSettings)}`)}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:J.UPDATE_CONSTRAINT_CONFIG,data:this._mediaSettings,responseCommand:B.UPDATE_CONSTRAINT_CONFIG_RES}).then(e=>{e.data.code!==0&&this._log.warn(e.data.message)}).catch(()=>{})}addTrack(e){return _(this,null,function*(){var s;if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is adding ${e.kind} track to current published local ${i?h.AUXILIARY:h.MAIN} stream`),(s=this._sei)==null||s.handleEncodedStreams(),We()?yield this.addTrackByTransceiver(e,i):yield this.addTrackBySender(e)})}addTrackByTransceiver(e,i){return _(this,null,function*(){var n;if(!e.mediaTrack)return;let s=this._peerConnection.getTransceivers(),o=e.mediaTrack;if(e.kind===h.AUDIO)this._audioManager.addAudioTrack(e),o=this._audioManager.mediaStreamTrack,yield s[0].sender.replaceTrack(o);else{let a=i?3:1;if(yield s[a].sender.replaceTrack(o),a===1&&((n=this.localMainVideoTrack)==null?void 0:n.small)){this._smallGenerator=new bt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let c=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield s[2].sender.replaceTrack(c)}s[a].direction===G.INACTIVE&&(yield this.setTransceiverDirection(G.SENDONLY,[a]))}this.updateMediaSettings(),yield this.doPublishChange()})}addTrackBySender(e){return _(this,null,function*(){if(!e.mediaTrack)return;let i=e.mediaTrack;ot()&&this._peerConnection.getTransceivers().findIndex(n=>n.direction==="stopped")>=0&&(this._log.warn("transceiver is stopping, negotiate sdp first"),yield this.updateOffer("remove",i));let s=this._peerConnection.getSenders().find(n=>n.track&&n.track.kind===i.kind);if(s&&s.track){this._log.warn("sender already exists, remove sender first");let n=s.track;this.removeSender(s),yield this.updateOffer("remove",n)}let{mediaStream:o}=e;if(this._peerConnection.addTrack(i,o),i.kind===h.VIDEO&&e instanceof je&&e.small){this._smallGenerator=new bt(e),yield this._smallGenerator.initialize();let n=this._smallGenerator.generateSmallVideoTrack(e.small),a=new MediaStream;a.addTrack(n),this._peerConnection.addTrack(n,a)}yield this.updateOffer("add",i)})}isNeedToResetOfferOrder(){if(this._sdpSemantics===Wi||!this._peerConnection||!this._peerConnection.localDescription)return!1;let{sdp:e}=this._peerConnection.localDescription,i=ne(e);for(let s=0;s<i.media.length;s++)if(Number(i.media[s].mid)===0&&i.media[s].type===h.VIDEO)return!0;return!1}removeSender(e){let i=null;ot()&&(i=this._peerConnection.getTransceivers().find(s=>s.sender&&s.sender.track===e.track)),this._peerConnection.removeTrack(e),i&&j(i.stop)&&(this._log.info("stop transceiver"),i.stop())}removeTrack(e){return _(this,null,function*(){if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is removing ${e.kind} track from current published local ${i?h.AUXILIARY:h.MAIN} stream`),We()?yield this.removeTrackByTransceiver(e,i):yield this.removeTrackBySender(e)})}removeTrackByTransceiver(e,i){return _(this,null,function*(){if(!e.mediaTrack)return;let s=this._peerConnection.getTransceivers();if(e.kind===h.AUDIO)this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield s[0].sender.replaceTrack(null));else{let o=i?3:1;yield s[o].sender.replaceTrack(null),o===1&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield s[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(G.INACTIVE,[o])}this.updateMediaSettings(),yield this.doPublishChange()})}setTransceiverDirection(e,i){return _(this,null,function*(){if(!Y)return;let s=!1,o=!1;this._log.info(`setting transceiver ${i.join(",")} direction to ${e}`);let n=this._peerConnection.getTransceivers();if(i.forEach(l=>{n[l].direction!==e&&(n[l].direction=e,s=!0)}),s){this._log.info("updating offer");let l=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(l)}let a=-1,c=this._peerConnection.remoteDescription.sdp.split(`\r
`).map(l=>{if(l.match(new RegExp(`a=(${G.INACTIVE}|${G.RECVONLY}|${G.SENDONLY})`))&&a++,i.includes(a)){if(e===G.INACTIVE&&l.includes(`a=${G.RECVONLY}`))return o=!0,`a=${e}`;if(e===G.SENDONLY&&l.includes(`a=${G.INACTIVE}`))return o=!0,`a=${G.RECVONLY}`}return l}).join(`\r
`);o&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:c}))})}removeTrackBySender(e){return _(this,null,function*(){var s,o;if(!e.mediaTrack)return;if(e.kind===h.VIDEO&&this.isNeedToResetOfferOrder()&&this.localMainAudioTrack){this.reset(),this.initialize(),(o=(s=this.localMainVideoTrack)==null?void 0:s.mediaStream)==null||o.removeTrack(e.mediaTrack),yield this.publish({localAudioTrack:this.localMainAudioTrack,isAuxiliary:!1});return}let i=this._peerConnection.getSenders().find(n=>n.track===e.mediaTrack);i&&(this.removeSender(i),e.kind===h.VIDEO&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,this._peerConnection.getSenders().forEach(n=>{n.track&&n.track.kind===h.VIDEO&&this.removeSender(n)}))),yield this.updateOffer("remove",e.mediaTrack)})}replaceTrack(e){return _(this,null,function*(){var a,c;let i=(a=this._peerConnection)==null?void 0:a.getSenders();if(!i||i.length===0||!e.mediaTrack)return;let s=e.mediaTrack,o;if(We()?o=s.kind===h.AUDIO?i[0]:i[1]:o=i.find(l=>l.track&&l.track.kind===s.kind),!o)return;let n=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;if(this._log.info(`is replacing ${s.kind} track on ${n?h.AUXILIARY:h.MAIN} stream`),s.kind===h.AUDIO)this._audioManager.addAudioTrack(e),this._audioManager.isMixed&&(s=this._audioManager.mediaStreamTrack),yield o.replaceTrack(s);else if(s.kind===h.VIDEO){if(n)i[3]&&(yield i[3].replaceTrack(s));else if(yield o.replaceTrack(s),this._smallGenerator&&i[2]){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new bt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let l=this._smallGenerator.generateSmallVideoTrack(((c=this.localMainVideoTrack)==null?void 0:c.small)||this._room.smallStreamConfig);yield i[2].replaceTrack(l)}}})}updateOffer(e,i){return _(this,null,function*(){try{let s=yield this._peerConnection.createOffer(pl);Y&&s.sdp&&(s.sdp=this.setSDPDirection(s.sdp,"sendrecv")),yield this._peerConnection.setLocalDescription(s);let o=this.updateMediaSettings(),n={action:e,trackId:i.id,kind:i.kind===h.VIDEO?"bigVideo":i.kind,type:"offer",sdp:this._peerConnection.localDescription.sdp,constraintConfig:o,state:this.publishState};this._log.info("createOffer success, sending updated offer to remote server"),this._log.debug(`updatedOffer: ${n.sdp}`);let a=yield this._signalChannel.sendWaitForResponse({command:J.PUBLISH_CHANGE,data:n,responseCommand:B.UPDATE_OFFER_RESULT,timeout:hn,commandDesc:"update offer"}),{code:c,message:l}=a.data;c!==0&&this.checkPublishResultCode(c,l),yield this.acceptAnswer(a.data.data),s.sdp&&this.updateSSRC(s.sdp)}catch(s){throw this._log.error(s),s}})}setBandwidth(n){return _(this,arguments,function*({bandwidth:e,type:i,videoType:s,sdp:o}){if(!Jr())return o?i===h.VIDEO?this.updateVideoBandwidthRestriction(o,e,s):this.updateAudioBandwidthRestriction(o,e):void 0;let a=0;i===h.VIDEO&&(s===h.SMALL?a=2:s===h.AUXILIARY?a=3:a=1);let c=this._peerConnection.getSenders()[a];if(c){let l=c.getParameters();(!l.encodings||l.encodings.length===0)&&(l.encodings=[{}]),l.encodings[0].maxBitrate=e*1e3;try{return yield c.setParameters(l),this._log.info(`${s||""}${i} bandwidth ${e} kbps`),o}catch(u){if(this._log.info(`failed to set bandwidth by setting maxBitrate: ${u}`),o)return i===h.VIDEO?this.updateVideoBandwidthRestriction(o,e,s):this.updateAudioBandwidthRestriction(o,e)}}return o})}updateVideoBandwidthRestriction(e,i,s){let o="AS";Y&&(o="TIAS",i=i*1e3);let n=0,a=-1;return s===h.SMALL?n=1:s===h.AUXILIARY&&(n=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,c=>(a+=1,a===n?`${c}b=${o}:${i}\r
`:c)),e}updateAudioBandwidthRestriction(e,i){let s="AS";return Y&&(s="TIAS",i=i*1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,`m=audio $1\r
c=IN $2\r
b=${s}:${i}\r
`),e}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}connect(){return _(this,null,function*(){try{yield this.exchangeSDP(),yield this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),this.uninstallEvents(),e}})}exchangeSDP(){return _(this,null,function*(){try{yield this.createOffer(),this._log.info("createOffer success, sending offer to remote server"),yield this.doExchangeSDP()}catch(e){throw e}})}createOffer(){return _(this,null,function*(){try{let e=yield this._peerConnection.createOffer(pl);yield this._peerConnection.setLocalDescription(e),e.sdp&&this.updateSSRC(e.sdp)}catch(e){throw e}})}doExchangeSDP(){let e={command:J.PUBLISH,responseCommand:B.PUBLISH_RESULT,data:{type:this._peerConnection.localDescription.type,sdp:this.removeVideoOrientation(this._peerConnection.localDescription.sdp),screen:this.localMainVideoTrack instanceof at||this.localAuxVideoTrack instanceof at,state:this.publishState,constraintConfig:this._mediaSettings},enableLog:!1};return this._log.debug(`sending sdp offer: ${e.data.sdp}`),this._signalChannel.sendWaitForResponse(e).then(i=>{let{code:s,message:o,data:n}=i.data;return s===0?this.acceptAnswer(n):this.checkPublishResultCode(s,o)})}setSDPDirection(e,i,s="all"){let o=ne(e);return o.media.forEach(n=>{(s==="all"||n.type===s)&&(n.direction=i)}),Ve(o)}acceptAnswer(e){return _(this,null,function*(){var i,s,o,n,a;try{let c;if(this._publishingLocalAudioTrack||this._publishingLocalVideoTrack||this.isMainStreamPublished){let m=((i=this._publishingLocalVideoTrack)==null?void 0:i.profile.bitrate)||((s=this.localMainVideoTrack)==null?void 0:s.profile.bitrate),f=((o=this._publishingLocalAudioTrack)==null?void 0:o.profile.bitrate)||((n=this.localMainAudioTrack)==null?void 0:n.profile.bitrate);if(m){let O=this._isPublishingAux?h.AUXILIARY:h.BIG;c=yield this.setBandwidth({bandwidth:m,type:h.VIDEO,sdp:c,videoType:O})}f&&(c=yield this.setBandwidth({bandwidth:f,type:h.AUDIO,sdp:c}))}if(c=this.removeVideoOrientation(e.sdp),(a=this._publishingLocalVideoTrack)!=null&&a.small){let{smallStreamConfig:m}=this._room;c=yield this.setBandwidth({bandwidth:this._publishingLocalVideoTrack.small.bitrate||m.bitrate,type:h.VIDEO,videoType:h.SMALL,sdp:c})}let u={type:e.type,sdp:c};yield this._peerConnection.setRemoteDescription(u),this._log.debug(`accepted answer: ${c}`)}catch(c){throw this._log.error(`failed to accept remote answer ${c}`),c}})}sendMutedFlag(e){var o,n,a;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let s={audio:!!((o=this.localMainAudioTrack)!=null&&o.muted),bigVideo:!!((n=this.localMainVideoTrack)!=null&&n.muted),auxVideo:!!((a=this.localAuxVideoTrack)!=null&&a.muted)};this._log.info(`send muted state: ${JSON.stringify(s)}`),this._signalChannel.send(J.UPDATE_MUTE_STAT,s)}getIsReconnecting(){return this._isReconnecting}reconnect(){return _(this,null,function*(){if(!(ii(za.prototype,this,"beforeReconnect").call(this)<0))try{yield this._signalChannel.sendWaitForResponse({command:J.UNPUBLISH,responseCommand:B.UNPUBLISH_RESULT,enableLog:!1}),this.closePeerConnection(),this.initialize(),this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0})),this._log.warn("reconnect() uplink reconnect successfully"),this.stopReconnection()}catch(i){let s=we(this._reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${s/1e3}s`),this._reconnectionTimer=setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},s)}})}handleConnectionStateChange(e){e.state==="CONNECTED"&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&E.emit(p.SEND_FIRST_VIDEO_FRAME,{room:this._room})}updateSSRC(e){try{ne(e).media.forEach((s,o)=>{if(s.type===h.AUDIO){let n=s.ssrcs&&s.ssrcs[0];n&&(this.ssrc.audio=Number(n.id))}else{if(this._sdpSemantics===Wi&&s.ssrcGroups){s.ssrcGroups.forEach((a,c)=>{let l=Number(a.ssrcs.split(" ")[0]);c===0?this.ssrc.video=l:c===1&&(this.ssrc.small=l)});return}let n=s.ssrcs&&s.ssrcs[0];if(!n)return;switch(o){case 1:this.ssrc.video=Number(n.id);break;case 2:this.ssrc.small=Number(n.id);break;case 3:this.ssrc.auxiliary=Number(n.id);break;default:break}}})}catch(i){}}getVideoTrackId(e=h.VIDEO){if(this._peerConnection){let i=this._peerConnection.getSenders();if(e===h.AUXILIARY&&i[3]&&i[3].track)return i[3].track.id;if(e===h.VIDEO&&i[1]&&i[1].track)return i[1].track.id}if(this.localMainVideoTrack&&e===h.VIDEO){let i=this.localMainVideoTrack.mediaTrack;if(i)return i.id}if(this.localAuxVideoTrack&&e===h.AUXILIARY){let i=this.localAuxVideoTrack.mediaTrack;if(i)return i.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,i){if(e!==0)throw e===di?(this._log.error(le.NOT_SUPPORTED_H264ENCODE),new A({code:I.NOT_SUPPORTED_H264,message:b({key:C.NOT_SUPPORTED_H264ENCODE})})):new A({code:I.UNKNOWN,message:b({key:C.SIGNAL_RESPONSE_FAILED,data:{signalResponse:B.PUBLISH_RESULT,code:e,message:i}})})}sendSEI(e,i){var s;(s=this._sei)==null||s.push(e,i)}},ms=za;y([W(r=>function(...t){return new Promise((e,i)=>{let s=o=>{this._emitter.off("closed",s),i(new A({code:I.API_CALL_ABORTED,message:b({key:C.CONNECTION_ABORTED,data:o})}))};this._emitter.on("closed",s),r.apply(this,t).then(e,i).finally(()=>{this._emitter.off("closed",s)})})})],ms.prototype,"publish",1),y([ho(Pe.prototype.afterConnect),uo(Pe.prototype.beforeConnect)],ms.prototype,"connect",1);var ko=ms;var _s=class{constructor(t,e){this.room=t;d(this,"_log");d(this,"_prevReportTime");d(this,"_prevReport",{});d(this,"_prevEncoderImplementation");d(this,"_prevQualityLimitationReason");d(this,"_prevAuxQualityLimitationReason");d(this,"_prevDecoderImplementationMap",new Map);d(this,"_spcStats",null);this._log=e,this._prevReportTime=0,this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevAuxQualityLimitationReason=""}get statInterval(){return this._prevReportTime===0?2:(Date.now()-this._prevReportTime)/1e3}getSenderStats(t){return _(this,null,function*(){let e={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},i=t.getPeerConnection(),s=t.getSSRC();if(i)try{if((this._spcStats||(yield i.getStats())).forEach(n=>{if(n.type==="outbound-rtp")if(n.mediaType===h.VIDEO){let a,c;if(n.ssrc===s.video?(a=h.VIDEO,c=t.localMainVideoTrack):n.ssrc===s.small?a=h.SMALL:n.ssrc===s.auxiliary&&(c=t.localAuxVideoTrack,a=h.AUXILIARY),!a)return;e[a].bytesSent=n.bytesSent,e[a].packetsSent=n.packetsSent,e[a].framesEncoded=n.framesEncoded,T(n.keyFramesEncoded)||(e[a].keyFramesEncoded=n.keyFramesEncoded),T(n.nackCount)||(e[a].nackCount=n.nackCount),T(n.pliCount)||(e[a].pliCount=n.pliCount),T(n.retransmittedPacketsSent)||(e[a].retransmittedPacketsSent=n.retransmittedPacketsSent),T(n.totalEncodeTime)||(e[a].totalEncodeTime=n.totalEncodeTime),T(n.totalPacketSendDelay)||(e[a].totalPacketSendDelay=n.totalPacketSendDelay),n.ssrc===s.video?(!T(n.encoderImplementation)&&this._prevEncoderImplementation!==n.encoderImplementation&&(this._log.info(`encoderImplementation change to ${n.encoderImplementation}`),this._prevEncoderImplementation=n.encoderImplementation),!T(n.qualityLimitationReason)&&n.bytesSent!==0&&this._prevQualityLimitationReason!==n.qualityLimitationReason&&(this._log.info(`qualityLimitationReason change to ${n.qualityLimitationReason}`),this._prevQualityLimitationReason=n.qualityLimitationReason)):n.ssrc===s.auxiliary&&!T(n.qualityLimitationReason)&&n.bytesSent!==0&&this._prevAuxQualityLimitationReason!==n.qualityLimitationReason&&(this._log.info(`aux qualityLimitationReason change to ${n.qualityLimitationReason}`),this._prevAuxQualityLimitationReason=n.qualityLimitationReason)}else n.mediaType===h.AUDIO&&(e.audio.bytesSent=n.bytesSent,e.audio.packetsSent=n.packetsSent);else n.type==="candidate-pair"?Gt(n)&&Q(n.currentRoundTripTime)&&(e.rtt=Math.floor(n.currentRoundTripTime*1e3)):n.type==="media-source"&&(n.kind===h.AUDIO?(e.audio.audioLevel=n.audioLevel||0,e.audio.totalAudioEnergy=n.totalAudioEnergy||0):n.kind===h.VIDEO&&(n.trackIdentifier===t.getVideoTrackId(h.VIDEO)?e.video.fpsCapture=n.framesPerSecond:n.trackIdentifier===t.getVideoTrackId(h.AUXILIARY)?e.auxiliary.fpsCapture=n.framesPerSecond:e.small.fpsCapture=n.framesPerSecond));if(T(n.audioLevel)||(e.audio.audioLevel=n.audioLevel||0),!T(n.frameWidth)){let a=h.SMALL;n.trackIdentifier===t.getVideoTrackId(h.VIDEO)||n.ssrc===s.video?a=h.VIDEO:(n.trackIdentifier===t.getVideoTrackId(h.AUXILIARY)||n.ssrc===s.auxiliary)&&(a=h.AUXILIARY),e[a].frameWidth=n.frameWidth,e[a].frameHeight=n.frameHeight,e[a].framesSent=n.framesSent}}),t.localMainAudioTrack){let n=t.localMainAudioTrack.getInternalAudioLevel();e.audio.micAudioLevel=n,e.audio.audioLevel===0&&(e.audio.audioLevel=n)}}catch(o){this._log.warn(`failed to getStats on sender connection ${o}`)}return e})}getReceiverStats(t){return _(this,null,function*(){let e={tinyId:t.tinyId,userId:t.userId,rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0,insertedSamplesForDeceleration:0,removedSamplesForAcceleration:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0}},i=t.getPeerConnection();if(i)try{let{ssrc:s}=t,{muteState:o}=t;(this._spcStats||(yield i.getStats())).forEach(a=>{if(a.type==="inbound-rtp"){if(a.mediaType===h.AUDIO&&a.ssrc===s.audio&&o.hasAudio){e.audio.packetsReceived=a.packetsReceived,e.audio.bytesReceived=a.bytesReceived,e.audio.packetsLost=a.packetsLost,a.insertedSamplesForDeceleration&&(e.audio.insertedSamplesForDeceleration=a.insertedSamplesForDeceleration),a.removedSamplesForAcceleration&&(e.audio.removedSamplesForAcceleration=a.removedSamplesForAcceleration);let{remoteAudioTrack:c}=t;c.stat.packetsReceived=a.packetsReceived,c.stat.bytesReceived=a.bytesReceived,c.stat.packetsLost=a.packetsLost,a.jitterBufferDelay&&(c.stat.jitterBufferDelay=Math.floor(a.jitterBufferDelay/a.jitterBufferEmittedCount*1e3)),e.hasAudio=!0}else if(a.mediaType===h.VIDEO){if(Y&&a.bytesReceived===0)return;let c;a.ssrc===s.video&&o.hasVideo&&(e.video.packetsReceived=a.packetsReceived,e.video.bytesReceived=a.bytesReceived,e.video.packetsLost=a.packetsLost,e.video.framesReceived=a.framesReceived,e.video.framesDecoded=a.framesDecoded,e.video.fpsDecoded=a.framesPerSecond,e.hasVideo=!0,c=t.remoteVideoTrack,a.decoderImplementation&&(!this._prevDecoderImplementationMap.has(e.userId)||this._prevDecoderImplementationMap.get(e.userId)!==a.decoderImplementation)&&(this._log.info(`${e.userId} decoderImplementation change to ${a.decoderImplementation}`),this._prevDecoderImplementationMap.set(e.userId,a.decoderImplementation))),a.ssrc===s.auxiliary&&o.hasAuxiliary&&(e.auxiliary.packetsReceived=a.packetsReceived,e.auxiliary.bytesReceived=a.bytesReceived,e.auxiliary.packetsLost=a.packetsLost,e.auxiliary.framesReceived=a.framesReceived,e.auxiliary.framesDecoded=a.framesDecoded,e.auxiliary.fpsDecoded=a.framesPerSecond,c=t.remoteAuxiliaryTrack,e.hasAuxiliary=!0),c&&(c.stat.packetsReceived=a.packetsReceived,c.stat.bytesReceived=a.bytesReceived,c.stat.packetsLost=a.packetsLost,c.stat.framesReceived=a.framesReceived,c.stat.framesDecoded=a.framesDecoded,a.jitterBufferDelay&&(c.stat.jitterBufferDelay=Math.floor(a.jitterBufferDelay/a.jitterBufferEmittedCount*1e3)))}}else a.type==="candidate-pair"&&Gt(a)&&Q(a.currentRoundTripTime)&&(e.rtt=Math.floor(a.currentRoundTripTime*1e3));T(a.frameWidth)||((a.trackIdentifier===t.getMainStreamVideoTrackId()||a.ssrc===s.video)&&(e.video.frameWidth=a.frameWidth,e.video.frameHeight=a.frameHeight,t.remoteVideoTrack.stat.frameWidth=a.frameWidth,t.remoteVideoTrack.stat.frameHeight=a.frameHeight),(a.trackIdentifier===t.getAuxStreamVideoTrackId()||a.ssrc===s.auxiliary)&&(e.auxiliary.frameWidth=a.frameWidth,e.auxiliary.frameHeight=a.frameHeight,t.remoteAuxiliaryTrack.stat.frameWidth=a.frameWidth,t.remoteAuxiliaryTrack.stat.frameHeight=a.frameHeight)),T(a.audioLevel)||(e.audio.audioLevel=a.audioLevel||0,e.audio.totalAudioEnergy=a.totalAudioEnergy||0)}),e.audio.audioLevel===0&&(e.audio.audioLevel=t.remoteAudioTrack.getInternalAudioLevel()||0)}catch(s){this._log.warn(`failed to getStats on receiver connection ${s}`)}return e})}getStats(t,e){return _(this,null,function*(){let i={},s=[];if(this.room.singlePC){let o=this.room.singlePC.getPeerConnection();if(!o)return{senderStats:i,receiverStats:s};let n=yield o.getStats(),a=[],c=new Set(["inbound-rtp","outbound-rtp","track","candidate-pair","media-source"]);n.forEach(l=>c.has(l.type)&&a.push(l)),this._spcStats=a}t&&(i=yield this.getSenderStats(t));for(let[o,n]of e){let a=yield this.getReceiverStats(n);s.push(a)}return{senderStats:i,receiverStats:s}})}getDifferenceValue(t,e){if(At(t))return e;let i=e-t;return i<0?0:i}prepareReport({stats:t,report:e,freezeMap:i}){if(!At(t.senderStats)){let u={uint32_audio_level:t.senderStats.audio.audioLevel*Ut,uint32_audio_energy:t.senderStats.audio.totalAudioEnergy*1e6,uint32_audio_codec_bitrate:t.senderStats.audio.bytesSent};t.senderStats.audio.micAudioLevel&&(u.uint32_mic_audio_level=t.senderStats.audio.micAudioLevel*Ut);let m=[],f={uint32_video_stream_type:2,uint32_video_codec_fps:t.senderStats.video.framesSent,uint32_video_capture_fps:t.senderStats.video.fpsCapture,uint32_video_width:t.senderStats.video.frameWidth,uint32_video_height:t.senderStats.video.frameHeight,uint32_video_codec_bitrate:t.senderStats.video.bytesSent,uint32_video_enc_fps:t.senderStats.video.framesEncoded,uint32_key_frame_count:t.senderStats.video.keyFramesEncoded,uint32_nack_count:t.senderStats.video.nackCount,uint32_pli_count:t.senderStats.video.pliCount,uint32_encode_cost:(t.senderStats.video.totalEncodeTime||0)*1e3,uint32_send_packet_cost:(t.senderStats.video.totalPacketSendDelay||0)*1e3,uint32_video_arq_packets:t.senderStats.video.retransmittedPacketsSent};if(m.push(f),t.senderStats.small.bytesSent){let N={uint32_video_stream_type:3,uint32_video_codec_fps:t.senderStats.small.framesSent||0,uint32_video_capture_fps:t.senderStats.small.fpsCapture||0,uint32_video_width:t.senderStats.small.frameWidth||0,uint32_video_height:t.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.small.bytesSent,uint32_video_enc_fps:t.senderStats.small.framesEncoded||0,uint32_key_frame_count:t.senderStats.small.keyFramesEncoded,uint32_nack_count:t.senderStats.small.nackCount,uint32_pli_count:t.senderStats.small.pliCount,uint32_encode_cost:(t.senderStats.small.totalEncodeTime||0)*1e3,uint32_send_packet_cost:(t.senderStats.small.totalPacketSendDelay||0)*1e3,uint32_video_arq_packets:t.senderStats.small.retransmittedPacketsSent};m.push(N)}if(t.senderStats.auxiliary.bytesSent){let N={uint32_video_stream_type:7,uint32_video_codec_fps:t.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:t.senderStats.auxiliary.fpsCapture||0,uint32_video_width:t.senderStats.auxiliary.frameWidth||0,uint32_video_height:t.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:t.senderStats.auxiliary.framesEncoded||0,uint32_key_frame_count:t.senderStats.auxiliary.keyFramesEncoded,uint32_nack_count:t.senderStats.auxiliary.nackCount,uint32_pli_count:t.senderStats.auxiliary.pliCount,uint32_encode_cost:(t.senderStats.auxiliary.totalEncodeTime||0)*1e3,uint32_send_packet_cost:(t.senderStats.auxiliary.totalPacketSendDelay||0)*1e3,uint32_video_arq_packets:t.senderStats.auxiliary.retransmittedPacketsSent};m.push(N)}let O={uint32_bitrate:0,uint32_lost:0,uint32_rtt:t.senderStats.rtt};e.msg_up_stream_info={msg_audio_status:u,msg_video_status:m,msg_network_status:O}}let{statInterval:s}=this;e.msg_down_stream_info=[],t.receiverStats.forEach(u=>{let m={msg_user_info:{str_identifier:u.userId,uint64_tinyid:u.tinyId},msg_network_status:{uint32_rtt:u.rtt,uint32_bitrate:0,uint32_lost:0},msg_audio_status:{},msg_video_status:[]};if(u.hasAudio){let f={uint32_audio_codec_bitrate:u.audio.bytesReceived,uint32_audio_total_bitrate:u.audio.bytesReceived,uint32_audio_level:u.audio.audioLevel*1e8,uint32_audio_energy:u.audio.totalAudioEnergy*1e6,uint32_audio_receive:u.audio.packetsReceived,uint32_audio_origin_lost:u.audio.packetsLost};m.msg_audio_status=f}if(u.hasVideo){let f=i.get(`${u.userId}_${dn}`),O=f?f.duration:0,N={uint32_video_stream_type:2,uint32_video_receive_fps:u.video.framesReceived,uint32_video_width:u.video.frameWidth,uint32_video_height:u.video.frameHeight,uint32_video_codec_bitrate:u.video.bytesReceived,uint32_video_receive:u.video.packetsReceived,uint32_video_origin_lost:u.video.packetsLost,uint32_video_block_time:O,uint32_video_dec_fps:u.video.framesDecoded};m.msg_video_status.push(N)}if(u.hasAuxiliary){let f=i.get(`${u.userId}_${ln}`),O=f?f.duration:0,N={uint32_video_stream_type:7,uint32_video_receive_fps:u.auxiliary.framesReceived,uint32_video_width:u.auxiliary.frameWidth,uint32_video_height:u.auxiliary.frameHeight,uint32_video_codec_bitrate:u.auxiliary.bytesReceived,uint32_video_receive:u.auxiliary.packetsReceived+u.auxiliary.packetsLost,uint32_video_origin_lost:u.auxiliary.packetsLost,uint32_video_block_time:O,uint32_video_dec_fps:u.auxiliary.framesDecoded};m.msg_video_status.push(N)}e.msg_down_stream_info.push(m)});let o=this._prevReport;if(this._prevReport=JSON.parse(JSON.stringify(e)),e.msg_up_stream_info.msg_audio_status&&o.msg_up_stream_info.msg_audio_status){let u=o.msg_up_stream_info.msg_audio_status,m=e.msg_up_stream_info.msg_audio_status;if(u.uint32_audio_codec_bitrate===0)m.uint32_audio_codec_bitrate=0;else{let f=this.getDifferenceValue(u.uint32_audio_codec_bitrate,m.uint32_audio_codec_bitrate);m.uint32_audio_codec_bitrate=Math.round(f*8/s),e.msg_up_stream_info.msg_network_status.uint32_bitrate+=m.uint32_audio_codec_bitrate}}let n=o.msg_up_stream_info.msg_video_status;e.msg_up_stream_info.msg_video_status.forEach(u=>{let m=n.find(oe=>oe.uint32_video_stream_type===u.uint32_video_stream_type);if(!m||m.uint32_video_codec_bitrate===0){u.uint32_video_codec_bitrate=0,u.uint32_video_enc_fps=0,u.uint32_video_codec_fps=0;return}let f=0,O=0,N=0;m&&u.uint32_video_codec_bitrate>=m.uint32_video_codec_bitrate&&(f=m.uint32_video_codec_bitrate,O=m.uint32_video_enc_fps,N=m.uint32_video_codec_fps);let w=this.getDifferenceValue(f,u.uint32_video_codec_bitrate);u.uint32_video_codec_bitrate=Math.round(w*8/s),e.msg_up_stream_info.msg_network_status.uint32_bitrate+=u.uint32_video_codec_bitrate,u.uint32_video_enc_fps=Math.round(this.getDifferenceValue(O,u.uint32_video_enc_fps)/s),u.uint32_video_codec_fps=Math.round(this.getDifferenceValue(N,u.uint32_video_codec_fps)/s),ri&&qe()===115&&m.uint32_video_width===0&&m.uint32_video_height===0&&m.uint32_video_codec_fps===0&&(u.uint32_video_codec_fps=u.uint32_video_enc_fps),T(m.uint32_key_frame_count)||(u.uint32_key_frame_count=Math.round(this.getDifferenceValue(m.uint32_key_frame_count,u.uint32_key_frame_count))),T(m.uint32_nack_count)||(u.uint32_nack_count=Math.round(this.getDifferenceValue(m.uint32_nack_count,u.uint32_nack_count))),T(m.uint32_pli_count)||(u.uint32_pli_count=Math.round(this.getDifferenceValue(m.uint32_pli_count,u.uint32_pli_count))),T(m.uint32_video_arq_packets)||(u.uint32_video_arq_packets=Math.round(this.getDifferenceValue(m.uint32_video_arq_packets,u.uint32_video_arq_packets))),T(m.uint32_encode_cost)||(u.uint32_encode_cost=Math.round(this.getDifferenceValue(m.uint32_encode_cost,u.uint32_encode_cost)/s)),T(m.uint32_send_packet_cost)||(u.uint32_send_packet_cost=Math.round(this.getDifferenceValue(m.uint32_send_packet_cost,u.uint32_send_packet_cost)/s))});let c=e.msg_down_stream_info,l=o.msg_down_stream_info;return c.forEach(u=>{let m=l.find(f=>f.msg_user_info.uint64_tinyid===u.msg_user_info.uint64_tinyid);if(!!m){if(!At(u.msg_audio_status)&&!At(m.msg_audio_status)){let f=u.msg_audio_status,O=m.msg_audio_status;f.uint32_audio_origin_lost=this.getDifferenceValue(O.uint32_audio_origin_lost,f.uint32_audio_origin_lost),f.uint32_audio_receive=this.getDifferenceValue(O.uint32_audio_receive,f.uint32_audio_receive),f.uint32_audio_receive+=f.uint32_audio_origin_lost;let N=this.getDifferenceValue(O.uint32_audio_codec_bitrate,f.uint32_audio_codec_bitrate);f.uint32_audio_codec_bitrate=Math.round(N*8/s),f.uint32_audio_total_bitrate=Math.round(N*8/s)}else u.msg_audio_status={};if(u.msg_video_status&&m.msg_video_status){let f=m.msg_video_status;u.msg_video_status=u.msg_video_status.filter(N=>f.find(w=>w.uint32_video_stream_type===N.uint32_video_stream_type)),u.msg_video_status.forEach(N=>{let w=f.find(Hl=>Hl.uint32_video_stream_type===N.uint32_video_stream_type),oe=w.uint32_video_receive,Lt=w.uint32_video_origin_lost,Is=w.uint32_video_codec_bitrate,Ul=w.uint32_video_receive_fps,Vl=w.uint32_video_dec_fps;N.uint32_video_origin_lost=this.getDifferenceValue(Lt,N.uint32_video_origin_lost),N.uint32_video_receive=this.getDifferenceValue(oe,N.uint32_video_receive)+N.uint32_video_origin_lost;let Bl=this.getDifferenceValue(Is,N.uint32_video_codec_bitrate);N.uint32_video_codec_bitrate=Math.round(Bl*8/s);let $l=this.getDifferenceValue(Ul,N.uint32_video_receive_fps);N.uint32_video_receive_fps=Math.round($l/s),N.uint32_video_dec_fps=Math.round(this.getDifferenceValue(Vl,N.uint32_video_dec_fps)/s)})}}}),e}getStatsReport(s){return _(this,arguments,function*({uplinkConnection:t,downlinkConnections:e,freezeMap:i}){let o={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:0},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}}]},n=yield this.getStats(t,e);return JSON.stringify(this._prevReport)==="{}"&&(this._prevReport=JSON.parse(JSON.stringify(o))),this.prepareReport({stats:n,report:o,freezeMap:i}),this._prevReportTime=Date.now(),o})}reset(){this._prevReportTime=0,this._prevReport={},this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevDecoderImplementationMap=new Map}};var El=Ne(Me());var Za=class extends El.default{constructor({signalChannel:e,room:i}){super();d(this,"_room");d(this,"_signalChannel");d(this,"_log");d(this,"_uplinkRTT",0);d(this,"_uplinkLoss",0);d(this,"_downlinkRTT",0);d(this,"_downlinkLoss",0);d(this,"_downlinkPrevStatMap",new Map);d(this,"_downlinkLossAndRTTMap",new Map);d(this,"_interval",-1);d(this,"_uplinkNetworkQuality",0);d(this,"_downlinkNetworkQuality",0);this._room=i,this._signalChannel=e,this._log=g.createLogger({id:"q",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this.initialize()}get uplinkNetworkQuality(){return this._uplinkNetworkQuality}set uplinkNetworkQuality(e){e!==this._uplinkNetworkQuality&&this._log.info(`uplink network quality change ${this.uplinkNetworkQuality} -> ${e}, rtt: ${this._uplinkRTT}, loss: ${this._uplinkLoss}`),this._uplinkNetworkQuality=e}get downlinkNetworkQuality(){return this._downlinkNetworkQuality}set downlinkNetworkQuality(e){if(e!==this._downlinkNetworkQuality){let{rtt:i,loss:s}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._log.info(`downlink network quality change ${this.downlinkNetworkQuality} -> ${e}, rtt: ${i}, loss: ${s}`)}this._downlinkNetworkQuality=e}initialize(){this._signalChannel.on(B.UPLINK_NETWORK_STATS,e=>{this.handleUplinkNetworkQuality(e)}),this._signalChannel.on(se.CONNECTION_STATE_CHANGED,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){var c,l;if(e.data.code!==0)return;let i=e.data.data;if(i.delay&&this.updateDelay(i.delay),!this._room.uplinkConnection){this.uplinkNetworkQuality=0,this._uplinkLoss=0,this._uplinkRTT=0;return}let s=(l=(c=this._room)==null?void 0:c.uplinkConnection)==null?void 0:l.getPeerConnection();if(s&&this.isPeerConnectionDisconnected(s)){this.uplinkNetworkQuality=6,this._uplinkLoss=0,this._uplinkRTT=0;return}let o=i.expectAudPkg+i.expectVidPkg,n=i.recvAudPkg+i.recvVidPkg,a=o-n;o===0&&n===0||(a<=0?this._uplinkLoss=0:this._uplinkLoss=Math.round(a/o*100),this._uplinkRTT=i.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this._uplinkLoss,this._uplinkRTT))}handleDownlinkNetworkQuality(){return _(this,null,function*(){if(this._room.remotePublishedUserMap.size===0){this.downlinkNetworkQuality=0;return}let e=[...this._room.remotePublishedUserMap.values()],i=e.filter(a=>{var c;return((c=a.getPeerConnection())==null?void 0:c.connectionState)===Z.CONNECTED});if(e.filter(a=>this.isPeerConnectionDisconnected(a.getPeerConnection())).length===e.length){this.downlinkNetworkQuality=6;return}for(let a=0;a<i.length;a++){let c=i[a].getPeerConnection();if(!c)return;let{rtt:l,totalPacketsLost:u,totalPacketsReceived:m}=yield this.getStat(c);if(!this._downlinkPrevStatMap.has(c)){this._downlinkPrevStatMap.set(c,{totalPacketsLost:u,totalPacketsReceived:m});continue}let f=0,O=this._downlinkPrevStatMap.get(c),N=u-O.totalPacketsLost,w=m-O.totalPacketsReceived;N<=0||w<0?f=0:f=Math.round(N/(N+w)*100),this._downlinkPrevStatMap.set(c,{totalPacketsLost:u,totalPacketsReceived:m}),this._downlinkLossAndRTTMap.set(c,{rtt:l,loss:f,userId:i[a].getUserId(),audioDelay:i[a].remoteAudioTrack.stat.end2EndDelay,videoDelay:i[a].remoteVideoTrack.stat.end2EndDelay})}if([...this._downlinkPrevStatMap.keys()].forEach(a=>{this.isPeerConnectionDisconnected(a)&&(this._downlinkPrevStatMap.delete(a),this._downlinkLossAndRTTMap.delete(a))}),this._downlinkLossAndRTTMap.size===0)return;let{rtt:o,loss:n}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._downlinkRTT=o,this._downlinkLoss=n,this.downlinkNetworkQuality=this.getNetworkQuality(n,o)})}getStat(e){return _(this,null,function*(){let i={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!mi())return i;let s=e.getReceivers();try{for(let o=0;o<s.length;o++)(yield s[o].getStats()).forEach(c=>{c.type==="candidate-pair"&&Q(c.currentRoundTripTime)&&(i.rtt=Math.round(c.currentRoundTripTime*1e3)),c.type==="inbound-rtp"&&(c.mediaType===h.AUDIO||c.mediaType===h.VIDEO)&&(i.totalPacketsLost+=c.packetsLost,i.totalPacketsReceived+=c.packetsReceived)});return i}catch(o){return i}})}getAverageLossAndRTT(e){let i={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach(s=>{i.rtt+=s.rtt,i.loss+=s.loss}),Object.keys(i).forEach(s=>{i[s]=Math.round(i[s]/e.length)})),i}getNetworkQuality(e,i){return e>50||i>500?5:e>30||i>350?4:e>20||i>200?3:e>10||i>100?2:e>=0||i>=0?1:0}handleSignalConnectionStateChange(e){e.state===Le.DISCONNECTED?(this._uplinkRTT=0,this._uplinkLoss=0,this.uplinkNetworkQuality=6):e.state===Le.CONNECTED&&this.uplinkNetworkQuality===6&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange({state:e}){e==="DISCONNECTED"?(this._uplinkLoss=0,this._uplinkRTT=0,this.uplinkNetworkQuality=6):e==="CONNECTED"&&this.uplinkNetworkQuality===6&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!!(e&&(e.connectionState===Z.DISCONNECTED||e.connectionState===Z.FAILED||e.connectionState===Z.CLOSED))}setUplinkConnection(e){this._room.uplinkConnection=e,this._room.uplinkConnection?this._room.uplinkConnection.on(Zc.CONNECTION_STATE_CHANGED,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this._uplinkRTT=0,this._uplinkLoss=0)}start(){if(this._interval!==-1){this._log.info("network quality calculating is already started");return}this._log.debug("start network quality calculating"),this._interval=ee.run(et,()=>{this.handleDownlinkNetworkQuality();let e=[...this._downlinkLossAndRTTMap.values()];E.emit(p.NETWORK_QUALITY,{room:this._room,uplink:{rtt:this._uplinkRTT,loss:this._uplinkLoss},downlinks:e}),this.emit(Za.EVENT_NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this._uplinkRTT,uplinkLoss:this._uplinkLoss,downlinkRTT:this._downlinkRTT,downlinkLoss:this._downlinkLoss,downlinkInfo:e})},{delay:2e3})}stop(){this._log.info("stop network quality calculating"),this._interval!==-1&&(ee.clearTask(this._interval),this._interval=-1),this._downlinkLossAndRTTMap.clear(),this._downlinkPrevStatMap.clear()}updateDelay(e){let{tinyIdToUserIdMap:i}=this._room;e.forEach(({srcTinyId:s,videoDelay:o,audioDelay:n})=>{let a=i.get(s);if(a){let c=this._room.remotePublishedUserMap.get(a);c==null||c.setDelay({videoDelay:o,audioDelay:n})}})}},Oi=Za;d(Oi,"EVENT_NETWORK_QUALITY","0");var vt=new WeakMap;function lr({settings:r={retries:5,timeout:2e3},onError:t,onRetrying:e,onRetryFailed:i}){return function(s,o,n){let a=rt({retryFunction:n.value,settings:r,onError(c,l,u,m){t&&t.call(this,c,()=>{var f;(f=vt.get(s))!=null&&f.has(o)?l():u(c)},u,m)},onRetrying:(c,l)=>{var u;j(e)&&e(c,l),(u=vt.get(s))!=null&&u.has(o)&&(vt.get(s).get(o).stopRetry=l)},onRetryFailed:i});return n.value=function(...c){let l=vt.get(s);return l?l.set(o,{args:c}):vt.set(s,new Map([[o,{args:c}]])),a.apply(this,c).finally(()=>{var u;return(u=vt.get(s))==null?void 0:u.delete(o)})},n}}function ps({fnName:r,callback:t,validateArgs:e=!0}){return function(i,s,o){let n=o.value;return o.value=function(...a){var c,l;if((c=vt.get(i))!=null&&c.has(r)){let{stopRetry:u,args:m}=vt.get(i).get(r),f=!0;if(e){for(let O of m)if(!a.find(N=>N===O)){f=!1;break}}f&&(t&&t.apply(this,a),u&&u(),(l=vt.get(i))==null||l.delete(r))}return n.apply(this,a)},o}}function hm({fn:r,context:t}){return function(...e){try{let i=r.apply(t||this,e);return $r(i)?i.catch(s=>g.error(`${r.name}() error observed ${s}`)):i}catch(i){g.error(`${r.name}() error observed ${i}`)}}}var wo=class{constructor(t){this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0};this._apiSuccessRateMap=new Map;this._eventMap=new Map;this._frameWorkType=t.frameWorkType||30,this._component=t.component||0,this.connectionType=t.connectionType||1,this._language=t.language||0,this._room=t.room,this._keyPrefix="key_point",this._log=g.createLogger({id:"kpm",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),Object.getOwnPropertyNames(this.__proto__).forEach(e=>{e.startsWith("handle")&&j(this[e])&&(this[e]=hm({fn:this[e],context:this}))}),this.initData(),this.installEvents(),this._intervalId=ee.run(et,this.setStorage.bind(this),{delay:2e4})}get _storageKey(){return`${this._keyPrefix}_${this._room.userId}`}initData(){this._firstPublishedUserList=[],this._networkQuality={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this._basicInfo={string_sdk_version:Ie,uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:this._room.scene==="live"?1:0,uint32_joining_duration:0,uint32_networkType:kt[zs()],uint32_framework:this._frameWorkType,uint32_component:this._component,uint32_connection_type:this.connectionType,uint32_caller_coding_language:this._language,string_domain:location.hostname},this._pathJoinRoom={uint64_start_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this._pathLeaveRoom={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this._localStreamStat={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this._pathMainVideoMap=new Map,this._pathMainAudioMap=new Map,this._pathAuxiliaryMap=new Map,this._remoteStreamStatMap=new Map,this._apiSuccessRateMap.clear(),Lr().then(t=>{this._basicInfo.string_os_version=Zo(),t&&(this._basicInfo.string_device_name=t.model)})}addEvent(t,e){return this._eventMap.set(t,e),E.on(t,e),this}installEvents(){this.handleUnload=this.handleUnload.bind(this),window.addEventListener("unload",this.handleUnload),this._room.once("banned",()=>this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId})),this.addEvent(p.JOIN_START,this.handleJoinStart).addEvent(p.JOIN_SIGNAL_CONNECTION_START,this.handleSignalConnectionStart).addEvent(p.JOIN_SIGNAL_CONNECTION_END,this.handleSignalConnectionEnd).addEvent(p.JOIN_SEND_CMD,this.handleJoinSendCMD).addEvent(p.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce).addEvent(p.JOIN_SUCCESS,this.handleJoinSuccess).addEvent(p.JOIN_FAILED,this.handleJoinFailed).addEvent(p.LEAVE_START,this.handleLeaveStart).addEvent(p.LEAVE_SUCCESS,this.handleLeaveSuccess).addEvent(p.LEAVE_SEND_CMD,this.handleLeaveSendCMD).addEvent(p.LOCAL_TRACK_CAPTURE_START,this.handleTrackCaptureStart).addEvent(p.LOCAL_TRACK_CAPTURE_SUCCESS,this.handleTrackCaptureSuccess).addEvent(p.LOCAL_TRACK_CAPTURE_FAILED,this.handleTrackCaptureFailed).addEvent(p.PUBLISH_START,this.handlePublishStart).addEvent(p.SEND_FIRST_VIDEO_FRAME,this.handleSendFirstVideoFrame).addEvent(p.SUBSCRIBE_START,this.handleSubscribeStart).addEvent(p.SUBSCRIBE_SUCCESS,this.handleSubscribed).addEvent(p.PLAY_TRACK_START,this.handlePlayStart).addEvent(p.VIDEO_LOADED_DATA,this.handleVideoLoadedData).addEvent(p.PLAYER_STATE_CHANGED,({track:t,state:e,type:i})=>{!Vt(t)||!this.hitTest(t.room)||e==="PLAYING"&&(i===h.AUDIO?this.handleAudioPlaying(t):this.handleVideoPlaying(t))}).addEvent(p.NETWORK_QUALITY,this.handleNetworkQuality).addEvent(p.HEARTBEAT_REPORT,this.handleHeartbeatStats).addEvent(p.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList).addEvent(p.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:i})=>{if(!this.hitTest(t))return;let s=e.hasAudio||e.hasVideo||e.hasSmall,o=e.hasAuxiliary,n=i.hasAudio||i.hasVideo||i.hasSmall,a=i.hasAuxiliary;!s&&n&&this.handleRemoteStreamAdded(i.userId,"main"),!o&&a&&this.handleRemoteStreamAdded(i.userId,"auxiliary")}).addEvent(p.API_SUCCESS_RATE,this.handleAPISuccessRate)}uninstallEvents(){window.removeEventListener("unload",this.handleUnload),this._eventMap.forEach((t,e)=>E.off(e,t)),this._eventMap.clear()}destroy(){this.uninstallEvents(),ee.clearTask(this._intervalId)}handleUnload(){this._room.isJoined&&this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId})}handleJoinStart(t){this.hitTest(t.room)&&(this._pathJoinRoom.uint64_start_time===0&&(this._pathJoinRoom.uint64_start_time=Date.now(),this.checkStorage()),t.params&&(T(t.params.frameWorkType)||(this._frameWorkType=t.params.frameWorkType,this._basicInfo.uint32_framework=this._frameWorkType),T(t.params.component)||(this._component=t.params.component,this._basicInfo.uint32_component=this._component),T(t.params.language)||(this._language=t.params.language,this._basicInfo.uint32_caller_coding_language=this._language)))}handleSignalConnectionStart({room:t}){this.hitTest(t)&&this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time===0&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleSignalConnectionEnd({room:t,error:e}){this.hitTest(t)&&this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time===0&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time=Date.now(),e&&(this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret=e instanceof A?Number(e.getExtraCode()||e.getCode()):I.UNKNOWN,this._pathJoinRoom.int32_end_ret=2))}handleJoinSendCMD(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time===0&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time===0&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time=Date.now(),this._pathJoinRoom.int32_send_request_enter_room_cmd_ret=t.code,t.code!==0&&(this._pathJoinRoom.int32_end_ret=3))}handleJoinSuccess(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_end_time===0&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret=0,this._signalInfo=t.room.getSignalInfo())}handleJoinFailed({room:t}){this.hitTest(t)&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret===0&&(this._pathJoinRoom.int32_end_ret=3),setTimeout(()=>{this.report()}))}handleReceivedPublishUserList(t){this.hitTest(t.room)&&this._pathJoinRoom.uint64_recv_userlist_time===0&&(this._pathJoinRoom.uint64_recv_userlist_time=Date.now(),this._firstPublishedUserList=t.publishedUserList||[])}handleSendFirstVideoFrame({room:t}){!this.hitTest(t)||this._pathJoinRoom.uint64_send_first_video_frame_time===0&&this._pathJoinRoom.uint64_start_time!==0&&(this._pathJoinRoom.uint64_send_first_video_frame_time=Date.now())}handleLeaveStart(t){this.hitTest(t.room)&&(this._pathLeaveRoom.uint64_start_time=Date.now())}handleLeaveSuccess(t){this.hitTest(t.room)&&this._pathLeaveRoom.uint64_end_time===0&&(this._pathLeaveRoom.uint64_end_time=Date.now(),this._pathJoinRoom.uint64_end_time!==0?this._basicInfo.uint32_joining_duration=this._pathLeaveRoom.uint64_end_time-this._pathJoinRoom.uint64_end_time:this._log.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(t){this.hitTest(t.room)&&(this._pathLeaveRoom.uint64_send_request_exit_room_cmd_start_time=Date.now(),this._pathLeaveRoom.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded(t,e){var s;let i=`${t}_${e}`;if(!this._remoteStreamStatMap.has(i)){let o={userId:t,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:k(R({},mm),{msg_user_info:new Es({userId:t,tinyId:(s=this._room.remotePublishedUserMap.get(t))==null?void 0:s.tinyId,role:20})})};o.statsToReport.uint32_stream_type=e==="main"?2:7,this._remoteStreamStatMap.set(i,o)}}handleSubscribeStart({room:t,remotePublishedUser:e,streamType:i,subscribeState:s}){if(!this.hitTest(t))return;let{userId:o,tinyId:n,role:a}=e,c=new Es({userId:o,tinyId:n,role:a==="anchor"?20:21}),l=Date.now(),u=`${o}_${i}`,m=this._remoteStreamStatMap.get(u);m&&m.subscribeStartTime===0&&(m.subscribeStartTime=l),i==="main"?(e.muteState.hasVideo&&(s.video||s.smallVideo)&&!this._pathMainVideoMap.has(u)&&this._pathMainVideoMap.set(u,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0},userId:o,sendSubscribeCMDTime:l}),e.muteState.hasAudio&&s.audio&&!this._pathMainAudioMap.has(u)&&this._pathMainAudioMap.set(u,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_play_first_frame_time:0},userId:o,sendSubscribeCMDTime:l})):e.muteState.hasAuxiliary&&s.auxiliary&&!this._pathAuxiliaryMap.has(u)&&this._pathAuxiliaryMap.set(u,{sendSubscribeCMDTime:l})}handleSubscribed({room:t,remotePublishedUser:e,streamType:i}){if(this.hitTest(t)){let s=`${e.userId}_${i}`,o=this._remoteStreamStatMap.get(s);o&&o.subscribedTime===0&&(o.subscribedTime=Date.now())}}handlePlayStart({track:t}){if(!Vt(t)||!this.hitTest(t.room))return;let e=`${t.userId}_${t.streamType}`,i=this._remoteStreamStatMap.get(e);(i==null?void 0:i.playStreamTime)===0&&(i.playStreamTime=Date.now())}handleVideoLoadedData({track:t}){if(!Vt(t)||!this.hitTest(t.room))return;let e=`${t.userId}_${t.streamType}`,i=this._pathMainVideoMap.get(e);i&&i.statsToReport.uint64_combine_first_frame_time===0&&(i.statsToReport.uint64_combine_first_frame_time=Date.now())}handleVideoPlaying(t){let e=`${t.userId}_${t.streamType}`,i=Date.now(),s=this._pathMainVideoMap.get(e),o=this._remoteStreamStatMap.get(e);if(s&&(s.statsToReport.uint64_render_first_frame_time===0&&(s.statsToReport.uint64_render_first_frame_time=i),o)){let{statsToReport:a,playStreamTime:c,subscribedTime:l}=o;a.uint32_video_render_first===0&&c-l<=100&&(a.uint32_video_render_first=i-s.sendSubscribeCMDTime)}let n=this._pathAuxiliaryMap.get(e);if(n&&o){let{statsToReport:a,playStreamTime:c,subscribedTime:l}=o;a.uint32_video_render_first===0&&c-l<=100&&(a.uint32_video_render_first=i-n.sendSubscribeCMDTime)}}handleAudioPlaying(t){let e=`${t.userId}_${t.streamType}`,i=this._pathMainAudioMap.get(e);i&&i.statsToReport.uint64_play_first_frame_time===0&&(i.statsToReport.uint64_play_first_frame_time=Date.now())}handleNetworkQuality(t){this.hitTest(t.room)&&(this._networkQuality.totalUplinkLoss+=t.uplink.loss,this._networkQuality.totalUplinkRTT+=t.uplink.rtt,this._networkQuality.count++,t.downlinks.forEach(({rtt:e,loss:i,userId:s,videoDelay:o,audioDelay:n})=>{let a=this._networkQuality.totalDownlinkRTTAndLossMap.get(s);if(a)a.totalRTT+=e,a.totalLoss+=i,o&&(a.totalVideoDelay=(a.totalVideoDelay||0)+o,a.videoDelayCount=(a.videoDelayCount||0)+1),n&&(a.totalAudioDelay=(a.totalAudioDelay||0)+n,a.audioDelayCount=(a.audioDelayCount||0)+1),a.count++;else{let c,l,u,m;o&&(l=o,u=1),n&&(c=n,m=1),this._networkQuality.totalDownlinkRTTAndLossMap.set(s,{totalRTT:e,totalLoss:i,count:1,totalAudioDelay:c,totalVideoDelay:l,audioDelayCount:m,videoDelayCount:u})}}))}handleHeartbeatStats(t){if(this.hitTest(t.room)){let{msg_up_stream_info:e,msg_down_stream_info:i}=t.report;if(e.msg_video_status[0]){let{uint32_video_codec_bitrate:s,uint32_video_enc_fps:o,uint32_video_width:n,uint32_video_height:a}=e.msg_video_status[0];this._localStreamStat.totalVideoBitrate+=s,this._localStreamStat.totalVideoFPS+=o,this._localStreamStat.totalVideoWidth+=n,this._localStreamStat.totalVideoHeight+=a,this._localStreamStat.videoCount++}if(e.msg_audio_status){let{uint32_audio_level:s}=e.msg_audio_status;Math.floor(s/Ut*100)>0&&(this._localStreamStat.totalAudioLevel+=s/Ut,this._localStreamStat.audioLevelCount++)}i.forEach(s=>{let{msg_user_info:o,msg_audio_status:n,msg_video_status:a}=s,c=o.str_identifier,l=this._room.remotePublishedUserMap.get(c);if(a.forEach(u=>{let m=u.uint32_video_stream_type===2,f=u.uint32_video_stream_type===7,O=`${c}_${m?"main":"auxiliary"}`,N=this._remoteStreamStatMap.get(O);if(!!N&&(m&&(l==null?void 0:l.remoteVideoTrack.isSubscribed)||f&&(l==null?void 0:l.remoteAuxiliaryTrack))){N.totalVideoFPS+=u.uint32_video_receive_fps,N.totalVideoBitrate+=u.uint32_video_codec_bitrate,N.videoCount++,N.statsToReport.uint32_video_width===0&&(N.statsToReport.uint32_video_width=u.uint32_video_width),N.statsToReport.uint32_video_height===0&&(N.statsToReport.uint32_video_height=u.uint32_video_height);let w=m?l.remoteVideoTrack:l.remoteAuxiliaryTrack;w.stat.jitterBufferDelay&&(N.videoJitterBufferDelay=w.stat.jitterBufferDelay),w.stat.framesReceived&&(N.statsToReport.uint32_video_consume_render_rate=Math.floor(w.stat.framesDecoded/w.stat.framesReceived*gs(10,6)))}}),n){let u=`${c}_${"main"}`,m=this._remoteStreamStatMap.get(u);this._remoteStreamStatMap.has(u)&&m&&(l==null?void 0:l.remoteAudioTrack.isSubscribed)&&(m.totalAudioBitrate+=n.uint32_audio_codec_bitrate,m.audioCount++,l.remoteAudioTrack.stat.jitterBufferDelay&&(m.audioJitterBufferDelay=l.remoteAudioTrack.stat.jitterBufferDelay),Math.floor(n.uint32_audio_level/Ut*100)>0&&(m.totalAudioLevel+=n.uint32_audio_level/Ut,m.audioLevelCount++))}})}}handlePublishStart({room:t}){this.hitTest(t)&&this._localStreamStat.publishStartTime===0&&(this._localStreamStat.publishStartTime=Date.now())}handleTrackCaptureStart({track:t}){t.mediaType===1&&!this._pathJoinRoom.uint64_init_audio_start_time&&(this._pathJoinRoom.uint64_init_audio_start_time=Date.now()),t.mediaType===4&&!this._pathJoinRoom.uint64_init_camera_start_time&&(this._pathJoinRoom.uint64_init_camera_start_time=Date.now())}handleTrackCaptureSuccess({track:t}){t.mediaType===1&&!this._pathJoinRoom.uint64_init_audio_end_time&&(this._pathJoinRoom.int32_init_audio_ret=0,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),t.mediaType===4&&!this._pathJoinRoom.uint64_init_camera_end_time&&(this._pathJoinRoom.int32_init_camera_ret=0,this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleTrackCaptureFailed({track:t,error:e}){let s={NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5,InvalidStateError:6,SecurityError:7,TypeError:8}[e.name]||(e instanceof A?e.getExtraCode()||e.getCode():I.UNKNOWN);t.mediaType===1&&!this._pathJoinRoom.uint64_init_audio_end_time&&(this._pathJoinRoom.int32_init_audio_ret=s,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),t.mediaType===4&&!this._pathJoinRoom.uint64_init_camera_end_time&&(this._pathJoinRoom.int32_init_camera_ret=s,this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleAPISuccessRate({room:t,apiName:e,error:i,cost:s}){if(!this.hitTest(t))return;let o=fl[e],n={uint32_function_request_type:o,uint32_avg_value:0,uint32_max_value:0,uint32_request_count:1,uint32_success_count:0,msg_error_code:[]};if(i){let c=i.extraCode||i.code||I.UNKNOWN;z.logFailedEvent({eventType:e,code:c,userId:this._room.userId,error:i});let l={int32_error_code:c,error_count:1};n.msg_error_code.push(l)}else Q(s)&&(z.logSuccessEvent({eventType:e,userId:this._room.userId}),n.uint32_avg_value=s,n.uint32_max_value=s,n.uint32_success_count=1);let a=this._apiSuccessRateMap.get(o);a?(a.uint32_success_count+n.uint32_success_count>0&&(a.uint32_avg_value=(a.uint32_avg_value*a.uint32_success_count+n.uint32_avg_value)/(a.uint32_success_count+n.uint32_success_count)),a.uint32_max_value=Math.max(a.uint32_max_value,n.uint32_max_value),a.uint32_request_count+=1,a.uint32_success_count=a.uint32_success_count+n.uint32_success_count,n.msg_error_code.forEach(c=>{let l=a.msg_error_code.find(u=>u.int32_error_code===c.int32_error_code);l?l.error_count+=1:a.msg_error_code.push(c)})):this._apiSuccessRateMap.set(o,n)}hasVideoFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&Fi)>=0}hasAudioFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&Gi)>=0}hasAuxFlag(t){return this._firstPublishedUserList.findIndex(e=>e.userId===t&&e.flag&kr)>=0}hitTest(t){return t===this._room}checkStorage(){return _(this,null,function*(){try{let t=qi.getItem(this._storageKey);t&&(yield this.upload(t),qi.deleteItem(this._storageKey))}catch(t){this._log.warn(t)}})}setStorage(){this.prepareReport();let t=this.getReportData();t.msg_path_enter_room.uint64_start_time!==0&&qi.setItem(this._storageKey,t)}prepareReport(){if(this._networkQuality.count>0&&(this._basicInfo.uint32_avg_rtt=Math.floor(this._networkQuality.totalUplinkRTT/this._networkQuality.count),this._basicInfo.uint32_avg_up_loss=Math.floor(this._networkQuality.totalUplinkLoss/this._networkQuality.count)),this._localStreamStat.videoCount>0){this._localStreamStat.statsToReport.uint32_video_big_capture_fps=Math.floor(this._localStreamStat.totalVideoFPS/this._localStreamStat.videoCount),this._localStreamStat.statsToReport.uint32_video_big_bitrate=Math.floor(this._localStreamStat.totalVideoBitrate/this._localStreamStat.videoCount);let t=Math.floor(this._localStreamStat.totalVideoWidth/this._localStreamStat.videoCount),e=Math.floor(this._localStreamStat.totalVideoHeight/this._localStreamStat.videoCount);this._localStreamStat.statsToReport.uint32_video_big_resolution=t<<16|e}this._localStreamStat.audioLevelCount>0&&(this._localStreamStat.statsToReport.uint32_audio_capture_db=Math.floor(this._localStreamStat.totalAudioLevel/this._localStreamStat.audioLevelCount*100)),this._remoteStreamStatMap.forEach((t,e)=>{let{userId:i}=t,s=this._networkQuality.totalDownlinkRTTAndLossMap.get(i);if(s){let{totalLoss:u,count:m,audioDelayCount:f,videoDelayCount:O,totalAudioDelay:N,totalVideoDelay:w}=s;t.statsToReport.uint32_avg_down_loss=Math.floor(u/m),f&&N&&(t.statsToReport.uint32_audio_network_p2p_delay=Math.floor(N/f),t.audioJitterBufferDelay&&(t.statsToReport.uint32_p2p_delay=Math.floor(t.statsToReport.uint32_audio_network_p2p_delay+t.audioJitterBufferDelay))),O&&w&&(t.statsToReport.uint32_video_network_p2p_delay=Math.floor(w/O))}t.videoCount>0&&(t.statsToReport.uint32_video_avg_fps=Math.floor(t.totalVideoFPS/t.videoCount),t.statsToReport.uint32_video_avg_bitrate=Math.floor(t.totalVideoBitrate/t.videoCount)),t.audioCount>0&&(t.statsToReport.uint32_audio_recv_bitrate=t.statsToReport.uint32_audio_bitrate=Math.floor(t.totalAudioBitrate/t.audioCount)),t.audioLevelCount>0&&(t.statsToReport.uint32_audio_play_db=Math.floor(t.totalAudioLevel/t.audioLevelCount*100));let{callDurationCalculator:o}=this._room;o&&(t.statsToReport.uint32_audio_play_time=o.getDuration(e,h.AUDIO),t.statsToReport.uint32_video_play_time=o.getDuration(e,h.VIDEO)),t.statsToReport.uint32_video_render_first=Math.min(t.statsToReport.uint32_video_render_first,Di);let{badCaseDetector:n}=this._room,{dataFreeze:a,count:c}=n.getDataFreezeDuration(e),{renderFreeze:l}=n.getRenderFreezeDuration(e);t.statsToReport.uint32_video_block_count=c,t.statsToReport.uint32_video_block_time=Math.min(a,t.statsToReport.uint32_video_play_time),t.statsToReport.uint32_video_external_block_time=Math.min(l,t.statsToReport.uint32_video_play_time),n.isBlackStream(e)&&t.statsToReport.uint32_video_avg_fps===0?t.statsToReport.uint32_video_black_screen_subjective=1:t.statsToReport.uint32_video_black_screen_subjective=0,(t.subscribeStartTime===0||t.subscribeStartTime-t.streamAddedTime>100||t.playStreamTime===0)&&(this._pathMainAudioMap.delete(e),this._pathMainVideoMap.delete(e),t.statsToReport.uint32_video_render_first=0)}),this._pathMainAudioMap.forEach((t,e)=>{if(!this.hasAudioFlag(t.userId)){this._pathMainAudioMap.delete(e);return}t.statsToReport.uint64_play_first_frame_time-t.statsToReport.uint64_start_enter_time>Di&&(t.statsToReport.uint64_play_first_frame_time=t.statsToReport.uint64_start_enter_time+Di)}),this._pathMainVideoMap.forEach((t,e)=>{if(!this.hasVideoFlag(t.userId)){this._pathMainVideoMap.delete(e);return}t.statsToReport.uint64_render_first_frame_time-t.statsToReport.uint64_start_enter_time>Di&&(t.statsToReport.uint64_render_first_frame_time=t.statsToReport.uint64_start_enter_time+Di)}),this._pathJoinRoom.uint64_end_time-this._pathJoinRoom.uint64_start_time>Di&&(this._pathJoinRoom.uint64_end_time=this._pathJoinRoom.uint64_start_time+Di)}getReportData(){return{uint32_sdk_app_id:Number(this._room.sdkAppId),msg_user_info:new Es({userId:this._room.userId,tinyId:this._room.tinyId,role:this._room.role==="anchor"?20:21}),msg_basic_info:this._basicInfo,uint32_acc_ip:Gr(this._signalInfo.relayIp),uint32_client_ip:Gr(this._signalInfo.clientIp,!1),uint32_acc_port:this._signalInfo.relayPort||0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*2147483648),msg_path_enter_room:this._pathJoinRoom,msg_path_exit_room:this._pathLeaveRoom,msg_path_recv_video:[...this._pathMainVideoMap.values()].map(e=>e.statsToReport),msg_quality_statistics:[...this._remoteStreamStatMap.values()].map(e=>e.statsToReport),str_room_name:String(this._room.roomId||0),msg_path_recv_audio:[...this._pathMainAudioMap.values()].map(e=>e.statsToReport),uint32_info_client_ip:Gr(this._signalInfo.clientIp,!1),error_code:[],msg_local_statistics:this._localStreamStat.statsToReport,msg_function_request_stats:[...this._apiSuccessRateMap.values()]}}report(){try{this.prepareReport();let t=this.getReportData();this.upload(t),qi.deleteItem(this._storageKey),this.initData()}catch(t){this._log.warn(t)}}upload(t){if(He||t.msg_path_enter_room.uint64_start_time===0||[Fs,tn,rn].findIndex(o=>o===location.host)>=0)return;let e=Number(this._room.sdkAppId),i=ui(e,ci.KEY_POINT),s=!1;navigator.sendBeacon&&(s=navigator.sendBeacon(i,JSON.stringify(t))),s||Ht({url:i,body:JSON.stringify(t)})}setConnectionType(t){this.connectionType=t,this._basicInfo.uint32_connection_type=t}};y([lr({settings:{timeout:500,retries:3}})],wo.prototype,"upload",1);var Di=5e3,mm={msg_user_info:null,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0,uint32_video_consume_render_rate:0},Es=class{constructor(t){this.str_identifier=String(t.userId),this.str_tinyid=String(t.tinyId||0),this.uint32_role=t.role}},fl=(D=>(D[D.enterRoom=50001]="enterRoom",D[D.exitRoom=50002]="exitRoom",D[D.switchRole=50003]="switchRole",D[D.destroy=50004]="destroy",D[D.startLocalAudio=50005]="startLocalAudio",D[D.updateLocalAudio=50006]="updateLocalAudio",D[D.stopLocalAudio=50007]="stopLocalAudio",D[D.startLocalVideo=50008]="startLocalVideo",D[D.updateLocalVideo=50009]="updateLocalVideo",D[D.stopLocalVideo=50010]="stopLocalVideo",D[D.startScreenShare=50011]="startScreenShare",D[D.updateScreenShare=50012]="updateScreenShare",D[D.stopScreenShare=50013]="stopScreenShare",D[D.enableAudioVolumeEvaluation=50014]="enableAudioVolumeEvaluation",D[D.startRemoteVideo=50015]="startRemoteVideo",D[D.updateRemoteVideo=50016]="updateRemoteVideo",D[D.stopRemoteVideo=50017]="stopRemoteVideo",D[D.muteRemoteAudio=50018]="muteRemoteAudio",D[D.setRemoteAudioVolume=50019]="setRemoteAudioVolume",D[D.startMixTranscode=50020]="startMixTranscode",D[D.stopMixTranscode=50021]="stopMixTranscode",D[D.startPublishCDNStream=50022]="startPublishCDNStream",D[D.stopPublishCDNStream=50023]="stopPublishCDNStream",D[D.PeerConnectionConnect=50024]="PeerConnectionConnect",D[D.PeerConnectionReconnect=50025]="PeerConnectionReconnect",D[D.WebsocketConnect=50026]="WebsocketConnect",D[D.WebsocketReconnect=50027]="WebsocketReconnect",D[D.schedule=50028]="schedule",D[D.SPCConnect=50029]="SPCConnect",D[D.SPCReconnect=50030]="SPCReconnect",D))(fl||{}),Tl=wo;var ec=class{constructor(){d(this,"_startTime");d(this,"_endTime");this._startTime=0,this._endTime=0,this.start()}start(){this._startTime===0&&(this._startTime=V())}stop(){this._endTime===0&&(this._endTime=V())}getDuration(){return this._endTime===0?V()-this._startTime:this._endTime-this._startTime}get endTime(){return this._endTime}},ur=ec;var tc=class{constructor(t){d(this,"_room",null);d(this,"_durationMap");d(this,"_eventMap",new Map);this._room=t.room,this._durationMap=new Map,this.installEvents()}installEvents(){this._eventMap.set(p.SUBSCRIBE_SUCCESS,this.handleSubscribed).set(p.UNSUBSCRIBE_SUCCESS,this.handleStreamStopped).set(p.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:i})=>{var n;let{userId:s}=i;if(!this.hitTest(t))return;e.hasAudio&&!i.hasAudio&&this.stopDurationItem(`${s}_${"main"}`,h.AUDIO),e.hasVideo&&!i.hasVideo&&this.stopDurationItem(`${s}_${"main"}`,h.VIDEO),e.hasAuxiliary&&!i.hasAuxiliary&&this.stopDurationItem(`${s}_${"auxiliary"}`,h.VIDEO);let o=(n=this._room)==null?void 0:n.remotePublishedUserMap.get(s);!o||(!e.hasAudio&&i.hasAudio&&o.remoteAudioTrack.isSubscribed&&this.addDuractionItem(s,h.AUDIO,"main"),!e.hasVideo&&i.hasVideo&&o.remoteVideoTrack.isSubscribed&&this.addDuractionItem(s,h.VIDEO,"main"),!e.hasAuxiliary&&i.hasAuxiliary&&o.remoteAuxiliaryTrack.isSubscribed&&this.addDuractionItem(s,h.VIDEO,"auxiliary"))}),this._eventMap.forEach((t,e)=>E.on(e,t,this))}uninstallEvents(){this._eventMap.forEach((t,e)=>E.off(e,t,this)),this._eventMap.clear()}handleSubscribed({room:t,streamType:e,remotePublishedUser:i}){if(!this.hitTest(t))return;let{userId:s}=i,o=`${s}_${e}`;if(i.muteState.hasAudio&&e==="main")if(i.remoteAudioTrack.isSubscribed){let n=new ur,a=this._durationMap.get(o);a?this.isRecording(a.audio)||a.audio.push(n):this._durationMap.set(o,{userId:s,type:e,audio:[n],video:[]})}else this.stopDurationItem(o,h.AUDIO);if(i.muteState.hasVideo||i.muteState.hasAuxiliary)if(i.remoteVideoTrack.isSubscribed||i.remoteAuxiliaryTrack.isSubscribed){let n=new ur,a=this._durationMap.get(o);a?this.isRecording(a.video)||a.video.push(n):this._durationMap.set(o,{userId:s,type:e,audio:[],video:[n]})}else this.stopDurationItem(o,h.VIDEO)}handleStreamStopped({room:t,streamType:e,remotePublishedUser:i}){if(!this.hitTest(t))return;let{userId:s}=i,o=`${s}_${e}`;this.stopDurationItem(o,h.AUDIO),this.stopDurationItem(o,h.VIDEO)}isRecording(t){return t.findIndex(e=>e.endTime===0)>=0}addDuractionItem(t,e,i){let s=`${t}_${i}`,o=new ur,n=this._durationMap.get(s);n?this.isRecording(n[e])||n[e].push(o):this._durationMap.set(s,{userId:t,type:i,audio:e===h.AUDIO?[o]:[],video:e===h.AUDIO?[]:[o]})}stopDurationItem(t,e){if(this._durationMap.has(t)){let s=this._durationMap.get(t)[e].find(o=>o.endTime===0);s&&s.stop()}}hitTest(t){return this._room===t}getDuration(t,e){return this._durationMap.has(t)?this._durationMap.get(t)[e].reduce((s,o)=>s+o.getDuration(),0):0}getDurationMap(){return this._durationMap}reset(){this._durationMap.clear()}destroy(){this._room=null,this.uninstallEvents()}},Il=tc;var ic=class{constructor(t){d(this,"_room");d(this,"_renderFreezeMap",new Map);d(this,"_isVideoPlayingEventFiredMap",new Map);d(this,"_dataFreezeMap",new Map);d(this,"_monitorFreezeData",new Map);d(this,"_eventMap",new Map);this._room=t.room,this.installEvents()}installEvents(){this._eventMap.set(p.LEAVE_SUCCESS,({room:t})=>{this.hitTest(t)&&this.stop()}).set(p.PLAY_TRACK_START,this.onPlayTrackStart).set(p.UNSUBSCRIBE_SUCCESS,({room:t,streamType:e,remotePublishedUser:i})=>{if(!this.hitTest(t))return;let{userId:s}=i,o=`${s}_${e}`;this.stopDataFreeze({key:o,userId:s,type:e})}).set(p.REMOTE_PUBLISH_STATE_CHANGED,({room:t,prevMuteState:e,muteState:i})=>{if(!this.hitTest(t))return;let{userId:s}=i;if(e.hasVideo&&!i.hasVideo){let o="main",n=`${i.userId}_${o}`;this.stopDataFreeze({key:n,userId:s,type:o})}if(e.hasAuxiliary&&!i.hasAuxiliary){let o="auxiliary",n=`${i.userId}_${o}`;this.stopDataFreeze({key:n,userId:s,type:o})}}).set(p.PLAYER_STATE_CHANGED,({track:t,state:e,reason:i,type:s})=>{if(!(!Vt(t)||!this.hitTest(t.room)||s!==h.VIDEO)){if(e==="PLAYING"){let o=`${t.userId}_${t.streamType}`;this._isVideoPlayingEventFiredMap.set(o,!0)}i===h.MUTE?this.onVideoTrackMuted(t):i===h.UNMUTE&&this.onVideoTrackUnmuted(t)}}).set(p.HEARTBEAT_REPORT,this.onHearBeatReport),this._eventMap.forEach((t,e)=>E.on(e,t,this))}uninstallEvents(){this._eventMap.forEach((t,e)=>E.off(e,t,this)),this._eventMap.clear()}stop(){this._renderFreezeMap.clear(),this._dataFreezeMap.clear(),this._isVideoPlayingEventFiredMap.clear()}onVideoTrackMuted(t){if(!t.isSubscribed)return;let{userId:e,streamType:i}=t,s=`${e}_${i}`,o=this._dataFreezeMap.get(s),n=new ur;o?o.durationItemList.push(n):this._dataFreezeMap.set(s,{userId:e,type:i,durationItemList:[n],isFreezing(){let a=this.durationItemList[this.durationItemList.length-1];return a&&a.endTime===0}})}onVideoTrackUnmuted(t){if(!t.isSubscribed)return;let{userId:e,streamType:i}=t,s=`${e}_${i}`;this.stopDataFreeze({key:s,userId:e,type:i})}onHearBeatReport({room:t,report:e}){!this.hitTest(t)||e.msg_down_stream_info.forEach(i=>{let s=this._room.remotePublishedUserMap.get(i.msg_user_info.str_identifier);if(!s)return;let{userId:o,muteState:n}=s;i.msg_video_status.forEach(a=>{a.uint32_video_stream_type===2&&n.hasVideo&&!n.videoMuted&&s.remoteVideoTrack.isSubscribed&&this.handleRenderFreeze({userId:o,fps:a.uint32_video_dec_fps,type:"main"}),a.uint32_video_stream_type===7&&n.hasAuxiliary&&s.remoteAuxiliaryTrack.isSubscribed&&this.handleRenderFreeze({userId:o,fps:a.uint32_video_dec_fps,type:"auxiliary"})})})}stopDataFreeze({key:t,userId:e,type:i}){let s=this._dataFreezeMap.get(t);if(!s||!s.isFreezing())return;let o=s.durationItemList[s.durationItemList.length-1];o.stop();let n=o.getDuration();n>Xs?this._monitorFreezeData.set(t,{userId:e,type:i,duration:n}):s.durationItemList.pop()}getTotalDuration(t){return t.reduce((e,i)=>{let s=i.getDuration();return e+Math.min(s,5e3)},0)}handleRenderFreeze(s){return _(this,arguments,function*({userId:t,fps:e,type:i}){let o=`${t}_${i}`,n=this._renderFreezeMap.get(o);if(e<=2){let a=V();n&&!n.isFreeze&&(n.freezeTimeline.push({startTime:a,endTime:0}),n.isFreeze=!0),n||this._renderFreezeMap.set(o,{userId:t,type:i,isFreeze:!0,freezeTimeline:[{startTime:a,endTime:0}],renderFreezeTotal:0})}else if(n&&n.isFreeze){n.isFreeze=!1;let a=n.freezeTimeline.pop();if(a){a.endTime=V();let c=a.endTime-a.startTime;n.freezeTimeline.push(a),n.renderFreezeTotal+=Math.min(5e3,c)}}})}onPlayTrackStart({track:t}){if(!Vt(t)||!this.hitTest(t.room)||t.kind!==h.VIDEO||t.hasFlag)return;let e=`${t.userId}_${t.streamType}`;this._isVideoPlayingEventFiredMap.has(e)||this._isVideoPlayingEventFiredMap.set(e,!1)}getDataFreezeDuration(t){let e={dataFreeze:0,count:0},i=this._dataFreezeMap.get(t);if(i){if(i.isFreezing()){let s=i.durationItemList[i.durationItemList.length-1];s.stop(),s.getDuration()<Xs&&i.durationItemList.pop()}e.dataFreeze=this.getTotalDuration(i.durationItemList),e.count=i.durationItemList.length}return e}getRenderFreezeDuration(t){let e=this._renderFreezeMap.get(t),i=0,s=0;if(e)if(!e.isFreeze)i=e.renderFreezeTotal;else{let o=V(),n=e.freezeTimeline[e.freezeTimeline.length-1],a=o-n.startTime;i=e.renderFreezeTotal+Math.min(a,5e3),s=e.freezeTimeline.length}return{renderFreeze:i,count:s}}getMonitorFreeze(){return this._monitorFreezeData}isBlackStream(t){return this._isVideoPlayingEventFiredMap.has(t)?!this._isVideoPlayingEventFiredMap.get(t):!1}resetMonitor(){this._monitorFreezeData.clear()}hitTest(t){return t===this._room}destroy(){this.uninstallEvents()}},Sl=ic;var rc=null,sc=!0;function zt(r){te(r)&&r!==sc&&(sc=r,g.info(`setIsNeedToSchedule ${r}`))}E.on("28",()=>zt(!0));E.on("63",()=>zt(!0));E.on("84",()=>zt(!0));E.on("201",r=>{r.state==="RECONNECTING"&&zt(!0)});E.on("202",r=>{r.state==="RECONNECTING"&&zt(!0)});function Rl(a){return _(this,arguments,function*({userId:r,sdkAppId:t,useStringRoomId:e,roomId:i,userSig:s,version:o,frameWorkType:n}){if(!sc&&rc)return{isCached:!0,result:rc};let c={delta:0,count:[1,1],msg:[]};try{let l=new FormData;l.append("userId",String(r)),l.append("sdkAppId",String(t)),l.append("isStrGroupId",String(e)),l.append("groupId",String(i)),l.append("sdkVersion",o),l.append("userSig",String(s)),l.append("frameWorkType",String(n));let u=V(),m=yield pm(l,c,t);return m.config&&(m.config.loggerDomain&&ai(m.config.loggerDomain),te(m.config.scheduleCache)&&zt(!m.config.scheduleCache)),c.delta=V()-u,rc=m,{isCached:!1,result:m}}catch(l){let u=he(l)?l[0]:l,m=Q(u.code)?u.code:0,f=`schedule failed${u.message?`: ${u.message}`:""}`,O=new A({code:I.SCHEDULE_FAILED,extraCode:m,message:b({key:C.JOIN_ROOM_FAILED,data:{error:f,code:m}})});throw g.error(O),O}})}function gl(r,t=h.MAIN){let e;return qs(r)?e=t===h.MAIN?Ki.MAIN_OVERSEA:Ki.BACKUP_OVERSEA:e=t===h.MAIN?Ki.MAIN:Ki.BACKUP,`https://${e}/api/v1/config`}function _m(r,t,e){return new Promise((i,s)=>{Ht({url:r,body:t,timeout:e.timeout}).then(o=>{o.data.code===0?i(o.data.data):s({code:o.data.code,message:o.data.msg})}).catch(s)})}var Al=(r,t)=>rt({retryFunction:_m,settings:{retries:3,timeout:0},onError:t,onRetrying:r});function pm(r,t,e){return new Promise((i,s)=>{let o=null;In([Al(n=>t.count[0]=n+1,(n,a)=>{t.msg[0]=n.message,o||a()})(gl(e,h.MAIN),r,{get timeout(){return Xi(2+t.count[0])*1e3}}),Al(n=>t.count[1]=n+1,(n,a)=>{t.msg[1]=n.message,o||a()})(gl(e,h.BACKUP),r,{get timeout(){return Xi(2+t.count[1])*1e3}})]).then(n=>{o=n,i(o)}).catch(s)})}var Em=0;var xo=class extends F{constructor(e){super("room");this.seq=++Em;this.role="anchor";this.localTracks=new Set;this.enableAutoPlayDialog=!0;this.autoReceiveAudio=!0;this.autoReceiveVideo=!0;this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null};this._isUsingCachedSchedule=!1;this._log=g.createLogger({id:`r${this.seq}`});this._joinedTimestamp=0;this._isDestroyed=!1;this.useStringRoomId=!!e.useStringRoomId,te(e.autoReceiveAudio)&&(this.autoReceiveAudio=e.autoReceiveAudio),te(e.autoReceiveVideo)&&(this.autoReceiveVideo=e.autoReceiveVideo),te(e.enableAutoPlayDialog)&&(this.enableAutoPlayDialog=e.enableAutoPlayDialog),this.keyPointManager=new Tl({room:this,frameWorkType:e.frameWorkType,component:e.component,language:e.language}),this.callDurationCalculator=new Il({room:this}),this.badCaseDetector=new Sl({room:this}),this.audioManager=new _o({room:this})}get isMainStreamPublished(){for(let e of this.localTracks)if(e.mediaType&4)return!0;return!1}get isAuxStreamPublished(){for(let e of this.localTracks)if(e.mediaType&2)return!0;return!1}get hasAuxStream(){for(let e of this.remotePublishedUserMap.values())if(e.muteState.hasAuxiliary)return!0;return this.isAuxStreamPublished}getLogger(){return this._log}get isJoined(){return this.state==="joined"}addTrack(e){return _(this,null,function*(){return this.publish(e)})}removeTrack(e){return _(this,null,function*(){return this.unpublish(e)})}replaceTrack(e){return _(this,null,function*(){})}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAIVoice(e){throw new Error("Method not implemented.")}getRemoteAudioStats(){return _(this,null,function*(){let e={};return this.remotePublishedUserMap.forEach(i=>{e[i.userId]=i.remoteAudioTrack.stat}),e})}getTransportStats(){return _(this,null,function*(){var i;let e={rtt:((i=this.quality)==null?void 0:i.uplinkRTT)||0,downlinksRTT:{}};if(this.quality)for(let s of this.quality.downlinkInfo)e.downlinksRTT[s.userId]=s.rtt;return e})}getRemoteVideoStats(){return _(this,arguments,function*(e="main"){let i={};return this.remotePublishedUserMap.forEach(s=>{let o=e==="auxiliary"?s.remoteAuxiliaryTrack:s.remoteVideoTrack;i[s.userId]=o.stat}),i})}checkDestroy(){if(this._isDestroyed)throw new A({code:I.INVALID_OPERATION,message:b({key:C.CLIENT_DESTROYED,data:{funName:"join"}})})}destroy(){if(this.isJoined)throw this._log.warn(le.INVALID_DESTROY),new A({code:I.INVALID_OPERATION,message:b({key:C.INVALID_DESTROY})});this._log.info("destroy room"),this.keyPointManager.destroy(),this.callDurationCalculator.destroy(),this.badCaseDetector.destroy(),this._isDestroyed=!0,E.emit(p.ROOM_DESTROY,{room:this})}schedule(e,i,s){return _(this,null,function*(){var n,a;let o=V();try{let{isCached:c,result:l}=yield Rl({userId:this.userId,sdkAppId:this.sdkAppId,roomId:e,useStringRoomId:this.useStringRoomId,version:s,userSig:this.userSig,frameWorkType:i});this._isUsingCachedSchedule=c,this._log.info(`schedule cache: ${c} : ${JSON.stringify(l)}`),this.scheduleResult=R(R({},this.scheduleResult),l),Q((n=l.config)==null?void 0:n.retryCount)&&un(l.config.retryCount),X((a=l.config)==null?void 0:a.loggerDomain)&&ai(l.config.loggerDomain),E.emit(p.JOIN_SCHEDULE_SUCCESS,{room:this,schedule:this.scheduleResult}),E.emit(p.API_SUCCESS_RATE,{room:this,apiName:"schedule",cost:V()-o})}catch(c){throw E.emit(p.API_SUCCESS_RATE,{room:this,apiName:"schedule",error:c}),c}})}};var Zt=new WeakMap,dt=new WeakMap;function fs(){return function(r,t,e){let i=e.value,s=({fn:o,args:n,context:a,resolve:c,reject:l})=>{o.apply(a,n).then(c,l)};return e.value=function(...o){return new Promise((a,c)=>{if(Zt.has(this)){let l=Zt.get(this),{length:u}=l;l.push({fn:i,args:o,context:this,resolve:a,reject:c}),u===0&&s({fn:i,args:o,context:this,resolve:a,reject:c})}else Zt.set(this,[{fn:i,args:o,context:this,resolve:a,reject:c}]),s({fn:i,args:o,context:this,resolve:a,reject:c})}).finally(()=>{let a=Zt.get(this);a&&(a.shift(),a[0]&&s(R({},a[0])))})},e}}function Cl(r){return function(t,e,i){let s=i.value;return i.value=function(...o){let n=Zt.get(this);if(n){let a=n.filter((c,l)=>{if(l===0)return!0;let u=!0;return c.args.forEach(m=>{o.find(f=>f===m)||(u=!1)}),u?(c.reject(new A({code:I.API_CALL_ABORTED,message:r})),!1):!0});Zt.set(this,a)}return s.apply(this,o)},i}}function Nl(r){return function(t,e,i){let s=i.value;return i.value=function(...o){var a,c;let n=[];return(a=Zt.get(this))==null||a.forEach(l=>n.push(l)),(c=dt.get(this))==null||c.forEach(l=>l.forEach(u=>n.push(u))),n.forEach(l=>{l.reject(new A({code:I.API_CALL_ABORTED,message:r}))}),Zt.delete(this),dt.delete(this),s.apply(this,o)},i}}function oc(r){return function(t,e,i){let s=i.value,o=a=>Q(r)?a[r]:r(...a),n=({fn:a,args:c,context:l,resolve:u,reject:m})=>{a.apply(l,c).then(u,m).finally(()=>{if(dt.has(l)&&dt.get(l).has(o(c))){let f=dt.get(l).get(o(c));f&&(f.shift(),f[0]&&n(R({},f[0])))}})};return i.value=function(...a){return new Promise((c,l)=>{if(dt.has(this))if(dt.get(this).has(o(a))){let u=dt.get(this).get(o(a));if(u){let{length:m}=u;u.push({fn:s,args:a,context:this,resolve:c,reject:l}),m===0&&n({fn:s,args:a,context:this,resolve:c,reject:l})}}else dt.get(this).set(o(a),[{fn:s,args:a,context:this,resolve:c,reject:l}]),n({fn:s,args:a,context:this,resolve:c,reject:l});else{let u=new Map;u.set(o(a),[{fn:s,args:a,context:this,resolve:c,reject:l}]),dt.set(this,u),n({fn:s,args:a,context:this,resolve:c,reject:l})}})},i}}var Ll=Ne(Me());var nc=Ne(Wa()),yl=r=>{let t=ne(r),e={audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0};return t.media.forEach((i,s)=>{var o;if(i.ssrcs&&!T(i.ssrcs[0].id)){let n=Number(i.ssrcs[0].id),a=Number((o=i.ssrcs.filter(c=>c.attribute==="cname")[1])==null?void 0:o.id);switch(s){case 0:e.audioSsrc=n;break;case 1:e.bigVideoSsrc=n,e.bigVideoRtxSsrc=a;break;case 2:e.smallVideoSsrc=n,e.smallVideoRtxSsrc=a;break;case 3:e.auxVideoSsrc=n,e.auxVideoRtxSsrc=a;break}}}),e},Ol=(r,t)=>{var a,c;let e=ne(r),i={ice:{ufrag:"",password:""},dtls:{hash:"",fingerprint:"",setup:""},audio:{codecs:[],extensions:[]},video:{codecs:[],extensions:[]},useDataChannel:t};i.ice.ufrag=String(e.media[0].iceUfrag),i.ice.password=e.media[0].icePwd||"",e.fingerprint&&(i.dtls.hash=e.fingerprint.type,i.dtls.fingerprint=e.fingerprint.hash,i.dtls.setup=e.setup||""),e.media[0].fingerprint&&(i.dtls.hash=e.media[0].fingerprint.type,i.dtls.fingerprint=e.media[0].fingerprint.hash),i.dtls.setup=e.media[0].setup||"";let s=e.media[0],o=e.media[1];s.ext&&(i.audio.extensions=s.ext.map(l=>({id:l.value,uri:l.uri}))),o.ext&&(i.video.extensions=o.ext.map(l=>({id:l.value,uri:l.uri})));let n={codec:s.rtp[0].codec,fmtp:s.fmtp[0].config,payload:s.fmtp[0].payload,rate:s.rtp[0].rate,channel:s.rtp[0].encoding,rtcpFb:[],rtx:0};(a=s.rtcpFb)==null||a.forEach(({payload:l,type:u,subtype:m})=>{if(l===n.payload){let f={id:u,params:[]};m&&f.params.push(m),n.rtcpFb.push(f)}}),i.audio.codecs.push(n);for(let l=0;l<o.rtp.length;l++){if(["rtx","red","ulpfec"].includes(o.rtp[l].codec))continue;let u=o.fmtp.filter(m=>m.payload===o.rtp[l].payload)[0];i.video.codecs.push({payload:o.rtp[l].payload,codec:o.rtp[l].codec,fmtp:u?u.config:"",rate:o.rtp[l].rate,rtx:((c=o.rtp[l+1])==null?void 0:c.codec)==="rtx"?o.rtp[l+1].payload:0,rtcpFb:((o==null?void 0:o.rtcpFb)||[]).filter(m=>m.payload===o.rtp[l].payload).map(({type:m,subtype:f})=>({id:m,params:f?[f]:[]}))})}return i},Dl=({serverAbility:r,clientAbility:t,offerSDP:e,enableCustomMessage:i})=>{let s=ne(e),o={extmapAllowMixed:"extmap-allow-mixed",groups:s.groups,icelite:"ice-lite",media:[],msidSemantic:{semantic:"",token:"WMS"},name:"-",origin:{address:"127.0.0.1",username:"-",sessionId:String(Date.now()),sessionVersion:1,netType:"IN",ipVer:4},timing:{start:0,stop:0},version:0},n={candidates:r.candidates.map(a=>({component:1,foundation:"1",generation:0,ip:a.ip,port:a.port,priority:a.priority,transport:a.foundation,type:a.type})),connection:{version:4,ip:"0.0.0.0"},direction:h.TRANSCEIVER_DIRECTION_RECVONLY,ext:r.audio.extensions.map(a=>({value:a.id,uri:a.uri})),fingerprint:{type:r.dtls.hash,hash:r.dtls.fingerprint},fmtp:[{payload:r.audio.codecs[0].payload,config:r.audio.codecs[0].fmtp}],icePwd:r.ice.password,iceUfrag:r.ice.ufrag,mid:"0",payloads:String(r.audio.codecs[0].payload),port:s.media[0].port,protocol:s.media[0].protocol,type:h.AUDIO,setup:r.dtls.setup,rtcpFb:r.audio.codecs[0].rtcpfb.map(a=>({payload:r.audio.codecs[0].payload,type:a.id,subtype:a.params[0]})),rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[{payload:r.audio.codecs[0].payload,codec:r.audio.codecs[0].codec,rate:r.audio.codecs[0].rate,encoding:r.audio.codecs[0].channels}]};return o.media.push(n),[1,2,3].forEach(a=>{o.media.push(ac({mid:a,serverAbility:r,clientAbility:t,parsedOffer:s}))}),i&&o.media.push(s.media.find(a=>a.mid==="dc")),Ve(o)},ac=({mid:r,serverAbility:t,clientAbility:e,parsedOffer:i,useAllCodec:s=!1})=>{let o={candidates:t.candidates.map(n=>({component:1,foundation:"1",generation:0,ip:n.ip,port:n.port,priority:n.priority,transport:n.foundation,type:n.type})),connection:{version:4,ip:"0.0.0.0"},direction:h.TRANSCEIVER_DIRECTION_RECVONLY,ext:t.video.extensions.map(n=>({value:n.id,uri:n.uri})),fingerprint:{type:t.dtls.hash,hash:t.dtls.fingerprint},fmtp:[],icePwd:t.ice.password,iceUfrag:t.ice.ufrag,mid:String(r),payloads:"",port:i.media[0].port,protocol:i.media[0].protocol,type:h.VIDEO,setup:t.dtls.setup,rtcpFb:[],rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[]};if(t.video.codecs.length>0)if(s)for(let n=0;n<t.video.codecs.length;n++)Uo(o,t.video.codecs[n]);else{let n=t.video.codecs.findIndex(a=>a.codec.toLowerCase()===(t.useVp8?"vp8":"h264"));Uo(o,t.video.codecs[n])}else if(s)for(let n=0;n<e.video.codecs.length;n++)Uo(o,e.video.codecs[n]);else Uo(o,e.video.codecs[0]);return o.payloads=o.payloads.trim(),o},Uo=(r,t)=>{r.payloads=`${r.payloads} ${t.payload}`,r.fmtp.push({payload:t.payload,config:t.fmtp}),r.rtcpFb=[...r.rtcpFb||[],...(t.rtcpfb||t.rtcpFb).map(e=>({payload:t.payload,type:e.id,subtype:e.params[0]}))],r.rtp.push({payload:t.payload,codec:t.codec.toUpperCase(),rate:t.rate}),t.rtx&&(r.payloads=`${r.payloads} ${t.rtx}`,r.fmtp.push({payload:t.rtx,config:`apt=${t.payload}`}),r.rtp.push({payload:t.rtx,codec:"rtx",rate:t.rate}))};function fm(r){let t=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);r.ext&&(r.ext=r.ext.filter(e=>!t.has(e.uri)))}function Tm(r){if(!r.rtcpFb)return;let t=[];r.rtcpFb.forEach((e,i)=>{var s;t.push(e),r.rtcpFb&&((s=r.rtcpFb[i+1])==null?void 0:s.payload)!==e.payload&&e.type!=="rrtr"&&t.push({payload:e.payload,type:"rrtr"})}),r.rtcpFb=t}function Im(r){r.type===h.VIDEO&&r.fmtp&&r.fmtp.forEach(t=>{t.config.includes("apt")||(t.config+=";sps-pps-idr-in-keyframe=1")})}function Sm(r){r.type===h.AUDIO&&r.fmtp&&r.fmtp.forEach(t=>{t.config+=";sprop-stereo=1;stereo=1"})}var bl=r=>{let t=nc.default.parse(r);return t.media.forEach(e=>{var i;(e.type===h.AUDIO||e.type===h.VIDEO)&&(Tm(e),Im(e),Sm(e),fm(e)),((i=e.payloads)==null?void 0:i.includes("datachannel"))&&t.groups&&e.mid&&(t.groups[0].mids=t.groups[0].mids.replace(e.mid,"dc"),e.mid="dc")}),nc.default.write(t)};var ei=(a=>(a.TRACK="track",a.DATA_CHANNEL_MESSAGE="data_channel_msg",a[a.CONNECTION_STATE_CHANGED="connection-state-changed"]="CONNECTION_STATE_CHANGED",a[a.FIREWALL_RESTRICTION="firewall-restriction"]="FIREWALL_RESTRICTION",a.RECONNECTED="spc-reconnected",a.RECONNECT_FAILED="spc-reconnect-failed",a.ERROR="error",a))(ei||{}),Pl=0,Ml=!1,gm=new Set,Am=r=>Pl>2&&!Ml&&gm.size===0&&r,Rm=1,hr=class extends Ll.default{constructor({signalChannel:e,room:i,enableCustomMessage:s}){super();d(this,"currentState","DISCONNECTED");d(this,"_room");d(this,"_signalChannel");d(this,"_peerConnection",null);d(this,"_datachannel",null);d(this,"_enableCustomMessage");d(this,"_log");d(this,"_downlinkMIDMap",new Map);d(this,"_reconnectionTimer",-1);d(this,"reconnectionCount",0);d(this,"_clientAbility",null);d(this,"_serverAbility",null);d(this,"addDownlinkQueue",new Set);d(this,"removeDownlinkQueue",new Set);d(this,"_parsedAnswer",null);d(this,"_updateSDPPromise",null);d(this,"_waitForPCConnectedPromise");d(this,"_waitForPCConnectedPromiseReject",null);d(this,"_isSDPLogged",!1);this._room=i,this._enableCustomMessage=s,this._signalChannel=e,this._log=g.createLogger({id:`spc${Rm++}`,userId:this._room.userId,sdkAppId:this._room.sdkAppId})}get isH264EncodeSupported(){let e=this._room.checkSystemResult.detail.isH264EncodeSupported;return this._serverAbility&&(e=e&&!!this._serverAbility.video.codecs.find(i=>i.codec.toLowerCase()==="h264")),e}get isVP8EncodeSupported(){let e=this._room.checkSystemResult.detail.isVp8EncodeSupported;return this._serverAbility&&(e=e&&this._serverAbility.useVp8),e}get uplinkSSRC(){return this._peerConnection&&this._peerConnection.localDescription?yl(this._peerConnection.localDescription.sdp):{audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0}}get isReconnecting(){return this.currentState==="RECONNECTING"||this._reconnectionTimer>0||this.reconnectionCount>0}initialize(){return _(this,null,function*(){try{this._peerConnection=new RTCPeerConnection({offerExtmapAllowMixed:!0,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._room.sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"}),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this),this._peerConnection.ontrack=i=>this.emit("track",i),this._enableCustomMessage&&(this._datachannel=this._peerConnection.createDataChannel(`${this._room.userId}dc`),this._datachannel.binaryType="arraybuffer",this._datachannel.onopen=()=>{this._log.info("datachannel open")},this._datachannel.onclose=()=>{this._log.warn("datachannel close")},this._datachannel.onmessage=i=>{let s=new dc(i.data);this.emit("data_channel_msg",{data:s})},this._datachannel.onerror=i=>{this._log.warn("datachannel error",i)}),this._peerConnection.addTransceiver(h.AUDIO,{direction:h.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:h.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:h.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:h.TRANSCEIVER_DIRECTION_SENDONLY});let e=yield this._peerConnection.createOffer();return yield this.setOffer(e),this._clientAbility=Ol(e.sdp,this._enableCustomMessage),this._clientAbility}catch(e){throw this._log.error(`initialize failed ${e}`),e}})}connect(e,i=!1){return _(this,null,function*(){try{if(this.currentState==="CONNECTED")return;let s=V(),o={type:"answer",sdp:Dl({serverAbility:e,clientAbility:this._clientAbility,offerSDP:this._peerConnection.localDescription.sdp,enableCustomMessage:this._enableCustomMessage})};this._serverAbility=e,yield this.setAnswer(o),yield this.waitForPeerConnectionConnected(),i||E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCConnect",cost:Math.min(V()-s,30*1e3)})}catch(s){let o=s instanceof A&&s.code===I.API_CALL_ABORTED;throw o||this._log.error(`connect failed: ${s} ${e}`),this.reset(),!o&&!this.isReconnecting&&(E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCConnect",error:s}),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()),s}})}reconnect(){return _(this,null,function*(){if(this._reconnectionTimer!==-1){this._log.warn("reconnect() is reconnecting, ignore current reconnection");return}if(!this._signalChannel.isConnected){this._log.warn("reconnect() wait signal channel is connected"),this._signalChannel.once(se.CONNECTED,this.reconnect,this);return}try{this.reconnectionCount++,this._log.warn(`reconnect() trying [${this.reconnectionCount}]`),this.reset();let e=yield this.initialize(),i=yield this._signalChannel.sendWaitForResponse({command:J.REBUILD_PEER_CONNECTION,responseCommand:B.REBUILD_PEER_CONNECTION_RES,data:{ability:e},enableLog:!1});yield this.connect(i.data.data.ability,!0),this._log.warn("reconnect() successfully"),this.stopReconnection(),this.emit("spc-reconnected")}catch(e){if(!this.isReconnecting)return;if(e!=null&&e.message.includes("timeout")){let i=we(this.reconnectionCount);this._log.warn(`reconnect() timeout, try again after ${i/1e3}s`),this._reconnectionTimer=window.setTimeout(()=>{this.clearReconnectionTimer(),this.reconnect()},i)}else this._log.error(`reconnect() failed ${e}`),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCReconnect",error:e}),this.reconnectionCount>=pt()&&this._log.warn(`SDK has tried reconnect for ${pt()} times, but all failed, please check your network`),this.stopReconnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.emit("error")}})}getPeerConnection(){return this._peerConnection}startReconnection(){return _(this,null,function*(){this._log.warn("start reconnect"),this.emitConnectionStateChangedEvent("RECONNECTING");let e=V();yield this.reconnect(),E.emit(p.API_SUCCESS_RATE,{room:this._room,apiName:"SPCReconnect",cost:Math.min(V()-e,30*1e3)})})}stopReconnection(){this.isReconnecting&&(this._log.info("stop reconnect"),this.reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(se.CONNECTED,this.reconnect,this))}checkPeerConnectionToReconnect(){var e;!this.isReconnecting&&((e=this._peerConnection)==null?void 0:e.connectionState)===Z.CLOSED&&this.startReconnection()}clearReconnectionTimer(){this._reconnectionTimer!==-1&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onConnectionStateChange(e){let i=this._peerConnection.iceConnectionState,s=this.getDTLSTransportState();if(this._log.info(`connectionState: ${e.target.connectionState}, ICE: ${i}, DTLS: ${s}`),e.target.connectionState===Z.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),e.target.connectionState===Z.FAILED||e.target.connectionState===Z.CLOSED){let o=`ICE/DTLS Transport connection ${e.target.connectionState}. ICE Transport state: ${i}, DTLS Transport state: ${s}`,n=new A({message:o,code:I.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()}(e.target.connectionState===Z.CONNECTED||e.target.connectionState===Z.COMPLETED)&&(this.logSelectedCandidate(),this.emitConnectionStateChangedEvent("CONNECTED"))}getDTLSTransportState(){if(!this._peerConnection)return Ge;let e=null;return!zi()||this._peerConnection.getSenders().length===0?Ge:(e=this._peerConnection.getSenders()[0].transport,!mi()||this._peerConnection.getReceivers().length===0?Ge:e?e.state:Ge)}emitConnectionStateChangedEvent(e){e!==this.currentState&&(this.currentState==="RECONNECTING"&&e==="CONNECTING"||(this.emit(ei.CONNECTION_STATE_CHANGED,{prevState:this.currentState,state:e}),this.currentState=e))}logSelectedCandidate(){return _(this,null,function*(){if(!this._peerConnection)return;let e=yield this._peerConnection.getStats();for(let[i,s]of e)if(Gt(s)){let o=e.get(s.localCandidateId),n=e.get(s.remoteCandidateId);o&&this._log.info(`local candidate: ${o.candidateType} ${o.protocol}:${o.ip||o.address}:${o.port} ${o.networkType||""} ${o.candidateType==="relay"?`relayProtocol:${o.relayProtocol}`:""}`),n&&this._log.info(`remote candidate: ${n.candidateType} ${n.protocol}:${n.ip||n.address}:${n.port}`);break}})}waitForPeerConnectionConnected(){return this._waitForPCConnectedPromise?this._waitForPCConnectedPromise:(this._waitForPCConnectedPromise=new Promise((e,i)=>{if(this.currentState==="CONNECTED")return e();this._waitForPCConnectedPromiseReject=i;let s=c=>{c.state==="CONNECTED"&&(clearTimeout(a),n(),e())},o=({room:c})=>{c===this._room&&(clearTimeout(a),n(),i(new A({code:I.API_CALL_ABORTED,message:b({key:C.CONNECTION_ABORTED,data:"leave room"})})))},n=()=>{E.off(p.LEAVE_SUCCESS,o,this),this.off(ei.CONNECTION_STATE_CHANGED,s,this)},a=setTimeout(()=>{n();let c=new A({code:I.API_CALL_TIMEOUT,message:"connection timeout"});Pl+=1,Am(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),Ml=!0,this.emit(ei.FIREWALL_RESTRICTION)),i(c)},Ur);E.on(p.LEAVE_SUCCESS,o,this),this.on(ei.CONNECTION_STATE_CHANGED,s,this)}),this._waitForPCConnectedPromise=this._waitForPCConnectedPromise.finally(()=>{this._waitForPCConnectedPromise=null,this._waitForPCConnectedPromiseReject=null}),this._waitForPCConnectedPromise)}waitForReconnected(){return this.isReconnecting?new Promise((e,i)=>{this.once("spc-reconnected",e),this.once("error",i)}):Promise.resolve()}addDownlink(e){return _(this,null,function*(){if(this._log.info(`addDownlink(${e.userId}) trying`),this.isReconnecting&&(yield this.waitForReconnected()),this.updateLocalAndRemoteSDPConfig(e),this.addDownlinkQueue.size===0)try{yield this.updateSDP({isNeedToCreateOffer:!0}),this._log.info(`addDownlink(${e.userId}) done`)}catch(i){this._log.info(`addDownlink(${e.userId}) failed`),yield this.startReconnection()}})}updateLocalAndRemoteSDPConfig({ssrc:e,userId:i,tinyId:s}){if(!this._peerConnection)return;this._log.info(`updateLocalAndRemoteSDPConfig ${i} ${JSON.stringify(e)}`);let o=this._peerConnection.getTransceivers().filter(u=>u.direction==="inactive").slice(0,3).map(u=>(u.direction=h.TRANSCEIVER_DIRECTION_RECVONLY,Number(u.mid)));o.length===0&&(this._peerConnection.addTransceiver(h.AUDIO,{direction:h.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:h.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(h.VIDEO,{direction:h.TRANSCEIVER_DIRECTION_RECVONLY})),this._parsedAnswer||(this._parsedAnswer=ne(this._peerConnection.remoteDescription.sdp));let n,a,c;if(o.length===3)n=this._parsedAnswer.media.find(u=>Number(u.mid)===Number(o[0])),a=this._parsedAnswer.media.find(u=>Number(u.mid)===Number(o[1])),c=this._parsedAnswer.media.find(u=>Number(u.mid)===Number(o[2]));else{n=JSON.parse(JSON.stringify(this._parsedAnswer.media[0]));let u=ac({mid:1,serverAbility:this._serverAbility,clientAbility:this._clientAbility,parsedOffer:ne(this._peerConnection.localDescription.sdp),useAllCodec:!0});a=JSON.parse(JSON.stringify(u)),c=JSON.parse(JSON.stringify(u)),n.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(n),a.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(a),c.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(c)}n.direction=h.TRANSCEIVER_DIRECTION_SENDONLY,n.ssrcs=[{id:e.audio,attribute:"cname",value:`${s}`},{id:e.audio,attribute:"msid",value:`${s}-${h.MAIN} ${s}-audio`}],a.direction=h.TRANSCEIVER_DIRECTION_SENDONLY,a.ssrcs=[{id:e.video,attribute:"cname",value:`${s}`},{id:e.video,attribute:"msid",value:`${s}-${h.MAIN} ${s}-bigvideo`},{id:e.videoRtx,attribute:"cname",value:`${s}`},{id:e.videoRtx,attribute:"msid",value:`${s}-${h.MAIN} ${s}-bigvideo`}],a.ssrcGroups=[{semantics:"FID",ssrcs:`${e.video} ${e.videoRtx}`}],c.direction=h.TRANSCEIVER_DIRECTION_SENDONLY;let l=`${s}-aux`;c.ssrcs=[{id:e.auxiliary,attribute:"cname",value:l},{id:e.auxiliary,attribute:"msid",value:`${l} ${s}-aux${h.VIDEO}`},{id:e.auxiliaryRtx,attribute:"cname",value:`${l} ${s}-aux${h.VIDEO}`},{id:e.auxiliaryRtx,attribute:"msid",value:`${l} ${s}-aux${h.VIDEO}`}],c.ssrcGroups=[{semantics:"FID",ssrcs:`${e.auxiliary} ${e.auxiliaryRtx}`}],this._parsedAnswer.groups&&(this._parsedAnswer.groups[0].mids=this._parsedAnswer.media.map(u=>u.mid).join(" ")),this._downlinkMIDMap.set(s,[n.mid,a.mid,c.mid])}removeDownlink(e,i){return _(this,null,function*(){if(!this._downlinkMIDMap.has(e)||!this._peerConnection)return;this._log.info(`removeDownlink(${i}) trying`),this.isReconnecting&&(yield this.waitForReconnected());let s=this._downlinkMIDMap.get(e),o=!1;this._peerConnection.getTransceivers().forEach(n=>{s!=null&&s.includes(Number(n.mid))&&(o=!0,n.direction="inactive")}),this._parsedAnswer||(this._parsedAnswer=ne(this._peerConnection.remoteDescription.sdp)),this._parsedAnswer.media.forEach(n=>{s!=null&&s.includes(Number(n.mid))&&(o=!0,n.direction="inactive",n.ssrcs=[],n.ssrcGroups=[])}),this.removeDownlinkQueue.size===0&&o&&(yield this.updateSDP({isNeedToCreateOffer:!0,tinyIdRemoving:e})),this._downlinkMIDMap.delete(e),this._log.info(`removeDownlink(${i}) done`)})}getDownlinkMids(e){return this._downlinkMIDMap.get(e)}setBandwidth(e){return _(this,null,function*(){if(!this._peerConnection)return;let{audio:i,bigVideo:s,smallVideo:o,auxVideo:n}=e;try{if(Jr()){let a=this._peerConnection.getSenders().slice(0,4);for(let c=0;c<a.length;c++){let l=a[c],u;c===0&&i?u=i:c===1&&s?u=s:c===2&&o?u=o:c===3&&n&&(u=n),u&&(yield this.setSenderMaxBitrate(l,u))}}else yield this.setBandwidthBySDP(e);Object.keys(e).forEach(a=>{e[a]&&this._log.info(`${a} bandwidth was set to ${e[a]} kbps`)})}catch(a){this._log.error(`failed to set bandwidth${a}`)}})}setSenderMaxBitrate(e,i){let s=e.getParameters();return(!s.encodings||s.encodings.length===0)&&(s.encodings=[{}]),i==="unlimited"?delete s.encodings[0].maxBitrate:s.encodings[0].maxBitrate=i*1e3,e.setParameters(s)}setBandwidthBySDP({audio:e,bigVideo:i,smallVideo:s,auxVideo:o}){if(!this._peerConnection||!this._peerConnection.localDescription)return;let n=ne(this._peerConnection.localDescription.sdp);this._parsedAnswer||(this._parsedAnswer=ne(this._peerConnection.remoteDescription.sdp));let a=Y?"TIAS":"AS";e&&(n.media[0].bandwidth=[{type:a,limit:Y?e*1e3:e}],this._parsedAnswer.media[0].bandwidth=[{type:a,limit:Y?e*1e3:e}]),i&&(n.media[1].bandwidth=[{type:a,limit:Y?i*1e3:i}],this._parsedAnswer.media[1].bandwidth=[{type:a,limit:Y?i*1e3:i}]),s&&(n.media[2].bandwidth=[{type:a,limit:Y?s*1e3:s}],this._parsedAnswer.media[2].bandwidth=[{type:a,limit:Y?s*1e3:s}]),o&&(n.media[3].bandwidth=[{type:a,limit:Y?o*1e3:o}],this._parsedAnswer.media[3].bandwidth=[{type:a,limit:Y?o*1e3:o}]);let c={type:"offer",sdp:Ve(n)};return this.updateSDP({localDescription:c})}updateSDP({isNeedToCreateOffer:e=!1,localDescription:i,tinyIdRemoving:s}){if(!this._parsedAnswer)return;let o=Ve(this._parsedAnswer);return this._updateSDPPromise=new Promise((n,a)=>_(this,null,function*(){var c,l;try{e&&this._peerConnection&&(this._log.info("creating offer"),i=yield this._peerConnection.createOffer()),i&&(yield this.setOffer(i)),yield this.setAnswer({type:"answer",sdp:o}),this._updateSDPPromise=null,n()}catch(u){this._log.error(u),!this._isSDPLogged&&this._peerConnection&&(this._log.warn(`transceivers: ${JSON.stringify(this._peerConnection.getTransceivers().map(({mid:m,currentDirection:f,direction:O,stopped:N})=>({mid:m,currentDirection:f,direction:O,stopped:N})))}`),this._log.warn(`parsedAnswer: ${JSON.stringify(this._parsedAnswer)}`),this._log.warn(`local sdp: ${i==null?void 0:i.sdp}`||((c=this._peerConnection.localDescription)==null?void 0:c.sdp)),this._log.warn(`remote sdp: ${o}`||((l=this._peerConnection.remoteDescription)==null?void 0:l.sdp)),this._isSDPLogged=!0),this._updateSDPPromise=null,a(u)}})),this._updateSDPPromise}setOffer(e){return this._log.info("setting offer"),this._peerConnection.setLocalDescription({type:"offer",sdp:bl(e.sdp)})}setAnswer(e){return this._log.info("setting answer"),this._room.enableHWEncoder&&e.sdp&&(e.sdp=e.sdp.replaceAll("42e01f","42001f")),this._peerConnection.setRemoteDescription(e)}sendDataChannelMessage(e){var i;(i=this._datachannel)==null||i.send(e)}reset(){var e;(e=this._peerConnection)==null||e.close(),this._waitForPCConnectedPromise=null,this._parsedAnswer=null}close(){this._log.info("close pc"),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._downlinkMIDMap.clear(),this.stopReconnection(),this.removeAllListeners()}};y([fs()],hr.prototype,"updateSDP",1);var cc=class{constructor(t){d(this,"tag");d(this,"len");d(this,"data");let e=new DataView(t);this.tag=e.getUint16(),this.len=e.getUint16(2),this.data=new Uint8Array(t).slice(4,2+2+this.len).buffer}},dc=class{constructor(t){d(this,"tinyId");d(this,"data");let e=new DataView(t),i=0,s=[];for(;i<e.byteLength;){let o=e.getUint16(i+2),n=new cc(new Uint8Array(t).slice(i,i+2+2+o).buffer);s.push(n),i+=2+2+o}s.forEach(o=>{o.tag===1?this.tinyId=new TextDecoder().decode(o.data):o.tag===2&&(this.data=o.data)})}},vl=new Set;function bi(){let r=Math.floor(Math.random()*4294967296);return vl.has(r)?bi():(vl.add(r),r)}var kl=Ne(Me());var vi=class extends kl.default{constructor(e){super();d(this,"userId");d(this,"tinyId");d(this,"_sdpSemantics");d(this,"_isUplink");d(this,"_room");d(this,"_log");d(this,"_signalChannel");d(this,"_currentState","DISCONNECTED");d(this,"_prevTime",-1);d(this,"_enableSEI");d(this,"_sei");this.userId=e.userId,this.tinyId=e.tinyId,this._room=e.room,this._sdpSemantics=e.room.sdpSemantics,this._isUplink=e.isUplink,this._log=g.createLogger({id:"n",userId:this._room.userId,remoteUserId:this._isUplink?void 0:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=e.signalChannel,this._enableSEI=e.enableSEI,this._enableSEI&&Wt&&(this._sei=new Lo(this,this._log,this._isUplink))}get _peerConnection(){var e;return((e=this.singlePC)==null?void 0:e.getPeerConnection())||null}get singlePC(){return this._room.singlePC}close(e){this._log.info("close connection"),this.emit("closed",e),this._sei&&(this._sei.destroy(),this._sei=null)}emitConnectionStateChangedEvent(e){return e===this._currentState?!1:(E.emit(p.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:e,remoteUserId:this._isUplink?void 0:this.userId}),this.emit("connection-state-changed",{prevState:this._currentState,state:e}),this._currentState=e,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}getCurrentState(){return this._currentState}get isH264(){var e,i;return!!((i=(e=this._peerConnection)==null?void 0:e.remoteDescription)!=null&&i.sdp.includes("H264"))}};var lc=class extends vi{constructor(e){super(k(R({},e),{isUplink:!0}));d(this,"localMainAudioTrack",null);d(this,"localMainVideoTrack",null);d(this,"localAuxAudioTrack",null);d(this,"localAuxVideoTrack",null);d(this,"_isPublishingAux",!1);d(this,"_publishingLocalAudioTrack");d(this,"_publishingLocalVideoTrack");d(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0});d(this,"_smallGenerator");d(this,"_audioManager");this._audioManager=e.audioManager,this._smallGenerator=null,this.initialize()}get ssrc(){if(!this.singlePC)return{audio:0,video:0,videoRtx:0,small:0,smallRtx:0,auxiliary:0,auxiliaryRtx:0};let{audioSsrc:e,bigVideoSsrc:i,bigVideoRtxSsrc:s,smallVideoSsrc:o,smallVideoRtxSsrc:n,auxVideoSsrc:a,auxVideoRtxSsrc:c}=this.singlePC.uplinkSSRC;return{audio:e||0,video:i||0,videoRtx:s||0,small:o||0,smallRtx:n||0,auxiliary:a||0,auxiliaryRtx:c||0}}get isMainStreamPublished(){return!!(this.localMainAudioTrack||this.localMainVideoTrack)}get isAuxStreamPublished(){return!!(this.localAuxVideoTrack||this.localAuxAudioTrack)}get publishState(){var i,s,o,n;let e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let a=this._peerConnection.getSenders();a&&(ot()?(e.audio=!!((i=a[0])!=null&&i.track),e.bigVideo=!!((s=a[1])!=null&&s.track),e.smallVideo=!!((o=a[2])!=null&&o.track),e.auxVideo=!!((n=a[3])!=null&&n.track)):a.forEach(c=>{c.track&&(c.track.kind===h.AUDIO?e.audio=!0:(e.bigVideo=!0,this._smallGenerator&&(e.smallVideo=!0)))}))}return e}initialize(){this.installEvents()}reset(){this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){var e;this.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this.on("connection-state-changed",this.handleConnectionStateChange,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||(e=this.singlePC)==null||e.on("spc-reconnected",this.onSinglePCReconnected,this)}uninstallEvents(){var e;this.off("connection-state-changed",this.handleConnectionStateChange,this),(e=this.singlePC)==null||e.off("spc-reconnected",this.onSinglePCReconnected,this)}emitConnectionStateChangedEvent(e,i){var n,a,c;let s=this._currentState,o=super.emitConnectionStateChangedEvent(e);return o&&s!==e&&(i?i.emit("connection-state-changed",{prevState:s,state:e}):((n=this.localMainVideoTrack)==null||n.emit("connection-state-changed",{prevState:s,state:e}),(a=this.localAuxVideoTrack)==null||a.emit("connection-state-changed",{prevState:s,state:e}),(c=this._publishingLocalVideoTrack)==null||c.emit("connection-state-changed",{prevState:s,state:e}))),o}publish(o){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i,isAuxiliary:s}){var a,c,l,u,m,f;if(!this.singlePC)return;if(yield this.singlePC.waitForPeerConnectionConnected(),e&&(this._publishingLocalAudioTrack=e),i){if(!this.singlePC.isH264EncodeSupported&&!this.singlePC.isVP8EncodeSupported)throw new A({code:I.NOT_SUPPORTED_H264,message:b({key:C.NOT_SUPPORTED_H264ENCODE})});ye&&qe()===115&&i.profile.width*i.profile.height<=640*360&&(this._log.warn("fallback video to 480p"),yield i.setProfile(_t["480p_2"])),this._publishingLocalVideoTrack=i}this._isPublishingAux=s;let n;i&&!s&&i.small&&(this._smallGenerator=new bt(i),yield this._smallGenerator.initialize(),n=this._smallGenerator.generateSmallVideoTrack(i.small)),We()&&(yield this.publishByTransceiver({localAudioTrack:e,localVideoTrack:i,smallTrack:n,isAuxiliary:s})),this._publishingLocalAudioTrack=null,this._publishingLocalVideoTrack=null,this._isPublishingAux=!1,s?(i&&(this.localAuxVideoTrack=i),e&&(this.localAuxAudioTrack=e)):(i&&(this.localMainVideoTrack=i),e&&(this.localMainAudioTrack=e)),yield this.singlePC.setBandwidth({audio:((a=this.localMainAudioTrack)==null?void 0:a.profile.bitrate)||((c=this.localAuxAudioTrack)==null?void 0:c.profile.bitrate),bigVideo:(l=this.localMainVideoTrack)==null?void 0:l.profile.bitrate,smallVideo:(m=(u=this.localMainVideoTrack)==null?void 0:u.small)==null?void 0:m.bitrate,auxVideo:(f=this.localAuxVideoTrack)==null?void 0:f.profile.bitrate}),yield this._signalChannel.sendWaitForResponse({command:J.SPC_PUBLISH,responseCommand:B.SPC_PUBLISH_RESULT,data:k(R({},this.singlePC.uplinkSSRC),{state:this.publishState})}),this.sendMediaSettings(),this.installTrackMuteEvents(e,i),this.sendMutedFlag()})}publishByTransceiver({localAudioTrack:e,localVideoTrack:i,smallTrack:s,isAuxiliary:o}){this._log.info("publish by transceiver"),i&&si&&vr&&i.genCanvasTrack();let n=(i==null?void 0:i.canvasTrack)||(i==null?void 0:i.mediaTrack),a=this._audioManager.mediaStreamTrack,c=this._peerConnection.getTransceivers(),l=[],u=[];if(a){let f=c[0].sender.replaceTrack(a);u.push(0),l.push(f)}if(n)if(o){let f=c[3].sender.replaceTrack(n);u.push(3),l.push(f)}else{let f=c[1].sender.replaceTrack(n);u.push(1),l.push(f)}if(s){let f=c[2].sender.replaceTrack(s);u.push(2),l.push(f)}let m=this.setTransceiverDirection(G.SENDONLY,u);return l.push(m),Promise.all(l)}installTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.on("mute",this.sendMutedFlag,this),i==null||i.on("unmute",this.sendMutedFlag,this))})}uninstallTrackMuteEvents(...e){e.forEach(i=>{i&&(i==null||i.off("mute",this.sendMutedFlag,this),i==null||i.off("unmute",this.sendMutedFlag,this))})}unpublish(s){return _(this,arguments,function*({localAudioTrack:e,localVideoTrack:i}){let o=i&&i===this.localAuxVideoTrack,n=e==null?void 0:e.mediaTrack,a=i==null?void 0:i.mediaTrack,c=this._peerConnection.getSenders(),l=[];n&&(this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield c[0].replaceTrack(null),l.push(0)),o?this.localAuxAudioTrack=null:this.localMainAudioTrack=null),a&&(o?(yield c[3].replaceTrack(null),this.localAuxVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),l.push(3)):(yield c[1].replaceTrack(null),yield c[2].replaceTrack(null),this.localMainVideoTrack=null,this._mediaSettings=k(R({},this._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),l.push(1,2))),this.isMainStreamPublished||this.isAuxStreamPublished?(yield this.setTransceiverDirection(G.INACTIVE,l),yield this.doPublishChange(!1)):yield this.doUnpublish(),this.uninstallTrackMuteEvents(e,i),i==null||i.emit("connection-state-changed",{prevState:this._currentState,state:"DISCONNECTED"})})}doPublishChange(e=!0){return _(this,null,function*(){let i={state:this.publishState,constraintConfig:this._mediaSettings},s=yield this._signalChannel.sendWaitForResponse({command:J.PUBLISH_STATE_CHANGE,data:i,responseCommand:B.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(s.data.code,s.data.message)})}doUnpublish(e=!1){return this._signalChannel.sendWaitForResponse({command:J.UNPUBLISH,commandDesc:"unpublish",responseCommand:B.UNPUBLISH_RESULT,enableLog:e}).catch(i=>{if(i.getCode()===I.API_CALL_TIMEOUT)return Promise.resolve();throw i})}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:i}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":i&&(this._mediaSettings.videoCodec="VP8");let s=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:o,localAuxVideoTrack:n}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?n=this._publishingLocalVideoTrack:o=this._publishingLocalVideoTrack),Ke){if(s&&s.mediaTrack){let a=s.mediaTrack.getSettings();this._mediaSettings.audioChannel=a.channelCount||1,this._mediaSettings.audioBps=s.profile.bitrate*1e3,this._mediaSettings.audioFs=a.sampleRate||0}if(o&&o.mediaTrack){let a=o.mediaTrack.getSettings();this._mediaSettings.videoWidth=a.width||0,this._mediaSettings.videoHeight=a.height||0,this._mediaSettings.videoFps=a.frameRate||0,this._mediaSettings.videoBps=o.profile.bitrate*1e3,o.small&&(this._mediaSettings.smallVideoWidth=o.small.width,this._mediaSettings.smallVideoHeight=o.small.height,this._mediaSettings.smallVideoFps=o.small.frameRate,this._mediaSettings.smallVideoBps=o.small.bitrate*1e3)}if(n&&n.mediaTrack){let a=n.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=a.width||0,this._mediaSettings.auxVideoHeight=a.height||0,this._mediaSettings.auxVideoFps=a.frameRate||0,this._mediaSettings.auxVideoBps=n.profile.bitrate*1e3}}else s&&s.mediaTrack&&(this._mediaSettings.audioChannel=s.profile.channelCount,this._mediaSettings.audioBps=s.profile.bitrate*1e3,this._mediaSettings.audioFs=s.profile.sampleRate),o&&o.mediaTrack&&(this._mediaSettings.videoWidth=o.profile.width,this._mediaSettings.videoHeight=o.profile.height,this._mediaSettings.videoFps=o.profile.frameRate,this._mediaSettings.videoBps=o.profile.bitrate*1e3);this._log.info(`updateMediaSettings: ${JSON.stringify(this._mediaSettings)}`)}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:J.UPDATE_CONSTRAINT_CONFIG,data:this._mediaSettings,responseCommand:B.UPDATE_CONSTRAINT_CONFIG_RES}).then(e=>{e.data.code!==0&&this._log.warn(e.data.message)}).catch(()=>{})}addTrack(e){return _(this,null,function*(){var s;if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is adding ${e.kind} track to current published local ${i?h.AUXILIARY:h.MAIN} stream`),(s=this._sei)==null||s.handleEncodedStreams(),ot()&&(yield this.addTrackByTransceiver(e,i))})}addTrackByTransceiver(e,i){return _(this,null,function*(){var n;if(!e.mediaTrack)return;let s=this._peerConnection.getTransceivers(),o=e.mediaTrack;if(e.kind===h.AUDIO)this._audioManager.addAudioTrack(e),o=this._audioManager.mediaStreamTrack,yield s[0].sender.replaceTrack(o);else{let a=i?3:1;if(yield s[a].sender.replaceTrack(e.canvasTrack||o),a===1&&((n=this.localMainVideoTrack)==null?void 0:n.small)){this._smallGenerator=new bt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let c=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield s[2].sender.replaceTrack(c)}s[a].direction===G.INACTIVE&&(yield this.setTransceiverDirection(G.SENDONLY,[a]))}this.updateMediaSettings(),yield this.doPublishChange()})}removeTrack(e){return _(this,null,function*(){if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info(`is removing ${e.kind} track from current published local ${i?h.AUXILIARY:h.MAIN} stream`),ot()&&(yield this.removeTrackByTransceiver(e,i))})}removeTrackByTransceiver(e,i){return _(this,null,function*(){if(!e.mediaTrack)return;let s=this._peerConnection.getTransceivers();if(e.kind===h.AUDIO)this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield s[0].sender.replaceTrack(null));else{let o=i?3:1;yield s[o].sender.replaceTrack(null),o===1&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield s[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(G.INACTIVE,[o])}this.updateMediaSettings(),yield this.doPublishChange()})}setTransceiverDirection(e,i){return _(this,null,function*(){if(!Y)return;let s=!1,o=!1;this._log.info(`setting transceiver ${i.join(",")} direction to ${e}`);let n=this._peerConnection.getTransceivers();if(i.forEach(l=>{n[l].direction!==e&&(n[l].direction=e,s=!0)}),s){this._log.info("updating offer");let l=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(l)}let a=-1,c=this._peerConnection.remoteDescription.sdp.split(`\r
`).map(l=>{if(l.match(new RegExp(`a=(${G.INACTIVE}|${G.RECVONLY}|${G.SENDONLY})`))&&a++,i.includes(a)){if(e===G.INACTIVE&&l.includes(`a=${G.RECVONLY}`))return o=!0,`a=${e}`;if(e===G.SENDONLY&&l.includes(`a=${G.INACTIVE}`))return o=!0,`a=${G.RECVONLY}`}return l}).join(`\r
`);o&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:c}))})}replaceTrack(e){return _(this,null,function*(){var n;let i=(n=this._peerConnection)==null?void 0:n.getSenders();if(!i||i.length===0||!e.mediaTrack)return;let s=e.mediaTrack,o=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;if(this._log.info(`is replacing ${s.kind} track on ${o?h.AUXILIARY:h.MAIN} stream`),s.kind===h.AUDIO&&i[0]&&(this._audioManager.addAudioTrack(e),this._audioManager.isMixed&&(s=this._audioManager.mediaStreamTrack),yield i[0].replaceTrack(s)),s.kind===h.VIDEO){if(!o&&i[1]&&(yield i[1].replaceTrack(e.canvasTrack||s),this._smallGenerator&&i[2])){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new bt(this.localMainVideoTrack),yield this._smallGenerator.initialize();let a=this._smallGenerator.generateSmallVideoTrack(this._room.smallStreamConfig);yield i[2].replaceTrack(a)}o&&i[3]&&(yield i[3].replaceTrack(s))}})}setBandwidth(o){return _(this,arguments,function*({bandwidth:e,type:i,videoType:s}){if(this.singlePC){let n={};i===h.AUDIO?n.audio=e:s==="big"?n.bigVideo=e:s==="small"?n.smallVideo=e:n.auxVideo=e,yield this.singlePC.setBandwidth(n)}})}sendMutedFlag(e){var o,n,a;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let s={audio:!!((o=this.localMainAudioTrack)!=null&&o.muted),bigVideo:!!((n=this.localMainVideoTrack)!=null&&n.muted),auxVideo:!!((a=this.localAuxVideoTrack)!=null&&a.muted)};this._log.info(`send muted state: ${JSON.stringify(s)}`),this._signalChannel.send(J.UPDATE_MUTE_STAT,s)}handleConnectionStateChange(e){e.state==="CONNECTED"&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&E.emit(p.SEND_FIRST_VIDEO_FRAME,{room:this._room})}getVideoTrackId(e=h.VIDEO){if(this._peerConnection){let i=this._peerConnection.getSenders();if(e===h.AUXILIARY&&i[3]&&i[3].track)return i[3].track.id;if(e===h.VIDEO&&i[1]&&i[1].track)return i[1].track.id}if(this.localMainVideoTrack&&e===h.VIDEO){let i=this.localMainVideoTrack.mediaTrack;if(i)return i.id}if(this.localAuxVideoTrack&&e===h.AUXILIARY){let i=this.localAuxVideoTrack.mediaTrack;if(i)return i.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,i){if(e!==0)throw e===di?(this._log.error(le.NOT_SUPPORTED_H264ENCODE),new A({code:I.NOT_SUPPORTED_H264,message:b({key:C.NOT_SUPPORTED_H264ENCODE})})):new A({code:I.UNKNOWN,message:b({key:C.SIGNAL_RESPONSE_FAILED,data:{signalResponse:B.PUBLISH_RESULT,code:e,message:i}})})}sendSEI(e,i){var s;(s=this._sei)==null||s.push(e,i)}onSinglePCReconnected(){return _(this,null,function*(){this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0}))})}},uc=lc;function wl(r){return Object.keys(r).filter(t=>r[t])}var Vo=class extends vi{constructor(e){super(k(R({},e),{isUplink:!1}));d(this,"_flag",0);d(this,"role","anchor");d(this,"remoteAudioTrack");d(this,"remoteVideoTrack");d(this,"remoteAuxiliaryTrack");d(this,"ssrc",{audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0});this.flag=e.flag,this.remoteAudioTrack=new tr(this._room,this),this.remoteVideoTrack=new Si(this._room,this),this.remoteAuxiliaryTrack=new ir(this._room,this),this.initialize()}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(this.remoteVideoTrack.mediaType&8?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return Bt(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var i,s,o;e!==this._flag&&(this._flag=e,(i=this.remoteAudioTrack)==null||i.onFlagChanged(),(s=this.remoteVideoTrack)==null||s.onFlagChanged(),(o=this.remoteAuxiliaryTrack)==null||o.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===h.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){this.installEvents()}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents(),this.removeDownlink()}installEvents(){!this.singlePC||(this.listeners("track").includes(this.onTrack)||this.singlePC.on("track",this.onTrack,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||this.singlePC.on("spc-reconnected",this.onSinglePCReconnected,this))}uninstallEvents(){!this.singlePC||(this.singlePC.off("track",this.onTrack,this),this.singlePC.off("spc-reconnected",this.onSinglePCReconnected,this))}emitConnectionStateChangedEvent(e){var o,n;let i=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&i!==e&&((o=this.remoteVideoTrack)==null||o.emit("connection-state-changed",{prevState:i,state:e}),(n=this.remoteAuxiliaryTrack)==null||n.emit("connection-state-changed",{prevState:i,state:e})),s}onTrack(e){let i=e.streams[0],{track:s}=e;if(i.id.split("-")[0]!==this.tinyId)return;let a=i.id.includes("aux")?"auxiliary":"main";this._log.debug(`ontrack ${a} ${s.kind}`);let c=h.AUDIO;s.kind===h.VIDEO&&(c=a===h.MAIN?h.VIDEO:h.AUXILIARY);let l=this.remoteAudioTrack;c===h.VIDEO?l=this.remoteVideoTrack:c===h.AUXILIARY&&(l=this.remoteAuxiliaryTrack),l.setMediaStream(i),l.setMediaStreamTrack(s)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,i){return _(this,null,function*(){try{if(this.isSubscriptionStateNotChanged(e))return;if(this._log.info(`subscribe ${i} ${wl(e)}`),this.hasSSRC){let s="subscribe_change";Object.values(e).find(o=>o===!0)||(s="unsubscribe"),yield this.sendSubscription(s,e)}else yield this.doSubscribe(e)}catch(s){throw this._room.isJoined&&this.isStreamUnpublished(i)?(this._log.warn(`${s.message} ${JSON.stringify(this.muteState)}`),new A({code:I.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId} unpublished stream`})):s}})}unsubscribe(s){return _(this,arguments,function*({remoteTracks:e,streamType:i}){var a;if(i==="main"&&!this.isMainStreamSubscribed||i==="auxiliary"&&!this.isAuxStreamSubscribed){this._log.info(`${i} stream already unsubscribed`);return}let o=R({},this.subscribeState);e.forEach(c=>{switch(c.mediaType){case 1:o.audio=!1;break;case 4:o.video=!1;break;case 8:o.smallVideo=!1;break;case 2:o.auxiliary=!1;break;default:break}});let n="subscribe_change";Object.values(o).find(c=>c===!0)||(n="unsubscribe"),this._log.info(`${n==="unsubscribe"?n:"subscribe"} ${i} [${wl(o)}]`),n==="unsubscribe"&&((a=this.singlePC)==null||a.removeDownlinkQueue.add(this.tinyId)),yield this.sendSubscription(n,o),n==="unsubscribe"&&(yield this.removeDownlink())})}sendSubscription(e,i=this.subscribeState){let s={srcTinyId:this.tinyId,srcUserId:this.userId},o=J.UNSUBSCRIBE,n=B.UNSUBSCRIBE_RESULT;return e==="subscribe_change"&&(s={audio:i.audio,bigVideo:i.video,auxVideo:i.auxiliary,smallVideo:i.smallVideo,srcTinyId:this.tinyId},o=J.SUBSCRIBE_CHANGE,n=B.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:o,data:s,responseCommand:n,timeout:1e4}).then(({data:a})=>{if(a.code!==0){let c=new A({code:a.code,message:b({key:C.ERROR_MESSAGE,data:{type:e,message:a.message}})});throw this._log.error(c),c}})}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}setDelay({audioDelay:e,videoDelay:i}){this.remoteAudioTrack.stat.end2EndDelay=e,this.remoteVideoTrack.stat.end2EndDelay=i}onSinglePCReconnected(){(this.ssrc.audio||this.ssrc.video||this.ssrc.auxiliary)&&this.doSubscribe(this.subscribeState,!1)}get hasSSRC(){return this.ssrc.audio&&this.ssrc.video&&this.ssrc.auxiliary}doSubscribe(){return _(this,arguments,function*(e=this.subscribeState,i=!0){if(!!this.singlePC){if(this.singlePC.addDownlinkQueue.add(this.tinyId),yield this.singlePC.waitForPeerConnectionConnected(),i||!this.hasSSRC){let s={audioSsrc:bi(),bigVideoSsrc:bi(),bigVideoRtxSsrc:bi(),auxVideoSsrc:bi(),auxVideoRtxSsrc:bi()},{audioSsrc:o,bigVideoSsrc:n,bigVideoRtxSsrc:a,auxVideoSsrc:c,auxVideoRtxSsrc:l}=s;this.ssrc={audio:o,video:n,videoRtx:a,auxiliary:c,auxiliaryRtx:l},this.singlePC.addDownlinkQueue.delete(this.tinyId),yield this.singlePC.addDownlink({userId:this.userId,tinyId:this.tinyId,ssrc:this.ssrc});let u=yield this._signalChannel.sendWaitForResponse({command:J.SPC_SUBSCRIBE,responseCommand:B.SPC_SUBSCRIBE_RESULT,data:{srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo,customData:!0,ssrc:s}});if(u.data.code!==0)throw yield this.removeDownlink(),new A({code:u.data.code,message:u.data.message});return}this.singlePC.addDownlinkQueue.delete(this.tinyId),yield this.singlePC.addDownlink({userId:this.userId,tinyId:this.tinyId,ssrc:this.ssrc})}})}removeDownlink(){return _(this,null,function*(){!this.singlePC||(this.ssrc={audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0},this.singlePC.removeDownlinkQueue.delete(this.tinyId),yield this.singlePC.removeDownlink(this.tinyId,this.userId))})}};y([W(r=>function(...t){return new Promise((e,i)=>{let s=o=>{this.off("closed",s),i(new A({code:I.API_CALL_ABORTED,message:b({key:C.CONNECTION_ABORTED,data:o})}))};this.on("closed",s),r.apply(this,t).then(e,i).finally(()=>{this.off("closed",s)})})})],Vo.prototype,"subscribe",1);var xl=Vo;var{isString:hc,isPlainObject:Cm,isUndefined:ti,getNetworkType:Nm,getTerminalType:ym,isEmpty:Ts}=Se,lt=class extends xo{constructor(e){super(e);this.privateMapKey="";this._heartbeat=-1;this._lastHeartBeatTime=-1;this._joinTimeout=-1;this._firstPublishedList=null;this._joinReject=null;this._isPublishing=!1;this._isRelayChanged=!1;this.uplinkConnection=null;this.singlePC=null;this._enableSPC=Kr;this._changeBigSmallRecords=new Map;this._networkQuality=null;this._networkType=Nm();this._turnServers=[];this._syncUserListInterval=-1;this._smallStreamConfig={bitrate:100,frameRate:15,height:120,width:160};this.enableSEI=!1;this._enableAudioVolumeEvaluation=!1;this._audioVolumeIntervalId=null;this._enableMultiAuxStream=!1;this._pureAudioPushMode=!1;this.enableHWEncoder=!1;this._stats=new _s(this,this._log),this.userManager=new Ro(this.userId,this._log),this._version=Ie,this.sdpSemantics=Wi,ti(e.sdpSemantics)?Tt.isUnifiedPlanDefault()&&(this.sdpSemantics=xt):this.sdpSemantics=e.sdpSemantics,this._log.info(`sdpSemantics: ${this.sdpSemantics}, netType: ${this._networkType}`),e.iceTransportPolicy&&(this._iceTransportPolicy=e.iceTransportPolicy),this._enableMultiAuxStream=ti(e.enableMultiAuxStream)?!1:e.enableMultiAuxStream,this.enableSEI=e.enableSEI,!ti(e.enableSPC)&&Kr&&(this._enableSPC=e.enableSPC),this.enableHWEncoder=e.enableHWEncoder||!1,this._initBusinessInfo(e)}get isMainStreamPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.isMainStreamPublished)}get isMainAudioPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.localMainAudioTrack)}get isAuxStreamPublished(){var e;return!!((e=this.uplinkConnection)!=null&&e.isAuxStreamPublished)}get hasAuxStream(){return[...this.remotePublishedUserMap.values()].findIndex(e=>e.muteState.hasAuxiliary)>=0}get userMap(){return this.userManager.userMap}get remotePublishedUserMap(){return this.userManager.remotePublishedUserMap}get tinyIdToUserIdMap(){return new Map([...this.remotePublishedUserMap.values()].map(e=>[e.tinyId,e.userId]))}join(e,i,s){return _(this,null,function*(){return this.userManager.mySelfId=this.userId,this.userManager.on("1",o=>{this.emit("peer-join",o)}),this.userManager.on("2",o=>{this.closeDownLinkConnection(o,"remote user exitRoom"),this.emit("peer-leave",o)}),this.userManager.on("3",this.createDownlinkConnection,this),this.userManager.on("5",this.closeDownLinkConnection,this),this.userManager.on("6",n=>{var o=Ec(n,[]);E.emit(p.REMOTE_PUBLISH_STATE_CHANGED,R({room:this},o)),this.emit("remote-publish-state-changed",R({},o))}),this._joinOptions=e,new Promise((o,n)=>_(this,null,function*(){this._joinReject=n;try{this.checkDestroy(),yield this.initialize(),yield this.doJoin(e),o(),this._firstPublishedList&&this.onPublishedUserList({data:{userList:this._firstPublishedList}})}catch(a){n(a)}this._joinReject=null}))})}doJoin(e){return new Promise((i,s)=>_(this,null,function*(){var c,l,u;ti(e.role)||(this.role=e.role===20?"anchor":"audience"),ti(e.privateMapKey)||(this.privateMapKey=e.privateMapKey),this._signalChannel.once(se.SETUP_FAILED,m=>{this.clearJoinTimeout(),E.emit(p.JOIN_SIGNAL_CONNECTION_END,{room:this,error:m}),s(m)}),te((l=(c=this.scheduleResult)==null?void 0:c.config)==null?void 0:l.singlePC)&&Kr&&(this._enableSPC=this.scheduleResult.config.singlePC);let o;if(this._enableSPC&&!this.singlePC){this.singlePC=new hr({signalChannel:this._signalChannel,room:this,enableCustomMessage:!1}),this.singlePC.once("error",()=>this.fallbackToMPC());try{o=yield this.singlePC.initialize()}catch(m){this.fallbackToMPC()}}this.keyPointManager.setConnectionType(this.singlePC?1:2);let n={roomId:String(e.roomId||e.strRoomId),useStringRoomId:this.useStringRoomId,privateMapKey:this.privateMapKey,trtcRole:this.role==="anchor"?20:21,trtcScene:this.scene==="live"?2:1,sdpSemantics:this.sdpSemantics,version:this._version,ua:navigator&&navigator.userAgent||"",terminalType:ym(),netType:kt[this._networkType],bussinessInfo:this._businessInfo,ability:o};this._log.debug(`join room signal data: ${JSON.stringify(n)}`);let a=5e3;((u=this.scheduleResult.config)==null?void 0:u.enterRoomTimeout)&&this.scheduleResult.config.enterRoomTimeout>=1&&(a=this.scheduleResult.config.enterRoomTimeout*1e3),this._joinTimeout=window.setTimeout(()=>{s(new A({code:I.JOIN_ROOM_FAILED,message:b({key:C.JOIN_ROOM_TIMEOUT})}))},a),E.emit(p.JOIN_SEND_CMD,{room:this}),this._signalChannel.send(this.singlePC?J.SPC_JOIN_ROOM:J.JOIN_ROOM,n),this._signalChannel.once(B.JOIN_ROOM_RESULT,m=>{this.clearJoinTimeout();let{code:f,message:O,data:N}=m.data;E.emit(p.JOIN_RECEIVED_CMD_RES,{room:this,code:f}),f===0?(this._log.info("Join room success, start heartbeat"),this.startHeartbeat(),this.syncUserList(),this.startSyncUserListInterval(),this._firstPublishedList=N.publishers,this.singlePC&&this.singlePC.connect(N.ability).catch(()=>{}),i()):(this._log.error(`Join room failed result: ${f} error: ${O}`),s(new A({code:I.JOIN_ROOM_FAILED,extraCode:f,message:b({key:C.JOIN_ROOM_FAILED,data:{error:O,code:f}})})))})}))}reJoin(){return _(this,null,function*(){if(!this.isJoined){this._log.warn("reJoin abort");return}try{this._log.warn(`reJoin pending: ${this._joinOptions.roomId}`),this.singlePC&&(this.singlePC.close(),this.singlePC=null),this._signalChannel.close(),yield this._signalChannel.connect(),yield this.doJoin(k(R({},this._joinOptions),{role:this.role==="anchor"?20:21,privateMapKey:this.privateMapKey})),this._log.warn("reJoin success"),z.logSuccessEvent({userId:this.userId,eventType:Ze.REJOIN}),this.singlePC?(yield this.singlePC.waitForPeerConnectionConnected(),this.uplinkConnection instanceof uc&&this.uplinkConnection.onSinglePCReconnected(),this.remotePublishedUserMap.forEach(e=>{e.installEvents(),e.doSubscribe()})):(this.checkConnectionsToReconnect(),this.uplinkConnection instanceof ko&&!this.uplinkConnection.getIsReconnecting()&&this.uplinkConnection.startReconnection())}catch(e){this._log.warn(`reJoin fail ${e}`),this.reset(),z.logFailedEvent({userId:this.userId,eventType:Ze.REJOIN,error:e}),this.emit("error",new A({code:I.JOIN_ROOM_FAILED,message:b({key:C.REJOIN_ROOM_FAILED,data:{roomId:this._joinOptions.roomId}})}))}})}initialize(){this._log.info("setup signal channel");let{mainUrl:e,backupUrl:i}=this.getSignalChannelUrl();return this._signalChannel=new ds({sdkAppId:this.sdkAppId,userId:this.userId,userSig:this.userSig,url:e,backupUrl:i,room:this}),this._networkQuality||(this._networkQuality=new Oi({signalChannel:this._signalChannel,room:this}),this._networkQuality.on(Oi.EVENT_NETWORK_QUALITY,s=>{this.emit("network-quality",s)})),this._signalChannel.on(se.CONNECTION_STATE_CHANGED,s=>{E.emit(p.SIGNAL_CONNECTION_STATE_CHANGED,R({room:this},s)),this.emit("signal-connection-state-changed",s)}),this._signalChannel.on(se.RECONNECT_FAILED,s=>{this.reset(),this.emit("error",s)}),this._signalChannel.once(se.SETUP_SUCCESS,s=>{this.tinyId=s.signalInfo.tinyId,E.emit(p.JOIN_SIGNAL_CONNECTION_END,{room:this})}),this._signalChannel.on(B.PEER_JOIN,s=>{let{srcTinyId:o,userId:n,role:a}=s.data.data;this.userManager.addUser({userId:n,tinyId:o,role:a})}),this._signalChannel.on(B.PEER_LEAVE,s=>{let{userId:o,reason:n=0}=s.data.data;this.userManager.deleteUser(o,n)}),this._signalChannel.on(B.UPDATE_REMOTE_MUTE_STAT,s=>{this._lastHeartBeatTime>0&&Date.now()-this._lastHeartBeatTime>=10*1e3&&this.doHeartbeat(),this.onPublishedUserList(s.data)}),this._signalChannel.on(B.CLIENT_BANNED,s=>{let o=s.data.data,{reason:n}=o;if(z.uploadEvent({log:`stat-banned:${n}`,userId:this.userId}),n==="user_time_out"){this._log.warn(`${n} last heart beat time: ${this._lastHeartBeatTime} interval: ${Date.now()-this._lastHeartBeatTime}, visibility: ${document.visibilityState}`),this.reJoin();return}this._log[n==="kick"?"error":"info"](`user was banned because of [${n}]`),this.reset(),this.emit("banned",{reason:n})}),E.emit(p.JOIN_SIGNAL_CONNECTION_START,{room:this}),this._signalChannel.connect(this._isUsingCachedSchedule?10*1e3:void 0)}leave(){return _(this,null,function*(){try{yield this.doHeartbeat()}catch(e){}E.emit(p.LEAVE_SEND_CMD,{room:this}),this._log.info("leave() => leaving room"),this._signalChannel.send(J.LEAVE_ROOM),this.reset()})}clearNetworkQuality(){this._networkQuality&&(this._networkQuality.stop(),this._networkQuality=null)}closeConnections(){this.remotePublishedUserMap.forEach(e=>{this.closeDownLinkConnection(e.userId,"you exitRoom")})}clearJoinTimeout(){clearTimeout(this._joinTimeout),this._joinTimeout=-1}startHeartbeat(){this._heartbeat===-1&&(this._heartbeat=ee.run(et,this.doHeartbeat.bind(this),{delay:2e3}))}stopHeartbeat(){this._heartbeat!==-1&&(this._log.info("stopHeartbeat"),ee.clearTask(this._heartbeat),this._heartbeat=-1,this._lastHeartBeatTime=-1)}doHeartbeat(){return _(this,null,function*(){var a;let e=this.badCaseDetector.getMonitorFreeze(),i=yield this._stats.getStatsReport({uplinkConnection:this.uplinkConnection,downlinkConnections:this.remotePublishedUserMap,freezeMap:e});if(this.badCaseDetector.resetMonitor(),!((a=this._signalChannel)!=null&&a.isConnected))return;let s=this._signalChannel.isConnected?Pd(this.userId):[],o=R({str_sdk_version:ni,uint64_datetime:new Date().getTime(),msg_user_info:{str_identifier:this.userId,uint64_tinyid:this.tinyId},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:kt[this._networkType]},msg_event_msg:s,str_acc_ip:this.getSignalInfo().relayIp,str_client_ip:this.getSignalInfo().clientIp},i);E.emit(p.HEARTBEAT_REPORT,{room:this,report:o}),this._signalChannel.send(J.ON_QUALITY_REPORT,o);let n=Date.now();this._lastHeartBeatTime>0&&n-this._lastHeartBeatTime>1e4&&this._log.warn(`heartbeat took ${n-this._lastHeartBeatTime}`),this._signalChannel.isConnected&&(this._lastHeartBeatTime=n),!this._isRelayChanged&&this.isRelayMaybeFailed()&&(this.reJoin(),this._isRelayChanged=!0)})}onPublishedUserList(e){if(!this.isJoined)return;let i=e.data.userList.map(({userId:s,srcTinyId:o,flag:n})=>{let a=this.remotePublishedUserMap.get(s);return a&&this._changeBigSmallRecords.has(s)&&this.checkSubscribeBigSmallVideo(a),{userId:s,tinyId:o,flag:n}});E.emit(p.RECEIVED_PUBLISHED_USER_LIST,{room:this,publishedUserList:i}),this.userManager.setRemotePublishedUserList(i)}closeUplink(e="you unpublished"){this.uplinkConnection&&(this.localTracks.size>0&&this.uplinkConnection.doUnpublish(),this.uplinkConnection.close(e),this.uplinkConnection=null),this.localTracks.forEach(i=>i.unpublish()),this.localTracks.clear()}createDownlinkConnection({userId:e,tinyId:i,flag:s}){let o=new(this.singlePC?xl:Ja)({userId:e,tinyId:i,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:s});this.userManager.addRemotePublishedUser(o),this.installDownlinkEvents(o,e),this.emit("remote-published",o)}closeDownLinkConnection(e,i="remote user unpublished"){let s=this.remotePublishedUserMap.get(e);s&&(s.close(i),this.emit("remote-unpublished",s))}installDownlinkEvents(e,i){e.on("sei-message",s=>{this.emit("sei-message",s)}),e.on("error",s=>{let o=s.getCode();o!==I.ICE_TRANSPORT_ERROR&&(o===I.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLinkConnection(i),this.emit("error",s))}),e.on("connection-state-changed",s=>{this.emit("media-connection-state-changed",k(R({},s),{userId:e.userId}))}),e.on("firewall-restriction",()=>{this.emit("firewall-restriction")})}startSyncUserListInterval(){this._syncUserListInterval===-1&&(this._syncUserListInterval=ee.run(et,this.syncUserList.bind(this)))}stopSyncUserListInterval(){ee.clearTask(this._syncUserListInterval),this._syncUserListInterval=-1}syncUserList(){return this.getUserList().then(e=>{this.userManager.setUserList(e)}).catch(e=>{this._log.debug(`sync user list failed: ${e}`)})}getUserList(){var e;return(e=this._signalChannel)!=null&&e.isConnected?this._signalChannel.sendWaitForResponse({command:J.GET_USER_LIST,responseCommand:B.USER_LIST_RES,enableLog:!1,timeout:2e3}).then(({data:i})=>{let{code:s,message:o}=i;if(s===0)return(i.data&&i.data.userList||[]).map(({userId:a,srcTinyId:c,role:l})=>({userId:a,tinyId:c,role:l}));throw b({key:C.SIGNAL_RESPONSE_FAILED,data:{signalResponse:B.USER_LIST_RES,code:s,message:o}})}):Promise.reject("not connected")}getAllConnections(){let e=[...this.remotePublishedUserMap.values()];return this.uplinkConnection&&e.push(this.uplinkConnection),e}isRelayMaybeFailed(){if(!this._signalChannel.isOnline||!Ha)return!1;if(this.singlePC)return this.singlePC.reconnectionCount>6;let e=this.getAllConnections();if(e.length===0)return!1;for(let i=0;i<e.length;i++)if(e[i].getReconnectionCount()<6)return!1;return!0}checkConnectionsToReconnect(){this.singlePC||this.getAllConnections().forEach(i=>{if(i instanceof Pe&&!i.getIsReconnecting()){let s=i.getPeerConnection();s&&s.connectionState===Z.CLOSED&&(this._log.warn(`[${i.getUserId()}] pc is closed but not reconnect`),i.startReconnection())}})}fallbackToMPC(){return _(this,null,function*(){var e;if(this._log.warn("fallback to multi pc"),z.uploadEvent({log:"stat-fallback",userId:this.userId}),this._enableSPC=!1,(e=this.singlePC)==null||e.close(),this.singlePC=null,yield this.reJoin(),this.uplinkConnection){let i=this.uplinkConnection;this.uplinkConnection=new ko({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),i.isMainStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:i.localMainAudioTrack,localVideoTrack:i.localMainVideoTrack,isAuxiliary:!1})),i.isAuxStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:i.localAuxAudioTrack,localVideoTrack:i.localAuxVideoTrack,isAuxiliary:!0}))}this.remotePublishedUserMap.forEach(i=>{let s=new Ja({userId:i.userId,tinyId:i.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:i.flag,remoteAudioTrack:i.remoteAudioTrack,remoteVideoTrack:i.remoteVideoTrack,remoteAuxiliaryTrack:i.remoteAuxiliaryTrack});this.installDownlinkEvents(s,i.userId),this.remotePublishedUserMap.set(i.userId,s),i.isMainStreamSubscribed&&s.subscribe(i.subscribeState,"main"),i.isAuxStreamSubscribed&&s.subscribe(i.subscribeState,"auxiliary")})})}destroy(){this._isDestroyed||(super.destroy(),this._joinReject&&(this._joinReject(new A({code:I.INVALID_OPERATION,message:b({key:C.CLIENT_DESTROYED,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.removeAllListeners())}switchRole(e){return _(this,null,function*(){this.role!==e&&(e==="audience"&&this.uplinkConnection&&this.closeUplink("you switch role to audience"),yield this.doSwitchRole(e))})}doSwitchRole(e){let i={command:J.SWITCH_ROLE,data:{role:e==="anchor"?20:21,privateMapKey:this.privateMapKey},responseCommand:B.SWITCH_ROLE_RES,retries:1};return this._log.info(`switchRole signal data: ${JSON.stringify(i.data)}`),this._signalChannel.sendWaitForResponseWithRetry(i).then(s=>{let{code:o,message:n}=s.data;if(o!==0)throw new A({code:I.SWITCH_ROLE_FAILED,message:b({key:C.SWITCH_ROLE_FAILED,data:{message:n,code:o}})});this.role=e}).catch(s=>{throw s instanceof A&&s.getCode()===I.API_CALL_TIMEOUT&&(s=new A({code:I.SWITCH_ROLE_FAILED,message:b({key:C.SWITCH_ROLE_TIMEOUT})})),this._log.error(s),s})}publish(...e){return _(this,null,function*(){if(this.scene==="live"&&this.role!=="anchor")return;E.emit(p.PUBLISH_START,{room:this});let i={},s={};this._isPublishing=!0,e.forEach(o=>{!o.mediaTrack||(o instanceof be&&(o instanceof Ti?(s.audio=o,this.audioManager.addScreenAudioTrack(o)):(i.audio=o,this.audioManager.addAudioTrack(o))),o instanceof je&&(o instanceof at&&o.mediaType===2?s.video=o:i.video=o),o.setPublishStarting(this))});try{let o=Ts(i),n=Ts(s);(!o||!n)&&!this.uplinkConnection&&(this.singlePC?this.uplinkConnection=new uc({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}):this.uplinkConnection=new ko({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),this.uplinkConnection.on("connection-state-changed",c=>{this.emit("media-connection-state-changed",k(R({},c),{userId:this.userId}))}),this.uplinkConnection.on("firewall-restriction",()=>{this.emit("firewall-restriction")}),this.uplinkConnection.on("error",c=>{let l=c.getCode();l!==I.ICE_TRANSPORT_ERROR&&(l===I.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emit("error",c))}));let a=e.map(c=>c.kind).join(",");o||(this._log.info(`publish() => main ${a}`),yield this.uplinkConnection.publish({localAudioTrack:i.audio,localVideoTrack:i.video,isAuxiliary:!1}),this._log.info("main is published")),n||(this._log.info(`publish() => aux ${a}`),yield this.uplinkConnection.publish({localAudioTrack:s.audio,localVideoTrack:s.video,isAuxiliary:!0}),this._log.info("aux is published")),this._isPublishing=!1,e.forEach(c=>{!c.mediaTrack||(this.localTracks.add(c),c.publish(this))})}catch(o){throw e.forEach(n=>{let a="error";o.message.includes("timeout")?a="timeout":o.code===I.API_CALL_ABORTED&&(a="api-call"),n.setPublishStopped(a,a==="error"?o:void 0)}),this._isPublishing=!1,o}})}unpublish(...e){return _(this,null,function*(){if(this.scene==="live"&&this.role!=="anchor"||!this.isMainStreamPublished&&!this.isAuxStreamPublished||!this.uplinkConnection)return;let i={},s={};e.forEach(o=>{!o.mediaTrack||(o instanceof be&&(o instanceof Ti?s.audio=o:i.audio=o),o instanceof je&&(o instanceof at&&o.mediaType===2?s.video=o:i.video=o))});try{let o=e.map(n=>n.kind).join(",");Ts(i)||(this._log.info(`unpublish() => main ${o}`),yield this.uplinkConnection.unpublish({localAudioTrack:i.audio,localVideoTrack:i.video})),Ts(s)||(this._log.info(`unpublish() => aux ${o}`),yield this.uplinkConnection.unpublish({localAudioTrack:s.audio,localVideoTrack:s.video}))}catch(o){}e.forEach(o=>{!o.mediaTrack||(o.unpublish(),this.localTracks.delete(o))}),this.localTracks.size===0&&!this.audioManager.isMixed&&this.closeUplink("you unpublished")})}addTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():(e.setPublishStarting(this),this.uplinkConnection.addTrack(e).then(i=>(e.publish(this),i)))}removeTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():this.uplinkConnection.removeTrack(e).then(i=>(e.unpublish(),i))}replaceTrack(e){return!this.uplinkConnection||!e.mediaTrack?Promise.resolve():this.uplinkConnection.replaceTrack(e).then(i=>{E.emit(p.LOCAL_TRACK_REPLACED,{track:e})})}setBandWidth(e){return _(this,null,function*(){!this.uplinkConnection||(yield this.uplinkConnection.setBandwidth(e),yield this.uplinkConnection.sendMediaSettings())})}subscribe(...e){return _(this,null,function*(){if(e=e.filter(n=>!n.isSubscribed),e.length===0)return;let{userId:i}=e[0],s=this.remotePublishedUserMap.get(i);if(!s)return;let o=e.find(n=>n.mediaType===2)?"auxiliary":"main";try{let n=R({},s.subscribeState);e.forEach(c=>{switch(c.mediaType){case 1:n.audio=!0;break;case 4:n.video=!0;break;case 2:n.auxiliary=!0;break}});let a=this._changeBigSmallRecords.get(i);a&&a.options.smallVideo&&s.muteState.hasSmall&&n.video&&(n.video=!1,n.smallVideo=!0),E.emit(p.SUBSCRIBE_START,{room:this,streamType:o,remotePublishedUser:s,subscribeState:n}),this._log.info(`subscribe() => ${i} ${o} [${Mo(n)}] prev: [${Mo(s.subscribeState)}]`),yield s.subscribe(n,o),s.remoteVideoTrack.setMediaType(n.smallVideo?8:4),E.emit(p.SUBSCRIBE_SUCCESS,{room:this,streamType:o,remotePublishedUser:s})}catch(n){let a=n instanceof A?n.getCode():I.UNKNOWN,c=n;throw n instanceof A?a===I.REMOTE_STREAM_NOT_EXIST&&(c=new A({code:I.API_CALL_ABORTED,message:b({key:C.API_CALL_ABORTED,data:{message:n.message,userId:i,streamType:o}})}),this._log.warn(c)):(c=new A({code:a,message:b({key:C.SUBSCRIBE_FAILED,data:{message:n.message,userId:i,streamType:o}})}),this._log.error(c)),c}})}unsubscribe(...e){return _(this,null,function*(){let{userId:i}=e[0],s=this.remotePublishedUserMap.get(i);if(!s)return;let o=e.find(n=>n.mediaType===2)?"auxiliary":"main";this._log.info(`unsubscribe() => ${i} ${o}`);try{yield s.unsubscribe({remoteTracks:e,streamType:o})}catch(n){this._log.warn(`unsubscribe() => failed ${n}`)}e.forEach(n=>{n.unsubscribe(),n.mediaType===8&&n.setMediaType(4)}),E.emit(p.UNSUBSCRIBE_SUCCESS,{room:this,streamType:o,remotePublishedUser:s})})}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAudioVolumeEvaluation(e=2e3,i){if(e<=0){this._enableAudioVolumeEvaluation=!1,ee.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null;return}e=Math.floor(Math.max(e,100)),E.emit(p.AUDIO_LEVEL_INTERVAL,{interval:e}),this._audioVolumeIntervalId&&(ee.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null),this._enableAudioVolumeEvaluation=!0,this._audioVolumeIntervalId=ee.run(Et,()=>{var o,n;let s=[];if((o=this.uplinkConnection)!=null&&o.localMainAudioTrack){let a=Math.floor(this.uplinkConnection.localMainAudioTrack.getAudioLevel()*100);s.push({userId:"",volume:a})}(n=this.remotePublishedUserMap)==null||n.forEach(a=>{if(a.muteState.hasAudio){let c=Math.floor(a.remoteAudioTrack.getAudioLevel()*100);s.push({userId:a.userId,volume:c})}}),this.emit("audio-volume",s)},{fps:1e3/e,backgroundTask:i})}getLocalAudioStats(){return _(this,null,function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0},this.uplinkConnection){let i=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:i.audio.bytesSent,packetsSent:i.audio.packetsSent}}return e})}getLocalVideoStats(){return _(this,null,function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection){let{video:{bytesSent:i,packetsSent:s,framesEncoded:o,framesSent:n,frameWidth:a,frameHeight:c}}=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:i,packetsSent:s,framesEncoded:o,framesSent:n,frameWidth:a,frameHeight:c}}return e})}getTransportStats(){return _(this,null,function*(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection){let i=yield this._stats.getSenderStats(this.uplinkConnection);e.rtt=i.rtt}for(let[,i]of this.remotePublishedUserMap){let s=yield this._stats.getReceiverStats(i);e.downlinksRTT[s.userId]=s.rtt}return e})}getRemoteVideoStats(e){return _(this,null,function*(){let i={};for(let[s,o]of this.remotePublishedUserMap)e==="main"&&o.muteState.hasVideo&&(i[s]=o.remoteVideoTrack.stat),e==="auxiliary"&&o.muteState.hasAuxiliary&&(i[s]=o.remoteAuxiliaryTrack.stat);return i})}getRemoteAudioStats(){return _(this,null,function*(){let e={};for(let[i,s]of this.remotePublishedUserMap)s.muteState.hasAudio&&(e[i]=s.remoteAudioTrack.stat);return e})}setProxyServer(e){if(hc(e)){if(!e.startsWith("wss://"))throw new A({code:I.INVALID_PARAMETER,message:"invalid websocket url"});this.proxy_ws=e}else if(Cm(e)){let{websocketProxy:i,loggerProxy:s}=e;i&&(this.proxy_ws=i),s&&ai(s)}}setTurnServer(e,i){this._log.info(`set turn server: ${JSON.stringify(e)} ${i||""}`);let s=[];Array.isArray(e)?e.forEach(o=>s.push(Se.getTurnServer(o))):Se.isPlainObject(e)&&s.push(Se.getTurnServer(e)),this._turnServers=s,i&&(this._iceTransportPolicy=i)}sendStartMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:J.START_MIX_TRANSCODE,data:e,timeout:5e3,responseCommand:B.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"})}sendStopMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:J.STOP_MIX_TRANSCODE,data:e,timeout:5e3,responseCommand:B.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"})}sendStartPublishCDN(e,i=!0){return this._signalChannel.sendWaitForResponse({command:i?J.START_PUBLISH_TENCENT_CDN:J.START_PUBLISH_GIVEN_CDN,data:e,timeout:5e3,responseCommand:i?B.START_PUBLISH_TENCENT_CDN_RES:B.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDN"})}sendStopPublishCDN(e,i=!0){return this._signalChannel.sendWaitForResponse({command:i?J.STOP_PUBLISH_TENCENT_CDN:J.STOP_PUBLISH_GIVEN_CDN,data:e,timeout:5e3,responseCommand:i?B.STOP_PUBLISH_TENCENT_CDN_RES:B.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDN"})}getIceServers(){return this._turnServers.length===0&&this.scheduleResult.iceServers?this.scheduleResult.iceServers:this._turnServers}getIceTransportPolicy(){return this._iceTransportPolicy||this.scheduleResult.iceTransportPolicy||"all"}getLogger(){return this._log}enableAIVoice(){throw new Error("Method not implemented.")}getSignalChannelUrl(){let e={mainUrl:"",backupUrl:""},i=Se.getEnv();return i?(e.mainUrl=`wss://${i}.rtc.qq.com`,e.backupUrl=e.mainUrl):this.proxy_ws?(e.mainUrl=this.proxy_ws,e.backupUrl=e.mainUrl):Array.isArray(this.scheduleResult.domains)&&this.scheduleResult.domains.length>0&&(e.mainUrl=`wss://${this.scheduleResult.domains[0]}`,e.backupUrl=e.mainUrl,this.scheduleResult.domains[1]&&(e.backupUrl=`wss://${this.scheduleResult.domains[1]}`)),e}getSignalInfo(){var e;return((e=this._signalChannel)==null?void 0:e.getSignalInfo())||{}}reset(){this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.clearNetworkQuality(),this.closeUplink("you exitRoom"),this._signalChannel&&(this._log.info("destroying SignalChannel"),this._signalChannel.close()),this._stats.reset(),this.userManager.clear(),this.userManager.removeAllListeners(),this.singlePC&&(this.singlePC.close(),this.singlePC=null),this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null}}checkSubscribeBigSmallVideo(e){return _(this,null,function*(){let i=e==null?void 0:e.muteState.hasSmall,s=e==null?void 0:e.muteState.hasVideo;if(!i&&!s||!e.isBigStreamSubscribed&&!e.isSmallStreamSubscribed)return;let o=e.getUserId(),n=this._changeBigSmallRecords.get(o)||{},{subscribeState:a}=e,{options:c,isSubscribing:l,reSubscribeCount:u}=n;if(c.video&&a.video||c.smallVideo&&a.smallVideo&&i||l)return;let m={audio:e.remoteAudioTrack.isSubscribed||e.remoteAudioTrack.isSubscribing,auxiliary:e.remoteAuxiliaryTrack.isSubscribed||e.remoteAuxiliaryTrack.isSubscribing,video:c.video,smallVideo:c.smallVideo};if(i&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed)try{c&&!l&&u>=1&&(n.isSubscribing=!0,n.reSubscribeCount=u-1,!i&&e.isSmallStreamSubscribed&&(m.video=!0,m.smallVideo=!1),yield e==null?void 0:e.subscribe(m,"main"),e.remoteVideoTrack.setMediaType(m.smallVideo?8:4),this._log.info(`change [${o}] to ${m.smallVideo?"small":"big"} video successfully. count ${Ji-n.reSubscribeCount}.`),n.isSubscribing=!1,n.reSubscribeCount=Ji)}catch(f){this._log.info(`change [${o}] to ${m.smallVideo?"small":"big"} video failed. count ${Ji-n.reSubscribeCount}.`),n.isSubscribing=!1,u===0&&this._changeBigSmallRecords.delete(o)}})}changeType(e,i){let o={options:{video:!e,smallVideo:e},isSubscribing:!1,reSubscribeCount:Ji};this._changeBigSmallRecords.set(i.userId,o),this._log.info(`set [${i.userId}] video prefer type: ${e?"small":"big"}`)}get smallStreamConfig(){return this._smallStreamConfig}_initBusinessInfo(e){this._businessInfo=e.businessInfo;let i={};if(hc(e.businessInfo)&&(i=JSON.parse(e.businessInfo)),!ti(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new A({code:I.INVALID_PARAMETER,message:b({key:C.INVALID_PURE_AUDIO})});this._pureAudioPushMode=e.pureAudioPushMode,i.Str_uc_params||(i.Str_uc_params={}),i.Str_uc_params.pure_audio_push_mod=this._pureAudioPushMode}if(!ti(e.userDefineRecordId)){let s=/^[A-Za-z0-9_-]{1,64}$/gi;if(e.userDefineRecordId.match(s)===null)throw new A({code:I.INVALID_PARAMETER,message:b({key:C.INVALID_USER_DEFINE_RECORDID})});i.Str_uc_params||(i.Str_uc_params={}),i.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!ti(e.userDefinePushArgs))if(hc(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256)i.Str_uc_params||(i.Str_uc_params={}),i.Str_uc_params.userdefine_push_args=e.userDefinePushArgs;else throw new A({code:I.INVALID_PARAMETER,message:b({key:C.INVALID_USER_DEFINE_PUSH_ARGS})});Ts(i)||(this._businessInfo=JSON.stringify(i))}sendSEI(e,i){var s;(s=this.uplinkConnection)==null||s.sendSEI(e,i)}};y([me(["left",F.INIT],"joined"),lr({settings:{retries:1,timeout:0},onError(r,t,e){this._isUsingCachedSchedule&&!this._isDestroyed?(this._log.warn("is using cached schedule, retry join"),zt(!0),this.reset(),t()):(this.reset(),this._log.error(r),e(r))}}),zd()],lt.prototype,"join",1),y([me("joined","left",{ignoreError:!0}),Zd(),Nl("leave room"),ps({fnName:"publish",validateArgs:!1}),ps({fnName:"unsubscribe",validateArgs:!1})],lt.prototype,"leave",1),y([fs(),lr({settings:{retries:pt,timeout:r=>we(r)},onError(r,t,e){var i;(i=r.message)!=null&&i.includes("timeout")?(this._log.warn("publish timeout"),t()):(this._log.error(`publish failed: ${r}`),e(r),E.emit(p.PUBLISH_FAILED,{room:this}))}})],lt.prototype,"publish",1),y([ps({fnName:"publish",callback(...r){var t;this.localTracks.size===0&&((t=this.uplinkConnection)==null||t.close("you unpublished"),this.uplinkConnection=null,r.forEach(e=>e.setPublishStopped("api-call")))}}),Cl("api-call"),fs()],lt.prototype,"unpublish",1),y([oc((...r)=>r[0].userId),el(),lr({settings:{retries:pt,timeout:r=>we(r)},onError(r,t,e,i){r.message.includes("timeout")?(this._log.warn("subscribe timeout"),t()):(this._log.error(`subscribe failed: ${r}`),e(r),E.emit(p.SUBSCRIBE_FAILED,{room:this,remoteTracks:i}))}})],lt.prototype,"subscribe",1),y([ps({fnName:"subscribe",callback(...r){this.singlePC||r.forEach(t=>{let e=this.remotePublishedUserMap.get(t.userId);e&&!e.isMainStreamSubscribed&&!e.isAuxStreamSubscribed&&e.close("you unsubscribed")})}}),oc((...r)=>r[0].userId)],lt.prototype,"unsubscribe",1);cs.create=cs._create.bind(cs,lt);var uL=cs;export{uL as default};
