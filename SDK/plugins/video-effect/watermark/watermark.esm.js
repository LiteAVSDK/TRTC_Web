var U=Object.defineProperty;var C=(o,e,t)=>e in o?U(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var p=(o,e,t)=>(C(o,typeof e!="symbol"?e+"":e,t),t);function O(o){return{name:"WatermarkOptions",type:"object",required:!0,allowEmpty:!1,properties:{imageUrl:{required:!0,type:"string"},x:{required:!1,type:"number"},y:{required:!1,type:"number"},size:{required:!1,type:["string","object","number"]}},validate(e,t,i,b){var m;let{RtcError:r,ErrorCode:c,ErrorCodeDictionary:a}=o.errorModule;if(!e)return;let{imageUrl:s}=e,u=s.split("?")[0].split(".").pop();if((u==="jpg"||u==="jpeg")&&o.log.warn("The image format is not recommended to be jpg/jpeg, because the format does not support transparency."),!((m=o.room.videoManager.cameraTrack)!=null&&m.mediaTrack))throw new r({code:c.INVALID_OPERATION,extraCode:a.INVALID_OPERATION_NEED_VIDEO,fnName:i});if(o.utils.isString(e.size)&&e.size!=="contain"&&e.size!=="cover")throw new r({code:c.INVALID_PARAMETER,extraCode:a.INVALID_PARAMETER_TYPE,message:"The size parameter must be 'contain' or 'cover'",fnName:i});if(o.utils.isNumber(e.size)&&(e.size<=0||e.size>1))throw new r({code:c.INVALID_PARAMETER,extraCode:a.INVALID_PARAMETER_RANGE,message:"The size parameter must be greater than 0",fnName:i});if(o.utils.isObject(e.size)){if(!e.size.width||!e.size.height)throw new r({code:c.INVALID_PARAMETER,extraCode:a.INVALID_PARAMETER_TYPE,message:"The size parameter must be an object with width and height properties",fnName:i});if(e.size.width<=0||e.size.height<=0)throw new r({code:c.INVALID_PARAMETER,extraCode:a.INVALID_PARAMETER_RANGE,message:"The size parameter must be greater than 0",fnName:i})}}}}function A(o){return{name:"StopWatermarkOptions",required:!1}}var g=0,_=class{constructor(e){this.core=e;p(this,"seq");p(this,"_core");p(this,"log");p(this,"startResolve");p(this,"startReject");g=g+1,this.seq=g,this._core=e,this.log=e.log.createChild({id:`${this.getAlias()}${g}`}),this.log.info("created")}getName(){return"Watermark"}getAlias(){return"w"}getValidateRule(e){switch(e){case"start":return O(this._core);case"update":return A(this._core);case"stop":return A(this._core)}}getGroup(){return"w"}async start(e){return this.doStart(e)}async update(e){return await this.stop(),this.doStart(e)}async stop(){return this._core.room.videoManager.deleteWatermark()}async doStart(e){let{imageUrl:t,x:i=0,y:b=0,size:r="cover"}=e,{settings:c}=this._core.room.videoManager.cameraTrack,a;try{a=await this._core.utils.loadImage(t)}catch(P){let{RtcError:h,ErrorCode:N}=this.core.errorModule;throw new h({code:N.INVALID_PARAMETER,message:`load image failed, url: ${t}`})}let{width:s,height:n}=c,{width:u,height:m}=a,d=u,l=m;this._core.utils.isObject(r)&&(d=(r==null?void 0:r.width)||d,l=(r==null?void 0:r.height)||l),this._core.utils.isNumber(r)&&(d=u*r,l=m*r);let T=u/m,D=s/n,R=T>D;r==="contain"&&(R?(d=s,l=s/T):(d=n*T,l=n)),r==="cover"&&(R?(l=n,d=n*T):(d=s,l=s/T));let S=document.createElement("canvas"),E=S.getContext("2d");S.width=Math.min(s-i,u),S.height=Math.min(n-b,m),E==null||E.drawImage(a,0,0,d,l);let I=new Image;return I.src=S.toDataURL("image/png"),this._core.room.videoManager.setWatermark({x:i,y:b,width:Math.min(s-i,u),height:Math.min(n-b,m),imageUrl:t,imageElement:I})}};var B=_;export{_ as Watermark,B as default};
