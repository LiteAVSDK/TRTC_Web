import"webrtc-adapter/out/adapter";function e(e,t,i,s,n){var a={};return Object.keys(s).forEach((function(e){a[e]=s[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var t="4.15.16";let i=(new Date).getTime(),s=0;const n=function(){return(new Date).getTime()+s},a=function(){const e=new Date;return e.setTime(n()),e.toLocaleString()},o={CANVAS:"canvas",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",SMALL:"small",BIG:"big",AUXILIARY:"auxiliary",AUX:"aux",SMALL_VIDEO:"smallVideo",FACING_MODE_USER:"user",FACING_MODE_ENVIRONMENT:"environment",MUTE:"mute",UNMUTE:"unmute",ENDED:"ended",PLAYING:"playing",PAUSE:"pause",ERROR:"error",LOADEDDATA:"loadeddata",AUDIO_INPUT:"audioinput",VIDEO_INPUT:"videoinput",DETAIL:"detail",TEXT:"text",MAIN:"main",BACKUP:"backup",BANNED:"banned",KICK:"kick",USER_TIME_OUT:"user_time_out",ROOM_DISBAND:"room_disband",SEI_MESSAGE:"sei-message",PLAYER_STATE_PLAYING:"PLAYING",PLAYER_STATE_PAUSED:"PAUSED",PLAYER_STATE_STOPPED:"STOPPED",DIRECTION_INACTIVE:"inactive",DIRECTION_SENDONLY:"sendonly",DIRECTION_RECVONLY:"recvonly",ADD:"add",REMOVE:"remove",REPLACE:"replace",TRACK:"track"},r="wss://trtc.rtc.qq.com",d="wss://webrtc.qq.com",c="qcloud",l="trtc",h="webrtc";let u="";const _="jssdk_log",m="jssdk_event",p="jssdk_new_endreport",g=e=>u=e,I=1,S=2,E="live",T=20,f=21,A="anchor",v="audience",y="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",R="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",b=2,D=o.MAIN,C=o.AUXILIARY,N="unknown",w="DISCONNECTED",k="CONNECTING",O="RECONNECTING",L="CONNECTED",P="new",M="connecting",U="failed",V="closed",x="disconnected",$="connected",F="completed",B={JOIN:"join",DELTA_JOIN:"delta-join",REJOIN:"rejoin",LEAVE:"leave",DELTA_LEAVE:"delta-leave",PUBLISH:"publish",DELTA_PUBLISH:"delta-publish",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",UPLINK_CONNECTION:"uplink-connection",UPLINK_RECONNECTION:"uplink-reconnection",DOWNLINK_CONNECTION:"downlink-connection",DOWNLINK_RECONNECTION:"downlink-reconnection",ON_TRACK:"ontrack",SET_LOCAL_DESCRIPTION:"setLocalDescription",SET_REMOTE_DESCRIPTION:"setRemoteDescription",ICE_CONNECTION_STATE:"iceConnectionState",LOCAL_STREAM_INITIALIZE:"stream-initialize",SIGNAL_CONNECTION:"websocketConnectionState",SIGNAL_RECONNECTION:"websocketReconnectionState",UPDATE_STREAM:"update-stream",RECOVER_LOCAL_AUDIO_TRACK:"recover-local-audio-track",RECOVER_LOCAL_VIDEO_TRACK:"recover-local-video-track",RECOVER_SUBSCRIPTION:"recover-subscription",START_MIX_TRANSCODE:"start-mix-transcode",STOP_MIX_TRANSCODE:"stop-mix-transcode",PLAYER_ERROR:"player-error",SCHEDULE:"schedule",LOAD_WORKLET:"load-worklet"},H="unsubscribe",G="subscribe_change",W="unified-plan",j="plan-b",J={MANUAL:"manual",PRESET_LAYOUT:"preset-layout"},K={REMOTE:"$PLACE_HOLDER_REMOTE$"},z={IT_AUDIO_VIDEO:0,IT_PICTURE:2,IT_CANVAS:3,IT_PURE_AUDIO:4,IT_PURE_VIDEO:5},Y="string",X="number",q="boolean",Q="array",Z="object",ee={ADD:o.ADD,REMOVE:o.REMOVE},te={unknown:0,wifi:1,"4g":2,"3g":3,"2g":4,wired:5},ie=-1,se=0,ne=1,ae=o.BIG,oe=o.SMALL,re=6048e5,de={MAIN:"schedule.rtc.qq.com",BACKUP:"schedule.rtc.qcloud.com",MAIN_OVERSEA:"schedule.rtc.tencentcloud.com",BACKUP_OVERSEA:"schedule-ecdn.rtc.tencentcloud.com"};let ce="";const le=e=>ce=e,he="TRTC",ue="Client",_e="LocalStream",me="RemoteStream",pe="Stream",ge="web.sdk.qcloud.com",Ie="web.sdk.tencent.cn",Se="web.sdk.cloud.tencent.cn",Ee="https://console.cloud.tencent.com/trtc",Te=`https://${ge}/trtc/webrtc/doc`,fe=`${Te}/zh-cn/`,Ae="trtc_error_assistance",ve="default",ye="communications",Re={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},be=1,De=2,Ce=1,Ne=2,we=Object.keys(Re),ke=["normal leave","timeout leave","kick","role change"],Oe=2e3,Le="ric",Pe="raf",Me="timeout",Ue="Resolution reset to 1080p, need to upgrade ability here https://cloud.tencent.com/document/product/647/85386",Ve={"TRTC.checkSystemRequirements":40001,"TRTC.isScreenShareSupported":40002,"TRTC.isSmallStreamSupported":40003,"TRTC.createClient.rtc":40004,"TRTC.createClient.live":40005,"TRTC.createClient.intRoomId":40006,"TRTC.createClient.stringRoomId":40007,"TRTC.createClient.autoSubscribe":40008,"TRTC.createClient.manualSubscribe":40009,"TRTC.enableUploadLog":40010,"TRTC.disableUploadLog":40011,"Client.publish":40012,"Client.publish.isAuxiliary":40013,"Client.switchRole":40014,"Client.startPublishCDNStream":40015,"Client.stopPublishCDNStream":40016,"Client.startMixTranscode":40017,"Client.stopMixTranscode":40018,"Client.enableAudioVolumeEvaluation":40019,"Client.enableSmallStream":40020,"Client.disableSmallStream":40021,"Client.setSmallStreamProfile":40022,"Client.setRemoteVideoStreamType":40023,"Client.sendSEIMessage":40024,"Client.setProxyServer":40025,"Client.setTurnServer":40026,"LocalStream.setAudioProfile.standard":40027,"LocalStream.setAudioProfile.high":40028,"LocalStream.setAudioProfile.standard-stereo":40029,"LocalStream.setAudioProfile.high-stereo":40030,"LocalStream.setVideoProfile.120p":40031,"LocalStream.setVideoProfile.120p_2":40032,"LocalStream.setVideoProfile.180p":40033,"LocalStream.setVideoProfile.180p_2":40034,"LocalStream.setVideoProfile.240p":40035,"LocalStream.setVideoProfile.240p_2":40036,"LocalStream.setVideoProfile.360p":40037,"LocalStream.setVideoProfile.360p_2":40038,"LocalStream.setVideoProfile.480p":40039,"LocalStream.setVideoProfile.480p_2":40040,"LocalStream.setVideoProfile.720p":40041,"LocalStream.setVideoProfile.1080p":40042,"LocalStream.setVideoProfile.1440p":40043,"LocalStream.setVideoProfile.4K":40044,"LocalStream.setScreenProfile.480p":40045,"LocalStream.setScreenProfile.480p_2":40046,"LocalStream.setScreenProfile.720p":40047,"LocalStream.setScreenProfile.720p_2":40048,"LocalStream.setScreenProfile.1080p":40049,"LocalStream.setScreenProfile.1080p_2":40050,"LocalStream.setVideoContentHint.motion":40051,"LocalStream.setVideoContentHint.detail":40052,"LocalStream.setVideoContentHint.text":40053,"LocalStream.setAudioCaptureVolume":40054,"LocalStream.getVideoFrame":40055,"RemoteStream.setAudioOutput":40056,"RemoteStream.getVideoFrame":40057,AI_DENOISER:1700,SPATIAL_AUDIO:1701,"2K_4K":1704},xe=["width","height","frameRate","facingMode","sampleRate","sampleSize","channelCount","deviceId"],$e={AVOID_REPEATED_CALL:"AVOID_REPEATED_CALL",INVALID_PARAMETER_REQUIRED:"INVALID_PARAMETER_REQUIRED",INVALID_PARAMETER_TYPE:"INVALID_PARAMETER_TYPE",INVALID_PARAMETER_EMPTY:"INVALID_PARAMETER_EMPTY",INVALID_PARAMETER_INSTANCE:"INVALID_PARAMETER_INSTANCE",INVALID_PARAMETER_RANGE:"INVALID_PARAMETER_RANGE",API_CALL_TIMEOUT:"API_CALL_TIMEOUT",SIGNAL_CHANNEL_RECONNECTION_FAILED:"SIGNAL_CHANNEL_RECONNECTION_FAILED",SIGNAL_CHANNEL_SETUP_FAILED:"SIGNAL_CHANNEL_SETUP_FAILED",ERROR_MESSAGE:"ERROR_MESSAGE",EXCHANGE_SDP_TIMEOUT:"EXCHANGE_SDP_TIMEOUT",DOWNLINK_RECONNECTION_FAILED:"DOWNLINK_RECONNECTION_FAILED",EXCHANGE_SDP_FAILED:"EXCHANGE_SDP_FAILED",UPDATE_OFFER_TIMEOUT:"UPDATE_OFFER_TIMEOUT",UPLINK_RECONNECTION_FAILED:"UPLINK_RECONNECTION_FAILED",INVALID_RECORDID:"INVALID_RECORDID",INVALID_PURE_AUDIO:"INVALID_PURE_AUDIO",INVALID_STREAMID:"INVALID_STREAMID",INVALID_USER_DEFINE_RECORDID:"INVALID_USER_DEFINE_RECORDID",INVALID_USER_DEFINE_PUSH_ARGS:"INVALID_USER_DEFINE_PUSH_ARGS",INVALID_PROXY:"INVALID_PROXY",INVALID_JOIN:"INVALID_JOIN",INVALID_ROOMID_STRING:"INVALID_ROOMID_STRING",INVALID_ROOMID_INTEGER:"INVALID_ROOMID_INTEGER",INVALID_SIGNAL_CHANNEL:"INVALID_SIGNAL_CHANNEL",JOIN_ROOM_TIMEOUT:"JOIN_ROOM_TIMEOUT",JOIN_ROOM_FAILED:"JOIN_ROOM_FAILED",REJOIN_ROOM_FAILED:"REJOIN_ROOM_FAILED",INVALID_DESTROY:"INVALID_DESTROY",INVALID_PUBLISH:"INVALID_PUBLISH",INVALID_UNPUBLISH:"INVALID_UNPUBLISH",INVALID_AUDIENCE:"INVALID_AUDIENCE",INVALID_INITIALIZE:"INVALID_INITIALIZE",INVALID_DUPLICATE_PUBLISHING:"INVALID_DUPLICATE_PUBLISHING",INVALID_SUBSCRIBE_UNDEFINED:"INVALID_SUBSCRIBE_UNDEFINED",INVALID_SUBSCRIBE_LOCAL:"INVALID_SUBSCRIBE_LOCAL",INVALID_REMOTE_STREAM:"INVALID_REMOTE_STREAM",SUBSCRIBE_FAILED:"SUBSCRIBE_FAILED",INVALID_ROLE:"INVALID_ROLE",INVALID_PARAMETER_SWITCH_ROLE:"INVALID_PARAMETER_SWITCH_ROLE",INVALID_OPERATION_SWITCH_ROLE:"INVALID_OPERATION_SWITCH_ROLE",SWITCH_ROLE_TIMEOUT:"SWITCH_ROLE_TIMEOUT",SWITCH_ROLE_FAILED:"SWITCH_ROLE_FAILED",CLIENT_BANNED:"CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"INVALID_OPERATION_START_PUBLISH_CDN",INVALID_OPERATION_STOP_PUBLISH_CDN:"INVALID_OPERATION_STOP_PUBLISH_CDN",INVALID_STREAM_ID:"INVALID_STREAM_ID",START_PUBLISH_CDN_FAILED:"START_PUBLISH_CDN_FAILED",STOP_PUBLISH_CDN_FAILED:"STOP_PUBLISH_CDN_FAILED",START_MIX_TRANSCODE:"START_MIX_TRANSCODE",STOP_MIX_TRANSCODE:"STOP_MIX_TRANSCODE",INVALID_AUDIO_VOLUME:"INVALID_AUDIO_VOLUME",ENABLE_SMALL_STREAM_PUBLISHED:"ENABLE_SMALL_STREAM_PUBLISHED",DISABLE_SMALL_STREAM_PUBLISHED:"DISABLE_SMALL_STREAM_PUBLISHED",NOT_SUPPORTED_SMALL_STREAM:"NOT_SUPPORTED_SMALL_STREAM",INVALID_SMALL_STREAM_PROFILE:"INVALID_SMALL_STREAM_PROFILE",INVALID_PARAMETER_REMOTE_STREAM:"INVALID_PARAMETER_REMOTE_STREAM",INVALID_OPERATION_CHANGE_SMALL:"INVALID_OPERATION_CHANGE_SMALL",REMOTE_NOT_PUBLISH_SMALL_STREAM:"REMOTE_NOT_PUBLISH_SMALL_STREAM",INVALID_SWITCH_DEVICE:"INVALID_SWITCH_DEVICE",INVALID_SWITCH_DEVICE_PUBLISHING:"INVALID_SWITCH_DEVICE_PUBLISHING",INVALID_REPLACE_TRACK:"INVALID_REPLACE_TRACK",INVALID_INITIALIZE_LOCAL_STREAM:"INVALID_INITIALIZE_LOCAL_STREAM",INVALID_ADD_TRACK_REPETITIVE:"INVALID_ADD_TRACK_REPETITIVE",INVALID_ADD_TRACK_REMOVING:"INVALID_ADD_TRACK_REMOVING",INVALID_ADD_TRACK_PUBLISHING:"INVALID_ADD_TRACK_PUBLISHING",INVALID_STREAM_INITIALIZED:"INVALID_STREAM_INITIALIZED",INVALID_ADD_TRACK_NUMBER:"INVALID_ADD_TRACK_NUMBER",INVALID_REMOVE_AUDIO_TRACK:"INVALID_REMOVE_AUDIO_TRACK",INVALID_REMOVE_AUDIO_ADDING:"INVALID_REMOVE_AUDIO_ADDING",INVALID_REMOVE_AUDIO_ON:"INVALID_REMOVE_AUDIO_ON",INVALID_REMOVE_TRACK_PUBLISHING:"INVALID_REMOVE_TRACK_PUBLISHING",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"INVALID_REMOVE_TRACK_NOT_PUBLISHING",INVALID_REMOVE_TRACK_NUMBER:"INVALID_REMOVE_TRACK_NUMBER",INVALID_REPLACE_TRACK_NO_TRACK:"INVALID_REPLACE_TRACK_NO_TRACK",REPEAT_JOIN:"REPEAT_JOIN",CLIENT_DESTROYED:"CLIENT_DESTROYED",START_MIX_TRANSCODE_FAILED:"START_MIX_TRANSCODE_FAILED",STOP_MIX_TRANSCODE_FAILED:"STOP_MIX_TRANSCODE_FAILED",MIX_TRANSCODE_NOT_STARTED:"MIX_TRANSCODE_NOT_STARTED",CANNOT_LESS_THAN_ZERO:"CANNOT_LESS_THAN_ZERO",MIX_PARAMS_VIDEO_FRAMERATE:"MIX_PARAMS_VIDEO_FRAMERATE",MIX_PARAMS_VIDEO_GOP:"MIX_PARAMS_VIDEO_GOP",MIX_PARAMS_AUDIO_BITRATE:"MIX_PARAMS_AUDIO_BITRATE",MIX_PARAMS_USER_Z_ORDER:"MIX_PARAMS_USER_Z_ORDER",MIX_PARAMS_NOT_SELF:"MIX_PARAMS_NOT_SELF",MIX_PARAMS_USER_STREAM:"MIX_PARAMS_USER_STREAM",INVALID_PLAY:"INVALID_PLAY",INVALID_ELEMENT_ID:"INVALID_ELEMENT_ID",INVALID_ELEMENT_ID_TYPE:"INVALID_ELEMENT_ID_TYPE",PLAY_FAILED:"PLAY_FAILED",INVALID_USERID:"INVALID_USERID",INVALID_CREATE_STREAM_SOURCE:"INVALID_CREATE_STREAM_SOURCE",INVALID_CREATE_STREAM_SCREEN:"INVALID_CREATE_STREAM_SCREEN",INVALID_CREATE_STREAM_AUDIO:"INVALID_CREATE_STREAM_AUDIO",INVALID_CREATE_STREAM_SCREEN_AUDIO:"INVALID_CREATE_STREAM_SCREEN_AUDIO",NOT_SUPPORTED_HTTP:"NOT_SUPPORTED_HTTP",NOT_SUPPORTED_WEBRTC:"NOT_SUPPORTED_WEBRTC",NOT_SUPPORTED_PROFILE:"NOT_SUPPORTED_PROFILE",NOT_SUPPORTED_MEDIA:"NOT_SUPPORTED_MEDIA",NOT_SUPPORTED_H264ENCODE:"NOT_SUPPORTED_H264ENCODE",NOT_SUPPORTED_H264DECODE:"NOT_SUPPORTED_H264DECODE",NOT_SUPPORTED_TRACK:"NOT_SUPPORTED_TRACK",NOT_SUPPORTED_SWITCH_DEVICE:"NOT_SUPPORTED_SWITCH_DEVICE",NOT_SUPPORTED_CAPTURE:"NOT_SUPPORTED_CAPTURE",NOT_SUPPORTED_AUX:"NOT_SUPPORTED_AUX",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",SIGNAL_RESPONSE_FAILED:"SIGNAL_RESPONSE_FAILED",CATCH_HANDLER_ERROR:"CATCH_HANDLER_ERROR",API_NOT_EXIST:"API_NOT_EXIST",CONNECTION_CLOSED:"CONNECTION_CLOSED",SUBSCRIBE_ALL_FALSE:"SUBSCRIBE_ALL_FALSE",SEI_NOT_SUPPORT:"SEI_NOT_SUPPORT",SEI_DISABLED:"SEI_DISABLED",SEI_EMPTY:"SEI_EMPTY",SEI_OVERSIZE:"SEI_OVERSIZE",SEI_BEFORE_PUBLISH:"SEI_BEFORE_PUBLISH",SEI_NOT_VIDEO:"SEI_NOT_VIDEO",CALL_FREQUENCY_LIMIT:"CALL_FREQUENCY_LIMIT",CONNECTION_ABORTED:"CONNECTION_ABORTED",API_CALL_ABORTED:"API_CALL_ABORTED",DUPLICATE_AUX:"DUPLICATE_AUX"},Fe={AVOID_REPEATED_CALL:e=>`previous ${e.name}() is ongoing, please avoid repeated calls.`,INVALID_PARAMETER_REQUIRED:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' is a required param when calling ${i}(), received: ${s}.`,INVALID_PARAMETER_TYPE({key:e,rule:t,fnName:i,value:s}){const n=`${e||t.name}`;let a="";return a=Array.isArray(t.type)?t.type.join("|"):t.type,`'${n}' must be type of ${a} when calling ${i}(), received type: ${Ii(s)}.`},INVALID_PARAMETER_EMPTY:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' cannot be '${s}' when calling ${i}().`,INVALID_PARAMETER_INSTANCE:({key:e,rule:t,fnName:i,value:s})=>`'${`${e||t.name}`}' must be instanceof ${`${t.instanceOf.name||t.instanceOf}`} when calling ${i}(), received type: ${Ii(s)}.`,INVALID_PARAMETER_RANGE:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' must be one of ${t.values.join("|")} when calling ${i}(), received: ${s}.`,API_CALL_TIMEOUT:e=>`${e.commandDesc||e.command} timeout observed.`,SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED:e=>`SignalChannel setup failure: (errorCode: ${e.errorCode}, errorMsg: ${e.errorMsg} }).`,ERROR_MESSAGE(e){let t=`${e.type} failed`;return e.message&&(t=`${t}: ${e.message}.`),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED:e=>`exchange sdp failed ${e.errMsg}.`,UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING:e=>`'${e}' must be validate string when useStringRoomId is true.`,INVALID_ROOMID_INTEGER:e=>`'${e}' must be an integer between [1, 4294967294] when useStringRoomId is false.`,INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED:({error:e,code:t})=>`Failed to join room - ${e} code: ${t}`,REJOIN_ROOM_FAILED:e=>`reJoin room: ${e.roomId} failed, please check your network.`,INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:`no permission to publish() under live/${v}, please call switchRole("${A}") firstly before publish().`,INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING:e=>`duplicate ${e} stream publishing, please unpublish your prev ${e} stream and then re-publish.`,INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED:({message:e,stream:t})=>`failed to subscribe ${t.getUserId()} ${t.getType()} stream, reason: ${e}.`,INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:`role could only be set to a value as ${A} or ${v}.`,INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED:e=>`switchRole failed, errCode: ${e.code} errMsg: ${e.message}.`,CLIENT_BANNED:e=>"client was banned because of "+e.message+".",INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() before client join the room or after client join the room and successfully publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED:e=>`startPublishCDNStream failed, errMsg: ${e.message}.`,STOP_PUBLISH_CDN_FAILED:e=>`stopPublishCDNStream failed, errMsg: ${e.message}.`,INVALID_STREAM_ID:e=>`'${e}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`,START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"the track to be removed is not being publishing.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK:e=>`cannot replace ${e.kind} track because stream has not ${e.kind} track`,START_MIX_TRANSCODE_FAILED:e=>`startMixTranscode failed, errMsg: ${e.message}.`,STOP_MIX_TRANSCODE_FAILED:e=>`stopMixTranscode failed, errMsg: ${e.message}.`,MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO:({key:e,rule:t,fnName:i,value:s})=>`'${e||t.name}' cannot be less than 0 when calling ${i}().`,MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER:e=>`'${e}' is required and must be between 1 and 15.`,MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:({key:e,fnName:t})=>`'${e}' is not found in the document object when calling ${t}().`,INVALID_ELEMENT_ID_TYPE:({key:e,fnName:t,type:i})=>`the element corresponding to '${e}' must be instanceof HTMLDivElement when calling ${t}(), received: ${i}.`,PLAY_FAILED:e=>`${e.media} play failed，browser exception: ${e.error.toString()}`,INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK:e=>`${e}Track is not supported on your browser.`,NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone and the configuration on TRTC.createStream.",CAMERA_NOT_FOUND:"no camera detected, please check your camera and the configuration on TRTC.createStream.",SIGNAL_RESPONSE_FAILED:e=>`${e.signalResponse} failed, response code is ${e.code} , errMsg: ${e.message}.`,CATCH_HANDLER_ERROR:({name:e,event:t})=>`an error was caught on ${e}.on('${t}', handler), please check your code on 'handler'.`,API_NOT_EXIST:({name:e})=>`experimental api ${e} does not exist.`,REPEAT_JOIN:e=>`[${e}] is calling client.join api or has already joined room, please avoid repeated join.`,CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED:({funName:e})=>`failed to call ${e}() because client was destroyed.`,SEI_NOT_SUPPORT:e=>"not support to sendSEIMessage"+(!1===e?" without using h264 codec":""),SEI_DISABLED:"SEI is disabled, to enable SEI: TRTC.createClient({ enableSEI: true })",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:e=>`buffer size(${e}) is over 1000 Bytes`,SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:({isSize:e,name:t,timesInSecond:i,maxSizeInSecond:s})=>`api ${t} call ${e?"size":"times"} is over ${e?s+" bytes":i} in a second.`,CONNECTION_ABORTED:e=>"connection aborted due to: "+e,API_CALL_ABORTED(e){let t;return t=e.message.includes("REMOTE_STREAM_NOT_EXIST")?`Subscribe ${e.stream.getUserId()} ${e.stream.getType()} stream aborted, reason: remote user ${e.stream.getUserId()} unpublished stream.`:`API aborted, reason: ${e.message}`,t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser."},Be=window.navigator&&window.navigator.userAgent||"",He=/AppleWebKit\/([\d.]+)/i.exec(Be);He&&parseFloat(He.pop());const Ge=/iPad/i.test(Be),We=navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/Macintosh/.test(Be),je=/iPhone/i.test(Be)&&!Ge,Je=/iPod/i.test(Be),Ke=je||Ge||Je||We,ze=/Android/i.test(Be);ze&&function(){const e=Be.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const t=e[1]&&parseFloat(e[1]),i=e[2]&&parseFloat(e[2]);t&&i&&parseFloat(e[1]+"."+e[2])}();ze&&/webkit/i.test(Be);const Ye=/Firefox/i.test(Be),Xe=Ye&&function(){const e=Be.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),qe=/Edge\//i.test(Be),Qe=qe&&function(){var e=Be.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),Ze=/Edg\//i.test(Be),et=Ze&&function(){const e=Be.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),tt=/SogouMobileBrowser\//i.test(Be),it=tt&&function(){const e=Be.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),st=/MetaSr\s/i.test(Be),nt=st&&function(){const e=Be.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),at=/TBS\/\d+/i.test(Be),ot=at&&function(){var e=Be.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),rt=/XWEB\/\d+/i.test(Be),dt=rt&&function(){var e=Be.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}();/MSIE\s8\.0/.test(Be);/MSIE\/\d+/i.test(Be)&&function(){const e=/MSIE\s(\d+)\.\d/.exec(Be);let t=e&&parseFloat(e[1]);!t&&/Trident\/7.0/i.test(Be)&&/rv:11.0/.test(Be)&&(t=11)}();const ct=/(micromessenger|webbrowser)/i.test(Be),lt=ct&&function(){var e=Be.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return e[1]}(),ht=!at&&/MQQBrowser\/\d+/i.test(Be)&&/COVC\/\d+/i.test(Be),ut=!at&&/MQQBrowser\/\d+/i.test(Be)&&!/COVC\/\d+/i.test(Be),_t=(ut||ht)&&function(){const e=Be.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),mt=!at&&/ QQBrowser\/\d+/i.test(Be),pt=mt&&function(){const e=Be.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),gt=!at&&/QQBrowserLite\/\d+/i.test(Be),It=gt&&function(){const e=Be.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),St=!at&&/MQBHD\/\d+/i.test(Be),Et=St&&function(){const e=Be.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Tt=/Windows/i.test(Be),ft=!Ke&&/MAC OS X/i.test(Be),At=!ze&&/Linux/i.test(Be);/MicroMessenger/i.test(Be);const vt=/UCBrowser/i.test(Be);/Electron/i.test(Be);const yt=/MiuiBrowser/i.test(Be),Rt=yt&&function(){const e=Be.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),bt=/HuaweiBrowser/i.test(Be),Dt=/Huawei/i.test(Be),Ct=bt&&function(){const e=Be.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Nt=/SamsungBrowser/i.test(Be),wt=Nt&&function(){const e=Be.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),kt=/HeyTapBrowser/i.test(Be),Ot=kt&&function(){const e=Be.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Lt=/VivoBrowser/i.test(Be),Pt=Lt&&function(){const e=Be.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Mt=()=>{const e=Be.match(/Chrome\/(\d+)/);return e&&e[1]?Number(e[1]):null},Ut=/Chrome/i.test(Be),Vt=!qe&&!st&&!tt&&!at&&!rt&&!Ze&&!mt&&!yt&&!bt&&!Nt&&!kt&&!Lt&&/Chrome/i.test(Be),xt=Vt&&Mt(),$t=Vt&&function(){const e=Be.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Ft=!Ut&&!ut&&!ht&&!gt&&!St&&/Safari/i.test(Be),Bt=function(){if(Ft){const e=Be.match(/Version\/([\d.]+)/);if(e&&e[1])return e[1]}return""}(),Ht=/Android.*(wv|.0.0.0)/.test(Be),Gt=(()=>{if(We)return Bt;if(Ke){const e=Be.match(/OS (\d+)_(\d+)/i);if(e&&e[1]){let t=e[1];return e[2]&&(t+=`.${e[2]}`),t}}return""})(),Wt=Number(Gt.split(".")[0]),jt="15.1"===Bt,Jt="15.1"===Gt,Kt=(()=>{const e=Number(Gt.split(".")[0]);return 14===e||13===e})(),zt="file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname,Yt=(()=>{let e;return()=>{if(li(e))try{e=window.localStorage}catch(t){Vs.warn(t),e=!1}return e}})(),Xt=new Map([[Ye,["Firefox",Xe]],[Ze,["Edg",et]],[Vt,["Chrome",$t]],[Ft,["Safari",Bt]],[at,["TBS",ot]],[rt,["XWEB",dt]],[ct&&je,["WeChat",lt]],[mt,["QQ(Win)",pt]],[ut,["QQ(Mobile)",_t]],[ht,["QQ(Mobile X5)",_t]],[gt,["QQ(Mac)",It]],[St,["QQ(iPad)",Et]],[yt,["MI",Rt]],[bt,["HW",Ct]],[Nt,["Samsung",wt]],[kt,["OPPO",Ot]],[Lt,["VIVO",Pt]],[qe,["EDGE",Qe]],[tt,["SogouMobile",it]],[st,["Sogou",nt]]]);function qt(){let e="unknown",t="unknown";return Xt.get(!0)&&(e=Xt.get(!0)[0],t=Xt.get(!0)[1]),{name:e,version:t}}const Qt=(e,t)=>t?Te+"/"+e+"/"+t:Te+"/"+e+"/index.html",Zt=()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};{let e=localStorage.getItem(Ae);if(e){e=JSON.parse(e);const t=document.createElement("script");t.type="text/javascript",t.text=e.message,document.body.appendChild(t);const i=window.TRTC_ERROR_INFO,s=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:i,TRTC_ERROR_LINK:s}}}return{}},ei=()=>{if(!Yt())return!1;const e=localStorage.getItem(Ae);e&&!(e=>{const i=e.saveTime&&(new Date).getTime()-e.saveTime>=re,s=!e.saveVersion||e.saveVersion!==t;return i||s})(JSON.parse(e))||(Vs.info("init debug info"),(()=>{const e=new XMLHttpRequest;if(e.open("GET","https://web.sdk.qcloud.com/trtc/webrtc/download/error-message/0.0.3/script.js",!1),e.send(null),4===e.readyState&&200===e.status){const i=document.createElement("script");i.type="text/javascript",i.text=e.responseText,document.body.appendChild(i),localStorage.setItem(Ae,JSON.stringify({message:e.responseText,saveTime:(new Date).getTime(),saveVersion:t})),document.body.removeChild(i)}})())};function ti(e){const{key:t,data:i,link:s,addDocLink:n=!0}=e;let a="",o="",r="";ci(Fe[t])?a=Fe[t](i):hi(Fe[t])&&(a=Fe[t]);const{TRTC_ERROR_INFO:d,TRTC_ERROR_LINK:c}=Zt();s?r=`${s.className}.html#${s.fnName}`:c&&c[t]&&(ci(c[t])?r=c[t](i):hi(c[t])&&(r=c[t]));let l=a;return fi()&&(d&&d[t]&&(ci(d[t])?o=d[t](i):hi(d[t])&&(o=d[t])),o&&(l=n?o+"\n请查看文档: "+Qt("zh-cn",r)+"\n\n":o+"\n\n",l+=a)),n&&(l+=" \nRefer to: "+Qt("en",r)+"\n"),l}const ii=function(){return function(e){const t=window.location.search.match(new RegExp("(\\?|&)"+e+"=([^&]*)(&|$)"));return t?decodeURIComponent(t[2]):""}("trtc_env")},si=e=>(e=Number(e))>0&&e<14e8,ni=function(e,t){let i;i=u?u.includes("http")?u:"https://"+u:si(e)?"https://apisgp.my-imcloud.com":"https://yun.tim.qq.com";return`${i}/v5/AVQualityReportSvc/C2S?random=${Math.floor(Math.random()*2**31)}&sdkappid=${e}&cmdtype=${t}`};function ai(){const e=navigator.userAgent,t=navigator.connection;let i=e.match(/NetType\/\w+/)?e.match(/NetType\/\w+/)[0]:"";i=i.toLowerCase().replace("nettype/",""),"3gnet"===i&&(i="3g");const s=t&&t.type&&t.type.toLowerCase();let n=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===n&&(n="2g");let a=i||"unknown";if(s)switch(s){case"cellular":case"wimax":a=n||"unknown";break;case"wifi":a="wifi";break;case"ethernet":a="wired";break;case"none":case"other":case"unknown":a="unknown"}return a}const oi=function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)};function ri(e,t=1,i=1){return e<=1?i:ri(e-1,i,t+i)}function di(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*ri(t)}const ci=e=>"function"==typeof e,li=e=>void 0===e,hi=e=>"string"==typeof e,ui=e=>"number"==typeof e,_i=e=>"boolean"==typeof e,mi=e=>"object"===Ii(e),pi=e=>"array"===Ii(e),gi=e=>Ii(e)==="MediaStreamTrack".toLowerCase();function Ii(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}function Si(e){const t={};return t.urls=`turn:${e.url}`,li(e.username)||li(e.credential)||(t.username=e.username,t.credential=e.credential,t.credentialType="password",li(e.credentialType)||(t.credentialType=e.credentialType)),t}function Ei(){return performance&&performance.now?Math.floor(performance.now()):Date.now()}function Ti(e,t="big"){if(!hi(e))return 0;const i=e.split(".");return"big"===t?(Number(i[0])<<24|Number(i[1])<<16|Number(i[2])<<8|Number(i[3]))>>>0:(Number(i[3])<<24|Number(i[2])<<16|Number(i[1])<<8|Number(i[0]))>>>0}const fi=()=>{let e=navigator.language||navigator.userLanguage;return e=e.substr(0,2),"zh"===e},Ai=(()=>{let e=!1,t=document.visibilityState;return()=>{document.visibilityState!==t&&Vs.info(`visibility change: ${document.visibilityState}`),e||(document.addEventListener("visibilitychange",(()=>{Vs.info("visibility change: "+document.visibilityState),t=document.visibilityState})),e=!0)}})();window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;const vi=()=>new window.AudioContext,yi=(()=>{let e;return()=>{if(e)return e;e=new window.AudioContext;return e.onstatechange=()=>{Vs.info(`gain context state: ${e.state}`),"suspended"===e.state?(e.resume(),document.addEventListener("click",e.resume)):"interrupted"===e.state?e.resume():document.removeEventListener("click",e.resume)},e}})(),Ri=!!window.AudioWorkletNode,bi=(e,t)=>{const i=e.emit;return e.emit=(...s)=>{try{i.apply(e,s)}catch(n){const e=ti({key:$e.CATCH_HANDLER_ERROR,data:{name:t,event:s[0]},addDocLink:!1});Vs.warn(e+"\n\n"+n.stack)}},e},Di=e=>+e<10?`0${e}`:e,Ci=e=>{const t=e.match(/^\d+\.\d+\.\d+/)[0];if(!t)return e;const i=t.split("."),s=Di(i[1])+Di(i[2]);i[1]-15>0&&(i[1]="15"),i[2]-15>0&&(i[2]="15");return i.join(".")+"."+s};function Ni(e,t){try{if(pi(e))return`[${e.map((e=>Ni(e,t))).join(",")}]`;if(!oi(e)||!pi(t))return JSON.stringify(e);const i={},s=new Set(t);return Object.keys(e).forEach((t=>{s.has(t)&&(i[t]=e[t])})),JSON.stringify(i)}catch(i){return"{}"}}function wi(e){const{url:t,body:i,method:s,timeout:n}=e;let a=new XMLHttpRequest;return new Promise(((e,o)=>{a.onload=t=>{if(a.status>=200&&a.status<300&&a.responseText.length>0)try{let t=JSON.parse(a.response);e({data:t})}catch(i){e({data:a.response})}else a.status>0&&o({code:a.status,message:`request failed, readyState:${a.readyState} status:${a.status} loaded size:${t.loaded}`})};const r=e=>{o({code:a.readyState,message:`request ${e.type}, readyState:${a.readyState} status:${a.status} loaded size:${e.loaded}`})};a.onerror=r,a.onabort=r,a.ontimeout=r,a.timeout=n||5e3,a.open(s||"POST",t,!0),a.send(i)}))}var ki="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Oi={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function s(){}function n(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function a(e,t,s,a,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var r=new n(s,a||e,o),d=i?i+t:t;return e._events[d]?e._events[d].fn?e._events[d]=[e._events[d],r]:e._events[d].push(r):(e._events[d]=r,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function r(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),r.prototype.eventNames=function(){var e,s,n=[];if(0===this._eventsCount)return n;for(s in e=this._events)t.call(e,s)&&n.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},r.prototype.listeners=function(e){var t=i?i+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var n=0,a=s.length,o=new Array(a);n<a;n++)o[n]=s[n].fn;return o},r.prototype.listenerCount=function(e){var t=i?i+e:e,s=this._events[t];return s?s.fn?1:s.length:0},r.prototype.emit=function(e,t,s,n,a,o){var r=i?i+e:e;if(!this._events[r])return!1;var d,c,l=this._events[r],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,s),!0;case 4:return l.fn.call(l.context,t,s,n),!0;case 5:return l.fn.call(l.context,t,s,n,a),!0;case 6:return l.fn.call(l.context,t,s,n,a,o),!0}for(c=1,d=new Array(h-1);c<h;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var u,_=l.length;for(c=0;c<_;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),h){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,s);break;case 4:l[c].fn.call(l[c].context,t,s,n);break;default:if(!d)for(u=1,d=new Array(h-1);u<h;u++)d[u-1]=arguments[u];l[c].fn.apply(l[c].context,d)}}return!0},r.prototype.on=function(e,t,i){return a(this,e,t,i,!1)},r.prototype.once=function(e,t,i){return a(this,e,t,i,!0)},r.prototype.removeListener=function(e,t,s,n){var a=i?i+e:e;if(!this._events[a])return this;if(!t)return o(this,a),this;var r=this._events[a];if(r.fn)r.fn!==t||n&&!r.once||s&&r.context!==s||o(this,a);else{for(var d=0,c=[],l=r.length;d<l;d++)(r[d].fn!==t||n&&!r[d].once||s&&r[d].context!==s)&&c.push(r[d]);c.length?this._events[a]=1===c.length?c[0]:c:o(this,a)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new s,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=i,r.EventEmitter=r,e.exports=r}(Oi);var Li=Oi.exports;const Pi=new Li,Mi=1,Ui=2,Vi=3,xi=4,$i=5,Fi=20,Bi=21,Hi=22,Gi=23,Wi=24,ji=27,Ji=28,Ki=29,zi=30,Yi=31,Xi=32,qi=33,Qi=40,Zi=41,es=52,ts=100,is=101,ss=102,ns=103,as=110,os=111,rs=112,ds=113,cs=114,ls=115,hs=116,us=120,_s=121,ms=122,ps=123,gs=130,Is=131,Ss=132,Es=133,Ts=134,fs=135,As=136,vs=137,ys=200,Rs=201,bs=300,Ds=301,Cs=302,Ns=303,ws=0,ks=1,Os=2;function Ls({retryFunction:e,settings:t,onError:i,onRetrying:s,onRetryFailed:n,onRetrySuccess:a,context:o}){return function(...r){const d=t.retries||5;let c=0,l=-1,h=ws;const u=async(_,m)=>{const p=o||this;try{const t=await e.apply(p,r);0!==c&&ci(a)&&a.call(p,c),c=0,_(t)}catch(g){const e=()=>{clearTimeout(l),c=0,h=Os,m(g)},a=()=>{h!==Os&&c<d?(c++,h=ks,ci(s)&&s.call(p,c,e),l=setTimeout((()=>{l=-1,u(_,m)}),li(t.timeout)?1e3:t.timeout)):(e(),ci(n)&&n.call(p,g))};ci(i)?i.call(p,g,a,m,r,c):a()}};return new Promise(u)}}class Ps{constructor(e){this.log=e.log,this.level=e.level,this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.forAllJoinedClients=e.forAllJoinedClients,this.uploaded=!1}}class Ms{constructor(e){this.id_=e.id,this.userId_=e.userId,this.sdkAppId_=e.sdkAppId,this.type_=e.type,this.isLocal_=!_i(e.isLocal)||e.isLocal}setUserId(e){this.userId_=e}setSdkAppId(e){this.sdkAppId_=e}log(e,t){Vs.log({log:`[${this.isLocal_?"↑":"↓"}${this.id_}] ${this.type_?this.type_+" ":""}${t}`,level:e,forAllJoinedClients:li(this.userId_),userId:this.userId_,sdkAppId:this.sdkAppId_})}info(e){this.log(Re.INFO,e)}debug(e){this.log(Re.DEBUG,e)}warn(e){this.log(Re.WARN,e)}error(e){this.log(Re.ERROR,e)}}const Us=!(Ke||ze);var Vs=new class{constructor(){this.clients_=new Set,this.queue_=[],this.timeoutId_=-1,this.logLevel_=Re.DEBUG,this.logLevelToUpload_=Re.INFO,this.enableUploadLog_=!0,this.isAbleToUpload_=!1,this.checkURLParam(),Pi.on(zi,(({client:e})=>{-1===this.timeoutId_&&this.startUpload(),this.clients_.add(e)})),Pi.on(qi,(({client:e})=>this.clients_.delete(e))),Pi.on(Yi,(e=>{e&&oi(e.config)&&we[e.config.logLevelToUpload]&&(this.logLevelToUpload_=e.config.logLevelToUpload)})),Pi.on(xi,this.setIsAbleToUpload,this),Pi.on($i,this.setIsAbleToUpload,this)}getIsAbleToUpload(){return this.isAbleToUpload_}setIsAbleToUpload(){this.isAbleToUpload_=!0,Pi.off(xi,this.setIsAbleToUpload,this),Pi.off($i,this.setIsAbleToUpload,this)}async startUpload(){try{await this.upload()}catch(e){}this.timeoutId_=setTimeout((()=>this.startUpload()),2e3)}getLogsToUpload(){const e={map:new Map,splicedQueue:[]};if(this.queue_[0].forAllJoinedClients&&0===this.clients_.size)return e;let t=0;for(;t<this.queue_.length&&50!==t;t++){const i=this.queue_[t];if(i.forAllJoinedClients)this.clients_.forEach((t=>{if(!t.getIsJoined())return;const s=t.getUserId(),n=t.getSDKAppId();if(e.map.has(s)){const{logs:t}=e.map.get(s);t.push(i)}else e.map.set(s,{userId:s,sdkAppId:n,logs:[i]})}));else if(e.map.has(i.userId)){const{logs:t}=e.map.get(i.userId);t.push(i)}else e.map.set(i.userId,{userId:i.userId,sdkAppId:i.sdkAppId,logs:[i]})}return e.map.size>0&&(e.splicedQueue=this.queue_.splice(0,t)),e}async upload(){if(0===this.queue_.length||!this.isAbleToUpload_)return;const{map:e,splicedQueue:i}=this.getLogsToUpload();if(0===e.size)return;try{const i=[...e.values()];for(let e=0;e<i.length;e++){const{userId:s,sdkAppId:n,logs:o}=i[e];await this.uploadLogWithRetry(JSON.stringify({timestamp:a(),sdkAppId:String(n),userId:s,version:t,log:o.map((e=>e.log)).join("\n")}),n),o.forEach((e=>e.uploaded=!0))}}catch(n){}const s=i.filter((e=>!e.uploaded));s.length>0&&(this.queue_=s.concat(this.queue_))}uploadLogWithRetry(e,t){return Ls({retryFunction:()=>wi({url:ni(t,_),body:e,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(e,t)=>{t()}})()}getPrefix(e){const t=new Date;return t.setTime(n()),String.prototype.padStart?`[${t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${t.getMilliseconds().toString().padStart(3,"0")}] <${we[e]}>`:`[${t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${t.getMilliseconds()}] <${we[e]}>`}getLogLevel(){return this.logLevel_}setLogLevel(e){li(we[e])||(this.logLevel_!==e&&this.info(`setLogLevel ${e}`),this.logLevel_=e)}enableUploadLog(){this.enableUploadLog_=!0}disableUploadLog(){this.enableUploadLog_=!1}log({log:e,level:t,forAllJoinedClients:i=!0,userId:s,sdkAppId:n}){if(e=`${this.getPrefix(t)} ${e}`,this.enableUploadLog_&&t>=this.logLevelToUpload_&&this.queue_.push(new Ps({log:e,level:t,userId:s,sdkAppId:n,forAllJoinedClients:i})),t<this.logLevel_)return;let a=we[t]?we[t].toLowerCase():"info";Us?console[a]("%cTRTC%c%s","padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;","display: inline",e):console[a](e)}debug(e){this.log({log:e,level:Re.DEBUG})}info(e){this.log({log:e,level:Re.INFO})}warn(e){this.log({log:e,level:Re.WARN})}error(e){this.log({log:e,level:Re.ERROR})}createLogger(e){return new Ms(e)}checkURLParam(){const e=new URLSearchParams(location.search).get("logLevelToUpload");we[e]&&(this.logLevelToUpload_=e)}};let xs=!0;const $s=1,Fs=5,Bs=2,Hs=3,Gs=4,Ws="DISCONNECTED",js="CONNECTING",Js="RECONNECTING",Ks="CONNECTED",zs={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772},Ys=[zs.UPDATE_REMOTE_MUTE_STAT,zs.UPLINK_NETWORK_STATS,zs.USER_LIST_RES,zs.MUTE_RESULT],Xs={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res"},qs="publish_change",Qs="publish_state_change",Zs="join",en="leave",tn="quality_report",sn="mute_uplink",nn="publish",an="unpublish",on="subscribe",rn="unsubscribe",dn="subscribe_change",cn="start_publishing",ln="stop_publishing",hn="start_push_user_cdn",un="stop_push_user_cdn",_n="start_mcu_mix",mn="stop_mcu_mix",pn="get_user_list",gn="change_role",In="update_constraint_config",Sn={INVALID_PARAMETER:4096,INVALID_OPERATION:4097,NOT_SUPPORTED:4098,DEVICE_NOT_FOUND:4099,INITIALIZE_FAILED:4100,SIGNAL_CHANNEL_SETUP_FAILED:16385,SIGNAL_CHANNEL_ERROR:16386,ICE_TRANSPORT_ERROR:16387,JOIN_ROOM_FAILED:16388,CREATE_OFFER_FAILED:16389,SIGNAL_CHANNEL_RECONNECTION_FAILED:16390,UPLINK_RECONNECTION_FAILED:16391,DOWNLINK_RECONNECTION_FAILED:16392,REMOTE_STREAM_NOT_EXIST:16400,CLIENT_BANNED:16448,SERVER_TIMEOUT:16449,SUBSCRIPTION_TIMEOUT:16450,PLAY_NOT_ALLOWED:16451,DEVICE_AUTO_RECOVER_FAILED:16452,START_PUBLISH_CDN_FAILED:16453,STOP_PUBLISH_CDN_FAILED:16454,START_MIX_TRANSCODE_FAILED:16455,STOP_MIX_TRANSCODE_FAILED:16456,NOT_SUPPORTED_H264:16457,SWITCH_ROLE_FAILED:16458,API_CALL_TIMEOUT:16459,SCHEDULE_FAILED:16460,API_CALL_ABORTED:16461,UNKNOWN:65535};class En extends Error{constructor({name:e="RtcError",message:t,code:i=Sn.UNKNOWN,extraCode:s=0,constraint:n}){const a=`<${function(e){for(let t in Sn)if(Sn[t]===e)return t;return"UNKNOWN"}(i)} 0x${i.toString(16)}>`;super(t+""+(n?` constraint: ${n}`:"")+(null!=t&&t.includes(a)?"":" "+a)),this.code_=i,this.extraCode_=s,this.name=e,this.message_=t,n&&(this.constraint=n)}getCode(){return this.code_}getExtraCode(){return this.extraCode_}}const Tn=32768,fn=32769,An=32770,vn=32771,yn=32772,Rn=32773,bn=32774,Dn=32775,Cn=32777,Nn=32778,wn=32779,kn=32780,On=32781,Ln=32782,Pn=32783,Mn=32784,Un=32785,Vn=32786,xn=32787,$n=32788,Fn=32789,Bn=32790,Hn=32791,Gn=32792,Wn=32793,jn=32794,Jn=32795,Kn=32796,zn=32797,Yn=32798,Xn=32799,qn=32800,Qn=32801,Zn=32802,ea=32803,ta=32804,ia=new Map,sa=function(e,t){let i=ia.get(e);i||(ia.set(e,[]),i=ia.get(e)),i.push(t)};var na=Object.prototype.hasOwnProperty;function aa(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(oi(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(var t in e)if(na.call(e,t))return!1;return!0}return!1}var oa=new class{constructor(){const{name:e,version:i}=qt();this.roomIdMap_=new Map,this.configs_={sdkAppId:"",userId:"",version:t,env:c,browserVersion:e+i,ua:navigator.userAgent}}setConfig({sdkAppId:e,env:t,userId:i,roomId:s}){e!==this.configs_.sdkAppId&&(this.configs_.sdkAppId=String(e)),this.configs_.env=t,this.configs_.userId=i,this.roomIdMap_.set(i,String(s))}logEvent(e){if(zt)return;const t={...e,...this.configs_,userId:e.userId||this.configs_.userId};li(t.code)&&(t.code="failed"===t.result?Sn.UNKNOWN:0),this.sendRequest(ni(this.configs_.sdkAppId,m),t)}logSuccessEvent(e){zt||(this.logEvent({...e,result:"success",roomId:this.roomIdMap_.get(e.userId)}),this.configs_.env===c&&this.uploadEventToKibana({...e,result:"success"}))}logFailedEvent(e){if(zt)return;const{eventType:t,code:i,error:s,userId:n}=e,a={roomId:this.roomIdMap_.get(n),userId:n,eventType:t,result:"failed",code:i||(s instanceof En?s.getExtraCode()||s.getCode():Sn.UNKNOWN)};this.logEvent(a),this.configs_.env===c&&this.uploadEventToKibana({...a,error:s})}uploadEventToKibana(e){let t=`stat-${e.eventType}-${e.result}`;"delta-join"!==e.eventType&&"delta-leave"!==e.eventType&&"delta-publish"!==e.eventType||(t=`${e.eventType}:${e.delta}`),this.uploadEvent({log:t,userId:e.userId}),"failed"===e.result&&(t=`stat-${e.eventType}-${e.result}-${e.code}`,this.uploadEvent({log:t,userId:e.userId,error:e.error}))}uploadEvent({log:e,userId:t,error:i}){const s={timestamp:a(),sdkAppId:this.configs_.sdkAppId,userId:t||this.configs_.userId,version:this.configs_.version,log:e};i&&(s.errorInfo=i.message),this.sendRequest(ni(this.configs_.sdkAppId,_),s)}sendRequest(e,t){Vs.getIsAbleToUpload()?wi({url:e,body:JSON.stringify(t)}).catch((()=>{})):setTimeout((()=>{this.sendRequest(e,t)}),1e3)}};class ra{constructor(e){this.client_=e.client,this.sdkAppId_=e.sdkAppId,this.userId_=e.userId,this.userSig_=e.userSig,this.url_=e.url,this.backupUrl_=e.backupUrl;let t=`?sdkAppId=${encodeURIComponent(this.sdkAppId_)}&userId=${encodeURIComponent(this.userId_)}&userSig=${encodeURIComponent(this.userSig_)}&roomId=${encodeURIComponent(e.roomId)}`;const i=this.client_.getSystemResult();if(i&&i.detail){const{isH264EncodeSupported:e,isVp8EncodeSupported:s,isH264DecodeSupported:n,isVp8DecodeSupported:a}=i.detail;t+=`&enc264=${Number(e)}&dec264=${Number(n)}&encVp8=${Number(s)}&decVp8=${Number(a)}`}e.signalDomainWhenUnifiedProxy&&(t+=`&signalDomain=${encodeURIComponent(e.signalDomainWhenUnifiedProxy)}`),this.urlWithParam_=`${this.url_}${t}`,this.backupUrlWithParam_=`${this.backupUrl_}${t}`,this.isConnected_=!1,this.isConnecting_=!1,this.socketInUse_=null,this.socket_=null,this.backupSocket_=null,this.backupTimer_=-1,this.signalInfo_={},this.currentState_=Ws,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.lastMessageTime_=-1,this.seq_=0,this.log_=Vs.createLogger({id:"ws|"+this.userId_,userId:this.userId_,sdkAppId:this.sdkAppId_}),this.emitter_=new Li}get isOnline(){return this.currentState_===Ks&&Date.now()-this.lastMessageTime_<12e3}connect(){return new Promise(((e,t)=>{this.log_.info(`connect to url: ${this.urlWithParam_}`),this.emitConnectionStateChanged(js),this.socket_=new WebSocket(this.urlWithParam_),this.bindSocket(this.socket_),this.backupTimer_=setTimeout((()=>{this.isConnected_||(this.log_.info("trying to connect to backupUrl"),this.tryConnectBackup())}),5e3);const i=setTimeout((()=>{this.close(),t(new En({code:Sn.JOIN_ROOM_FAILED,message:"join room timeout"}))}),1e4);this.once(Hs,(()=>{clearTimeout(i),e()})),this.once(Gs,(e=>{clearTimeout(i),t(e)}))}))}tryConnectBackup(){this.backupSocket_||(this.unbindAndCloseSocket(o.MAIN),this.log_.debug(`try to connect to url: ${this.backupUrlWithParam_}`),this.backupSocket_=new WebSocket(this.backupUrlWithParam_),this.bindSocket(this.backupSocket_))}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}unbindAndCloseSocket(e){if(e===o.MAIN){if(this.socket_){this.unbindSocket(this.socket_);try{this.socket_.close(1e3)}catch(t){}this.socket_=null}}else if(this.backupSocket_){this.unbindSocket(this.backupSocket_);try{this.backupSocket_.close(1e3)}catch(t){}this.backupSocket_=null}}clearBackupTimer(){-1!==this.backupTimer_&&(clearTimeout(this.backupTimer_),this.backupTimer_=-1)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1,this.isReconnecting_&&aa(this.signalInfo_)&&this.stopReconnection(),this.clearBackupTimer(),e.target===this.socket_?(this.unbindAndCloseSocket(o.BACKUP),this.socketInUse_=this.socket_):(this.unbindAndCloseSocket(o.MAIN),this.socketInUse_=this.backupSocket_);const t=e.target.url;this.log_.info(`websocket[${t}] is connected`),this.currentState_===js?this.addSignalEvent(Hn,"signal channel is connected"):this.currentState_===Js&&this.addSignalEvent(Jn,"signal channel reconnect success"),this.emitConnectionStateChanged(Ks),this.emitter_.emit(Hs)}onclose(e){const t=e.target.url,i=e.target===this.socketInUse_;if(this.log_.info(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),i&&(this.isConnected_=!1,this.emitConnectionStateChanged(Ws),this.addSignalEvent(Bn,"signal channel is disconnected"),!e.wasClean||1e3!==e.code)){this.log_.warn(`onclose code:${e.code} reason:${e.reason}`),this.log_.warn("close current websocket and schedule a reconnect timeout"),this.socketInUse_.onclose=()=>{},this.socketInUse_.close(4011);const t=this.socketInUse_===this.socket_;this.socket_=this.backupSocket_=this.socketInUse_=null,this.reconnect(t?o.BACKUP:o.MAIN)}}onerror(e){const t=e.target.url;if(this.log_.error(`websocket[${t}] error observed`),this.isConnected_){if(e.target===this.socketInUse_){this.isConnected_=!1,this.unbindAndCloseSocket(o.MAIN),this.unbindAndCloseSocket(o.BACKUP);const e=this.socketInUse_===this.socket_;this.socketInUse_=null,this.reconnect(e?o.BACKUP:o.MAIN)}}else this.isReconnecting_||oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.SIGNAL_CONNECTION,code:Sn.UNKNOWN}),e.target==this.socket_?(this.unbindAndCloseSocket(o.MAIN),this.reconnect(o.BACKUP)):(this.unbindAndCloseSocket(o.BACKUP),this.reconnect(o.MAIN));this.isConnecting_=!1,this.isConnected_=!1}onmessage(e){if(!this.isConnected_)return;this.lastMessageTime_=Date.now();const t=JSON.parse(e.data),{cmd:n,data:a}=t,o=Object.values(zs),r=Object.keys(zs)[o.indexOf(n)],d=Xs[r];switch(Ys.includes(n)||(this.log_.debug(`received msg: ${e.data}`),this.log_.info(`Received event: [ ${d||"unknown cmd: "+n} ]`)),n){case zs.CHANNEL_SETUP_RESULT:if(0===t.code)this.signalInfo_.clientIp=a.clientIp,this.signalInfo_.signalIp=a.signalInnerIp,this.signalInfo_.tinyId=t.tinyId,a.svrTime&&function(e){i=e,s=i-(new Date).getTime();const t=new Date;t.setTime(e),Vs.info("baseTime from server: "+t+" offset: "+s)}(a.svrTime),this.log_.info("ChannelSetup Success"),oa.logSuccessEvent({userId:this.userId_,eventType:B.SIGNAL_CONNECTION}),this.emitter_.emit($s,{signalInfo:this.signalInfo_});else{const e=new En({code:Sn.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:t.code,message:ti({key:$e.SIGNAL_CHANNEL_SETUP_FAILED,data:{errorCode:t.code,errorMsg:t.message}})});this.log_.error(`${t.code}, ${t.message}`),this.close(),oa.logFailedEvent({userId:this.userId_,eventType:B.SIGNAL_CONNECTION,error:e}),this.emitter_.emit(Fs,e)}break;case zs.JOIN_ROOM_RESULT:0===t.code&&(this.signalInfo_.relayIp=a.relayOuterIp,this.signalInfo_.relayInnerIp=a.relayInnerIp,this.signalInfo_.relayPort=a.relayPort,this.log_.info(`signalIp:${this.signalInfo_.signalIp} clientIp:${this.signalInfo_.clientIp} relayIp: ${this.signalInfo_.relayIp}`)),this.emitter_.emit(d,{data:t});break;case zs.CHANNEL_RECONNECT_RESULT:0===t.code?(this.log_.warn("reconnect success"),this.stopReconnection(),oa.logSuccessEvent({userId:this.userId_,eventType:B.SIGNAL_RECONNECTION}),this.client_.syncUserList(),this.client_.checkConnectionsToReconnect()):(this.log_.warn(`reconnect failed, ${t.code} ${t.message}`),this.client_.reJoin());break;default:this.emitter_.emit(d,{data:t})}}addSignalEvent(e,t){sa(this.userId_,{eventId:e,eventDesc:t,timestamp:n(),userId:this.userId_,tinyId:this.signalInfo_.tinyId})}reconnect(e=o.MAIN){if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.log_.info("signal channel is reconnecting, ignoring current reconnection");if(Pi.emit(Qi,this.client_),this.reconnectionCount_>=30){this.log_.warn("SDK has tried reconnect signal channel for 30 times, but all failed. please check your network");const e=new En({code:Sn.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:ti({key:$e.SIGNAL_CHANNEL_RECONNECTION_FAILED})});return oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.SIGNAL_RECONNECTION,error:e}),this.addSignalEvent(Kn,"signal channel reconnect fail"),void this.emitter_.emit(Gs,e)}this.isConnecting_=!0,this.reconnectionCount_++,this.currentState_!==Js&&(this.emitConnectionStateChanged(Js),this.addSignalEvent(jn,"signal channel is reconnecting")),this.log_.warn(`reconnecting to ${e} signal channel [${this.reconnectionCount_}/30]`);const t=this.getReconnectionUrl(e);e===o.MAIN?(this.socket_=new WebSocket(t),this.bindSocket(this.socket_)):(this.backupSocket_=new WebSocket(t),this.bindSocket(this.backupSocket_));const i=di(this.reconnectionCount_);this.reconnectionTimer_=setTimeout((()=>{this.log_.warn(`reconnect ${e} signal channel timeout(${i/1e3}s), close and try again`),this.isConnecting_=!1,this.clearReconnectionTimer(),this.unbindAndCloseSocket(e),this.reconnect(e===o.MAIN?o.BACKUP:o.MAIN)}),i)}isConnected(){return this.isConnected_}get isReconnecting_(){return-1!==this.reconnectionTimer_}getReconnectionUrl(e){let t=e===o.MAIN?this.urlWithParam_:this.backupUrlWithParam_;if(!aa(this.signalInfo_)&&-1===t.indexOf("&rc=1")){const e=this.client_.getRoomId(),i=this.client_.getUseStringRoomId();t+=`&rc=1&relayInnerIp=${this.signalInfo_.relayInnerIp}&relayOuterIp=${this.signalInfo_.relayIp}&relayPort=${this.signalInfo_.relayPort}&roomId=${e}&useStringRoomId=${i}`}return t}send(e,t={}){if(this.isConnected_){const i={cmd:e,data:t,userId:this.userId_,tinyId:this.signalInfo_.tinyId,seq:++this.seq_};return this.socketInUse_.send(JSON.stringify(i)),i.seq}}sendWaitForResponse({command:e,data:t,timeout:i=5e3,responseCommand:s,commandDesc:n,enableLog:a=!0}){return new Promise(((o,r)=>{const d=setTimeout((()=>{this.off(s,c);const t=new En({code:Sn.API_CALL_TIMEOUT,message:ti({key:$e.API_CALL_TIMEOUT,data:{commandDesc:n,command:e}})});a&&this.log_.warn(t),r(t)}),i),c=e=>{e.data.seq===l&&(clearTimeout(d),this.off(s,c),o(e))};this.on(s,c);const l=this.send(e,t)}))}sendWaitForResponseWithRetry(...e){const{commandDesc:t,command:i,retries:s=0,retryTimeout:n=0}=e[0];return Ls({retryFunction:this.sendWaitForResponse,onRetrying:e=>{this.log_.warn(`${t||i} timeout observed, retrying [${e}/${s}]`)},settings:{retries:s,timeout:n},context:this})(...e)}getCurrentState(){return this.currentState_}getSignalInfo(){return this.signalInfo_}stopReconnection(){this.isReconnecting_&&(this.reconnectionCount_=0,this.clearReconnectionTimer())}close(){this.log_.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this.signalInfo_={},this.isConnecting_=!1,this.isConnected_=!1,this.socketInUse_=null,this.unbindAndCloseSocket(o.MAIN),this.unbindAndCloseSocket(o.BACKUP),this.emitConnectionStateChanged(Ws)}on(e,t,i){this.emitter_.on(e,t,i)}removeListener(e,t,i){this.emitter_.removeListener(e,t,i)}once(e,t,i){this.emitter_.once(e,t,i)}off(e,t,i){this.emitter_.off(e,t,i)}emitConnectionStateChanged(e){e!==this.currentState_&&(this.emitter_.emit(Bs,{prevState:this.currentState_,state:e}),this.currentState_=e)}}var da={},ca={},la={exports:{}},ha=la.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"invalid",names:["value"]}]};Object.keys(ha).forEach((function(e){ha[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))})),function(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,s){var n=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:n&&!i[e.name]&&(i[e.name]={});var a=e.push?{}:n?i[e.name]:i;!function(e,i,s,n){if(n&&!s)i[n]=t(e[1]);else for(var a=0;a<s.length;a+=1)null!=e[a+1]&&(i[s[a]]=t(e[a+1]))}(s.match(e.reg),a,e.names,e.name),e.push&&i[e.push].push(a)},s=la.exports,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},a=[],o=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(a.push({rtp:[],fmtp:[]}),o=a[a.length-1]);for(var r=0;r<(s[t]||[]).length;r+=1){var d=s[t][r];if(d.reg.test(n))return i(d,o,n)}})),t.media=a,t};var a=function(e,i){var s=i.split(/=(.+)/,2);return 2===s.length?e[s[0]]=t(s[1]):1===s.length&&i.length>1&&(e[s[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],s=e.split(" ").map(t),n=0;n<s.length;n+=3)i.push({component:s[n],ip:s[n+1],port:s[n+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,s=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),s=!0),{scid:i,paused:s}}))}))}}(ca);var ua=la.exports,_a=/%[sdv%]/g,ma=function(e){var t=1,i=arguments,s=i.length;return e.replace(_a,(function(e){if(t>=s)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},pa=function(e,t,i){var s=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1){var a=t.names[n];t.name?s.push(i[t.name][a]):s.push(i[t.names[n]])}else s.push(i[t.name]);return ma.apply(null,s)},ga=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Ia=["i","c","b","a"],Sa=ca,Ea=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||ga,s=t.innerOrder||Ia,n=[];return i.forEach((function(t){ua[t].forEach((function(i){i.name in e&&null!=e[i.name]?n.push(pa(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){n.push(pa(t,i,e))}))}))})),e.media.forEach((function(e){n.push(pa("m",ua.m[0],e)),s.forEach((function(t){ua[t].forEach((function(i){i.name in e&&null!=e[i.name]?n.push(pa(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){n.push(pa(t,i,e))}))}))}))})),n.join("\r\n")+"\r\n"};da.write=Ea,da.parse=Sa.parse,da.parseFmtpConfig=Sa.parseFmtpConfig,da.parseParams=Sa.parseParams,da.parsePayloads=Sa.parsePayloads,da.parseRemoteCandidates=Sa.parseRemoteCandidates,da.parseImageAttributes=Sa.parseImageAttributes,da.parseSimulcastStreamList=Sa.parseSimulcastStreamList;const Ta=function(e){return da.parse(e)},fa=function(e){return da.write(e)};var Aa,va,ya,Ra;const ba=(null===(Aa=window)||void 0===Aa?void 0:Aa.requestIdleCallback)||function(e){let t=Date.now();return setTimeout((()=>{e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),1e3)},Da=(null===(va=window)||void 0===va?void 0:va.cancelIdleCallback)||function(e){clearTimeout(e)};let Ca=(null===(ya=window)||void 0===ya?void 0:ya.cancelAnimationFrame)||(null===(Ra=window)||void 0===Ra?void 0:Ra.mozCancelAnimationFrame);class Na{static taskMap=new Map;static currentTaskID=1;static generateTaskID(){return this.currentTaskID++}static run(e=Me,t,i){i="interval"===e?{delay:2e3,count:0,backgroundTask:!0,...i}:e===Le?{delay:1e4,count:0,...i}:e===Pe?{fps:60,delay:16.6,count:0,backgroundTask:!0,...i}:{delay:2e3,count:0,backgroundTask:!0,...i},mi(t)&&(i={...i,...t}),ci(e)&&(t=e,e=Me);let s={taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:e,callback:t,...i};return this.taskMap.set(s.taskID,s),this[e](s),s.taskID}static interval(e){return e.intervalID=setInterval((()=>{e.callback(),e.loopCount+=1,this.isBreakLoop(e)}),e.delay)}static timeout(e){const t=()=>{if(e.callback(),e.loopCount+=1,!this.isBreakLoop(e))return e.timeoutID=setTimeout(t,e.delay)};return e.timeoutID=setTimeout(t,e.delay)}static ric(e){let t,i=Ei();const s=()=>{if(t=Ei()-i,t>=e.delay&&(i=Ei()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),!this.isBreakLoop(e))return e.ricID=ba(s,{timeout:e.delay})};return e.ricID=ba(s,{timeout:e.delay})}static raf(e){e.delay=(1e3/e.fps).toFixed(2);let t,i=Ei();const s=()=>{if(document.hidden&&e.backgroundTask){if(t=Ei()-i,i=Ei(),e.callback(),e.loopCount+=1,this.isBreakLoop(e))return;return e.timeoutID=setTimeout(s,e.delay-Math.floor(t%e.delay))}if(t=Ei()-i,t>=e.delay&&(i=Ei()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),!this.isBreakLoop(e))return e.rafID=requestAnimationFrame(s)};if(e.rafID=requestAnimationFrame(s),e.backgroundTask){const t=()=>{if(document.hidden){let t=Ei()-i;t>=e.delay?s():e.timeoutID=setTimeout(s,e.delay-t)}};document.addEventListener("visibilitychange",t),e.onVisibilitychange=t,document.hidden&&t()}return e.taskID}static hasTask(e){return this.taskMap.has(e)}static clearTask(e){if(!this.taskMap.has(e))return!0;const{intervalID:t,timeoutID:i,rafID:s,ricID:n,onVisibilitychange:a}=this.taskMap.get(e);return t&&clearInterval(t),i&&clearTimeout(i),s&&Ca(s),n&&Da(n),a&&document.removeEventListener("visibilitychange",a),this.taskMap.delete(e),!0}static isBreakLoop(e){return!this.taskMap.has(e.taskID)||0!==e.count&&e.loopCount>=e.count&&(this.clearTask(e.taskID),!0)}}var wa=new class{constructor(){this.prefix_="TRTC",this.queue_=new Map,this.checkStorage()}getRealKey(e){return`${this.prefix_}_${e}`}checkStorage(){if(!Yt())return;Object.keys(localStorage).filter((e=>{if(e.startsWith(this.prefix_)){const t=JSON.parse(localStorage.getItem(e));if(t&&t.expiresIn<Date.now())return!0}return!1})).forEach((e=>localStorage.removeItem(e)))}doFlush(){if(Yt())try{for(const[e,t]of this.queue_)localStorage.setItem(e,JSON.stringify(t))}catch(e){Vs.warn(e)}}getItem(e){if(!Yt())return null;try{const t=JSON.parse(localStorage.getItem(this.getRealKey(e)));return t&&t.expiresIn>=Date.now()?t.value:null}catch(t){Vs.warn(t)}}setItem(e,t,i=!1){if(Yt())try{const s={expiresIn:Date.now()+re,value:t};i?localStorage.setItem(this.getRealKey(e),JSON.stringify(s)):(this.queue_.set(this.getRealKey(e),s),Na.hasTask(this.intervalId_)||(this.intervalId_=Na.run(Le,this.doFlush.bind(this),{count:1})))}catch(s){Vs.warn(s)}}deleteItem(e){if(!Yt())return!1;try{return e=this.getRealKey(e),this.queue_.delete(e),localStorage.removeItem(e),!0}catch(t){return Vs.warn(t),!1}}clear(){if(Yt())try{localStorage.clear()}catch(e){Vs.warn(e)}}};let ka={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isMediaDevicesSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}};const Oa="checkResult";const La=function(){return!vt&&!qe&&(!(Ze&&et<80)&&!(Ye&&Xe<56))},Pa=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((e=>e in window)).length>0},Ma=async function(){if(ka.detail.isH264EncodeSupported&&ka.detail.isVp8EncodeSupported)return{isH264EncodeSupported:ka.detail.isH264EncodeSupported,isVp8EncodeSupported:ka.detail.isVp8EncodeSupported};let e="",t=!1,i=!1;try{const s=new RTCPeerConnection,n=document.createElement(o.CANVAS);n.getContext("2d");const a=n.captureStream(0);return s.addTrack(a.getVideoTracks()[0],a),e=await s.createOffer(),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),s.close(),ka.detail.isH264EncodeSupported=t,ka.detail.isVp8EncodeSupported=i,{isH264EncodeSupported:ka.detail.isH264EncodeSupported,isVp8EncodeSupported:ka.detail.isVp8EncodeSupported}}catch(s){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}};const Ua=async function(){if(ka.detail.isH264DecodeSupported&&ka.detail.isVp8DecodeSupported)return{isH264DecodeSupported:ka.detail.isH264DecodeSupported,isVp8DecodeSupported:ka.detail.isVp8DecodeSupported};let e="",t=!1,i=!1;try{const s=new RTCPeerConnection;return e=await s.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),s.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:i}}catch(s){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}},Va=((e,t)=>{let i=null;return function(...s){return i||(i=e.apply(t||this,s),i.then((e=>(i=null,e))).catch((e=>{throw i=null,e})),i)}})((async function(){if(!xa())return ka;const e=La(),t=Pa(),i=function(){if(!navigator.mediaDevices)return!1;const e=["getUserMedia","enumerateDevices"];return e.filter((e=>e in navigator.mediaDevices)).length===e.length}();let{isH264EncodeSupported:s,isVp8EncodeSupported:n}=await Ma(),{isH264DecodeSupported:a,isVp8DecodeSupported:r}=await Ua();if(!s||!n){const e=await Ma();s=e.isH264EncodeSupported,n=e.isVp8EncodeSupported}if(s&&a&&(kt||Lt||Ht)&&!at&&Mt()<79){const{encode:e,decode:t}=await async function(){return new Promise((async e=>{const t={encode:!1,decode:!1};let i=null;try{const s=document.createElement("canvas"),n=s.getContext("2d");s.width=640,s.height=480;const a=setInterval((()=>{n.fillText("test",Math.floor(640*Math.random()),Math.floor(480*Math.random()))}),33);let r=-1,d=-1;i=()=>{clearInterval(r),clearInterval(a),clearTimeout(d),l.close(),h.close(),c.getTracks().forEach((e=>e.stop()))},d=setTimeout((()=>{i(),e(t)}),3e3);const c=s.captureStream(),l=new RTCPeerConnection({}),h=new RTCPeerConnection({offerToReceiveAudio:!0,offerToReceiveVideo:!0});l.addEventListener("icecandidate",(e=>h.addIceCandidate(e.candidate))),h.addEventListener("icecandidate",(e=>l.addIceCandidate(e.candidate))),l.addTrack(c.getVideoTracks()[0],c);const u=await l.createOffer();await l.setLocalDescription(u),await h.setRemoteDescription(u);const _=await h.createAnswer(),m=Ta(_.sdp),p=m.media[0].rtp.findIndex((e=>"H264"===e.codec));m.media[0].rtp=[m.media[0].rtp[p]],m.media[0].fmtp=m.media[0].fmtp.filter((e=>e.payload===m.media[0].rtp[0].payload)),m.media[0].rtcpFb=m.media[0].rtcpFb.filter((e=>e.payload===m.media[0].rtp[0].payload)),_.sdp=fa(m),await h.setLocalDescription(_),await l.setRemoteDescription(_),r=setInterval((async()=>{t.encode&&t.decode&&(i(),e(t));const s=await l.getStats(),n=await h.getStats();t.encode||s.forEach((e=>{"outbound-rtp"===e.type&&e.mediaType===o.VIDEO&&e.framesEncoded>0&&(t.encode=!0)})),t.decode||n.forEach((e=>{"inbound-rtp"===e.type&&e.mediaType===o.VIDEO&&e.framesDecoded>0&&(t.decode=!0)}))}),500)}catch(s){i(),Vs.warn(s),e(t)}}))}();s=e,a=t}return ka.result=e&&t&&i&&(s||n)&&(a||r),ka.detail.isBrowserSupported=e,ka.detail.isWebRTCSupported=t,ka.detail.isMediaDevicesSupported=i,ka.detail.isH264EncodeSupported=s,ka.detail.isVp8EncodeSupported=n,ka.detail.isH264DecodeSupported=a,ka.detail.isVp8DecodeSupported=r,xa()&&(Vs.warn(ti({key:$e.NOT_SUPPORTED_WEBRTC})),Vs.info(`${navigator.userAgent} ${JSON.stringify(ka.detail)}`)),wa.setItem(Oa,{ua:navigator.userAgent,checkResult:ka},!0),ka}));function xa(){return Object.keys(ka.detail).findIndex((e=>!ka.detail[e]))>=0}function $a(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)}function Fa(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function Ba(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function Ha(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function Ga(){return"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype}function Wa(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}function ja(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&Ba()}function Ja(){return!!li(navigator.mediaDevices)&&(Vs.error(Fe.NOT_SUPPORTED_MEDIA),!0)}function Ka(){return"http:"===location.protocol&&!zt&&(Vs.warn(ti({key:$e.NOT_SUPPORTED_HTTP})),!0)}const za="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&Mt()>=86;function Ya(e){return!("candidate-pair"!==e.type||!e.nominated||"in-progress"!==e.state&&"succeeded"!==e.state)&&!(_i(e.selected)&&!e.selected)}let Xa=new Map([[ze,"Android"],[Ke,"iOS"],[Tt,"Windows"],[ft,"MacOS"],[At,"Linux"]]);function qa(){let e="unknown";return Xa.get(!0)&&(e=Xa.get(!0)),e}function Qa(){let e="";if(screen.width){e+=(screen.width?screen.width*window.devicePixelRatio:"")+" * "+(screen.height?screen.height*window.devicePixelRatio:"")}return e}function Za(){let e=!1;return(navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(e=!0),e}function eo(){let e={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let i=0;i<t.length;i++)if(t[i]in window){e.isSupported=!0;break}return e.isSupported}function to(){return!(ct&&Mt()<86)&&(!(Ke&&ui(Gt)&&Gt<15)&&(!(xt&&xt<63)&&!(!La()||!("captureStream"in HTMLCanvasElement.prototype))))}function io(){const e={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return li(window.AudioDecoder)||(e.AudioDecoder=!0),li(window.AudioEncoder)||(e.AudioEncoder=!0),li(window.VideoDecoder)||(e.VideoDecoder=!0),li(window.VideoEncoder)||(e.VideoEncoder=!0),li(window.ImageDecoder)||(e.ImageDecoder=!0),e}const so=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,no=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype;!function(){Ka();const e=wa.getItem(Oa);e&&e.ua===navigator.userAgent&&(ka=e.checkResult),Va()}();const ao={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_PUBLISHED:"stream-published",STREAM_SUBSCRIBED:"stream-subscribed",STREAM_UNSUBSCRIBED:"stream-unsubscribed",STATE_CHANGED:"state-changed",ERROR:"error",CONNECTION_STATE_CHANGED:"connection-state-changed",SEI_MESSAGE:o.SEI_MESSAGE},oo={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_SUBSCRIBED:"stream-subscribed",CONNECTION_STATE_CHANGED:"connection-state-changed",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",MUTE_AUDIO:"mute-audio",MUTE_VIDEO:"mute-video",UNMUTE_AUDIO:"unmute-audio",UNMUTE_VIDEO:"unmute-video",CLIENT_BANNED:"client-banned",NETWORK_QUALITY:"network-quality",AUDIO_VOLUME:"audio-volume",SEI_MESSAGE:o.SEI_MESSAGE,ERROR:"error"},ro="player-state-changed",co="screen-sharing-stopped",lo="connection-state-changed",ho="device-auto-recovered",uo="error",_o="player-state-changed";class mo{constructor(e){const t=e.getUserId();this.log_=Vs.createLogger({id:t,userId:t,sdkAppId:e.getSDKAppId()}),this.prevReportTime_=0,this.prevReport_={},this.prevEncoderImplementation_="",this.prevQualityLimitationReason_="",this.prevDecoderImplementationMap_=new Map}get statInterval(){return 0===this.prevReportTime_?2:(Date.now()-this.prevReportTime_)/1e3}async getSenderStats(e){const t={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},i=e.getPeerConnection(),s=e.getSSRC();if(i)try{var n;if((await i.getStats()).forEach((i=>{if("outbound-rtp"===i.type)if(i.mediaType===o.VIDEO){if(!Ye&&0===i.bytesSent)return;i.ssrc!==s.video||li(i.encoderImplementation)||this.prevEncoderImplementation_===i.encoderImplementation||(this.log_.info(`encoderImplementation change to ${i.encoderImplementation}`),this.prevEncoderImplementation_=i.encoderImplementation),i.ssrc!==s.video||li(i.qualityLimitationReason)||this.prevQualityLimitationReason_===i.qualityLimitationReason||(this.log_.info(`qualityLimitationReason change to ${i.qualityLimitationReason}`),this.prevQualityLimitationReason_=i.qualityLimitationReason);let e=o.VIDEO;i.ssrc===s.small?e=o.SMALL:i.ssrc===s.auxiliary&&(e=o.AUXILIARY),t[e].bytesSent=i.bytesSent,t[e].packetsSent=i.packetsSent,t[e].framesEncoded=i.framesEncoded}else i.mediaType===o.AUDIO&&(t.audio.bytesSent=i.bytesSent,t.audio.packetsSent=i.packetsSent);else"candidate-pair"===i.type?Ya(i)&&ui(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime)):"media-source"===i.type&&(i.kind===o.AUDIO?(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0):i.kind===o.VIDEO&&(i.trackIdentifier===e.getVideoTrackId(o.VIDEO)?t.video.fpsCapture=i.framesPerSecond:i.trackIdentifier===e.getVideoTrackId(o.AUXILIARY)?t.auxiliary.fpsCapture=i.framesPerSecond:t.small.fpsCapture=i.framesPerSecond));if(li(i.audioLevel)||(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0),!li(i.frameWidth)){let n;i.trackIdentifier===e.getVideoTrackId(o.VIDEO)||i.ssrc===s.video?n=o.VIDEO:i.trackIdentifier===e.getVideoTrackId(o.AUXILIARY)||i.ssrc===s.auxiliary?n=o.AUXILIARY:i.trackIdentifier!==e.getVideoTrackId(o.SMALL)&&i.ssrc!==s.small||(n=o.SMALL),n&&(t[n].frameWidth=i.frameWidth,t[n].frameHeight=i.frameHeight,t[n].framesSent=i.framesSent)}})),0===t.audio.audioLevel)t.audio.audioLevel=(null===(n=e.getLocalStream())||void 0===n?void 0:n.getInternalAudioLevel())||0}catch(a){this.log_.warn("failed to getStats on sender connection "+a)}return t}async getReceiverStats(e){const t={tinyId:e.getTinyId(),userId:e.getUserId(),rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0}},i=e.getPeerConnection();if(i)try{const n=e.getSSRC(),a=e.getTrackState();var s;if((await i.getStats()).forEach((i=>{if("inbound-rtp"===i.type){if(i.mediaType===o.AUDIO&&i.ssrc===n.audio&&a.audio)t.audio.packetsReceived=i.packetsReceived,t.audio.bytesReceived=i.bytesReceived,t.audio.packetsLost=i.packetsLost,t.audio.jitter=i.jitter,t.hasAudio=!0;else if(i.mediaType===o.VIDEO){if(Ye&&0===i.bytesReceived)return;i.ssrc===n.video&&a.video&&(t.video.packetsReceived=i.packetsReceived,t.video.bytesReceived=i.bytesReceived,t.video.packetsLost=i.packetsLost,t.video.framesReceived=i.framesReceived,t.video.framesDecoded=i.framesDecoded,t.video.fpsDecoded=i.framesPerSecond,t.hasVideo=!0,!i.decoderImplementation||this.prevDecoderImplementationMap_.has(t.userId)&&this.prevDecoderImplementationMap_.get(t.userId)===i.decoderImplementation||(this.log_.info(`${t.userId} decoderImplementation change to ${i.decoderImplementation}`),this.prevDecoderImplementationMap_.set(t.userId,i.decoderImplementation))),i.ssrc===n.auxiliary&&a.auxiliary&&(t.auxiliary.packetsReceived=i.packetsReceived,t.auxiliary.bytesReceived=i.bytesReceived,t.auxiliary.packetsLost=i.packetsLost,t.auxiliary.framesReceived=i.framesReceived,t.auxiliary.framesDecoded=i.framesDecoded,t.auxiliary.fpsDecoded=i.framesPerSecond,t.hasAuxiliary=!0)}}else"candidate-pair"===i.type&&Ya(i)&&ui(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime));li(i.frameWidth)||(i.trackIdentifier!==e.getMainStreamVideoTrackId()&&i.ssrc!==n.video||(t.video.frameWidth=i.frameWidth,t.video.frameHeight=i.frameHeight),i.trackIdentifier!==e.getAuxStreamVideoTrackId()&&i.ssrc!==n.auxiliary||(t.auxiliary.frameWidth=i.frameWidth,t.auxiliary.frameHeight=i.frameHeight)),li(i.audioLevel)||(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0)})),0===t.audio.audioLevel)t.audio.audioLevel=(null===(s=e.getMainStream())||void 0===s?void 0:s.getInternalAudioLevel())||0}catch(n){this.log_.warn("failed to getStats on receiver connection "+n)}return t}async getStats(e,t){let i={};e&&(i=await this.getSenderStats(e));const s=[];for(let[n,a]of t){const e=await this.getReceiverStats(a);s.push(e)}return{senderStats:i,receiverStats:s}}getDifferenceValue(e,t){if(aa(e))return t;const i=t-e;return i<0?0:i}prepareReport({stats:e,report:t,freezeMap:i}){if(!aa(e.senderStats)){let i;i={uint32_audio_level:1e8*e.senderStats.audio.audioLevel,uint32_audio_energy:1e6*e.senderStats.audio.totalAudioEnergy,uint32_audio_codec_bitrate:e.senderStats.audio.bytesSent,audioLevel:e.senderStats.audio.audioLevel};let s=[],n={uint32_video_stream_type:2,uint32_video_codec_fps:e.senderStats.video.framesSent,uint32_video_capture_fps:e.senderStats.video.fpsCapture,uint32_video_width:e.senderStats.video.frameWidth,uint32_video_height:e.senderStats.video.frameHeight,uint32_video_codec_bitrate:e.senderStats.video.bytesSent,uint32_video_enc_fps:e.senderStats.video.framesEncoded};if(s.push(n),e.senderStats.small.bytesSent){let t={uint32_video_stream_type:3,uint32_video_codec_fps:e.senderStats.small.framesSent||0,uint32_video_capture_fps:e.senderStats.small.fpsCapture||0,uint32_video_width:e.senderStats.small.frameWidth||0,uint32_video_height:e.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:e.senderStats.small.bytesSent,uint32_video_enc_fps:e.senderStats.small.framesEncoded||0};s.push(t)}if(e.senderStats.auxiliary.bytesSent){let t={uint32_video_stream_type:7,uint32_video_codec_fps:e.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:e.senderStats.auxiliary.fpsCapture||0,uint32_video_width:e.senderStats.auxiliary.frameWidth||0,uint32_video_height:e.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:e.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:e.senderStats.auxiliary.framesEncoded||0};s.push(t)}let a={uint32_bitrate:0,uint32_rtt:e.senderStats.rtt};t.msg_up_stream_info={msg_audio_status:i,msg_video_status:s,msg_network_status:a}}const s=this.statInterval;t.msg_down_stream_info=[],e.receiverStats.forEach((e=>{const s={};if(s.msg_user_info={str_identifier:e.userId,uint64_tinyid:e.tinyId},s.msg_network_status={uint32_rtt:e.rtt},s.msg_video_status={},e.hasAudio){const t={uint32_audio_codec_bitrate:e.audio.bytesReceived,uint32_audio_total_bitrate:e.audio.bytesReceived,uint32_audio_level:1e8*e.audio.audioLevel,uint32_audio_energy:1e6*e.audio.totalAudioEnergy,uint32_audio_receive:e.audio.packetsReceived,uint32_audio_origin_lost:e.audio.packetsLost,audioLevel:e.audio.audioLevel};s.msg_audio_status=t}if(s.msg_video_status=[],e.hasVideo){const t=i.get(e.userId+"_"+D),n=t?t.duration:0,a={uint32_video_stream_type:2,uint32_video_receive_fps:e.video.framesReceived,uint32_video_width:e.video.frameWidth,uint32_video_height:e.video.frameHeight,uint32_video_codec_bitrate:e.video.bytesReceived,uint32_video_receive:e.video.packetsReceived,uint32_video_origin_lost:e.video.packetsLost,uint32_video_block_time:n,uint32_video_dec_fps:e.video.framesDecoded};s.msg_video_status.push(a)}if(e.hasAuxiliary){const t=i.get(e.userId+"_"+C),n=t?t.duration:0,a={uint32_video_stream_type:7,uint32_video_receive_fps:e.auxiliary.framesReceived,uint32_video_width:e.auxiliary.frameWidth,uint32_video_height:e.auxiliary.frameHeight,uint32_video_codec_bitrate:e.auxiliary.bytesReceived,uint32_video_receive:e.auxiliary.packetsReceived+e.auxiliary.packetsLost,uint32_video_origin_lost:e.auxiliary.packetsLost,uint32_video_block_time:n,uint32_video_dec_fps:e.auxiliary.framesDecoded};s.msg_video_status.push(a)}t.msg_down_stream_info.push(s)}));const n=this.prevReport_;if(this.prevReport_=JSON.parse(JSON.stringify(t)),t.msg_up_stream_info.msg_audio_status&&n.msg_up_stream_info.msg_audio_status){const e=n.msg_up_stream_info.msg_audio_status,i=t.msg_up_stream_info.msg_audio_status,a=this.getDifferenceValue(e.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=Math.round(8*a/s),t.msg_up_stream_info.msg_network_status.uint32_bitrate+=i.uint32_audio_codec_bitrate}const a=n.msg_up_stream_info.msg_video_status;t.msg_up_stream_info.msg_video_status.forEach((e=>{const i=a.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type));if(!i||0===i.uint32_video_codec_bitrate)return e.uint32_video_codec_bitrate=0,e.uint32_video_enc_fps=0,void(e.uint32_video_codec_fps=0);let n=i.uint32_video_codec_bitrate,o=i.uint32_video_enc_fps,r=i.uint32_video_codec_fps;const d=this.getDifferenceValue(n,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*d/s),t.msg_up_stream_info.msg_network_status.uint32_bitrate+=e.uint32_video_codec_bitrate,e.uint32_video_enc_fps=Math.round(this.getDifferenceValue(o,e.uint32_video_enc_fps)/s),e.uint32_video_codec_fps=Math.round(this.getDifferenceValue(r,e.uint32_video_codec_fps)/s)}));const o=t.msg_down_stream_info,r=n.msg_down_stream_info;return o.forEach((e=>{const t=r.find((t=>t.msg_user_info.uint64_tinyid===e.msg_user_info.uint64_tinyid));if(t){if(e.msg_audio_status&&t.msg_audio_status){const i=e.msg_audio_status,n=t.msg_audio_status;i.uint32_audio_origin_lost=this.getDifferenceValue(n.uint32_audio_origin_lost,i.uint32_audio_origin_lost),i.uint32_audio_receive=this.getDifferenceValue(n.uint32_audio_receive,i.uint32_audio_receive),i.uint32_audio_receive+=i.uint32_audio_origin_lost;const a=this.getDifferenceValue(n.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=Math.round(8*a/s),i.uint32_audio_total_bitrate=Math.round(8*a/s)}if(e.msg_video_status&&t.msg_video_status){const i=e.msg_video_status,n=t.msg_video_status;i.forEach((e=>{const t=n.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type));if(!t)return e.uint32_video_receive=0,e.uint32_video_origin_lost=0,e.uint32_video_codec_bitrate=0,e.uint32_video_receive_fps=0,void(e.uint32_video_dec_fps=0);let i=t.uint32_video_receive,a=t.uint32_video_origin_lost,o=t.uint32_video_codec_bitrate,r=t.uint32_video_receive_fps,d=t.uint32_video_dec_fps;e.uint32_video_origin_lost=this.getDifferenceValue(a,e.uint32_video_origin_lost),e.uint32_video_receive=this.getDifferenceValue(i,e.uint32_video_receive)+e.uint32_video_origin_lost;const c=this.getDifferenceValue(o,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*c/s);const l=this.getDifferenceValue(r,e.uint32_video_receive_fps);e.uint32_video_receive_fps=Math.round(l/s),e.uint32_video_dec_fps=Math.round(this.getDifferenceValue(d,e.uint32_video_dec_fps)/s)}))}}})),t}async getStatsReport({uplinkConnection:e,downlinkConnections:t,freezeMap:i}){const s={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0,audioLevel:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:""},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0,audioLevel:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0,uint32_jitter:0}}]},n=await this.getStats(e,t);return"{}"===JSON.stringify(this.prevReport_)&&(this.prevReport_=JSON.parse(JSON.stringify(s))),this.prepareReport({stats:n,report:s,freezeMap:i,uplinkConnection:e,downlinkConnections:t}),this.prevReportTime_=Date.now(),s}reset(){this.prevReportTime_=0,this.prevReport_={},this.prevEncoderImplementation_="",this.prevQualityLimitationReason_="",this.prevDecoderImplementationMap_=new Map}}class po{constructor({signalChannel:e,connections:t,client:i}){this.client_=i,this.signalChannel_=e,this.connections_=t,this.client_=i,this.log_=Vs.createLogger({id:"q|"+this.client_.getUserId(),userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId()}),this.uplinkConnection_=null,this.uplinkNetworkQuality_=0,this.uplinkRTT_=0,this.uplinkLoss_=0,this.downlinkNetworkQuality_=0,this.downlinkRTT_=0,this.downlinkLoss_=0,this.downlinkPrevStatMap_=new Map,this.downlinkLossAndRTTMap_=new Map,this.interval_=-1,this.emitter_=new Li,this.initialize()}get uplinkNetworkQuality(){return this.uplinkNetworkQuality_}set uplinkNetworkQuality(e){e!==this.uplinkNetworkQuality_&&this.log_.info(`uplink network quality change ${this.uplinkNetworkQuality} -> ${e}, rtt: ${this.uplinkRTT_}, loss: ${this.uplinkLoss_}`),this.uplinkNetworkQuality_=e}get downlinkNetworkQuality(){return this.downlinkNetworkQuality_}set downlinkNetworkQuality(e){if(e!==this.downlinkNetworkQuality_){const{rtt:t,loss:i}=this.getAverageLossAndRTT([...this.downlinkLossAndRTTMap_.values()]);this.log_.info(`downlink network quality change ${this.downlinkNetworkQuality} -> ${e}, rtt: ${t}, loss: ${i}`)}this.downlinkNetworkQuality_=e}initialize(){this.signalChannel_.on(Xs.UPLINK_NETWORK_STATS,(e=>{this.handleUplinkNetworkQuality(e)})),this.signalChannel_.on(Bs,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){if(!this.uplinkConnection_)return this.uplinkNetworkQuality=0,this.uplinkLoss_=0,void(this.uplinkRTT_=0);const t=this.uplinkConnection_.getPeerConnection();if(t&&this.isPeerConnectionDisconnected(t))return this.uplinkNetworkQuality=6,this.uplinkLoss_=0,void(this.uplinkRTT_=0);if(0===e.data.code){const t=e.data.data,i=t.expectAudPkg+t.expectVidPkg,s=t.recvAudPkg+t.recvVidPkg,n=i-s,a=t.delay;if(a&&this.updateDelay(a),0===i&&0===s)return;this.uplinkLoss_=n<=0?0:Math.round(n/i*100),this.uplinkRTT_=t.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this.uplinkLoss_,this.uplinkRTT_)}}async handleDownlinkNetworkQuality(){if(!this.connections_||0===this.connections_.size)return void(this.downlinkNetworkQuality=0);const e=[...this.connections_.values()],t=e.filter((e=>e.getPeerConnection()&&e.getPeerConnection().connectionState===$));if(e.filter((e=>e.getPeerConnection()&&this.isPeerConnectionDisconnected(e.getPeerConnection()))).length===e.length)return void(this.downlinkNetworkQuality=6);for(let n=0;n<t.length;n++){const e=t[n].getPeerConnection(),{rtt:i,totalPacketsLost:s,totalPacketsReceived:a}=await this.getStat(e);if(!this.downlinkPrevStatMap_.has(e)){this.downlinkPrevStatMap_.set(e,{totalPacketsLost:s,totalPacketsReceived:a});continue}let o=0;const r=this.downlinkPrevStatMap_.get(e),d=s-r.totalPacketsLost,c=a-r.totalPacketsReceived;o=d<=0||c<0?0:Math.round(d/(d+c)*100),this.downlinkPrevStatMap_.set(e,{totalPacketsLost:s,totalPacketsReceived:a}),this.downlinkLossAndRTTMap_.set(e,{rtt:i,loss:o,userId:t[n].getUserId()})}if([...this.downlinkPrevStatMap_.keys()].forEach((e=>{this.isPeerConnectionDisconnected(e)&&(this.downlinkPrevStatMap_.delete(e),this.downlinkLossAndRTTMap_.delete(e))})),0===this.downlinkLossAndRTTMap_.size)return;const{rtt:i,loss:s}=this.getAverageLossAndRTT([...this.downlinkLossAndRTTMap_.values()]);this.downlinkRTT_=i,this.downlinkLoss_=s,this.downlinkNetworkQuality=this.getNetworkQuality(s,i)}async getStat(e){const t={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!Fa())return t;const i=e.getReceivers();try{for(let e=0;e<i.length;e++){const s=i[e];(await s.getStats()).forEach((e=>{"candidate-pair"===e.type&&ui(e.currentRoundTripTime)&&(t.rtt=Math.round(1e3*e.currentRoundTripTime)),"inbound-rtp"!==e.type||e.mediaType!==o.AUDIO&&e.mediaType!==o.VIDEO||(t.totalPacketsLost+=e.packetsLost,t.totalPacketsReceived+=e.packetsReceived)}))}return t}catch(s){return t}}getAverageLossAndRTT(e){const t={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach((e=>{t.rtt+=e.rtt,t.loss+=e.loss})),Object.keys(t).forEach((i=>{t[i]=Math.round(t[i]/e.length)}))),t}getNetworkQuality(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}handleSignalConnectionStateChange(e){e.state===Ws?(this.uplinkRTT_=0,this.uplinkLoss_=0,this.uplinkNetworkQuality=6):e.state===Ks&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange({state:e}){e===w?(this.uplinkLoss_=0,this.uplinkRTT_=0,this.uplinkNetworkQuality=6):e===L&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!(!e||e.connectionState!==x&&e.connectionState!==U&&e.connectionState!==V)}setUplinkConnection(e){this.uplinkConnection_=e,this.uplinkConnection_?this.uplinkConnection_.on(ao.CONNECTION_STATE_CHANGED,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this.uplinkRTT_=0,this.uplinkLoss_=0)}start(){-1===this.interval_?(this.log_.info("start network quality calculating"),this.interval_=Na.run(Le,(()=>{this.handleDownlinkNetworkQuality(),Pi.emit(bs,{client:this.client_,uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT_,uplinkLoss:this.uplinkLoss_,downlinkRTT:this.downlinkRTT_,downlinkLoss:this.downlinkLoss_,downlinkLossAndRTTMap:this.downlinkLossAndRTTMap_}),this.emitter_.emit(oo.NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT_,uplinkLoss:this.uplinkLoss_,downlinkRTT:this.downlinkRTT_,downlinkLoss:this.downlinkLoss_})}),{delay:2e3})):this.log_.info("network quality calculating is already started")}stop(){this.log_.info("stop network quality calculating"),-1!==this.interval_&&(Na.clearTask(this.interval_),this.interval_=-1),this.downlinkLossAndRTTMap_.clear(),this.downlinkPrevStatMap_.clear()}on(e,t){this.emitter_.on(e,t)}updateDelay(e){e.forEach((({srcTinyId:e,videoDelay:t,audioDelay:i})=>{const s=this.connections_.get(e);s&&s.setDelay({videoDelay:t,audioDelay:i})}))}}class go{constructor(e){this.log_=Vs.createLogger({id:e.client.getUserId(),userId:e.client.getUserId(),sdkAppId:e.client.getSDKAppId()}),this.localStream_=null,this.prevDevices_=[],this.initialize()}initialize(){navigator.mediaDevices&&navigator.mediaDevices.addEventListener&&(this.onDeviceChange=this.onDeviceChange.bind(this),navigator.mediaDevices.addEventListener("devicechange",this.onDeviceChange))}destroy(){navigator.mediaDevices&&navigator.mediaDevices.removeEventListener&&navigator.mediaDevices.removeEventListener("devicechange",this.onDeviceChange)}async onDeviceChange(){if(!this.localStream_||!this.localStream_.getMediaStream()||this.localStream_.getScreen())return;const e=await Eo(),t=e.filter((e=>this.prevDevices_.findIndex((({deviceId:t})=>e.deviceId===t))<0)),i=this.prevDevices_.filter((t=>e.findIndex((({deviceId:e})=>t.deviceId===e))<0));t.length>0&&this.handleDeviceAdded(this.prevDevices_,t),i.length>0&&this.handleDeviceRemoved(e,i),this.prevDevices_=e}async setLocalStream(e){e&&(this.prevDevices_=await Eo()),this.localStream_=e}handleDeviceAdded(e,t){var i,s;if(!this.localStream_)return;this.log_.warn(`devicesAdded: ${JSON.stringify(t)}`),this.localStream_.updateDeviceIdInUse();const n=t.filter((({kind:e})=>e===o.VIDEO_INPUT)),a=t.filter((({kind:e})=>e===o.AUDIO_INPUT)),r=e.filter((({kind:e})=>e===o.VIDEO_INPUT)),d=e.filter((({kind:e})=>e===o.AUDIO_INPUT)),c=n.length>0&&0===r.length&&"live"!==(null===(i=this.localStream_.getVideoTrack())||void 0===i?void 0:i.readyState),l=a.length>0&&0===d.length&&"live"!==(null===(s=this.localStream_.getAudioTrack())||void 0===s?void 0:s.readyState);if(l&&c)return this.log_.info("new microphone and camera detected, but there was no device before."),void this.localStream_.recoverCapture({audio:!0,video:!0,cameraId:n[0].deviceId,microphoneId:a[0].deviceId});c&&(this.log_.info("new camera detected, but there was no camera before."),this.localStream_.recoverCapture({audio:!1,video:!0,cameraId:n[0].deviceId})),l&&(this.log_.info("new microphone detected, but there was no microphone before."),this.localStream_.recoverCapture({audio:!0,video:!1,microphoneId:a[0].deviceId}))}handleDeviceRemoved(e,t){if(!this.localStream_)return;this.log_.warn(`devicesRemoved: ${JSON.stringify(t)}`),this.localStream_.updateDeviceIdInUse();let i=!1,s=!1;const n=this.localStream_.getCameraId(),a=this.localStream_.getMicrophoneId();if(a===ve){const t=this.localStream_.getMicrophoneGroupId(),i=e.filter((e=>e.deviceId===ve&&e.kind===o.AUDIO_INPUT))[0];i&&i.groupId!==t&&(s=!0)}if(t.forEach((({deviceId:e})=>{n.length>0&&e===n?i=!0:a.length>0&&e===a&&(s=!0)})),i&&s)return this.log_.warn(`current camera and microphone in use is lost, cameraId: ${n}, microphoneId: ${a}`),void((this.localStream_.getAudio()||this.localStream_.getVideo())&&this.localStream_.recoverCapture({video:!0,audio:!0}));i&&(this.log_.warn(`current camera in use is lost, deviceId: ${n}`),this.localStream_.getVideo()&&this.localStream_.recoverCapture({video:!0,audio:!1})),s&&(this.log_.warn(`current microphone in use is lost, deviceId: ${a}`),this.localStream_.getAudio()&&this.localStream_.recoverCapture({video:!1,audio:!0}))}}const Io=new Set;async function So(){if(Ka()||Ja())return[];const e=await navigator.mediaDevices.enumerateDevices();return e.forEach((e=>{Io.add(`${e.deviceId}_${e.kind}`)})),e}async function Eo(){return(await So()).filter((e=>e.kind!==o.AUDIO_INPUT||e.deviceId!=ye)).map(((e,t)=>{let i=e.label;e.label||(i=e.kind+"_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),e.getCapabilities&&(s.getCapabilities=()=>e.getCapabilities()),s}))}async function To(){return(await So()).filter((e=>e.kind===o.AUDIO_INPUT&&e.deviceId!==ye)).map(((e,t)=>{let i=e.label;e.label||(i="microphone_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),e.getCapabilities&&(s.getCapabilities=()=>e.getCapabilities()),s}))}async function fo(){return(await So()).filter((e=>"audiooutput"===e.kind)).map(((e,t)=>{let i=e.label;e.label||(i="speaker_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),s}))}let Ao,vo,yo=new Blob(["class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=Math.max(rms,this.volume*0.95);this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);"],{type:"application/javascript"}),Ro=!1;class bo{constructor(e){this.context_=e.context,this.addModuleToContext()}async addModuleToContext(){try{await this.context_.audioWorklet.addModule(URL.createObjectURL(yo)),Vs.info("worklet addModule success"),Pi.emit(Cs),Ro=!0}catch(e){Vs.info(`worklet addModule catch error. ${e.message}`),Pi.emit(Ns)}}get initWorkletSuccess(){return Ro}}let Do=0;class Co{constructor(e){const{track:t,log:i,stream:s}=e;this.volume_=0,this.log_=i,this.track_=t,this.stream_=s,Do+=1,Ao||(Ao=vi()),this.audioCtx_=Ao,this.destination_=this.audioCtx_.destination;const n=new MediaStream;n.addTrack(this.track_),this.streamSource_=this.audioCtx_.createMediaStreamSource(n),this.audioWorkletNode_=null,this.scriptProcessorNode_=null,this.interval_=200,Pi.on(Ds,this.resume,this),Pi.on(Xi,this.handleAudioLevelInterval,this),Ri?(Pi.on(Cs,this.initAudioWorklet,this),Pi.on(Ns,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor()}preload(){vo?vo.initWorkletSuccess&&this.initAudioWorklet():vo=new bo({context:Ao})}initAudioWorklet(){if(!this.audioWorkletNode_)try{this.audioWorkletNode_=new AudioWorkletNode(this.audioCtx_,"volume-meter"),this.audioWorkletNode_.port.onmessage=e=>{this.volume_=e.data.volume||0},this.streamSource_.connect(this.audioWorkletNode_).connect(this.destination_),this.handleAudioLevelInterval({interval:this.interval_})}catch(e){this.log_.warn("load volume meter failed, load again. error: "+e),this.initScriptProcessor()}}initScriptProcessor(){if(!this.scriptProcessorNode_)try{this.scriptProcessorNode_=this.audioCtx_.createScriptProcessor(2048,1,1),this.scriptProcessorNode_.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);let i=0;for(let s=0;s<t.length;++s)i+=t[s]*t[s];this.volume_=Math.sqrt(i/t.length)||0},this.streamSource_.connect(this.scriptProcessorNode_),this.scriptProcessorNode_.connect(this.destination_)}catch(e){this.log_.error("volumeMeter init script processor error: "+e),Do-=1}}destroy(){var e;(this.streamSource_&&this.streamSource_.disconnect(),this.scriptProcessorNode_&&(this.scriptProcessorNode_.onaudioprocess=null,this.scriptProcessorNode_.disconnect()),this.audioWorkletNode_&&(this.audioWorkletNode_.port.postMessage({name:"stop"}),this.audioWorkletNode_.port.onmessage=null,this.audioWorkletNode_.disconnect()),this.audioWorkletNode_=null,this.scriptProcessorNode_=null,this.audioCtx_=null,Pi.off(Ds,this.resume,this),Pi.off(Xi,this.handleAudioLevelInterval,this),Pi.off(Cs,this.initAudioWorklet,this),Pi.off(Ns,this.initScriptProcessor,this),Do>0&&(Do-=1),0===Do)&&(null===(e=Ao)||void 0===e||e.close(),Ao=null,vo=null)}resume(){var e;null===(e=Ao)||void 0===e||e.resume()}getInternalAudioLevel(){return this.volume_}getCalculatedVolume(){return this.volume_.toFixed(2)}handleAudioLevelInterval({interval:e}){var t;this.interval_=e,null===(t=this.audioWorkletNode_)||void 0===t||t.port.postMessage({name:"setIntervalTime",intervalTime:e})}}class No{constructor(e){this.stream_=e.stream,this.userId_=e.stream.getUserId(),this.log_=this.stream_.getLogger(),this.track_=e.track,e.gainedTrack&&(this.gainedTrack_=e.gainedTrack),this.div_=e.div,this.muted_=e.muted,this.outputDeviceId_=e.outputDeviceId,this.volume_=e.volume,this.pausedRetryCount_=5,this.emitter_=new Li,this.initializeElement(),this.state_="NONE",this.volumeMeter_=new Co({stream:this.stream_,track:this.gainedTrack_||this.track_,log:this.log_})}get isPlaying(){return this.state_===o.PLAYER_STATE_PLAYING}initializeElement(){if(this.isAudioElementInit()){const e=new MediaStream;e.addTrack(this.gainedTrack_||this.track_);const t=document.createElement(o.AUDIO);t.srcObject=e,t.muted=this.muted_,t.setAttribute("id",`audio_${this.stream_.getId()}`),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_.appendChild(t),this.element_=t}this.handleEvents()}setMuted(e){this.element_&&(this.element_.muted=e,this.muted_=e)}async play(){this.outputDeviceId_&&this.element_&&await this.element_.setSinkId(this.outputDeviceId_),this.setVolume(this.volume_);try{this.element_&&await this.element_.play()}catch(e){const t=ti({key:$e.PLAY_FAILED,data:{media:"Audio",error:e}});if(this.log_.warn(t),t.includes("NotAllowedError"))throw new En({code:Sn.PLAY_NOT_ALLOWED,message:t})}}handleEvents(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_&&(this.element_.addEventListener(o.PLAYING,this.handleElementEvent),this.element_.addEventListener(o.ENDED,this.handleElementEvent),this.element_.addEventListener(o.PAUSE,this.handleElementEvent),this.element_.addEventListener(o.ERROR,this.handleElementEvent)),this.track_.addEventListener(o.ENDED,this.handleTrackEvent),this.track_.addEventListener(o.MUTE,this.handleTrackEvent),this.track_.addEventListener(o.UNMUTE,this.handleTrackEvent),this.track_.readyState===o.ENDED&&this.handleTrackEvent({type:o.ENDED}),this.track_.muted&&this.handleTrackEvent({type:o.MUTE})}async handleElementEvent(e){switch(e.type){case o.PLAYING:this.log_.info("audio player is playing"),this.state_=o.PLAYER_STATE_PLAYING,Pi.emit(ns,{stream:this.stream_}),this.emitter_.emit(_o,{state:this.state_,reason:o.PLAYING});break;case o.ENDED:this.log_.info("audio player is ended"),this.state_!==o.PLAYER_STATE_STOPPED&&(this.state_=o.PLAYER_STATE_STOPPED,this.emitter_.emit(_o,{state:this.state_,reason:o.ENDED}));break;case o.PAUSE:{this.log_.info("audio player is paused"),this.state_=o.PLAYER_STATE_PAUSED,this.emitter_.emit(_o,{state:this.state_,reason:o.PAUSE});const e=this.div_&&document.getElementById(this.div_.id);e||this.log_.warn(`audio player has been remove, element ID: ${this.div_.id}`);const t=Mt();this.pausedRetryCount_>0&&(ui(t)&&t<=70||!e)&&(this.resume(),this.pausedRetryCount_--),Ke&&(this.interval_=Na.run((()=>{this.element_&&this.state_===o.PLAYER_STATE_PAUSED&&this.resume()}),{delay:3e3}));break}case o.ERROR:if(this.element_&&this.element_.error){const e=`${qa()}/${qt().name}/${qt().version}`,t=await Ic.getSpeakers();let i=t[0].label;const s=t.find((e=>e.deviceId===this.outputDeviceId_));s&&(i=s.label),this.log_.error(`audio player error observed. code: ${this.element_.error.code} message: ${this.element_.error.message} deviceInfo: ${e} speaker: ${i}`),oa.uploadEvent({log:`stat-${this.stream_.getType()}-audio-${B.PLAYER_ERROR}-${this.element_.error.code}-${e}-${i}`,userId:this.userId_,error:this.element_.error})}}}handleTrackEvent(e){const t=e.type;switch(t){case o.ENDED:this.log_.info("audio track is ended"),this.state_!==o.PLAYER_STATE_STOPPED&&(this.state_=o.PLAYER_STATE_STOPPED,this.emitter_.emit(_o,{state:this.state_,reason:o.ENDED})),Pi.emit(vs,{stream:this.stream_,type:t});break;case o.MUTE:this.log_.info("audio track is unable to provide media output"),this.stream_.isRemote()||Ai(),this.state_!==o.PLAYER_STATE_PAUSED&&(this.state_=o.PLAYER_STATE_PAUSED,this.emitter_.emit(_o,{state:this.state_,reason:o.MUTE})),Pi.emit(As,{stream:this.stream_,type:t});break;case o.UNMUTE:this.log_.info("audio track is able to provide media output"),this.state_===o.PLAYER_STATE_PAUSED&&(this.state_=o.PLAYER_STATE_PLAYING,this.emitter_.emit(_o,{state:this.state_,reason:o.UNMUTE}))}}unbindEvents(){this.element_&&(this.element_.removeEventListener(o.PLAYING,this.handleElementEvent),this.element_.removeEventListener(o.ENDED,this.handleElementEvent),this.element_.removeEventListener(o.PAUSE,this.handleElementEvent),this.element_.removeEventListener(o.ERROR,this.handleElementEvent)),this.track_&&(this.track_.removeEventListener(o.ENDED,this.handleTrackEvent),this.track_.removeEventListener(o.MUTE,this.handleTrackEvent),this.track_.removeEventListener(o.UNMUTE,this.handleTrackEvent))}async setSinkId(e){this.outputDeviceId_!==e&&(this.element_&&await this.element_.setSinkId(e),this.outputDeviceId_=e)}setVolume(e){this.element_&&(this.log_.info(`audioElement setVolume to : ${e}`),this.element_.volume=e)}getAudioLevel(){return this.volumeMeter_.getCalculatedVolume()}getInternalAudioLevel(){return this.volumeMeter_.getInternalAudioLevel()}stop(){this.unbindEvents(),this.element_&&(this.div_.removeChild(this.element_),this.element_.srcObject=null,this.element_=null),this.volumeMeter_&&(this.volumeMeter_.destroy(),this.volumeMeter_=null),this.interval_>0&&Na.clearTask(this.interval_)}async resume(){try{this.volumeMeter_&&this.volumeMeter_.resume(),this.element_&&await this.element_.play()}catch(e){const t=ti({key:$e.PLAY_FAILED,data:{media:"Audio",error:e}});if(this.log_.warn(t),t.includes("NotAllowedError"))throw new En({code:Sn.PLAY_NOT_ALLOWED,message:t})}}on(e,t){this.emitter_.on(e,t)}isAudioElementInit(){return!("15.2"===Gt||"15.3"===Gt||"15.4"===Gt)||"local"!==this.stream_.getType()||!this.muted_||(this.log_.info("audioElement is muted."),!1)}}const wo="trtc_autoplay",ko=`${wo}_mask`,Oo=`${wo}_wrapper`,Lo=`${wo}_header`,Po=`${wo}_content`,Mo=`${wo}_action_wrapper`,Uo=`${wo}_question`,Vo=`${wo}_collapse`,xo=`${wo}_action_confirm`,$o=`${wo}_detail`,Fo="#2473E8",Bo="dialog",Ho=`${Bo}-show`,Go=`${Bo}-1`,Wo=`${Bo}-2`;let jo=!1;const Jo=()=>!!document.querySelector(`.${Oo}`),Ko=`${Te}/${fi()?"zh-cn":"en"}/tutorial-21-advanced-auto-play-policy.html`,zo=`<br><a href='${Ko}' target='_blank'>${fi()?"其他方案？":"Any other solution?"}</a>`,Yo=""+(fi()?`浏览器自动播放策略：在用户与页面产生交互（点击、触摸）之前，浏览器禁止播放有声媒体。该弹窗用于帮助用户恢复音视频播放。${zo}`:`Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ${zo}`);class Xo{constructor(){if(this.dialogNode_=null,this.bodyPosition_="",this.content="音视频播放被浏览器拦截，请点击“恢复播放”。",fi()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!jo){const e=document.createElement("style");e.innerHTML=`.${ko}{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.${ko} div:not(.${Mo}){display:block !important;}.${Oo}{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.${Oo} a{color:${Fo};}.${Lo}{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.${Po}{margin:8px 0;}.${Mo}{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.${Vo}{margin-right:auto;cursor:pointer}.${Uo}{height:100%;line-height:16px;cursor:pointer;}.${xo}{margin-left:8px;color:#fff;background:${Fo};padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.${xo}:hover{opacity:0.9;}.${Vo},.${xo},.${Po},.${Uo}{font-size:14px;}@media screen and (max-width:750px){.${Oo}{width:80vw;}}`,document.head.appendChild(e),jo=!0}this.showDetail_=!1,this.isCollapseClicked_=!1,this.isQuestionClicked_=!1,this.addDiaLog()}createDiaLog(){const e=document.createElement("template");e.innerHTML=`<div class="${ko}"><div class='${Oo}'><div class='${Lo}'>${location.host}</div><div class='${Po}'>${this.content}</div><div class='${$o}' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">${Yo}</div><div class='${Mo}'></div></div></div>`.trim();const t=document.createElement("button");t.className=xo,t.innerText=fi()?"恢复播放":"Resume",t.onclick=this.onConfirm.bind(this);const i=document.createElement("div");i.className=Uo,i.innerHTML='<?xml version="1.0" encoding="UTF-8"?>\n    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">\n    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>\n    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>\n    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>\n    </svg>\n    ',i.onclick=this.onQuestionClick.bind(this);const s=document.createElement("div");s.className=Vo,s.innerText=""+(fi()?"详情 >":"Detail >"),s.onclick=this.onCollapseClick.bind(this);const n=e.content.firstChild,a=n.querySelector(`.${Mo}`);return a.appendChild(s),a.appendChild(i),a.appendChild(t),n}addDiaLog(){Jo()||(this.dialogNode_=this.createDiaLog(),document.body.appendChild(this.dialogNode_),this.dialogNode_.onclick=this.onConfirm.bind(this),this.dialogNode_.querySelector(`.${Oo}`).onclick=e=>e.stopPropagation(),this.bodyPosition_=document.body.style.position,document.body.style.position="fixed",Vs.info("show autoplay dialog"),oa.uploadEvent({log:Ho}))}deleteDiaLog(){this.dialogNode_&&(document.body.removeChild(this.dialogNode_),document.body.style.position=this.bodyPosition_,this.dialogNode_=null)}onConfirm(){Vs.warn("confirm clicked, try resume stream"),Pi.emit(Ds),this.deleteDiaLog()}onCollapseClick(){const e=this.dialogNode_.querySelector(`.${$o}`);e.style.visibility=""+(this.showDetail_?"hidden":"visible"),e.style.height=`${this.showDetail_?0:"fit-content"}`,this.showDetail_=!this.showDetail_,this.isCollapseClicked_||oa.uploadEvent({log:Go}),this.isCollapseClicked_=!0}onQuestionClick(){window.open(Ko,"_blank"),this.isQuestionClicked_||oa.uploadEvent({log:Wo}),this.isQuestionClicked_=!0}}class qo{constructor(e){this.stream_=e.stream,this.userId_=e.stream.getUserId(),this.log_=this.stream_.getLogger(),this.track_=e.track,this.div_=e.div,this.muted_=e.muted,this.objectFit_=e.objectFit,this.mirror_=e.mirror,this.emitter_=new Li,this.initializeElement(),this.state_="NONE",this.pausedRetryCount_=5}get isPlaying(){return this.state_===o.PLAYER_STATE_PLAYING}initializeElement(){const e=new MediaStream;e.addTrack(this.track_);const t=document.createElement(o.VIDEO);t.srcObject=e,t.muted=!0;let i=`width: 100%; height: 100%; object-fit: ${this.objectFit_};`;this.mirror_&&(i+="transform: scaleX(-1);"),t.setAttribute("id",`video_${this.stream_.getId()}`),t.setAttribute("style",i),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.element_=t,"17.0"!==Gt&&"17.1"!==Gt||this.initCanvasElement(i),this.div_&&this.div_.appendChild(this.canvas_||t),this.handleEvents()}initCanvasElement(e){if(!this.track_||this.stream_.isRemote())return;const t=document.createElement("canvas"),i=()=>{var e;const i=null===(e=this.track_)||void 0===e?void 0:e.getSettings();i&&i.width&&i.height&&(t.width=i.width,t.height=i.height)};i(),t.setAttribute("style",e);const s=t.getContext("2d");this.canvasTimerId_=Na.run("raf",(()=>{this.element_&&s&&(i(),s.drawImage(this.element_,0,0,t.width,t.height))}),{backgroundTask:!1}),this.log_.warn("use canvas for playback"),this.canvas_=t}setRect({width:e,height:t}){this.element_&&(this.element_.style.width=e+"px",this.element_.style.height=t+"px")}setMirror(e){this.element_&&(this.element_.style.transform=e?"scaleX(-1)":"",this.mirror_=e)}setObjectFit(e){this.element_&&(this.element_.style.objectFit=`${e}`,this.objectFit_=e)}async play(){try{await this.element_.play()}catch(e){const t=ti({key:$e.PLAY_FAILED,data:{media:"Video",error:e}});if(this.log_.warn(t),t.includes("NotAllowedError"))throw new En({code:Sn.PLAY_NOT_ALLOWED,message:t})}}handleEvents(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_.addEventListener(o.PLAYING,this.handleElementEvent),this.element_.addEventListener(o.ENDED,this.handleElementEvent),this.element_.addEventListener(o.PAUSE,this.handleElementEvent),this.element_.addEventListener(o.ERROR,this.handleElementEvent),this.element_.addEventListener(o.LOADEDDATA,this.handleElementEvent),this.track_.addEventListener(o.ENDED,this.handleTrackEvent),this.track_.addEventListener(o.MUTE,this.handleTrackEvent),this.track_.addEventListener(o.UNMUTE,this.handleTrackEvent),this.track_.readyState===o.ENDED&&this.handleTrackEvent({type:o.ENDED}),this.track_.muted&&this.handleTrackEvent({type:o.MUTE})}handleElementEvent(e){switch(e.type){case o.PLAYING:this.log_.info("video player is playing"),this.state_=o.PLAYER_STATE_PLAYING,Pi.emit(ss,{stream:this.stream_}),this.emitter_.emit(_o,{state:this.state_,reason:o.PLAYING}),this.interval_&&(Na.clearTask(this.interval_),this.interval_=null);break;case o.ENDED:this.log_.info("video player is ended"),this.state_!==o.PLAYER_STATE_STOPPED&&(this.state_=o.PLAYER_STATE_STOPPED,this.emitter_.emit(_o,{state:this.state_,reason:o.ENDED}));break;case o.PAUSE:this.log_.info("video player is paused"),this.div_&&!document.getElementById(this.div_.id)&&this.log_.warn(`video player has been remove, element ID: ${this.div_.id}`),this.state_=o.PLAYER_STATE_PAUSED,this.emitter_.emit(_o,{state:this.state_,reason:o.PAUSE}),this.pausedRetryCount_>0&&!Jo()&&(this.log_.info("video player auto resume when video paused"),this.resume(),this.pausedRetryCount_--),Ke&&(this.interval_=Na.run((()=>{this.element_&&this.state_===o.PLAYER_STATE_PAUSED&&this.resume()}),{delay:3e3}));break;case o.ERROR:if(this.element_&&this.element_.error){const e=`${qa()}/${qt().name}/${qt().version}`;this.log_.error(`video player error observed. code: ${this.element_.error.code} message: ${this.element_.error.message} deviceInfo: ${e}`),oa.uploadEvent({log:`stat-${this.stream_.getType()}-video-${B.PLAYER_ERROR}-${this.element_.error.code}-${e}`,userId:this.userId_,error:this.element_.error})}break;case o.LOADEDDATA:Pi.emit(Es,{stream:this.stream_})}}handleTrackEvent(e){const t=e.type;switch(t){case o.ENDED:this.log_.info("video track is ended"),Pi.emit(fs,{stream:this.stream_,type:t}),this.state_!==o.PLAYER_STATE_STOPPED&&(this.state_=o.PLAYER_STATE_STOPPED,this.emitter_.emit(_o,{state:this.state_,reason:o.ENDED}));break;case o.MUTE:this.log_.info("video track is unable to provide media output"),this.stream_.isRemote()||Ai(),Pi.emit(gs,{stream:this.stream_,type:t}),this.state_!==o.PLAYER_STATE_PAUSED&&(this.state_=o.PLAYER_STATE_PAUSED,this.emitter_.emit(_o,{state:this.state_,reason:o.MUTE}));break;case o.UNMUTE:this.log_.info("video track is able to provide media output"),Pi.emit(Is,{stream:this.stream_}),this.state_===o.PLAYER_STATE_PAUSED&&(this.state_=o.PLAYER_STATE_PLAYING,this.emitter_.emit(_o,{state:this.state_,reason:o.UNMUTE}))}}unbindEvents(){this.element_&&(this.element_.removeEventListener(o.PLAYING,this.handleElementEvent),this.element_.removeEventListener(o.ENDED,this.handleElementEvent),this.element_.removeEventListener(o.PAUSE,this.handleElementEvent),this.element_.removeEventListener(o.ERROR,this.handleElementEvent),this.element_.removeEventListener(o.LOADEDDATA,this.handleElementEvent)),this.track_&&(this.track_.removeEventListener(o.ENDED,this.handleTrackEvent),this.track_.removeEventListener(o.MUTE,this.handleTrackEvent),this.track_.removeEventListener(o.UNMUTE,this.handleTrackEvent))}stop(){this.unbindEvents(),this.element_&&(this.element_.remove(),this.element_.srcObject=null,this.element_=null),this.interval_&&Na.clearTask(this.interval_),this.canvasTimerId_&&Na.clearTask(this.canvasTimerId_),this.canvas_&&(this.canvas_.remove(),this.canvas_=null)}resume(){return this.play()}getVideoFrame(){const e=document.createElement("canvas");e.width=this.element_.videoWidth,e.height=this.element_.videoHeight;return e.getContext("2d").drawImage(this.element_,0,0),e.toDataURL("image/png")}on(e,t){this.emitter_.on(e,t)}getElement(){return this.element_?this.element_:null}}class Qo{constructor(e,t,i){this.isUplink_=i,this.connection_=e,this.log_=t,this.seiMessageList_=[],this.smallVideoSeiMessageList_=[],this.seiPayloadType_=243,this.runningAbortMap_=new Map,this.abortMap_=new Map,this.onSEIMessage=null}get isRunning(){return!!this.runningAbortMap_.size>0}start(e,t=this.seiMessageList_){const i=e.createEncodedStreams(),s=i.readable,n=i.writable,a=new TransformStream({transform:this.isUplink_?(e,i)=>this.encodeVideoFrame(e,i,t):(t,i)=>{var s,n;return this.decodeVideoFrame(t,i,e===(null===(s=this.connection_)||void 0===s||null===(n=s.getPeerConnection())||void 0===n?void 0:n.getReceivers()[Ne]))}}),o=new AbortController;s.pipeThrough(a).pipeTo(n,{signal:o.signal}).catch((()=>{})),this.runningAbortMap_.set(e,o)}restart(e,t){this.stop(),this.start(e,t)}stop(e){var t;null===(t=this.runningAbortMap_.get(e))||void 0===t||t.abort(),this.runningAbortMap_.delete(e)}destroy(){this.stop(),this.runningAbortMap_.forEach((e=>e.abort())),this.runningAbortMap_.clear(),this.abortMap_.forEach((e=>e.abort())),this.abortMap_.clear(),this.log_=null,this.onSEIMessage=null,this.connection_=null}handleEncodedStreams(){try{const e=this.connection_.getPeerConnection();this.clearUnusedSenderOrReceiver(e),this.isUplink_?e.getSenders().forEach(((e,t)=>{if(!this.runningAbortMap_.has(e)&&!this.abortMap_.has(e))if(t===be||t===De){const i=t===De?this.smallVideoSeiMessageList_:this.seiMessageList_;this.isRunning?this.restart(e,i):this.start(e,i)}else this.pipeSenderOrReceiver(e)})):e.getReceivers().forEach(((e,t)=>{var i;this.runningAbortMap_.has(e)||this.abortMap_.has(e)||(t!==Ce&&t!==Ne||(null===(i=e.track)||void 0===i?void 0:i.kind)!==o.VIDEO?this.pipeSenderOrReceiver(e):this.isRunning?this.restart(e):this.start(e))}))}catch(e){this.log_.warn(e)}}pipeSenderOrReceiver(e){const{readable:t,writable:i}=e.createEncodedStreams(),s=new AbortController;this.abortMap_.set(e,s),t.pipeTo(i,{signal:s.signal}).catch((()=>{}))}clearUnusedSenderOrReceiver(e){this.abortMap_.forEach(((t,i)=>{(this.isUplink_?e.getSenders():e.getReceivers()).find((e=>e===i))||(t.abort(),this.abortMap_.delete(i))}))}push(e,t){t&&t.seiPayloadType&&(this.seiPayloadType_=t.seiPayloadType),this.seiMessageList_.push(e),this.smallVideoSeiMessageList_.push(e)}hasSEI(e){const t=new DataView(e);return 1===t.getInt32(0)&&6===t.getInt8(4)}isEmptyFrame(e){return"empty"===e.type||0===e.data.byteLength}getNaluCount(e){let t=0,i=0;const s=new DataView(e);for(let n=0;n<e.byteLength;n++)switch(s.getUint8(n)){case 0:t++;break;case 1:2!==t&&3!==t||i++,t=0;break;default:t=0}return i}encodeVideoFrame(e,t,i){try{if(this.connection_.isH264&&i.length>0&&!this.isEmptyFrame(e)){const t=9-this.getNaluCount(e.data);if(t<=0)return;const s=i.splice(0,t).reverse().map(this.encodeSEINalu.bind(this)),n=s.reduce(((e,t)=>e+t.dataView.byteLength),0),a=new ArrayBuffer(n+e.data.byteLength),o=new DataView(a),r=new DataView(e.data);let d=0;for(let e=0;e<s.length;e++)for(let t=0;t<s[e].dataView.byteLength;t++)o.setInt8(d++,s[e].dataView.getInt8(t));for(let i=0;i<e.data.byteLength;i++)o.setInt8(d++,r.getInt8(i));e.data=a,this.log_.debug(`${s.length} sei sent`)}}catch(s){this.log_.warn(s)}t.enqueue(e)}decodeVideoFrame(e,t,i=!1){try{if(this.connection_.isH264&&!this.isEmptyFrame(e)&&this.hasSEI(e.data)){const t=[],s=new DataView(e.data);let n=0,a=-1,o=-1;for(let i=0;i<e.data.byteLength;i++){const r=s.getUint8(i);if(0===r)n++;else if(1===r){if(2===n||3===n){const r=i-n;-1===a?a=r:-1===o&&(o=r,t.push(new Zo(new DataView(s.buffer.slice(a,o)))),a=r,o=-1);if(!(6===s.getUint8(i+1))){e.data=new DataView(s.buffer.slice(r)).buffer;break}}n=0}else n=0}this.log_.debug(`${t.length} sei received`),ci(this.onSEIMessage)&&t.reverse().forEach((e=>{this.onSEIMessage({seiPayloadType:e.seiPayloadType,data:e.seiPayload.buffer,isFromAuxiliary:i})}))}}catch(s){this.log_.warn(s)}t.enqueue(e)}encodeSEINalu(e){const t=e.byteLength,i=parseInt(t/255),s=t%255,n=[];n.push(0,0,0,1,6,this.seiPayloadType_);for(let o=0;o<i;o++)n.push(255);n.push(s);const a=new DataView(e);return n.push(...new Uint8Array(a.buffer)),n.push(128),new Zo(new DataView(new Uint8Array(n).buffer),!0)}}class Zo{constructor(e,t=!1){this.dataView=e,this.isSEI&&(t?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){const e=this.seiPayloadStartIndex,t=this.dataView.byteLength-2,i=[];let s=0;for(let a=e;a<=t;a++){const e=this.dataView.getInt8(a);switch(e){case 0:case 1:case 2:case 3:2===s&&(i.push(3),s=0),0==e?s++:s=0,i.push(e);break;default:s=0,i.push(e)}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));const n=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=n}removePreventionByte(){const e=this.seiPayloadStartIndex,t=this.dataView.byteLength-1,i=[];let s=0;for(let a=e;a<=t;a++)switch(this.dataView.getInt8(a)){case 0:s++,i.push(this.dataView.getInt8(a));break;case 3:2!==s&&i.push(this.dataView.getInt8(a)),s=0;break;default:i.push(this.dataView.getInt8(a)),s=0}const n=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=n}get isSEI(){return 6===this.dataView.getUint8(4)}get seiPayloadStartIndex(){let e=6;for(let t=6;t<this.dataView.buffer.byteLength&&(e++,255===this.dataView.getUint8(t));t++);return e}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let e=0,t=6;for(let n=6;n<this.dataView.buffer.byteLength;n++){const i=this.dataView.getUint8(n);if(t++,255!==i){e+=i;break}e+=255}const i=new ArrayBuffer(e),s=new DataView(i);for(let n=0;n<i.byteLength;n++,t++)s.setInt8(n,this.dataView.getInt8(t));return s}}class er{constructor(e){this.userId_=e.userId,this.tinyId_=e.tinyId,this.client_=e.client,this.sdpSemantics_=e.client.getSdpSemantics(),this.isUplink_=e.isUplink,this.log_=Vs.createLogger({id:"n|"+this.userId_,userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId(),isLocal:this.isUplink_}),this.signalChannel_=e.signalChannel,this.peerConnection_=null,this.isErrorObserved_=!1,this.emitter_=new Li,this.currentState_=w,this.waitForPeerConnectionConnectedPromise_=null,this.isReconnecting_=!1,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.isFirstConnection_=!0,this.delay_={audioDelay:0,videoDelay:0},this.enableSEI_=e.enableSEI,this.enableSEI_&&za&&(this.sei_=new Qo(this,this.log_,this.isUplink_))}initialize(){const e={encodedInsertableStreams:this.enableSEI_&&za,iceServers:this.client_.getIceServers(),iceTransportPolicy:this.client_.getIceTransportPolicy(),sdpSemantics:this.sdpSemantics_,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this.peerConnection_=new RTCPeerConnection(e),this.peerConnection_.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(){this.log_.info("closing connection"),this.closePeerConnection(),this.sei_&&(this.sei_.destroy(),this.sei_=null)}closePeerConnection(e=!1){this.peerConnection_&&(this.peerConnection_.onconnectionstatechange=()=>{},this.peerConnection_.close(),this.peerConnection_=null,e&&this.emitConnectionStateChangedEvent(w))}getDTLSTransportState(){if(!this.peerConnection_)return N;let e=null;if(this.isUplink_){if(!Ba()||0===this.peerConnection_.getSenders().length)return N;e=this.peerConnection_.getSenders()[0].transport}else{if(!Fa()||0===this.peerConnection_.getReceivers().length)return N;e=this.peerConnection_.getReceivers()[0].transport}return e?e.state:N}onConnectionStateChange(e){const t=this.peerConnection_.iceConnectionState,i=this.getDTLSTransportState();if(this.log_.info("onConnectionStateChange() connectionState: "+e.target.connectionState),this.log_.info(`ICE Transport state: ${t}, DTLS Transport state: ${i}`),e.target.connectionState===M&&this.emitConnectionStateChangedEvent(k),e.target.connectionState===U||e.target.connectionState===V){const s=`${this.isUplink_?"uplink":"downlink"} ICE/DTLS Transport connection ${e.target.connectionState}. ICE Transport state: ${t}, DTLS Transport state: ${i}`,n=new En({message:s,code:Sn.ICE_TRANSPORT_ERROR});oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.ICE_CONNECTION_STATE,error:n}),this.emitConnectionStateChangedEvent(w),this.isErrorObserved_||this.emitter_.emit(ao.ERROR,n)}e.target.connectionState!==$&&e.target.connectionState!==F||(this.logSelectedCandidate(),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.ICE_CONNECTION_STATE}),this.emitConnectionStateChangedEvent(L))}emitConnectionStateChangedEvent(e){e!==this.currentState_&&(this.currentState_===O&&e===k||(Pi.emit(ys,{client:this.client_,connection:this,prevState:this.currentState_,state:e}),this.emitter_.emit(ao.CONNECTION_STATE_CHANGED,{prevState:this.currentState_,state:e}),this.currentState_=e))}hitTest(e){return(0===e||"0"===e)&&this.isUplink_||e===this.tinyId_}addEventInternal(e,t){const i=this.client_.getUserId();let s={eventId:e,eventDesc:t,timestamp:n(),userId:i,tinyId:this.client_.getTinyId()};this.isUplink_||(s.remoteUserId=this.userId_,s.remoteTinyId=this.tinyId_),sa(i,s)}getPeerConnection(){return this.peerConnection_}getClient(){return this.client_}getUserId(){return this.userId_}getTinyId(){return this.tinyId_}async logSelectedCandidate(){if(!this.peerConnection_)return;const e=await this.peerConnection_.getStats();for(let[t,i]of e)if(Ya(i)){const t=e.get(i.localCandidateId),s=e.get(i.remoteCandidateId);t&&this.log_.info(`local candidate: ${t.candidateType} ${t.protocol}:${t.ip||t.address}:${t.port} ${t.networkType||""} ${"relay"===t.candidateType?"relayProtocol:"+t.relayProtocol:""}`),s&&this.log_.info(`remote candidate: ${s.candidateType} ${s.protocol}:${s.ip||s.address}:${s.port}`);break}}getCurrentState(){return this.currentState_}waitForPeerConnectionConnected(){return this.waitForPeerConnectionConnectedPromise_||(this.waitForPeerConnectionConnectedPromise_=new Promise(((e,t)=>{if(this.currentState_===L)return e();let i=-1;const s=t=>{t.state===L&&(clearTimeout(i),a(),e())},n=({client:e})=>{e===this.client_&&(clearTimeout(i),a(),t(new En({code:Sn.API_CALL_ABORTED,message:ti({key:$e.CONNECTION_ABORTED,data:"leave room"})})))},a=()=>{Pi.off(Hi,n,this),this.emitter_.off(ao.CONNECTION_STATE_CHANGED,s,this)};i=setTimeout((()=>{a();let e=new En({code:Sn.API_CALL_TIMEOUT,message:"connection timeout"});t(e)}),1e4),Pi.on(Hi,n,this),this.emitter_.on(ao.CONNECTION_STATE_CHANGED,s,this)})),this.waitForPeerConnectionConnectedPromise_=this.waitForPeerConnectionConnectedPromise_.then((e=>(this.waitForPeerConnectionConnectedPromise_=null,e))).catch((e=>{throw this.waitForPeerConnectionConnectedPromise_=null,e}))),this.waitForPeerConnectionConnectedPromise_}getReconnectionCount(){return this.reconnectionCount_}startReconnection(){this.isReconnecting_=!0,this.emitConnectionStateChangedEvent(O),this.reconnect(),this.addEventInternal(this.isUplink_?zn:qn,(this.isUplink_?"uplink":"downlink")+"-connection is reconnecting")}stopReconnection(){this.log_.info("stop reconnection"),this.isReconnecting_=!1,this.reconnectionCount_=0,this.clearReconnectionTimer(),this.signalChannel_.off(Hs,this.reconnect,this)}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){this.emitter_.off(e,t,i)}setDelay({audioDelay:e,videoDelay:t}){this.delay_={audioDelay:e,videoDelay:t}}getDelay(){return this.delay_}get isH264(){var e,t;return!(null===(e=this.peerConnection_)||void 0===e||null===(t=e.remoteDescription)||void 0===t||!t.sdp.includes("H264"))}}var tr=new class{constructor(){this.set_=new Set,Pi.on(Mi,this.add,this),Pi.on(xi,this.add,this),Pi.on($i,this.delete,this),Pi.on(Hi,this.delete,this)}add({client:e,roomId:t}){if("rtc"===e.getMode())return;const i=this.getKey(e.getUserId(),t||e.getRoomId(),e.getSDKAppId(),e.getUseStringRoomId());this.set_.add(i)}delete({client:e}){if("rtc"===e.getMode())return;const t=this.getKey(e.getUserId(),e.getRoomId(),e.getSDKAppId(),e.getUseStringRoomId());this.set_.delete(t)}getKey(e,t,i,s){return`${i}_${t}_${e}_${s}`}isJoined({userId:e,roomId:t,sdkAppId:i,client:s}){return"rtc"!==s.getMode()&&this.set_.has(this.getKey(e,t,i,s.getUseStringRoomId()))}};function ir(e,t,i,s){if(this.useStringRoomId_){if(!(hi(e)&&/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(e)))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_ROOMID_STRING,data:t,link:{className:s,fnName:i}})})}else{if(!(ui(e)&&/^[1-9]\d*$/.test(String(e))&&e<4294967295))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_ROOMID_INTEGER,data:t,link:{className:s,fnName:i}})})}}function sr(e,t,i,s){if(!/^[A-Za-z\d_-]*$/.test(e))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_STREAM_ID,data:t,link:{className:s,fnName:i}})})}var nr,ar,or={TRTC:{createClient:{name:"clientConfig",required:!0,type:Z,properties:{sdkAppId:{required:!0,type:X,allowEmpty:!1},userId:{required:!0,type:Y,allowEmpty:!1},userSig:{required:!0,type:Y,allowEmpty:!1},mode:{required:!0,type:Y,values:["rtc",E]},useStringRoomId:{type:q},autoSubscribe:{type:q},enableAutoPlayDialog:{type:q},streamId:{type:Y},userDefineRecordId:{type:Y},pureAudioPushMode:{type:X,values:[1,2]},enableSEI:{type:q}}},createStream:{name:"streamConfig",required:!0,type:Z,properties:{userId:{type:Y},audio:{type:q},video:{type:q},screen:{type:q},screenAudio:{type:q},microphoneId:{type:Y},cameraId:{type:Y},facingMode:{type:[Y,Z]},audioSource:{instanceOf:window.MediaStreamTrack},videoSource:{instanceOf:window.MediaStreamTrack}},validate(e){if(!li(e.screen)&&e.screen&&li(e.audio)&&(e.audio=!1),!(li(e.audio)&&li(e.video)||li(e.audioSource)&&li(e.videoSource)))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_CREATE_STREAM_SOURCE})});if(!li(e.screen)&&!0===e.screen&&!0===e.video)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_CREATE_STREAM_SCREEN})});if(e.audio&&e.screenAudio)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_CREATE_STREAM_AUDIO})});if(!0!==e.screen&&!0===e.screenAudio)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_CREATE_STREAM_SCREEN_AUDIO})});if(!li(e.screen)&&!0===e.screen&&!this.isScreenShareSupported())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.NOT_SUPPORTED_CAPTURE})})}}},CLIENT:{join:{name:"options",required:!0,type:Z,properties:{roomId:{required:!0,type:[X,Y],allowEmpty:!1,validate:ir},role:{type:[Y],values:[A,v]},privateMapKey:{type:[Y]}},validate(e){if(this.isJoined_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_JOIN})});if(this.checkDestroy(),tr.isJoined({userId:this.userId_,roomId:e.roomId,sdkAppId:this.sdkAppId_,client:this}))throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.REPEAT_JOIN,data:this.userId_})})}},publish:[{name:"stream",required:!0,instanceOf:_e,validate(e){if(!this.isJoined_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_PUBLISH})});if(this.mode_===E&&this.role_===v)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_AUDIENCE})});if(!e.getIsReadyToPublish())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_INITIALIZE})});if(this.notPublishWithoutH264Supported_)throw new En({code:Sn.NOT_SUPPORTED_H264,message:ti({key:$e.NOT_SUPPORTED_H264ENCODE})})}},{name:"options",type:Z,defaultValue:{isAuxiliary:!1},properties:{isAuxiliary:{type:q,defaultValue:!1,validate(e=!1){if(e&&!Ga())throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_AUX})});if(this.uplinkConnection_&&(e&&this.uplinkConnection_.isAuxStreamPublished||!e&&this.uplinkConnection_.isMainStreamPublished))throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_DUPLICATE_PUBLISHING,data:e?o.AUXILIARY:"local"})});const t=this.localScreenStream_||[...this.connections_.values()].findIndex((e=>e.getTrackState().auxiliary))>=0;if(!this.enableMultiAuxStream_&&e&&t)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.DUPLICATE_AUX})})}}}}],unpublish:{name:"stream",required:!0,instanceOf:_e,validate(e){if(e!==this.localStream_&&e!==this.localAuxStream_){if(this.localStream_||this.localAuxStream_)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_UNPUBLISH})});this.log_.warn("Client currently has no published stream, please call publish() first.")}}},subscribe:[{name:"stream",required:!0,instanceOf:me,validate(e){if(!e.getConnection())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOTE_STREAM})});if(this.notSubscribeWithoutH264Supported_)throw new En({code:Sn.NOT_SUPPORTED_H264,message:ti({key:$e.NOT_SUPPORTED_H264DECODE})})}},{name:"options",type:Z,properties:{audio:{type:q},video:{type:q},smallVideo:{type:q}},validate({audio:e,video:t,smallVideo:i}){if(!1===e&&!1===t&&(li(i)||!1===i))throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.SUBSCRIBE_ALL_FALSE})})}}],unsubscribe:{name:"stream",required:!0,instanceOf:me,validate(e){if(!e.getConnection())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOTE_STREAM})})}},switchRole:{name:"role",required:!0,values:[A,v],validate(){if(this.mode_!==E)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_ROLE})});if(!this.isJoined_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_OPERATION_SWITCH_ROLE})})}},startPublishCDNStream:{name:"options",required:!1,properties:{streamId:{type:Y,validate:sr},streamType:{type:Y,values:["main","auxiliary"]},appId:{type:X,allowEmpty:!1},bizId:{type:X,allowEmpty:!1},url:{type:Y,allowEmpty:!1}},validate(){if(this.isDestroyed_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.CLIENT_DESTROYED,data:{funName:"startPublishCDNStream"}})})}},startMixTranscode:{name:"config",required:!0,type:Z,properties:{mode:{type:Y,values:["preset-layout","manual"]},streamId:{type:Y,validate:sr},videoWidth:{type:X,notLessThanZero:!0},videoHeight:{type:X,notLessThanZero:!0},videoBitrate:{type:X,notLessThanZero:!0,allowEmpty:!1},videoFramerate:{type:X,validate(e,t,i,s){if(e<=0||e>30)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.MIX_PARAMS_VIDEO_FRAMERATE,link:{className:s,fnName:i}})})}},videoGOP:{type:X,validate(e,t,i,s){if(e<1||e>8)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.MIX_PARAMS_VIDEO_GOP,link:{className:s,fnName:i}})})}},audioSampleRate:{type:X,notLessThanZero:!0},audioBitrate:{type:X,validate(e,t,i,s){if(e<32||e>192)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.MIX_PARAMS_AUDIO_BITRATE,link:{className:s,fnName:i}})})}},audioChannels:{type:X,values:[1,2]},backgroundColor:{type:X},backgroundImage:{type:Y},mixUsers:{required:!0,type:Q,arrayItem:{require:!0,type:Z,properties:{userId:{required:!0,type:Y},roomId:{type:[Y,X],validate:ir},pureAudio:{type:q},width:{type:X,notLessThanZero:!0},height:{type:X,notLessThanZero:!0},locationX:{type:X,notLessThanZero:!0},locationY:{type:X,notLessThanZero:!0},zOrder:{type:X},streamType:{type:Y,values:["main","auxiliary"]},renderMode:{type:X,values:[0,1,2,4]}}}}},validate(e,t,i,s,n){let a=0,o=0;const r=e.mixUsers,d=[];if(r.forEach(((e,t)=>{if(d.push(e.userId),!e.pureAudio){if(!e.zOrder||e.zOrder<1||e.zOrder>15)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.MIX_PARAMS_USER_Z_ORDER,data:`config.mixUsers[${t}].zOrder`,link:{className:s,fnName:i}})});e.width+e.locationX>a&&(a=e.width+e.locationX),e.height+e.locationY>o&&(o=e.height+e.locationY)}})),d.indexOf(this.getUserId())<0)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.MIX_PARAMS_NOT_SELF,link:{className:s,fnName:i}})});if(e.videoWidth<a||e.videoHeight<o)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.MIX_PARAMS_USER_STREAM,link:{className:s,fnName:i}})})}},sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate(e){if(!za)throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.SEI_NOT_SUPPORT})});if(!this.enableSEI_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.SEI_DISABLED})});if(e.byteLength>1e3)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.SEI_OVERSIZE,data:e.byteLength})});if(0===e.byteLength)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.SEI_EMPTY})});if(!this.uplinkConnection_||!this.localStream_)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.SEI_BEFORE_PUBLISH})});if(!this.localStream_.hasVideo())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.SEI_NOT_VIDEO})});const t=this.uplinkConnection_.isH264;if(!t)throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.SEI_NOT_SUPPORT,data:t})})}},{name:"options",type:Z,properties:{seiPayloadType:{type:X,values:[5,243]}}}]},LOCAL_STREAM:{switchDevice:[{name:"type",required:!0,type:Y,values:[o.AUDIO,o.VIDEO]},{name:"deviceId",required:!0,type:Y,validate(){if(this.screen_&&!this.audio_||this.audioSource_||this.videoSource_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_SWITCH_DEVICE})});if(this.publishState_===se)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_SWITCH_DEVICE_PUBLISHING})});if(!Wa())throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_SWITCH_DEVICE})})}}],setAudioCaptureVolume:{name:"volume",type:X}},STREAM:{play:[{name:"elementId",required:!0,type:[Y,"HTMLDivElement"],validate(e,t,i){if(hi(e)){const s=document.getElementById(e);if(!s)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_ELEMENT_ID,data:{key:t,fnName:i}})});if(!(s instanceof HTMLDivElement))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_ELEMENT_ID_TYPE,data:{key:t,fnName:i,type:Ii(s)}})})}}},{name:"options",type:Z,properties:{objectFit:{type:Y,values:["contain","cover","fill"]},muted:{type:q},mirror:{type:q}}}],addTrack:{name:o.TRACK,instanceOf:window.MediaStreamTrack,validate(e){if(this.isAddingTrack_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_ADD_TRACK_REPETITIVE})});if(this.isRemovingTrack_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_ADD_TRACK_REMOVING})});if(this.publishState_===se)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_ADD_TRACK_PUBLISHING})});const t=this.getMediaStream();if(!t)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_STREAM_INITIALIZED})});if(e.kind===o.AUDIO&&t.getAudioTracks().length>0||e.kind===o.VIDEO&&t.getVideoTracks().length>0)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_ADD_TRACK_NUMBER})});if(!Ha()&&!Ba())throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_TRACK,data:o.ADD})})}},removeTrack:{name:o.TRACK,instanceOf:window.MediaStreamTrack,validate(e){if(this.isAddingTrack_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOVE_AUDIO_ADDING})});if(this.isRemovingTrack_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOVE_AUDIO_ON})});if(this.publishState_===se)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOVE_TRACK_PUBLISHING})});const t=this.getMediaStream();if(!t)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_STREAM_INITIALIZED})});if(-1===t.getTracks().indexOf(e))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_REMOVE_TRACK_NOT_PUBLISHING})});if(!Ha()){if(1===t.getTracks().length)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOVE_TRACK_NUMBER})});if(e.kind===o.AUDIO)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_REMOVE_AUDIO_TRACK})});if(!Ba())throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_TRACK,data:o.REMOVE})})}}},replaceTrack:{name:o.TRACK,instanceOf:window.MediaStreamTrack,validate(e){const t=this.getMediaStream();if(!t)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_INITIALIZE_LOCAL_STREAM})});if(this.publishState_===se)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REPLACE_TRACK})});if(e.kind===o.AUDIO&&t.getAudioTracks().length<=0||e.kind===o.VIDEO&&t.getVideoTracks().length<=0)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_REPLACE_TRACK_NO_TRACK,data:e})});if(!Wa())throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_TRACK,data:o.REPLACE})})}}}};function rr(...e){return function(t,i,s){const n=s.value;return s.value=function(...t){return cr.call(this,e,t,i,this.name_),n.apply(this,t)},s}}function dr(...e){return function(t,i,s){const n=s.value;return s.value=async function(...t){return cr.call(this,e,t,i,this.name_),n.apply(this,t)},s}}function cr(e,t,i,s){try{for(let n=0;n<e.length;n++)lr.call(this,{rule:e[n],value:t[n],key:e[n].name,fnName:i,className:s})}catch(n){throw Vs.error(n),n}}function lr({rule:e,value:t,key:i,fnName:s,className:n}){if(li(t)){if(e.required)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_REQUIRED,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(li(e.defaultValue))return;t=e.defaultValue}if(Array.isArray(e.type)){if(!e.type.map((e=>e.toLowerCase())).includes(Ii(t)))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_TYPE,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})})}else if(!li(e.type)&&Ii(t)!==e.type)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_TYPE,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(!1===e.allowEmpty){const a=ui(t)&&(0===t||Number.isNaN(t)),o=hi(t)&&""===t.trim();if(a||o)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_EMPTY,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})})}if(e.notLessThanZero&&ui(t)&&t<0)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.CANNOT_LESS_THAN_ZERO,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(hi(e.instanceOf)){if(!t||t.name_!==e.instanceOf)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_INSTANCE,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})})}else if(ci(e.instanceOf)&&!(t instanceof e.instanceOf))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_INSTANCE,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});if(e.values&&!e.values.includes(t))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_RANGE,data:{key:i,rule:e,fnName:s,value:t},link:{className:n,fnName:s}})});const{properties:a}=e;oi(a)&&mi(t)&&Object.keys(a).forEach((e=>{lr.call(this,{rule:a[e],value:t&&t[e],key:`${i}.${e}`,fnName:s,className:n})}));const{arrayItem:o}=e;oi(o)&&pi(t)&&t.forEach(((e,t)=>{lr.call(this,{rule:o,value:e,key:`${i}[${t}]`,fnName:s,className:n})})),ci(e.validate)&&e.validate.call(this,t,i,s,n,this)}function hr(e={retries:5,timeout:2e3}){return function(t,i,s){const n=Ls({retryFunction:s.value,settings:e,onError:e.onError,onRetrying:e.onRetrying,onRetryFailed:e.onRetryFailed});return s.value=function(...e){return n.apply(this,e)},s}}const ur=5e3,_r={msg_user_info:0,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0};class mr{constructor(e){this.str_identifier=String(e.userId),this.uint64_tinyid=Number(e.tinyId),this.uint32_role=e.role}}let pr=(nr=hr({timeout:500,retries:3}),ar=class{constructor(e){this.frameWorkType_=e.frameWorkType||30,this.component_=e.component||0,this.client_=e.client,this.keyPrefix_="key_point",this.storageKey_=`${this.keyPrefix_}_${this.client_.getUserId()}`,this.log_=Vs.createLogger({id:"kpm|"+this.client_.getUserId(),userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId()}),Object.getOwnPropertyNames(this.__proto__).forEach((e=>{e.startsWith("handle")&&ci(this[e])&&(this[e]=function({fn:e,context:t}){return async function(...i){try{return await e.apply(t||this,i)}catch(s){Vs.error(`${e.name}() error observed `+s)}}}({fn:this[e],context:this}))})),this.initData(),this.installEvents(),this.intervalId_=Na.run(Le,this.setStorage.bind(this),{delay:2e4})}initData(){var e;this.firstPublishedUserList_=[],this.networkQuality_={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this.basicInfo={string_sdk_version:t,uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",string_domain:location.host,uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:"live"===(null===(e=this.client_)||void 0===e?void 0:e.getMode())?1:0,uint32_joining_duration:0,uint32_networkType:te[ai()],uint32_framework:this.frameWorkType_,uint32_component:this.component_},this.pathJoinRoom_={uint64_start_time:0,uint64_init_audio_start_time:0,uint64_init_audio_end_time:0,uint64_init_camera_start_time:0,uint64_init_camera_end_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_init_audio_ret:0,int32_init_camera_ret:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this.pathLeaveRoom_={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this.pathMainVideoMap_=new Map,this.pathMainAudioMap_=new Map,this.pathAuxiliaryMap_=new Map,this.localStreamStats_={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this.remoteStreamStatsMap_=new Map}installEvents(){Pi.on(Mi,this.handleJoinStart,this),Pi.on(Ji,this.handleWSStart,this),Pi.on(Ki,this.handleWSEnd,this),Pi.on(Ui,this.handleJoinSendCMD,this),Pi.on(Vi,this.handleJoinReceivedCMDResponce,this),Pi.on(xi,this.handleJoinSuccess,this),Pi.on($i,this.handleJoinFailed,this),Pi.on(Wi,this.handleReceivedPublishUserList,this),Pi.on(ys,this.handleConnectionStateChanged,this),Pi.on(Fi,this.handleLeaveStart,this),Pi.on(Hi,this.handleLeaveSuccess,this),Pi.on(Bi,this.handleLeaveSendCMD,this),Pi.on(Rs,this.handleSendSubscribeCMD,this),Pi.on(ss,this.handleVideoPlaying,this),Pi.on(ns,this.handleAudioPlaying,this),Pi.on(bs,this.handleNetworkQuality,this),Pi.on(Gi,this.handleHeartbeatStats,this),Pi.on(os,this.handleRemoteStreamAdded,this),Pi.on(rs,this.handleRemoteStreamSubscribeStart,this),Pi.on(ds,this.handleRemoteStreamSubscribed,this),Pi.on(hs,this.handleRemoteStreamRemoved,this),Pi.on(Es,this.handleVideoLoadedData,this),Pi.on(Ss,this.handlePlayStream,this),Pi.on(ji,this.handlePublishStart,this),Pi.on(_s,this.handleLocalStreamInitStart,this),Pi.on(ms,this.handleLocalStreamInitEnd,this),Pi.on(ps,this.handleLocalStreamInitFailed,this)}uninstallEvents(){Pi.off(Mi,this.handleJoinStart,this),Pi.off(Ji,this.handleWSStart,this),Pi.off(Ki,this.handleWSEnd,this),Pi.off(Ui,this.handleJoinSendCMD,this),Pi.off(Vi,this.handleJoinReceivedCMDResponce,this),Pi.off(Wi,this.handleReceivedPublishUserList,this),Pi.off(ys,this.handleConnectionStateChanged,this),Pi.off(Fi,this.handleLeaveStart,this),Pi.off(Hi,this.handleLeaveSuccess,this),Pi.off(xi,this.handleJoinSuccess,this),Pi.off($i,this.handleJoinFailed,this),Pi.off(Bi,this.handleLeaveSendCMD,this),Pi.off(Rs,this.handleSendSubscribeCMD,this),Pi.off(ss,this.handleVideoPlaying,this),Pi.off(ns,this.handleAudioPlaying,this),Pi.off(bs,this.handleNetworkQuality,this),Pi.off(Gi,this.handleHeartbeatStats,this),Pi.off(os,this.handleRemoteStreamAdded,this),Pi.off(rs,this.handleRemoteStreamSubscribeStart,this),Pi.off(ds,this.handleRemoteStreamSubscribed,this),Pi.off(hs,this.handleRemoteStreamRemoved,this),Pi.off(Es,this.handleVideoLoadedData,this),Pi.off(Ss,this.handlePlayStream,this),Pi.off(ji,this.handlePublishStart,this),Pi.off(_s,this.handleLocalStreamInitStart,this),Pi.off(ms,this.handleLocalStreamInitEnd,this),Pi.off(ps,this.handleLocalStreamInitFailed,this)}destroy(){this.uninstallEvents(),Na.clearTask(this.intervalId_),this.client_=null}handleJoinStart(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_start_time&&(this.pathJoinRoom_.uint64_start_time=Date.now(),this.checkStorage())}handleWSStart({client:e}){this.hitTest(e)&&0===this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleWSEnd({client:e,error:t}){this.hitTest(e)&&0===this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_end_time=Date.now(),t&&(this.pathJoinRoom_.int32_send_request_acc_ip_cmd_ret=t instanceof En?Number(t.getExtraCode()||t.getCode()):Sn.UNKNOWN,this.pathJoinRoom_.int32_end_ret=2))}handleJoinSendCMD(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time=Date.now(),this.pathJoinRoom_.int32_send_request_enter_room_cmd_ret=e.code,0!==e.code&&(this.pathJoinRoom_.int32_end_ret=3))}handleJoinSuccess(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_end_time&&(this.pathJoinRoom_.uint64_end_time=Date.now(),this.pathJoinRoom_.int32_end_ret=0)}handleJoinFailed({client:e}){this.hitTest(e)&&(this.pathJoinRoom_.uint64_end_time=Date.now(),0===this.pathJoinRoom_.int32_end_ret&&(this.pathJoinRoom_.int32_end_ret=3),this.prepareReport(),this.report())}handleReceivedPublishUserList(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_recv_userlist_time&&(this.pathJoinRoom_.uint64_recv_userlist_time=Date.now(),this.firstPublishedUserList_=e.data.data&&e.data.data.userList||[])}handleConnectionStateChanged({client:e,state:t,connection:i}){if(this.hitTest(e)&&t===L){this.client_.getUplinkConnection()===i&&0===this.pathJoinRoom_.uint64_send_first_video_frame_time&&this.localStreamStats_.publishStartTime>this.pathJoinRoom_.uint64_end_time&&this.localStreamStats_.publishStartTime-this.pathJoinRoom_.uint64_end_time<=100&&(this.pathJoinRoom_.uint64_send_first_video_frame_time=Date.now());const e=this.pathMainVideoMap_.get(`${i.getUserId()}_${D}`);e&&0===e.statsToReport.uint64_pc_connected_time&&(e.statsToReport.uint64_pc_connected_time=Date.now())}}handleLeaveStart(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_start_time=Date.now())}handleLeaveSuccess(e){this.hitTest(e.client)&&0===this.pathLeaveRoom_.uint64_end_time&&(this.pathLeaveRoom_.uint64_end_time=Date.now(),0!==this.pathJoinRoom_.uint64_end_time?this.basicInfo.uint32_joining_duration=this.pathLeaveRoom_.uint64_end_time-this.pathJoinRoom_.uint64_end_time:this.log_.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_start_time=Date.now(),this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded({client:e,stream:t}){if(this.hitTest(e)){const e=t.getUserId(),i=t.getType(),s=`${e}_${i}`,n=this.remoteStreamStatsMap_.get(s);if(n)n.stream=t;else{const n={userId:e,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:{..._r},stream:t};n.statsToReport.msg_user_info=new mr({userId:e,tinyId:t.getTinyId(),role:T}),n.statsToReport.uint32_stream_type=i===D?2:7,this.remoteStreamStatsMap_.set(s,n)}}}handleRemoteStreamSubscribeStart({client:e,stream:t}){if(this.hitTest(e)){const e=`${t.getUserId()}_${t.getType()}`,i=this.remoteStreamStatsMap_.get(e);i&&0===i.subscribeStartTime&&(i.subscribeStartTime=Date.now())}}handleSendSubscribeCMD(e){if(this.hitTest(e.client)){const t=new mr(e),i=Date.now(),s=`${e.userId}_${D}`;e.trackState.video&&e.subscribeState.video&&!this.pathMainVideoMap_.has(s)&&this.pathMainVideoMap_.set(s,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0,uint64_pc_connected_time:0},userId:e.userId,sendSubscribeCMDTime:i}),e.trackState.audio&&e.subscribeState.audio&&!this.pathMainAudioMap_.has(s)&&this.pathMainAudioMap_.set(s,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_play_first_frame_time:0},userId:e.userId,sendSubscribeCMDTime:i});const n=`${e.userId}_${C}`;e.trackState.auxiliary&&e.subscribeState.auxiliary&&!this.pathAuxiliaryMap_.has(n)&&this.pathAuxiliaryMap_.set(n,{sendSubscribeCMDTime:i})}}handleRemoteStreamSubscribed({client:e,stream:t}){if(this.hitTest(e)){const e=`${t.getUserId()}_${t.getType()}`,i=this.remoteStreamStatsMap_.get(e);i&&0===i.subscribedTime&&(i.subscribedTime=Date.now(),i.stream=t)}}handleRemoteStreamRemoved({client:e,stream:t}){if(this.hitTest(e)){const e=t.getUserId(),i=t.getType(),s=this.remoteStreamStatsMap_.get(`${e}_${i}`);s&&(s.stream=null)}}handlePlayStream({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`;if(this.remoteStreamStatsMap_.has(t)){const e=this.remoteStreamStatsMap_.get(t);0===e.playStreamTime&&(e.playStreamTime=Date.now())}}handleVideoLoadedData({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`;if(this.pathMainVideoMap_.has(t)){const e=this.pathMainVideoMap_.get(t);0===e.statsToReport.uint64_combine_first_frame_time&&(e.statsToReport.uint64_combine_first_frame_time=Date.now())}}handleVideoPlaying({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`,i=Date.now();if(this.pathMainVideoMap_.has(t)){const e=this.pathMainVideoMap_.get(t);if(0===e.statsToReport.uint64_render_first_frame_time&&(e.statsToReport.uint64_render_first_frame_time=i),this.remoteStreamStatsMap_.has(t)){const{statsToReport:s,playStreamTime:n,subscribedTime:a}=this.remoteStreamStatsMap_.get(t);0===s.uint32_video_render_first&&n-a<=100&&(s.uint32_video_render_first=i-e.sendSubscribeCMDTime)}}if(e.getType()===C&&this.pathAuxiliaryMap_.has(t)&&this.remoteStreamStatsMap_.has(t)){const{statsToReport:e,playStreamTime:s,subscribedTime:n}=this.remoteStreamStatsMap_.get(t);0===e.uint32_video_render_first&&s-n<=100&&(e.uint32_video_render_first=i-this.pathAuxiliaryMap_.get(t).sendSubscribeCMDTime)}}handleAudioPlaying(e){if(!e.stream.isRemote()||!e.stream.getConnection()||!this.hitTest(e.stream.getConnection().getClient()))return;const t=`${e.stream.getConnection().getUserId()}_${e.stream.getType()}`;if(this.pathMainAudioMap_.has(t)){const e=this.pathMainAudioMap_.get(t);0===e.statsToReport.uint64_play_first_frame_time&&(e.statsToReport.uint64_play_first_frame_time=Date.now())}}handleNetworkQuality(e){this.hitTest(e.client)&&(this.networkQuality_.totalUplinkLoss+=e.uplinkLoss,this.networkQuality_.totalUplinkRTT+=e.uplinkRTT,this.networkQuality_.count++,e.downlinkLossAndRTTMap.forEach((({rtt:e,loss:t,userId:i})=>{const s=this.networkQuality_.totalDownlinkRTTAndLossMap.get(i);s?(s.totalRTT+=e,s.totalLoss+=t,s.count++):this.networkQuality_.totalDownlinkRTTAndLossMap.set(i,{totalRTT:e,totalLoss:t,count:1})})))}handleHeartbeatStats(e){if(this.hitTest(e.client)){const{msg_up_stream_info:t,msg_down_stream_info:i}=e.stats;if(t.msg_video_status[0]){const{uint32_video_codec_bitrate:e,uint32_video_enc_fps:i,uint32_video_width:s,uint32_video_height:n}=t.msg_video_status[0];this.localStreamStats_.totalVideoBitrate+=e,this.localStreamStats_.totalVideoFPS+=i,this.localStreamStats_.totalVideoWidth+=s,this.localStreamStats_.totalVideoHeight+=n,this.localStreamStats_.videoCount++}if(t.msg_audio_status){const e=t.msg_audio_status.audioLevel;Math.floor(100*e)>0&&(this.localStreamStats_.totalAudioLevel+=e,this.localStreamStats_.audioLevelCount++)}i.forEach((e=>{const{msg_user_info:t,msg_audio_status:i,msg_video_status:s}=e,n=t.str_identifier;if(s.forEach((e=>{const t=2===e.uint32_video_stream_type,i=7===e.uint32_video_stream_type,s=`${n}_${t?D:C}`;if(this.remoteStreamStatsMap_.has(s)){var a,o;const n=this.remoteStreamStatsMap_.get(s);(t&&null!==(a=n.stream)&&void 0!==a&&a.isMainVideoSubscribed||i&&null!==(o=n.stream)&&void 0!==o&&o.isAuxVideoSubscribed)&&(n.totalVideoFPS+=e.uint32_video_receive_fps,n.totalVideoBitrate+=e.uint32_video_codec_bitrate,n.videoCount++,0===n.statsToReport.uint32_video_width&&(n.statsToReport.uint32_video_width=e.uint32_video_width),0===n.statsToReport.uint32_video_height&&(n.statsToReport.uint32_video_height=e.uint32_video_height))}})),i){const e=`${n}_${D}`;if(this.remoteStreamStatsMap_.has(e)){var a;const t=this.remoteStreamStatsMap_.get(e);null!==(a=t.stream)&&void 0!==a&&a.isMainAudioSubscribed&&(t.totalAudioBitrate+=i.uint32_audio_codec_bitrate,t.audioCount++,Math.floor(100*i.audioLevel)>0&&(t.totalAudioLevel+=i.audioLevel,t.audioLevelCount++))}}}))}}handlePublishStart({client:e}){this.hitTest(e)&&0===this.localStreamStats_.publishStartTime&&(this.localStreamStats_.publishStartTime=Date.now())}handleLocalStreamInitStart({audio:e,video:t}){e&&0===this.pathJoinRoom_.uint64_init_audio_start_time&&(this.pathJoinRoom_.uint64_init_audio_start_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_start_time&&(this.pathJoinRoom_.uint64_init_camera_start_time=Date.now())}handleLocalStreamInitEnd({audio:e,video:t}){e&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}handleLocalStreamInitFailed({audio:e,video:t,error:i}){const s=i instanceof En?i.getExtraCode()||i.getCode():{NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5}[i.name]||Sn.UNKNOWN;e&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.int32_init_audio_ret=s,this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.int32_init_camera_ret=s,this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}hasVideoFlag(e){return this.firstPublishedUserList_.findIndex((t=>t.userId===e&&1&t.flag))>=0}hasAudioFlag(e){return this.firstPublishedUserList_.findIndex((t=>t.userId===e&&8&t.flag))>=0}hasAuxFlag(e){return this.firstPublishedUserList_.findIndex((t=>t.userId===e&&4&t.flag))>=0}hitTest(e){return e===this.client_}async checkStorage(){try{const e=wa.getItem(this.storageKey_);e&&(await this.upload(e),wa.deleteItem(this.storageKey_))}catch(e){this.log_.warn(e)}}setStorage(){this.prepareReport();const e=this.getReportData();0!==e.msg_path_enter_room.uint64_start_time&&wa.setItem(this.storageKey_,e)}prepareReport(){if(this.networkQuality_.count>0&&(this.basicInfo.uint32_avg_rtt=Math.floor(this.networkQuality_.totalUplinkRTT/this.networkQuality_.count),this.basicInfo.uint32_avg_up_loss=Math.floor(this.networkQuality_.totalUplinkLoss/this.networkQuality_.count)),this.localStreamStats_.videoCount>0){this.localStreamStats_.statsToReport.uint32_video_big_capture_fps=Math.floor(this.localStreamStats_.totalVideoFPS/this.localStreamStats_.videoCount),this.localStreamStats_.statsToReport.uint32_video_big_bitrate=Math.floor(this.localStreamStats_.totalVideoBitrate/this.localStreamStats_.videoCount);const e=Math.floor(this.localStreamStats_.totalVideoWidth/this.localStreamStats_.videoCount),t=Math.floor(this.localStreamStats_.totalVideoHeight/this.localStreamStats_.videoCount);this.localStreamStats_.statsToReport.uint32_video_big_resolution=e<<16|t}this.localStreamStats_.audioLevelCount>0&&(this.localStreamStats_.statsToReport.uint32_audio_capture_db=Math.floor(this.localStreamStats_.totalAudioLevel/this.localStreamStats_.audioLevelCount*100)),this.remoteStreamStatsMap_.forEach(((e,t)=>{const i=e.userId;if(this.networkQuality_.totalDownlinkRTTAndLossMap.has(i)){const{totalLoss:t,count:s}=this.networkQuality_.totalDownlinkRTTAndLossMap.get(i);e.statsToReport.uint32_avg_down_loss=Math.floor(t/s)}e.videoCount>0&&(e.statsToReport.uint32_video_avg_fps=Math.floor(e.totalVideoFPS/e.videoCount),e.statsToReport.uint32_video_avg_bitrate=Math.floor(e.totalVideoBitrate/e.videoCount)),e.audioCount>0&&(e.statsToReport.uint32_audio_recv_bitrate=e.statsToReport.uint32_audio_bitrate=Math.floor(e.totalAudioBitrate/e.audioCount)),e.audioLevelCount>0&&(e.statsToReport.uint32_audio_play_db=Math.floor(e.totalAudioLevel/e.audioLevelCount*100));const s=this.client_.getCallDurationCalculator();s&&(e.statsToReport.uint32_audio_play_time=s.getDuration(t,o.AUDIO),e.statsToReport.uint32_video_play_time=s.getDuration(t,o.VIDEO)),e.statsToReport.uint32_video_render_first=Math.min(e.statsToReport.uint32_video_render_first,ur);const n=this.client_.getBadCaseDetector();if(n){const{dataFreeze:i,count:s}=n.getDataFreezeDuration(t),{renderFreeze:a}=n.getRenderFreezeDuration(t);e.statsToReport.uint32_video_block_count=s,e.statsToReport.uint32_video_block_time=Math.min(i,e.statsToReport.uint32_video_play_time),e.statsToReport.uint32_video_external_block_time=Math.min(a,e.statsToReport.uint32_video_play_time),n.isBlackStream(t)&&0===e.statsToReport.uint32_video_avg_fps?e.statsToReport.uint32_video_black_screen_subjective=1:e.statsToReport.uint32_video_black_screen_subjective=0}(0===e.subscribeStartTime||e.subscribeStartTime-e.streamAddedTime>100||0===e.playStreamTime)&&(this.pathMainAudioMap_.delete(t),this.pathMainVideoMap_.delete(t),e.statsToReport.uint32_video_render_first=0)})),this.pathMainAudioMap_.forEach(((e,t)=>{this.hasAudioFlag(e.userId)?e.statsToReport.uint64_play_first_frame_time-e.statsToReport.uint64_start_enter_time>ur&&(e.statsToReport.uint64_play_first_frame_time=e.statsToReport.uint64_start_enter_time+ur):this.pathMainAudioMap_.delete(t)})),this.pathMainVideoMap_.forEach(((e,t)=>{this.hasVideoFlag(e.userId)?e.statsToReport.uint64_render_first_frame_time-e.statsToReport.uint64_start_enter_time>ur&&(e.statsToReport.uint64_render_first_frame_time=e.statsToReport.uint64_start_enter_time+ur):this.pathMainVideoMap_.delete(t)})),this.pathJoinRoom_.uint64_end_time-this.pathJoinRoom_.uint64_start_time>ur&&(this.pathJoinRoom_.uint64_end_time=this.pathJoinRoom_.uint64_start_time+ur)}getReportData(){const e=this.client_.getSignalInfo();return{uint32_sdk_app_id:Number(this.client_.getSDKAppId()),msg_user_info:new mr({userId:this.client_.getUserId(),tinyId:this.client_.getTinyId(),role:this.client_.getRole()===A?T:f}),msg_basic_info:this.basicInfo,uint32_acc_ip:Ti(e.relayIp),uint32_client_ip:Ti(e.clientIp,"small"),uint32_acc_port:0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*2**31),msg_path_enter_room:this.pathJoinRoom_,msg_path_exit_room:this.pathLeaveRoom_,msg_path_recv_video:[...this.pathMainVideoMap_.values()].map((e=>e.statsToReport)),msg_quality_statistics:[...this.remoteStreamStatsMap_.values()].map((e=>e.statsToReport)),str_room_name:String(this.client_.getRoomId()),msg_path_recv_audio:[...this.pathMainAudioMap_.values()].map((e=>e.statsToReport)),uint32_info_client_ip:Ti(e.clientIp,"small"),error_code:[],msg_local_statistics:this.localStreamStats_.statsToReport,msg_function_state:gr.getStateArray()}}async report(){try{const e=this.getReportData();await this.upload(e),wa.deleteItem(this.storageKey_),gr.clearStateArray(),this.initData()}catch(e){this.log_.warn(e)}}async upload(e){if(zt||0===e.msg_path_enter_room.uint64_start_time||[ge,Ie,Se].findIndex((e=>e===location.host))>=0)return;const t=Number(this.client_.getSDKAppId()),i=ni(t,p),s=await wi({url:i,body:JSON.stringify(e)});if("ok"!==s.data)throw`key point upload failed: ${s.data}`}},e(ar.prototype,"upload",[nr],Object.getOwnPropertyDescriptor(ar.prototype,"upload"),ar.prototype),ar);class gr{static stateMap=new Map;static handleFunctionState({className:e,fnName:t,params:i}){var s,n,a,o;if(zt||[ge,Ie,Se].findIndex((e=>e===location.host))>=0)return;let r,d=[];if(e)switch(t){case"createClient":null!==(s=i[0])&&void 0!==s&&s.mode&&d.push(`${e}.${t}.${i[0].mode}`),null!==(n=i[0])&&void 0!==n&&n.useStringRoomId?d.push(`${e}.${t}.stringRoomId`):d.push(`${e}.${t}.intRoomId`),null!==(a=i[0])&&void 0!==a&&a.autoSubscribe?d.push(`${e}.${t}.autoSubscribe`):d.push(`${e}.${t}.manualSubscribe`);break;case"publish":null!==(o=i[1])&&void 0!==o&&o.isAuxiliary?d.push(`${e}.${t}.isAuxiliary`):d.push(`${e}.${t}`);break;case"setAudioProfile":case"setVideoProfile":case"setScreenProfile":case"setVideoContentHint":hi(i[0])&&d.push(`${e}.${t}.${i[0]}`);break;default:d.push(`${e}.${t}`)}else d.push(t);for(let c=0;c<d.length;c++){if(r=Ve[d[c]],!r)return;if(this.stateMap.has(r)){this.stateMap.get(r).int32_call_times+=1}else this.stateMap.set(r,{int32_id:r,int32_call_times:1})}}static getStateArray(){return Array.from(this.stateMap.values())}static clearStateArray(){this.stateMap.clear()}}function Ir(e){return function(t,i,s){const n=s.value;return s.value=function(...t){try{e||(e=this.name_),gr.handleFunctionState({className:e,fnName:i,params:t}),e=void 0}catch(s){this.log_.info(s)}return n.apply(this,t)},s}}var Sr,Er,Tr,fr;let Ar=(Sr=dr(...or.STREAM.play),Er=Ir(),Tr=Ir(),fr=class{constructor(e){this.name_=pe,this.userId_=e.userId,this.isRemote_=e.isRemote,this.type_=e.type,this.log_=Vs.createLogger({id:`s${e.seq?e.seq:""}|${this.userId_}`,userId:li(e.client)?void 0:e.client.getUserId(),sdkAppId:li(e.client)?void 0:e.client.getSDKAppId(),isLocal:!this.isRemote_,type:this.isRemote_?this.type_:""}),this.client_=null,li(e.client)||(this.client_=e.client),this.mediaStream_=null,this.div_=null,this.isPlaying_=!1,this.connection_=null,this.audioPlayer_=null,this.videoPlayer_=null,this.muted_=!1,this.objectFit_="cover",this.mirror_=!1,this.id_="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})),this.audioOutputDeviceId_=0,this.audioVolume_=1,this.emitter_=bi(new Li,this.name_),this.connectionState_=w,this.installEvents(),li(e.mirror)||this.log_.warn(`TRTC.createStream "mirror" option was deprecated since v4.12.1，please use localStream.play to set up preview mirror. refer to ${Te}/en/LocalStream.html#play. TRTC.createStream 接口的 mirror 选项从 v4.12.1 开始被废弃，请使用 localStream.play 设置本地流预览镜像，参考文档：${Te}/zh-cn/LocalStream.html#play。`)}installEvents(){Pi.on(Ds,this.restartPlayback,this)}uninstallEvents(){Pi.off(Ds,this.restartPlayback,this)}getType(){return this.type_}getLogger(){return this.log_}get isSubscribed(){return this.type_===D&&this.connection_.isMainStreamSubscribed||this.type_===C&&this.connection_.isAuxStreamSubscribed}get isMainVideoSubscribed(){const e=this.getSubscribedState();return this.type_===D&&e&&e.video}get isMainAudioSubscribed(){const e=this.getSubscribedState();return this.type_===D&&e&&e.audio}get isAuxVideoSubscribed(){const e=this.getSubscribedState();return this.type_===C&&e&&e.auxiliary}get isSmallVideoSubscribed(){const e=this.getSubscribedState();return this.type_===D&&e&&e.smallVideo}emitConnectionStateChanged(e){e.state!==this.connectionState_&&(e.state!==w&&this.isRemote_&&!this.isSubscribed||(this.emitter_.emit(lo,e),this.connectionState_=e.state))}setConnection(e){this.connection_!==e&&(e instanceof er?(null!==this.connection_&&this.connection_.off(ao.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this),e.on(ao.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this)):null===e&&this.connection_.off(ao.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this),this.connection_=e)}getConnection(){return this.connection_}async play(e,t){if(this.log_.info(`stream ${this.isPlaying_?"update":"start to"} play with elementId: ${e} and options: ${JSON.stringify(t)}.`),this.isPlaying_){if(t&&!li(t.muted)&&(this.muted_=t.muted),t&&!li(t.objectFit)&&(this.objectFit_=t.objectFit),this.isScreenShare()?this.mirror_=!1:t&&!li(t.mirror)&&(this.mirror_=t.mirror),this.audioPlayer_&&this.audioPlayer_.setMuted(this.muted_),this.videoPlayer_&&(this.videoPlayer_.setObjectFit(this.objectFit_),this.videoPlayer_.setMirror(this.mirror_)),this.elementId_!==e){let t=e;hi(e)&&(t=document.getElementById(e)),t.appendChild(this.div_),this.elementId_=e}return}this.isPlaying_=!0;const i=document.createElement("div");i.setAttribute("id",`player_${this.id_}`),i.setAttribute("style","width: 100%; height: 100%; position: relative; background-color: black; overflow: hidden;");let s=e;hi(e)&&(s=document.getElementById(e)),s.appendChild(i),this.elementId_=e,this.div_=i,this.isRemote_||(this.muted_=!0),t&&!li(t.muted)&&(this.muted_=t.muted),this.isScreenShare()&&(this.objectFit_="contain"),t&&!li(t.objectFit)&&(this.objectFit_=t.objectFit),this.isScreenShare()?this.mirror_=!1:(this.isRemote_||(this.mirror_=!0),t&&!li(t.mirror)&&(this.mirror_=t.mirror)),Pi.emit(Ss,{stream:this}),await Promise.all([this.playAudio(),this.playVideo()]),Pi.emit(ts,{stream:this})}async playAudio(){if(!this.hasAudio()||this.isRemote_&&!this.isMainAudioSubscribed)return;const e=this.getAudioTrack();if(!this.audioPlayer_&&e){var t;this.log_.info("create AudioPlayer and play"),this.audioPlayer_=new No({stream:this,track:e,gainedTrack:null===(t=this.gain_)||void 0===t?void 0:t.audioTrack,div:this.div_,muted:this.muted_,outputDeviceId:this.audioOutputDeviceId_,volume:this.audioVolume_}),this.audioPlayer_.on(_o,(e=>{const t={type:o.AUDIO,state:e.state,reason:e.reason};Pi.emit(is,{stream:this,...t}),this.emitter_.emit(ro,t)}));try{await this.audioPlayer_.play()}catch(i){throw this.client_&&this.client_.getEnableAutoPlayDialog()&&new Xo,this.emitter_.emit(uo,i),i}}}async playVideo(){if(!this.hasVideo()||this.isRemote_&&!this.isMainVideoSubscribed&&!this.isAuxVideoSubscribed&&!this.isSmallVideoSubscribed)return;const e=this.getVideoTrack();if(!this.videoPlayer_&&e){Pi.emit(Ts,{stream:this}),this.log_.info("create VideoPlayer and play"),this.videoPlayer_=new qo({stream:this,track:e,div:this.div_,muted:this.muted_,objectFit:this.objectFit_,mirror:this.mirror_}),this.videoPlayer_.on(_o,(e=>{const t={type:o.VIDEO,state:e.state,reason:e.reason};Pi.emit(is,{stream:this,...t}),this.emitter_.emit(ro,t)}));try{await this.videoPlayer_.play()}catch(t){throw this.client_&&this.client_.getEnableAutoPlayDialog()&&new Xo,this.emitter_.emit(uo,t),t}}}stopAudio(){this.audioPlayer_&&(this.log_.info("stop AudioPlayer"),this.audioPlayer_.stop(),this.audioPlayer_=null)}stopVideo(){this.videoPlayer_&&(this.log_.info("stop VideoPlayer"),this.videoPlayer_.stop(),this.videoPlayer_=null)}restartPlayback(){this.audioPlayer_&&!this.audioPlayer_.isPlaying&&this.restartAudio(),this.videoPlayer_&&!this.videoPlayer_.isPlaying&&this.restartVideo()}restartAudio(){this.isPlaying_&&(this.stopAudio(),this.playAudio().catch((e=>{})))}restartVideo(){this.isPlaying_&&(this.stopVideo(),this.playVideo().catch((e=>{})))}stop(){this.isPlaying_&&(this.isPlaying_=!1,this.stopAudio(),this.stopVideo(),this.div_.parentNode.removeChild(this.div_))}async resume(){this.isPlaying_&&(this.log_.info("resume"),this.audioPlayer_&&await this.audioPlayer_.resume(),this.videoPlayer_&&await this.videoPlayer_.resume())}close(){this.log_.info("close stream"),this.isPlaying_&&this.stop(),this.isRemote_||(this.mediaStream_&&(this.mediaStream_.preventEvent=1,this.mediaStream_.getTracks().forEach((e=>{e.stop()})),this.mediaStream_=null),this.uninstallEvents())}muteAudio(){return this.addRemoteEvent(!0,o.AUDIO),this.doEnableTrack(o.AUDIO,!1)}muteVideo(){return this.addRemoteEvent(!0,o.VIDEO),this.doEnableTrack(o.VIDEO,!1)}unmuteAudio(){return this.addRemoteEvent(!1,o.AUDIO),this.doEnableTrack(o.AUDIO,!0)}unmuteVideo(){return this.addRemoteEvent(!1,o.VIDEO),this.doEnableTrack(o.VIDEO,!0)}addRemoteEvent(e,t){if(this.isRemote_&&this.client_){const i=this.client_.getUserId();let s,n=`${e?o.MUTE:o.UNMUTE} remote ${t}`;s=t===o.AUDIO?e?Un:xn:e?Mn:Vn,sa(i,{eventId:s,eventDesc:n,timestamp:(new Date).getTime(),userId:i,tinyId:this.client_.getTinyId(),remoteUserId:this.userId_,remoteTinyId:this.connection_.getTinyId()})}}doEnableTrack(e,t){let i=!1;return e===o.AUDIO?this.mediaStream_.getAudioTracks().forEach((e=>{i=!0,e.enabled=t})):this.mediaStream_.getVideoTracks().forEach((e=>{i=!0,e.enabled=t})),i}getId(){return this.id_}getUserId(){return this.userId_}getTinyId(){return this.connection_?this.connection_.getTinyId():""}isPlaying(){return this.isPlaying_}async setAudioOutput(e){this.log_.info(`setAudioOutput ${e}`),this.audioOutputDeviceId_=e,this.audioPlayer_&&await this.audioPlayer_.setSinkId(e);const t=await fo();this.log_.info(`speakers: ${JSON.stringify(t)}`)}setAudioVolume(e){this.audioVolume_=e,this.log_.info(`setAudioVolume to ${e}`),this.audioPlayer_&&this.audioPlayer_.setVolume(e)}getAudioLevel(){let e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getAudioLevel()),e}getInternalAudioLevel(){let e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getInternalAudioLevel()),e}hasAudio(){if(this.isRemote_){if(!this.connection_)return!1;const e=this.connection_.getTrackState();return this.type_===D&&e.audio}return!!this.getAudioTrack()}hasVideo(){if(this.isRemote_){if(!this.connection_)return!1;const e=this.connection_.getTrackState();return this.type_===C?e.auxiliary:e.video}return!!this.getVideoTrack()}getSubscribedState(){return this.isRemote_&&this.connection_?this.connection_.getSubscribeState():null}getAudioTrack(){let e=null;if(this.mediaStream_){const t=this.mediaStream_.getAudioTracks();t.length>0&&(e=t[0])}return e}getVideoTrack(){let e=null;if(this.mediaStream_){const t=this.mediaStream_.getVideoTracks();t.length>0&&(e=t[0])}return e}getVideoFrame(){return this.videoPlayer_?this.videoPlayer_.getVideoFrame():null}getMediaStream(){return this.mediaStream_}setMediaStream(e){e!==this.mediaStream_&&(this.mediaStream_&&this.mediaStream_.getTracks().forEach((e=>e.stop())),this.mediaStream_=e)}updateVideoPlayingState(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play video"),this.playVideo().catch((e=>{}))):(this.log_.info("playing state updated, stop video"),this.stopVideo()))}updateAudioPlayingState(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play audio"),this.playAudio().catch((e=>{}))):(this.log_.info("playing state updated, stop audio"),this.stopAudio()))}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}isRemote(){return this.isRemote_}isScreenShare(){return!this.isRemote_&&this.screen_||this.isRemote_&&this.getType()===o.AUXILIARY}getDiv(){return this.div_}getObjectFit(){return this.objectFit_}getMuted(){return this.muted_}getClient(){return this.client_}},e(fr.prototype,"play",[Sr],Object.getOwnPropertyDescriptor(fr.prototype,"play"),fr.prototype),e(fr.prototype,"setAudioOutput",[Er],Object.getOwnPropertyDescriptor(fr.prototype,"setAudioOutput"),fr.prototype),e(fr.prototype,"getVideoFrame",[Tr],Object.getOwnPropertyDescriptor(fr.prototype,"getVideoFrame"),fr.prototype),fr);class vr extends Ar{constructor(e){const t={isRemote:!0,type:e.type};super({...e,...t}),this.name_=me,this.isStreamAddedEventEmitted_=!1,this.isAbleToCallSubscription_=!0}installEvents(){super.installEvents(),Pi.on(ds,this.handleStreamSubscribed,this),Pi.on(cs,this.handleStreamUnsubscribed,this)}uninstallEvents(){super.uninstallEvents(),Pi.off(ds,this.handleStreamSubscribed,this),Pi.off(cs,this.handleStreamUnsubscribed,this)}handleStreamSubscribed(e){e.client===this.client_&&e.stream===this&&this.connection_.getCurrentState()===L&&this.emitConnectionStateChanged({prevState:w,state:L})}handleStreamUnsubscribed(e){e.client===this.client_&&e.stream===this&&this.emitConnectionStateChanged({prevState:L,state:w})}getType(){return super.getType()}getIsAbleToCallSubscription(){return this.isAbleToCallSubscription_}setIsAbleToCallSubscription(e){this.isAbleToCallSubscription_=e}setIsStreamAddedEventEmitted(e){this.isStreamAddedEventEmitted_=e}getIsStreamAddedEventEmitted(){return this.isStreamAddedEventEmitted_}getAudioTrack(){if(!this.connection_)return null;return this.connection_.getTrackState().audio?super.getAudioTrack():null}getVideoTrack(){if(!this.connection_)return null;const e=this.connection_.getTrackState();return(this.type_!==D||e.video)&&(this.type_!==C||e.auxiliary)?super.getVideoTrack():null}close(){super.close()}}class yr{constructor(e){this.client_=e.client,this.subscribedStreams_=new Map,this.unsubscribedStreams_=new Map,this.subscriptedOptions_=new Map,this.autoRecoveryFlags_=new Map}get isEnabled(){return"webrtc"!==this.client_.getEnv()}async recover(e){const t=e.getUserId(),i=e.getType();if(!this.hasAutoRecoveryFlag(t,i))return;const s=this.getUnsubscribedStream(t,i)?"unsubscribe":"subscribe";try{Vs.warn(`recover() try to recover subscription [${s}][${t}][${i}]`),"subscribe"===s?await this.recoverSubscription(t,e):await this.recoverUnsubscription(t,e),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.RECOVER_SUBSCRIPTION}),Vs.warn(`recover() recover successfully [${s}][${t}][${i}]`)}catch(n){Vs.error(`recover() recover failed [${s}][${t}][${i}]`,n),oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.RECOVER_SUBSCRIPTION,error:n})}this.deleteAutoRecoveryFlag(t,i)}async recoverSubscription(e,t){const i=this.getOptions(e,t.getType()),s=this.getSubscribedStream(e,t.getType());if(!i||!s)return;const{isAudioMuted:n,isVideoMuted:a}=this.getStreamMuteState(s);this.mergeStream(s,t),this.recoverPlayingState(s),n&&s.doEnableTrack(o.AUDIO,!1),a&&s.doEnableTrack(o.VIDEO,!1)}async recoverUnsubscription(e,t){const i=this.getUnsubscribedStream(e,t.getType());i&&this.mergeStream(i,t)}getStreamMuteState(e){const t={isAudioMuted:!1,isVideoMuted:!1},i=e.getMediaStream();return i&&(t.isAudioMuted=i.getAudioTracks().map((e=>e.enabled)).includes(!1),t.isVideoMuted=i.getVideoTracks().map((e=>e.enabled)).includes(!1)),t}recoverPlayingState(e){const t=e.isPlaying(),i=e.getDiv();if(t&&i){const t=i.parentNode;e.stop(),e.play(t,{objectFit:e.getObjectFit(),muted:e.getMuted()})}}mergeStream(e,t){const i=t.getConnection(),s=t.getMediaStream();e.setConnection(i),i.setRemoteStream(s.id,e),e.setMediaStream(s),e.updateAudioPlayingState(t.hasAudio()),e.updateVideoPlayingState(t.hasVideo())}addSubscriptionRecord(e,t,i){const s=t.getType();if(this.subscribedStreams_.has(e))this.subscribedStreams_.get(e).set(s,t);else{const i=new Map;i.set(t.getType(),t),this.subscribedStreams_.set(e,i)}if(this.subscriptedOptions_.has(e))this.subscriptedOptions_.get(e).set(s,i);else{const s=new Map;s.set(t.getType(),i),this.subscriptedOptions_.set(e,s)}this.deleteUnsubscriptionRecord(e,s)}addUnsubscriptionRecord(e,t){if(this.unsubscribedStreams_.has(e))this.unsubscribedStreams_.get(e).set(t.getType(),t);else{const i=new Map;i.set(t.getType(),t),this.unsubscribedStreams_.set(e,i)}this.deleteSubscriptionRecord(e,t.getType())}getSubscribedStream(e,t){return this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).has(t)?this.subscribedStreams_.get(e).get(t):null}getOptions(e,t){return this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).has(t)?this.subscriptedOptions_.get(e).get(t):null}getUnsubscribedStream(e,t){return this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).has(t)?this.unsubscribedStreams_.get(e).get(t):null}deleteSubscriptionRecord(e,t){this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).delete(t),this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).delete(t)}deleteUnsubscriptionRecord(e,t){this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).delete(t)}markAllStream(){for(const[e,t]of[...this.subscribedStreams_.entries()])for(const[i]of[...t.entries()])this.setAutoRecoveryFlag(e,i);for(const[e,t]of[...this.unsubscribedStreams_.entries()])for(const[i]of[...t.entries()])this.setAutoRecoveryFlag(e,i)}setAutoRecoveryFlag(e,t){if(Vs.info(`setAutoRecoveryFlag() mark [${e}][${t}]`),this.autoRecoveryFlags_.has(e))this.autoRecoveryFlags_.get(e).set(t);else{const i=new Map;i.set(t),this.autoRecoveryFlags_.set(e,i)}}hasAutoRecoveryFlag(e,t){return!!this.isEnabled&&(this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).has(t))}deleteAutoRecoveryFlag(e,t){this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).delete(t)}delete(e){this.unsubscribedStreams_.delete(e),this.subscribedStreams_.delete(e),this.subscriptedOptions_.delete(e),this.autoRecoveryFlags_.delete(e)}}class Rr{constructor(e){this.player_=e,this.canvas_=document.createElement(o.CANVAS),this.canvasCtx_=this.canvas_.getContext("2d")}setCanvasRect(e,t){this.canvas_.width=e,this.canvas_.height=t}drawVideoToCanvas(){const e=this.player_.getElement(),t=e.videoHeight,i=e.videoWidth,s=i*this.canvas_.height/(t*this.canvas_.width);if(s>1.05||s<.95){let e=i*t/(this.canvas_.width*this.canvas_.height);this.setCanvasRect(i/Math.sqrt(e),t/Math.sqrt(e))}this.canvasCtx_.drawImage(e,0,0,this.canvas_.width,this.canvas_.height)}generateVideoTrackFromCanvasCapture(e){return this.canvas_.captureStream(e).getVideoTracks()[0]}generateStreamFromTrack(e){const t=new MediaStream;return t.addTrack(e),t}destroy(){this.player_.stop(),this.canvas_.width=0,this.canvas_.height=0,this.canvas_=null,this.canvasCtx_=null}get canvas(){return this.canvas_}get canvasCtx(){return this.canvasCtx_}get canDrawVideoToCanvas(){if(this.player_){const e=this.player_.getElement();if(e)return e.readyState===e.HAVE_ENOUGH_DATA}return!1}}let br=new Blob(['let t,e,a,i;onmessage=function(n){const{action:h,data:s}=n.data;switch(h){case"render":a=s.canvas,t=a.width,e=a.height,i=a.getContext("2d"),function(t,e){const n=new TransformStream({async transform(t,e){const n=t.displayWidth,h=t.displayHeight,s=n*a.height/(h*a.width);if(s>1.05||s<.95){const t=n*h/(a.width*a.height);a.width=n/Math.sqrt(t),a.height=h/Math.sqrt(t)}i.drawImage(t,0,0,a.width,a.height);const o=new VideoFrame(a,{timestamp:t.timestamp});t.close(),e.enqueue(o)}});t.pipeThrough(n).pipeTo(e)}(s.readable,s.writable)}}'],{type:"application/javascript"});class Dr{constructor(e){const{videoTrack:t}=e;this.width=void 0,this.height=void 0,this.canvas=document.createElement("canvas"),this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:t}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(br)),Vs.info("init worker processor success")}catch(e){Vs.warn(`init worker processor failed. ${e.error}`)}}setCanvasRect(e,t){this.width=e,this.height=t,this.canvas.width=e,this.canvas.height=t,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generatorVideoTrack(){const e=new MediaStream([this.smallGenerator]);return null==e?void 0:e.getTracks()[0]}destroy(){this.worker.terminate()}}class Cr{constructor(e){this.localStream_=e,this.player_=null,this.processor_=null,this.initOffscreenSuccess_=!1}async initialize(){var e;if(function(){var e,t,i;return(null===(e=window)||void 0===e?void 0:e.OffscreenCanvas)&&(null===(t=window)||void 0===t?void 0:t.MediaStreamTrackProcessor)&&(null===(i=window)||void 0===i?void 0:i.MediaStreamTrackGenerator)}()&&(null===(e=navigator)||void 0===e?void 0:e.hardwareConcurrency)>=6)try{await this.initOffscreen(),this.initOffscreenSuccess_=!0,Vs.info("Initialize VideoGenerator successfully!")}catch(t){this.initCanvas()}else this.initCanvas()}generateSmallVideoTrack(e){const{height:t,width:i,frameRate:s}=e,n=this.getSmallVideoProfile(i,t);let a;return this.initOffscreenSuccess_?(this.processor_.setCanvasRect(n.width,n.height),a=this.processor_.generatorVideoTrack()):(this.processor_.setCanvasRect(n.width,n.height),this.player_.setRect({width:n.width,height:n.height}),a=this.processor_.generateVideoTrackFromCanvasCapture(s),this.interval_=Na.run(Pe,this.render.bind(this),{fps:s})),a}render(){this.processor_.canDrawVideoToCanvas&&this.processor_.drawVideoToCanvas()}destroy(){Na.clearTask(this.interval_),this.processor_&&this.processor_.destroy()}initOffscreen(){this.processor_=new Dr({videoTrack:this.localStream_.getVideoTrack()})}initCanvas(){this.player_=new qo({stream:this.localStream_,track:this.localStream_.getVideoTrack(),muted:!0,objectFit:"cover",mirror:!1}),this.player_.play().then((()=>{Vs.info("VideoGenerator: play local video success")})).catch((()=>{Vs.error("VideoGenerator: Failed to play local video")})),this.processor_=new Rr(this.player_)}getSmallVideoProfile(e,t){const i=this.localStream_.getVideoTrack();let s,n=this.localStream_.getVideoProfile();if(so){const e=i.getSettings();e&&e.width&&e.height&&(n.width=e.width,n.height=e.height)}const a=n.width*n.height,o=e*t;Vs.info(`big stream resolution: ${n.width}*${n.height} small stream resolution: ${e}*${t} `),s=a>o?a/o:a/19200;return{width:parseInt(n.width/Math.sqrt(s)),height:parseInt(n.height/Math.sqrt(s))}}}const Nr=new Map;const wr=Ls({retryFunction:async function(e){if(Ja())return;const t=await function(e){return{audio:kr(e),video:Or(e)}}(e);let i,s;Vs.info("getUserMedia with constraints: "+JSON.stringify(t)),t.audio&&(i=await Ic.getMicrophones(),Vs.info(`microphones: ${Ni(i,["deviceId","label"])}`)),t.video&&(s=await Ic.getCameras(),Vs.info(`cameras: ${Ni(s,["deviceId","label"])}`));try{return await navigator.mediaDevices.getUserMedia(t)}catch(o){var n,a;if("NotFoundError"===o.name){if(s&&0===s.length)throw new En({code:Sn.DEVICE_NOT_FOUND,message:ti({key:$e.CAMERA_NOT_FOUND})});if(i&&0===i.length)throw new En({code:Sn.DEVICE_NOT_FOUND,message:ti({key:$e.MICROPHONE_NOT_FOUND})})}if(t.audio&&(null===(n=i)||void 0===n?void 0:n.length)>0){const t=i.find((t=>t.deviceId===e.microphoneId));t&&t.getCapabilities&&Vs.warn(Ni(t.getCapabilities(),xe))}if(t.video&&(null===(a=s)||void 0===a?void 0:a.length)>0){const t=s.find((t=>t.deviceId===e.cameraId));t&&t.getCapabilities&&Vs.warn(Ni(t.getCapabilities(),xe))}throw new En({code:Sn.INITIALIZE_FAILED,name:o.name,message:o.message,constraint:o.constraint})}},settings:{retries:3,timeout:500},onError:(e,t,i,s,n)=>{Vs.warn(`getUserMedia error: ${e}`),"NotReadableError"===e.name?(s[0].video&&(s[0].maxResoution=!1,s[0].frameRate=s[0].frameRate>10?10:5),2===n&&(s[0].useTrueAsConstraint=!0),t()):e.message.includes("deviceId")&&s[0].retryWhenExactFailed?(s[0].useExact=!1,t()):i(e)},onRetrying:e=>{Vs.warn(`getUserMedia retrying [${e}/3]`)},onRetryFailed:()=>{oa.uploadEvent({log:"stat-getUserMedia-retry-failed"})},onRetrySuccess:e=>{oa.uploadEvent({log:"stat-getUserMedia-retry-success-"+e})}});function kr(e){if(!e.audio)return!1;if(e.useTrueAsConstraint)return!0;const t={};return aa(e.microphoneId)||(t.deviceId=e.useExact?{exact:e.microphoneId}:e.microphoneId),ui(e.channelCount)&&e.channelCount>1&&(t.channelCount=e.channelCount),_i(e.echoCancellation)&&!e.echoCancellation&&(t.echoCancellation=!1),_i(e.noiseSuppression)&&!e.noiseSuppression&&(t.noiseSuppression=!1),_i(e.autoGainControl)&&!e.autoGainControl&&(t.autoGainControl=!1),!!aa(t)||t}function Or(e){if(!e.video)return!1;if(e.useTrueAsConstraint)return!0;const{maxResoution:t=!0}=e,i={};return e.facingMode?i.facingMode=e.facingMode:e.cameraId&&(i.deviceId=e.useExact?{exact:e.cameraId}:e.cameraId),e.width&&(i.width={ideal:e.width},t&&!Ye&&(i.width.max=e.width)),e.height&&(i.height={ideal:e.height},t&&!Ye&&(i.height.max=e.height)),Ye&&ft&&e.width&&e.height&&e.width*e.height<101376&&(i.width=e.width,i.height=e.height),e.frameRate&&(i.frameRate=e.frameRate),!!aa(i)||i}function Lr(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:e.sampleRate,channelCount:e.channelCount};return li(e.microphoneId)||(t.deviceId=e.microphoneId),{audio:t,video:!1}}function Pr(e){let t={systemAudio:"include",selfBrowserSurface:"include",surfaceSwitching:"include"},i={width:Ft?{max:e.width}:{ideal:e.width,max:e.width},height:Ft?{max:e.height}:{ideal:e.height,max:e.height},frameRate:e.frameRate,displaySurface:"monitor"};return t.video=i,li(e.audioConstraints)||(t.audio=e.audioConstraints),t}const Mr=new Map([["120p",{width:160,height:120,frameRate:15,bitrate:200}],["120p_2",{width:160,height:120,frameRate:15,bitrate:100}],["180p",{width:320,height:180,frameRate:15,bitrate:350}],["180p_2",{width:320,height:180,frameRate:15,bitrate:150}],["240p",{width:320,height:240,frameRate:15,bitrate:400}],["240p_2",{width:320,height:240,frameRate:15,bitrate:200}],["360p",{width:640,height:360,frameRate:15,bitrate:800}],["360p_2",{width:640,height:360,frameRate:15,bitrate:400}],["480p",{width:640,height:480,frameRate:15,bitrate:900}],["480p_2",{width:640,height:480,frameRate:15,bitrate:500}],["720p",{width:1280,height:720,frameRate:15,bitrate:1500}],["1080p",{width:1920,height:1080,frameRate:15,bitrate:2e3}],["1440p",{width:2560,height:1440,frameRate:30,bitrate:4860}],["4K",{width:3840,height:2160,frameRate:30,bitrate:9e3}]]),Ur=new Map([["480p",{width:640,height:480,frameRate:5,bitrate:900}],["480p_2",{width:640,height:480,frameRate:30,bitrate:1e3}],["720p",{width:1280,height:720,frameRate:5,bitrate:1200}],["720p_2",{width:1280,height:720,frameRate:30,bitrate:3e3}],["1080p",{width:1920,height:1080,frameRate:5,bitrate:1600}],["1080p_2",{width:1920,height:1080,frameRate:30,bitrate:4e3}]]),Vr=new Map([["standard",{sampleRate:48e3,channelCount:1,bitrate:40}],["standard-stereo",{sampleRate:48e3,channelCount:2,bitrate:64}],["high",{sampleRate:48e3,channelCount:1,bitrate:128}],["high-stereo",{sampleRate:48e3,channelCount:2,bitrate:192}]]);var xr,$r,Fr,Br,Hr,Gr,Wr,jr,Jr,Kr,zr,Yr;const Xr=new Map;let qr=(xr=Ir(_e),$r=Ir(_e),Fr=Ir(_e),Br=Ir(_e),Hr=dr(...or.LOCAL_STREAM.switchDevice),Gr=dr(or.STREAM.addTrack),Wr=dr(or.STREAM.removeTrack),jr=dr(or.STREAM.replaceTrack),Jr=hr({retries:10,timeout:3e3,onRetryFailed(e){oa.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.UPDATE_STREAM,error:e}),this.emitter_.emit(uo,new En({code:Sn.DEVICE_AUTO_RECOVER_FAILED,message:e.message}))}}),Kr=rr(or.LOCAL_STREAM.setAudioCaptureVolume),zr=Ir(_e),e((Yr=class extends Ar{constructor(e){super({...e,isRemote:!1,type:"local"}),this.name_=_e,this.client_=null,this.video_=e.video,this.audio_=e.audio,this.cameraId_=e.cameraId,this.cameraGroupId_="",this.facingMode_=e.facingMode,this.microphoneId_=e.microphoneId,this.microphoneGroupId_="",this.microphoneLabel_="",this.videoSource_=e.videoSource,this.audioSource_=e.audioSource,this.screen_=e.screen,this.screenAudio_=e.screenAudio,this.audioProfile_={echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40},this.screenAudio_&&(this.audioProfile_.echoCancellation=!0,this.audioProfile_.autoGainControl=!1,this.audioProfile_.noiseSuppression=!1),_i(e.echoCancellation)&&(this.audioProfile_.echoCancellation=e.echoCancellation),_i(e.autoGainControl)&&(this.audioProfile_.autoGainControl=e.autoGainControl),_i(e.noiseSuppression)&&(this.audioProfile_.noiseSuppression=e.noiseSuppression),this.videoProfile_=Mr.get("480p_2"),this.screenProfile_=Ur.get("1080p"),this.videoSetting_=null,this.muteState_={video:!1,audio:!1,auxVideo:!1},this.beautyStatus_=!1,this.prevAudioRecoverTime_=0,this.prevVideoRecoverTime_=0,this.isAudioRecovering_=!1,this.isVideoRecovering_=!1,this.initState(),this.canvas_=null,this.canvasInterval_=null,this.canvasTrack_=null,this.gain_={audioTrack:null,source:null,gainNode:null},this.captureVolume_=100,this.enableAutoRecoverCapture_=!!li(e.enableAutoRecoverCapture)||e.enableAutoRecoverCapture,this.enableAutoRecoverOther_=!_i(e.enableAutoRecoverOther)||e.enableAutoRecoverOther,this.log_.info(`stream created: ${this.id_} autoRecover: ${this.enableAutoRecoverCapture_}`),this.isAIDenoiser=!1}initState(){this.isAddingTrack_=!1,this.isRemovingTrack_=!1,this.setIsReadyToPublish(!1),this.setPublishState(ie)}installEvents(){super.installEvents(),Pi.on(fs,this.onVideoTrackStopped,this),Pi.on(gs,this.onVideoTrackStopped,this),Pi.on(vs,this.onAudioTrackStopped,this),Pi.on(As,this.onAudioTrackStopped,this)}uninstallEvents(){super.uninstallEvents(),Pi.off(fs,this.onVideoTrackStopped,this),Pi.off(gs,this.onVideoTrackStopped,this),Pi.off(vs,this.onAudioTrackStopped,this),Pi.off(As,this.onAudioTrackStopped,this)}initialize(){return new Promise(((e,t)=>{if(Ka())t(new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.NOT_SUPPORTED_HTTP})}));else{if(li(this.audio_)){const t=new MediaStream;return li(this.audioSource_)||(t.addTrack(this.audioSource_),this.updateAudioPlayingState(!0)),li(this.videoSource_)||(t.addTrack(this.videoSource_),this.updateVideoPlayingState(!0)),this.setMediaStream(t),oa.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.LOCAL_STREAM_INITIALIZE,kind:"custom"}),this.setIsReadyToPublish(!0),e()}this.screen_?(this.log_.info("initialize stream audio: "+this.audio_+" screenAudio: "+this.screenAudio_+" screen: "+this.screen_),async function(e){if(Ja())return;let t=null;if(Vt&&xt<74||Ft){const i=Pr(e);Vs.info("getDisplayMedia with constraints: "+JSON.stringify(i));let s=await navigator.mediaDevices.getDisplayMedia(i);if(e.screenAudio)return Vs.warn("Your browser not support capture system audio"),s;if(e.audio){const i=Lr(e);return Vs.info("getUserMedia with constraints: "+JSON.stringify(i)),t=await navigator.mediaDevices.getUserMedia(i),s.addTrack(t.getAudioTracks()[0]),s}return s}if(e.screenAudio){e.audioConstraints={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:44100};const t=Pr(e);return Vs.info("getDisplayMedia with constraints: "+JSON.stringify(t)),await navigator.mediaDevices.getDisplayMedia(t)}{const i=Pr(e);Vs.info("getDisplayMedia with constraints: "+JSON.stringify(i));let s=await navigator.mediaDevices.getDisplayMedia(i);if(e.audio){const i=Lr(e);return Vs.info("getUserMedia with constraints: "+JSON.stringify(i)),t=await navigator.mediaDevices.getUserMedia(i),s.addTrack(t.getAudioTracks()[0]),s}return s}}({audio:this.audio_,screenAudio:this.screenAudio_,microphoneId:this.microphoneId_,width:this.screenProfile_.width,height:this.screenProfile_.height,frameRate:this.screenProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation}).then((t=>{this.setMediaStream(t),this.updateAudioPlayingState(this.audio_||this.screenAudio_),this.updateVideoPlayingState(!0);const i=this.getVideoTrack();return i.applyConstraints&&i.applyConstraints({frameRate:{min:this.screenProfile_.frameRate,ideal:this.screenProfile_.frameRate},width:this.screenProfile_.width,height:this.screenProfile_.height}).catch((e=>{this.warn(`screen applyConstraints failed: ${e}`)})),this.listenForScreenSharingStopped(i),this.setVideoContentHint(o.DETAIL),this.updateDeviceIdInUse(),this.setIsReadyToPublish(!0),this.log_.info(JSON.stringify(i.getSettings())),oa.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.LOCAL_STREAM_INITIALIZE,kind:"getDisplayMedia"}),e()})).catch((e=>{oa.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.LOCAL_STREAM_INITIALIZE,kind:"getDisplayMedia",error:e}),this.log_.error("getDisplayMedia error observed "+e),t(e instanceof En?e:new En({code:Sn.INITIALIZE_FAILED,name:e.name,message:e.message}))}))):(Pi.emit(_s,{stream:this,audio:this.audio_,video:this.video_}),this.log_.info("initialize stream audio: "+this.audio_+" video: "+this.video_),wr({audio:this.audio_,video:this.video_,facingMode:this.facingMode_,cameraId:this.cameraId_,microphoneId:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation,useExact:!0,retryWhenExactFailed:!0}).then((t=>(Pi.emit(ms,{stream:this,audio:this.audio_,video:this.video_}),this.setMediaStream(t),t.getTracks().forEach((e=>{if(so){const t=e.getSettings();this.log_.debug(`${e.kind} settings: ${JSON.stringify(t)}`),e.kind===o.VIDEO&&(this.videoSetting_=t)}no&&this.log_.info(`${e.kind} capabilities: ${Ni(e.getCapabilities(),xe)}`)})),this.updateAudioPlayingState(this.audio_),this.updateVideoPlayingState(this.video_),this.updateDeviceIdInUse(),this.log_.info("gotStream hasAudio: "+this.hasAudio()+" hasVideo: "+this.hasVideo()),this.setIsReadyToPublish(!0),oa.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.LOCAL_STREAM_INITIALIZE,kind:"getUserMedia"}),e()))).catch((e=>{Pi.emit(ps,{stream:this,audio:this.audio_,video:this.video_,error:e}),oa.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.LOCAL_STREAM_INITIALIZE,kind:"getUserMedia",error:e}),this.log_.error("getUserMedia error observed "+e),t(e)})))}}))}listenForScreenSharingStopped(e){e.addEventListener("ended",(e=>{this.log_.info("screen sharing was stopped because the video track is ended"),this.emitter_.emit(co)}))}muteAudio(){const e=super.muteAudio();return e&&(this.log_.info("localStream mute audio"),this.sendMutedFlag(o.AUDIO,!0)),e}muteVideo(){const e=super.muteVideo();return e&&(this.log_.info("localStream mute video"),this.sendMutedFlag(o.VIDEO,!0)),e}unmuteAudio(){const e=super.unmuteAudio();return e&&(this.log_.info("localStream unmute audio"),this.sendMutedFlag(o.AUDIO,!1)),e}unmuteVideo(){const e=super.unmuteVideo();return e&&(this.log_.info("localStream unmute video"),this.sendMutedFlag(o.VIDEO,!1)),e}sendMutedFlag(e,t){this.setMuteState(e,t);const i=this.getConnection();if(i){i.sendMutedFlag(this.muteState_,this);const s=i.getUserId(),a=i.getTinyId();let r,d=`${t?o.MUTE:o.UNMUTE} local ${e} track`;r=e===o.AUDIO?t?yn:bn:t?Rn:Dn,sa(s,{eventId:r,eventDesc:d,timestamp:n(),userId:s,tinyId:a})}}setMuteState(e,t){this.muteState_[e]=t,this.log_.info(`set ${e} muted state: [${t?"mute":"unmute"}]`)}async setAudioProfile(e){let t;"object"==typeof e?t=e:(t=Vr.get(e),void 0===t&&(t=Vr.get("standard"))),this.log_.info("setAudioProfile: "+JSON.stringify(t));const i=this.getAudioTrack();i&&await i.applyConstraints(t);const s=this.audioProfile_.bitrate!==t.bitrate;this.audioProfile_={...this.audioProfile_,...t},s&&this.connection_&&(await this.connection_.setBandwidth({bandwidth:this.audioProfile_.bitrate,type:o.AUDIO}),this.connection_.sendMediaSettings(this))}async setVideoProfile(e){var t;if(this.connection_&&!ja())throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_PROFILE})});let i;if(oi(e)?i={...this.videoProfile_,...e}:hi(e)&&(i=Mr.get(e),li(i)&&(i=Mr.get("480p_2"))),null!==(t=this.client_)&&void 0!==t&&t.get2k4kFlag()){!(1===this.client_.get2k4kFlag())&&!this.screen_&&i.height*i.width>=3686400?(i.width=1920,i.height=1080,this.log_.warn(Ue)):gr.handleFunctionState({fnName:"2K_4K"})}i&&i.width*i.height>921600&&Kt&&(i.width=1280,i.height=720,this.log_.warn("reset to 1280 * 720 on iOS 13~14")),this.log_.info("setVideoProfile "+JSON.stringify(i));const s=this.getVideoTrack();s&&await s.applyConstraints(i);const n=this.videoProfile_.bitrate!==i.bitrate;this.videoProfile_=i,n&&this.connection_&&(await this.connection_.setBandwidth({bandwidth:i.bitrate,type:o.VIDEO,videoType:o.BIG}),this.connection_.sendMediaSettings(this))}getVideoBitrate(){return this.screen_?this.screenProfile_.bitrate:this.videoProfile_.bitrate}getAudioBitrate(){return this.audioProfile_.bitrate}setScreenProfile(e){let t=e;hi(e)&&(t=Ur.get(e)||Ur.get("1080p")),this.log_.info("setScreenProfile "+JSON.stringify(e)),this.screenProfile_=t}getVideoProfile(){return this.screen_?this.screenProfile_:this.videoProfile_}getAudioProfile(){return this.audioProfile_}setVideoContentHint(e){const t=this.getVideoTrack();t&&"contentHint"in t&&(this.log_.info("set video track contentHint to: "+e),t.contentHint=e,t.contentHint!==e&&this.log_.warn("Invalid video track contentHint: "+e))}async switchDevice(e,t){if(!this.mediaStream_||this.cameraId_===t||this.facingMode_===t)return;const i=e===o.AUDIO,s=e===o.VIDEO;if(i&&t===this.microphoneId_){if(t!==ve)return;if(await async function(e,t){const i=(await To()).find((e=>e.deviceId===ve));return(null==i?void 0:i.groupId)===e&&i.label===t}(this.microphoneGroupId_,this.microphoneLabel_))return}if(this.setIsReadyToPublish(!1),this.log_.info("switchDevice "+e+" to: "+t),i){const e=this.getAudioTrack(),t=this.getMicrophoneTrackMixed();e&&e.stop(),t&&t.stop()}if(s){const e=this.getVideoTrack();if(e&&e.stop(),Dt){const e=this.getAudioTrack();e&&(this.log_.info("stop audio track first in huawei env"),e.stop())}}try{const e=await wr({audio:i||Dt,video:s,facingMode:t===o.FACING_MODE_USER||t===o.FACING_MODE_ENVIRONMENT?t:void 0,cameraId:s?t:this.cameraId_,microphoneId:i?t:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation,useExact:!0,retryWhenExactFailed:!1});let a=null;if(i){const t=e.getAudioTracks()[0];if(t&&this.isAudioTrackMixed()){const e=this.getAudioTrack(),i=Ic.AudioMixerPlugin.getAudioTrackMap();a=Ic.AudioMixerPlugin.mix({targetTrack:t,sourceList:i.get(e.id).sourceList,trackList:i.get(e.id).trackList})}else a=t}else{a=e.getVideoTracks()[0],a&&this.isVideoTrackBeautified()&&(a=await this.generateBeautyTrack(a));const t=e.getAudioTracks()[0];t&&Dt&&await this.replaceTrack(t)}await this.replaceTrack(a),this.updateDeviceIdInUse();const r=this.getConnection();if(r){const e=r.getUserId(),t=r.getTinyId();let s=kn,a="switch camera";i&&(s=On,a="switch microphone"),sa(e,{eventId:s,eventDesc:a,timestamp:n(),userId:e,tinyId:t})}this.log_.info(`switch ${i?"microphone":"camera"} success `),i&&(this.audio_=!0),s&&(this.video_=!0,t!==o.FACING_MODE_ENVIRONMENT&&t!==o.FACING_MODE_USER||(this.facingMode_=t)),this.setIsReadyToPublish(!0)}catch(a){throw this.log_.error(a),i?this.recoverCapture({audio:!0,video:!1,microphoneId:this.microphoneId_}):this.recoverCapture({audio:!1,video:!0,cameraId:this.cameraId_,facingMode:this.facingMode_}),a}}async addTrack(e){try{if(e.kind===o.VIDEO&&so){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`video resolution of the track (${t.width} x ${t.height}) shall be kept the same as the previous: ${this.videoSetting_.width} x ${this.videoSetting_.height}. It may cause abnormal Cloud Recording.`)}this.isAddingTrack_=!0,this.keepMuteState(e),this.mediaStream_.addTrack(e);const t=this.getConnection();if(t){let i=null;e.kind===o.VIDEO&&(Jt||jt)&&gi(e)&&(i=this.getCanvasTrack()),await t.addTrack(i||e,this)}e.kind===o.AUDIO?(this.audio_=!0,this.updateAudioPlayingState(!0),100!==this.captureVolume_&&this.setAudioCaptureVolume(this.captureVolume_)):(this.video_=!0,this.updateVideoPlayingState(!0)),this.isAddingTrack_=!1}catch(t){throw this.mediaStream_.removeTrack(e),this.isAddingTrack_=!1,t}}async removeTrack(e){try{this.isRemovingTrack_=!0;const t=this.getConnection();t&&(e.kind===o.VIDEO&&(Jt||jt)&&this.canvasTrack_?(await t.removeTrack(this.canvasTrack_,this),this.clearCanvas()):e.kind===o.AUDIO&&this.gain_.audioTrack?await t.removeTrack(this.gain_.audioTrack,this):await t.removeTrack(e,this)),this.mediaStream_.removeTrack(e),e.kind===o.AUDIO?(this.audio_=!1,this.updateAudioPlayingState(!1),this.stopGainNode()):(this.video_=!1,this.updateVideoPlayingState(!1)),this.isRemovingTrack_=!1}catch(t){throw this.isRemovingTrack_=!1,t}}async replaceTrack(e){if(e.kind===o.VIDEO&&so){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`video resolution of the track (${t.width} x ${t.height}) shall be kept the same as the previous: ${this.videoSetting_.width} x ${this.videoSetting_.height}. It may cause abnormal Cloud Recording.`)}this.keepMuteState(e);const t=this.mediaStream_;if(e.kind===o.AUDIO){if(t.removeTrack(t.getAudioTracks()[0]),t.addTrack(e),super.restartAudio(),this.gain_.gainNode)return void this.reconnectGainNode(e)}else t.removeTrack(t.getVideoTracks()[0]),t.addTrack(e),super.restartVideo();const i=this.getConnection();if(i){if(e.kind===o.VIDEO&&(Jt||jt)&&this.canvasTrack_)return;await i.replaceTrack(e,this)}}async recoverCapture(e){if(!this.mediaStream_||!this.enableAutoRecoverCapture_||e.audio&&!e.video&&this.isAudioRecovering_||e.video&&!e.audio&&this.isVideoRecovering_)return;e.audio&&(this.isAudioRecovering_=!0),e.video&&(this.isVideoRecovering_=!0),this.log_.warn("recoverCapture() trying "+JSON.stringify(e));let t=this.audio_&&e.audio,i=this.video_&&e.video;try{const a=await Ic.getCameras(),r=await Ic.getMicrophones();if(i&&0===a.length&&(i=!1,this.log_.warn("recoverCapture() video flag is true, but no camera detected, set video to false")),t&&0===r.length&&(t=!1,this.log_.warn("recoverCapture() audio flag is true, but no microphone detected, set audio to false")),!t&&!i)return e.audio&&(this.isAudioRecovering_=!1),e.video&&(this.isVideoRecovering_=!1),void this.log_.warn("recoverCapture() both audio and video are false, aborted");const d=e&&a.findIndex((({deviceId:t})=>t===e.cameraId))>=0,c=e&&r.findIndex((({deviceId:t})=>t===e.microphoneId))>=0;var s,n;if(t)null===(s=this.getAudioTrack())||void 0===s||s.stop();if(i)null===(n=this.getVideoTrack())||void 0===n||n.stop();const l=(await wr({audio:t,video:i,cameraId:d?e.cameraId:void 0,microphoneId:c?e.microphoneId:void 0,facingMode:this.facingMode_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation})).getTracks();for(let e=0;e<l.length;e++){const t=l[e];if(t.kind===o.AUDIO&&this.isAudioTrackMixed()){const e=this.getAudioTrack(),i=Ic.AudioMixerPlugin.getAudioTrackMap().get(e.id);if(!i.hasMicrophone){t.stop();continue}const s=Ic.AudioMixerPlugin.mix({targetTrack:t,sourceList:i.sourceList,trackList:i.trackList});await this.replaceTrack(s)}else if(t.kind===o.VIDEO&&this.isVideoTrackBeautified()){const e=await this.generateBeautyTrack(t);await this.replaceTrack(e)}else if(await this.replaceTrack(t),"ended"===t.readyState)throw new Error(`new track is failed, muted ${t.muted} readyState ${t.readyState}`)}this.updateDeviceIdInUse(),oa.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:B.UPDATE_STREAM}),e.audio&&(this.isAudioRecovering_=!1),e.video&&(this.isVideoRecovering_=!1),this.log_.warn("recoverCapture() successfully"),this.emitter_.emit(ho,{isCamera:e.video,isMicrophone:e.audio,cameraId:this.cameraId_,microphoneId:this.microphoneId_})}catch(a){throw e.audio&&(this.isAudioRecovering_=!1),e.video&&(this.isVideoRecovering_=!1),this.log_.warn("recoverCapture() failed, "+a),a}}updateDeviceIdInUse(){if(!this.mediaStream_)return this.cameraId_="",this.cameraGroupId_="",this.microphoneId_="",void(this.microphoneGroupId_="");if(so){this.mediaStream_.getTracks().forEach((e=>{if(e.kind===o.AUDIO&&this.isAudioTrackMixed()){const e=this.getMicrophoneTrackMixed();if(e){const{deviceId:t,groupId:i}=e.getSettings();t&&(this.microphoneId_=t,this.microphoneGroupId_=i,this.microphoneLabel_=e.label)}return}if(e.kind===o.VIDEO&&this.isVideoTrackBeautified()){const e=this.getBeautyOriginTrack();if(e){const{deviceId:t,groupId:i}=e.getSettings();t&&(this.cameraId_=t,this.cameraGroupId_=i)}return}const{deviceId:t,groupId:i}=e.getSettings();t&&(e.kind===o.AUDIO?(this.microphoneId_=t,this.microphoneGroupId_=i,this.microphoneLabel_=e.label):e.kind!==o.VIDEO||this.screen_||(this.cameraId_=t,this.cameraGroupId_=i))}))}const e=this.mediaStream_.getAudioTracks(),t=this.mediaStream_.getVideoTracks();e&&0===e.length&&(this.microphoneId_="",this.microphoneGroupId_=""),t&&0===t.length&&(this.cameraId_="",this.cameraGroupId_="")}isAudioTrackMixed(){if(Ic.AudioMixerPlugin){const e=Ic.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id))return!0}return!1}getMicrophoneTrackMixed(){if(Ic.AudioMixerPlugin){const e=Ic.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id)){const i=e.get(t.id);return i.hasMicrophone?i.microphoneTrack:null}}return null}isVideoTrackBeautified(){if(Ic.beautyTrackMap){const e=Ic.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id))return!0}return!1}getBeautyOriginTrack(){if(Ic.beautyTrackMap){const e=Ic.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id)){const i=e.get(t.id);if(i.originTrack)return i.originTrack}}return null}async generateBeautyTrack(e){let t=null;const i=this.getVideoTrack(),s=Ic.beautyTrackMap.get(i.id),n=s.param;if(s.type)switch(s.type){case"beauty":t=s.pluginInstance.generateBeautyTrack(e);break;case"virtual":t=await s.pluginInstance.generateVirtualTrack({videoTrack:e,type:n.type,img:n.img});break;case"mixed":t=await s.pluginInstance.generateMixedTrack({videoTrack:e,type:n.type,img:n.img})}else t=s.pluginInstance.generateBeautyTrack(e);return s.pluginInstance.deleteSource(i.id),this.log_.info(`regenerate beauty track, track id = ${e.id}`),t}getScreen(){return this.screen_}hasScreenTrack(){if(this.screen_)return!0;const e=this.getVideoTrack();return!!e&&(e.contentHint===o.DETAIL||e.contentHint===o.TEXT)}getVideo(){return this.video_}getAudio(){return this.audio_}getCameraId(){return this.cameraId_}getMicrophoneId(){return this.microphoneId_}getMicrophoneGroupId(){return this.microphoneGroupId_}getIsReadyToPublish(){return this.isReadyToPublish_}setIsReadyToPublish(e){this.isReadyToPublish_=e}setPublishState(e){this.publishState_=e}setBeautyStatus(e){this.beautyStatus_=!!e}getBeautyStatus(){return this.beautyStatus_}syncMuteState(){const e=this.getAudioTrack(),t=this.getVideoTrack();if(e){const t=!e.enabled;this.setMuteState(o.AUDIO,t)}if(t){const e=!t.enabled;this.setMuteState(o.VIDEO,e)}this.connection_&&this.connection_.sendMutedFlag(this.muteState_,this)}keepMuteState(e){e instanceof window.MediaStreamTrack&&this.muteState_[e.kind]&&(e.enabled=!1,this.log_.warn(`prev ${e.kind} track is muted, keep mute state`))}async onVideoTrackStopped({stream:e,type:t}){!(e===this&&this.video_&&this.cameraId_&&function(e){var t;if(e instanceof CanvasCaptureMediaStreamTrack)return!1;if(!(e instanceof window.MediaStreamTrack))return!1;const i=e.label.toLocaleLowerCase();if(i.includes("camera")||i.includes("webcam"))return!0;const s=`${null===(t=e.getSettings())||void 0===t?void 0:t.deviceId}_${o.VIDEO_INPUT}`;return!!Io.has(s)}(this.getVideoTrack()))||this.isVideoRecovering_||t===o.MUTE&&ft&&Ft||(Date.now()-this.prevVideoRecoverTime_<Oe?setTimeout((()=>this.onVideoTrackStopped({stream:e,type:t})),Oe):t===o.MUTE?setTimeout((()=>{const e=this.getVideoTrack();null!=e&&e.muted&&"visible"===document.visibilityState&&this.recoverVideoCapture(t)}),5e3):this.recoverVideoCapture(t))}async onAudioTrackStopped({stream:e,type:t}){e!==this||!this.audio_||!this.microphoneId_||this.isAudioRecovering_||t===o.MUTE&&ft&&Ft||(Date.now()-this.prevAudioRecoverTime_<Oe?setTimeout((()=>this.onAudioTrackStopped({stream:e,type:t})),Oe):t===o.MUTE?setTimeout((()=>{const e=this.getAudioTrack();null!=e&&e.muted&&"visible"===document.visibilityState&&this.recoverAudioCapture(t)}),5e3):this.recoverAudioCapture(t))}async recoverAudioCapture(e){this.prevAudioRecoverTime_=Date.now(),oa.uploadEvent({log:`stat-local-audio-${e}`,userId:this.userId_}),this.recoverCapture({audio:!0,video:!1,microphoneId:await this.getRecoverCaptureDeviceId(!1)})}async recoverVideoCapture(e){this.prevVideoRecoverTime_=Date.now(),oa.uploadEvent({log:`stat-local-video-${e}`,userId:this.userId_}),this.recoverCapture({audio:!1,video:!0,cameraId:await this.getRecoverCaptureDeviceId(!0)})}async getRecoverCaptureDeviceId(e=!0){let t=e?this.cameraId_:this.microphoneId_;if(t&&this.enableAutoRecoverOther_){Xr.has(t)?Xr.set(t,Xr.get(t)+1):Xr.set(t,1);const i=Xr.get(t);if(i>=3){const s=e?(await Ic.getCameras()).find((e=>!Xr.has(e.deviceId))):(await Ic.getMicrophones()).find((e=>!Xr.has(e.deviceId)));s&&(this.log_.warn(`${e?"camera":"mic"} ${t} capture fail ${i} times, change new ${s.deviceId}`),t=s.deviceId)}}return t}setAudioVolume(e){super.setAudioVolume(e)}clearCanvas(){this.canvasInterval_&&(Na.clearTask(this.canvasInterval_),this.canvasInterval_=null,this.canvas_=null,this.canvasTrack_=null)}getCanvasTrack(){if(this.canvasTrack_)return this.canvasTrack_;this.log_.info("gen canvas track");const e=this.getVideoTrack(),{width:t,height:i,frameRate:s}=e.getSettings();this.canvas_=document.createElement("canvas");const n=this.canvas_.getContext("2d");this.canvas_.width=t,this.canvas_.height=i,this.canvasInterval_=Na.run(Pe,(()=>{if(this.hasVideo()){const e=this.getVideoTrack().getSettings();e.width===this.canvas_.width&&e.height===this.canvas_.height||(this.canvas_.width=e.width,this.canvas_.height=e.height)}this.videoPlayer_&&this.videoPlayer_.element_&&n.drawImage(this.videoPlayer_.element_,0,0,this.canvas_.width,this.canvas_.height)}),{fps:Math.max(15,s)});const a=this.canvas_.captureStream();return this.canvasTrack_=a.getVideoTracks()[0],this.canvasTrack_}setClient(e,t){e&&(this.log_.setUserId(e.getUserId()),this.log_.setSdkAppId(e.getSDKAppId()),t||this.syncMuteState()),this.client_=e}setAudioCaptureVolume(e=100){if(!this.hasAudio()||e<0||!Wa())return!1;if(this.captureVolume_===e)return!0;this.captureVolume_=e,this.log_.info("setCaptureVolume "+e),e/=100;const t=yi();if(this.gain_.gainNode)this.gain_.gainNode.gain.value=e;else{var i;const s=new MediaStream;s.addTrack(this.getAudioTrack());const n=t.createMediaStreamDestination(),a=t.createMediaStreamSource(s),o=t.createGain();o.gain.value=e,a.connect(o),o.connect(n);const r=n.stream.getAudioTracks()[0],d=e=>this.log_.info(`gained audio track ${e}`);r.onmute=()=>d("muted"),r.onunmute=()=>d("unmuted"),r.onended=()=>d("ended"),this.gain_={source:a,audioTrack:r,gainNode:o},null===(i=this.connection_)||void 0===i||i.replaceTrack(r),super.restartAudio()}return!0}getGainedTrack(){return this.gain_.audioTrack}reconnectGainNode(e){this.log_.warn("reconnect gain node");const t=new MediaStream;t.addTrack(e);const i=yi().createMediaStreamSource(t);i.connect(this.gain_.gainNode),this.gain_.source.disconnect(),this.gain_.source=i}stopGainNode(){const{audioTrack:e,source:t,gainNode:i}=this.gain_;i&&(t.disconnect(),i.disconnect(),e.onmute=null,e.onunmute=null,e.onended=null,e.stop(),this.gain_={source:null,gainNode:null,audioTrack:null}),this.captureVolume_=100}close(){this.setIsReadyToPublish(!1),this.stopGainNode(),super.close()}setIsAIDenoiser(e){this.isAIDenoiser=e}}).prototype,"setAudioProfile",[xr],Object.getOwnPropertyDescriptor(Yr.prototype,"setAudioProfile"),Yr.prototype),e(Yr.prototype,"setVideoProfile",[$r],Object.getOwnPropertyDescriptor(Yr.prototype,"setVideoProfile"),Yr.prototype),e(Yr.prototype,"setScreenProfile",[Fr],Object.getOwnPropertyDescriptor(Yr.prototype,"setScreenProfile"),Yr.prototype),e(Yr.prototype,"setVideoContentHint",[Br],Object.getOwnPropertyDescriptor(Yr.prototype,"setVideoContentHint"),Yr.prototype),e(Yr.prototype,"switchDevice",[Hr],Object.getOwnPropertyDescriptor(Yr.prototype,"switchDevice"),Yr.prototype),e(Yr.prototype,"addTrack",[Gr],Object.getOwnPropertyDescriptor(Yr.prototype,"addTrack"),Yr.prototype),e(Yr.prototype,"removeTrack",[Wr],Object.getOwnPropertyDescriptor(Yr.prototype,"removeTrack"),Yr.prototype),e(Yr.prototype,"replaceTrack",[jr],Object.getOwnPropertyDescriptor(Yr.prototype,"replaceTrack"),Yr.prototype),e(Yr.prototype,"recoverCapture",[Jr],Object.getOwnPropertyDescriptor(Yr.prototype,"recoverCapture"),Yr.prototype),e(Yr.prototype,"setAudioCaptureVolume",[Kr,zr],Object.getOwnPropertyDescriptor(Yr.prototype,"setAudioCaptureVolume"),Yr.prototype),Yr);var Qr,Zr;const ed={voiceActivityDetection:!1};let td=(Qr=hr({retries:1,timeout:0,onRetrying(e){this.log_.warn(`connection timeout, retrying [${e}]`)},onError(e,t,i){e.message.includes("timeout")?(this.reset(),this.initialize(),t()):i(e)}}),e((Zr=class extends er{constructor(e){super(e),this.localStream_=null,this.exchangeSDPTimeout_=-1,this.localAuxStream_=null,this.publishingStream_=null,this.isPublishingAuxStream_=!1,this.smallGenerator_=null,this.isSDPExchanging_=!1,this.ssrc_={audio:0,video:0,small:0,auxiliary:0},this.mediaSettings_={videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0},this.mixedAudioTrack_=null}get isMainStreamPublished(){return!!this.localStream_}get isAuxStreamPublished(){return!!this.localAuxStream_}get publishState(){const e={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this.peerConnection_){const a=this.peerConnection_.getSenders();var t,i,s,n;if(a)if(Ha())e.audio=!(null===(t=a[0])||void 0===t||!t.track),e.bigVideo=!(null===(i=a[1])||void 0===i||!i.track),e.smallVideo=!(null===(s=a[2])||void 0===s||!s.track),e.auxVideo=!(null===(n=a[3])||void 0===n||!n.track);else a.forEach((t=>{t.track&&(t.track.kind===o.AUDIO?e.audio=!0:(e.bigVideo=!0,this.smallGenerator_&&(e.smallVideo=!0)))}))}return e}initialize(){super.initialize(),this.installEvents()}reset(){this.isReconnecting_&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents(),this.clearExchangeSDPTimeout(),this.localStream_&&this.localStream_.clearCanvas()}close(){super.close(),this.reset(),this.emitConnectionStateChangedEvent(w),this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null)}installEvents(){this.emitter_.on(ao.ERROR,this.handleError,this),this.emitter_.on(ao.CONNECTION_STATE_CHANGED,this.handleConnectionStateChange,this)}uninstallEvents(){this.emitter_.off(ao.ERROR,this.handleError,this),this.emitter_.off(ao.CONNECTION_STATE_CHANGED,this.handleConnectionStateChange,this)}async publish(e,t){var i;this.publishingStream_=e,this.isPublishingAuxStream_=t;let s=null;e.getVideoTrack()&&!t&&this.client_.getIsEnableSmallStream()&&(this.smallGenerator_=new Cr(e),await this.smallGenerator_.initialize(),s=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_));const n=e.getVideoProfile();if(this.client_.get2k4kFlag()){!(1===this.client_.get2k4kFlag())&&!e.getScreen()&&n.height*n.width>=3686400&&(n.width=1920,n.height=1080,this.log_.warn(Ue),await e.setVideoProfile(n))}return ze&&115===Mt()&&n.width*n.height<=230400&&(this.log_.warn("fallback video to 480p"),await e.setVideoProfile("480p_2")),this.updateMediaSettings(e,t),Ga()?Ke&&11===Wt?await this.publishByAddTrack(e,s):await this.publishByTransceiver(e,s,t):await this.publishByAddTrack(e,s),this.publishingStream_=null,this.isPublishingAuxStream_=!1,t?this.localAuxStream_=e:this.localStream_=e,null===(i=this.sei_)||void 0===i||i.handleEncodedStreams(),e}async publishByTransceiver(e,t,i){this.log_.info("publish by transceiver");const s=e.getMediaStream(),n=e.getAudioTrack(),a=e.getVideoTrack();let r=null;(Jt||jt)&&gi(a)&&(r=e.getCanvasTrack());const d=this.peerConnection_.getTransceivers();if(0===d.length)this.peerConnection_.addTransceiver(n||o.AUDIO,{direction:o.DIRECTION_SENDONLY,streams:[s]}),this.peerConnection_.addTransceiver(i?o.VIDEO:r||a||o.VIDEO,{direction:o.DIRECTION_SENDONLY,streams:[s]}),this.peerConnection_.addTransceiver(t||o.VIDEO,{direction:o.DIRECTION_SENDONLY,streams:[s]}),this.peerConnection_.addTransceiver(i?r||a:o.VIDEO,{direction:o.DIRECTION_SENDONLY,streams:[s]}),await this.connect();else{const s=[];if(n&&(d[0].sender.track?(this.mixAudioTrack(d[0].sender.track,n),await d[0].sender.replaceTrack(this.mixedAudioTrack_)):(await d[0].sender.replaceTrack(n),s.push(0)),await this.setBandwidth({bandwidth:e.getAudioBitrate(),type:o.AUDIO})),a){const n=i?3:1;await d[n].sender.replaceTrack(r||a),await this.setBandwidth({bandwidth:e.getVideoBitrate(),type:o.VIDEO,videoType:i?o.AUXILIARY:o.BIG}),s.push(n),t&&(await d[2].sender.replaceTrack(t),await this.setBandwidth({bandwidth:this.client_.smallStreamConfig.bitrate,type:o.VIDEO,videoType:o.SMALL}),s.push(2))}await this.setTransceiverDirection(o.DIRECTION_SENDONLY,s),await this.doPublishChange()}}async publishByAddTrack(e,t){this.log_.info("publish by addtrack");const i=e.getMediaStream(),s=e.getAudioTrack(),n=e.getVideoTrack();if(s&&this.peerConnection_.addTrack(s,i),n&&(this.peerConnection_.addTrack(n,i),t)){const e=new MediaStream;e.addTrack(t),this.peerConnection_.addTrack(t,e)}await this.connect()}async unpublish(e){if(!Ha())return this.doUnpublish();const t=e.getAudioTrack(),i=e===this.localAuxStream_,s=[];if(this.peerConnection_){const e=this.peerConnection_.getSenders();t&&(this.mixedAudioTrack_?(this.log_.info("has mixed audioTrack, use another audioTrack"),await e[0].replaceTrack(i?this.localStream_.getAudioTrack():this.localAuxStream_.getAudioTrack()),this.destroyMixedAudioTrack()):(await e[0].replaceTrack(null),s.push(0))),i?(await e[3].replaceTrack(null),this.localAuxStream_=null,this.mediaSettings_={...this.mediaSettings_,auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0},s.push(3)):(await e[1].replaceTrack(null),await e[2].replaceTrack(null),this.localStream_=null,this.mediaSettings_={...this.mediaSettings_,videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0},s.push(1,2))}this.localStream_||this.localAuxStream_?(await this.setTransceiverDirection(o.DIRECTION_INACTIVE,s),await this.doPublishChange()):await this.doUnpublish()}async doPublishChange(){const e={state:this.publishState,constraintConfig:this.mediaSettings_},t=await this.signalChannel_.sendWaitForResponse({command:Qs,data:e,responseCommand:Xs.PUBLISH_STATE_CHANGE_RESULT});this.checkPublishResultCode(t.data.code,t.data.message)}doUnpublish(){return this.signalChannel_.sendWaitForResponse({command:an,commandDesc:"unpublish",responseCommand:Xs.UNPUBLISH_RESULT}).then((()=>{this.close()})).catch((()=>{this.close()}))}updateMediaSettings(e,t){this.localAuxStream_&&e===this.localAuxStream_&&(t=!0);const{detail:{isH264EncodeSupported:i,isVp8EncodeSupported:s}}=this.client_.getSystemResult();if(i?this.mediaSettings_.videoCodec="H264":s&&(this.mediaSettings_.videoCodec="VP8"),so){const i=e.getMediaStream();null==i||i.getTracks().forEach((i=>{const s=i.getSettings();if(i.kind===o.AUDIO){let t=1;s.channelCount&&(t=s.channelCount),this.mediaSettings_.audioChannel=t,this.mediaSettings_.audioBps=1e3*e.getAudioBitrate(),this.mediaSettings_.audioFs=s.sampleRate}else if(i.kind===o.VIDEO){if(t)return this.mediaSettings_.auxVideoWidth=s.width,this.mediaSettings_.auxVideoHeight=s.height,this.mediaSettings_.auxVideoFps=s.frameRate,void(this.mediaSettings_.auxVideoBps=1e3*e.getVideoBitrate());this.client_.getIsEnableSmallStream()&&(this.mediaSettings_.smallVideoWidth=this.client_.smallStreamConfig.width,this.mediaSettings_.smallVideoHeight=this.client_.smallStreamConfig.height,this.mediaSettings_.smallVideoFps=this.client_.smallStreamConfig.frameRate,this.mediaSettings_.smallVideoBps=1e3*this.client_.smallStreamConfig.bitrate),this.mediaSettings_.videoWidth=s.width,this.mediaSettings_.videoHeight=s.height,this.mediaSettings_.videoFps=s.frameRate,this.mediaSettings_.videoBps=1e3*e.getVideoBitrate()}}))}else this.updateMediaSettingsFromProfile(e);this.log_.info("updateMediaSettings: "+JSON.stringify(this.mediaSettings_))}updateMediaSettingsFromProfile(e){if(e){if(e.hasAudio()){const t=e.getAudioProfile();this.mediaSettings_.audioChannel=t.channelCount,this.mediaSettings_.audioBps=1e3*t.bitrate,this.mediaSettings_.audioFs=t.sampleRate}if(e.hasVideo()){const t=e.getVideoProfile();this.mediaSettings_.videoWidth=t.width,this.mediaSettings_.videoHeight=t.height,this.mediaSettings_.videoFps=t.frameRate,this.mediaSettings_.videoBps=1e3*t.bitrate}}}sendMediaSettings(e){this.updateMediaSettings(e),this.signalChannel_.sendWaitForResponse({command:In,data:this.mediaSettings_,responseCommand:Xs.UPDATE_CONSTRAINT_CONFIG_RES}).then((e=>{0!==e.data.code&&this.log_.warn(e.data.message)})).catch(this.log_.warn)}async addTrack(e,t){var i;if(!this.peerConnection_)return;const s=t===this.localAuxStream_;this.log_.info(`is adding ${e.kind} track to current published local ${s?o.AUXILIARY:o.MAIN} stream`),null===(i=this.sei_)||void 0===i||i.handleEncodedStreams(),Ha()?await this.addTrackByTransceiver(e,t):await this.addTrackBySender(e),sa(this.userId_,{eventId:e.kind===o.AUDIO?fn:Tn,eventDesc:`add ${e.kind} track to current published stream`,timestamp:n(),userId:this.userId_,tinyId:this.tinyId_})}async addTrackByTransceiver(e,t){const i=t===this.localAuxStream_,s=this.peerConnection_.getTransceivers();if(e.kind===o.AUDIO)s[0].sender.track?(this.mixAudioTrack(s[0].sender.track,e),await s[0].sender.replaceTrack(this.mixedAudioTrack_)):await s[0].sender.replaceTrack(e);else{const t=i?3:1;if(await s[t].sender.replaceTrack(e),1===t&&this.client_.getIsEnableSmallStream()){this.smallGenerator_=new Cr(this.localStream_),await this.smallGenerator_.initialize();let e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);await s[2].sender.replaceTrack(e)}s[t].direction===o.DIRECTION_INACTIVE&&await this.setTransceiverDirection(o.DIRECTION_SENDONLY,[t])}this.updateMediaSettings(t,i),await this.doPublishChange()}async addTrackBySender(e){Ha()&&this.peerConnection_.getTransceivers().findIndex((e=>"stopped"===e.direction))>=0&&(this.log_.warn("transceiver is stopping, negotiate sdp first"),await this.updateOffer(ee.REMOVE,e));const t=this.peerConnection_.getSenders().find((t=>t.track&&t.track.kind===e.kind));if(t){this.log_.warn("sender already exists, remove sender first");const e=t.track;this.removeSender(t),await this.updateOffer(ee.REMOVE,e)}const i=this.localStream_.getMediaStream();if(this.peerConnection_.addTrack(e,i),e.kind===o.VIDEO&&this.client_.getIsEnableSmallStream()){this.smallGenerator_=new Cr(this.localStream_),await this.smallGenerator_.initialize();let e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);const t=new MediaStream;t.addTrack(e),this.peerConnection_.addTrack(e,t)}await this.updateOffer(ee.ADD,e)}isNeedToResetOfferOrder(){if(this.sdpSemantics_===j||!this.peerConnection_||!this.peerConnection_.localDescription)return!1;const e=this.peerConnection_.localDescription.sdp,t=Ta(e);for(let i=0;i<t.media.length;i++)if(0===t.media[i].mid&&t.media[i].type===o.VIDEO)return!0;return!1}removeSender(e){let t=null;Ha()&&(t=this.peerConnection_.getTransceivers().find((t=>t.sender&&t.sender.track===e.track))),this.peerConnection_.removeTrack(e),t&&ci(t.stop)&&(this.log_.info("stop transceiver"),t.stop())}async removeTrack(e,t){this.peerConnection_&&(this.log_.info(`is removing ${e.kind} track from current published local ${t===this.localAuxStream_?o.AUXILIARY:o.MAIN} stream`),Ha()?await this.removeTrackByTransceiver(e,t):await this.removeTrackBySender(e),sa(this.userId_,{eventId:e.kind===o.AUDIO?vn:An,eventDesc:`remove ${e.kind} track from current published stream`,timestamp:n(),userId:this.userId_,tinyId:this.tinyId_}))}async removeTrackByTransceiver(e,t){const i=t===this.localAuxStream_,s=this.peerConnection_.getTransceivers();if(e.kind===o.AUDIO)this.mixedAudioTrack_?(await s[0].sender.replaceTrack(i?this.localStream_.getAudioTrack():this.localAuxStream_.getAudioTrack()),this.destroyMixedAudioTrack()):await s[0].sender.replaceTrack(null);else{const e=i?3:1;await s[e].sender.replaceTrack(null),1===e&&this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null,await s[2].sender.replaceTrack(null)),await this.setTransceiverDirection(o.DIRECTION_INACTIVE,[e])}this.updateMediaSettings(t,i),await this.doPublishChange()}async setTransceiverDirection(e,t){if(!Ye)return;let i=!1,s=!1;this.log_.info(`setting transceiver ${t.join(",")} direction to ${e}`);const n=this.peerConnection_.getTransceivers();if(t.forEach((t=>{n[t].direction!==e&&(n[t].direction=e,i=!0)})),i){this.log_.info("updating offer");const e=await this.peerConnection_.createOffer();await this.peerConnection_.setLocalDescription(e)}let a=-1;const r=this.peerConnection_.remoteDescription.sdp.split("\r\n").map((i=>{if(i.match(new RegExp(`a=(${o.DIRECTION_INACTIVE}|${o.DIRECTION_RECVONLY}|${o.DIRECTION_SENDONLY})`))&&a++,t.includes(a)){if(e===o.DIRECTION_INACTIVE&&i.includes(`a=${o.DIRECTION_RECVONLY}`))return s=!0,`a=${e}`;if(e===o.DIRECTION_SENDONLY&&i.includes(`a=${o.DIRECTION_INACTIVE}`))return s=!0,`a=${o.DIRECTION_RECVONLY}`}return i})).join("\r\n");s&&(this.log_.info("updating answer"),await this.peerConnection_.setRemoteDescription({type:"answer",sdp:r}))}async removeTrackBySender(e){var t;if(e.kind===o.VIDEO&&this.isNeedToResetOfferOrder())return this.reset(),this.initialize(),null===(t=this.localStream_.getMediaStream())||void 0===t||t.removeTrack(e),void(await this.publish(this.localStream_));const i=this.peerConnection_.getSenders().find((t=>t.track===e));i&&(this.removeSender(i),e.kind===o.VIDEO&&this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null,this.peerConnection_.getSenders().forEach((e=>{e.track&&e.track.kind===o.VIDEO&&this.removeSender(e)})))),await this.updateOffer(ee.REMOVE,e)}async replaceTrack(e,t){var i;const s=null===(i=this.peerConnection_)||void 0===i?void 0:i.getSenders();if(!s||0===s.length)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REPLACE_TRACK})});const a=t===this.localAuxStream_;var r,d;if(this.log_.info(`is replacing ${e.kind} track to current published local ${a?o.AUXILIARY:o.MAIN} stream`),e.kind===o.AUDIO&&s[0])if(this.mixedAudioTrack_&&null!==(r=this.localStream_)&&void 0!==r&&r.hasAudio()&&null!==(d=this.localAuxStream_)&&void 0!==d&&d.hasAudio()){this.destroyMixedAudioTrack();const t=a?this.localStream_.getAudioTrack():this.localAuxStream_.getAudioTrack();this.mixAudioTrack(e,t),await s[0].replaceTrack(this.mixedAudioTrack_)}else await s[0].replaceTrack(e);if(e.kind===o.VIDEO){if(t===this.localStream_&&s[1]&&(await s[1].replaceTrack(e),this.smallGenerator_&&s[2])){this.log_.info("replacing smallVideo"),this.smallGenerator_.destroy(),this.smallGenerator_=new Cr(this.localStream_),await this.smallGenerator_.initialize();const e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);await s[2].replaceTrack(e)}t===this.localAuxStream_&&s[3]&&await s[3].replaceTrack(e)}sa(this.userId_,{eventId:e.kind===o.AUDIO?Pn:Ln,eventDesc:`replace ${e.kind} track from current published stream`,timestamp:n(),userId:this.userId_,tinyId:this.tinyId_})}async updateOffer(e,t){try{const i=await this.peerConnection_.createOffer(ed);Ye&&(i.sdp=this.setSDPDirection(i.sdp,"sendrecv")),await this.peerConnection_.setLocalDescription(i);const s=this.updateMediaSettings(this.localStream_||this.localAuxStream_),n={action:e,trackId:t.id,kind:t.kind===o.VIDEO?"bigVideo":t.kind,type:"offer",sdp:this.peerConnection_.localDescription.sdp,constraintConfig:s,state:this.publishState};this.log_.info("createOffer success, sending updated offer to remote server"),this.log_.debug("updatedOffer: "+n.sdp);const a=await this.signalChannel_.sendWaitForResponse({command:qs,data:n,responseCommand:Xs.UPDATE_OFFER_RESULT,timeout:1e4,commandDesc:"update offer"}),{code:r,message:d}=a.data;0!==r&&this.checkPublishResultCode(r,d),await this.acceptAnswer(a.data.data),this.updateSSRC(i.sdp),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.SET_LOCAL_DESCRIPTION,kind:"offer"})}catch(i){throw this.log_.error(i),oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.SET_LOCAL_DESCRIPTION,kind:"offer",error:i}),i}}async setBandwidth({bandwidth:e,type:t,videoType:i="",sdp:s}){if(!ja()&&s)return t===o.VIDEO?this.updateVideoBandwidthRestriction(s,e,i):this.updateAudioBandwidthRestriction(s,e);let n=0;t===o.VIDEO&&(n=i===o.SMALL?2:i===o.AUXILIARY?3:1);const a=this.peerConnection_.getSenders()[n];if(a){const n=a.getParameters();n.encodings&&0!==n.encodings.length||(n.encodings=[{}]),"unlimited"===e?delete n.encodings[0].maxBitrate:n.encodings[0].maxBitrate=1e3*e;try{return await a.setParameters(n),this.log_.info(i+t+" bandwidth was set to "+e+" kbps"),s}catch(r){if(this.log_.info("failed to set bandwidth by setting maxBitrate: "+r),s)return t===o.VIDEO?this.updateVideoBandwidthRestriction(s,e,i):this.updateAudioBandwidthRestriction(s,e)}}return s}updateVideoBandwidthRestriction(e,t,i){let s="AS";Ye&&(s="TIAS",t*=1e3);let n=0,a=-1;return i===o.SMALL?n=1:i===o.AUXILIARY&&(n=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,(e=>(a++,a===n?`${e}b=${s}:${t}\r\n`:e)))}updateAudioBandwidthRestriction(e,t){let i="AS";return Ye&&(i="TIAS",t*=1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,"m=audio $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n")}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}async connect(){try{await this.exchangeSDP(),await this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),e}}async exchangeSDP(){try{this.isSDPExchanging_=!0,await this.createOffer(),this.log_.info("createOffer success, sending offer to remote server"),await this.doExchangeSDP(),this.isSDPExchanging_=!1}catch(e){throw this.isSDPExchanging_=!1,e}}async createOffer(){try{const e=await this.peerConnection_.createOffer(ed);await this.peerConnection_.setLocalDescription(e),this.updateSSRC(e.sdp),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.SET_LOCAL_DESCRIPTION,kind:"offer"})}catch(e){throw oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.SET_LOCAL_DESCRIPTION,kind:"offer",error:e}),e}}doExchangeSDP(){return new Promise(((e,t)=>{this.exchangeSDPTimeout_=setTimeout((()=>{this.signalChannel_.off(Xs.PUBLISH_RESULT,i),this.clearExchangeSDPTimeout();const e=new En({code:Sn.API_CALL_TIMEOUT,message:ti({key:$e.EXCHANGE_SDP_TIMEOUT})});t(e)}),1e4);const i=async i=>{try{this.clearExchangeSDPTimeout();const{code:t,message:s}=i.data;0===t?(await this.acceptAnswer(i.data.data),e()):this.checkPublishResultCode(t,s)}catch(s){t(s)}},s={type:this.peerConnection_.localDescription.type,sdp:this.removeVideoOrientation(this.peerConnection_.localDescription.sdp),screen:(this.publishingStream_||this.localStream_).hasScreenTrack(),state:this.publishState,constraintConfig:this.mediaSettings_};this.signalChannel_.once(Xs.PUBLISH_RESULT,i),this.log_.debug("sending sdp offer: "+s.sdp),this.signalChannel_.send(nn,s)}))}setSDPDirection(e,t,i="all"){const s=Ta(e);return s.media.forEach((e=>{"all"!==i&&e.type!==i||(e.direction=t)})),fa(s)}async acceptAnswer(e){try{let t=this.removeVideoOrientation(e.sdp);const i=this.publishingStream_||this.localStream_;if(i){const e=i.getVideoBitrate(),s=i.getAudioBitrate();if(e){const i=this.isPublishingAuxStream_?o.AUXILIARY:o.BIG;t=await this.setBandwidth({bandwidth:e,type:o.VIDEO,sdp:t,videoType:i})}s&&(t=await this.setBandwidth({bandwidth:s,type:o.AUDIO,sdp:t}))}if(this.client_.getIsEnableSmallStream()){const e=this.client_.smallStreamConfig;t=await this.setBandwidth({bandwidth:e.bitrate,type:o.VIDEO,videoType:o.SMALL,sdp:t})}const s={type:e.type,sdp:t};await this.peerConnection_.setRemoteDescription(s),this.log_.debug("accepted answer: "+t),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.SET_REMOTE_DESCRIPTION,kind:"answer"})}catch(t){throw oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.SET_REMOTE_DESCRIPTION,kind:"answer",error:t}),this.log_.error("failed to accept remote answer "+t),t}}sendMutedFlag(e,t){if(t===this.localAuxStream_)return;const i={audio:e.audio,bigVideo:e.video,auxVideo:e.auxVideo};this.log_.info(`send muted state: ${JSON.stringify(i)}`),this.signalChannel_.send(sn,i)}getIsReconnecting(){return this.isReconnecting_}async reconnect(){if(-1===this.reconnectionTimer_){if(this.reconnectionCount_>=30){this.log_.warn("SDK has tried reconnect uplink for 30 times, but all failed, please check your network"),this.stopReconnection();const e=new En({code:Sn.UPLINK_RECONNECTION_FAILED,message:ti({key:$e.UPLINK_RECONNECTION_FAILED})});return oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.UPLINK_RECONNECTION,error:e}),this.addEventInternal(Xn,"uplink-connection reconnect fail"),this.emitConnectionStateChangedEvent(w),void this.emitter_.emit(ao.ERROR,e)}if(this.signalChannel_.getCurrentState()!==Ks)return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),void this.signalChannel_.once(Hs,this.reconnect,this);this.reconnectionCount_++;try{this.log_.warn(`reconnect() try to reconnect uplink [${this.reconnectionCount_}/30]`);const e=di(this.reconnectionCount_);if(this.reconnectionTimer_=setTimeout((()=>{this.log_.warn(`reconnect() uplink reconnect timeout(${e/1e3}s), try again`),this.clearReconnectionTimer(),this.reconnect()}),e),this.isSDPExchanging_||this.peerConnection_&&this.peerConnection_.connectionState===M)return;await this.signalChannel_.sendWaitForResponse({command:an,responseCommand:Xs.UNPUBLISH_RESULT,enableLog:!1}),this.reset(),this.initialize(),this.localStream_&&await this.publish(this.localStream_),this.localAuxStream_&&await this.publish(this.localAuxStream_,!0),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.UPLINK_RECONNECTION}),this.log_.warn("reconnect() uplink reconnect successfully"),this.addEventInternal(Yn,"uplink-connection reconnect success"),this.stopReconnection(),this.localStream_.syncMuteState()}catch(e){}}else this.log_.warn("reconnect() uplink is reconnecting, ignore current reconnection")}clearExchangeSDPTimeout(){-1!==this.exchangeSDPTimeout_&&(clearTimeout(this.exchangeSDPTimeout_),this.exchangeSDPTimeout_=-1)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}handleError(e){e.getCode()===Sn.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.UPLINK_CONNECTION,error:e})),this.isReconnecting_||this.startReconnection())}handleConnectionStateChange(e){e.state===L&&this.isFirstConnection_&&(this.isFirstConnection_=!1,oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.UPLINK_CONNECTION}),this.addEventInternal(Gn,"uplink-connection is connected"))}updateSSRC(e){try{Ta(e).media.forEach(((e,t)=>{if(e.type===o.AUDIO){const t=e.ssrcs[0];t&&(this.ssrc_.audio=t.id)}else{if(this.sdpSemantics_===j)return void e.ssrcGroups.forEach(((e,t)=>{const i=Number(e.ssrcs.split(" ")[0]);0===t?this.ssrc_.video=i:1===t&&(this.ssrc_.small=i)}));const i=e.ssrcs[0];if(!i)return;switch(t){case 1:this.ssrc_.video=i.id;break;case 2:this.ssrc_.small=i.id;break;case 3:this.ssrc_.auxiliary=i.id}}}))}catch(t){}}getVideoTrackId(e=o.VIDEO){if(this.peerConnection_){const t=this.peerConnection_.getSenders();if(e===o.VIDEO&&t[1]&&t[1].track)return t[1].track.id;if(e===o.SMALL&&t[2]&&t[2].track)return t[2].track.id;if(e===o.AUXILIARY&&t[3]&&t[3].track)return t[3].track.id}if(this.localStream_&&e===o.VIDEO){const e=this.localStream_.getVideoTrack();if(e)return e.id}if(this.localAuxStream_&&e===o.AUXILIARY){const e=this.localAuxStream_.getVideoTrack();if(e)return e.id}return""}getSSRC(){return this.ssrc_}checkPublishResultCode(e,t){if(0!==e)throw 1028===e?(this.log_.error(Fe.NOT_SUPPORTED_H264ENCODE),new En({code:Sn.NOT_SUPPORTED_H264,message:ti({key:$e.NOT_SUPPORTED_H264ENCODE})})):new En({code:Sn.UNKNOWN,message:ti({key:$e.SIGNAL_RESPONSE_FAILED,data:{signalResponse:Xs.PUBLISH_RESULT,code:e,message:t}})})}getLocalStream(){return this.localStream_}sendSEI(e,t){this.sei_.push(e,t)}mixAudioTrack(e,t){this.log_.info("mix audio track"),this.mixedAudioTrack_=function(e){const t=vi(),i=t.createMediaStreamDestination(),s=[];e.forEach((e=>{const n=new MediaStream;n.addTrack(e);const a=t.createMediaStreamSource(n);a.connect(i),s.push(a)}));const n=i.stream.getAudioTracks()[0];return Nr.set(n,{destination:i,track:n,mediaStreamSourceList:s}),n}([e,t])}destroyMixedAudioTrack(){this.mixedAudioTrack_&&(this.log_.info("destroy audio track"),function(e){if(Nr.has(e)){const{destination:t,track:i,mediaStreamSourceList:s}=Nr.get(e);i.stop(),t.disconnect(),s.forEach((e=>{e.disconnect()})),Nr.delete(e)}}(this.mixedAudioTrack_),this.mixedAudioTrack_=null)}}).prototype,"publish",[Qr],Object.getOwnPropertyDescriptor(Zr.prototype,"publish"),Zr.prototype),Zr);const id=new WeakMap;function sd(){return function(e,t,i){const s=i.value,n=({fn:e,args:t,context:i,resolve:s,reject:a})=>{e.apply(i,t).then(s,a).finally((()=>{const e=id.get(i);e&&(e.shift(),e[0]&&n({...e[0]}))}))};return i.value=function(...e){return new Promise(((i,a)=>{if(id.has(this)){const o=id.get(this),r=o.length;o.push({fn:s,args:e,context:this,resolve:i,reject:a,name:t}),0===r&&n({fn:s,args:e,context:this,resolve:i,reject:a})}else id.set(this,[{fn:s,args:e,context:this,resolve:i,reject:a,name:t}]),n({fn:s,args:e,context:this,resolve:i,reject:a})}))},i}}var nd,ad,od,rd,dd;let cd=(nd=sd(),ad=hr({retries:1,timeout:0,onRetrying(e){this.log_.warn(`connection timeout, retrying [${e}]`)},onError(e,t,i){e.message.includes("timeout")?t():i(e)}}),od=sd(),rd=function(e=1e4){return function(t,i,s){const n=s.value;return s.value=function(...t){return new Promise(((s,a)=>{const o=setTimeout((()=>a(new Error(`${i} timeout`))),e);n.apply(this,t).then(s,a).finally((()=>{clearTimeout(o)}))}))},s}}(),e((dd=class extends er{constructor(e){super(e),this.remoteStreams_=new Map,this.autoSubscribe=e.autoSubscribe,this.trackState_={audio:e.trackState.audio,video:e.trackState.video,auxiliary:e.trackState.auxiliary,smallVideo:e.trackState.smallVideo},this.ssrc_={audio:0,video:0,auxiliary:0},this.subscribeState_={audio:e.autoSubscribe,video:e.autoSubscribe,auxiliary:e.autoSubscribe,smallVideo:!1},this.isSDPExchanging_=!1,this.installEvents()}getMixUserList(){return this.mixUserList_?this.mixUserList_.map((({userId:e,flag:t})=>({userId:e,hasAudio:!!(8&t),hasVideo:!!(1&t),hasAuxiliary:!!(4&t)}))):void 0}setMixUserList(e){(!this.mixUserList_||pi(this.mixUserList_)&&!function(e,t){if(t.length===e.length){for(const i of t){const t=e.find((e=>e.userId===i.userId));if(!t||t.flag!==i.flag)return!1}return!0}return!1}(this.mixUserList_,e))&&(this.mixUserList_=e,this.emitter_.emit(ao.STREAM_UPDATED,{stream:this.getMainStream()}))}get isMainStreamSubscribed(){return(this.subscribeState_.audio||this.subscribeState_.video||this.subscribeState_.smallVideo)&&(this.trackState_.audio||this.trackState_.video||this.trackState_.smallVideo)}get isAuxStreamSubscribed(){return this.subscribeState_.auxiliary&&this.trackState_.auxiliary}get isSmallStreamSubscribed(){return this.subscribeState_.smallVideo&&this.trackState_.smallVideo}get isBigStreamSubscribed(){return this.subscribeState_.video&&this.trackState_.video}isStreamUnpublished(e){return e.getType()===o.MAIN?!this.trackState_.audio&&!this.trackState_.video:!this.trackState_.auxiliary}initialize(){super.initialize(),this.peerConnection_.ontrack=this.onTrack.bind(this)}close(){var e,t,i;super.close(),this.trackState_.audio=!1,this.trackState_.video=!1,this.trackState_.smallVideo=!1,this.trackState_.auxiliary=!1,this.emitConnectionStateChangedEvent(w),e=this,t=({fn:e,args:t,resolve:i,reject:s,name:n})=>{if("subscribe"===n){if(!this.client_.getIsJoined())return s(new En({code:Sn.API_CALL_ABORTED,message:ti({key:$e.API_CALL_ABORTED,data:{message:"leave room",stream:t[0]}})}));if(this.isStreamUnpublished(t[0]))return s(new En({code:Sn.API_CALL_ABORTED,message:ti({key:$e.API_CALL_ABORTED,data:{message:`remote user ${this.userId_} unpublished stream`,stream:t[0]}})}))}else if("unsubscribe"===n)return i();i()},null===(i=id.get(e))||void 0===i||i.forEach(t),id.delete(e),this.remoteStreams_.forEach((e=>{const t=e;t.setConnection(null),t.uninstallEvents(),t.getIsStreamAddedEventEmitted()&&this.emitter_.emit(ao.STREAM_REMOVED,{stream:t})})),this.remoteStreams_.clear(),this.uninstallEvents()}installEvents(){Pi.on(as,this.onRemoteStreamUpdate,this),this.emitter_.on(ao.ERROR,(e=>{e.getCode()===Sn.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.DOWNLINK_CONNECTION,error:e})),this.isReconnecting_||this.startReconnection())})),this.emitter_.on(ao.CONNECTION_STATE_CHANGED,(e=>{e.state===L&&this.isFirstConnection_&&(this.isFirstConnection_=!1,oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.DOWNLINK_CONNECTION}),this.addEventInternal(Wn,"downlink-connection is connected"))}))}uninstallEvents(){Pi.removeListener(as,this.onRemoteStreamUpdate,this)}onRemoteStreamUpdate(e){if(this.hitTest(e.tinyId)&&e.client===this.client_){this.updateTrackState(e.action,e.kind);const t=e.kind===o.AUXILIARY?R:y,i=this.remoteStreams_.get(t);if(!i)return;e.action===ee.ADD?this.handleRemoteAddTrack(e.kind,i):this.handleRemoteRemoveTrack(e.kind,i)}}handleRemoteAddTrack(e,t){this.log_.info(`remote add ${e} track`),e===o.AUDIO?t.updateAudioPlayingState(this.subscribeState_.audio):t.updateVideoPlayingState(e===o.AUXILIARY?this.subscribeState_.auxiliary:this.subscribeState_.video||this.subscribeState_.smallVideo),t.getIsStreamAddedEventEmitted()?this.emitter_.emit(ao.STREAM_UPDATED,{stream:t}):(this.emitter_.emit(ao.STREAM_ADDED,{stream:t}),this.currentState_===L&&t.emitConnectionStateChanged({prevState:w,state:L}))}handleRemoteRemoveTrack(e,t){t.getIsStreamAddedEventEmitted()&&(this.log_.info(`remote remove ${e} track`),e===o.AUXILIARY||!this.trackState_.audio&&!this.trackState_.video?(this.log_.info(`remote stream ${t.getType()} removed`),this.currentState_===L&&t.emitConnectionStateChanged({prevState:L,state:w}),this.emitter_.emit(ao.STREAM_REMOVED,{stream:t})):(e===o.AUDIO?t.updateAudioPlayingState(!1):(e!==o.SMALL_VIDEO||this.isSmallStreamSubscribed)&&t.updateVideoPlayingState(!1),this.emitter_.emit(ao.STREAM_UPDATED,{stream:t})))}updateTrackState(e,t){const i=e===ee.ADD;switch(t){case o.AUDIO:this.trackState_.audio=i;break;case o.VIDEO:this.trackState_.video=i;break;case o.AUXILIARY:this.trackState_.auxiliary=i;break;case o.SMALL_VIDEO:this.trackState_.smallVideo=i}this.log_.info(`trackState updated: ${JSON.stringify(this.trackState_)}`)}onTrack(e){const t=e.streams[0],i=e.track;if(this.log_.info(`ontrack() kind: ${i.kind} id: ${i.id} streamId: ${t.id}`),this.sdpSemantics_===W){const e=function(e){let t=da.parse(e),i={audio:[],video:[]};return t.media.forEach((e=>{if(e.ssrcs){let t=e.ssrcs[0].id>>16&255;if(e.type===o.AUDIO)i.audio.push(y);else if(e.type==o.VIDEO){const e=t===b?y:R;i.video.push(e)}}})),i}(this.peerConnection_.remoteDescription.sdp);if(i.kind===o.AUDIO){if(0===e.audio.length||t.id!==y)return void this.log_.debug("skip this invalid audio track")}else if(-1===e.video.indexOf(t.id))return void this.log_.debug(`skip this invalid video track: ${i.id}  msid: ${t.id}`)}oa.logEvent({eventType:"ontrack",kind:i.kind});let s=!1,n=this.remoteStreams_.get(t.id);const a=t.id===y?D:C;if(li(n)&&(n=new vr({type:a,userId:this.userId_,client:this.client_}),n.setConnection(this),this.remoteStreams_.set(t.id,n),s=!0),n.setMediaStream(t),i.kind===o.AUDIO?n.updateAudioPlayingState(this.subscribeState_.audio):a===D?n.updateVideoPlayingState(this.subscribeState_.video||this.subscribeState_.smallVideo):n.updateVideoPlayingState(this.subscribeState_.auxiliary),a===C&&!this.trackState_.auxiliary)return;if(a===D&&!this.trackState_.audio&&!this.trackState_.video)return;const r=this.client_.getSubscriptionManager();r&&r.hasAutoRecoveryFlag(this.userId_,a)||(s?this.emitter_.emit(ao.STREAM_ADDED,{stream:n}):this.emitter_.emit(ao.STREAM_UPDATED,{stream:n}))}addRRTRLine(e){const t=e.split("\r\n"),i=new Map;t.forEach(((e,s)=>{/^a=rtcp-fb:/.test(e)&&t[s+1]&&!/^a=rtcp-fb:/.test(t[s+1])&&e.match(/^a=rtcp-fb:\d+/)&&i.set(s+1,e.match(/^a=rtcp-fb:\d+/)[0]+" rrtr")}));const s=[...i];for(let n=0;n<s.length;n++){let[e,i]=s[n];t.splice(e+n,0,i)}return t.join("\r\n")}addSPSDescription(e){const t=Ta(e);return t.media.forEach((e=>{e.type===o.VIDEO&&e.fmtp.forEach((e=>{e.config+=";sps-pps-idr-in-keyframe=1"}))})),fa(t)}removeSDESDescription(e){const t=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],i=Ta(e);return i.media.forEach((e=>{e.ext=e.ext.filter((e=>!t.includes(e.uri)))})),fa(i)}isSubscriptionStateNotChanged(e,t){return e.getType()===D?(null==t?void 0:t.audio)===this.subscribeState_.audio&&(null==t?void 0:t.video)===this.subscribeState_.video&&this.isSubscribeSmall(t):e.getType()===C?!li(t.video)&&this.subscribeState_.auxiliary===t.video:void 0}isSubscribeSmall(e){return li(e.smallVideo)&&!this.subscribeState_.smallVideo}async subscribe(e,t){try{var i,s;const{emitEvent:n=!0}=t,a=e.getType();if((null===(i=this.peerConnection_)||void 0===i?void 0:i.connectionState)!==P&&(null===(s=this.peerConnection_)||void 0===s?void 0:s.connectionState)!==M||await this.waitForPeerConnectionConnected(),this.isSubscriptionStateNotChanged(e,t))return this.peerConnection_||(this.initialize(),await this.connect()),n&&li(t.smallVideo)&&this.emitter_.emit(ao.STREAM_SUBSCRIBED,{stream:e,result:!0}),e;if(a===o.MAIN?(li(t.audio)||(this.subscribeState_.audio=t.audio),li(t.video)||(this.subscribeState_.video=t.video),this.subscribeState_.smallVideo=(null==t?void 0:t.smallVideo)||!1,this.addEventInternal(this.subscribeState_.audio?Cn:wn,this.subscribeState_.audio?"subscribe audio":"unsubscribe audio"),this.addEventInternal(this.subscribeState_.video?Cn:wn,this.subscribeState_.video?"subscribe video":"unsubscribe video"),this.addEventInternal(this.subscribeState_.smallVideo?ea:ta,this.subscribeState_.smallVideo?"subscribe smallVideo":"unsubscribe smallVideo")):li(t.video)||(this.subscribeState_.auxiliary=t.video),this.log_.info(`subscribe ${a} stream with options ${JSON.stringify(t)} current state: ${JSON.stringify(this.subscribeState_)}`),this.peerConnection_||this.isSDPExchanging_){let t=G;this.isMainStreamSubscribed||this.isAuxStreamSubscribed||(t=H),await this.sendSubscription(t),a===o.MAIN?(e.updateAudioPlayingState(this.subscribeState_.audio),e.updateVideoPlayingState(this.subscribeState_.video||this.subscribeState_.smallVideo)):e.updateVideoPlayingState(this.subscribeState_.auxiliary)}else this.initialize(),await this.connect();return n&&this.emitter_.emit(ao.STREAM_SUBSCRIBED,{stream:e,result:!0}),e}catch(n){if(this.client_.getIsJoined()&&this.isStreamUnpublished(e))throw this.log_.warn(`${n.message} ${JSON.stringify(this.trackState_)}`),new En({code:Sn.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId_} unpublished stream`});throw n}}async unsubscribe(e){const t=e.getType();if(t===o.MAIN){if(!this.isMainStreamSubscribed)return this.log_.info("main stream already unsubscribed"),e;this.subscribeState_.audio=!1,this.subscribeState_.video=!1,this.subscribeState_.smallVideo=!1}else{if(!this.isAuxStreamSubscribed)return this.log_.info("auxiliary stream already unsubscribed"),e;this.subscribeState_.auxiliary=!1}let i=H;if((t===D&&this.isAuxStreamSubscribed||t===C&&this.isMainStreamSubscribed)&&(i=G),this.log_.info(`unsubscribe ${t} stream with ${JSON.stringify(this.subscribeState_)}`),await this.sendSubscription(i),e.updateVideoPlayingState(!1),e.updateAudioPlayingState(!1),i===H){const t=e.getMediaStream();t&&t.getTracks().forEach((e=>t.removeTrack(e))),this.closePeerConnection(),this.emitConnectionStateChangedEvent(w)}return this.addEventInternal(wn,"unsubscribe audio"),this.addEventInternal(Nn,"unsubscribe video"),e}sendSubscription(e){let t={srcTinyId:this.tinyId_,srcUserId:this.userId_},i=rn,s=Xs.UNSUBSCRIBE_RESULT;return e===G&&(t={audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary,smallVideo:this.subscribeState_.smallVideo,srcTinyId:this.tinyId_},i=dn,s=Xs.SUBSCRIBE_CHANGE_RESULT),this.signalChannel_.sendWaitForResponse({command:i,data:t,responseCommand:s,timeout:1e4}).then((({data:t})=>{if(0!==t.code){const i=new En({code:t.code,message:ti({key:$e.ERROR_MESSAGE,data:{type:e,message:t.message}})});throw this.log_.error(i),i}}))}async connect(){try{await this.exchangeSDP(),await this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),e}}async exchangeSDP(){try{this.isSDPExchanging_=!0,await this.createOffer(),this.log_.info("createOffer success, sending offer to remote server");const{type:e,sdp:t}=this.peerConnection_.localDescription,i={type:e,sdp:t,srcUserId:this.userId_,srcTinyId:this.tinyId_,audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary,smallVideo:this.subscribeState_.smallVideo};Pi.emit(Rs,{client:this.client_,connection:this,userId:this.userId_,tinyId:this.tinyId_,role:T,subscribeState:this.subscribeState_,trackState:this.trackState_});const s=await this.signalChannel_.sendWaitForResponse({command:on,commandDesc:"exchange sdp",data:i,responseCommand:Xs.SUBSCRIBE_RESULT,timeout:1e4});if(!this.peerConnection_){const e=new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.CONNECTION_CLOSED})});throw this.log_.warn(e),e}await this.onSubscribeResult(s),this.isSDPExchanging_=!1}catch(e){throw this.isSDPExchanging_=!1,e}}async createOffer(){const e={voiceActivityDetection:!1};Ga()&&this.sdpSemantics_===W?(this.peerConnection_.addTransceiver(o.AUDIO,{direction:"recvonly"}),this.peerConnection_.addTransceiver(o.VIDEO,{direction:"recvonly"}),this.peerConnection_.addTransceiver(o.VIDEO,{direction:"recvonly"})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);const t=await this.peerConnection_.createOffer(e),{isH264DecodeSupported:i}=await Ua();i||(this.log_.warn("remove h264 desc from sdp"),t.sdp=function(e){const t=Ta(e);return t.media.forEach((e=>{if(e.type===o.VIDEO){const t=new Set;e.rtp.forEach((({payload:e,codec:i})=>"H264"===i&&t.add(e))),e.fmtp.forEach((({payload:e,config:i})=>{const s=i.match(/apt=(\d+)/);s&&s[1]&&t.has(Number(s[1]))&&t.add(e)}));const i=({payload:e})=>!t.has(e);e.rtp=e.rtp.filter(i),e.rtcpFb=e.rtcpFb.filter(i),e.fmtp=e.fmtp.filter(i),e.payloads=e.payloads.split(" ").filter((e=>!t.has(Number(e)))).join(" ")}})),fa(t)}(t.sdp)),t.sdp=this.addRRTRLine(t.sdp),t.sdp=this.addSPSDescription(t.sdp),t.sdp=function(e){const t=Ta(e);return t.media.forEach((e=>{e.type===o.AUDIO&&e.fmtp.forEach((e=>{e.config+=";sprop-stereo=1;stereo=1"}))})),fa(t)}(t.sdp),this.sdpSemantics_===W&&(t.sdp=this.removeSDESDescription(t.sdp)),await this.peerConnection_.setLocalDescription(t)}async onSubscribeResult(e){let{code:t,message:i=""}=e&&e.data||{},{type:s,sdp:n}=e&&e.data&&e.data.data||{};if(77393===t)throw this.log_.error(Fe.NOT_SUPPORTED_H264DECODE),new En({code:Sn.NOT_SUPPORTED_H264,message:ti({key:$e.NOT_SUPPORTED_H264DECODE})});try{if(0!==t)throw new En({code:t,message:ti({key:$e.EXCHANGE_SDP_FAILED,data:{errMsg:i}})});this.log_.debug("accept remote answer: "+n),await this.peerConnection_.setRemoteDescription({type:s,sdp:n}),this.sei_&&(this.sei_.handleEncodedStreams(),this.sei_.onSEIMessage=e=>{this.emitter_.emit(ao.SEI_MESSAGE,{...e,userId:this.userId_})}),this.updateSSRC(n)}catch(a){throw this.log_.error(a),a}}updateSSRC(e){try{Ta(e).media.forEach((e=>{if(e.type===o.AUDIO){const t=e.ssrcs.find((e=>e.value.includes(y)));t&&(this.ssrc_.audio=t.id)}else{const t=e.ssrcs.find((e=>e.value.includes(y))),i=e.ssrcs.find((e=>e.value.includes(R)));t&&(this.ssrc_.video=t.id),i&&(this.ssrc_.auxiliary=i.id)}}))}catch(t){}}setRemoteStream(e,t){this.remoteStreams_.set(e,t)}getSubscribeState(){return this.subscribeState_}getTrackState(){return this.trackState_}getSSRC(){return this.ssrc_}getMainStream(){return this.remoteStreams_.get(y)}getAuxStream(){return this.remoteStreams_.get(R)}getMainStreamVideoTrackId(){const e=this.getMainStream();if(e){const t=e.getVideoTrack();if(t)return t.id}return""}getAuxStreamVideoTrackId(){const e=this.getAuxStream();if(e){const t=e.getVideoTrack();if(t)return t.id}return""}async reconnect(){if(-1!==this.reconnectionTimer_)return void this.log_.warn("reconnect() downlink is reconnecting, ignore current reconnection");if(this.reconnectionCount_>=30){this.log_.warn(`SDK has tried reconnect downlink [${this.userId_}] for 30 times, but all failed, please check your network`),this.stopReconnection();const e=new En({code:Sn.DOWNLINK_RECONNECTION_FAILED,message:ti({key:$e.DOWNLINK_RECONNECTION_FAILED})});return oa.logFailedEvent({userId:this.client_.getUserId(),eventType:B.DOWNLINK_RECONNECTION,error:e}),this.addEventInternal(Zn,"downlink-connection reconnect fail"),this.emitConnectionStateChangedEvent(w),void this.emitter_.emit(ao.ERROR,e)}if(this.signalChannel_.getCurrentState()!==Ks)return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),void this.signalChannel_.once(Hs,this.reconnect,this);this.reconnectionCount_++,this.log_.warn(`reconnect() try to reconnect downlink [${this.reconnectionCount_}/30]`);const e=di(this.reconnectionCount_);if(this.reconnectionTimer_=setTimeout((()=>{this.log_.warn(`reconnect() downlink [${this.userId_}] reconnect timeout(${e/1e3}s), try again`),this.clearReconnectionTimer(),this.reconnect()}),e),!(this.isSDPExchanging_||this.peerConnection_&&this.peerConnection_.connectionState===M))try{this.closePeerConnection(),this.initialize(),await this.connect(),this.stopReconnection(),this.log_.warn("reconnect() downlink reconnect successfully"),oa.logSuccessEvent({userId:this.client_.getUserId(),eventType:B.DOWNLINK_RECONNECTION}),this.addEventInternal(Qn,"downlink-connection reconnect success"),this.recoverSubscription()}catch(t){}}recoverSubscription(){const e=this.client_.getSubscriptionManager();e&&[...this.remoteStreams_.values()].forEach((t=>{e.hasAutoRecoveryFlag(this.userId_,t.getType())&&e.recover(t)}))}getIsReconnecting(){return this.isReconnecting_}getSubscribedMainStream(){let e=null;return this.isMainStreamSubscribed&&(e=this.remoteStreams_.get(y)),e}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}startReconnection(){const e=this.client_.getSubscriptionManager();if(e)for(let t of this.remoteStreams_.values()){const i=t.getType();(i===D&&(this.trackState_.audio||this.trackState_.video)||i===C&&this.trackState_.auxiliary)&&e.setAutoRecoveryFlag(this.userId_,t.getType())}super.startReconnection()}getCurrentState(){return this.currentState_}hasMainStream(){return this.trackState_.video||this.trackState_.audio||this.trackState_.smallVideo}hasAuxStream(){return this.trackState_.auxiliary}}).prototype,"subscribe",[nd,ad],Object.getOwnPropertyDescriptor(dd.prototype,"subscribe"),dd.prototype),e(dd.prototype,"unsubscribe",[od],Object.getOwnPropertyDescriptor(dd.prototype,"unsubscribe"),dd.prototype),e(dd.prototype,"exchangeSDP",[rd],Object.getOwnPropertyDescriptor(dd.prototype,"exchangeSDP"),dd.prototype),dd);class ld{constructor(){this.startTime=0,this.endTime=0,this.start()}start(){0===this.startTime&&(this.startTime=Ei())}stop(){0===this.endTime&&(this.endTime=Ei())}getDuration(){return 0===this.endTime?Ei()-this.startTime:this.endTime-this.startTime}}class hd{constructor(e){this.client_=e.client,this.intervalId_=-1,this.statsCalculator_=e.stats,this.prevStats_=null,this.renderFreezeMap_=new Map,this.remoteStreamMap_=new Map,this.dataFreezeMap_=new Map,this.monitorFreezeData_=new Map}installEvents(){Pi.on(Ts,this.handlePlayVideoStart,this),Pi.on(gs,this.onVideoTrackMuted,this),Pi.on(Is,this.onVideoTrackUnmuted,this),Pi.on(hs,this.handleStreamStopped,this),Pi.on(cs,this.handleStreamStopped,this),Pi.on(ss,this.handleVideoPlaying,this)}uninstallEvents(){Pi.off(Ts,this.handlePlayVideoStart,this),Pi.off(gs,this.onVideoTrackMuted,this),Pi.off(Is,this.onVideoTrackUnmuted,this),Pi.off(hs,this.handleStreamStopped,this),Pi.off(cs,this.handleStreamStopped,this),Pi.off(ss,this.handleVideoPlaying,this)}start(){-1===this.intervalId_&&(this.installEvents(),this.intervalId_=Na.run((async()=>{try{await this.detectFPS()}catch(e){}}),{delay:1e3}))}stop(){-1!==this.intervalId_&&(this.uninstallEvents(),Na.clearTask(this.intervalId_),this.intervalId_=-1,this.renderFreezeMap_.clear(),this.dataFreezeMap_.clear(),this.remoteStreamMap_.clear())}onVideoTrackMuted({stream:e}){if(e.getClient()!==this.client_||!e.isRemote())return;const t=e.userId_,i=e.type_,s=`${t}_${i}`,n=this.dataFreezeMap_.get(s),a=new ld;n?n.durationItemList.push(a):this.dataFreezeMap_.set(s,{userId:t,type:i,durationItemList:[a],isFreezing(){const e=this.durationItemList[this.durationItemList.length-1];return e&&0===e.endTime}})}onVideoTrackUnmuted({stream:e}){if(e.getClient()!==this.client_||!e.isRemote())return;const t=e.userId_,i=e.type_,s=`${t}_${i}`;this.stopDataFreeze({key:s,userId:t,type:i})}handleStreamStopped({client:e,stream:t}){if(e!==this.client_)return;const i=t.getUserId(),s=t.getType(),n=`${i}_${s}`;this.stopDataFreeze({key:n,userId:i,type:s})}stopDataFreeze({key:e,userId:t,type:i}){const s=this.dataFreezeMap_.get(e);if(!s||!s.isFreezing())return;const n=s.durationItemList[s.durationItemList.length-1];n.stop();const a=n.getDuration();a>500?(oa.logEvent({eventType:"videoFrozenCount",delta:a}),this.monitorFreezeData_.set(e,{userId:t,type:i,duration:a})):s.durationItemList.pop()}getTotalDuration(e){return e.reduce(((e,t)=>{const i=t.getDuration();return e+Math.min(i,5e3)}),0)}async getStats(){const e=this.client_.getConnections(),t={};for(let[i,s]of e){if(!s.getPeerConnection())continue;const e=s.getSubscribeState(),n=s.getTrackState(),a=await this.statsCalculator_.getReceiverStats(s),o={userId:a.userId,tinyId:i,hasVideo:n.video&&e.video,hasAuxiliary:n.auxiliary&&e.auxiliary,video:{framesDecoded:0},auxiliary:{framesDecoded:0}};o.hasVideo&&(o.video.framesDecoded=a.video.framesDecoded),o.hasAuxiliary&&(o.auxiliary.framesDecoded=a.auxiliary.framesDecoded),t[a.userId]=o}return t}async detectFPS(){const e=await this.getStats();if(this.prevStats_){for(let t in e){if(!this.prevStats_[t])continue;const i=e[t].tinyId,s=this.client_.getMutedStates();if(e[t].hasVideo&&this.prevStats_[t].hasVideo&&s.has(i)&&!s.get(i).videoMuted){const i=e[t].video.framesDecoded-this.prevStats_[t].video.framesDecoded;this.handleRenderFreeze({userId:t,type:D,fps:i})}if(e[t].hasAuxiliary&&this.prevStats_[t].hasAuxiliary){const i=e[t].auxiliary.framesDecoded-this.prevStats_[t].auxiliary.framesDecoded;this.handleRenderFreeze({userId:t,type:C,fps:i})}}this.prevStats_=e}else this.prevStats_=e}async handleRenderFreeze({userId:e,fps:t,type:i}){const s=`${e}_${i}`;let n=this.renderFreezeMap_.get(s);if(t<=2){const t=Ei();n&&!n.isFreeze&&(n.freezeTimeline.push({startTime:t,endTime:void 0}),n.isFreeze=!0),n||this.renderFreezeMap_.set(s,{userId:e,type:i,isFreeze:!0,freezeTimeline:[{startTime:t,endTime:void 0}],renderFreezeTotal:0})}else if(n&&n.isFreeze){n.isFreeze=!1;const e=n.freezeTimeline.pop();e.endTime=Ei();const t=e.endTime-e.startTime;n.freezeTimeline.push(e),n.renderFreezeTotal+=Math.min(5e3,t)}}handlePlayVideoStart({stream:e}){if(e.getClient()!==this.client_||!e.isRemote()||!e.hasVideo())return;const t=`${e.getUserId()}_${e.getType()}`;this.remoteStreamMap_.has(t)||this.remoteStreamMap_.set(t,{isPlayingFired:!1})}handleVideoPlaying({stream:e}){if(!e.isRemote()||e.getClient()!==this.client_)return;const t=`${e.getUserId()}_${e.getType()}`;if(this.remoteStreamMap_.has(t)){this.remoteStreamMap_.get(t).isPlayingFired=!0}}getDataFreezeDuration(e){const t={dataFreeze:0,count:0},i=this.dataFreezeMap_.get(e);if(i){if(i.isFreezing()){const e=i.durationItemList[i.durationItemList.length-1];e.stop();e.getDuration()<500&&i.durationItemList.pop()}t.dataFreeze=this.getTotalDuration(i.durationItemList),t.count=i.durationItemList.length}return t}getRenderFreezeDuration(e){const t=this.renderFreezeMap_.get(e);let i=0,s=0;if(t)if(t.isFreeze){const e=Ei()-t.freezeTimeline[t.freezeTimeline.length-1].startTime;i=t.renderFreezeTotal+Math.min(e,5e3),s=t.freezeTimeline.length}else i=t.renderFreezeTotal;return{renderFreeze:i,count:s}}getMonitorFreeze(){return this.monitorFreezeData_}isBlackStream(e){if(this.remoteStreamMap_.has(e)){return!this.remoteStreamMap_.get(e).isPlayingFired}return!1}resetMonitor(){this.monitorFreezeData_.clear()}}class ud{constructor(e){this.userId=e.userId,this.tinyId=e.tinyId,this.role=e.role===T?A:v}}var _d,md={exports:{}};_d=md,function(e){function t(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function i(e,i,s,n,a,o){return t((r=t(t(i,e),t(n,o)))<<(d=a)|r>>>32-d,s);var r,d}function s(e,t,s,n,a,o,r){return i(t&s|~t&n,e,t,a,o,r)}function n(e,t,s,n,a,o,r){return i(t&n|s&~n,e,t,a,o,r)}function a(e,t,s,n,a,o,r){return i(t^s^n,e,t,a,o,r)}function o(e,t,s,n,a,o,r){return i(s^(t|~n),e,t,a,o,r)}function r(e,i){var r,d,c,l,h;e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;var u=1732584193,_=-271733879,m=-1732584194,p=271733878;for(r=0;r<e.length;r+=16)d=u,c=_,l=m,h=p,u=s(u,_,m,p,e[r],7,-680876936),p=s(p,u,_,m,e[r+1],12,-389564586),m=s(m,p,u,_,e[r+2],17,606105819),_=s(_,m,p,u,e[r+3],22,-1044525330),u=s(u,_,m,p,e[r+4],7,-176418897),p=s(p,u,_,m,e[r+5],12,1200080426),m=s(m,p,u,_,e[r+6],17,-1473231341),_=s(_,m,p,u,e[r+7],22,-45705983),u=s(u,_,m,p,e[r+8],7,1770035416),p=s(p,u,_,m,e[r+9],12,-1958414417),m=s(m,p,u,_,e[r+10],17,-42063),_=s(_,m,p,u,e[r+11],22,-1990404162),u=s(u,_,m,p,e[r+12],7,1804603682),p=s(p,u,_,m,e[r+13],12,-40341101),m=s(m,p,u,_,e[r+14],17,-1502002290),u=n(u,_=s(_,m,p,u,e[r+15],22,1236535329),m,p,e[r+1],5,-165796510),p=n(p,u,_,m,e[r+6],9,-1069501632),m=n(m,p,u,_,e[r+11],14,643717713),_=n(_,m,p,u,e[r],20,-373897302),u=n(u,_,m,p,e[r+5],5,-701558691),p=n(p,u,_,m,e[r+10],9,38016083),m=n(m,p,u,_,e[r+15],14,-660478335),_=n(_,m,p,u,e[r+4],20,-405537848),u=n(u,_,m,p,e[r+9],5,568446438),p=n(p,u,_,m,e[r+14],9,-1019803690),m=n(m,p,u,_,e[r+3],14,-187363961),_=n(_,m,p,u,e[r+8],20,1163531501),u=n(u,_,m,p,e[r+13],5,-1444681467),p=n(p,u,_,m,e[r+2],9,-51403784),m=n(m,p,u,_,e[r+7],14,1735328473),u=a(u,_=n(_,m,p,u,e[r+12],20,-1926607734),m,p,e[r+5],4,-378558),p=a(p,u,_,m,e[r+8],11,-2022574463),m=a(m,p,u,_,e[r+11],16,1839030562),_=a(_,m,p,u,e[r+14],23,-35309556),u=a(u,_,m,p,e[r+1],4,-1530992060),p=a(p,u,_,m,e[r+4],11,1272893353),m=a(m,p,u,_,e[r+7],16,-155497632),_=a(_,m,p,u,e[r+10],23,-1094730640),u=a(u,_,m,p,e[r+13],4,681279174),p=a(p,u,_,m,e[r],11,-358537222),m=a(m,p,u,_,e[r+3],16,-722521979),_=a(_,m,p,u,e[r+6],23,76029189),u=a(u,_,m,p,e[r+9],4,-640364487),p=a(p,u,_,m,e[r+12],11,-421815835),m=a(m,p,u,_,e[r+15],16,530742520),u=o(u,_=a(_,m,p,u,e[r+2],23,-995338651),m,p,e[r],6,-198630844),p=o(p,u,_,m,e[r+7],10,1126891415),m=o(m,p,u,_,e[r+14],15,-1416354905),_=o(_,m,p,u,e[r+5],21,-57434055),u=o(u,_,m,p,e[r+12],6,1700485571),p=o(p,u,_,m,e[r+3],10,-1894986606),m=o(m,p,u,_,e[r+10],15,-1051523),_=o(_,m,p,u,e[r+1],21,-2054922799),u=o(u,_,m,p,e[r+8],6,1873313359),p=o(p,u,_,m,e[r+15],10,-30611744),m=o(m,p,u,_,e[r+6],15,-1560198380),_=o(_,m,p,u,e[r+13],21,1309151649),u=o(u,_,m,p,e[r+4],6,-145523070),p=o(p,u,_,m,e[r+11],10,-1120210379),m=o(m,p,u,_,e[r+2],15,718787259),_=o(_,m,p,u,e[r+9],21,-343485551),u=t(u,d),_=t(_,c),m=t(m,l),p=t(p,h);return[u,_,m,p]}function d(e){var t,i="",s=32*e.length;for(t=0;t<s;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function c(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var s=8*e.length;for(t=0;t<s;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function l(e){var t,i,s="0123456789abcdef",n="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),n+=s.charAt(t>>>4&15)+s.charAt(15&t);return n}function h(e){return unescape(encodeURIComponent(e))}function u(e){return function(e){return d(r(c(e),8*e.length))}(h(e))}function _(e,t){return function(e,t){var i,s,n=c(e),a=[],o=[];for(a[15]=o[15]=void 0,n.length>16&&(n=r(n,8*e.length)),i=0;i<16;i+=1)a[i]=909522486^n[i],o[i]=1549556828^n[i];return s=r(a.concat(c(t)),512+8*t.length),d(r(o.concat(s),640))}(h(e),h(t))}function m(e,t,i){return t?i?_(t,e):l(_(t,e)):i?u(e):l(u(e))}_d.exports?_d.exports=m:e.md5=m}(ki);var pd=md.exports;class gd{constructor(e){this.client_=e.client,this.signalChannel_=e.signalChannel,this.log_=Vs.createLogger({id:"mix|"+this.client_.getUserId(),userId:e.client.getUserId(),sdkAppId:e.client.getSDKAppId()}),this.isMixing_=!1,this.config_=null,this.data_=null,this.remoteStreamMap_=new Map,this.installEvents()}get isPresetLayoutMode(){return this.config_&&this.config_.mode===J.PRESET_LAYOUT}installEvents(){Pi.on(ds,this.onStreamSubscribed,this),Pi.on(cs,this.onStreamUnsubscribed,this),this.client_.on("stream-removed",this.onStreamRemoved,this)}uninstallEvents(){Pi.off(ds,this.onStreamSubscribed,this),Pi.off(cs,this.onStreamUnsubscribed,this),this.client_.off("stream-removed",this.onStreamRemoved,this)}reset(){this.uninstallEvents(),this.isMixing_=!1,this.config_=null}onStreamSubscribed({client:e,stream:t}){e===this.client_&&(this.remoteStreamMap_.set(t.getId(),{remoteStream:t,isUsed:!1}),this.isMixing_&&this.hasAvailablePlaceHolder()&&this.startMixTranscode(this.config_))}onStreamUnsubscribed({client:e,stream:t}){e===this.client_&&this.onStreamRemoved({stream:t})}onStreamRemoved({stream:e}){if(this.remoteStreamMap_.has(e.getId())){const{isUsed:t}=this.remoteStreamMap_.get(e.getId());this.remoteStreamMap_.delete(e.getId()),this.isMixing_&&this.isPresetLayoutMode&&t&&this.startMixTranscode(this.config_)}}async startMixTranscode(e){try{this.resetIsUsedFlag(),this.config_=e;const t=this.getInputParam(e,this.remoteStreamMap_),i=this.getOutputParam(e),s=this.getOutputSessionId({config:e,roomId:this.client_.getRoomId(),userId:this.client_.getUserId()});this.isMixing_&&this.data_&&s!==this.data_.outputSessionId&&(this.log_.info("startMixTranscode() streamId changed, stop mixing before start"),await this.doStopMixTranscode()),await this.doStartMixTranscode({outputSessionId:s,inputParam:t,outputParam:i})}catch(t){throw this.resetIsUsedFlag(),t}}async doStartMixTranscode({outputSessionId:e,inputParam:t,outputParam:i}){const s={roomId:String(this.client_.getRoomId()),mcuRequestTime:Date.now(),outputSessionId:e,inputParam:t,outputParam:i};this.data_=s,this.log_.info(`startMixTranscode: ${JSON.stringify(s)}`),this.isMixing_=!0;try{const e=await this.signalChannel_.sendWaitForResponse({command:_n,data:s,timeout:5e3,responseCommand:Xs.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"});let{code:t,message:i}=e.data;if(0!==t)throw-102083===t&&(i=`Please enable relayed-push in ${Ee} and try later, refer to ${fe}tutorial-26-advanced-publish-cdn-stream.html`),this.log_.error(`startMixTranscode failed, errCode: ${t} errMsg: ${i}`),this.isMixing_=!1,new En({code:Sn.START_MIX_TRANSCODE_FAILED,message:ti({key:$e.START_MIX_TRANSCODE_FAILED,data:{message:i},link:{className:"Client",fnName:"startMixTranscode"}})})}catch(n){throw this.isMixing_=!1,n}}reStartMixTranscode(){this.isMixing_&&this.startMixTranscode(this.config_)}async stopMixTranscode(){if(!this.isMixing_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.MIX_TRANSCODE_NOT_STARTED})});await this.doStopMixTranscode(),this.resetIsUsedFlag()}async doStopMixTranscode(){const e={mcuRequestTime:Date.now(),outputSessionId:this.data_.outputSessionId,streamType:this.data_.outputParam.streamType};this.log_.info(`stopMixTranscode: ${JSON.stringify(e)}`);const t=await this.signalChannel_.sendWaitForResponse({command:mn,data:e,timeout:5e3,responseCommand:Xs.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"}),{code:i,message:s}=t.data;if(0!==i)throw this.log_.error(`stopMixTranscode failed, errCode: ${i} errMsg: ${s}`),new En({code:Sn.STOP_MIX_TRANSCODE_FAILED,message:ti({key:$e.STOP_MIX_TRANSCODE_FAILED,data:{message:s},link:{className:"Client",fnName:"stopMixTranscode"}})});this.isMixing_=!1}getOutputSessionId({config:e,userId:t,roomId:i}){return hi(e.streamId)&&e.streamId.length>0?e.streamId:pd(`${i}_${t}_main`)}getInputParam(e,t){let i=e.mixUsers.map((e=>({userId:e.userId,roomId:String(e.roomId||this.client_.getRoomId()),width:e.width||0,height:e.height||0,locationX:e.locationX||0,locationY:e.locationY||0,zOrder:e.zOrder,streamType:li(e.streamType)||e.streamType!==C?0:1,inputType:e.pureAudio?z.IT_PURE_AUDIO:z.IT_AUDIO_VIDEO,renderMode:e.renderMode||0})));return e.mode===J.PRESET_LAYOUT&&(i.forEach((e=>{if(e.userId===K.REMOTE){const i=[...t.values()].find((({isUsed:e})=>!e));i&&(e.userId=i.remoteStream.getUserId(),e.streamType=i.remoteStream.getType()===C?1:0,i.isUsed=!0)}})),i=i.filter((e=>e.userId!==K.REMOTE))),i}getOutputParam(e){const t=e.streamId||"";return{streamId:t,streamType:t.length>0?1:0,width:li(e.videoWidth)?640:e.videoWidth,height:li(e.videoHeight)?480:e.videoHeight,videoBps:e.videoBitrate||0,fps:e.videoFramerate||15,gop:e.videoGOP||2,audioSampleRate:e.audioSampleRate||48e3,audioBps:e.audioBitrate||64,audioChannels:e.audioChannels||1,backgroundColor:e.backgroundColor||0,backgroundImg:e.backgroundImage||"",extraInfo:"",videoCodec:2,audioCodec:0}}hasAvailablePlaceHolder(){return!!this.isPresetLayoutMode&&this.data_.inputParam.length!==this.config_.mixUsers.length}resetIsUsedFlag(){this.remoteStreamMap_.forEach((e=>e.isUsed=!1))}}class Id{constructor(e){this.client_=e.client,this.signalChannel_=e.signalChannel,this.publishTencentMainStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1},this.publishTencentAuxStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1},this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}setSignalChannel(e){this.signalChannel_=e.signalChannel}getIsPublishingTencentCDN(){return this.publishTencentMainStreamObj_.isPublishing_||this.publishTencentAuxStreamObj_.isPublishing_}getIsPublishingGivenCDN(){return this.isPublishingGivenCDN_}generatePublishCDNStreamId(e,t){if(!e){let e=`${this.client_.getRoomId()}_${this.client_.getUserId()}_${t}`;return/^[A-Za-z\d_-]*$/.test(e)||(e=pd(e)),`${this.client_.getSDKAppId()}_${e}`}return e}generatePublishCDNSessionId(e){return pd(`${this.client_.getRoomId()}_${this.client_.getUserId()}_${e}`)}async startPublishTencentCDN(e){if(e.streamType===o.AUX?(this.publishTencentAuxStreamObj_.params_=e,this.publishTencentAuxStreamObj_.isPublishing_=!0):(this.publishTencentMainStreamObj_.params_=e,this.publishTencentMainStreamObj_.isPublishing_=!0),!this.client_.isJoined_)return;const t=this.generatePublishCDNStreamId(e.streamId,e.streamType),i=this.generatePublishCDNSessionId(e.streamType),s=e.streamType===o.AUX?1:0,n={requestTime:Date.now(),sessionId:i,streamId:t,streamType:s};await this.doStartPublishTencentCDN(n,e.streamType)}async doStartPublishTencentCDN(e,t){try{Vs.info("startPublishTencentCDN: "+JSON.stringify(e));const i=await this.signalChannel_.sendWaitForResponseWithRetry({command:cn,data:e,timeout:2e3,responseCommand:Xs.START_PUBLISH_TENCENT_CDN_RES,commandDesc:"startPublishCDNStream",retries:2});let{code:s,message:n}=i.data;if(0!==s)throw t===o.AUX?this.publishTencentAuxStreamObj_.isPublishing_=!1:this.publishTencentMainStreamObj_.isPublishing_=!1,-102083===s&&(n=`Please enable relayed-push in ${Ee} and try later, refer to ${fe}tutorial-26-advanced-publish-cdn-stream.html`),Vs.error(`startPublishTencentCDN failed, errCode: ${s}, errMsg: ${n}`),new En({code:Sn.START_PUBLISH_CDN_FAILED,message:ti({key:$e.START_PUBLISH_CDN_FAILED,data:{message:n},link:{className:"Client",fnName:"startPublishCDNStream"}})});t===o.AUX?this.publishTencentAuxStreamObj_.streamId_=e.streamId:this.publishTencentMainStreamObj_.streamId_=e.streamId}catch(i){throw t===o.AUX?this.publishTencentAuxStreamObj_.isPublishing_=!1:this.publishTencentMainStreamObj_.isPublishing_=!1,i}}resetPublishTencentParam(e){e===o.MAIN&&(this.publishTencentMainStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1}),e===o.AUX&&(this.publishTencentAuxStreamObj_={params_:null,streamId_:void 0,isPublishing_:!1})}async stopPublishTencentCDN(){if(!this.client_.isJoined_)return this.resetPublishTencentParam(o.MAIN),void this.resetPublishTencentParam(o.AUX);this.publishTencentMainStreamObj_.isPublishing_&&await this.doStopPublishTencentCDN(o.MAIN),this.publishTencentAuxStreamObj_.isPublishing_&&await this.doStopPublishTencentCDN(o.AUX)}async doStopPublishTencentCDN(e){const t={requestTime:Date.now(),sessionId:pd(`${this.client_.getRoomId()}_${this.client_.getUserId()}_${e}`)};Vs.info("stopPublishTencentCDN: "+JSON.stringify(t));const i=await this.signalChannel_.sendWaitForResponse({command:ln,data:t,timeout:5e3,responseCommand:Xs.STOP_PUBLISH_TENCENT_CDN_RES,commandDesc:"stopPublishCDNStream"});let{code:s,message:n}=i.data;if(0===s)this.resetPublishTencentParam(e);else{if(-102069!==s)throw Vs.error(`stopPublishTencentCDN failed, errCode: ${s} errMsg: ${n}`),new En({code:Sn.STOP_PUBLISH_CDN_FAILED,message:ti({key:$e.STOP_PUBLISH_CDN_FAILED,data:{message:n},link:{className:"Client",fnName:"stopPublishCDNStream"}})});Vs.warn("stopPublishTencentCDN failed, can not stopPublishTencentCDN in auto relayed-push mode"),this.resetPublishTencentParam(e)}}async startPublishGivenCDN(e){const t=e.streamType===o.MAIN?this.publishTencentMainStreamObj_.streamId_:this.publishTencentAuxStreamObj_.streamId_,i={pushRequestTime:Date.now(),pushAppId:e.appId,pushBizId:e.bizId,pushCdnUrl:e.url,pushStreamType:e.streamType,pushStreamId:t};if(Vs.info("startPublishGivenCDN: "+JSON.stringify(i)),this.publishGivenCDNData_=i,this.isPublishingGivenCDN_=!0,this.client_.isJoined_)try{const e=await this.signalChannel_.sendWaitForResponse({command:hn,data:i,timeout:5e3,responseCommand:Xs.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDNStream"});let{code:t,message:s}=e.data;if(0!==t)throw Vs.error(`startPublishGivenCDN failed, errCode: ${t}, errMsg: ${s}`),this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1,new En({code:Sn.START_PUBLISH_CDN_FAILED,message:ti({key:$e.START_PUBLISH_CDN_FAILED,data:{message:s},link:{className:"Client",fnName:"startPublishCDNStream"}})})}catch(s){throw this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1,s}}async stopPublishGivenCDN(){if(!this.client_.isJoined_)return this.publishGivenCDNData_=null,void(this.isPublishingGivenCDN_=!1);let{pushAppId:e,pushBizId:t,pushCdnUrl:i,pushStreamType:s}=this.publishGivenCDNData_;const n={pushRequestTime:Date.now(),pushAppId:e,pushBizId:t,pushCdnUrl:i,pushStreamType:s};Vs.info("stopPublishGivenCDN: "+JSON.stringify(n));const a=await this.signalChannel_.sendWaitForResponse({command:un,data:n,timeout:5e3,responseCommand:Xs.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDNStream"});let{code:o,message:r}=a.data;if(0!==o)throw Vs.error(`stopPublishGivenCDN failed, errCode: ${o} errMsg: ${r}`),new En({code:Sn.STOP_PUBLISH_CDN_FAILED,message:ti({key:$e.STOP_PUBLISH_CDN_FAILED,data:{message:r},link:{className:"Client",fnName:"stopPublishCDNStream"}})});this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}handleCDNConfigForJoinData(e){let t,i=e;if(this.publishTencentMainStreamObj_.isPublishing_||this.publishTencentAuxStreamObj_.isPublishing_){let e={};hi(i)&&(e=JSON.parse(i)),e.Str_uc_params||(e.Str_uc_params={}),this.publishTencentMainStreamObj_.isPublishing_&&(this.publishTencentMainStreamObj_.streamId_?e.Str_uc_params.userdefine_streamid_main=this.publishTencentMainStreamObj_.streamId_:this.publishTencentMainStreamObj_.params_&&(e.Str_uc_params.userdefine_streamid_main=this.generatePublishCDNStreamId(this.publishTencentMainStreamObj_.params_.streamId,o.MAIN))),this.publishTencentAuxStreamObj_.isPublishing_&&(this.publishTencentAuxStreamObj_.streamId_?e.Str_uc_params.userdefine_streamid_aux=this.publishTencentAuxStreamObj_.streamId_:this.publishTencentAuxStreamObj_.params_&&(e.Str_uc_params.userdefine_streamid_aux=this.generatePublishCDNStreamId(this.publishTencentAuxStreamObj_.params_.streamId,o.AUX))),i=JSON.stringify(e)}if(this.isPublishingGivenCDN_){let{pushAppId:e,pushBizId:i,pushCdnUrl:s,pushStreamType:n,pushStreamId:a}=this.publishGivenCDNData_;t={pushRequestTime:Date.now(),pushAppId:e,pushBizId:i,pushCdnUrl:s,pushStreamType:n,pushStreamId:a}}return{bussinessInfo:i,pushUserCdnInfo:t}}reset(){this.resetPublishTencentParam(o.MAIN),this.resetPublishTencentParam(o.AUX),this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}}class Sd{constructor(e){this.client_=e.client,this.durationMap_=new Map,this.installEvents()}installEvents(){Pi.on(ds,this.handleSubscribed,this),Pi.on(as,this.handleStreamTrackUpdated,this),Pi.on(cs,this.handleStreamStopped,this),Pi.on(hs,this.handleStreamStopped,this)}uninstallEvents(){Pi.off(ds,this.handleSubscribed,this),Pi.off(as,this.handleStreamTrackUpdated,this),Pi.off(cs,this.handleStreamStopped,this),Pi.off(hs,this.handleStreamStopped,this)}handleSubscribed({client:e,stream:t}){if(e!==this.client_)return;const i=t.getUserId(),s=t.getType(),n=`${i}_${s}`;if(t.hasAudio())if(t.isMainAudioSubscribed){const e=new ld,t=this.durationMap_.get(n);t?this.isRecording(t.audio)||t.audio.push(e):this.durationMap_.set(n,{userId:i,type:s,audio:[e],video:[]})}else this.stopDurationItem(n,o.AUDIO);if(t.hasVideo())if(s===D&&t.isMainVideoSubscribed||s===C&&t.isAuxVideoSubscribed){const e=new ld,t=this.durationMap_.get(n);t?this.isRecording(t.video)||t.video.push(e):this.durationMap_.set(n,{userId:i,type:s,audio:[],video:[e]})}else this.stopDurationItem(n,o.VIDEO)}handleStreamStopped({client:e,stream:t}){if(!this.clientHitTest(e))return;const i=`${t.getUserId()}_${t.getType()}`;this.stopDurationItem(i,o.AUDIO),this.stopDurationItem(i,o.VIDEO)}handleStreamTrackUpdated({client:e,userId:t,tinyId:i,kind:s,action:n}){if(!this.clientHitTest(e)||!this.client_.getConnections().has(i))return;const a=s===o.AUXILIARY?s:D,r=`${t}_${a}`;if(n===ee.ADD){const e=this.client_.getConnections().get(i).getSubscribeState();if(s===o.AUDIO&&!e.audio||s===o.VIDEO&&!e.video||s===o.AUXILIARY&&!e.auxiliary)return;const n=new ld,d=this.durationMap_.get(r);d?(s!==o.AUDIO||this.isRecording(d.audio)||d.audio.push(n),s===o.AUDIO||this.isRecording(d.video)||d.video.push(n)):this.durationMap_.set(r,{userId:t,type:a,audio:s===o.AUDIO?[n]:[],video:s===o.AUDIO?[]:[n]})}else this.stopDurationItem(r,s===o.AUDIO?o.AUDIO:o.VIDEO)}isRecording(e){return e.findIndex((e=>0===e.endTime))>=0}stopDurationItem(e,t){if(this.durationMap_.has(e)){const i=this.durationMap_.get(e)[t].find((e=>0===e.endTime));i&&i.stop()}}clientHitTest(e){return this.client_===e}getDuration(e,t){if(this.durationMap_.has(e)){return this.durationMap_.get(e)[t].reduce(((e,t)=>e+t.getDuration()),0)}return 0}getDurationMap(){return this.durationMap_}reset(){this.durationMap_.clear()}destroy(){this.client_=null,this.uninstallEvents()}}function Ed(){return function(e,t,i){const s=i.value,n=new Set;return i.value=async function(...e){if(n.has(this))throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.AVOID_REPEATED_CALL,data:{name:t}})});try{n.add(this);const t=await s.apply(this,e);return n.delete(this),t}catch(i){throw n.delete(this),i}},i}}let Td=null,fd=!0;function Ad(e){_i(e)&&e!==fd&&(fd=e,Vs.info("setIsNeedToSchedule "+e))}async function vd({userId:e,sdkAppId:i,useStringRoomId:s,roomId:n,userSig:a}){if(!fd&&Td)return{isCached:!0,result:Td};const r={delta:0,count:[1,1],msg:[]};try{const d=new FormData;d.append("userId",String(e)),d.append("sdkAppId",String(i)),d.append("isStrGroupId",s),d.append("groupId",String(n)),d.append("sdkVersion",t),d.append("userSig",String(a)),ce&&d.append("oversea",!0),function(e,t){try{if(PerformanceObserver){const i=Ei(),s=Rd(e,o.MAIN),n=Rd(e,o.BACKUP),a=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{if(e.startTime>=i&&(e.name===s||e.name===n)){const i=e.name===s?o.MAIN:o.BACKUP;if(e.code&&200!==e.code)return void Vs.warn(`${i} schedule with code ${e.code}, ${JSON.stringify(e.toJSON())}`);const n=e.responseEnd-e.startTime,r=[e.domainLookupStart-e.startTime,e.domainLookupEnd-e.domainLookupStart,e.requestStart-e.secureConnectionStart,e.secureConnectionStart-e.connectStart,e.responseStart-e.requestStart,e.responseEnd-e.responseStart].map((e=>e.toFixed(1)));a.disconnect(),oa.uploadEvent({log:`stat-schedule-net:${n.toFixed(1)}(${r.join("->")}) ${i}`,userId:t})}}))}));a.observe({type:"resource",buffered:!0})}}catch(i){}}(i,e);const c=Ei(),l=await function(e,t,i){return new Promise(((s,n)=>{let a=null;var r;(r=[Dd((e=>t.count[0]=e+1),((e,i)=>{t.msg[0]=e.message,a||i()}))(Rd(i,o.MAIN),e,{get timeout(){return 1e3*ri(2+t.count[0])}}),Dd((e=>t.count[1]=e+1),((e,i)=>{t.msg[1]=e.message,a||i()}))(Rd(i,o.BACKUP),e,{get timeout(){return 1e3*ri(2+t.count[1])}})],new Promise(((e,t)=>{let i=[];r.forEach((s=>{s.then(e).catch((e=>{i.push(e),i.length===r.length&&t(i)}))}))}))).then((e=>{a=e,s(a)})).catch(n)}))}(d,r,i);return l.config&&(l.config.loggerDomain&&g(l.config.loggerDomain),_i(l.config.scheduleCache)&&Ad(!l.config.scheduleCache)),r.delta=Ei()-c,yd({stat:r,userId:e}),Td=l,{isCached:!1,result:l}}catch(d){const t=pi(d)?d[0]:d,i=ui(t.code)?t.code:0,s="schedule failed"+(t.message?`: ${t.message}`:""),a=new En({code:Sn.SCHEDULE_FAILED,extraCode:i,message:ti({key:$e.JOIN_ROOM_FAILED,data:{error:s,code:i}})});throw Vs.error(a),yd({stat:r,userId:e,roomId:n,error:a}),a}}function yd({stat:e,userId:t,error:i}){i?oa.logFailedEvent({eventType:B.SCHEDULE,error:i,userId:t}):oa.logSuccessEvent({eventType:B.SCHEDULE,delta:e.delta,userId:t}),oa.uploadEvent({log:"stat-schedule:"+JSON.stringify(e),userId:t})}function Rd(e,t=o.MAIN){let i;return i=ce||(si(e)?t===o.MAIN?de.MAIN_OVERSEA:de.BACKUP_OVERSEA:t===o.MAIN?de.MAIN:de.BACKUP),`https://${i}/api/v1/config`}function bd(e,t,i){return new Promise(((s,n)=>{wi({url:e,body:t,timeout:i.timeout}).then((e=>{0===e.data.code?s(e.data.data):n({code:e.data.code,message:e.data.msg})})).catch(n)}))}Pi.on($i,(()=>Ad(!0))),Pi.on(Zi,(()=>Ad(!0))),Pi.on(es,(()=>Ad(!0))),Pi.on(Qi,(()=>Ad(!0))),Pi.on(ys,(e=>{e.state===O&&Ad(!0)}));const Dd=(e,t)=>Ls({retryFunction:bd,settings:{retries:3,timeout:0},onError:t,onRetrying:e});var Cd,Nd,wd,kd,Od,Ld,Pd,Md,Ud,Vd,xd,$d,Fd,Bd,Hd,Gd,Wd,jd,Jd,Kd,zd,Yd,Xd,qd,Qd,Zd,ec,tc,ic,sc,nc,ac,oc=new class{constructor(){}call(e,t){return ci(this[e])?this[e](t):Promise.reject(new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.API_NOT_EXIST,data:{name:e}})}))}updatePrivateMapKey({privateMapKey:e,client:t}){return t.setProperty("privateMapKey",e),Promise.resolve()}};let rc=(Cd=Ed(),Nd=dr(or.CLIENT.join),wd=hr({retries:1,timeout:0,onError(e,t,i){this.isUsingCachedSchedule_?(this.log_.warn("is using cached schedule, retry join"),Ad(!0),this.reset(),t()):(Pi.emit($i,{client:this,error:e}),oa.logFailedEvent({userId:this.userId_,eventType:B.JOIN,error:e}),this.reset(),this.log_.error(e),i(e))}}),kd=Ed(),Od=hr({retries:3}),Ld=Ed(),Pd=dr(...or.CLIENT.publish),Md=Ir(ue),Ud=Ed(),Vd=dr(or.CLIENT.unpublish),xd=dr(...or.CLIENT.subscribe),$d=dr(or.CLIENT.unsubscribe),Fd=Ed(),Bd=dr(or.CLIENT.switchRole),Hd=Ir(ue),Gd=dr(or.CLIENT.startPublishCDNStream),Wd=Ir(ue),jd=Ir(ue),Jd=dr(or.CLIENT.startMixTranscode),Kd=Ir(ue),zd=Ir(ue),Yd=Ir(ue),Xd=Ir(ue),qd=Ir(ue),Qd=Ir(ue),Zd=Ir(ue),ec=rr(...or.CLIENT.sendSEIMessage),tc=Ir(ue),ic=function({timesInSecond:e,maxSizeInSecond:t,getSize:i}){return function(s,n,a){const o=a.value,r=new Map;return Pi.on(qi,(({client:e})=>r.delete(e))),a.value=function(...s){let a=r.get(this);if(a||(a={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},r.set(this,a)),0===a.timestamp?a.timestamp=Date.now():Date.now()-a.timestamp>1e3&&(a.timestamp=Date.now(),a.callCountInSecond=0,a.totalSizeInSecond=0),i&&(a.totalSizeInSecond+=i(...s)),0!==a.timestamp&&Date.now()-a.timestamp<1e3&&(a.callCountInSecond>=e||a.totalSizeInSecond>t))throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.CALL_FREQUENCY_LIMIT,data:{isTimes:a.callCountInSecond>=e,isSize:a.totalSizeInSecond>t,name:n,timesInSecond:e,maxSizeInSecond:t}})});return a.callCountInSecond++,o.apply(this,s)},a}}({timesInSecond:30,maxSizeInSecond:8e3,getSize:(...e)=>e[0].byteLength}),sc=Ir(ue),nc=Ir(ue),ac=class{constructor(e){this.name_=ue,this.mode_=e.mode,this.sdpSemantics_=j,li(e.sdpSemantics)?function(){var e;if(li(window.RTCRtpTransceiver))return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let t=null,i=!1;try{t=new RTCPeerConnection({sdpSemantics:W}),t.addTransceiver(o.AUDIO),i=!0}catch(s){}return null===(e=t)||void 0===e||e.close(),i}()&&(this.sdpSemantics_=W):this.sdpSemantics_=e.sdpSemantics,this.sdkAppId_=e.sdkAppId,this.userId_=e.userId,this.log_=Vs.createLogger({id:`c${e.seq}|${this.userId_}`,userId:this.userId_,sdkAppId:this.sdkAppId_}),this.userSig_=e.userSig,this.roomId_=0,this.useStringRoomId_=e.useStringRoomId||!1,this.pureAudioPushMode_=null,this.version_=e.version,this.log_.info("using sdpSemantics: "+this.sdpSemantics_),this.signalChannel_=null,this.role_=A,this.privateMapKey_="",this.tinyId_=0,this.env_="",this.proxy_=null,this.unifiedProxy_=null,this.connections_=new Map,this.mutedStates_=new Map,this.userMap_=new Map,this.syncUserListInterval_=-1,this.localStream_=null,this.localAuxStream_=null,this.uplinkConnection_=null,this.emitter_=bi(new Li,this.name_),this.isJoined_=!1,this.heartbeat_=-1,this.lastHeartBeatTime_=-1,this.stats_=new mo(this),this.joinTimeout_=-1,this.changeBigSmallRecords_=new Map,this.networkQuality_=null,this.badCaseDetector_=null,this.networkType_=ai(),this.autoSubscribe_=!!li(e.autoSubscribe)||e.autoSubscribe,this.joinedTimestamp_=0,this.joinOptions_={},this.basis_=function(){const e={browser:qt().name+"/"+qt().version,os:qa(),displayResolution:Qa(),isScreenShareSupported:$a(),isWebRTCSupported:Pa(),isGetUserMediaSupported:Za(),isWebAudioSupported:eo(),isWebSocketsSupported:"WebSocket"in window&&2===window.WebSocket.CLOSING,isWebCodecSupported:io(),isMediaSessionSupported:"mediaSession"in navigator&&!li(navigator.mediaSession.setActionHandler),isWebTransportSupported:!li(window.WebTransport)};return navigator.userAgent.includes("miniProgram")&&(e.browser=`mini/${e.browser}`),e}(),this.initBussinessInfo_(e),this.publishedCDN_=!1,this.publishCDNData_=null,this.mixedMCU_=!1,this.mixTranscodeData_=null,this.checkSystemResult_=null,this.enableAudioVolumeEvaluation_=!1,this.audioVolumeIntervalId_=null,this.mixTranscodeManager_=null,this.publishCDNManager_=new Id({client:this}),this.keyPointManager_=new pr({client:this,frameWorkType:e.frameWorkType,component:e.component}),this.isPublishing_=!1,this.isEnableSmallStream_=!1,this.smallStreamConfig_={bitrate:100,frameRate:15,height:120,width:160},this.turnServers_=[],this.iceTransportPolicy_=e.iceTransportPolicy,this.schedule_={domains:null,iceServers:null,iceTransportPolicy:null,trtcCapability:null},this.isUsingCachedSchedule_=!1,this.enableAutoPlayDialog_=!!li(e.enableAutoPlayDialog)||e.enableAutoPlayDialog,this.enableMultiAuxStream_=!li(e.enableMultiAuxStream)&&e.enableMultiAuxStream,this.signalInfo_={},this.enableSEI_=!li(e.enableSEI)&&e.enableSEI,this.isDestroyed_=!1}initBussinessInfo_(e){this.bussinessInfo_=e.bussinessInfo;let t={};if(hi(e.bussinessInfo)&&(t=JSON.parse(e.bussinessInfo)),!li(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PURE_AUDIO})});this.pureAudioPushMode_=e.pureAudioPushMode,t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.pure_audio_push_mod=this.pureAudioPushMode_}if(!li(e.streamId)){if(!(hi(e.streamId)&&String(e.streamId)&&String(e.streamId).length<=64))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_STREAMID})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_streamid_main=e.streamId}if(!li(e.userDefineRecordId)){const i=/^[A-Za-z0-9_-]{1,64}$/gi;if(null===e.userDefineRecordId.match(i))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_USER_DEFINE_RECORDID})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!li(e.userDefinePushArgs)){if(!(hi(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_USER_DEFINE_PUSH_ARGS})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_push_args=e.userDefinePushArgs}e.enableServerAudioMix&&(t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.enable_server_audio_mix=1,t.Str_uc_params.uc_biz_type=1e3),aa(t)||(this.bussinessInfo_=JSON.stringify(t))}async schedule(e){const{result:t,isCached:i}=await vd({userId:this.userId_,sdkAppId:this.sdkAppId_,roomId:e,useStringRoomId:this.useStringRoomId_,version:this.version_,userSig:this.userSig_});this.isUsingCachedSchedule_=i,t&&(this.log_.info(`schedule with cache:${i} : ${JSON.stringify(t)}`),t.trtcCapability=null==t?void 0:t.trtcAutoConf,this.schedule_={...this.schedule_,...t},Pi.emit(Yi,this.schedule_))}getSignalChannelUrl(){const e={mainUrl:"",backupUrl:""},t=ii();return t?e.mainUrl=e.backupUrl=`wss://${t}.rtc.qq.com`:this.proxy_?e.mainUrl=e.backupUrl=this.proxy_:this.unifiedProxy_?e.mainUrl=e.backupUrl=`wss://${this.unifiedProxy_}`:Array.isArray(this.schedule_.domains)&&this.schedule_.domains.length>0&&(e.mainUrl=e.backupUrl=`wss://${this.schedule_.domains[0]}`,this.schedule_.domains[1]&&(e.backupUrl=`wss://${this.schedule_.domains[1]}`)),e}getUserId(){return this.userId_}getUserSig(){return this.userSig_}getRole(){return this.role_}getSignalInfo(){return this.signalInfo_}getRoomId(){return this.roomId_}getSDKAppId(){return this.sdkAppId_}getTinyId(){return this.tinyId_}getIceTransportPolicy(){return this.iceTransportPolicy_||this.schedule_.iceTransportPolicy||"all"}initialize(e){this.log_.info("setup signal channel");const{mainUrl:t,backupUrl:i}=this.getSignalChannelUrl();return this.signalChannel_=new ra({sdkAppId:this.sdkAppId_,userId:this.userId_,userSig:this.userSig_,roomId:e.roomId,url:t,backupUrl:i,signalDomainWhenUnifiedProxy:this.unifiedProxy_?this.schedule_.domains[0]:void 0,client:this}),this.networkQuality_||(this.networkQuality_=new po({connections:this.connections_,signalChannel:this.signalChannel_,userId:this.userId_,client:this}),this.networkQuality_.on(oo.NETWORK_QUALITY,(e=>{this.emitter_.emit(oo.NETWORK_QUALITY,e)}))),this.deviceDetector_||(this.deviceDetector_=new go({client:this})),this.subscriptionManager_||(this.subscriptionManager_=new yr({client:this})),this.badCaseDetector_||(this.badCaseDetector_=new hd({client:this,stats:this.stats_})),this.callDurationCalculator_||(this.callDurationCalculator_=new Sd({client:this})),this.mixTranscodeManager_||(this.mixTranscodeManager_=new gd({client:this,signalChannel:this.signalChannel_})),this.publishCDNManager_&&this.publishCDNManager_.setSignalChannel({signalChannel:this.signalChannel_}),this.signalChannel_.on(Bs,(e=>{this.log_.info(`SignalChannel state changed from ${e.prevState} to ${e.state}`),this.emitter_.emit(oo.CONNECTION_STATE_CHANGED,e)})),this.signalChannel_.on(Gs,(e=>{this.reset(),this.emitter_.emit(oo.ERROR,e)})),this.signalChannel_.once($s,(e=>{this.tinyId_=e.signalInfo.tinyId,Pi.emit(Ki,{client:this})})),this.signalChannel_.on(Xs.PEER_JOIN,this.onPeerJoin,this),this.signalChannel_.on(Xs.PEER_LEAVE,this.onPeerLeave,this),this.signalChannel_.on(Xs.UPDATE_REMOTE_MUTE_STAT,(e=>{Date.now()-this.lastHeartBeatTime_>=1e4&&this.doHeartbeat(),Pi.emit(Wi,{client:this,data:e.data}),this.onPublishedUserList(e.data),this.onUpdateRemoteMuteStat(e.data)})),this.signalChannel_.on(Xs.CLIENT_BANNED,(e=>{let t,i=e.data.data.reason;if(oa.uploadEvent({log:`stat-banned:${i}`,userId:this.userId_}),i===o.BANNED)t="you got banned by the admin";else if(i===o.KICK)t="duplicated userId joining the room";else if(i===o.ROOM_DISBAND)t="the room has been disbanded by the admin",i=i.replace("_","-");else if(i===o.USER_TIME_OUT)return this.log_.warn(`${i} last heart beat time: ${this.lastHeartBeatTime_} interval: ${Date.now()-this.lastHeartBeatTime_}, visibility: ${document.visibilityState}`),void this.reJoin();this.log_["kick"===i?"error":"info"](`user was banned because of [${i}]`),this.reset(),this.emitter_.emit(oo.CLIENT_BANNED,{reason:i,message:ti({key:$e.CLIENT_BANNED,data:{message:t,reason:i}})||i})})),Pi.emit(Ji,{client:this}),this.signalChannel_.connect()}async preJoin(e){this.joinOptions_=e,this.checkSystemResult_=await Va(),this.checkDestroy();let t=ii();t||(t=c,this.proxy_&&(this.proxy_.startsWith(r)?t=l:this.proxy_.startsWith(d)&&(t=h))),this.env_=t,oa.setConfig({env:t,sdkAppId:this.sdkAppId_,userId:this.userId_,roomId:e.roomId}),this.uploadTrtcStats();const{isH264EncodeSupported:i,isVp8EncodeSupported:s}=this.checkSystemResult_.detail;if(!Pa()||!i&&!s)throw new En({code:Sn.NOT_SUPPORTED,message:ti({key:$e.NOT_SUPPORTED_WEBRTC})})}async join(e){this.roomId_=e.roomId,li(e.role)||(this.role_=e.role),li(e.privateMapKey)||(this.privateMapKey_=e.privateMapKey);const t=Ei();return Pi.emit(Mi,{client:this}),sa(this.userId_,{eventId:$n,eventDesc:"joining room",timestamp:n(),userId:this.userId_,tinyId:this.tinyId_}),await this.preJoin(e),new Promise((async(i,s)=>{this.joinReject_=s;try{this.proxy_||this.schedule_.domains||await this.schedule(e.roomId),this.checkDestroy(),await this.initialize(e),await this.doJoin(e),this.signalInfo_=this.signalChannel_.getSignalInfo(),Pi.emit(xi,{client:this}),this.joinedTimestamp_=Ei(),oa.logSuccessEvent({userId:this.userId_,eventType:B.DELTA_JOIN,delta:this.joinedTimestamp_-t}),oa.logSuccessEvent({userId:this.userId_,eventType:B.JOIN}),oa.uploadEvent({log:`stat-autoplay-dialog:${this.enableAutoPlayDialog_}`,userId:this.userId_}),oa.uploadEvent({log:`stat-conv-${zt}-${location.hostname}`,userId:this.userId_}),i()}catch(n){s(n)}this.joinReject_=null}))}checkDestroy(){if(this.isDestroyed_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.CLIENT_DESTROYED,data:{funName:"join"}})})}async uploadTrtcStats(){let e,t;try{const t=await Ic.getMicrophones();e=t&&t.length}catch(l){}try{const e=await Ic.getCameras();t=e&&e.length}catch(l){}const i={microphone:e,camera:t},{isH264EncodeSupported:s,isVp8EncodeSupported:n,isH264DecodeSupported:a,isVp8DecodeSupported:o}=this.checkSystemResult_.detail,r={webRTC:this.basis_.isWebRTCSupported,getUserMedia:this.basis_.isGetUserMediaSupported,webSocket:this.basis_.isWebSocketsSupported,screenShare:this.basis_.isScreenShareSupported,webAudio:this.basis_.isWebAudioSupported,h264Encode:s,h264Decode:a,vp8Encode:n,vp8Decode:o},d={browser:this.basis_.browser,os:this.basis_.os,trtc:r,devices:i},c={isWebCodecSupported:this.basis_.isWebCodecSupported,isMediaSessionSupported:this.basis_.isMediaSessionSupported,isWebTransportSupported:this.basis_.isWebTransportSupported};oa.uploadEvent({log:"trtcstats-"+JSON.stringify(d),userId:this.userId_}),this.log_.info("TrtcStats-"+JSON.stringify(d)),oa.uploadEvent({log:"trtcadvancedstats-"+JSON.stringify(c),userId:this.userId_})}doJoin(e){return new Promise(((e,t)=>{this.log_.info(`Join() => joining room: ${this.roomId_} useStringRoomId: ${this.useStringRoomId_} mode: ${this.mode_} role: ${this.role_}`);const i={roomId:String(this.roomId_),useStringRoomId:this.useStringRoomId_,privateMapKey:this.privateMapKey_,trtcRole:this.role_===A?T:f,trtcScene:this.mode_===E?S:I,sdpSemantics:this.sdpSemantics_,version:Ci(this.version_),ua:navigator&&navigator.userAgent||"",autoSubscribe:this.autoSubscribe_,terminalType:ze?4:je?2:Ge?3:ft?12:Tt?5:At?13:1,netType:te[ai()],bussinessInfo:this.bussinessInfo_,receiveMix:!0};if(this.publishCDNManager_){const{bussinessInfo:e,pushUserCdnInfo:t}=this.publishCDNManager_.handleCDNConfigForJoinData(this.bussinessInfo_);Object.assign(i,{bussinessInfo:e,pushUserCdnInfo:t})}this.log_.debug(`join room signal data: ${JSON.stringify(i)}`),this.joinTimeout_=setTimeout((()=>{t(new En({code:Sn.JOIN_ROOM_FAILED,message:ti({key:$e.JOIN_ROOM_TIMEOUT})}))}),5e3),Pi.emit(Ui,{client:this}),this.signalChannel_.once(Fs,(e=>{this.clearJoinTimeout(),Pi.emit(Ki,{client:this,error:e}),t(e)})),this.signalChannel_.send(Zs,i),this.signalChannel_.once(Xs.JOIN_ROOM_RESULT,(i=>{this.clearJoinTimeout();const{code:s,message:n,data:a}=i.data;this.onPublishedUserList({data:{userList:a.publishers}}),Pi.emit(Vi,{client:this,code:s}),0===s?(this.isJoined_=!0,this.log_.info("Join room success, start heartbeat"),this.startHeartbeat(),this.badCaseDetector_&&this.badCaseDetector_.start(),this.syncUserList(),this.startSyncUserListInterval(),e()):(this.log_.error("Join room failed result: "+s+" error: "+n),t(new En({code:Sn.JOIN_ROOM_FAILED,extraCode:s,message:ti({key:$e.JOIN_ROOM_FAILED,data:{error:n,code:s}})})))}))}))}async reJoin(){if(this.isJoined_){this.isJoined_=!1;try{this.log_.warn(`reJoin pending: ${this.joinOptions_.roomId}`),this.subscriptionManager_&&this.subscriptionManager_.markAllStream(),this.signalChannel_.close(),await this.signalChannel_.connect(),await this.doJoin({...this.joinOptions_,role:this.role_,privateMapKey:this.privateMapKey_}),this.log_.warn("reJoin success"),oa.logSuccessEvent({userId:this.userId_,eventType:B.REJOIN}),this.checkConnectionsToReconnect(),this.uplinkConnection_&&!this.uplinkConnection_.getIsReconnecting()&&this.uplinkConnection_.startReconnection(),this.mixTranscodeManager_&&this.mixTranscodeManager_.reStartMixTranscode()}catch(e){this.log_.warn("reJoin fail "+e),this.reset(),oa.logFailedEvent({userId:this.userId_,eventType:B.REJOIN,error:e}),this.emitter_.emit(oo.ERROR,new En({code:Sn.JOIN_ROOM_FAILED,message:ti({key:$e.REJOIN_ROOM_FAILED,data:{roomId:this.joinOptions_.roomId}})}))}}else this.log_.warn("reJoin abort")}async leave(){Pi.emit(Fi,{client:this}),sa(this.userId_,{eventId:Fn,eventDesc:"leaving room",timestamp:n(),userId:this.userId_,tinyId:this.tinyId_});try{await this.doHeartbeat()}catch(t){}this.doLeave(),Pi.emit(Hi,{client:this}),oa.logSuccessEvent({userId:this.userId_,eventType:B.LEAVE});const e=Math.floor((Ei()-this.joinedTimestamp_)/1e3);oa.logSuccessEvent({userId:this.userId_,eventType:B.DELTA_LEAVE,delta:e})}doLeave(){this.isJoined_&&(Pi.emit(Bi,{client:this}),this.log_.info("leave() => leaving room"),this.signalChannel_.send(en),this.reset())}clearNetworkQuality(){this.networkQuality_&&(this.networkQuality_.stop(),this.networkQuality_=null)}closeConnections(){this.connections_.forEach((e=>{this.closeDownLink(e.getTinyId())}))}clearJoinTimeout(){clearTimeout(this.joinTimeout_),this.joinTimeout_=-1}destroy(){var e,t,i;if(this.isJoined_)throw this.log_.warn(Fe.INVALID_DESTROY),new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_DESTROY})});this.isDestroyed_||(this.log_.info("destroy client"),this.joinReject_&&(this.joinReject_(new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.CLIENT_DESTROYED,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.off("*"),null===(e=this.callDurationCalculator_)||void 0===e||e.destroy(),null===(t=this.keyPointManager_)||void 0===t||t.destroy(),null===(i=this.deviceDetector_)||void 0===i||i.destroy(),this.callDurationCalculator_=null,this.keyPointManager_=null,this.deviceDetector_=null,this.badCaseDetector_=null,this.publishCDNManager_=null,this.isDestroyed_=!0,Pi.emit(qi,{client:this}))}reset(){this.isJoined_=!1,this.schedule_={domains:null,iceServers:null,iceTransportPolicy:null,trtcCapability:null},this.keyPointManager_&&this.keyPointManager_.prepareReport(),this.mixTranscodeManager_&&(this.mixTranscodeManager_.reset(),this.mixTranscodeManager_=null),this.publishCDNManager_&&this.publishCDNManager_.reset(),this.userMap_.clear(),this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.mutedStates_.clear(),this.clearNetworkQuality(),this.badCaseDetector_&&this.callDurationCalculator_&&this.uploadAllCallStats(),this.closeUplink(),this.signalChannel_&&(this.log_.info("destroying SignalChannel"),this.signalChannel_.close(),this.signalChannel_=null),this.stats_.reset()}startSyncUserListInterval(){-1===this.syncUserListInterval_&&(this.syncUserListInterval_=Na.run(Le,this.syncUserList.bind(this)))}stopSyncUserListInterval(){Na.clearTask(this.syncUserListInterval_),this.syncUserListInterval_=-1}async syncUserList(){try{const e=await this.getUserList();0!==this.userMap_.size&&this.userMap_.forEach((t=>{e.findIndex((({userId:e})=>e===t.userId))<0&&(this.log_.info(`peer leave detected: ${t.userId}`),this.cleanUser({userId:t.userId,tinyId:t.tinyId}))})),e.forEach((e=>{const{userId:t}=e;this.userMap_.has(t)||t===this.userId_||(this.userMap_.set(t,e),this.emitter_.emit(oo.PEER_JOIN,{userId:t}))}))}catch(e){this.log_.warn("sync user list failed: "+e)}}getUserList(){return this.signalChannel_?this.signalChannel_.sendWaitForResponse({command:pn,responseCommand:Xs.USER_LIST_RES,enableLog:!1,timeout:2e3}).then((({data:e})=>{const{code:t,message:i}=e;if(0===t){return(e.data&&e.data.userList||[]).map((({userId:e,srcTinyId:t,role:i})=>new ud({userId:e,tinyId:t,role:i})))}throw ti({key:$e.SIGNAL_RESPONSE_FAILED,data:{signalResponse:Xs.USER_LIST_RES,code:t,message:i}})})):[]}async publish(e,t={isAuxiliary:!1}){e.setPublishState(se),this.isPublishing_=!0;const i=Ei();Pi.emit(ji,{client:this,stream:e});const s=t.isAuxiliary,a=s?o.AUXILIARY:o.MAIN,r=e.getScreen();this.log_.info(`publish() => publishing ${r?o.SCREEN+" ":""}${a} stream ${e.getId()}`);let d=this.uplinkConnection_;try{d||(d=new td({userId:this.userId_,tinyId:this.tinyId_,client:this,isUplink:!0,signalChannel:this.signalChannel_,enableSEI:this.enableSEI_}),d.initialize(),d.on(ao.ERROR,(e=>{const t=e.getCode();t!==Sn.ICE_TRANSPORT_ERROR&&(t===Sn.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emitter_.emit(oo.ERROR,e))}))),e.setConnection(d),await d.publish(e,s),this.log_.info(`local ${r?o.SCREEN+" ":""}${a} stream is published`),this.isPublishing_=!1,s?this.localAuxStream_=e:(this.localStream_=e,this.deviceDetector_&&this.deviceDetector_.setLocalStream(this.localStream_),this.localStream_.getBeautyStatus()&&this.log_.info("beauty stream is published successfully")),e.setPublishState(ne),e.setClient(this,s),this.uplinkConnection_=d;const t=Ei()-i;oa.logSuccessEvent({userId:this.userId_,eventType:B.PUBLISH}),oa.logSuccessEvent({userId:this.userId_,eventType:B.DELTA_PUBLISH,delta:t}),e.hasAudio()&&sa(this.userId_,{eventId:fn,eventDesc:"publish audio track",timestamp:n(),userId:this.userId_,tinyId:this.tinyId_}),e.hasVideo()&&sa(this.userId_,{eventId:Tn,eventDesc:"publish video track",timestamp:n(),userId:this.userId_,tinyId:this.tinyId_}),this.networkQuality_&&this.networkQuality_.setUplinkConnection(this.uplinkConnection_),Pi.emit(us,{localStream:e,isAuxiliary:s,client:this}),this.notPublishWithoutH264Supported_=!1,e.isAIDenoiser&&gr.handleFunctionState({fnName:"AI_DENOISER"})}catch(c){throw c instanceof En&&c.getCode()===Sn.NOT_SUPPORTED_H264&&(this.notPublishWithoutH264Supported_=!0),e.setPublishState(ie),d.close(),this.log_.error("failed to publish stream "+c),this.isPublishing_=!1,oa.logFailedEvent({userId:this.userId_,eventType:B.PUBLISH,error:c}),c}}async unpublish(e){if(!this.uplinkConnection_)return;const t=e===this.localAuxStream_,i=e.getScreen();this.log_.info(`unpublish() => unpublishing local ${i?o.SCREEN+" ":""}${t?o.AUXILIARY:o.MAIN} stream`);try{await this.uplinkConnection_.unpublish(e),e.setClient(null),e.setConnection(null),t?this.localAuxStream_=null:(this.localStream_=null,e.hasAudio()&&sa(this.userId_,{eventId:vn,eventDesc:"unpublish audio track",timestamp:n(),userId:this.userId_,tinyId:this.tinyId_}),e.hasVideo()&&sa(this.userId_,{eventId:An,eventDesc:"unpublish video track",timestamp:n(),userId:this.userId_,tinyId:this.tinyId_})),this.localStream_||this.localAuxStream_||this.closeUplink(),oa.logSuccessEvent({userId:this.userId_,eventType:B.UNPUBLISH})}catch(s){throw oa.logFailedEvent({userId:this.userId_,eventType:B.UNPUBLISH,error:s}),s}}closeUplink(){this.uplinkConnection_&&(this.uplinkConnection_.close(),this.uplinkConnection_=null,this.networkQuality_&&this.networkQuality_.setUplinkConnection(null),this.localStream_&&(this.localStream_.setClient(null),this.localStream_.setConnection(null),this.localStream_=null),this.localAuxStream_&&(this.localAuxStream_.setClient(null),this.localAuxStream_.setConnection(null),this.localAuxStream_=null),this.deviceDetector_&&this.deviceDetector_.setLocalStream(null))}closeDownLink(e){const t=this.connections_.get(e);t&&(t.getIsReconnecting()&&t.stopReconnection(),this.subscriptionManager_&&this.subscriptionManager_.delete(t.getUserId()),t.close(),this.connections_.delete(e),this.mutedStates_.delete(e))}async subscribe(e,t){this.log_.info(`subscribe() => subscribe to [${e.getUserId()}] ${e.getType()} stream with options: ${JSON.stringify(t)}`),li(t)&&(t={audio:!0,video:!0}),li(t.audio)&&(t.audio=!0),li(t.smallVideo)?li(t.video)&&(t.video=!0):t.smallVideo?li(t.video)?(t.video=!1,t.smallVideo=!0):t.video&&(t.video=!0,delete t.smallVideo,this.log_.warn("options.video and options.smallVideo can't be both true")):li(t.video)&&(t.video=!0,delete t.smallVideo),t.video&&this.changeBigSmallRecords_.delete(e.getUserId());const i=e.getConnection();t.smallVideo&&(i.getTrackState().smallVideo||(this.setRemoteVideoStreamType(e,"small"),t.video=!0,delete t.smallVideo));try{Pi.emit(rs,{client:this,stream:e}),await i.subscribe(e,t),this.subscriptionManager_&&this.subscriptionManager_.addSubscriptionRecord(e.getUserId(),e,t),this.notSubscribeWithoutH264Supported_=!1,oa.logSuccessEvent({userId:this.userId_,eventType:B.SUBSCRIBE})}catch(s){const t=s instanceof En?s.getCode():Sn.UNKNOWN;let i;throw t===Sn.NOT_SUPPORTED_H264&&(this.notSubscribeWithoutH264Supported_=!0),i=t===Sn.REMOTE_STREAM_NOT_EXIST?new En({code:Sn.API_CALL_ABORTED,message:ti({key:$e.API_CALL_ABORTED,data:{message:s.message,stream:e}})}):new En({code:t,message:ti({key:$e.SUBSCRIBE_FAILED,data:{message:s.message,stream:e}})}),i.getCode()===Sn.API_CALL_ABORTED?this.log_.warn(i):this.log_.error(i),oa.logFailedEvent({userId:this.userId_,eventType:B.SUBSCRIBE,error:i}),i}}async unsubscribe(e){this.log_.info(`unsubscribe() => unsubscribe to [${e.getUserId()}] ${e.getType()} stream`);try{const t=e.getConnection();await t.unsubscribe(e),this.subscriptionManager_&&this.subscriptionManager_.addUnsubscriptionRecord(e.getUserId(),e),Pi.emit(cs,{client:this,stream:e}),oa.logSuccessEvent({userId:this.userId_,eventType:B.UNSUBSCRIBE})}catch(t){throw oa.logFailedEvent({userId:this.userId_,eventType:B.UNSUBSCRIBE,error:t}),t}}async switchRole(e){this.role_!==e&&(e===v&&this.uplinkConnection_&&this.closeUplink(),this.log_.info("switchRole() => switch role to: "+e),await this.doSwitchRole(e))}doSwitchRole(e){var t,i;const s={command:gn,data:{role:e===A?T:f,privateMapKey:this.privateMapKey_},responseCommand:Xs.SWITCH_ROLE_RES,retries:(null===(t=this.schedule_.config)||void 0===t||null===(i=t.retries)||void 0===i?void 0:i.switchRole)||1};return this.log_.info("switchRole signal data: "+JSON.stringify(s.data)),this.signalChannel_.sendWaitForResponseWithRetry(s).then((t=>{const{code:i,message:s}=t.data;if(0!==i)throw new En({code:Sn.SWITCH_ROLE_FAILED,message:ti({key:$e.SWITCH_ROLE_FAILED,data:{errMsg:s,errCode:i}})});this.role_=e})).catch((e=>{throw e instanceof En&&e.getCode()===Sn.API_CALL_TIMEOUT&&(e=new En({code:Sn.SWITCH_ROLE_FAILED,message:ti({key:$e.SWITCH_ROLE_TIMEOUT})})),this.log_.error(e),e}))}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}getRemoteMutedState(){const e=[];return this.mutedStates_.forEach(((t,i,s)=>{const n=this.connections_.get(i);n&&e.push({userId:n.getUserId(),...t})})),e}async getTransportStats(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e.rtt=t.rtt}for(let[t,i]of this.connections_){const t=await this.stats_.getReceiverStats(i);e.downlinksRTT[t.userId]=t.rtt}return e}async getLocalAudioStats(){const e={};if(e[this.userId_]={bytesSent:0,packetsSent:0},this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e[this.userId_]={bytesSent:t.audio.bytesSent,packetsSent:t.audio.packetsSent}}return e}async getLocalVideoStats(){const e={};if(e[this.userId_]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e[this.userId_]={bytesSent:t.video.bytesSent,packetsSent:t.video.packetsSent,framesEncoded:t.video.framesEncoded,framesSent:t.video.framesSent,frameWidth:t.video.frameWidth,frameHeight:t.video.frameHeight}}return e}async getRemoteAudioStats(){const e={};for(let[t,i]of this.connections_){const{audioDelay:t}=i.getDelay(),s=await this.stats_.getReceiverStats(i);s.hasAudio&&(e[s.userId]={bytesReceived:s.audio.bytesReceived,packetsReceived:s.audio.packetsReceived,packetsLost:s.audio.packetsLost,end2EndDelay:t})}return e}async getRemoteVideoStats(e=D){const t={};for(let[i,s]of this.connections_){const i=await this.stats_.getReceiverStats(s),{videoDelay:n}=s.getDelay();e===D&&i.hasVideo&&(t[i.userId]={bytesReceived:i.video.bytesReceived,packetsReceived:i.video.packetsReceived,packetsLost:i.video.packetsLost,framesDecoded:i.video.framesDecoded,frameWidth:i.video.frameWidth,frameHeight:i.video.frameHeight,end2EndDelay:n}),e===C&&i.hasAuxiliary&&(t[i.userId]={bytesReceived:i.auxiliary.bytesReceived,packetsReceived:i.auxiliary.packetsReceived,packetsLost:i.auxiliary.packetsLost,framesDecoded:i.auxiliary.framesDecoded,frameWidth:i.auxiliary.frameWidth,frameHeight:i.auxiliary.frameHeight,end2EndDelay:n})}return t}getSdpSemantics(){return this.sdpSemantics_}getIceServers(){return 0===this.turnServers_.length&&this.schedule_.iceServers?this.schedule_.iceServers:this.turnServers_}getConnections(){return this.connections_}getMutedStates(){return this.mutedStates_}startHeartbeat(){-1===this.heartbeat_&&(this.log_.info("startHeartbeat..."),this.heartbeat_=Na.run(Le,this.doHeartbeat.bind(this),{delay:2e3}))}stopHeartbeat(){-1!==this.heartbeat_&&(this.log_.info("stopHeartbeat"),Na.clearTask(this.heartbeat_),this.heartbeat_=-1,this.lastHeartBeatTime_=-1)}async doHeartbeat(){var e;const t=this.badCaseDetector_.getMonitorFreeze(),i=await this.stats_.getStatsReport({uplinkConnection:this.uplinkConnection_,downlinkConnections:this.connections_,freezeMap:t});if(Pi.emit(Gi,{client:this,stats:i}),null===(e=this.badCaseDetector_)||void 0===e||e.resetMonitor(),!this.signalChannel_)return;const s=this.signalChannel_.isConnected()?function(e){let t=ia.get(e),i=[];return t?(ia.delete(e),i=t.map((e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc})))):i=[],i}(this.userId_):[],n={str_sdk_version:this.version_,uint64_datetime:(new Date).getTime(),msg_user_info:{str_identifier:this.userId_,uint64_tinyid:this.tinyId_},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:te[this.networkType_]},...i,msg_event_msg:s};this.signalChannel_.send(tn,n);const a=Date.now();this.lastHeartBeatTime_>0&&a-this.lastHeartBeatTime_>1e4&&this.log_.warn("heartbeat took "+(a-this.lastHeartBeatTime_)),this.lastHeartBeatTime_=a,!this.isRelayChanged_&&this.isRelayMaybeFailed()&&(this.reJoin(),this.isRelayChanged_=!0)}onRemoteStreamAdded(e){const t=e.content,{userId:i,tinyId:s,audio:n,bigVideo:a,auxVideo:o,smallVideo:r}=t;if(null===i)return void this.log_.warn("received null userId on stream added");this.userMap_.has(i)||(this.userMap_.set(i,new ud({userId:i,tinyId:s,role:A})),this.emitter_.emit(oo.PEER_JOIN,{userId:i}));const d=this.connections_.get(s);if(d){if(d.getIsReconnecting())return;this.log_.warn("duplicated stream-added observed, rebuild the connection"),d.close(),this.connections_.delete(s)}const c={audio:n,video:a,auxiliary:o,smallVideo:r};this.log_.info(`remote peer [${i}] published stream. trackState: ${JSON.stringify(c)}`),this.createDownlinkConnection({userId:i,tinyId:s,trackState:c})}createDownlinkConnection({userId:e,tinyId:t,trackState:i}){const s=new cd({userId:e,tinyId:t,client:this,isUplink:!1,signalChannel:this.signalChannel_,autoSubscribe:this.autoSubscribe_,trackState:i,enableSEI:this.enableSEI_});this.connections_.set(t,s),this.installDownlinkEvents(s,e,t),this.autoSubscribe_?(s.initialize(),s.connect().catch((()=>{!s.getMainStream()&&s.hasMainStream()&&this.initRemoteStream({type:D,userId:e,downlinkConnection:s}),!s.getAuxStream()&&s.hasAuxStream()&&this.initRemoteStream({type:C,userId:e,downlinkConnection:s})}))):(s.hasMainStream()&&this.initRemoteStream({type:D,userId:e,downlinkConnection:s}),s.hasAuxStream()&&this.initRemoteStream({type:C,userId:e,downlinkConnection:s}))}initRemoteStream({type:e,userId:t,downlinkConnection:i}){const s=new vr({type:e,userId:t,client:this});s.setConnection(i),i.setRemoteStream(e===D?y:R,s),s.setIsStreamAddedEventEmitted(!0),Pi.emit(os,{client:this,stream:s}),this.emitter_.emit(oo.STREAM_ADDED,{stream:s})}installDownlinkEvents(e,t,i){e.on(ao.SEI_MESSAGE,(e=>{this.emitter_.emit(oo.SEI_MESSAGE,e)})),e.on(ao.STREAM_ADDED,(e=>{e.stream.setIsStreamAddedEventEmitted(!0),Pi.emit(os,{client:this,stream:e.stream}),this.emitter_.emit(oo.STREAM_ADDED,{stream:e.stream})})),e.on(ao.STREAM_REMOVED,(e=>{this.changeBigSmallRecords_.delete(e.stream.getUserId()),e.stream.stop(),e.stream.setIsStreamAddedEventEmitted(!1),this.subscriptionManager_&&this.subscriptionManager_.deleteAutoRecoveryFlag(e.stream.getUserId(),e.stream.getType()),Pi.emit(hs,{client:this,stream:e.stream}),this.emitter_.emit(oo.STREAM_REMOVED,{stream:e.stream})})),e.on(ao.STREAM_UPDATED,(t=>{Pi.emit(ls,{client:this,stream:t.stream});const i=e.getMixUserList();i&&(t.mixUserList=i),this.emitter_.emit(oo.STREAM_UPDATED,t)})),e.on(ao.STREAM_SUBSCRIBED,(e=>{Pi.emit(ds,{client:this,stream:e.stream}),this.emitter_.emit(oo.STREAM_SUBSCRIBED,{stream:e.stream})})),e.on(ao.ERROR,(e=>{const t=e.getCode();t!==Sn.ICE_TRANSPORT_ERROR&&(t===Sn.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLink(i),this.emitter_.emit(oo.ERROR,e))}))}onPeerJoin(e){const{srcTinyId:t,userId:i,role:s}=e.data.data;this.userMap_.has(i)||(this.userMap_.set(i,new ud({userId:i,tinyId:t,role:s})),this.emitter_.emit(oo.PEER_JOIN,{userId:i}))}onPeerLeave(e){const{srcTinyId:t,userId:i,reason:s=0}=e.data.data;this.log_.info(`peer leave [${i}]: ${ke[s]}`),this.cleanUser({userId:i,tinyId:t})}cleanUser({userId:e,tinyId:t}){this.userMap_.delete(e),this.closeDownLink(t),this.emitter_.emit(oo.PEER_LEAVE,{userId:e})}onPublishedUserList(e){try{const t=[...e.data.userList];e.data.mixRobotList&&t.push(...e.data.mixRobotList),e.data.fakeMixUser&&t.push(e.data.fakeMixUser);const i=t.map((e=>e.userId));this.connections_.forEach((e=>{const t=e.getUserId(),s=e.getTinyId();i.findIndex((e=>e===t))<0&&(this.log_.info(`peer unpublished detected [${t}]`),this.closeDownLink(s))})),t.forEach((({userId:e,srcTinyId:t,flag:i,mixUserList:s})=>{if(e===this.userId_)return;const n=!!(1&i),a=!!(8&i),r=!!(4&i),d=!!(2&i),c=this.connections_.get(t);if((d||n)&&this.checkSubscribeBigSmallVideo(c,d),c){const{audio:i,video:l,auxiliary:h,smallVideo:u}=c.getTrackState();pi(s)&&c.setMixUserList(s),!l&&n&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.ADD,kind:o.VIDEO}),!i&&a&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.ADD,kind:o.AUDIO}),!h&&r&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.ADD,kind:o.AUXILIARY}),!u&&d&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.ADD,kind:o.SMALL_VIDEO}),l&&!n&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.REMOVE,kind:o.VIDEO}),i&&!a&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.REMOVE,kind:o.AUDIO}),h&&!r&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.REMOVE,kind:o.AUXILIARY}),u&&!d&&Pi.emit(as,{client:this,tinyId:t,userId:e,action:ee.REMOVE,kind:o.SMALL_VIDEO})}else this.log_.info(`peer published detected [${e}]`),this.onRemoteStreamAdded({content:{audio:a,bigVideo:n,auxVideo:r,smallVideo:d,userId:e,tinyId:t}})}))}catch(t){}}onUpdateRemoteMuteStat(e){const t=e.data;(t&&t.userList||[]).forEach((e=>{const{srcTinyId:t,userId:i}=e;if(0===t||t===this.tinyId_)return;const s=this.connections_.get(t);if(!s)return void this.mutedStates_.delete(t);const n=s.getMainStream();if(!n||!n.getIsStreamAddedEventEmitted())return;const a=!!(1&e.flag),o=!!(8&e.flag),r=!!(2&e.flag),d=!!(64&e.flag),c=!!(16&e.flag),l=this.mutedStates_.get(t);if(void 0===l)return this.mutedStates_.set(t,{hasAudio:o,hasVideo:a,hasSmall:r,audioMuted:d,videoMuted:c}),a?c?this.emitter_.emit(oo.MUTE_VIDEO,{userId:i}):this.emitter_.emit(oo.UNMUTE_VIDEO,{userId:i}):this.emitter_.emit(oo.MUTE_VIDEO,{userId:i}),void(o?d?this.emitter_.emit(oo.MUTE_AUDIO,{userId:i}):this.emitter_.emit(oo.UNMUTE_AUDIO,{userId:i}):this.emitter_.emit(oo.MUTE_AUDIO,{userId:i}));{const e=!l.audioMuted&&l.hasAudio,s=!d&&o,n=!l.videoMuted&&l.hasVideo,h=!c&&a;this.mutedStates_.set(t,{hasAudio:o,hasVideo:a,hasSmall:r,audioMuted:d,videoMuted:c}),e!==s&&(s?this.emitter_.emit(oo.UNMUTE_AUDIO,{userId:i}):this.emitter_.emit(oo.MUTE_AUDIO,{userId:i})),n!==h&&(h?this.emitter_.emit(oo.UNMUTE_VIDEO,{userId:i}):this.emitter_.emit(oo.MUTE_VIDEO,{userId:i}))}}))}getEnv(){return this.env_}getSubscriptionManager(){return this.subscriptionManager_}async startPublishCDNStream(e={}){if(this.log_.info(`startPublishCDNStream with params: ${JSON.stringify(e)}; isJoined: ${this.isJoined_}; hasMainStream: ${!!this.localStream_}; hasAuxStream: ${!!this.localAuxStream_};`),e.streamType=e.streamType||o.MAIN,e.streamType===o.AUXILIARY&&(e.streamType=o.AUX),e.streamId=e.streamId||"",this.isJoined_){if(e.streamType===o.MAIN&&!this.localStream_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_OPERATION_START_PUBLISH_CDN})});if(e.streamType===o.AUX&&!this.localAuxStream_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_OPERATION_START_PUBLISH_CDN})})}await this.publishCDNManager_.startPublishTencentCDN(e),e.appId&&e.bizId&&e.url&&await this.publishCDNManager_.startPublishGivenCDN(e)}async stopPublishCDNStream(){if(!this.publishCDNManager_.getIsPublishingTencentCDN())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_OPERATION_STOP_PUBLISH_CDN})});this.log_.info("stopPublishCDNStream"),await this.publishCDNManager_.stopPublishTencentCDN(),this.publishCDNManager_.getIsPublishingGivenCDN()&&await this.publishCDNManager_.stopPublishGivenCDN()}async startMixTranscode(e){if(!this.isJoined_||!this.mixTranscodeManager_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.START_MIX_TRANSCODE})});li(e.mode)&&(e.mode=J.MANUAL);try{this.log_.info(`startMixTranscode with config ${JSON.stringify(e)}`),oa.uploadEvent({log:`mix-transcode-mode:${e.mode}`,userId:this.userId_}),await this.mixTranscodeManager_.startMixTranscode(e),oa.logSuccessEvent({userId:this.userId_,eventType:B.START_MIX_TRANSCODE})}catch(t){throw oa.logFailedEvent({userId:this.userId_,eventType:B.START_MIX_TRANSCODE,error:t}),t}}async stopMixTranscode(){if(!this.isJoined_||!this.mixTranscodeManager_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.STOP_MIX_TRANSCODE})});try{await this.mixTranscodeManager_.stopMixTranscode(),oa.logSuccessEvent({userId:this.userId_,eventType:B.STOP_MIX_TRANSCODE})}catch(e){throw oa.logFailedEvent({userId:this.userId_,eventType:B.STOP_MIX_TRANSCODE,error:e}),e}}getSystemResult(){return this.checkSystemResult_}enableAudioVolumeEvaluation(e=2e3,t=!1){if(!ui(e))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_AUDIO_VOLUME})});if(this.log_.info("enableAudioVolumeEvaluation with interval: "+e),e<=0)return this.enableAudioVolumeEvaluation_=!1,Na.clearTask(this.audioVolumeIntervalId_),void(this.audioVolumeIntervalId_=null);e=Math.floor(Math.max(e,16)),Pi.emit(Xi,{interval:e}),this.audioVolumeIntervalId_&&(Na.clearTask(this.audioVolumeIntervalId_),this.audioVolumeIntervalId_=null),this.enableAudioVolumeEvaluation_=!0,this.audioVolumeIntervalId_=Na.run(Pe,(()=>{const e=[];if(this.localStream_){const t=Math.floor(100*this.localStream_.getAudioLevel());e.push({userId:this.userId_,audioVolume:t,stream:this.localStream_})}this.connections_.forEach((t=>{const i=t.getSubscribedMainStream();if(i){const s=Math.floor(100*i.getAudioLevel());e.push({userId:t.getUserId(),audioVolume:s,stream:i})}})),this.emitter_.emit(oo.AUDIO_VOLUME,{result:e})}),{fps:1e3/e,backgroundTask:t})}callExperimentalAPI(e,t){return oc.call(e,{client:this,...t})}setProperty(e,t){const i=`${e}_`;li(this[i])||(this[i]=t)}uploadAllCallStats(){this.callDurationCalculator_.getDurationMap().forEach((({userId:e,type:t},i)=>{const s=this.callDurationCalculator_.getDuration(i,o.VIDEO),{dataFreeze:n}=this.badCaseDetector_.getDataFreezeDuration(i),{renderFreeze:a}=this.badCaseDetector_.getRenderFreezeDuration(i),r={userId:e,type:t,duration:s,dataFreeze:n,renderFreeze:a};oa.uploadEvent({log:"callStats-"+JSON.stringify(r),userId:this.userId_})})),this.badCaseDetector_.stop(),this.callDurationCalculator_.reset()}async enableSmallStream(){if(this.isPublished()||this.isPublishing_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.ENABLE_SMALL_STREAM_PUBLISHED})});if(!to())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.NOT_SUPPORTED_SMALL_STREAM})});this.setIsEnableSmallStream(!0),this.log_.info("SmallStream successfully enabled")}async disableSmallStream(){if(this.isPublished()||this.isPublishing_)throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.DISABLE_SMALL_STREAM_PUBLISHED})});this.setIsEnableSmallStream(!1),this.log_.info("SmallStream successfully disabled")}setSmallStreamProfile(e){e&&e.framerate&&(e.frameRate=e.framerate),e.width*e.height>307200&&(e.width=320,e.height=240,this.log_.info("Small stream resolution is beyond limitation, which is invalid. Reset to 320 * 240")),Object.keys(this.smallStreamConfig_).forEach((t=>{e[t]&&(this.smallStreamConfig_[t]=e[t])}));const{width:t,height:i,bitrate:s,frameRate:n}=this.smallStreamConfig_;if(this.log_.info(`setSmallStreamProfile: bitrate=${s}, frameRate=${n}, height=${i}, width=${t}`),t<0||i<0||s<0||n<0)throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_SMALL_STREAM_PROFILE})})}async setRemoteVideoStreamType(e,t){if(!(e instanceof vr))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PARAMETER_REMOTE_STREAM})});if(!e.getConnection())throw new En({code:Sn.INVALID_OPERATION,message:ti({key:$e.INVALID_REMOTE_STREAM})});if(e.getType()!==C)switch(t){case ae:case oe:await this.changeVideoType(e,t)}}async changeVideoType(e,t){const i=e.getUserId(),s={stream:e,options:{video:t===ae,smallVideo:t===oe},isSubscribing:!1,reSubscribeCount:10};this.changeBigSmallRecords_.set(i,s),this.log_.info(`set [${i}] ${e.getType()} stream video prefer type: ${t}`)}async checkSubscribeBigSmallVideo(e,t){if(!(null!=e&&e.isBigStreamSubscribed||null!=e&&e.isSmallStreamSubscribed))return;const i=e.getUserId();if(!this.changeBigSmallRecords_.has(i))return;let s=this.changeBigSmallRecords_.get(i);const{video:n,smallVideo:a}=e.getSubscribeState(),{stream:o,options:r,isSubscribing:d,reSubscribeCount:c}=s;if(r.video&&n||r.smallVideo&&a&&t)return;let l={video:r.video,smallVideo:r.smallVideo};if(t&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed)try{if(r&&o&&!d&&c>=1){s.isSubscribing=!0,s.reSubscribeCount=c-1;const e=o.getConnection();!t&&e.isSmallStreamSubscribed&&(l={video:!0,smallVideo:!1}),l.emitEvent=!1,await(null==e?void 0:e.subscribe(o,l)),this.log_.info(`change [${i}] to ${l.smallVideo?"small":"big"} video successfully. count ${10-s.reSubscribeCount}.`),s.isSubscribing=!1,s.reSubscribeCount=10}}catch(h){this.log_.info(`change [${i}] to ${l.smallVideo?"small":"big"} video failed. count ${10-s.reSubscribeCount}.`),s.isSubscribing=!1,0===c&&this.changeBigSmallRecords_.delete(i)}}setIsEnableSmallStream(e){this.isEnableSmallStream_=e}getIsEnableSmallStream(){return this.isEnableSmallStream_}get smallStreamConfig(){return this.smallStreamConfig_}isPublished(){return!!this.localStream_}getUplinkConnection(){return this.uplinkConnection_}getLocalStream(){return this.localStream_}getMode(){return this.mode_}getBadCaseDetector(){return this.badCaseDetector_}getCallDurationCalculator(){return this.callDurationCalculator_}getIsJoined(){return this.isJoined_}getAllConnections(){const e=[...this.connections_.values()];return this.uplinkConnection_&&e.push(this.uplinkConnection_),e}isRelayMaybeFailed(){if(!this.signalChannel_.isOnline)return!1;const e=this.getAllConnections();if(0===e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].getReconnectionCount()<6)return!1;return!0}getUseStringRoomId(){return this.useStringRoomId_}checkConnectionsToReconnect(){this.getAllConnections().forEach((e=>{if(!e.getIsReconnecting()){const t=e.getPeerConnection();t&&t.connectionState===V&&(this.log_.warn(`[${e.getUserId()}] pc is closed but not reconnect`),e.startReconnection())}}))}getEnableAutoPlayDialog(){return this.enableAutoPlayDialog_}sendSEIMessage(e,t){this.uplinkConnection_.sendSEI(e,t)}setProxyServer(e){if(this.log_.info(`set proxy server: ${JSON.stringify(e)}`),hi(e)){if(!e.startsWith("wss://"))throw new En({code:Sn.INVALID_PARAMETER,message:ti({key:$e.INVALID_PROXY})});this.proxy_=e}else if(oi(e)){const{websocketProxy:t,loggerProxy:i,scheduleProxy:s,unifiedProxy:n}=e;t&&(this.proxy_=t),i&&g(i),s&&le(s),n&&(this.unifiedProxy_=n,g(`https://${n}`),le(n))}}setTurnServer(e){this.log_.info("set turn server: "+JSON.stringify(e));const t=[];Array.isArray(e)?e.forEach((e=>t.push(Si(e)))):oi(e)&&t.push(Si(e)),this.turnServers_=t}get2k4kFlag(){var e,t;return(null===(e=this.schedule_)||void 0===e||null===(t=e.trtcCapability)||void 0===t?void 0:t["2k4k"])||2}},e(ac.prototype,"join",[Cd,Nd,wd],Object.getOwnPropertyDescriptor(ac.prototype,"join"),ac.prototype),e(ac.prototype,"leave",[kd],Object.getOwnPropertyDescriptor(ac.prototype,"leave"),ac.prototype),e(ac.prototype,"getUserList",[Od],Object.getOwnPropertyDescriptor(ac.prototype,"getUserList"),ac.prototype),e(ac.prototype,"publish",[Ld,Pd,Md],Object.getOwnPropertyDescriptor(ac.prototype,"publish"),ac.prototype),e(ac.prototype,"unpublish",[Ud,Vd],Object.getOwnPropertyDescriptor(ac.prototype,"unpublish"),ac.prototype),e(ac.prototype,"subscribe",[xd],Object.getOwnPropertyDescriptor(ac.prototype,"subscribe"),ac.prototype),e(ac.prototype,"unsubscribe",[$d],Object.getOwnPropertyDescriptor(ac.prototype,"unsubscribe"),ac.prototype),e(ac.prototype,"switchRole",[Fd,Bd,Hd],Object.getOwnPropertyDescriptor(ac.prototype,"switchRole"),ac.prototype),e(ac.prototype,"startPublishCDNStream",[Gd,Wd],Object.getOwnPropertyDescriptor(ac.prototype,"startPublishCDNStream"),ac.prototype),e(ac.prototype,"stopPublishCDNStream",[jd],Object.getOwnPropertyDescriptor(ac.prototype,"stopPublishCDNStream"),ac.prototype),e(ac.prototype,"startMixTranscode",[Jd,Kd],Object.getOwnPropertyDescriptor(ac.prototype,"startMixTranscode"),ac.prototype),e(ac.prototype,"stopMixTranscode",[zd],Object.getOwnPropertyDescriptor(ac.prototype,"stopMixTranscode"),ac.prototype),e(ac.prototype,"enableAudioVolumeEvaluation",[Yd],Object.getOwnPropertyDescriptor(ac.prototype,"enableAudioVolumeEvaluation"),ac.prototype),e(ac.prototype,"enableSmallStream",[Xd],Object.getOwnPropertyDescriptor(ac.prototype,"enableSmallStream"),ac.prototype),e(ac.prototype,"disableSmallStream",[qd],Object.getOwnPropertyDescriptor(ac.prototype,"disableSmallStream"),ac.prototype),e(ac.prototype,"setSmallStreamProfile",[Qd],Object.getOwnPropertyDescriptor(ac.prototype,"setSmallStreamProfile"),ac.prototype),e(ac.prototype,"setRemoteVideoStreamType",[Zd],Object.getOwnPropertyDescriptor(ac.prototype,"setRemoteVideoStreamType"),ac.prototype),e(ac.prototype,"sendSEIMessage",[ec,tc,ic],Object.getOwnPropertyDescriptor(ac.prototype,"sendSEIMessage"),ac.prototype),e(ac.prototype,"setProxyServer",[sc],Object.getOwnPropertyDescriptor(ac.prototype,"setProxyServer"),ac.prototype),e(ac.prototype,"setTurnServer",[nc],Object.getOwnPropertyDescriptor(ac.prototype,"setTurnServer"),ac.prototype),ac);var dc,cc,lc,hc,uc,_c,mc;let pc=0,gc=0;var Ic=new(dc=Ir(he),cc=Ir(he),lc=Ir(he),hc=rr(or.TRTC.createClient),uc=Ir(he),_c=rr(or.TRTC.createStream),e((mc=class{constructor(){this.name_=he,this.VERSION=t,this.Logger={loggerManager:Vs,LogLevel:Re,setLogLevel(e){Vs.setLogLevel(e),e<=1&&ei()},enableUploadLog(){gr.handleFunctionState({fnName:"TRTC.enableUploadLog"}),Vs.enableUploadLog()},disableUploadLog(){Vs.warn("disableUploadLog"),gr.handleFunctionState({fnName:"TRTC.disableUploadLog"}),Vs.disableUploadLog()}}}async checkSystemRequirements(){return await Va()}isScreenShareSupported(){return $a()}isSmallStreamSupported(){return to()}getDevices(){return Eo()}getCameras(){return async function(){return Ka()||Ja()?[]:(await So()).filter((e=>e.kind===o.VIDEO_INPUT)).map(((e,t)=>{let i=e.label;e.label||(i="camera_"+t);const s={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(s.groupId=e.groupId),e.getCapabilities&&(s.getCapabilities=()=>e.getCapabilities()),s}))}()}getMicrophones(){return To()}getSpeakers(){return fo()}createClient(e){!function(){if(xs&&(xs=!1,Vs.getLogLevel()!=Ic.Logger.LogLevel.NONE&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info(`*   API Document: ${fe}index.html`),console.info("*   Changelog: https://cloud.tencent.com/document/product/647/38958"),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),Vs.info("TRTC Web SDK Version: "+t),Vs.info("UserAgent: "+navigator.userAgent),Vs.info("URL of current page: "+location.href),navigator.userAgentData&&ci(navigator.userAgentData.getHighEntropyValues)))try{navigator.userAgentData.getHighEntropyValues(["architecture","bitness","model","platformVersion","fullVersionList"]).then((e=>{let t=`UAData: ${e.platform}/${e.platformVersion}`;e.architecture&&e.bitness&&(t+=` ${e.architecture}/${e.bitness}`),e.mobile&&(t+=" mobile"),e.model&&(t+=` model: ${e.model}`),e.fullVersionList&&(t+=` ${e.fullVersionList.filter((e=>"Not/A)Brand"!==e.brand)).map((e=>`${e.brand}/${e.version}`)).join(",")}`),Vs.info(t)})).catch((()=>{}))}catch(e){}}();const i={version:this.VERSION},s=new rc({...i,...e,seq:++pc});return Pi.emit(zi,{client:s}),s}createStream(e){return new qr({...e,seq:++gc})}}).prototype,"checkSystemRequirements",[dc],Object.getOwnPropertyDescriptor(mc.prototype,"checkSystemRequirements"),mc.prototype),e(mc.prototype,"isScreenShareSupported",[cc],Object.getOwnPropertyDescriptor(mc.prototype,"isScreenShareSupported"),mc.prototype),e(mc.prototype,"isSmallStreamSupported",[lc],Object.getOwnPropertyDescriptor(mc.prototype,"isSmallStreamSupported"),mc.prototype),e(mc.prototype,"createClient",[hc,uc],Object.getOwnPropertyDescriptor(mc.prototype,"createClient"),mc.prototype),e(mc.prototype,"createStream",[_c],Object.getOwnPropertyDescriptor(mc.prototype,"createStream"),mc.prototype),mc);export{Ic as default};
